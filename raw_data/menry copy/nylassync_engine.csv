sync-engine,:incoming_envelope: IMAP/SMTP sync system with modern APIs
username,timestamp,url,sha,message
spang,2017-03-08 18:34:10,https://api.github.com/repos/nylas/sync-engine/git/commits/b91b94b9a0033be4199006eb234d270779a04443,b91b94b9a0033be4199006eb234d270779a04443,"[none] Fix dep version issues running setup.sh

This commit should make creating a vagrant VM from scratch work again."
spang,2017-03-08 16:51:19,https://api.github.com/repos/nylas/sync-engine/git/commits/62850ac7a20a7b727026f0a7e5b43242cbe9a451,62850ac7a20a7b727026f0a7e5b43242cbe9a451,Bump version for new release
spang,2017-03-08 16:48:44,https://api.github.com/repos/nylas/sync-engine/git/commits/e3ef94ce2d20f5fd656134817bc449a48c653a6a,e3ef94ce2d20f5fd656134817bc449a48c653a6a,Merge changes for new release
aneeshusa,2017-03-08 16:24:58,https://api.github.com/repos/nylas/sync-engine/git/commits/5bfca3b0fa5046a4f7086bafa7252fa936c1bea7,5bfca3b0fa5046a4f7086bafa7252fa936c1bea7,"Silence Vagrant security warning for new versions (#302)

Old versions of Vagrant had insecure defaults for SSH: the forwarded
SSH port was open to the world, and could always be authenticated to
using the well-known Vagrant public/private key pair, letting anyone
SSH into a Vagrant box running locally. The vagrant-rekey-ssh plugin
plugs this hole.

However, Vagrant now includes mitigations for these issues (restricting
the forwarded port to localhost only and automatically rekeying) since
Vagrant 1.7.0, so the warning is unnecessary for these newer Vagrants."
spang,2017-03-08 16:24:31,https://api.github.com/repos/nylas/sync-engine/git/commits/04b8737c352babb3f6bc6436308e3884e7435fbb,04b8737c352babb3f6bc6436308e3884e7435fbb,"Add index on (event.namespace_id, event.start) (#347)

This index is required for performant pagination of events, which
many applications require."
cdalbergue,2017-03-08 16:20:20,https://api.github.com/repos/nylas/sync-engine/git/commits/67ae731c70e8d26815ed80c200d270e3f7af7225,67ae731c70e8d26815ed80c200d270e3f7af7225,update redis conf to fix a security issue (#392)
tbraeutigam,2017-01-31 01:37:42,https://api.github.com/repos/nylas/sync-engine/git/commits/235ac9312a2aa9f79f4db6629f3f4f4497924490,235ac9312a2aa9f79f4db6629f3f4f4497924490,Fix bin/inbox-auth to properly update account credentials instead of adding new accounts. (#388)
grinich,2017-01-06 00:13:42,https://api.github.com/repos/nylas/sync-engine/git/commits/0d607a3c17120901b8663d8f8051600ac845e647,0d607a3c17120901b8663d8f8051600ac845e647,Release 17.1.6 (#424)
khamidou,2016-09-08 17:58:40,https://api.github.com/repos/nylas/sync-engine/git/commits/91e3a8bff6ef0656eca9e356c07963c8b238d876,91e3a8bff6ef0656eca9e356c07963c8b238d876,Sleep when we run into Google bot detection.
bengotow,2016-09-02 21:34:03,https://api.github.com/repos/nylas/sync-engine/git/commits/60d8f1de4630c51c5fe208b620274c6df2e0a6f9,60d8f1de4630c51c5fe208b620274c6df2e0a6f9,Rebase imapclient changes on top of menno’s github repo
khamidou,2016-09-01 23:41:27,https://api.github.com/repos/nylas/sync-engine/git/commits/987e975f22d9f0b8e0d3b48b2b4da4a0a670981c,987e975f22d9f0b8e0d3b48b2b4da4a0a670981c,"Add support for non-optimistic updates (+ API versioning) (#359)

Summary:
This PR adds a new way to update API objects. Instead of updating API objects before pushing the changes to the backend server (aka optimistic updates), we now push the changes to the backend and wait for the sync engine to pick up the changes. This solves a lot of problems we've had previously with folder and labels, where our datastore and the remote server would get out of sync.

For example, in the case of a folder rename, PUTting changes to /folders/my_id will return the title of the original folder. The new name will be returned only once we've carried the folder rename operation. This is a breaking API change, which could be very confusing to our long-time API users.

To keep backward compatibility, I've introduced a very basic API versioning scheme, similar to what Github does with its API. API versions are dates. You can set the API version you'd like to use by setting the ""Api-Version"" header in your request. If you don't set this header, we'll default to the version set for your developer dashboard account (changes forthcoming).

This diff is pretty close to review but I need to take a final pass to make sure everything fits together.

Test Plan:
Make a final manual test pass using IMAP and Exchange accounts.

Reviewers:
spang, bengotow"
spang,2016-09-01 22:04:38,https://api.github.com/repos/nylas/sync-engine/git/commits/19d353f9997a0d017eea7a2af9efce7f2e30607d,19d353f9997a0d017eea7a2af9efce7f2e30607d,"Break down sync errors in the same way we break down API errors

Test Plan: jenkins, threw in some manual raises and verified logs

Reviewers: drew

Differential Revision: https://phab.nylas.com/D3252"
bengotow,2016-09-01 19:26:23,https://api.github.com/repos/nylas/sync-engine/git/commits/5fdb850b13b88af06eedf994dc1d7a6235b9e98a,5fdb850b13b88af06eedf994dc1d7a6235b9e98a,"Some SQLalchemy errors have a message which is also an error

Resolves https://sentry.nylas.com/sentry/sync-prod/group/55590/"
bengotow,2016-09-01 19:08:24,https://api.github.com/repos/nylas/sync-engine/git/commits/d1331354fd2b88ca5b82b04e8f441c2d79551caf,d1331354fd2b88ca5b82b04e8f441c2d79551caf,"Switch shard pagination helper to use string cursors

We’re currently returning JSON with numeric values like `14073748835535329`. This number is too large to be represented in JavaScript, so this JSON can only be consumed by some languages. Cast to a string instead.

Impacts the admin dashboard"
spang,2016-09-01 18:25:19,https://api.github.com/repos/nylas/sync-engine/git/commits/90c2a864b9a55a41f45198100e97265f0b9016e8,90c2a864b9a55a41f45198100e97265f0b9016e8,"Fixes for API error logging

The original new API for log_exception() had an optional message, but this was
removed before the patch was landed. Fix err() function to use the latest API
instead of passing in a message that was interpreted as the send_to_sentry
value.

Also, don't add 'error' keys to the request log context, which causes
log_exception() to not log additional information.

Lastly, don't send validation errors to err(), which will send them to
Sentry... raise an InputError instead and let the regular validation
error handler handle them."
bengotow,2016-08-31 01:08:38,https://api.github.com/repos/nylas/sync-engine/git/commits/6c3ea63676187b5e70dbdd07ebdaa2e2991041a6,6c3ea63676187b5e70dbdd07ebdaa2e2991041a6,"Fix unicode-aware truncation of EAS event attrs

Summary:
The EAS event class was trying to be unicode-aware, but only ran unicode-safe truncation when the string was /already/ unicode-encoded. Creating an EAS event with a Location: `aกกกกก (+250 more)` caused it to break the non-unicode input in an invalid way.

I changed the conveinece method to support unicode and non-unicode input, and consolidated it with other unicode-aware trimming code elsewhere. It should now be used everywhere we truncate string input.

Fixes https://sentry.nylas.com/sentry/sync-prod/group/52270/ and possibly others.

Test Plan: Updated tests

Reviewers: drew, spang

Reviewed By: spang

Subscribers: khamidou, jenkins

Differential Revision: https://phab.nylas.com/D3247"
pfista,2016-09-01 17:22:23,https://api.github.com/repos/nylas/sync-engine/git/commits/c6e54701f21d76bbf4b6cfc6407775784a23821d,c6e54701f21d76bbf4b6cfc6407775784a23821d,Add security disclosure to readme.md
spang,2016-09-01 14:01:24,https://api.github.com/repos/nylas/sync-engine/git/commits/90396ab0c19a25c8a6bcd7a7080b18df970808e9,90396ab0c19a25c8a6bcd7a7080b18df970808e9,Add 'debug' level to one more spammy syncback log line
spang,2016-09-01 14:00:04,https://api.github.com/repos/nylas/sync-engine/git/commits/5f1298bd9d8cc61bfc74c43304846107a7ffac2f,5f1298bd9d8cc61bfc74c43304846107a7ffac2f,Put syncback iteration log line at 'debug' level also
spang,2016-09-01 13:41:26,https://api.github.com/repos/nylas/sync-engine/git/commits/03b7677d937823d27bd6392463d9a1e45d1864fa,03b7677d937823d27bd6392463d9a1e45d1864fa,"Put logging back in but make it 'debug' level

We only log 'info' and above in production, and these verbose log lines
may be sometimes useful for debugging."
spang,2016-08-31 19:26:50,https://api.github.com/repos/nylas/sync-engine/git/commits/d6a9fe5998d09595b630232160fbae74430fa528,d6a9fe5998d09595b630232160fbae74430fa528,"Remove super spammy log lines

These log lines account for at least 50% of our log volume right
now. Let's see if we can do without them."
bengotow,2016-08-30 18:24:12,https://api.github.com/repos/nylas/sync-engine/git/commits/c45905b2b5331060750320b5b231f625eb9f3a78,c45905b2b5331060750320b5b231f625eb9f3a78,"Enable SSL moving write buffer and auto retry

Summary: This resolves https://sentry.nylas.com/sentry/sync-prod/group/52244/, which was caused by SSL requesting a retry during a (presumably large) write during /send.

Test Plan: No new tests, test on staging or prod

Reviewers: spang, mike

Reviewed By: mike

Subscribers: jenkins

Differential Revision: https://phab.nylas.com/D3243"
jstejada,2016-08-31 03:23:49,https://api.github.com/repos/nylas/sync-engine/git/commits/8bb907fdfffcc3617cc6b3df4647eda3d963b405,8bb907fdfffcc3617cc6b3df4647eda3d963b405,"Overwrite sync_error on Account if it is a string, so it uses new format"
spang,2016-08-31 00:19:11,https://api.github.com/repos/nylas/sync-engine/git/commits/cb6c5cd1633a19eeeef9b316a3d00e3d5f5831be,cb6c5cd1633a19eeeef9b316a3d00e3d5f5831be,Fail more gracefully when log_context is empty
khamidou,2016-08-30 22:07:26,https://api.github.com/repos/nylas/sync-engine/git/commits/02f375f5800898e8dee62bd3a135726d1098fa30,02f375f5800898e8dee62bd3a135726d1098fa30,Add a function to flatten lists of lists.
khamidou,2016-08-30 21:16:53,https://api.github.com/repos/nylas/sync-engine/git/commits/88abdde032805c2c4d24db8707bda40114669124,88abdde032805c2c4d24db8707bda40114669124,"Send event invites from a separate domain

Summary:
Right now we're sending invite messages through the same domain we're using for other transactional emails like password recovery. This could cause delivery problems in the medium term.

To make sure this doesn't happen, this diff switches invite sending to use a new domain. Ansible diff forthcoming.

Test Plan: Look at the code a long time

Reviewers: spang

Reviewed By: spang

Subscribers: jenkins

Differential Revision: https://phab.nylas.com/D3214"
bengotow,2016-08-30 19:38:33,https://api.github.com/repos/nylas/sync-engine/git/commits/469b463de25fa904fd1dfce001e558920e7f6e5b,469b463de25fa904fd1dfce001e558920e7f6e5b,"Increase the length of g_id_token

Summary: Following redwood spec failure: http://leeroy.inboxapp.com/job/redwood/2163/console

Test Plan: Only >1024 seen was 1191, assuming 2048 is enough.

Reviewers: spang

Reviewed By: spang

Subscribers: rene, jenkins, mike

Differential Revision: https://phab.nylas.com/D3244"
spang,2016-08-30 19:37:51,https://api.github.com/repos/nylas/sync-engine/git/commits/5db7043028965b6093d43ee904dbdf7e7b9a31cf,5db7043028965b6093d43ee904dbdf7e7b9a31cf,"Within HTTP requests, log all additional info on the request context

Summary:
This diff implements two things:
* Instead of logging stack traces or other extra info within HTTP requests as
  separate log entries, log them in the same log line so we have all the
  information about a request in the same place, can't log some lines with
  missing information required for correlation, and also to make our logs more
  compact since the structured metadata for each log entry is significant.
* Breaks down error logging into three different parts: the exception class,
  the error message, and the traceback. This should make it easier to
  aggregate different types of errors that don't have identical tracebacks
  (plus the tracebacks are huge---should leave that kind of aggregation to
  sentry).

Test Plan: jenkins

Reviewers: drew

Reviewed By: drew

Subscribers: jenkins

Differential Revision: https://phab.nylas.com/D3233"
spang,2016-08-30 18:13:50,https://api.github.com/repos/nylas/sync-engine/git/commits/85f3df6ada9694142d25ac0ff0618d64d5515abf,85f3df6ada9694142d25ac0ff0618d64d5515abf,"Remove unnecessary log fields from certain logs

Test Plan: jenkins

Reviewers: khamidou

Subscribers: jenkins

Differential Revision: https://phab.nylas.com/D3238"
pfista,2016-08-22 23:18:48,https://api.github.com/repos/nylas/sync-engine/git/commits/11e8119ca49fd0a29baded49416111f36fc486ea,11e8119ca49fd0a29baded49416111f36fc486ea,"Store OAuth urls in one place

Summary:
We shouldn't have the same constants defined in multiple places. This
makes sync-engine in charge of google oauth urls. Related: D3173

Test Plan: run tests

Reviewers: khamidou

Reviewed By: khamidou

Subscribers: jenkins

Differential Revision: https://phab.nylas.com/D3197"
jstejada,2016-08-30 01:48:40,https://api.github.com/repos/nylas/sync-engine/git/commits/fcc75f2046ffd637ee74fb9cbfc541b2f3339748,fcc75f2046ffd637ee74fb9cbfc541b2f3339748,"Add helper to paginate over all shards when querying for a model

Summary:
Update pagination helper to pre populate query

- prepopulates query to filter based on latest cursor, apply limit and
order correctly
- helps developer not have to remember to do it himself

Test Plan: - TODO

Reviewers: khamidou, drew

Reviewed By: drew

Subscribers: jenkins

Differential Revision: https://phab.nylas.com/D3240"
spang,2016-08-29 00:11:47,https://api.github.com/repos/nylas/sync-engine/git/commits/2f0e3c5f854ca4cb02f1760052cc4b556aeb547e,2f0e3c5f854ca4cb02f1760052cc4b556aeb547e,bump nylas-prod-py version
spang,2016-08-27 20:25:58,https://api.github.com/repos/nylas/sync-engine/git/commits/a81546e164ee8c1968b46daf4e154b151c73a62c,a81546e164ee8c1968b46daf4e154b151c73a62c,"s/INBOX_CFG_PATH/SYNC_ENGINE_CFG_PATH/

This feature is only used on our Jenkins CI test runs, so we should be
good to go since that config has already been updated."
spang,2016-08-27 20:18:49,https://api.github.com/repos/nylas/sync-engine/git/commits/d7c5f38d3f0090e6dc35f8aae710043ac891bd3e,d7c5f38d3f0090e6dc35f8aae710043ac891bd3e,Remove more Inbox references
spang,2016-08-26 02:51:13,https://api.github.com/repos/nylas/sync-engine/git/commits/6597256eed38580076f9c0e3ec7ed37a63f14eb3,6597256eed38580076f9c0e3ec7ed37a63f14eb3,"Switch deprecated INBOX_ENV for NYLAS_ENV

Summary: It's time for this bizarre legacy oddity to go away.

Test Plan: jenkins

Reviewers: khamidou

Reviewed By: khamidou

Subscribers: jenkins

Differential Revision: https://phab.nylas.com/D3219"
spang,2016-08-26 02:44:48,https://api.github.com/repos/nylas/sync-engine/git/commits/dcbc0cb10d609fb8ce5d16ee56d24f85a1fdfc01,dcbc0cb10d609fb8ce5d16ee56d24f85a1fdfc01,"Remove old X-Request-Id logging

Summary: We moved this functionality to nylas-production-python

Test Plan: jenkins

Reviewers: khamidou

Reviewed By: khamidou

Subscribers: jenkins

Differential Revision: https://phab.nylas.com/D3218"
spang,2016-08-26 03:19:32,https://api.github.com/repos/nylas/sync-engine/git/commits/96f7a6194ceaa7014df6ce2924f22f957d4e2801,96f7a6194ceaa7014df6ce2924f22f957d4e2801,"Bump nylas-production-python version

Need this for env logging to work"
pfista,2016-08-23 22:19:44,https://api.github.com/repos/nylas/sync-engine/git/commits/ea8a95a0ea31b167fb5d386a845b01c63b4f817f,ea8a95a0ea31b167fb5d386a845b01c63b4f817f,"Update log messages when there are multiple sent system roles defined for an account's folders

Test Plan: run tests

Reviewers: khamidou

Reviewed By: khamidou

Subscribers: jenkins

Differential Revision: https://phab.nylas.com/D3203"
spang,2016-08-19 20:02:29,https://api.github.com/repos/nylas/sync-engine/git/commits/8283803464cc081c9f96b1a9ff4aa50b2c43fc8b,8283803464cc081c9f96b1a9ff4aa50b2c43fc8b,Disable urllib3 warnings in vendored urllib3 also
spang,2016-08-19 19:33:27,https://api.github.com/repos/nylas/sync-engine/git/commits/bf39696bfb2c16de5b487d05cf807823d484f946,bf39696bfb2c16de5b487d05cf807823d484f946,"Upgrade to latest nylas-production-python

We need this to get unified key names for logs across haproxy/nginx/application."
jstejada,2016-08-19 14:42:53,https://api.github.com/repos/nylas/sync-engine/git/commits/bd92bcbc3010e58f27e65a81f0f253e7e0ac7c81,bd92bcbc3010e58f27e65a81f0f253e7e0ac7c81,"Save uncaught sync errors to the account object

Summary: Save any uncaught sync errors to the account object. Make sure to save the error message and traceback.

Test Plan: TODO

Reviewers: khamidou, drew

Reviewed By: drew

Subscribers: jenkins

Differential Revision: https://phab.nylas.com/D3167"
spang,2016-08-19 17:23:53,https://api.github.com/repos/nylas/sync-engine/git/commits/82493b30f248b9169b0ae97f5493f63f9e6db8bb,82493b30f248b9169b0ae97f5493f63f9e6db8bb,Disable urllib3 warnings
khamidou,2016-08-18 23:42:49,https://api.github.com/repos/nylas/sync-engine/git/commits/4747996831298677306de3df045c29cc905eef76,4747996831298677306de3df045c29cc905eef76,Embed IPython in the right scope.
jstejada,2016-08-16 22:45:43,https://api.github.com/repos/nylas/sync-engine/git/commits/5d52ca1bf7e13b59408457e85276a1abf0575709,5d52ca1bf7e13b59408457e85276a1abf0575709,Update gitignore
dregitsky,2016-08-16 22:12:48,https://api.github.com/repos/nylas/sync-engine/git/commits/487d290b8712b1303d90ddaf81b2d48749e62c55,487d290b8712b1303d90ddaf81b2d48749e62c55,"Call `expunge` in delta/longpoll endpoint to prevent long-lived transaction

References to g.namespace in the delta/longpoll endpoint after closing the
session may be causing a long-lived session. Expunge the namespace object
to prevent this, like what we do in the delta/streaming endpoint."
pfista,2016-08-16 20:41:17,https://api.github.com/repos/nylas/sync-engine/git/commits/e4722b5b713dddadd6d6b62e35a03d197173aa67,e4722b5b713dddadd6d6b62e35a03d197173aa67,"Properly set the from address when generating ical invite messages

Summary:
A customer had an issue where they were unable to update the `To` field
when replying to an ical invite message that had its `From` field set to the
`account.email_address` in non-browser versions of Outlook. To avoid this, we
should set the `From` field to an address from our actual mailsend provider
(mailgun) to avoid this error.

Test Plan:
Added a test to make sure the From header is set to
""notifications@mg.nylas.com""

Reviewers: khamidou

Differential Revision: https://phab.nylas.com/D3165"
mhahnenberg,2016-08-16 01:52:39,https://api.github.com/repos/nylas/sync-engine/git/commits/602635c38fcbb2e83513e8850c8a58ea896364fa,602635c38fcbb2e83513e8850c8a58ea896364fa,"Make mocking DNS resolution easier (#375)

Moving MockDNSResolver and adding a nice yield fixture makes it more accessible
from other repositories."
mhahnenberg,2016-08-15 23:01:44,https://api.github.com/repos/nylas/sync-engine/git/commits/54e50db9b36d03bd707e30ebc4398c029c020c95,54e50db9b36d03bd707e30ebc4398c029c020c95,"Use SQLAlchemy's synonym for Folder canonical_name (#381)

This allows us to use the property getter/setter stuff while retaining the
ability to say things like ""Folder.canonical_name"" in SQLAlchemy queries."
mhahnenberg,2016-08-15 19:17:46,https://api.github.com/repos/nylas/sync-engine/git/commits/9db8951723d4caf66b7c15082229a5b66952de45,9db8951723d4caf66b7c15082229a5b66952de45,"Fix the tests! (#379)

There was turmoil last week on Travis due to upgrade pytest to 2.8.0, so some
of the tests started failing w/o us noticing. Let's fix (most of) them!"
kevinmartin,2016-08-15 17:59:43,https://api.github.com/repos/nylas/sync-engine/git/commits/f1e82472260e47e843c706f0c53f06263ebe3280,f1e82472260e47e843c706f0c53f06263ebe3280,"Add Tiliq to Providers (#287)

* Add Tiliq to Providers

* Add to list alphabetically"
dregitsky,2016-08-12 21:59:43,https://api.github.com/repos/nylas/sync-engine/git/commits/f168287017dbbda17c23e589768d1e6cbfe849bc,f168287017dbbda17c23e589768d1e6cbfe849bc,"Fix bug in multisend finish during deletion of sent messages

Summary:
The syncback refactor in D3115 added a required param to
`remote_delete_sent` that was not being passed from the `multi_send_finish`
endpoint, where the function is called directly. This was causing the
delete to always fail during multi-send.

Adds the required param to the function call and adds a regression test.

Test Plan: Adds a test for this issue, existing tests pass.

Reviewers: khamidou

Reviewed By: khamidou

Subscribers: jenkins, jackie

Differential Revision: https://phab.nylas.com/D3159"
hallamoore,2016-08-12 21:13:09,https://api.github.com/repos/nylas/sync-engine/git/commits/92313a289abe74cdf8f1e014df8d17620d146cad,92313a289abe74cdf8f1e014df8d17620d146cad,"Update folder roles if they've been changed (#370)

* Update the role for a Folder/Category if the role has changed

We've implemented code to guess folder roles, but these guesses aren't saved after the
initial creation of the folder. This diff changes that, so that users with accounts from
before the role guessing implementation can have their folders updated properly.

* Add some more folder edge cases

* Define getter/setter for Folder.canonical_name

The setter automatically updates the role for the corresponding Category, so that
people don't have to remember to update both."
mhahnenberg,2016-08-12 21:11:13,https://api.github.com/repos/nylas/sync-engine/git/commits/4cf43c124d21da4281bbd31240ed38e566869f0c,4cf43c124d21da4281bbd31240ed38e566869f0c,Add ability to customize mock IMAP ValidationError (#369)
bengotow,2016-08-12 17:15:32,https://api.github.com/repos/nylas/sync-engine/git/commits/b96214260048977ccd6e02c0fd6d3b82dd8ceb11,b96214260048977ccd6e02c0fd6d3b82dd8ceb11,"Update pytest, support numbers in sanitize_name"
bengotow,2016-08-12 01:43:38,https://api.github.com/repos/nylas/sync-engine/git/commits/e437dfac28036ca24e613698b8867d0c50c0ae34,e437dfac28036ca24e613698b8867d0c50c0ae34,Fix linter errors
bengotow,2016-08-12 01:27:54,https://api.github.com/repos/nylas/sync-engine/git/commits/0de05abd4eed79d59f52453fbe0ddf1fdc8467ed,0de05abd4eed79d59f52453fbe0ddf1fdc8467ed,Convert to unicode using more robust `decode`—fixes EAS specs
pfista,2016-08-11 22:06:15,https://api.github.com/repos/nylas/sync-engine/git/commits/7b5f2e52c2011974c4c6afc694269183cbe35563,7b5f2e52c2011974c4c6afc694269183cbe35563,"TLS Improvements

Better TLS support, certificate verification, and fixes for python <2.7.9 ssl ssl warnings"
brandoncc,2016-08-11 01:10:13,https://api.github.com/repos/nylas/sync-engine/git/commits/fa3664652b0a29479eebe17fef0502d7edc4f49e,fa3664652b0a29479eebe17fef0502d7edc4f49e,Fix typo (#371)
pfista,2016-08-09 21:56:45,https://api.github.com/repos/nylas/sync-engine/git/commits/42381aef0958e960bd9a8fde4f9e035efa0746d7,42381aef0958e960bd9a8fde4f9e035efa0746d7,"Revert ""TLS Improvements""

This reverts commit f7cb6e8e413b659186c371b68fbbd03cdfa62341."
bengotow,2016-08-09 18:36:41,https://api.github.com/repos/nylas/sync-engine/git/commits/67d531097a9ad21e441e9792a6ba33bbcd438bd8,67d531097a9ad21e441e9792a6ba33bbcd438bd8,"Only log repeated transient errors (#351)

* Silence socket errors and SSL errors until the 20th time in a row

* Move while true outside of retry_with_logging, so successful passes through reset retry counters

* Include redis timeout in transient errors

* Python != JS, must take arg when given

* Stop keeping saved_folder_status in addition to state, which is super confusing, just load and save as necessary since state should change very infrequently

* Add note to retry_with_logging

* Fix specs and add new one for logging behavior

* Move db_session.commit to fix initial state"
pfista,2016-08-09 16:43:32,https://api.github.com/repos/nylas/sync-engine/git/commits/f7cb6e8e413b659186c371b68fbbd03cdfa62341,f7cb6e8e413b659186c371b68fbbd03cdfa62341,"TLS Improvements

Better TLS support, certificate verification, and fixes for python <2.7.9 ssl ssl warnings"
jstejada,2016-08-08 23:43:42,https://api.github.com/repos/nylas/sync-engine/git/commits/4da0442e57c72eb9b7613a2af600dec489bb7df9,4da0442e57c72eb9b7613a2af600dec489bb7df9,"Make sure queries by name to Folder/Label/Category account for truncation (#358)

- Cleans up Folder/Label/Category name sanitization code which was mostly duplicated
- Added a custom string type for Category names to make sure we always store properly sanitized strings, and extends `__eq__` comparison to compare against the truncated string, which is what we actually store in the database, even if the user queries using a longer (original) name. Going forward, any queries by name will now compare against the correct string.
- This only affects querying-- we still use the full folder name to be able to select the folder correctly in IMAP inside the sync engine
- Improves logging -- don't interpolate strings in the logs!

- This addresses most occurrences of https://sentry.nylas.com/sentry/sync-prod/group/8243/events/"
bengotow,2016-08-08 22:11:42,https://api.github.com/repos/nylas/sync-engine/git/commits/df403cca3e02f36d37691c4539f3d2739a462346,df403cca3e02f36d37691c4539f3d2739a462346,Fix event/when specs broken by 0722050
pfista,2016-08-08 21:14:37,https://api.github.com/repos/nylas/sync-engine/git/commits/846d008d3f6ec9e3ce6706a3b4318f54b79a72db,846d008d3f6ec9e3ce6706a3b4318f54b79a72db,"Thread count test

Add test to ensure limit, offset, and in_ filters return the correct number of threads when used together"
mhahnenberg,2016-08-08 19:31:36,https://api.github.com/repos/nylas/sync-engine/git/commits/8aab04213b9f090e363fd93e3ba785f4a5fd7848,8aab04213b9f090e363fd93e3ba785f4a5fd7848,"Unquiet pip during setup.sh and unbreak build (#364)

We want to see how things fail if they do. Also updates the imapclient
requirement so that the build doesn't fail any more :-)"
pfista,2016-08-08 17:17:36,https://api.github.com/repos/nylas/sync-engine/git/commits/36af600f7a0ddc843d3f0f7d554747bd1d00c386,36af600f7a0ddc843d3f0f7d554747bd1d00c386,"Revert ""Rearrange how Thread queries work to produce nicer queries""

This reverts commit e56067e7564a57bae635ebdf91deb2fa441d6d91."
bengotow,2016-08-06 00:08:50,https://api.github.com/repos/nylas/sync-engine/git/commits/072205068158be05d3d513fcd480534a9734011f,072205068158be05d3d513fcd480534a9734011f,"Fix low-hanging errors (#345) - Sentry #24197, #5907, #7654, #7659

* Don’t throw exceptions if folder is already gone #7654

* Silence socket errors and SSL errors until the 20th time in a row

* The display_name field typically contains INBOX.Foo for Fastmail. API request changes it to Foo and then we fix and re-save from the sync code. Isntead, just never put unprefixed `Foo` into the db in the first place

* Ignore CRUD actions on labels if they do not exist #7659

* Lots of events have end < start, just flip em and carry on #24197

* Add Redis timeouts to list of transient errors

* Handle nil internaldate without throwing (#5907), investigate bad folder_status response

* Update specs

* Handle occasional messages with body=None, 1970 date #3387

* iCloud get_address_book_home 403’ing due to bad URL format #20277

I verified this fix with my own iCloud account. Was able to reproduce 403 before fix, 200 and working sync after fix

* Revert ""Add Redis timeouts to list of transient errors""

This reverts commit 26b5e2f93d2b20bfc3d317d0b38897555c8a3538.

* Revert ""Silence socket errors and SSL errors until the 20th time in a row""

This reverts commit 482f2fe53f31f016098280a4277d825ff6d13c73.

* Don’t check for epoch timestamps ¯\_(ツ)_/¯

* Move handling of inverted start, end into remote processing"
bengotow,2016-08-05 23:30:09,https://api.github.com/repos/nylas/sync-engine/git/commits/9133fd0cf6b2bbd31b76ae2697c3d71449f82449,9133fd0cf6b2bbd31b76ae2697c3d71449f82449,Downgrade imapclient setuptools to 18.2. 18.8.1 is not available on jenkins
bengotow,2016-08-05 22:58:27,https://api.github.com/repos/nylas/sync-engine/git/commits/a37b2240e4df0b6e958c644e8f75b6566f0714cc,a37b2240e4df0b6e958c644e8f75b6566f0714cc,"Use FLAGS.SILENT instead of FLAGS, skip parsing unused response (#362)

* Use FLAGS.SILENT instead of FLAGS, skip parsing unused response

* Update specs"
mhahnenberg,2016-08-05 22:14:30,https://api.github.com/repos/nylas/sync-engine/git/commits/53714a663cff41f9899098e8c88aa8acb7deeb71,53714a663cff41f9899098e8c88aa8acb7deeb71,"Add timestamps to setup.sh output for Travis (#355)

This will be helpful to analyze which parts of the Travis build are taking the
longest. This also removes the /usr/local/lib/python2.7/dist-packages from the
cache settings in Travis config file because it was causing the cache step to
take > 3 minutes and then time out. By not trying to cache this directory we
save those 3 minutes of build time."
mhahnenberg,2016-08-05 21:35:25,https://api.github.com/repos/nylas/sync-engine/git/commits/b0fe6aa993534993a01db41166173dd098d468b4,b0fe6aa993534993a01db41166173dd098d468b4,"Clean up after fixtures that modify the database (#352)

A lot of our tests depend on fixtures to insert some data into the database;
however, they don't then remove the data they added, affecting the
behavior of future tests. This diff attempts to fix that for a large number
of our test fixtures. I think it reduces test running time a tad since there
is less data that accumulates for the tests to have to deal with. Might just
be noise though."
mhahnenberg,2016-08-05 18:21:58,https://api.github.com/repos/nylas/sync-engine/git/commits/f948d7e4b0f2d00a0edf4f06c1abcee389f71086,f948d7e4b0f2d00a0edf4f06c1abcee389f71086,"Make _trim_filename great again (#360)

It used to be None-safe, but it was recently changed which broke some tests."
bengotow,2016-08-05 18:18:46,https://api.github.com/repos/nylas/sync-engine/git/commits/5a85f0681e23316b4be040c8a08ef37f6aa4e540,5a85f0681e23316b4be040c8a08ef37f6aa4e540,"Add 3 missing tzs and add support for friendly timezone names (#353)

* Add 3 missing tzs and add support for friendly timezone names

Calendar sync encountered many exceptions for my bengotow@gmail.com Google calendar because it couldn’t find timezones for some of my events. This diff adds a few TZs I discovered were missing from https://github.com/regebro/tzlocal.

It also adds support for many more timezone strings, drawn from:
https://msdn.microsoft.com/en-us/library/ms912391(v=winembedded.11).aspx
http://micc.mitel.com/kb/Attachment442.aspx

This fixes my calendar.

* Add more timezones from my mail. USA! 🇺🇸🇺🇸🇺🇸

* Uppercase UTC/GMT"
mhahnenberg,2016-08-05 17:15:10,https://api.github.com/repos/nylas/sync-engine/git/commits/0f8fe1cabd3afb2a4f0818ca0649980a40d1c3ce,0f8fe1cabd3afb2a4f0818ca0649980a40d1c3ce,"Fix a couple sleeping tests with freezegun (#354)

Freezegun allows us to directly manipulate what time our tests think it is. So
now we don't have to actually sleep to get the clock the move forward :-D"
bengotow,2016-08-05 15:53:57,https://api.github.com/repos/nylas/sync-engine/git/commits/f040a779755ef77fde0e326c4cf983da7310181b,f040a779755ef77fde0e326c4cf983da7310181b,"Fix event parsing to support missing “LAST-MODIFIED” (#356)

I have a bunch of event invites sent from UberConference in my account. They do not have DTSTAMP or LAST-MODIFIED. Our Events table supports null values in that column, so I think we should allow them to be parsed and not blow up.

The exception this fixes is below:

{""traceback"": [""Traceback (most recent call last):\n"", ""  File \""/vagrant/inbox/events/ical.py\"", line 391, in import_attached_events\n    part_data)\n"", ""  File \""/vagrant/inbox/events/ical.py\"", line 120, in events_from_ics\n    last_modified = component.get('last-modified').dt\n"", ""AttributeError: 'NoneType' object has no attribute 'dt'\n""], ""account_id"": 7, ""level"": ""error"", ""timestamp"": ""2016-08-04T23:51:18.138445Z"", ""greenlet_id"": 74350096, ""module"": ""inbox.events.ical:410"", ""event"": ""Unhandled exception during message parsing"", ""state"": ""initial"", ""provider"": ""gmail"", ""folder"": ""[Gmail]/All Mail"", ""logstash_tag"": ""icalendar_autoimport"", ""message_id"": 89225, ""invite"": “…"
bengotow,2016-08-05 15:48:00,https://api.github.com/repos/nylas/sync-engine/git/commits/a30f79d1ec1f07210f776cf5cfee64a441b66ede,a30f79d1ec1f07210f776cf5cfee64a441b66ede,"Rewrite filename trunction to handle UTF8 correctly, add test (#357)

* Rewrite filename trunction to handle UTF8 correctly, add test

Based on Slack conversation here: https://nylas.slack.com/archives/sync/p1470352819000868

* A couple more test cases, handling of super-long file extensions"
jstejada,2016-08-04 21:27:47,https://api.github.com/repos/nylas/sync-engine/git/commits/66cf5ca096c8b327e6facf6bb71b59efe633c1d0,66cf5ca096c8b327e6facf6bb71b59efe633c1d0,Fix tests
annielcook,2016-08-04 17:42:29,https://api.github.com/repos/nylas/sync-engine/git/commits/a3341fae1b2c96dc4cd087ce16b2c4fd4a83be81,a3341fae1b2c96dc4cd087ce16b2c4fd4a83be81,fix(lint): Whitespace autopep8 lint changes
mhahnenberg,2016-08-04 19:16:03,https://api.github.com/repos/nylas/sync-engine/git/commits/1775101b5846cf3e47fd2c07de3d78b36260918c,1775101b5846cf3e47fd2c07de3d78b36260918c,"Mock IMAPClient and SMTPClient for auth tests (#346)

The auth tests are slow because they run against live services. It isn't
necessary to test the underlying libraries we use to speak IMAP/SMTP, so we
should just mock them out so our tests run faster. Very unscientific tests
show this reducing our test running time by ~30 seconds on a laptop."
mhahnenberg,2016-08-04 19:04:00,https://api.github.com/repos/nylas/sync-engine/git/commits/072d6998d959862dcb6fd9e298716e8bb77f9a2c,072d6998d959862dcb6fd9e298716e8bb77f9a2c,"Don't sleep for 30s during folder sync tests (#332)

This was slowing our folder sync tests way down. We override the poll_frequency
so that we don't sleep at the end of a call to poll_impl."
khamidou,2016-08-04 17:39:43,https://api.github.com/repos/nylas/sync-engine/git/commits/84c41a45ba3a00945faa6c9bc8319d031a697c01,84c41a45ba3a00945faa6c9bc8319d031a697c01,Log the contents of the X-Request-Id HTTP header on every call to `log.info`
jstejada,2016-08-04 00:29:09,https://api.github.com/repos/nylas/sync-engine/git/commits/ac7a6eb2d94570e9824bf32c1b076ff291c5074b,ac7a6eb2d94570e9824bf32c1b076ff291c5074b,Fix test error -- use nylas_uid instead of inbox_uid
bengotow,2016-08-03 18:56:14,https://api.github.com/repos/nylas/sync-engine/git/commits/ca0e416840d19268b82e7c008d50718a96f3d761,ca0e416840d19268b82e7c008d50718a96f3d761,"cleanup(*): rm refs to Inbox that refer to company, not inbox (#330)

* cleanup(*): rm refs to Inbox that refer to company, not inbox

* A few other replacements

* Completely remove inbox_uid"
mhahnenberg,2016-08-03 18:17:42,https://api.github.com/repos/nylas/sync-engine/git/commits/e9011fc3c5c59fb44d21c570ff0cb6f964f9bde8,e9011fc3c5c59fb44d21c570ff0cb6f964f9bde8,"Speed up concurrency tests (#342)

This was just another case of a test sleeping for some long amount of time
during the test. We've also moved mock_gevent_sleep to be usable by all tests
via conftest.py."
mhahnenberg,2016-08-03 17:49:35,https://api.github.com/repos/nylas/sync-engine/git/commits/727c764b13712b892a8720ee7b581aa827fac235,727c764b13712b892a8720ee7b581aa827fac235,Fix lint error (#344)
khamidou,2016-08-03 15:24:34,https://api.github.com/repos/nylas/sync-engine/git/commits/36f5baaa5f217aa974bc761d123247f3c3560454,36f5baaa5f217aa974bc761d123247f3c3560454,Fix inbox-console.
spang,2016-08-03 15:02:43,https://api.github.com/repos/nylas/sync-engine/git/commits/1077a2a9682cb1facb473cf5560cc99a778059c3,1077a2a9682cb1facb473cf5560cc99a778059c3,Remove deleted summary-stats
spang,2016-08-03 02:55:49,https://api.github.com/repos/nylas/sync-engine/git/commits/c99656df3c048faf7951e54d74cb5ef9d7dc3c97,c99656df3c048faf7951e54d74cb5ef9d7dc3c97,Remove deprecated summary-stats script
spang,2016-08-03 00:35:11,https://api.github.com/repos/nylas/sync-engine/git/commits/74daeab7cea92bf07c06ed14c273591767626bf0,74daeab7cea92bf07c06ed14c273591767626bf0,"Revert ""Support cross-signed CA""

This reverts commit d1d1da24583ed9c9d3dd5e79d02bf10def8d2a8c.

Reason for revert: breaks syncs."
spang,2016-08-03 00:34:55,https://api.github.com/repos/nylas/sync-engine/git/commits/249793379f4a06682e8916457b6ae625397592aa,249793379f4a06682e8916457b6ae625397592aa,"Revert ""Use exc_info""

This reverts commit f4b5bb93d2ed4da77b5dedc1b860d2f4944c0400.

Reason for rollback: breaks sync."
spang,2016-08-03 00:34:29,https://api.github.com/repos/nylas/sync-engine/git/commits/676bf9f774700ebea92a40a624cc3aa0e20f7883,676bf9f774700ebea92a40a624cc3aa0e20f7883,"Revert ""Don't use absolute path for certifi certs""

This reverts commit f437f2e1c245988a32020eb78b652f8d844d01d2.

Reason for rollback: breaks syncs."
mhahnenberg,2016-08-02 23:16:22,https://api.github.com/repos/nylas/sync-engine/git/commits/d45b3ea5abb91df452ba0d024eadf482eb3191fc,d45b3ea5abb91df452ba0d024eadf482eb3191fc,"Mock out DNS resolver for provider resolution test (#341)

This test previously depended on actually querying a DNS server which could
cause it to take an arbitrary amount of time depending on network conditions.
This diff mocks out the DNS resolver to do a lookup in a local dictionary
instead."
jstejada,2016-08-02 23:06:24,https://api.github.com/repos/nylas/sync-engine/git/commits/ab6fb92d8056dfb050102ea09a6eb367c1f15b80,ab6fb92d8056dfb050102ea09a6eb367c1f15b80,Remove deleted script from setup.py
bengotow,2016-08-02 01:04:54,https://api.github.com/repos/nylas/sync-engine/git/commits/dc3397f25f11edec660f90accae18278df9f433a,dc3397f25f11edec660f90accae18278df9f433a,Always reset sync_error fields when sync starts again
bengotow,2016-08-02 01:03:56,https://api.github.com/repos/nylas/sync-engine/git/commits/2a019ad71a4f4d488cf4995a3681c6cd668d3059,2a019ad71a4f4d488cf4995a3681c6cd668d3059,Remove S3 rollback support
mhahnenberg,2016-08-02 22:15:48,https://api.github.com/repos/nylas/sync-engine/git/commits/c21adde1be78559dd5bcd7a0be9add99d64143bc,c21adde1be78559dd5bcd7a0be9add99d64143bc,"Reduce amount of test data generated by hypothesis (#334)

We use hypothesis to autogenerate random test data for some of our IMAP sync
tests. The generation of this data is actually quite expensive due to the
amount of data we were generating. It also causes our tests to run slower since
we have so much data to process. This diff cuts down the amount of data we're
generating by around an order of magnitude."
mhahnenberg,2016-08-02 22:15:01,https://api.github.com/repos/nylas/sync-engine/git/commits/4535e58589970f4fe4021dad8f4fc5caf8b98995,4535e58589970f4fe4021dad8f4fc5caf8b98995,"Sleep less, test more (#338)

There are a number of tests that are using calls to sleep to achieve an effect
that they could get more precisely from something else (e.g. join). Let's
change these call sites so that we don't have to waste a bunch of time sleeping
during our tests."
mhahnenberg,2016-08-02 21:12:18,https://api.github.com/repos/nylas/sync-engine/git/commits/4f3df761c557b084ceb8ec89d758ac151b2b61db,4f3df761c557b084ceb8ec89d758ac151b2b61db,"Fix SQLAlchemy package requirement (#340)

We based our fix on the 1.1.0beta3 release of SQLAlchemy which caused some
tests to start failing mysteriously. Upon forcing a downgrade of the package to
1.0.14 the tests started passing again. We've updated our fork by backporting
the baked query fix to the 1.0.14 release which we now reference in
requirements.txt."
pfista,2016-08-02 20:51:38,https://api.github.com/repos/nylas/sync-engine/git/commits/f437f2e1c245988a32020eb78b652f8d844d01d2,f437f2e1c245988a32020eb78b652f8d844d01d2,Don't use absolute path for certifi certs
pfista,2016-08-02 16:30:52,https://api.github.com/repos/nylas/sync-engine/git/commits/f4b5bb93d2ed4da77b5dedc1b860d2f4944c0400,f4b5bb93d2ed4da77b5dedc1b860d2f4944c0400,Use exc_info
pfista,2016-08-02 16:29:40,https://api.github.com/repos/nylas/sync-engine/git/commits/d1d1da24583ed9c9d3dd5e79d02bf10def8d2a8c,d1d1da24583ed9c9d3dd5e79d02bf10def8d2a8c,"Support cross-signed CA

Updates requests, gevent, urllib3."
jstejada,2016-08-02 16:20:39,https://api.github.com/repos/nylas/sync-engine/git/commits/f96f11a776a314ea9b070c048005ce3a47010ba9,f96f11a776a314ea9b070c048005ce3a47010ba9,Use pip 8 inside setup.sh
spang,2016-08-02 15:45:24,https://api.github.com/repos/nylas/sync-engine/git/commits/b96095022f147f8ab3578350a3db49dde5239f1a,b96095022f147f8ab3578350a3db49dde5239f1a,Unify Travis lint configuration with Jenkins
spang,2016-08-02 14:57:32,https://api.github.com/repos/nylas/sync-engine/git/commits/cd17e675c555f8746ef235aefc27c5ed205420e3,cd17e675c555f8746ef235aefc27c5ed205420e3,Fix JSON indentation
khamidou,2016-08-02 08:05:44,https://api.github.com/repos/nylas/sync-engine/git/commits/91744eb3fbe8f1deb70066af481cc12b2f3b8b6e,91744eb3fbe8f1deb70066af481cc12b2f3b8b6e,"Fix an elusive MySQL integrity issue

Summary:
This diff fixes a bug which has been on my radar for a while --- according to Sentry (https://sentry.nylas.com/sentry/sync-prod/?query=Incorrect+string+value) it's been affecting around 600 accounts, breaking the sync for some of them.

The fix is pretty simple but it took some sleuthing and a long time reading about Unicode, MySQL and Python 2.

In https://github.com/nylas/sync-engine/blob/master/inbox/models/event.py#L145 we're truncating the length of some strings we're inserting in the db. Unfortunately, this function doesn't handle Unicode strings, causing us to sometimes truncate strings in the middle of a codepoint. Sadly, Python 2.x gladly accepts this, which causes the error to trickle down to MySQL, which ends up throwing an integrity error.

Test Plan: Wrote a regression test.

Reviewers: spang, mark

Reviewed By: mark

Subscribers: jenkins

Differential Revision: https://phab.nylas.com/D3145"
khamidou,2016-08-02 07:35:07,https://api.github.com/repos/nylas/sync-engine/git/commits/f6a2075acabb62e0f683d92c8540c4c1af46786e,f6a2075acabb62e0f683d92c8540c4c1af46786e,"`FORCE INDEX` more conservatively

Summary: This is a rework of D3118. The previous fix got reverted because using the same index in all cases isn't right (for example if you're filtering over the messages in a given thread). This diff limits forcing the index to the cases where we're simply querying `/messages` or asking for messages before/after a given date.

Test Plan: Tested manually with a couple example queries. Checked that the generated SQL made sense and ran a couple queries in the MySQL optimizer to see which index would get picked up.

Reviewers: spang, rene

Reviewed By: rene

Subscribers: jenkins

Maniphest Tasks: T6967

Differential Revision: https://phab.nylas.com/D3132"
spang,2016-08-01 23:38:17,https://api.github.com/repos/nylas/sync-engine/git/commits/472ed6d2d0119063dfed340b7ea04c45abe6f7f6,472ed6d2d0119063dfed340b7ea04c45abe6f7f6,"Merge back dependencies from other internal repos

This is a python _application_, and always expects its dependencies to be
installed from requirements.txt. Having a subset of dependencies duplicated
in setup.py was extremely confusing and resulted in dependency installation
bugs."
pfista,2016-07-28 18:07:20,https://api.github.com/repos/nylas/sync-engine/git/commits/485555aa673ce4d86515fdbee0f4402d5181b6c9,485555aa673ce4d86515fdbee0f4402d5181b6c9,fix lint errors
spang,2016-07-27 18:45:04,https://api.github.com/repos/nylas/sync-engine/git/commits/89ae05c6663132b4679b1d56076acf8bce361068,89ae05c6663132b4679b1d56076acf8bce361068,"Revert ""Force usage of the `ix_message_ns_id_is_draft_received_date` index""

This reverts commit 17761ecaf50c629b3f7e6d602ec5fb14395c4afb.

Reason for revert: erroneously adds FORCE INDEX to more queries than it
should, resulting in a performance regression across the MySQL clusters."
khamidou,2016-07-27 12:40:38,https://api.github.com/repos/nylas/sync-engine/git/commits/8ce3fa661e933e8a380c553fe63808f50bca8df1,8ce3fa661e933e8a380c553fe63808f50bca8df1,Display an error if REDIS_SHARDS isn't defined correctly.
khamidou,2016-07-27 10:35:44,https://api.github.com/repos/nylas/sync-engine/git/commits/46b67e57067e2df32ed00a5b2421bc74cc3bbd28,46b67e57067e2df32ed00a5b2421bc74cc3bbd28,"Fix cancellation sending for Exchange

Summary:
This diff fixes a long-standing bug --- Exchange wouldn't process our invite cancellation messages correctly. Sending a cancellation message to an Exchange server would result in Exchange stripping out the cancellation part of the invite, causing the event to stay on the recipient's calendar. I suppose it's because Exchange throws away what it doesn't understand.

After spending a looong time time trying various iCalendar and MIME incantations to have Exchange accept the invite, I figured out the solution: you don't negotiate with terrorists.

We're now sending the invite through Mailgun instead of Exchange. This works reliably across providers.

Test Plan: Tested manually by sending cancellation messages to Gmail and Exchange users.

Reviewers: spang

Reviewed By: spang

Subscribers: jenkins, gleb

Differential Revision: https://phab.nylas.com/D3125"
pfista,2016-07-26 22:46:34,https://api.github.com/repos/nylas/sync-engine/git/commits/dd6be6ef1266af2e3f80fd357f0d654ac72300d1,dd6be6ef1266af2e3f80fd357f0d654ac72300d1,Update PR template
bengotow,2016-07-26 21:36:02,https://api.github.com/repos/nylas/sync-engine/git/commits/9948e9e29869c60ecde4c3cdac723d171fa1423f,9948e9e29869c60ecde4c3cdac723d171fa1423f,"Draft Syncback Fixes (#322)

* Be explicit about draft replaced in update, allow for non-Nylas MessageIDs

* Set is_created when updating Gmail drafts so reconcilation succeeds

* Don’t assume that the old_message_id_header is always set"
pfista,2016-07-26 21:34:38,https://api.github.com/repos/nylas/sync-engine/git/commits/f293fb1f0ee2b6ca04595d4990db93844836223a,f293fb1f0ee2b6ca04595d4990db93844836223a,create pull request template
pfista,2016-07-26 21:19:04,https://api.github.com/repos/nylas/sync-engine/git/commits/97d5ee5ccf43718ca4ded19197e7692e13d1a0ff,97d5ee5ccf43718ca4ded19197e7692e13d1a0ff,create .lgtm settings file
jstejada,2016-07-26 18:56:16,https://api.github.com/repos/nylas/sync-engine/git/commits/e0166657d3dfa779f57763fff04ba58c865f9913,e0166657d3dfa779f57763fff04ba58c865f9913,"Fix running alembic migrations in offilne mode (`--sql`)

- Add required url parameter"
hallamoore,2016-07-22 23:32:01,https://api.github.com/repos/nylas/sync-engine/git/commits/6eb73c1e20a9cdc02389c327f18e05edf8ba7777,6eb73c1e20a9cdc02389c327f18e05edf8ba7777,"Fix issue with labels not being deleted when they've been deleted from gmail

Summary:
Labels that are deleted from Gmail are never deleted in N1. There is a check to
make sure that we don't delete standard labels, but this checks that the canonical
name is None, while the default value for canonical names is actually an empty string.
Python doesn't evaluate '' to be None, so the condition is never satisfied and we
never delete any labels that aren't deleted from within N1. This diff changes the
condition to check if the canonical name is Falsy instead.

Test Plan: Tested locally

Reviewers: bengotow, annie, khamidou

Reviewed By: khamidou

Subscribers: khamidou, jenkins

Differential Revision: https://phab.nylas.com/D3126"
dregitsky,2016-07-25 20:39:14,https://api.github.com/repos/nylas/sync-engine/git/commits/2e7d814012a5f1ebb638929c6beacb6506f74f9b,2e7d814012a5f1ebb638929c6beacb6506f74f9b,"Adding filtering function for new all metadata endpoint

Summary:
Adds a filtering function for Metadata that allows querying over all
metadata for an application, using the new `queryable_value` field.

Test Plan: Tested in redwood via new API endpoint.

Reviewers: spang

Reviewed By: spang

Subscribers: khamidou, jenkins, juan

Differential Revision: https://phab.nylas.com/D3102"
bengotow,2016-07-25 18:59:36,https://api.github.com/repos/nylas/sync-engine/git/commits/c5fd32f5de2c8891b0717845bd70d883e4e757cf,c5fd32f5de2c8891b0717845bd70d883e4e757cf,Skip tests requiring network on firewalled ports for Travis
bengotow,2016-07-25 18:28:25,https://api.github.com/repos/nylas/sync-engine/git/commits/e950136eff7789d43e7aaacefd64d0c003b6d6c3,e950136eff7789d43e7aaacefd64d0c003b6d6c3,Stop Travis from creating it’s own virtualenv
bengotow,2016-07-25 16:59:30,https://api.github.com/repos/nylas/sync-engine/git/commits/20cbf6849d2e0fe16ad3e813fda54c54c79157a6,20cbf6849d2e0fe16ad3e813fda54c54c79157a6,Make Travis put python packages into cache dir
bengotow,2016-07-23 00:13:45,https://api.github.com/repos/nylas/sync-engine/git/commits/9cbdce11f861d9d847da6de673fc8f7aceb39628,9cbdce11f861d9d847da6de673fc8f7aceb39628,Make Travis cache pip files
bengotow,2016-07-22 23:54:25,https://api.github.com/repos/nylas/sync-engine/git/commits/830a43bbc2366488f5f64f1dcea1ab33cc012293,830a43bbc2366488f5f64f1dcea1ab33cc012293,"Make Travis happy, make builds fail rather than error"
bengotow,2016-07-22 23:34:51,https://api.github.com/repos/nylas/sync-engine/git/commits/5e2d3146e4d066838eb1bff530928e01a368ce04,5e2d3146e4d066838eb1bff530928e01a368ce04,Make Travis try extra hard to run flake8+pep
bengotow,2016-07-22 23:29:54,https://api.github.com/repos/nylas/sync-engine/git/commits/609ee8ca5588040357d21659ddb8c96bb15d8370,609ee8ca5588040357d21659ddb8c96bb15d8370,Make Travis run flake8+pep
bengotow,2016-07-22 23:24:59,https://api.github.com/repos/nylas/sync-engine/git/commits/7f64e78c7f3042f0eb5d29acebb35c5cd7c1116b,7f64e78c7f3042f0eb5d29acebb35c5cd7c1116b,Fix all flake8 lint errors
bengotow,2016-07-22 22:43:54,https://api.github.com/repos/nylas/sync-engine/git/commits/2e820248e6332b43818a70d5285e986a5be1323f,2e820248e6332b43818a70d5285e986a5be1323f,Fix all pep8 lint errors
khamidou,2016-07-22 13:55:33,https://api.github.com/repos/nylas/sync-engine/git/commits/17761ecaf50c629b3f7e6d602ec5fb14395c4afb,17761ecaf50c629b3f7e6d602ec5fb14395c4afb,"Force usage of the `ix_message_ns_id_is_draft_received_date` index

Summary: Some queries to the `/messages` endpoint are failing because MySQL won't use the right index (`ix_message_ns_id_is_draft_received_date`). This is mildly surprising because typical `/messages` queries lookup the `namespace_id`, `is_draft` and `received_date` fields, in this order. This diff fixes that by passing a `FORCE INDEX` statement to MySQL.

Test Plan: Tested manually --- checked that the `FORCE INDEX` statement was in the generated SQL.

Reviewers: rene, spang

Reviewed By: rene, spang

Maniphest Tasks: T6967

Differential Revision: https://phab.nylas.com/D3118"
dregitsky,2016-07-22 00:09:55,https://api.github.com/repos/nylas/sync-engine/git/commits/894267d349187f9f1a114977af52caa24ca67024,894267d349187f9f1a114977af52caa24ca67024,"[SCHEMA] Add queryable_value column to Metadata

Summary:
Adds a new integer column to the Metadata table to allow querying for
metadata by value. The column functions as in index on a particular value
in the metadata's JSON value. The column will be populated in application
code based on the Metadata.value field, using a specified field name per
app.

Test Plan: Will be tested along with dependent code in redwood.

Reviewers: spang

Reviewed By: spang

Subscribers: jenkins, khamidou, juan

Differential Revision: https://phab.nylas.com/D3099"
pfista,2016-07-21 21:47:43,https://api.github.com/repos/nylas/sync-engine/git/commits/9b8cf33c2d17e311e1351d1cf8f47b001c5a073d,9b8cf33c2d17e311e1351d1cf8f47b001c5a073d,Improving inbox console
pfista,2016-07-21 21:15:18,https://api.github.com/repos/nylas/sync-engine/git/commits/6ccbc2343f68b04dbdad56c5dd6da36f8c5a2563,6ccbc2343f68b04dbdad56c5dd6da36f8c5a2563,Allow user to select account with multiple emails
spang,2016-07-16 03:54:58,https://api.github.com/repos/nylas/sync-engine/git/commits/09f7a52830e4c2c077e3f9ee31f310d46c6a458b,09f7a52830e4c2c077e3f9ee31f310d46c6a458b,Unbreak the build
spang,2016-07-15 20:22:04,https://api.github.com/repos/nylas/sync-engine/git/commits/3b9a03509a3a281b1b2a73aed9fdb2244aa2e061,3b9a03509a3a281b1b2a73aed9fdb2244aa2e061,remove random blank lines at top of file
pfista,2016-07-15 00:54:40,https://api.github.com/repos/nylas/sync-engine/git/commits/1010797c83918fd9e6d8def7e70edaab3516cf79,1010797c83918fd9e6d8def7e70edaab3516cf79,"Delete gmail drafts created with thread id on send

Summary:
Fixes T6950

Also adds support for setting log levels when running inbox-start

Test Plan: Tested manually, updated IMAPMockClient

Reviewers: spang

Subscribers: jenkins

Maniphest Tasks: T6950

Differential Revision: https://phab.nylas.com/D3097"
pfista,2016-07-15 16:57:55,https://api.github.com/repos/nylas/sync-engine/git/commits/f8939822f66afbfa95cd0162b4579acac090a47c,f8939822f66afbfa95cd0162b4579acac090a47c,"Allow environment variable to set log level

Test Plan: none

Reviewers: spang

Reviewed By: spang

Subscribers: jenkins

Differential Revision: https://phab.nylas.com/D3098"
spang,2016-07-15 15:47:10,https://api.github.com/repos/nylas/sync-engine/git/commits/b261171446d727bdcbfeefb305f15add2c815679,b261171446d727bdcbfeefb305f15add2c815679,Update some outdated comments in crispin.py
spang,2016-07-14 00:24:54,https://api.github.com/repos/nylas/sync-engine/git/commits/bff11a5489c81576409933464879e0044f99128f,bff11a5489c81576409933464879e0044f99128f,Handle multiple/no accounts found in console better
pfista,2016-07-08 19:35:11,https://api.github.com/repos/nylas/sync-engine/git/commits/5e5e92a9b301d3d996d263c2b7489995d188b405,5e5e92a9b301d3d996d263c2b7489995d188b405,"Create emailed events on account creation

Summary:
Instead of lazily creating emailed events when parsing ics files, the calendar should be created when theaccount is created
Fixes T6945

Test Plan: manual test

Reviewers: spang

Reviewed By: spang

Subscribers: jenkins

Maniphest Tasks: T6945

Differential Revision: https://phab.nylas.com/D3088"
khamidou,2016-07-08 21:02:31,https://api.github.com/repos/nylas/sync-engine/git/commits/698dbe8e1243f98265329eef7348edfe4a1fd63f,698dbe8e1243f98265329eef7348edfe4a1fd63f,"Send a cancellation message for users who have been removed from an event

Summary:
This diff fixes an oversight with the invite sending code --- if you updated an invite by removing an attendee, they wouldn't receive an event cancellation message, which means that the event would still show up in their calendar.

To fix this issue we get the list of attendees which got removed and save it into the Action's extra_args field (we make sure to truncate it to not get over the 64k chars limit of `TEXT` fields). Then, after executing the action we send a message to the attendees.

This works great from Exchange to Gmail and Exchange to Fastmail but cancelling an invite from Exchange to Exchange doesn't work great --- you receive the cancellation but for some reason Outlook won't cancel it. I'm still looking into this issue but it's definitely not a show stopper.

Test Plan: Tested manually. Will need more extensive testing.

Reviewers: drew, spang

Reviewed By: spang

Subscribers: jenkins, tomasz

Differential Revision: https://phab.nylas.com/D3083"
khamidou,2016-07-08 19:44:32,https://api.github.com/repos/nylas/sync-engine/git/commits/be5852726a4c5147f291c2a8d4cbbab1a386bc81,be5852726a4c5147f291c2a8d4cbbab1a386bc81,"Fix method signature --- turns out the EAS code actually needs to clear
out a single folder."
spang,2016-07-08 16:36:24,https://api.github.com/repos/nylas/sync-engine/git/commits/374ccfdf8585ee22ccb279144cff77b16618f0e0,374ccfdf8585ee22ccb279144cff77b16618f0e0,"Don't sleep after every shard with no contacts to index

Summary:
Oof. This could mean we spend minutes doing nothing when there are
actually contacts that still need indexing.

Found this by finding that we would sometimes not have a heartbeat on the
service for tens of minutes at a time.

Test Plan: TIP

Reviewers: khamidou

Subscribers: jenkins

Differential Revision: https://phab.nylas.com/D3084"
spang,2016-07-07 19:34:00,https://api.github.com/repos/nylas/sync-engine/git/commits/3bfcd81a6ced8de7e818d462ba143e5e2e1311b6,3bfcd81a6ced8de7e818d462ba143e5e2e1311b6,Better logging when skipping claiming new account syncs
spang,2016-07-06 23:30:59,https://api.github.com/repos/nylas/sync-engine/git/commits/6cc2fd64efb6b5dc83f05e7b9a642526b458c83a,6cc2fd64efb6b5dc83f05e7b9a642526b458c83a,"Limit per-process syncing concurrency

Summary:
We've run into several incidents where performance on a sync process or
instance can severely drop at high levels of concurrency because many
transactions are open concurrently and excessive system load means the open
transactions are not completed in a timely manner. I also looked at current
accounts per process and found only 3 processes with more than 150 accounts
assigned, and upon further digging, all of these processes were overloaded /
had high pending averages. Putting a hard cap on the concurrency of a process
should prevent at least some process overload.

Test Plan: TIP

Reviewers: khamidou

Reviewed By: khamidou

Subscribers: jenkins, drew

Differential Revision: https://phab.nylas.com/D3079"
spang,2016-07-06 23:18:05,https://api.github.com/repos/nylas/sync-engine/git/commits/8f8ee2426b08d356b3b60d18de7576b6f7403703,8f8ee2426b08d356b3b60d18de7576b6f7403703,"Fix misleading old comments / variable name

Summary:
We no longer pin sync processes to a CPU, and generally we run 2
processes for every CPU on an instance.

Test Plan: existing unit tests

Reviewers: khamidou

Reviewed By: khamidou

Subscribers: jenkins

Differential Revision: https://phab.nylas.com/D3078"
spang,2016-07-06 04:28:39,https://api.github.com/repos/nylas/sync-engine/git/commits/984234078f695068a13738ed748d6eae6ea3f0b3,984234078f695068a13738ed748d6eae6ea3f0b3,process num is optional
spang,2016-07-06 02:48:03,https://api.github.com/repos/nylas/sync-engine/git/commits/95b270c7ac7889f163af2253fdaf84c0bd9399a8,95b270c7ac7889f163af2253fdaf84c0bd9399a8,"Extend unschedule-account-syncs to work on single processes

Sometimes you just want to unload one."
khamidou,2016-07-01 18:35:11,https://api.github.com/repos/nylas/sync-engine/git/commits/e9741ceee90230b4d12a3ba59518f2eda7d616a1,e9741ceee90230b4d12a3ba59518f2eda7d616a1,Bring overload duration down.
khamidou,2016-07-01 00:38:57,https://api.github.com/repos/nylas/sync-engine/git/commits/d77a48e3ac435448f8ef1edc5bae81d045cc41e6,d77a48e3ac435448f8ef1edc5bae81d045cc41e6,"Remove account unloading

Summary: It's actually not feasible to have machines unload themselves. Dynamic systems are neat and all but they make it very hard to reason about issues.

Test Plan: Inspected the code + ran the unit tests.

Reviewers: drew

Reviewed By: drew

Subscribers: jenkins, spang

Differential Revision: https://phab.nylas.com/D3072"
dregitsky,2016-06-28 23:52:00,https://api.github.com/repos/nylas/sync-engine/git/commits/e1fae31c2e93d0c882a50039b92653f284bca3e9,e1fae31c2e93d0c882a50039b92653f284bca3e9,"Move multi-send 'delete from sent' to session close, run for gmail only

Summary:
Deleting copies of the sent message from the sent folder is only relevant
for gmail. Also, doing it as part of the individual send was causing
timeouts when many /send-multiple requests came in quickly (i.e. message
has many recipients). This moves the deletion to the final DELETE call that
also moves the draft to the sent folder. This requires only one call to the
remote provider (instead of one call per recipeint), and can be safely
retried if it fails.

Test Plan: Ensure current tests pass, test with many recipients on staging.

Reviewers: spang

Reviewed By: spang

Subscribers: jenkins

Differential Revision: https://phab.nylas.com/D3066"
khamidou,2016-06-28 01:27:41,https://api.github.com/repos/nylas/sync-engine/git/commits/0ac8c48fecba8f0c1d32eeab9ccae157d628e329,0ac8c48fecba8f0c1d32eeab9ccae157d628e329,"Don't unload accounts at every turn of the loop

Summary:
Right now, if the CPU usage of an machine is over a set threshold, we unload an account every 10 seconds. This is _very_ aggressive, especially since we run 16 mailsync process per machine.

This diff changes this to unloading an account every minute.

Test Plan: Wrote a regression test. Will test on staging.

Reviewers: spang

Reviewed By: spang

Subscribers: jenkins

Differential Revision: https://phab.nylas.com/D3063"
EthanBlackburn,2016-06-23 21:40:30,https://api.github.com/repos/nylas/sync-engine/git/commits/ff8b0bd749ac71f2c8c52430ccb8d3707485a499,ff8b0bd749ac71f2c8c52430ccb8d3707485a499,"Remove fk from messagecategory

Summary: T6850. This patch removes foreignkeys from MessageCategory table and adds unit tests to ensure that SQLAlchemy's relationship API handles the cascading deletes correctly

Test Plan: added unit tests

Reviewers: spang

Reviewed By: spang

Subscribers: jenkins

Differential Revision: https://phab.nylas.com/D3005"
khamidou,2016-06-22 23:58:23,https://api.github.com/repos/nylas/sync-engine/git/commits/cb4c6d13c94038aa488e9c6ef167722037aedfb1,cb4c6d13c94038aa488e9c6ef167722037aedfb1,"Unload accounts if the CPU load is too high

Summary:
Note: this diff updates 39680d03. It was reverted on prod because it was buggy.

Namely, it assumed that the first call to `cpu_percent` would always return a list of zeroes (https://pythonhosted.org/psutil/#psutil.cpu_percent) when they actually returned the current load. This would cause us to initialize our rolling CPU counts with the current load, which made some machines unload accounts en masse.

Original summary:
We're already not accepting new accounts if the CPU load is too high for a given machine. However, a machine which is overloaded will currently stay overloaded, until someone decides to move accounts away from it.

This diff changes this --- sync processes on machines with a CPU consistently over 90% will unload one account every 10 seconds. Sync processes with CPUs over 85% will also stop accepting new syncs. This allows us to not flip-flop between unloading and accepting new accounts.

Note that this diff changes the way we compute CPU usage --- instead of using the value from the last iteration, we compute a rolling average over roughly 3 minutes.

Test Plan: Ran the unit tests. Will be cautious about rollout.

Reviewers: spang

Reviewed By: spang

Subscribers: jenkins

Differential Revision: https://phab.nylas.com/D3052"
khamidou,2016-06-21 20:31:11,https://api.github.com/repos/nylas/sync-engine/git/commits/d605cecc5157993e56574c33bdc7366b214c9394,d605cecc5157993e56574c33bdc7366b214c9394,"Revert ""Unload accounts if the CPU load is too high""

Will re-apply when I've fixed the metrics issue."
khamidou,2016-06-21 18:28:53,https://api.github.com/repos/nylas/sync-engine/git/commits/e161140dee3c019f1e3d5c666c5334f52f5d3aba,e161140dee3c019f1e3d5c666c5334f52f5d3aba,"Shard mailsync heartbeats

Summary:
We're starting to run into the limits of using a single redis instance for all status data. This diff adds support for using multiple redis shards at the same time.

Instead of having a single `REDIS_HOSTNAME` variable in our config file, there's now a `REDIS_SHARDS` which is a list of redis hosts. Account ids are assigned to a specific host based on a simple formula: `host = REDIS_SHARDS[account_id % len(REDIS_SHARDS)]`.

I tried to make minimal changes to the existing status code, but more extensive changes will follow.

Test Plan: Tested manually + ran unit tests. Will need to test on staging.

Reviewers: spang

Reviewed By: spang

Subscribers: jenkins

Differential Revision: https://phab.nylas.com/D3044"
jackiehluo,2016-06-20 22:58:17,https://api.github.com/repos/nylas/sync-engine/git/commits/a3eab378fae313364d3a8fc825e0f500a5c718d5,a3eab378fae313364d3a8fc825e0f500a5c718d5,Change from Nilas to Nylas
dregitsky,2016-06-20 21:27:41,https://api.github.com/repos/nylas/sync-engine/git/commits/c56418f2adcfbdc8d1df29cd6bf20b32e4cc3462,c56418f2adcfbdc8d1df29cd6bf20b32e4cc3462,"Fix two issues with multi-send endpoint

Summary:
Prevent needless database writes by not touching the model object when
serializing an individual sent message. Also improve error handling for
deleting the message out of the sent folder after a single send.

Test Plan: run tests, test functionality on staging

Reviewers: khamidou, spang

Reviewed By: spang

Subscribers: jenkins

Differential Revision: https://phab.nylas.com/D3040"
spang,2016-06-19 20:08:01,https://api.github.com/repos/nylas/sync-engine/git/commits/3d186d762becf5ad76aabe67508bca47153d401c,3d186d762becf5ad76aabe67508bca47153d401c,"add syncback-stats script

I've found this script VERY useful when investigating syncback processing problems."
khamidou,2016-06-17 22:53:10,https://api.github.com/repos/nylas/sync-engine/git/commits/2c3f403e6d7a7a6fc67fa26a5cba10ae5c820fd6,2c3f403e6d7a7a6fc67fa26a5cba10ae5c820fd6,"Make our syncback algorithm a fair bit fairer

Summary:
Our current syncback algorithm is very simple --- we simply execute the ActionLog entries in order. This breaks down when somebody decides to queue 100k actions.

This diff changes the algorithm to be a bit fairer: at each iteration we execute an action for a `NUM_PARALLEL_ACCOUNTS` different accounts. This means that every account gets a chance to execute their actions.

Test Plan: Tested manually, will be more serious on staging.

Reviewers: spang

Reviewed By: spang

Subscribers: drew, jenkins

Differential Revision: https://phab.nylas.com/D3038"
dregitsky,2016-06-17 02:16:09,https://api.github.com/repos/nylas/sync-engine/git/commits/7c4e357e962033839e3dcbc1a4ab606c542a29cf,7c4e357e962033839e3dcbc1a4ab606c542a29cf,Add more logging in syncback service
dregitsky,2016-06-16 22:18:32,https://api.github.com/repos/nylas/sync-engine/git/commits/257c1f7ce29c73f0c4298b8d760886199203490f,257c1f7ce29c73f0c4298b8d760886199203490f,"Fail pending syncback actions for invalid accounts after a 2h grace period

Summary:
Fail the actions to prevent accumulation of pending actions for accounts
that have been marked invalid, otherwise the queue may back up with actions
that are always skipped.

Test Plan: run tests

Reviewers: khamidou

Reviewed By: khamidou

Subscribers: jenkins

Differential Revision: https://phab.nylas.com/D3035"
khamidou,2016-06-16 19:36:03,https://api.github.com/repos/nylas/sync-engine/git/commits/ff756650be210aa4ce7ef080889a13b4f1198263,ff756650be210aa4ce7ef080889a13b4f1198263,Fix namecheap SMTP port.
EthanBlackburn,2016-06-15 17:57:58,https://api.github.com/repos/nylas/sync-engine/git/commits/774e397e17f3497079e823088900affc857567b6,774e397e17f3497079e823088900affc857567b6,Adapt inbox-api script to work with new scheduler setup
kav-ya,2016-06-09 02:24:07,https://api.github.com/repos/nylas/sync-engine/git/commits/acce12f381778e3e31c30d8b627cfadb6313ea9e,acce12f381778e3e31c30d8b627cfadb6313ea9e,Include missing import.
kav-ya,2016-06-13 18:02:35,https://api.github.com/repos/nylas/sync-engine/git/commits/583401f001a27d11488135cd960341797c39344e,583401f001a27d11488135cd960341797c39344e,"Revert sync-syncback unification commits.

Reason for revert:
Requires optimization before shipping to prod --
affects sync velocity as is.

Commits:

Revert ""Adapt S3FolderSyncEngine.""
This reverts commit 385b03f73cb953df0c5ac2724add6110e06d96e1.

Revert ""Adapt SyncbackService to sync_host = hostname:pid format.""
This reverts commit 080587d0316273801afc80fd829aece97a1ed60e.

Revert ""Unify IMAP sync and syncback: Part II""
This reverts commit 37ce72248762c052f26d34c0f73e0d3f877d0301.

Revert ""Unify IMAP sync and syncback: Part I""
This reverts commit 398d17a72642855b057602e5a540e104cfa39c32.

Conflicts:
	inbox/syncback/base.py"
khamidou,2016-06-10 21:39:19,https://api.github.com/repos/nylas/sync-engine/git/commits/60d70ae10ab909268b666c14a4886ed88a23002c,60d70ae10ab909268b666c14a4886ed88a23002c,"Don't publish stray heartbeats

Summary: Looks like the S3 sync was still publishing heartbeats, which is annoying. This diff changes the `FolderSyncMonitor` to call a function named `publish_heartbeat_status` instead of making direct calls to the `HeartbeatStatusMonitor`. This way, we can override this method cleanly in `S3FolderSyncMonitor` and not worry about publishing stray heartbeats.

Test Plan: Looked at the code, synced an account.

Reviewers: kav-ya

Reviewed By: kav-ya

Subscribers: jenkins

Differential Revision: https://phab.nylas.com/D3010"
kav-ya,2016-06-09 01:53:40,https://api.github.com/repos/nylas/sync-engine/git/commits/00d8a30410d4dac180b75f0443e8327f2668e5e9,00d8a30410d4dac180b75f0443e8327f2668e5e9,Don't require syncback_id to be an int.
EthanBlackburn,2016-06-09 00:38:05,https://api.github.com/repos/nylas/sync-engine/git/commits/b8d11925078cc44be32d7e97a80ecdfad3e71131,b8d11925078cc44be32d7e97a80ecdfad3e71131,"Assign syncbacks to processes in config

Summary: In order to have multiple syncback workers, we need to assign shards to an instance. This diff introduces changes to the syncback service so that it will read which shards are assigned to it and only perform actions for those shards

Test Plan: our current unit tests already cover this change

Reviewers: kav-ya

Reviewed By: kav-ya

Subscribers: jenkins

Differential Revision: https://phab.nylas.com/D3014"
kav-ya,2016-06-08 18:28:17,https://api.github.com/repos/nylas/sync-engine/git/commits/9f39ede276d807acc9660577e110a741263e202f,9f39ede276d807acc9660577e110a741263e202f,Limit #(spawned SyncbackWorkers).
kav-ya,2016-06-07 23:36:46,https://api.github.com/repos/nylas/sync-engine/git/commits/94da9252c653ef3bdd3fd245d72fa398964676f6,94da9252c653ef3bdd3fd245d72fa398964676f6,Set a lower syncback limit.
khamidou,2016-06-07 22:55:54,https://api.github.com/repos/nylas/sync-engine/git/commits/8e63e26d975390b4361cea277386d24cc05cd7ea,8e63e26d975390b4361cea277386d24cc05cd7ea,Prevent the linter from complaining uselessly.
khamidou,2016-06-07 20:47:13,https://api.github.com/repos/nylas/sync-engine/git/commits/6739a7d5db1c929fb3493fcfe3657e27138251db,6739a7d5db1c929fb3493fcfe3657e27138251db,Typo.
EthanBlackburn,2016-06-07 19:10:41,https://api.github.com/repos/nylas/sync-engine/git/commits/f1553c70465c7972ca5e99f47cc97127df153b8a,f1553c70465c7972ca5e99f47cc97127df153b8a,"Do not check the autoincrement on the contactsearchindexcursor table

Summary: Provisioning instances frequently fails because contactsearchindexcursor's autoincrement is reset. I don't know why this keeps happening, but its not a table we should be check anyways because the primary key isn't used

Test Plan: tested locally

Reviewers: spang

Reviewed By: spang

Subscribers: jenkins

Differential Revision: https://phab.nylas.com/D3009"
khamidou,2016-06-07 18:28:37,https://api.github.com/repos/nylas/sync-engine/git/commits/ac5e43d17db5982a97ff8fe541559bed965e8912,ac5e43d17db5982a97ff8fe541559bed965e8912,"Handle IMAP folders correctly (2/2)

Summary: Second part of the API --- contains the required API and syncback changes.

Test Plan: Tested on staging previously --- will retest before shipping.

Reviewers: kav-ya

Reviewed By: kav-ya

Subscribers: jenkins

Differential Revision: https://phab.nylas.com/D2741"
khamidou,2016-06-07 17:31:35,https://api.github.com/repos/nylas/sync-engine/git/commits/39680d032d29799b2a3c5bb2874334b8ce32a0f1,39680d032d29799b2a3c5bb2874334b8ce32a0f1,"Unload accounts if the CPU load is too high

Summary:
We're already not accepting new accounts if the CPU load is too high for a given machine. However, a machine which is overloaded will currently stay overloaded, until someone decides to move accounts away from it.

This diff changes this --- sync processes on machines with a CPU consistently over 90% will unload one account every 10 seconds. Sync processes with CPUs over 85% will also stop accepting new syncs. This allows us to not flip-flop between unloading and accepting new accounts.

Note that this diff changes the way we compute CPU usage --- instead of using the value from the last iteration, we compute a rolling average over roughly 3 minutes.

Test Plan: Tested locally. Need to test on staging by hammering the cores.

Reviewers: kav-ya, spang

Reviewed By: spang

Subscribers: jenkins

Differential Revision: https://phab.nylas.com/D2991"
kav-ya,2016-06-07 00:31:19,https://api.github.com/repos/nylas/sync-engine/git/commits/385b03f73cb953df0c5ac2724add6110e06d96e1,385b03f73cb953df0c5ac2724add6110e06d96e1,Adapt S3FolderSyncEngine.
kav-ya,2016-06-06 22:45:20,https://api.github.com/repos/nylas/sync-engine/git/commits/080587d0316273801afc80fd829aece97a1ed60e,080587d0316273801afc80fd829aece97a1ed60e,Adapt SyncbackService to sync_host = hostname:pid format.
kav-ya,2016-06-06 22:18:15,https://api.github.com/repos/nylas/sync-engine/git/commits/1671f2d49a617941aab7505b01e232312a78a171,1671f2d49a617941aab7505b01e232312a78a171,Fix syntax for pytest v < 2.9.
kav-ya,2016-06-06 22:06:13,https://api.github.com/repos/nylas/sync-engine/git/commits/8d937400177ad456df498fb24a9353c928b052ed,8d937400177ad456df498fb24a9353c928b052ed,Temporarily skip test.
kav-ya,2016-06-06 21:35:59,https://api.github.com/repos/nylas/sync-engine/git/commits/611d63d86d5d986a2b5edd3db7ca80efe5f25627,611d63d86d5d986a2b5edd3db7ca80efe5f25627,Kill pending greenlets in test.
kav-ya,2016-05-26 00:38:03,https://api.github.com/repos/nylas/sync-engine/git/commits/37ce72248762c052f26d34c0f73e0d3f877d0301,37ce72248762c052f26d34c0f73e0d3f877d0301,"Unify IMAP sync and syncback: Part II

Summary:
Depends on D2984.

Changes to support the selective roll-out detailed in:
https://paper.dropbox.com/doc/IMAP-sync-and-syncback-integration-ixvTE7ScAVtXlb6AqTIYN#:h2=Deploy-proposal

Specifically we will have to:
1. Update and deploy the mailsync config to the syncback instance to pause its
syncback for accounts on the chosen subset of sync_hosts.
2. Deploy the sync code changes to that subset of sync_hosts to start syncback via
the mailsync processes.

Test Plan: Test against staging.

Reviewers: khamidou

Reviewed By: khamidou

Differential Revision: https://phab.nylas.com/D2986"
kav-ya,2016-05-25 01:07:09,https://api.github.com/repos/nylas/sync-engine/git/commits/398d17a72642855b057602e5a540e104cfa39c32,398d17a72642855b057602e5a540e104cfa39c32,"Unify IMAP sync and syncback: Part I

Summary:
Running sync and syncback as independant services that interact with the remote provider
in an uncoordinated manner causes a number of undesirable and difficult to debug issues like
incorrect message/thread state updates and phantom drafts.
In addition, sharing the SyncbackService across accounts has the downside of an account that has
tens of thousands of pending actions impacting the syncback latency for other accounts.

This revision integrates syncback for IMAP accounts into the sync service such that
sync and syncback for an account is interleaved so that after a syncback action has been performed successfully,
the next sync will pick it up or the latest update to the object as determined by the remote server
(last-write-wins as applied by the remote server).

This is achieved by means of a signal-wait protocol, described in detail here:
https://paper.dropbox.com/doc/IMAP-sync-and-syncback-integration-ixvTE7ScAVtXlb6AqTIYN

The core idea is the per-account ImapSyncMonitor periodically runs syncback for the account as well;
to interleave sync and syncback such that no sync is running while syncback is and vice-versa,
the ImapSyncMonitor and spawned *FolderSyncEngines use a signaling mechanism.

Test Plan: Tested manually, to be hammered further on staging.

Reviewers: spang, khamidou

Reviewed By: khamidou

Subscribers: jenkins

Differential Revision: https://phab.nylas.com/D2984"
khamidou,2016-06-06 20:39:27,https://api.github.com/repos/nylas/sync-engine/git/commits/a301e2b7fda14c7f3de1f2d3c5851388a412d24e,a301e2b7fda14c7f3de1f2d3c5851388a412d24e,"Fix BCC substitution for raw messages

Summary: When people send raw message we substitute the BCC header to make sure To'ed and CC'ed people don't see that the message has been BCC'ed. Unfortunately, our regexp isn't case-sensitive, so this potentially wouldn't work if a customer used `BCC:` instead of `Bcc:`.

Test Plan: Wrote a regression test.

Reviewers: spang

Reviewed By: spang

Subscribers: jenkins

Differential Revision: https://phab.nylas.com/D3006"
khamidou,2016-06-06 19:14:40,https://api.github.com/repos/nylas/sync-engine/git/commits/66a00f10844a45c9167d50ca3e67f478d8fe3664,66a00f10844a45c9167d50ca3e67f478d8fe3664,Apparently some ImapUids don't always have a linked message.
grinich,2016-06-06 01:08:55,https://api.github.com/repos/nylas/sync-engine/git/commits/efabf6d0ea7fddf02167a2909ec3f1bb5de799f9,efabf6d0ea7fddf02167a2909ec3f1bb5de799f9,"Add required Date header to outgoing messages.

Summary: Fixes https://github.com/nylas/N1/issues/1246

Test Plan: passes tests

Reviewers: spang

Subscribers:"
kav-ya,2016-05-27 00:15:15,https://api.github.com/repos/nylas/sync-engine/git/commits/e5edbdf4d30549161c16067656a93f84a04745c3,e5edbdf4d30549161c16067656a93f84a04745c3,"Skip syncback for invalid accounts.

Summary:
Fixes T6894.

Skip action syncback for invalid accounts. If/ when the account becomes valid again,
these actions will still be 'pending' and will be performed then.

Test Plan: Existing tests pass.

Reviewers: khamidou

Reviewed By: khamidou

Subscribers: jenkins

Maniphest Tasks: T6894

Differential Revision: https://phab.nylas.com/D2993"
kav-ya,2016-05-26 17:07:58,https://api.github.com/repos/nylas/sync-engine/git/commits/2d8804d62c46204b1440b4e27452c0c79e94255e,2d8804d62c46204b1440b4e27452c0c79e94255e,Include unschedule script in setup.py
spang,2016-05-26 16:42:11,https://api.github.com/repos/nylas/sync-engine/git/commits/3d873f50aaf10717658ed1154b3b8f5b6c97ba3d,3d873f50aaf10717658ed1154b3b8f5b6c97ba3d,Handle timeout error properly
EthanBlackburn,2016-05-25 20:28:55,https://api.github.com/repos/nylas/sync-engine/git/commits/e52e3419f9153ef6347d042bcd5ab84c9df5a172,e52e3419f9153ef6347d042bcd5ab84c9df5a172,"Revert ""Change object type"". This migration cannot be run online :(

This reverts commit d1082e3ad6636ae0e3353ff6ab9f80571f183c09."
EthanBlackburn,2016-05-25 17:13:51,https://api.github.com/repos/nylas/sync-engine/git/commits/d1082e3ad6636ae0e3353ff6ab9f80571f183c09,d1082e3ad6636ae0e3353ff6ab9f80571f183c09,"Change object type

Summary:
Change transaction.object_type to ENUM

Add migration file

Test Plan: tested locally

Reviewers: kav-ya

Reviewed By: kav-ya

Subscribers: jenkins, rene

Differential Revision: https://phab.nylas.com/D2983"
khamidou,2016-05-24 21:43:38,https://api.github.com/repos/nylas/sync-engine/git/commits/1fe40761a7e3a3270c9fa3eb2a688feb9d709f72,1fe40761a7e3a3270c9fa3eb2a688feb9d709f72,"Don't take on new processes when CPUs are pegged

Summary:
**Summary:** This diff changes the account stealing code to check that CPU usage isn't excessive before claiming new accounts.

A few months ago we moved from pegging sync processes to a CPU to having the kernel move them between CPUs transparently. It gave us better CPU utilization.

However, we're not really checking if we can take on more accounts before claiming them. This makes it hard to unload machines. Worse, unloading an overloaded machine recklessly can cause us to move the problem to another machine.

This diff changes this by adding an additional check before claiming accounts --- if every CPU is over 90% of use, we're temporarily not claiming accounts. 90% is a conservative choice --- we should probably revisit this a few weeks down the line.

Test Plan: Read the code. Made sure that individual lines where valid.

Reviewers: spang

Reviewed By: spang

Differential Revision: https://phab.nylas.com/D2982"
EthanBlackburn,2016-05-24 19:20:53,https://api.github.com/repos/nylas/sync-engine/git/commits/257c76144706323715c412b9524e9ade3482241b,257c76144706323715c412b9524e9ade3482241b,"Add idx_namespace_id migration

Summary: T6882, this migration was already run on prod by rene/jesmar this weekend. We need this migration for future shards

Test Plan: Already run on prod

Reviewers: kav-ya

Subscribers: jenkins

Differential Revision: https://phab.nylas.com/D2981"
dregitsky,2016-05-24 01:05:16,https://api.github.com/repos/nylas/sync-engine/git/commits/829b42858e54d685c79f17890adb10386667522e,829b42858e54d685c79f17890adb10386667522e,"Add more logging to multi-send endpoints

Summary: Adds a few more log lines to help debug issues with these endpoints.

Test Plan: Relevant tests pass

Reviewers: kav-ya

Reviewed By: kav-ya

Subscribers: jenkins

Differential Revision: https://phab.nylas.com/D2980"
kav-ya,2016-05-23 21:14:42,https://api.github.com/repos/nylas/sync-engine/git/commits/22e0a15d8c71cd44b44faf0cdc8572a2a063b511,22e0a15d8c71cd44b44faf0cdc8572a2a063b511,Only issue IMAP NAMESPACE for accounts that support it.
khamidou,2016-05-20 00:42:16,https://api.github.com/repos/nylas/sync-engine/git/commits/657e946214fae4dd8cc6b901f0ac1c9f783a9589,657e946214fae4dd8cc6b901f0ac1c9f783a9589,Handle EAS devices.
khamidou,2016-05-20 00:05:15,https://api.github.com/repos/nylas/sync-engine/git/commits/a1ddfdb8764f3218944cb5cad7a6bf62c5da6f0e,a1ddfdb8764f3218944cb5cad7a6bf62c5da6f0e,Add an undo flag.
khamidou,2016-05-18 01:13:26,https://api.github.com/repos/nylas/sync-engine/git/commits/232775a24e634b85eeeff996e7b2d28771ab48ad,232775a24e634b85eeeff996e7b2d28771ab48ad,Forgot to update setup.py
khamidou,2016-05-17 19:27:53,https://api.github.com/repos/nylas/sync-engine/git/commits/ab39e7542bf1cd0898ea0a19cb6e5e6fbd9afd92,ab39e7542bf1cd0898ea0a19cb6e5e6fbd9afd92,"Fix a Gmail search API bug

Summary:
This fixes a bug reported by one of our customers.

Sending a search request with `offset=30` and `limit=30` would return zero elements. This is because we were asking the Gmail API for at most `limit` and offsetting the results //after// receiving them. Instead, we need to ask the Gmail API for `limit + offset` and offset them.

Test Plan: Tested manually. Checked that a query with `?limit=30&offset=30` returned more than zero elements.

Reviewers: spang

Reviewed By: spang

Subscribers: jenkins

Differential Revision: https://phab.nylas.com/D2960"
kav-ya,2016-05-17 18:16:26,https://api.github.com/repos/nylas/sync-engine/git/commits/f9d9b45e10e51b7401959bb53ed43c9f589b2c3c,f9d9b45e10e51b7401959bb53ed43c9f589b2c3c,Replace test account.
kav-ya,2016-05-16 22:58:15,https://api.github.com/repos/nylas/sync-engine/git/commits/a43caf3556f097d7f2664f4083134e014dd4bef6,a43caf3556f097d7f2664f4083134e014dd4bef6,Changes to support D2958.
kav-ya,2016-05-16 19:28:20,https://api.github.com/repos/nylas/sync-engine/git/commits/a28115a4378f6cdf3f6f0fd35ab292448b32d104,a28115a4378f6cdf3f6f0fd35ab292448b32d104,Remove unused import.
kav-ya,2016-05-12 21:28:46,https://api.github.com/repos/nylas/sync-engine/git/commits/4747d956ed1e69e01a4471a8c2c170e659942500,4747d956ed1e69e01a4471a8c2c170e659942500,"Changes to support unification of mailsync, redwood account data deletion.

Summary: Concomitant sync changes to D2953.

Test Plan: Test against staging.

Reviewers: ethanb

Reviewed By: ethanb

Subscribers: jenkins

Differential Revision: https://phab.nylas.com/D2954"
khamidou,2016-05-16 19:15:00,https://api.github.com/repos/nylas/sync-engine/git/commits/979378273d132f3f5a1db378aa83582bde4657fe,979378273d132f3f5a1db378aa83582bde4657fe,"Faster S3 sync

Summary:
This diff adds a new type of FolderSyncEngine name S3FolderSyncEngine. This engine is created by the ImapSyncMonitor.

The S3FolderSyncEngine is a dumbed down version of the foldersyncengine we use for syncing generic IMAP accounts --- it simply syncs every uid and uploads them to S3. To make sure that we're not downloading the same messages over and over, we save our progress in Account._sync_status. It's a JSON column which is only used by the status code; I felt it wasn't worth to write a migration just for this.

I still need to write a similar program for Exchange. It should be much easier because we could just use the primary device to get all the messages from the Exchange server.

Test Plan: Tested manually, will re-check my results and test on staging.

Reviewers: kav-ya, spang

Reviewed By: spang

Subscribers: jenkins

Maniphest Tasks: T6857

Differential Revision: https://phab.nylas.com/D2945"
khamidou,2016-05-16 17:11:51,https://api.github.com/repos/nylas/sync-engine/git/commits/52394c2d5468a5fc0ab59925e7934525e7110459,52394c2d5468a5fc0ab59925e7934525e7110459,"Revert ""Disable subquery joinedloads to workaround an SQLAlchemy bug""

Reason: No clear path to shipping this fix. Need to talk about it
        with Kavya."
khamidou,2016-05-13 00:39:57,https://api.github.com/repos/nylas/sync-engine/git/commits/08f9b6b0d30df7676566504958edad0de9c1e045,08f9b6b0d30df7676566504958edad0de9c1e045,"Override __repr__ to make debugging easier

Summary:
Right now sentry traces aren't super helpful because every SQLAlchemy object looks like this:
`<inbox.models.event.RecurringEvent object at 0xae6ab10>`.

This diff changes `__repr__` for SQLAlchemy objects to display the object's id.

Test Plan: Tested manually.

Reviewers: spang

Reviewed By: spang

Subscribers: jenkins

Differential Revision: https://phab.nylas.com/D2955"
EthanBlackburn,2016-05-12 00:44:59,https://api.github.com/repos/nylas/sync-engine/git/commits/10418d099ff16acf389e2d5db34f5bdd69242fba,10418d099ff16acf389e2d5db34f5bdd69242fba,"Add column default before dropping them

Summary: We need to add defaults to columns before deleting them because sqlalchemy uses 'traditional' sql mode and throws an error if a column is missing

Test Plan: tested locally

Reviewers: rene

Reviewed By: rene

Differential Revision: https://phab.nylas.com/D2950"
khamidou,2016-05-11 19:22:42,https://api.github.com/repos/nylas/sync-engine/git/commits/9b8f4cb1ae5fac5d45db44084d8e229644b75da5,9b8f4cb1ae5fac5d45db44084d8e229644b75da5,"Add a script to get a MySQL prompt scoped to a shard

Summary:
Debugging MySQL errors is super annoying because we have to:
1. dig up the shard associated with the account
2. dig up the MySQL host for the shard
3. dig up the credentials
4. connect to the host

This script makes this much quicker. `mysql-prompt  --shard-num 2` gets you a prompt for shard 2.
It works by getting the credentials from `/etc/inboxapp/config.json` and creating a MySQL prompt.

Note that we're using pipes here, so the credentials aren't leaked in the output of `ps`.

Test Plan: Tested locally and on staging.

Reviewers: ethanb

Reviewed By: ethanb

Subscribers: jenkins, kav-ya

Differential Revision: https://phab.nylas.com/D2939"
khamidou,2016-05-10 19:01:24,https://api.github.com/repos/nylas/sync-engine/git/commits/bd601411f6481d6c13fb11e72706dff01f3e1820,bd601411f6481d6c13fb11e72706dff01f3e1820,Encode unicode strings to UTF-8.
khamidou,2016-05-06 21:56:08,https://api.github.com/repos/nylas/sync-engine/git/commits/a354869bb572eb3859269d04cdd9b0e5897b22d8,a354869bb572eb3859269d04cdd9b0e5897b22d8,"Fix threading for bounced emails.

Some SMTP servers alter the subject of the message to ""Undeliverable:
old subject"". Change the threading algorithm to accomodate this."
kav-ya,2016-05-06 17:42:42,https://api.github.com/repos/nylas/sync-engine/git/commits/e94949becd7f285940788f85c55ca884f94f83c1,e94949becd7f285940788f85c55ca884f94f83c1,"Verification prompt when bin/unschedule-account-syncs is called without
the --number option."
spang,2016-04-15 01:28:53,https://api.github.com/repos/nylas/sync-engine/git/commits/7aebc106278b08fdae2400cb85178b1c713b1ca6,7aebc106278b08fdae2400cb85178b1c713b1ca6,Fix unscheduling script and add support for unscheduling a specific # of accounts
spang,2016-03-22 17:50:33,https://api.github.com/repos/nylas/sync-engine/git/commits/09763d5d03b649c5cfee3bfbe6dfbea3faf1a404,09763d5d03b649c5cfee3bfbe6dfbea3faf1a404,"Add utility script for unscheduling all syncs on a given host

Summary:
This is primarily useful for unscheduling all the accounts on a single sync
host after terminating it. This codifies something I did manually the other
week, and would like for people to not have to figure out how to do every time
we need it.

Test Plan: Tested manually with --dry-run and looked at output

Reviewers: ethanb

Reviewed By: ethanb

Differential Revision: https://phab.nylas.com/D2770

Conflicts:
	bin/unschedule-account-syncs"
khamidou,2016-05-06 00:48:40,https://api.github.com/repos/nylas/sync-engine/git/commits/3ed6cf504f34f9978789927636cfd66714f08620,3ed6cf504f34f9978789927636cfd66714f08620,"Disable subquery joinedloads to workaround an SQLAlchemy bug

It looks like SQLAlchemy is getting confused by our subquery joinedloads
(https://sentry.nylas.com/sentry/API-Prod/group/22488/) --- we're
getting the wrong objects loaded both for `Message.events` and
`Message.parts`.

There's no smoking gun here, but I have a hunch that SQLAlchemy may
have gotten confused by our optimizations."
grinich,2016-05-05 02:40:15,https://api.github.com/repos/nylas/sync-engine/git/commits/93934cbfcdecd447818c491b4a481a4cb5173c46,93934cbfcdecd447818c491b4a481a4cb5173c46,throw an error if the raw message doesn't exist
grinich,2016-05-05 01:55:23,https://api.github.com/repos/nylas/sync-engine/git/commits/b0dc11e6f6de32cbaf8677f024c9019e7a57200d,b0dc11e6f6de32cbaf8677f024c9019e7a57200d,"If attachments are missing, go fetch them from message bodies.

Test Plan:
Tested this locally by deleting the parsed attachment from disk. it works.

temporarily fixes T6856

Reviewers: kav-ya

Subscribers: spang, jimmy, khamidou

Maniphest Tasks: T6856

Differential Revision: https://phab.nylas.com/D2940"
kav-ya,2016-05-04 23:21:00,https://api.github.com/repos/nylas/sync-engine/git/commits/03f5d570b325e7a8064b2a213c68af258b19d564,03f5d570b325e7a8064b2a213c68af258b19d564,Perform case-insensitive domain name comparision.
khamidou,2016-05-04 22:09:17,https://api.github.com/repos/nylas/sync-engine/git/commits/c0a1927181d50e66dd328852439928e2afb0d8bd,c0a1927181d50e66dd328852439928e2afb0d8bd,Handle NULL connections errors.
kav-ya,2016-05-04 02:05:43,https://api.github.com/repos/nylas/sync-engine/git/commits/432ee0d9547dc6be6493f80a204ece516fa620f9,432ee0d9547dc6be6493f80a204ece516fa620f9,Remove unused import.
kav-ya,2016-05-04 01:58:04,https://api.github.com/repos/nylas/sync-engine/git/commits/7155444de946c7d00b7ef984a3458765be1afa03,7155444de946c7d00b7ef984a3458765be1afa03,"Leverage the (namespace_id, created_at) transaction table index to
get the max transaction id for a namespace."
khamidou,2016-05-03 22:57:08,https://api.github.com/repos/nylas/sync-engine/git/commits/65064866ccf12ef23841ee529ba9b215170f6125,65064866ccf12ef23841ee529ba9b215170f6125,Typo.
khamidou,2016-05-03 21:36:33,https://api.github.com/repos/nylas/sync-engine/git/commits/4591060fa81466b4198e5f3cd16df7067e237694,4591060fa81466b4198e5f3cd16df7067e237694,"Prevent IMAP accounts from getting stuck in an infinite UIDINVALIDITY loop

Summary:
We have a generic IMAP account which is stuck in a uidinvalidity loop. We've resynced it hundreds of times, creating thousands of transactions.

This diff fixes this by limiting the number of **consecutive** resyncs we can do in a row. After 5, we mark the account as invalid.

Test Plan: This is hard to test in the real world so I wrote a regression test. I had to refactor the code a bit to make it work.

Reviewers: kav-ya

Reviewed By: kav-ya

Subscribers: spang

Maniphest Tasks: T6838

Differential Revision: https://phab.nylas.com/D2933"
khamidou,2016-05-03 21:10:13,https://api.github.com/repos/nylas/sync-engine/git/commits/d21576525c966de23192a2783762e3cdec0e94ac,d21576525c966de23192a2783762e3cdec0e94ac,Log the full stack trace when we raise an encoding error.
khamidou,2016-05-02 22:35:21,https://api.github.com/repos/nylas/sync-engine/git/commits/3f508748e214794c3d6c480cc25d80810723c538,3f508748e214794c3d6c480cc25d80810723c538,Use our fork of flanker. We need it to support Chinese characters.
khamidou,2016-05-02 19:25:23,https://api.github.com/repos/nylas/sync-engine/git/commits/a49270e197036d31d30c824cf3cd2587c7bb3ff3,a49270e197036d31d30c824cf3cd2587c7bb3ff3,Switch back to mainline flanker.
khamidou,2016-04-26 23:56:26,https://api.github.com/repos/nylas/sync-engine/git/commits/56e545e6be033eae701d2ab120de6dde4ab65831,56e545e6be033eae701d2ab120de6dde4ab65831,Bump up the number of connections per mailsync process.
khamidou,2016-04-26 23:00:03,https://api.github.com/repos/nylas/sync-engine/git/commits/fa13f0eabae1eb08ed89458d8e5863c7e709f31d,fa13f0eabae1eb08ed89458d8e5863c7e709f31d,"Don't hog redis connections

Summary:
The heartbeats code is very weird --- it uses, of all things, a singleton pattern, which means we're keeping db connections opened forever.

This diff changes this --- we're now releasing connections back to the pool as soon as we're done. This should significantly lower the number of connections on our redis cluster.

Test Plan: Stared at the code, ran the tests. Note that I skipped the tests because a heartbeat test fails when ran in the suite, but works correctly otherwise. I'm still investigating why.

Reviewers: kav-ya, spang

Reviewed By: spang

Differential Revision: https://phab.nylas.com/D2923"
kav-ya,2016-04-26 19:35:25,https://api.github.com/repos/nylas/sync-engine/git/commits/5c2c3820289c81f6f85a8ae685df11578d96f659,5c2c3820289c81f6f85a8ae685df11578d96f659,"Handle HTTP 400: pushNotSupportedForRequestedResource in Google calendar sync.
Add additional logging."
khamidou,2016-04-26 18:59:16,https://api.github.com/repos/nylas/sync-engine/git/commits/5da135bbf1f69040b1c412dcfadf8490c77d54a0,5da135bbf1f69040b1c412dcfadf8490c77d54a0,Handle more SMTP errors + Fix SMTP unit tests.
spang,2016-04-26 18:31:00,https://api.github.com/repos/nylas/sync-engine/git/commits/2044d9d086ea16a8f451a023ceebec5f48b2c544,2044d9d086ea16a8f451a023ceebec5f48b2c544,Log namespace ID in index backfill
dregitsky,2016-04-26 18:08:08,https://api.github.com/repos/nylas/sync-engine/git/commits/9e1b3fd502ab1982b7869db56169207e7fd4103d,9e1b3fd502ab1982b7869db56169207e7fd4103d,"Add new individualized multi-send endpoints

Summary:
Adds a new set of endpoints to allow sending messages where each recipient
is sent a different body, but only one message appears in the Sent folder.

This process has 3 steps, represented in the API by 3 new endpoints:

- A multi-send draft is created with the body intended for the user's sent
  folder. The draft is never synced back to the provider, and any existing
  copy on the remote is deleted.
  Endpoint: `POST /send-multiple`
  Initiates a multi-send session. Accepts a draft object or draft ID
  (like the `/send` endpoint). Creates or updates the draft to have
  `is_sending=True` and returns it.

- The client makes successive calls per recipient to a special send
  endpoint, triggering seperate sends with individualized bodies. If this
  creates any messages in the user's Sent folder, we delete them.
  Endpoint: `POST /send-multiple/<draft_id>`

- A final call closes out the session by marking the draft object as sent,
  and saving it to the user's Sent folder on the remote.
  Endpoint: `DELETE /send-multiple/<draft_id>`

Introduces a new property in Message, `is_sending`, to mark a draft that is
currently being sent by this process. The property sets the `version` to the
maximum allowed MySQL value for INT(11) and sets draft=False. It cannot
be unset.

Test Plan: Added tests for new endpoints. Also tested locally on a Yahoo and Gmail account. Both worked - only the message with the desired body was visible in the sent folder, and each recipient received a version with their personalized body.

Reviewers: kav-ya

Reviewed By: kav-ya

Subscribers: spang, mg, khamidou

Differential Revision: https://phab.nylas.com/D2891"
spang,2016-04-26 00:34:29,https://api.github.com/repos/nylas/sync-engine/git/commits/a6a41050d44da8f55940172c6a90cd0c1f83c37a,a6a41050d44da8f55940172c6a90cd0c1f83c37a,Fix log line
spang,2016-04-25 03:31:54,https://api.github.com/repos/nylas/sync-engine/git/commits/928115359c9e5cc1ab8a6d38a0e1cdf72fee1f6c,928115359c9e5cc1ab8a6d38a0e1cdf72fee1f6c,"Factor contact search indexing into methods

Summary:
Allows overriding and calling index operation with a set of namespace IDs to
filter index operations on --- so you don't have to always index _all_
accounts.

Test Plan: manual testing

Reviewers: ethanb

Differential Revision: https://phab.nylas.com/D2919"
kav-ya,2016-04-20 21:38:18,https://api.github.com/repos/nylas/sync-engine/git/commits/d9f2f7ae91557376e8d358650a8249e68893ae70,d9f2f7ae91557376e8d358650a8249e68893ae70,"Selectively overwrite sync_{host, state} while stopping syncs.

Summary:
Invoking queue_client.unassign() /before/ stopping an account's sync can have the
undesired effect of having the sync be reclaimed and started on a new host before the
original host removes it from its set of accounts to sync. When this happens, the account
may be syncing on more than one host for a period, and may be subsequently incorrectly set to
'stopped' when the original host eventually removes it.

The right solution to this is to update the unscheduling script to hit the `/unassign` endpoint exposed by
each mailsync process -- which will first stop the account's sync and then call queue_client.unassign() for it.

In the meantime, update account.sync_stopped() to perform a compare-and-swap before updating values --
only iff the requesting host still owns the account sync, account.sync_{host, state} are updated.
This is useful to do independant of updating the unscheduling script,  in case we ever need to unassign
using the `queue_client` directly.

Test Plan:
Regression test added that verifies:
* An incorrect host cannot update these values.
* The correct host can.

Reviewers: spang

Reviewed By: spang

Differential Revision: https://phab.nylas.com/D2910"
kav-ya,2016-04-23 00:11:44,https://api.github.com/repos/nylas/sync-engine/git/commits/ff60a6f42f6f8e5650bd5f3aa9c3605b02fe754f,ff60a6f42f6f8e5650bd5f3aa9c3605b02fe754f,"Batch delete events before a calendar delete.

Rather than relying on the configured delete cascade from a Calendar to its
Events, delete a calendar's events in batches before deleting it.

We do this because otherwise, deleting a calendar with many events can result
in the session post-flush processing (Transaction record creation) blocking
the event loop."
khamidou,2016-04-22 22:14:54,https://api.github.com/repos/nylas/sync-engine/git/commits/5a41e32ab37d12d81f7fe853fcc1552f5be12dc1,5a41e32ab37d12d81f7fe853fcc1552f5be12dc1,"Run the HTTP interface in a separate OS thread.

We don't want a rogue greenlet to prevent us from collecting metrics."
spang,2016-04-22 13:22:13,https://api.github.com/repos/nylas/sync-engine/git/commits/acb01a3fcc19749a4603344a79432005c4bf5ddd,acb01a3fcc19749a4603344a79432005c4bf5ddd,"Make load_overrides() configurable

Allows loading overrides from other configs."
spang,2016-04-22 12:02:39,https://api.github.com/repos/nylas/sync-engine/git/commits/86eeca5a615c18f2ddfe95480a80356a9cac848b,86eeca5a615c18f2ddfe95480a80356a9cac848b,document index_namespace()
spang,2016-04-22 00:04:21,https://api.github.com/repos/nylas/sync-engine/git/commits/f21dc71ca9ddf7c14a09438b8c33401645e2ce19,f21dc71ca9ddf7c14a09438b8c33401645e2ce19,fix the build
spang,2016-04-21 23:55:24,https://api.github.com/repos/nylas/sync-engine/git/commits/a0a342b6ef9859935a8c3b69bcecfc8b59b91d94,a0a342b6ef9859935a8c3b69bcecfc8b59b91d94,"More accurate log message for 404 response

https://developers.google.com/google-apps/calendar/v3/errors#404_not_found"
kav-ya,2016-04-21 23:45:14,https://api.github.com/repos/nylas/sync-engine/git/commits/d07786caf095a0ea2ed362d7b6ea83875642611d,d07786caf095a0ea2ed362d7b6ea83875642611d,Sleep and commit more often in google eventsync.
spang,2016-04-21 19:53:47,https://api.github.com/repos/nylas/sync-engine/git/commits/345c9c7f93d1e822d612bd707019b58bd0f70111,345c9c7f93d1e822d612bd707019b58bd0f70111,"option, not argument"
spang,2016-04-21 19:46:31,https://api.github.com/repos/nylas/sync-engine/git/commits/ac2384ae4cc8e3cadb1ad34dd3842ec0e6bc41f3,ac2384ae4cc8e3cadb1ad34dd3842ec0e6bc41f3,Add script to detect missing sync hosts
khamidou,2016-04-21 19:09:17,https://api.github.com/repos/nylas/sync-engine/git/commits/7175a3aa8b9b101eaa605bcebb469b8142899c32,7175a3aa8b9b101eaa605bcebb469b8142899c32,"Handle more SMTP errors

Summary:
We weren’t handling a lot of SMTP errors, which was confusing for our customers and affected our API success rate.

SMTP errors are pretty weird. The most up-to-date providers (i.e Gmail) use a standardized format which looks like this:

```
552 ""5.2.3 Your message exceeded Google's message size limits. Please review our size guidelines.
```

Unfortunately, this format isn’t used by everybody. It’s common to have errors look like this:

```
550 email@example.com exceeded recipient rate limit  ( 151.0 / 1h )
```

This diff tries to handle both types of errors. I’ve added a partial table of SMTP errors which I’ve gotten from Google (https://support.google.com/a/answer/3726730) and from our logs. We’re matching errors based on the SMTP code (550, 552, etc.) and the contents of the message. This isn’t the most elegant solution but it should work for various free-form errors.

Test Plan: Ran the regression tests.

Reviewers: kav-ya

Reviewed By: kav-ya

Subscribers: spang

Maniphest Tasks: T6731

Differential Revision: https://phab.nylas.com/D2911"
spang,2016-04-21 16:57:07,https://api.github.com/repos/nylas/sync-engine/git/commits/80cd2b632e9667a0e998eb02cc1186ea33c6a8ca,80cd2b632e9667a0e998eb02cc1186ea33c6a8ca,"send JSON, not params"
spang,2016-04-21 16:41:15,https://api.github.com/repos/nylas/sync-engine/git/commits/0da83afff9a6a6b0fa7732b73b188664706bf493,0da83afff9a6a6b0fa7732b73b188664706bf493,proper messages
spang,2016-04-21 16:29:09,https://api.github.com/repos/nylas/sync-engine/git/commits/b92800b992616d8b41450d22353b89366ef5a3fe,b92800b992616d8b41450d22353b89366ef5a3fe,script fixes
spang,2016-04-21 15:34:21,https://api.github.com/repos/nylas/sync-engine/git/commits/bdcf6d09be463a247a898462b3ad2cfa09fe07da,bdcf6d09be463a247a898462b3ad2cfa09fe07da,"Unassign accounts using /unassign, not queue directly.

Otherwise, it is possible for accounts to be started on their
new host before they are stopped on the old host.

Fixes T6820"
spang,2016-04-19 13:14:22,https://api.github.com/repos/nylas/sync-engine/git/commits/7656a2cc1c35cf2104bd7e5aa76d8fc471bf211b,7656a2cc1c35cf2104bd7e5aa76d8fc471bf211b,"Log calendar sync events with separate component

Summary: This makes it much easier to query for only calendar sync logs.

Test Plan: Ran locally and verified log output

Reviewers: khamidou

Differential Revision: https://phab.nylas.com/D2905"
spang,2016-04-20 14:38:46,https://api.github.com/repos/nylas/sync-engine/git/commits/fbeee444290b14ea5f348e7996bbe19c4e6450cd,fbeee444290b14ea5f348e7996bbe19c4e6450cd,Add support for unscheduling a specific # of accounts
kav-ya,2016-04-19 20:38:33,https://api.github.com/repos/nylas/sync-engine/git/commits/7003a467125ba9ada7c6a4a8d0daf23b9ac816f0,7003a467125ba9ada7c6a4a8d0daf23b9ac816f0,Include script in setup.py
kav-ya,2016-04-19 18:50:39,https://api.github.com/repos/nylas/sync-engine/git/commits/af68a5764a5423fd4dea3f5236c4a282bc390b13,af68a5764a5423fd4dea3f5236c4a282bc390b13,Preserve name=None semantics in the API for non-canonical folders and labels.
kav-ya,2016-04-13 02:16:18,https://api.github.com/repos/nylas/sync-engine/git/commits/82ca173513bb4ba8b494650347649663f38097c3,82ca173513bb4ba8b494650347649663f38097c3,"[SCHEMA] Prevent duplicate Category creation.

Summary:
Fixes T6800.

The current Category UniqueConstraint contains two nullable columns (name, deleted_at).
Since MySQL treats NULL value as unique values, duplicate Categories for the same (display_name, name)
can be created.

This revision fixes the Category UniqueConstraint by both the name, deleted_at columns non-nullable.
For the former, the default value is set to the empty string ('') and for the latter, the EPOCH timestamp
('1970-01-01 00:00:00').
While using such default values (especially for the DateTime column) is non-ideal, this gets the job done and
preserves the desired API semantics around Category deletions in the simplest manner.

The schema migration, backfix scripts are included here as well.

Test Plan: Tests added, updated.

Reviewers: ethanb

Reviewed By: ethanb

Subscribers: mg, drew

Maniphest Tasks: T6800

Differential Revision: https://phab.nylas.com/D2879"
spang,2016-04-19 18:36:44,https://api.github.com/repos/nylas/sync-engine/git/commits/b034f6fe9d1e8c47e2310b4372f1175ef4cf2fc6,b034f6fe9d1e8c47e2310b4372f1175ef4cf2fc6,"Revert ""Don't run a full calendar sync for N1 accounts.""

This reverts commit bab43d7d16e2b2bab58cfaccbe0c1f795f65ab20.

Reason for revert: No longer needed now that quota issues are resolved."
spang,2016-04-19 14:07:51,https://api.github.com/repos/nylas/sync-engine/git/commits/cefadd8954ec91ec80b4f2667b3a85e9f288c46e,cefadd8954ec91ec80b4f2667b3a85e9f288c46e,"Less Inbox, more Nylas"
khamidou,2016-04-18 22:20:25,https://api.github.com/repos/nylas/sync-engine/git/commits/bab43d7d16e2b2bab58cfaccbe0c1f795f65ab20,bab43d7d16e2b2bab58cfaccbe0c1f795f65ab20,"Don't run a full calendar sync for N1 accounts.

Summary:
This diff changes the `sync_events` bit to a `TINYINT` instead of a `Boolean`. This allows us to set `sync_events = 2` for some accounts --- which means a partial sync of events on initial sync, going one month back.

Note that we can do this without running a migration because MySQL doesn't support booleans internally --- they're actually TINYINTs which SQLAlchemy translates to Python booleans.

This is very much a hack to make it easier to sync our big backlog of N1 accounts. We'll have to run a full sync for those accounts eventually.

Test Plan: Tested manually + ran unit tests.

Reviewers: kav-ya, spang

Reviewed By: spang

Differential Revision: https://phab.nylas.com/D2890"
khamidou,2016-04-18 18:17:35,https://api.github.com/repos/nylas/sync-engine/git/commits/6b9de8688b9ac19d3cd947b0d2550327942658dc,6b9de8688b9ac19d3cd947b0d2550327942658dc,typo
spang,2016-04-15 01:28:53,https://api.github.com/repos/nylas/sync-engine/git/commits/f7933e8b9e69d0597d194cf65f411fe4947b0ee8,f7933e8b9e69d0597d194cf65f411fe4947b0ee8,Fix unscheduling script
khamidou,2016-04-12 19:29:32,https://api.github.com/repos/nylas/sync-engine/git/commits/aa304b7b5031a30ad014cdc31bd62de23139d9a6,aa304b7b5031a30ad014cdc31bd62de23139d9a6,"Always set an expiration date when watching a Google Push API resource

Summary:
From a system stability standpoint, it's better to have a channel with a set expiration and having to periodically renew it than to have one channel sending notifications forever.

The expiration date is set one week in the future.

Test Plan: Read the code and tested snippets in a python REPL.

Reviewers: kav-ya

Reviewed By: kav-ya

Maniphest Tasks: T6714

Differential Revision: https://phab.nylas.com/D2877"
khamidou,2016-04-11 21:25:43,https://api.github.com/repos/nylas/sync-engine/git/commits/e4099e56e1038c613a965a92f025321a6a2fc891,e4099e56e1038c613a965a92f025321a6a2fc891,Update the script to run it shard by shard.
khamidou,2016-04-11 21:15:10,https://api.github.com/repos/nylas/sync-engine/git/commits/b5e07a67ce124bc48187e735cd3aeb9bd1cd3a9f,b5e07a67ce124bc48187e735cd3aeb9bd1cd3a9f,"Truncate the extra_flags column.

Summary: We don't use the extra_flags column and don't expose it (yet?), so I feel like it's simpler to truncate it than to design a massive data migration.

Test Plan: Wrote a regression test.

Reviewers: spang

Reviewed By: spang

Differential Revision: https://phab.nylas.com/D2855"
kav-ya,2016-04-05 19:38:11,https://api.github.com/repos/nylas/sync-engine/git/commits/d6a235f4354f04d52d3c32ba19b3002199b68b58,d6a235f4354f04d52d3c32ba19b3002199b68b58,"Introduce SettingUpdateError to indicate invalid endpoint updates.

Summary: Concomitant sync-engine changes to D2849.

Test Plan:
Tests in redwood;
Manual end-to-end testing against staging.

Reviewers: drew, khamidou

Reviewed By: khamidou

Differential Revision: https://phab.nylas.com/D2850"
spang,2016-04-06 17:58:18,https://api.github.com/repos/nylas/sync-engine/git/commits/a322d9a0659e197df5f5f02be1d297534945992c,a322d9a0659e197df5f5f02be1d297534945992c,"Also save to Sent in raw sending API for generic IMAP

Summary: Resolves a customer-reported bug.

Test Plan: Verified manually before/after. Trying to write a regression test but we don't have tests for this code yet...

Reviewers: khamidou

Reviewed By: khamidou

Differential Revision: https://phab.nylas.com/D2840"
khamidou,2016-04-05 22:19:54,https://api.github.com/repos/nylas/sync-engine/git/commits/b2b0e51dc3b3a829f4b1fd580e8c2f6dcf105641,b2b0e51dc3b3a829f4b1fd580e8c2f6dcf105641,"Add a streaming search API

Summary:
**Summary:**

This diff adds an API to stream search results as they arrive. According to my tests, it reduced latency by about 2x.

**The API:**

We have two new endpoints `/threads/search/streaming` and `/messages/search/streaming`. They both accept a `q` parameter, like the regular search endpoints. The only difference with the old search endpoints are:
- they return results as they arrive instead of buffering them.
- results are returned in chunks, separated by '\n' characters.

```
curl -X GET ""http://localhost:5555/threads/search/streaming?q=BHV""
[
  // chunk 1
]

[
  // chunk 2
]
```
**Error semantics**

Errors semantics are a bit different from the other APIs. Because of the way Flask's streaming responses are implemented, it's not possible to raise an error during the search itself. Instead, the search will return an empty result.

Test Plan: Tested manually + unit tests.

Reviewers: kav-ya

Reviewed By: kav-ya

Subscribers: juan, bengotow

Maniphest Tasks: T6766

Differential Revision: https://phab.nylas.com/D2822"
khamidou,2016-04-01 21:59:02,https://api.github.com/repos/nylas/sync-engine/git/commits/fdec776d520c7e68eca01428cb4201f26670f067,fdec776d520c7e68eca01428cb4201f26670f067,Make backfix script more robust.
kav-ya,2016-03-25 21:48:05,https://api.github.com/repos/nylas/sync-engine/git/commits/a6b011aed03efe24fc510daeb06166097d9bd7f9,a6b011aed03efe24fc510daeb06166097d9bd7f9,"Optimistic label updates by the API respects Gmail's semantics.

Summary:
Fixes one cause of T6740.

Labels can be manipulated through the API in a manner that is inconsistent with Gmail's semantics --
for example, a message update that removes 'inbox', preserves 'all' and adds 'trash' will be applied no problem --
and the logic in _update_categories() makes it so the right labels from Gmail will never be applied.

This revision makes it so the optimistic label updates by the API respect Gmail's semantics.

While the long-term solution is to remove the arbitrary wait-to-apply in _update_categories(), the changes
in this revision should suffice for now -- even if we removed the arbitrary wait in _update_categories(),
the optimistic label update *should* respect Gmail's semantics since for a period, these changes will not be synced from Gmail.

Test Plan: Tests added.

Reviewers: khamidou

Reviewed By: khamidou

Subscribers: drew

Differential Revision: https://phab.nylas.com/D2804"
khamidou,2016-03-31 21:46:46,https://api.github.com/repos/nylas/sync-engine/git/commits/b501938683eb39630a00e8e3f2acebf7653e6034,b501938683eb39630a00e8e3f2acebf7653e6034,"Re-apply ""Handle IMAP folders correctly (1/2)""

The commit is ready to ship now that aebbc0ecae5 has landed."
khamidou,2016-03-31 21:45:11,https://api.github.com/repos/nylas/sync-engine/git/commits/aebbc0ecae56329e54754c8d5e2d25aad6517fdd,aebbc0ecae56329e54754c8d5e2d25aad6517fdd,"Redo the generic IMAP folder separator migration

Summary:
D2739 and D2741 have a complicated history. They originally were part of a single diff which included a migration. The migration was run but the diff was rolled back.

This has an unfortunate consequence: there's some prod shards with the columns and some more recent ones, without it.

This diff adds a new migration which adds the required columns only for the shards which require it.

Test Plan: Tested by running the migration and rolling it back.

Reviewers: kav-ya

Reviewed By: kav-ya

Differential Revision: https://phab.nylas.com/D2817"
khamidou,2016-03-31 21:43:51,https://api.github.com/repos/nylas/sync-engine/git/commits/c7a1b91c3695b055e2ad9f3f20efdfe56d85aff1,c7a1b91c3695b055e2ad9f3f20efdfe56d85aff1,"[eas] Fix a message duplication bug

Summary:
This diff fixes an issue affecting some EAS accounts: moving a message to another folder would create a duplicate. Interestingly, this is because of an annoying MySQL bug which required some digging.

Here's how we reconcile EAS messages:
```
def reconcile_eas_message(new_message, account, device_id, folder_role, ...)
    ...
    q = db_session.query(Message).filter(
        Message.namespace_id == new_message.namespace_id,
        Message.subject == new_message.subject,
        Message.message_id_header == new_message.message_id_header)

    if folder_role != 'sent':
        # Message objects that were created via the API only get reconciled
        # with messages in the sent folder.
        q = q.filter(Message.is_created.is_(False),
                     Message.received_date == new_message.received_date)
```

We're using a message's received_date to help us identify messages. After a lot of head-scratching, I noticed that this received date has fractional seconds, which MySQL is [[ https://github.com/nylas/sync-engine/commit/ed16b406e0a | notoriously bad at ]].

The solution is to discard fractional seconds.

Test Plan: Tested manually, verified that it fixed the bug.

Reviewers: kav-ya

Reviewed By: kav-ya

Subscribers: spang

Maniphest Tasks: T6748

Differential Revision: https://phab.nylas.com/D2824"
kav-ya,2016-03-30 21:09:59,https://api.github.com/repos/nylas/sync-engine/git/commits/4e257ab1aa66dbcd45d1acad056f2b794f0f1def,4e257ab1aa66dbcd45d1acad056f2b794f0f1def,"Revert ""Handle IMAP folders correctly (1/2)""
This reverts commit c9f0b3b82e22cf4d7c037aa1ac8c6f5cc21f3397.

Reason for revert:
Not ready to go out to production/ needs migration.

Conflicts:
	setup.py"
kav-ya,2016-03-30 20:54:36,https://api.github.com/repos/nylas/sync-engine/git/commits/82b9fb410330e8d8daeb67def8ef85259af8c46d,82b9fb410330e8d8daeb67def8ef85259af8c46d,Add /bin/correct-autoincrements to setup.py
khamidou,2016-03-29 17:42:55,https://api.github.com/repos/nylas/sync-engine/git/commits/c9f0b3b82e22cf4d7c037aa1ac8c6f5cc21f3397,c9f0b3b82e22cf4d7c037aa1ac8c6f5cc21f3397,"Handle IMAP folders correctly (1/2)

Summary:
D2503 changed the way we handle IMAP folder separators: we're now storing IMAP folder separator and prefixes per-account, instead of assuming all non-Gmail servers used `.`.

Unfortunately, I couldn't ship it to prod because it required running a lengthy backfix, which caused our API success rate to drop.

To be able to ship this diff without affecting our customers, I've decided to split it into two parts:
1. the first part will contain the backfix code and changes to the auth handler.
2. the second part will contain the rest of the diff.

I'm going to ship the first part to prod, run the backfix and, when it's done, ship the second part.

Test Plan: Tested on staging when it was D2503.

Reviewers: kav-ya

Reviewed By: kav-ya

Differential Revision: https://phab.nylas.com/D2739"
khamidou,2016-03-29 17:34:01,https://api.github.com/repos/nylas/sync-engine/git/commits/2e9012eb17b80592d375c7f8eec5f6b4daab83ce,2e9012eb17b80592d375c7f8eec5f6b4daab83ce,"Add more generic IMAP sent folders

Summary: I noticed while going through our support queue that we weren't detecting sent folders for some generic IMAP accounts.

Test Plan: Inspected the code.

Reviewers: kav-ya

Reviewed By: kav-ya

Differential Revision: https://phab.nylas.com/D2809"
grinich,2016-03-29 00:22:18,https://api.github.com/repos/nylas/sync-engine/git/commits/35a16d6a10885da8fb6c0a995a1086de87838725,35a16d6a10885da8fb6c0a995a1086de87838725,more references to kill
grinich,2016-03-29 00:19:23,https://api.github.com/repos/nylas/sync-engine/git/commits/4b56fdb3a5ce07104657d0e9030c32b9b3753e12,4b56fdb3a5ce07104657d0e9030c32b9b3753e12,remove deleted files from setup.py
grinich,2016-03-29 00:15:43,https://api.github.com/repos/nylas/sync-engine/git/commits/d6ca16db7702696db111d7cab0241dbaa650eb43,d6ca16db7702696db111d7cab0241dbaa650eb43,Remove bitrotted and crufty scripts
khamidou,2016-03-25 22:46:49,https://api.github.com/repos/nylas/sync-engine/git/commits/f54666160b677eefe640f9efd527c2d0768846b7,f54666160b677eefe640f9efd527c2d0768846b7,"Make IMAP search more robust

Summary:
This diff fixes two things with IMAP search:
1. We're now catching a bunch of Exception we weren't before. For example, if a folder got deleted on the server, we just skip it instead of returning a 500 error.
2. We're now prioritizing folders --- we search first the `inbox` and `archive` folders, instead of going through every folder.

Test Plan: Tested manually. Ran unit tests.

Reviewers: kav-ya

Reviewed By: kav-ya

Differential Revision: https://phab.nylas.com/D2797"
kav-ya,2016-03-24 22:21:15,https://api.github.com/repos/nylas/sync-engine/git/commits/206442b0b3c3b3cea98ec6b15740aa8dd28cbb02,206442b0b3c3b3cea98ec6b15740aa8dd28cbb02,"Revert ""Allow draft sending to include an embedded invite from an existing event""
This reverts commit 40a76b266f363316eb2d5b6eaa8e69a775a4f217.

Reason for revert:
Needs alternate implementation to handle provider protocol limitations."
spang,2016-03-22 17:50:33,https://api.github.com/repos/nylas/sync-engine/git/commits/fc7c89c7bb4df88c2362eaf8609cf6e98a3e4934,fc7c89c7bb4df88c2362eaf8609cf6e98a3e4934,"Add utility script for unscheduling all syncs on a given host

Summary:
This is primarily useful for unscheduling all the accounts on a single sync
host after terminating it. This codifies something I did manually the other
week, and would like for people to not have to figure out how to do every time
we need it.

Test Plan: Tested manually with --dry-run and looked at output

Reviewers: ethanb

Reviewed By: ethanb

Differential Revision: https://phab.nylas.com/D2770"
khamidou,2016-03-21 22:23:54,https://api.github.com/repos/nylas/sync-engine/git/commits/3960028f07bbcd4e8c938771c98ea9d21ec56ebe,3960028f07bbcd4e8c938771c98ea9d21ec56ebe,"Fix a reauth bug

Summary: This is the generic IMAP counterpart to the auth bug Kavya fixed this morning for Exchange auth. We can get a '' from the authentication system --- handle it correctly.

Test Plan: Wrote a regression test.

Reviewers: kav-ya

Reviewed By: kav-ya

Differential Revision: https://phab.nylas.com/D2774"
dregitsky,2016-03-18 23:51:21,https://api.github.com/repos/nylas/sync-engine/git/commits/40a76b266f363316eb2d5b6eaa8e69a775a4f217,40a76b266f363316eb2d5b6eaa8e69a775a4f217,"Allow draft sending to include an embedded invite from an existing event

Summary:
On the send endpoint, add handling for an `event_id` in the draft JSON,
which looks up an existing event and adds it as ical to the MIME of
the message to be sent.

Test Plan: Add a test for sending a draft with an event

Reviewers: kav-ya

Reviewed By: kav-ya

Subscribers: bengotow, khamidou

Differential Revision: https://phab.nylas.com/D2751"
khamidou,2016-03-18 17:23:52,https://api.github.com/repos/nylas/sync-engine/git/commits/2f6bca5f05f2364227f3f3daad8f32eed0970328,2f6bca5f05f2364227f3f3daad8f32eed0970328,also test for None
kav-ya,2016-03-18 01:24:16,https://api.github.com/repos/nylas/sync-engine/git/commits/470ee1a4f752ff3f6bd47632856ef2c5323f8496,470ee1a4f752ff3f6bd47632856ef2c5323f8496,Reset sync_state='running' on re-authing accounts for sync_state='stopped' as well.
khamidou,2016-03-18 00:19:59,https://api.github.com/repos/nylas/sync-engine/git/commits/e27ebda3779f25e3a1a61872588e3aefc9e51331,e27ebda3779f25e3a1a61872588e3aefc9e51331,parametrized test
khamidou,2016-03-17 23:18:18,https://api.github.com/repos/nylas/sync-engine/git/commits/13e09ae1a952924782c41392355e8cb16f5b9a7e,13e09ae1a952924782c41392355e8cb16f5b9a7e,Add a test to make sure that accounts with sync_should_run set to False aren't started.
khamidou,2016-03-15 21:24:41,https://api.github.com/repos/nylas/sync-engine/git/commits/8a9bcdda35a65245e5f9375195944ec12e8e9cf5,8a9bcdda35a65245e5f9375195944ec12e8e9cf5,Add a better error message when trying to update an IMAP/SMTP endpoint.
kav-ya,2016-03-14 22:52:15,https://api.github.com/repos/nylas/sync-engine/git/commits/07e325eded0979efb8dd5296618ad67a8804dfb9,07e325eded0979efb8dd5296618ad67a8804dfb9,"Surface sending quota exceeded errors for iCloud accounts as HTTP 429s as well.

Summary:
We can handle the same for other providers after this has been shipped.

Test Plan: Unit test added.

Reviewers: ethanb

Reviewed By: ethanb

Subscribers: khamidou

Differential Revision: https://phab.nylas.com/D2736"
khamidou,2016-03-14 18:10:21,https://api.github.com/repos/nylas/sync-engine/git/commits/f237de76deef72dcaf7d366acdbd6b46663a186e,f237de76deef72dcaf7d366acdbd6b46663a186e,"Make `matching_subdomains` a bit more robust

Summary: Companion diff to D2676. The EAS auth code sometimes gives us URLs instead of domain names. Handle this case.

Test Plan: Authed an EAS account.

Reviewers: emfree

Reviewed By: emfree

Differential Revision: https://phab.nylas.com/D2677"
khamidou,2016-03-13 05:59:36,https://api.github.com/repos/nylas/sync-engine/git/commits/0eba2743c0070f4eae1be8cb15d1045fa57944da,0eba2743c0070f4eae1be8cb15d1045fa57944da,"Override sync_state for N1

Test Plan: Tested manually by setting IS_N1 to true then to false. Checked than an account state was displayed as ""running"" only for N1.

Reviewers: spang

Reviewed By: spang

Differential Revision: https://phab.nylas.com/D2730"
kav-ya,2016-03-11 19:58:35,https://api.github.com/repos/nylas/sync-engine/git/commits/514241ceb27fa470a29a6a94272af3c2c51785a6,514241ceb27fa470a29a6a94272af3c2c51785a6,Set the `sync_state` on the API-returned account object to 'running' for new accounts.
khamidou,2016-03-11 19:27:43,https://api.github.com/repos/nylas/sync-engine/git/commits/20be2cd099720154d8940c6095fc9cb2a933f61b,20be2cd099720154d8940c6095fc9cb2a933f61b,"Merge pull request #286 from nylas/Add-Soverin

Add Soverin to providers"
GM-Polyakov,2016-03-11 19:25:38,https://api.github.com/repos/nylas/sync-engine/git/commits/f4cf6839ff867722a5e33015a4d2e24dd5969283,f4cf6839ff867722a5e33015a4d2e24dd5969283,"changed imap port from 143 to 993

Changed as per Karim's note: 143 is IMAP w/ STARTTLS, which is slightly
less secure."
GM-Polyakov,2016-03-11 18:53:21,https://api.github.com/repos/nylas/sync-engine/git/commits/9ae4a4294e24a7f6bb67bbc6f341828bbcbe5859,9ae4a4294e24a7f6bb67bbc6f341828bbcbe5859,"fixed name

Removed "".net"" from name"
GM-Polyakov,2016-03-11 18:47:14,https://api.github.com/repos/nylas/sync-engine/git/commits/a86c614d6ed5a74f1f8ee797a64d5ff91cba67a6,a86c614d6ed5a74f1f8ee797a64d5ff91cba67a6,"Added Soverin to providers

Added settings for soverin.net email provider to autodetected providers."
dregitsky,2016-03-11 00:49:05,https://api.github.com/repos/nylas/sync-engine/git/commits/33e3496215f580ba765ad3946ec7031e2fc35960,33e3496215f580ba765ad3946ec7031e2fc35960,"Update /metadata ""all metadata"" endpoint to exclude deleted metadata

Summary:
Currently the /metadata endpoint pages though all entries for the
account, including those where the metadata has been deleted via the
API (since deletion only writes NULL into the `value` field). This
filters that endpoint on `value != None` to prevent these entries from
showing up.

Test Plan: new test in redwood

Reviewers: kav-ya

Reviewed By: kav-ya

Subscribers: bengotow, ethan

Differential Revision: https://phab.nylas.com/D2717"
kav-ya,2016-03-10 22:59:12,https://api.github.com/repos/nylas/sync-engine/git/commits/7435d508ae95c69dcb596e74f62bfb030011201f,7435d508ae95c69dcb596e74f62bfb030011201f,Update mock Account in tests.
kav-ya,2016-03-10 22:37:12,https://api.github.com/repos/nylas/sync-engine/git/commits/22b8ac78fffffd0109ed3679ca76c70e5525e6f0,22b8ac78fffffd0109ed3679ca76c70e5525e6f0,"Set account.sync_state 'invalid'->'running' on a successful reauth.
This is necessary for API requests to proceed and an account modify delta to
be returned to delta/ streaming clients."
khamidou,2016-03-10 19:45:57,https://api.github.com/repos/nylas/sync-engine/git/commits/9faf4ea5be7f8c07d89d24146b5e6b87de80c361,9faf4ea5be7f8c07d89d24146b5e6b87de80c361,"Update get-object

Summary:
It already wasn’t very practical to run `get-object` in a single-shard world, and its become much slower since we sharded our db. This diff fixes this by adding support for an —account-id and —namespace-id argument.

This diff also contains a tiny wording fix for a crispin error message.

Test Plan: Tested manually.

Reviewers: spang

Reviewed By: spang

Differential Revision: https://phab.nylas.com/D2666"
emfree,2016-03-10 00:04:02,https://api.github.com/repos/nylas/sync-engine/git/commits/82f81d52311b65403a29f58a51991d82eb4be09c,82f81d52311b65403a29f58a51991d82eb4be09c,"Better handle concurrent Google calendar push updates.

For reasons that are still unclear, a few calendars can receive lots of
concurrent updates from Google calendar push notifications. Contentious
database writes are problematic, so just limit update frequency.

Test plan: Unit tests added."
kav-ya,2016-03-09 22:36:25,https://api.github.com/repos/nylas/sync-engine/git/commits/dd7ebb98995e7e987f7847be553e52afa7a36fb7,dd7ebb98995e7e987f7847be553e52afa7a36fb7,Ensure account deltas are returned when account.namespace.id != account.id as well.
grinich,2016-03-09 08:08:51,https://api.github.com/repos/nylas/sync-engine/git/commits/553c4738e6a6199d0d7ccdccb75e48b9685a20a0,553c4738e6a6199d0d7ccdccb75e48b9685a20a0,"Add `last_message_sent_timestamp` attribute to threads API

Summary:
Also rename ""receivedrecentdate"" to ""most_recent_received_date"" for clarity.

Fixes T6626

Test Plan: Added tests

Reviewers: spang

Subscribers: bengotow, kav-ya

Maniphest Tasks: T6626

Differential Revision: https://phab.nylas.com/D2703"
khamidou,2016-03-08 21:43:57,https://api.github.com/repos/nylas/sync-engine/git/commits/7dc0038195d235e6eddb9db30633c47429845427,7dc0038195d235e6eddb9db30633c47429845427,fix boto3 version
emfree,2016-03-08 19:27:24,https://api.github.com/repos/nylas/sync-engine/git/commits/b8140527fd2ea10bb941daeabdf991e5351a81bf,b8140527fd2ea10bb941daeabdf991e5351a81bf,Fix test command in Travis cfg; remove deprecated runtests script.
kav-ya,2016-03-03 20:27:12,https://api.github.com/repos/nylas/sync-engine/git/commits/04a1b2bfaa63eb23747dd5866002279960e9fa2d,04a1b2bfaa63eb23747dd5866002279960e9fa2d,"Respect `sync_email=False` throughout Gmail auth flow.

Summary: Fixes T6692.

Test Plan: Regression tests added.

Reviewers: emfree

Reviewed By: emfree

Subscribers: drew

Maniphest Tasks: T6692

Differential Revision: https://phab.nylas.com/D2678"
kav-ya,2016-03-05 01:09:40,https://api.github.com/repos/nylas/sync-engine/git/commits/72e22eb28be0f136015e86eb99a93268b483d617,72e22eb28be0f136015e86eb99a93268b483d617,"Expose the server_settings in the `account` object.

Summary:
Fixes T6704.

Setting `expand=True` while serializing the API `account` object returns the server_settings
for IMAP accounts. Gmail accounts do set set/ expose this attribute.

Test Plan: Tests added.

Reviewers: emfree

Reviewed By: emfree

Maniphest Tasks: T6704

Differential Revision: https://phab.nylas.com/D2683"
emfree,2016-03-05 00:14:00,https://api.github.com/repos/nylas/sync-engine/git/commits/8bae06166efde8e8bf2cc306c57a7c7d8e4c7c9e,8bae06166efde8e8bf2cc306c57a7c7d8e4c7c9e,"Revert ""Parse snippets to no longer include prior messages""

This reverts commit 96f39a046a5be3798ac073442c54e9b95886feaf.

Reason for rollback: Still can block."
logandavis,2016-02-29 22:01:39,https://api.github.com/repos/nylas/sync-engine/git/commits/78ed0285ebaf24e495780ff39c606c319cb90acd,78ed0285ebaf24e495780ff39c606c319cb90acd,"Fix bin/inbox-auth for no-SSL accounts

Summary:
bin/inbox-auth wasn't working for accounts without SSL, because
of some faulty boolean logic. Also, we were forcing GoDaddy
accounts to auth with specific ports, which is no good, since
those are ports with SSL and many of our no-SSL clients use
GoDaddy on different ports. These problems are fixed here.

linting

Test Plan: ran bin/inbox-auth with a no-SSL account. It worked.

Reviewers: spang, kav-ya

Reviewed By: kav-ya

Subscribers: spang

Differential Revision: https://phab.nylas.com/D2644"
emfree,2016-03-03 20:07:46,https://api.github.com/repos/nylas/sync-engine/git/commits/b35b5855311bc08fa96cfe961a94d7a95ea2ff0a,b35b5855311bc08fa96cfe961a94d7a95ea2ff0a,"Return HTTP 400 not 403 on delete of non-empty folder.

Fixes T6703."
emfree,2016-03-03 00:04:26,https://api.github.com/repos/nylas/sync-engine/git/commits/3556dc1b38ed27bc45f5efde080d180cafb01458,3556dc1b38ed27bc45f5efde080d180cafb01458,"Revert ""Optionally issue explicit BEGIN upon initiating database transaction.""

This reverts commit fd34dea3ebdd4858807f255527d410158b12b9e7.

Reason for rollback: unneeded."
logandavis,2016-03-03 01:57:30,https://api.github.com/repos/nylas/sync-engine/git/commits/0f331a3c6a9f21100465080ac0ad877252ac7926,0f331a3c6a9f21100465080ac0ad877252ac7926,"Also expose port 5009 in Vagrantfile

Summary:
N1's auth server edgehill-server listens on port 5009. Expose it
in the Vagrant box so that we can do full-stack N1 auth testing
without resorting to running multiple vagrant boxes.

Test Plan: I tried to connect to port 5009. It worked.

Reviewers: emfree

Reviewed By: emfree

Subscribers: kav-ya

Maniphest Tasks: T6690

Differential Revision: https://phab.nylas.com/D2672"
khamidou,2016-03-03 02:03:20,https://api.github.com/repos/nylas/sync-engine/git/commits/d143c20b70563fdeca4b8625024387f8d3c3301d,d143c20b70563fdeca4b8625024387f8d3c3301d,"Allow updating some IMAP endpoints

Summary:
This diff relaxes the constraints around updating endpoints for already-existing accounts. We allow updating endpoints provided that:
1. The old and new endpoint share the same parent domain (e.g: email.microsoft.com and outlook.microsoft.com will work but not email.services.microsoft.com and outlook.microsoft.com)
2. They point to the same IP address.

Also added a regression test.

Test Plan: Added a regression test.

Reviewers: emfree

Reviewed By: emfree

Subscribers: bernd, kav-ya

Differential Revision: https://phab.nylas.com/D2668"
emfree,2016-03-02 21:27:53,https://api.github.com/repos/nylas/sync-engine/git/commits/250b0ba043d28b66db0b8fb5baa3c2b54ac97828,250b0ba043d28b66db0b8fb5baa3c2b54ac97828,"Log more info on API usage responses.

Should help triage reports of unexpected 400s/404s."
emfree,2016-03-02 20:27:13,https://api.github.com/repos/nylas/sync-engine/git/commits/20289497bd698cd4e3a4a2a21c56fa4108341c3d,20289497bd698cd4e3a4a2a21c56fa4108341c3d,"Include \\Trash, \\Spam, \\All in set of Gmail labels that get remapped.

You don't *normally* see these in X-GM-LABELS (rather, you see an actual IMAP
folder move), but it seems possible that you briefly can.

Fixes T6698."
emfree,2016-02-29 22:11:01,https://api.github.com/repos/nylas/sync-engine/git/commits/ad3ec3b3f8e98afe0be044f3b4f00bb288189163,ad3ec3b3f8e98afe0be044f3b4f00bb288189163,Log additional context on SMTP connection failure.
khamidou,2016-03-01 20:07:07,https://api.github.com/repos/nylas/sync-engine/git/commits/a0a909216b09ccb56f0b8815e0c0f31ab3bfb3e9,a0a909216b09ccb56f0b8815e0c0f31ab3bfb3e9,Add a course of action to the error messages.
kav-ya,2016-03-01 05:18:34,https://api.github.com/repos/nylas/sync-engine/git/commits/b71b443207821db98216813184ffe00aadba52da,b71b443207821db98216813184ffe00aadba52da,"Return a consistent response across all API endpoints for an invalid account.

Summary:
As is, the different API endpoints return different and even internally inconsistent responses for invalid accounts:
* /send returns an HTTP 403 for Gmail, generic IMAP accounts,
* /search returns an HTTP 403 for Gmail accounts and an HTTP 500 for generic IMAP,
* More troublingly, message and thread update operations can return an HTTP 200 if there is no state change,
despite the account being invalid -- since the account validity check only occurs when the remote action is scheduled, and
an HTTP 403 if there is a state change.

To address all of the above, verify the validity of the account's credentials /before/ performing a
request to the remote server. This includes the message and thread /search endpoints, and the /send endpoint
which directly interact with the remote server, and all create, update, delete requests which result in requests
to the remote server via action syncback.

NOTE:
The concomitant EAS changes will be submitted in a separate revision.

Test Plan:
Tests added.
Tested manually.

Reviewers: emfree

Reviewed By: emfree

Differential Revision: https://phab.nylas.com/D2658"
kav-ya,2016-03-01 05:11:29,https://api.github.com/repos/nylas/sync-engine/git/commits/91b9efe5dfa0d23657402532e552f74514d5904c,91b9efe5dfa0d23657402532e552f74514d5904c,"Conditionally expose the `account` object in the delta, streaming APIs.

Summary:
Currently, no notification is sent to clients when an account becomes invalid.
This is problematic for N1 since there is no way to ""gracefully fail"" to the user and ask
them to reauthenticate until the next failing API request.

To address this, conditionally expose the `account` object in the delta, streaming APIs --
by setting the `exclude_account` flag to False, N1 will receive notifications about account.sync_state changes
(i.e. when it becomes invalid, when it flips to running again).

Test Plan: Tests added.

Reviewers: emfree

Reviewed By: emfree

Differential Revision: https://phab.nylas.com/D2657"
khamidou,2016-03-01 17:51:42,https://api.github.com/repos/nylas/sync-engine/git/commits/725faac1526f0592e839ede92aa8aea3c8225e44,725faac1526f0592e839ede92aa8aea3c8225e44,"First pass at better error messages

Summary: Was fixing a bunch of errors in the redwood auth but it turns out we were actually proxying sync-engine errors.

Test Plan: Ran the tests.

Reviewers: spang

Reviewed By: spang

Differential Revision: https://phab.nylas.com/D2656"
khamidou,2016-03-01 17:38:55,https://api.github.com/repos/nylas/sync-engine/git/commits/875f2f362c78b365e7b72afbaefd16bbb04642d5,875f2f362c78b365e7b72afbaefd16bbb04642d5,"[sync] Don't delete canonical labels

Summary: Many customers have complained that they wouldn't see the ""Important"" label in N1. Turns out it's because it's been marked as deleted. This diff prevents us from marking as deleted any label with a canonical name.

Test Plan: Wrote a regression test.

Reviewers: emfree

Reviewed By: emfree

Differential Revision: https://phab.nylas.com/D2648"
spang,2016-03-01 02:54:37,https://api.github.com/repos/nylas/sync-engine/git/commits/698d4643147ad086e3dd1689e039a280bd0d13d3,698d4643147ad086e3dd1689e039a280bd0d13d3,"Simplify providers code and override bluehost domain incorrectly identified as Gmail

Summary:
This commit removes a bunch of long-unused code implementing a plugin interface for our providers mapping which we've never actually used, and adds an override for a bluehost domain that currently is matched as a Google domain.

It also changes the algorithm we use to match providers to match first on domains, then on MX records, and finally on NS servers. We've already been making the assumption that domain matches are stronger than MX matches, and the previous domain overrides for accounts misidentified as Gmail accounts only worked through sheer luck since dictionaries are unordered.

Test Plan: unit and manual tests

Reviewers: khamidou

Reviewed By: khamidou

Differential Revision: https://phab.nylas.com/D2653"
kav-ya,2016-03-01 02:15:46,https://api.github.com/repos/nylas/sync-engine/git/commits/fe68e76ab0785a3bf11fe92927bcc275f76e920e,fe68e76ab0785a3bf11fe92927bcc275f76e920e,Update test account credentials.
khamidou,2016-03-01 00:14:21,https://api.github.com/repos/nylas/sync-engine/git/commits/d09b4b904cb08c7881d39193bbe051078048d952,d09b4b904cb08c7881d39193bbe051078048d952,minor version matters too.
khamidou,2016-02-29 23:52:48,https://api.github.com/repos/nylas/sync-engine/git/commits/09fb7f13a31ceea426b389e8a917957bfb5ecefd,09fb7f13a31ceea426b389e8a917957bfb5ecefd,hardcode dateutil version in setup.py too.
khamidou,2016-02-29 22:47:01,https://api.github.com/repos/nylas/sync-engine/git/commits/408a7ede786f2acdcd44c5619e1166abd8581ba8,408a7ede786f2acdcd44c5619e1166abd8581ba8,"hardcode dateutil version hash, because pip tries to get the latest version.

dateutil just released version 2.5.0"
emfree,2016-02-26 02:31:33,https://api.github.com/repos/nylas/sync-engine/git/commits/fd34dea3ebdd4858807f255527d410158b12b9e7,fd34dea3ebdd4858807f255527d410158b12b9e7,"Optionally issue explicit BEGIN upon initiating database transaction.

This really shouldn't be necessary... unless your database proxy does not
reliably preserve a database connection's autocommit value. For now this is
only enabled in the API for testing simplicity. We will enable it sitewide if
no problems are found in testing."
kav-ya,2016-02-18 22:49:28,https://api.github.com/repos/nylas/sync-engine/git/commits/8e9fca4e0c4ebd1041258df18d22e904a4f406ce,8e9fca4e0c4ebd1041258df18d22e904a4f406ce,"[SCHEMA] Implement support for non-SSL IMAP/ SMTP authentication.

Summary:
Fixes T6666.

The generic IMAP/ SMTP auth flow is updated to handle the case that an IMAP/ SMTP
server does not support SSL (over the default port or via STARTTLS) but authentication
over an insecure connection is desired.

Test Plan: Tests added, tested manually.

Reviewers: emfree

Reviewed By: emfree

Maniphest Tasks: T6666

Differential Revision: https://phab.nylas.com/D2598"
khamidou,2016-02-24 01:30:46,https://api.github.com/repos/nylas/sync-engine/git/commits/4d1f1e0c7019a5f206302f45d5156e31c9a514bf,4d1f1e0c7019a5f206302f45d5156e31c9a514bf,forgot to add @property decorator.
khamidou,2016-02-22 21:54:29,https://api.github.com/repos/nylas/sync-engine/git/commits/6dcd30cba47798e8d6f2ef99f2b6c13cf7d60cad,6dcd30cba47798e8d6f2ef99f2b6c13cf7d60cad,"Revert ""merge alter statements together.""

This reverts commit 0ed919a86c835956596e9e897423e6176625f158.
Reverting all IMAP folder handling patches."
khamidou,2016-02-22 21:54:03,https://api.github.com/repos/nylas/sync-engine/git/commits/c3be03401eca5e0d4987fdc99658d1ca09748d61,c3be03401eca5e0d4987fdc99658d1ca09748d61,"Revert ""[SCHEMA] Rework folders handling""

This reverts commit bc2cff7dac08fdaf14228750a74b04ebd31efae6.

Conflicts:
	migrations/versions/216_add_folder_separator_column_for_generic_.py
	setup.py"
kav-ya,2016-02-19 20:37:23,https://api.github.com/repos/nylas/sync-engine/git/commits/0f8aba362cda1da334d0811bb360e8b7a33c49d4,0f8aba362cda1da334d0811bb360e8b7a33c49d4,"Update IMAP/ SMTP credentials on re-authing a generic account.

Summary:
We absolutely must update the IMAP/ SMTP credentials in update_account()
in order for the legacy auth to function as desired.

Test Plan:
Regression test added.
Tested entire flow manually. I attempted to write an end-to-end test in redwood
to do so as well and am extremely unsatisfied with it. Let's not block on it though; I
will write it shortly.

Reviewers: emfree

Reviewed By: emfree

Differential Revision: https://phab.nylas.com/D2606"
kav-ya,2016-02-19 01:38:35,https://api.github.com/repos/nylas/sync-engine/git/commits/a9576f7398c3ff69239908e6c27c7a980800e115,a9576f7398c3ff69239908e6c27c7a980800e115,"Do not allow IMAP/ SMTP endpoints to be updated during re-auth of existing accounts.

Summary:
Allowing these endpoints to be subsequently changed after an account has been authed/ synced
is no bueno.

Note:
The corresponding EAS changes are in D2603.
No changes to the API code are necessary.

Test Plan: Regression tests added.

Reviewers: emfree

Reviewed By: emfree

Differential Revision: https://phab.nylas.com/D2601"
grinich,2016-02-18 23:36:08,https://api.github.com/repos/nylas/sync-engine/git/commits/befbf46828c47aebaf7f9d257652f1c2dfd27ae3,befbf46828c47aebaf7f9d257652f1c2dfd27ae3,"Merge pull request #273 from nylas/pr/191

Allow any_email param to accept multiple values"
AdriVanHoudt,2015-08-20 09:43:23,https://api.github.com/repos/nylas/sync-engine/git/commits/de19d5587d75d5aed0342bc255312d1fa302d27f,de19d5587d75d5aed0342bc255312d1fa302d27f,"Allow any_email param to accept multiple comma-separated email addresses

Also add new validation code for lists of email addresses

Closes original PR opened at https://github.com/nylas/sync-engine/pull/191"
grinich,2016-02-18 21:30:30,https://api.github.com/repos/nylas/sync-engine/git/commits/071f17064b5d0ba5aa9fd07580eabdff6038802f,071f17064b5d0ba5aa9fd07580eabdff6038802f,"Merge pull request #272 from nylas/masylum-allow-restful-patch

Add PATCH command to API endpoints to match REST semantics"
grinich,2016-02-18 17:41:25,https://api.github.com/repos/nylas/sync-engine/git/commits/b4c2f2a4691ba6d1021772a091417722c25c53fb,b4c2f2a4691ba6d1021772a091417722c25c53fb,"Merge pull request #274 from nylas/pr/211

Add the ability to choose a provider in bin/inbox-auth"
nlowe,2015-10-09 22:57:47,https://api.github.com/repos/nylas/sync-engine/git/commits/a22c9c92d9a9976c7523945b50674d138c6af945,a22c9c92d9a9976c7523945b50674d138c6af945,Fix #209: Add the ability to force a provider via bin/inbox-auth
grinich,2016-02-18 16:00:40,https://api.github.com/repos/nylas/sync-engine/git/commits/e40d26ec17529b86f10ede63f8478180e7deb400,e40d26ec17529b86f10ede63f8478180e7deb400,add PATCH to more endpoints
masylum,2015-10-18 11:22:49,https://api.github.com/repos/nylas/sync-engine/git/commits/12860ceaad881a97426f02b08e3bc4260f260aca,12860ceaad881a97426f02b08e3bc4260f260aca,Allow use of PATCH to follow REST semantics
grinich,2016-02-18 15:11:22,https://api.github.com/repos/nylas/sync-engine/git/commits/8cb2d4e33a1fd979784977e87037df0d4a7daee6,8cb2d4e33a1fd979784977e87037df0d4a7daee6,"Merge pull request #271 from nylas/test

Changes to automaticaly run tests on TravisCI"
emfree,2016-02-18 04:53:39,https://api.github.com/repos/nylas/sync-engine/git/commits/a0e86d1dfb0f91d1c736bce62cfa3ece73ad7d32,a0e86d1dfb0f91d1c736bce62cfa3ece73ad7d32,test
grinich,2016-02-08 06:14:50,https://api.github.com/repos/nylas/sync-engine/git/commits/3cbec04ffd82cc726d4c3640261eba4bd45bec5c,3cbec04ffd82cc726d4c3640261eba4bd45bec5c,Add TravisCI build file
grinich,2016-02-08 06:02:07,https://api.github.com/repos/nylas/sync-engine/git/commits/99cca79299cfd7dd5e3fa97182c6c80933be20ab,99cca79299cfd7dd5e3fa97182c6c80933be20ab,"Refactor test utility

- Never create Namespaces without an accompanying account
- Don't directly use Account or ImapAccount objects"
grinich,2016-02-08 06:01:40,https://api.github.com/repos/nylas/sync-engine/git/commits/fe34247fbf66cb2471ed177aa2f7e3cb2058789c,fe34247fbf66cb2471ed177aa2f7e3cb2058789c,Fix tests with limit param for case where there are more than 100 accts
grinich,2016-02-08 06:04:57,https://api.github.com/repos/nylas/sync-engine/git/commits/9b2201bf308f875c7ee94bc4aa4b9333da870625,9b2201bf308f875c7ee94bc4aa4b9333da870625,Add note for not directly creating Account or ImapAccount
grinich,2016-02-08 06:14:32,https://api.github.com/repos/nylas/sync-engine/git/commits/7b7d32448f231bc68f61cd48a1c02871a75d2b7f,7b7d32448f231bc68f61cd48a1c02871a75d2b7f,Less verbose setup script
grinich,2016-02-08 06:14:43,https://api.github.com/repos/nylas/sync-engine/git/commits/b6ad7d67c28d7899db1c3ecc217322787be5348c,b6ad7d67c28d7899db1c3ecc217322787be5348c,Remove old ZMQ dependency
khamidou,2016-02-18 01:52:44,https://api.github.com/repos/nylas/sync-engine/git/commits/eb872e535c0112fe0cd3be77af555e6e3c4ed096,eb872e535c0112fe0cd3be77af555e6e3c4ed096,fix migration to use migrate-db
emfree,2016-02-18 00:20:51,https://api.github.com/repos/nylas/sync-engine/git/commits/8877f027b49e0ac5dbc3a9886276099e3c10768e,8877f027b49e0ac5dbc3a9886276099e3c10768e,Fix test.
emfree,2016-02-17 22:16:15,https://api.github.com/repos/nylas/sync-engine/git/commits/0a9286a77564c5d192ec2131c941e85d2f693d92,0a9286a77564c5d192ec2131c941e85d2f693d92,"Properly replace div tags when creating message snippets.

Fixes Github issue #266, T3367."
emfree,2016-02-17 18:46:12,https://api.github.com/repos/nylas/sync-engine/git/commits/8d040f1b4af318ea65b0b80f6e0e1b4297925669,8d040f1b4af318ea65b0b80f6e0e1b4297925669,Fix merged script list.
khamidou,2016-02-17 18:44:15,https://api.github.com/repos/nylas/sync-engine/git/commits/0ed919a86c835956596e9e897423e6176625f158,0ed919a86c835956596e9e897423e6176625f158,merge alter statements together.
khamidou,2016-02-17 18:43:03,https://api.github.com/repos/nylas/sync-engine/git/commits/88a60b8ba5e8bca6869f6eeb872852c8592db6bd,88a60b8ba5e8bca6869f6eeb872852c8592db6bd,add stamp db to toolset.
khamidou,2016-02-17 17:58:48,https://api.github.com/repos/nylas/sync-engine/git/commits/bc2cff7dac08fdaf14228750a74b04ebd31efae6,bc2cff7dac08fdaf14228750a74b04ebd31efae6,"[SCHEMA] Rework folders handling

Summary:
My previous fix to the folder handling code for IMAP was buggy. Namely:
- it didn’t work for providers different from ‘custom’ and ‘fast mail’
- it incorrectly assumed most IMAP providers used dots for path separators.

This diff fixes that by:
- storing the folder separator in the GenericAccount object (added a migration + backfix script for this)
- reworking the path conversion functions to do the right thing (instead of doing the right thing for fastmail only)

Test Plan: Tested manually by CRUDing a folder using a Fastmail and Gandi account.

Reviewers: emfree

Reviewed By: emfree

Differential Revision: https://phab.nylas.com/D2503"
kav-ya,2016-02-16 18:48:54,https://api.github.com/repos/nylas/sync-engine/git/commits/8cd28178eae73408beec14963e49690e9614d01e,8cd28178eae73408beec14963e49690e9614d01e,Remove unused AccountTransaction scripts.
emfree,2016-02-12 00:09:12,https://api.github.com/repos/nylas/sync-engine/git/commits/b8bfdd57346864294a8af99cc41cc73001dbc676,b8bfdd57346864294a8af99cc41cc73001dbc676,Bump database connect timeout.
logandavis,2016-02-11 00:54:04,https://api.github.com/repos/nylas/sync-engine/git/commits/0ec1f9953244cd2c0c6a5d1f9e21dedef25ff601,0ec1f9953244cd2c0c6a5d1f9e21dedef25ff601,"Disable E402 in sync-engine

Summary:
E402 is everywhere in the sync-engine repo and is causing builds
to be marked as unbuildable. Disable it. (Note: a similar commit has
already landed in sync-engine-eas. Pyflakes looks for tox.ini
on a project level, so each repo is going to need this added
if we want to disable the lint everywhere.)

Test Plan: This run of arc diff is the test.

Reviewers: emfree

Reviewed By: emfree

Differential Revision: https://phab.nylas.com/D2563"
kav-ya,2016-02-11 18:32:22,https://api.github.com/repos/nylas/sync-engine/git/commits/15b7ca17aa7d8f5ed490544b893a1569c485fbe7,15b7ca17aa7d8f5ed490544b893a1569c485fbe7,Per-shard AccountTransaction population script.
logandavis,2016-02-04 01:02:06,https://api.github.com/repos/nylas/sync-engine/git/commits/497847a1175ea578f656a3e36e109d3b4de4e574,497847a1175ea578f656a3e36e109d3b4de4e574,"Make /labels/ 404 for accounts with folders and vice versa; add tests.

Summary:
Previously, GMail users could see a list of their account's labels by
sending a GET request to /folders/, and other users could see their
account's folders by sending a get request to /labels/. Similarly,
folders and labels could be renamed, deleted, etc. by sending requests
to either /folders/ or /labels/. Now /folders/ and /labels/ are
account-type-specific, so a request to /folders/ from a user whose
account uses labels will 404.

Also, added a pair of tests to check this functionality. Previously,
all of the tests for folders and labels were in
tests/api/test_messages.py, but with the addition of new tests it
made sense to refactor the tests and move them to their own file,
tests/api/test_folders_labels.py. New tests check every type of
request that can be made to /folders/ and /labels/ and also confirm
account-type-specificity. One older test (tests/api/test_views.py)
relied on /folders/ and /labels/ both being available for the same
GMail account; it now creates a new account to test folders in.

(Sorry for excessive linting commits. My text editor's linter wasn't
checking line lengths properly.)

Test Plan:
Ran py.test tests. Everything passed except for the
one skipped test and the one xfailed test.

Reviewers: khamidou

Reviewed By: khamidou

Maniphest Tasks: T3339

Differential Revision: https://phab.nylas.com/D2463"
emfree,2016-02-10 04:19:34,https://api.github.com/repos/nylas/sync-engine/git/commits/9490073efaea0530a4cfc12a7f1bbb4fb5fbb811,9490073efaea0530a4cfc12a7f1bbb4fb5fbb811,"Revert ""Parse snippets to no longer include prior messages""

This reverts commit 566fe2d3d69552ff18984c1cbc1ac595a4e41a18.

Reason for rollback: blocks event loop."
emfree,2016-02-10 03:52:33,https://api.github.com/repos/nylas/sync-engine/git/commits/7e322574097e0f14365d96dc16ec115147406554,7e322574097e0f14365d96dc16ec115147406554,"Configure backref on reply_to_message.

This emulates a database-level `ON DELTE SET NULL` cascade, which was wrongly
not configured, at the ORM level.

Fixes T6636."
dregitsky,2016-02-09 23:33:05,https://api.github.com/repos/nylas/sync-engine/git/commits/68d01f00fb104c03aee8841a22c502764e7db0d3,68d01f00fb104c03aee8841a22c502764e7db0d3,change metadata serialization to always include `value` field
emfree,2016-02-09 22:37:48,https://api.github.com/repos/nylas/sync-engine/git/commits/a6e8e01bf426b7b335f9d5b9597770749ae9fac8,a6e8e01bf426b7b335f9d5b9597770749ae9fac8,"Handle absent actionlog entries in update_message_metadata.

Test Plan: Unit test added.

Reviewers: kav-ya

Reviewed By: kav-ya

Differential Revision: https://phab.nylas.com/D2552"
kav-ya,2016-01-29 22:45:47,https://api.github.com/repos/nylas/sync-engine/git/commits/9e27b2e725beb10487ddd018a5c2f2012fc35946,9e27b2e725beb10487ddd018a5c2f2012fc35946,"[SCHEMA] Introduce AccountTransaction table.

Summary:
Fixes T5980.

Account object events are recorded in this table in addition to the Transaction table.

The former is to maintain a total ordering over all events for an account;
the latter is to simplify the expensive query by the Webhook service.

NOTE:
I considered writing the back-population script such that AccountTransaction records
are created for existing accounts linked to a webhook-enabled app only to begin with,
but do not think it's worth the complexity it might add later (-- ""why are these accounts
missing AccountTransaction records""?).

Test Plan: Tests added.

Reviewers: emfree

Reviewed By: emfree

Maniphest Tasks: T6617, T5980

Differential Revision: https://phab.nylas.com/D2528"
emfree,2016-02-05 21:56:25,https://api.github.com/repos/nylas/sync-engine/git/commits/0f8fcef91c3ab9f9aaf6a6362a7469ae758c5a84,0f8fcef91c3ab9f9aaf6a6362a7469ae758c5a84,"Set connect_timeout on database connections.

Summary:
Otherwise, an attempt to instantiate a database connection may block the event
loop forever if the database server is unresponsive.

Test Plan:
Can verify by enabling the discard protocol on port 9 and running
the following script.

```
from gevent.monkey import patch_all
patch_all()
import gevent

from nylas.logging import configure_logging
from inbox.ignition import engine
from inbox.instrumentation import GreenletTracer
configure_logging()

tr = GreenletTracer()
tr.start()

def func():
    # All data to port 9 gets discarded.
    eng = engine('test', 'mysql+mysqldb://user:pass@127.0.0.1:9')
    eng.execute('SELECT 1').fetchall()

g = gevent.spawn(func)
g.join()
```

Reviewers: spang

Reviewed By: spang

Differential Revision: https://phab.nylas.com/D2538"
kav-ya,2016-02-08 18:20:34,https://api.github.com/repos/nylas/sync-engine/git/commits/ef794fd64fe89629e1777d966e660b394e37acca,ef794fd64fe89629e1777d966e660b394e37acca,"Update GenericAccount migration to use a single DDL statement.

Summary: Use a single ALTER table, which causes a table-copy, rather than six.

Test Plan: Tested locally.

Reviewers: logan

Reviewed By: logan

Differential Revision: https://phab.nylas.com/D2541"
grinich,2016-02-08 05:16:26,https://api.github.com/repos/nylas/sync-engine/git/commits/69fceff02c803045d9afc0a5625b03e1d791e35c,69fceff02c803045d9afc0a5625b03e1d791e35c,Add build status to readme
grinich,2016-02-07 03:54:19,https://api.github.com/repos/nylas/sync-engine/git/commits/6eac90c406a891609304251198fafa13acd3b4af,6eac90c406a891609304251198fafa13acd3b4af,"update vm box to ubuntu/precise64

closes #249"
khamidou,2016-02-05 17:38:06,https://api.github.com/repos/nylas/sync-engine/git/commits/bc0bae3cda635bb387b34577b87475813f9291bf,bc0bae3cda635bb387b34577b87475813f9291bf,"Merge pull request #257 from mbilker/patch-1

Fix Github Markdown use in README."
mbilker,2016-02-05 00:43:46,https://api.github.com/repos/nylas/sync-engine/git/commits/ceb75bd585a0d3c0602e7c36ebcd73fc51a1536b,ceb75bd585a0d3c0602e7c36ebcd73fc51a1536b,"Correct GLFM usage for shell command

This PR corrects the explicit syntax highlighting.

_(I felt this PR did not need much more explanation)_"
kav-ya,2016-02-04 01:26:59,https://api.github.com/repos/nylas/sync-engine/git/commits/89f243c736e9299111e1b41471e7b78bda853460,89f243c736e9299111e1b41471e7b78bda853460,Include populate-imap-smtp-credentials script in setup.py
kav-ya,2016-02-04 00:51:26,https://api.github.com/repos/nylas/sync-engine/git/commits/11fc7d8cfd50d58e86e100792ce0ef67c2a568a3,11fc7d8cfd50d58e86e100792ce0ef67c2a568a3,"Use shard-specific foreign key columns.

Summary: `Namespace.id`, `Secret.id` in shard 0 is of type INT(11) not BIGINT(20).

Test Plan: Run against staging.

Reviewers: emfree

Differential Revision: https://phab.nylas.com/D2517"
emfree,2016-02-04 01:11:39,https://api.github.com/repos/nylas/sync-engine/git/commits/0882b1c48781d94fc78a6a4998380bba26191efa,0882b1c48781d94fc78a6a4998380bba26191efa,"Replace potentially expensive COUNT with EXISTS.

Test Plan: Unit tests; run events sync.

Reviewers: ethanb

Reviewed By: ethanb

Differential Revision: https://phab.nylas.com/D2519"
emfree,2016-02-03 23:49:49,https://api.github.com/repos/nylas/sync-engine/git/commits/059389b3ecb4d2c2c882ba8ee057fc20a2abbdef,059389b3ecb4d2c2c882ba8ee057fc20a2abbdef,Simplify syncback query.
kav-ya,2016-02-04 00:39:42,https://api.github.com/repos/nylas/sync-engine/git/commits/a2a6cab5a5a8c08ed9f92698f9cd3f116b090e1a,a2a6cab5a5a8c08ed9f92698f9cd3f116b090e1a,Re-order migrations.
kav-ya,2016-02-03 23:33:47,https://api.github.com/repos/nylas/sync-engine/git/commits/5e2860bf005658061f9ead24b152b3346a03734a,5e2860bf005658061f9ead24b152b3346a03734a,Fix migration version.
logandavis,2016-02-03 20:22:56,https://api.github.com/repos/nylas/sync-engine/git/commits/269709d7e3737f439c2cbec7b46dd8669fd60b54,269709d7e3737f439c2cbec7b46dd8669fd60b54,"[SCHEMA] Enable auth for accounts with different IMAP/SMTP credentials

Summary:
Previously, while the signup process asked for SMTP and IMAP usernames
and passwords, that information wasn't actually used or stored. As a
result, accounts with IMAP or SMTP usernames different from their
email addresses could neither sync nor send mail, and accounts
with different IMAP and SMTP passwords would fail to authenticate with
providers using the Nylas API.

Now the genericaccount database has four new fields: imap_username,
smtp_username, imap_password_id, and smtp_password_id. Where
possible, these fields are used for authentication. By default,
they are duplicates of the existing _raw_address and
password_id fields (the latter of which is no longer used for
anything and can be removed in a future migration, though it's still
around in this one, because we don't want to risk deleting the password
IDs juuuuuust yet.).

Tests for authentication with these custom accounts have been improved
and in some cases added from scratch.

Fixes T997
Depends on a commit in the redwood repo with the same name.

Test Plan:
Tested migration locally and manually authorized an account
with the right IMAP/SMTP credentials. Ran all sync-engine tests,
including some new ones - all passed.

Reviewers: khamidou, kav-ya

Reviewed By: kav-ya

Subscribers: emfree

Maniphest Tasks: T997

Differential Revision: https://phab.nylas.com/D2493"
emfree,2016-02-03 20:01:57,https://api.github.com/repos/nylas/sync-engine/git/commits/3da9135713c7fb37879c489571900bed744e6166,3da9135713c7fb37879c489571900bed744e6166,"Configure autoincrements in metadata migration; remove unused index.

Summary:
This is one downside of the sharding scheme that is not (yet) programmatically
addressed. If a migration script adds a table, it needs to also configure the
table's shard-dependent autoincrement. Otherwise metadata rows inserted into
different shards will end up with overlapping primary keys.

Update migration 212 to handle this. Also remove creation of an index on
`app_public_id`; looks like this column doesn't actually exist.

Test Plan: Run migration locally against shards.

Reviewers: drew

Reviewed By: drew

Differential Revision: https://phab.nylas.com/D2512"
emfree,2016-02-03 01:35:06,https://api.github.com/repos/nylas/sync-engine/git/commits/be72ca0eabfb778f4fca35d972a66c24bd05bf80,be72ca0eabfb778f4fca35d972a66c24bd05bf80,"Fix direction of reply_to_message relationship.

Fixes T2507."
khamidou,2016-02-03 17:25:42,https://api.github.com/repos/nylas/sync-engine/git/commits/cc50898ee39126437589ecd64d8c8c3d8ad8acd3,cc50898ee39126437589ecd64d8c8c3d8ad8acd3,add another GAFYD but actually Exchange provider.
khamidou,2016-02-03 00:58:42,https://api.github.com/repos/nylas/sync-engine/git/commits/9ece788d6baa50739e8bb7776d4492245b02f552,9ece788d6baa50739e8bb7776d4492245b02f552,handle folders with no names.
dregitsky,2016-02-02 23:44:52,https://api.github.com/repos/nylas/sync-engine/git/commits/fe3826621a2f29ba36347123f30f35650422638a,fe3826621a2f29ba36347123f30f35650422638a,"Add metadata store

Summary:
Adds a metadata store capable of storing arbitrary JSON against
API objects.

Includes a new database table for Metadata and some minor changes
to accommodate it. Alters the delta API to exclude metadata by
default, and uses a new param `exclude_metadata=False` to include it.
The API for all other access to metadata will live in Redwood.

Note that Metadata entries will remain even if the API object they are
tied to is deleted.

Also note, the new Metadata table contains columns with data about
`Application` objects, which reside in a different database and are
defined outside this repo, in Redwood.

D2468 contains tests for this diff and requires it to run.

Test Plan: New tests in redwood

Reviewers: kav-ya, emfree

Reviewed By: kav-ya, emfree

Subscribers: bengotow

Differential Revision: https://phab.nylas.com/D2467"
emfree,2016-02-02 19:25:06,https://api.github.com/repos/nylas/sync-engine/git/commits/13b27378b716c0226d2f3273d99ffbacf8736c9b,13b27378b716c0226d2f3273d99ffbacf8736c9b,"Set the \\Seen flag when saving sent messages to the IMAP server.

Fixes T6613."
khamidou,2016-02-02 17:52:38,https://api.github.com/repos/nylas/sync-engine/git/commits/1e446ad97f6a1c47cc2d6574e7ea94a1b5ccb180,1e446ad97f6a1c47cc2d6574e7ea94a1b5ccb180,fix vagrant box URL
khamidou,2016-01-30 00:25:38,https://api.github.com/repos/nylas/sync-engine/git/commits/56f297d32ae2a58caaad8a0cf16fdf418090f8cb,56f297d32ae2a58caaad8a0cf16fdf418090f8cb,"Apparently, vobject 0.8.1c doesn't exist anymore --- user 0.8.2
Context: https://github.com/eventable/vobject/issues/2"
khamidou,2016-01-30 00:24:59,https://api.github.com/repos/nylas/sync-engine/git/commits/2c9e777fc31a31d6c4eb2fd55b20d57c0613edbb,2c9e777fc31a31d6c4eb2fd55b20d57c0613edbb,Skip non-existing folders.
khamidou,2016-01-29 18:17:20,https://api.github.com/repos/nylas/sync-engine/git/commits/742b908e484e310e973fce192cac71ed5ecb64eb,742b908e484e310e973fce192cac71ed5ecb64eb,add utf-7 backfix scripts to setup.py.
khamidou,2016-01-29 17:55:08,https://api.github.com/repos/nylas/sync-engine/git/commits/5175ac9d9316253986fac5bee2e5e12b6e234b06,5175ac9d9316253986fac5bee2e5e12b6e234b06,"A script to backfix IMAP UTF-7 labels

Summary:
Because of a bug in IMAPClient, we have 400 production accounts with duplicate, badly-encoded labels (https://github.com/nylas/sync-engine/issues/212).
The bug has since been fixed, but the badly-encoded labels still show up even though they've been marked as deleted because the sync-engine still sees messages with those labels.

This script fixes this by going through the list of accounts, finding such labels and refreshing the flags for those. The messages then get affected to the correct labels, which cause the bad labels to be GCed.

Test Plan: Tested locally and on staging.

Reviewers: emfree

Reviewed By: emfree

Differential Revision: https://phab.nylas.com/D2484"
logandavis,2016-01-23 00:28:32,https://api.github.com/repos/nylas/sync-engine/git/commits/fa7daa2f885e1521f6cd38d7549b6e0c6c97ef55,fa7daa2f885e1521f6cd38d7549b6e0c6c97ef55,"Fix unicode handling for event queries, add unicode tests

Summary:
Previously, event queries for unicode characters were failing, even
though events could have unicode characters in their titles,
descriptions, and locations. This was due to Python 2's str.format()
throwing a UnicodeEncodeError when trying to insert unicode characters
into string literals that were incorrectly not explicitly defined
as unicode. The literals are now explicitly defined as unicode,
and a regression test is in place.

This is a pretty common error in Python 2 Unicode handling. Recommend
that future tests begin including unicode characters in user input
fields to make sure that the backend won't have encoding errors.

Test Plan: Ran all of the API tests with pytests; nothing broke.

Reviewers: emfree

Reviewed By: emfree

Maniphest Tasks: T1036

Differential Revision: https://phab.nylas.com/D2466"
emfree,2016-01-22 22:47:59,https://api.github.com/repos/nylas/sync-engine/git/commits/2ed2f8905bb8eb4f5b036760b08d0ed2e58daf7f,2ed2f8905bb8eb4f5b036760b08d0ed2e58daf7f,Set sane lock wait timeout value in alembic migrations.
khamidou,2016-01-21 22:48:58,https://api.github.com/repos/nylas/sync-engine/git/commits/e22f94c38456781bb5984cf92632f65cc6546615,e22f94c38456781bb5984cf92632f65cc6546615,add another Exchange provider.
emfree,2016-01-20 21:55:05,https://api.github.com/repos/nylas/sync-engine/git/commits/d18810ad42484ecfb9c2d0eeb0ecbc5ece730d2d,d18810ad42484ecfb9c2d0eeb0ecbc5ece730d2d,"Do not install pip 8.

Pip 8 appears to break things."
khamidou,2016-01-20 21:44:28,https://api.github.com/repos/nylas/sync-engine/git/commits/dd2fcc740c643a58c3fb0bda04a591b46f29d8ff,dd2fcc740c643a58c3fb0bda04a591b46f29d8ff,"Handle label renames

Summary:
Hopefully this is the last iteration of this diff. This is sensibly the same diff as D2389, rebased upon the latest master.

This diff fixes the old label renaming code by:
- fixing the consistency bug you found (there was a loop variable which wasn't used correctly)
- making it compatible with ImapClient 1.0
    using a semaphore to limit the number of greenlets running for a single account (the value is currently conservatively set to 1).
- handling label renames during the initial sync
- chunking metadata updates. That is, we're not sending a list of 5000 flags to `update_metadata` --- the changes are in batches of 500 elements.

Known limitations:
- if a label rename operation is interrupted mid-way, it won't be restarted.
- it looks like a Gmail search bug when looking for chinese labels. I'm not sure if it's a Gmail or an ImapClient problem.

Test Plan: Tested manually + added a regression test. I tested that the code handled correctly renaming a label with 5000 elements in it.

Reviewers: emfree

Reviewed By: emfree

Differential Revision: https://phab.nylas.com/D2435"
emfree,2016-01-20 00:02:57,https://api.github.com/repos/nylas/sync-engine/git/commits/e8c36a719bf40766340b4981afd05fd15507129b,e8c36a719bf40766340b4981afd05fd15507129b,Add zone to config-test-prod.
emfree,2016-01-19 23:56:07,https://api.github.com/repos/nylas/sync-engine/git/commits/18e88655c7445edd30f6fb0304de2119a8cce5d2,18e88655c7445edd30f6fb0304de2119a8cce5d2,"Wrap monitoring thread with retry logic.

Otherwise metrics may silently become stale."
emfree,2016-01-19 05:40:11,https://api.github.com/repos/nylas/sync-engine/git/commits/0a1df7325c03db01819e793c18489cd4a4044de6,0a1df7325c03db01819e793c18489cd4a4044de6,Fix typo in folder sync state check.
emfree,2016-01-19 04:54:47,https://api.github.com/repos/nylas/sync-engine/git/commits/035946466fd28fd5ef864038a57940f8bd1f0250,035946466fd28fd5ef864038a57940f8bd1f0250,Fix typos; make bin/inbox-start populate sync queue in dev mode.
emfree,2016-01-19 04:45:40,https://api.github.com/repos/nylas/sync-engine/git/commits/1d2bcda5526dcc9ec6ce1358d66200485128d446,1d2bcda5526dcc9ec6ce1358d66200485128d446,Remove stale imports.
emfree,2016-01-19 01:19:35,https://api.github.com/repos/nylas/sync-engine/git/commits/b8e8e60dbd3dd1d5db8e5c3826a304419e597044,b8e8e60dbd3dd1d5db8e5c3826a304419e597044,"Use Redis queueing mechanism for sync scheduling.

Summary:
In order to promptly schedule account syncs without needing to worry about
database write contention, or read volume growing proportionally to (shard
count) x (process count), replace the previous scheduling mechanism with a
Redis-backed queue. Details are described in inbox/scheduling/queue.py.
Essentially, we run a standalone `QueuePopulator`, which transfers account ids
from the database into a queue. Sync processes then pull from this queue and
atomically claim ownership of accounts by updating a Redis hash. This
functionally replaces the old `account.sync_host` column. Although we keep
writing to that column for now, so that existing reporting continues to work,
and so that a rollback is easy.

Test Plan: Unit tests in tests/scheduling/test_sync_start_logic.py.

Reviewers: kav-ya

Differential Revision: https://phab.nylas.com/D2447"
emfree,2016-01-16 23:28:29,https://api.github.com/repos/nylas/sync-engine/git/commits/38dbb7dd0a765c2b8faaade8e3397901bf8dc58e,38dbb7dd0a765c2b8faaade8e3397901bf8dc58e,"Clean up sync-stopping logic.

* Sync greenlets are now synchronously killed within the scope of
  MailsyncService.stop_sync.
* Posting to the process's /unassign endpoint calls MailsyncService.stop_sync,
  removing potential for races.
* Heartbeats are only cleared when the account.sync_should_run bit becomes
  False, preventing an account from being wrongly reported as dead if it's
  rescheduled.
* A variety of related crufty code is removed."
emfree,2016-01-13 22:42:23,https://api.github.com/repos/nylas/sync-engine/git/commits/9c0faa932a9b34dfc1cfc799d3fc6fae48052358,9c0faa932a9b34dfc1cfc799d3fc6fae48052358,Return 200 not 402 on partial send for now to prevent bad client retrying
emfree,2016-01-13 21:32:17,https://api.github.com/repos/nylas/sync-engine/git/commits/2eb291fb7bc35720508dceca3e747d9dc81ca184,2eb291fb7bc35720508dceca3e747d9dc81ca184,Better handle shard unavailability while starting syncs.
emfree,2016-01-15 18:33:22,https://api.github.com/repos/nylas/sync-engine/git/commits/b7da19d0ccdc1e12269424ac5462a79c7fa96b1b,b7da19d0ccdc1e12269424ac5462a79c7fa96b1b,"Revert ""Rework account scheduling (part 4): Remove 'cpu_id' constraint.""

This reverts commit 7bdf9646e57ee9eca5d0b7ae0ea776ea5b556715.

Reason for rollback: produces update contention under high load."
emfree,2016-01-15 18:33:20,https://api.github.com/repos/nylas/sync-engine/git/commits/2b8c6c34924c6c5d6da6820f79e1c1327d5f7010,2b8c6c34924c6c5d6da6820f79e1c1327d5f7010,"Revert ""Replace sync-host-to-shard affinity with 'zone' configuration.""

This reverts commit dada1e438c5496d8dba9fcc023698285c95237e7."
khamidou,2016-01-15 17:30:29,https://api.github.com/repos/nylas/sync-engine/git/commits/aa6c96aad910c59ca5598d8eb0390e8caa0a1f6e,aa6c96aad910c59ca5598d8eb0390e8caa0a1f6e,A small tool to stamp multiple shards at once.
khamidou,2016-01-15 02:29:01,https://api.github.com/repos/nylas/sync-engine/git/commits/f99a4abcf9ca44f4a656b452d990d65e1d71a16d,f99a4abcf9ca44f4a656b452d990d65e1d71a16d,"Fix a variety of iCalendar parsing bugs

Summary:
This diff fixes three things:
- We were creating events with an owner field of the form ""None <None>"" (https://sentry.nylas.com/sentry/API-Prod/group/9165/).
- We weren't formatting the owner field correctly. Legitimate addresses like `""George Bush, Jr."" <gbjr@gmail.com>` would be serialized as `George Bush, Jr. <gbjr@gmail.com>` (without quotes), breaking RSVP sending.
- We weren't including the organizer field in RSVP replies

Test Plan: Wrote a regression test. Checked that RSVPing weird addresses worked.

Reviewers: spang, emfree

Reviewed By: emfree

Differential Revision: https://phab.nylas.com/D2438"
emfree,2016-01-13 15:07:07,https://api.github.com/repos/nylas/sync-engine/git/commits/eb7aaf6d44dde013e68f8ba4f22820515526765a,eb7aaf6d44dde013e68f8ba4f22820515526765a,Support configurable poll interval in streaming API.
emfree,2016-01-13 01:44:06,https://api.github.com/repos/nylas/sync-engine/git/commits/3efe2a5f16b857e1c7d1653619a6e9434d4e3808,3efe2a5f16b857e1c7d1653619a6e9434d4e3808,Make gauge name consistent with others.
emfree,2016-01-13 00:35:46,https://api.github.com/repos/nylas/sync-engine/git/commits/afdab961815fe498bfff4322e007597619cfdcac,afdab961815fe498bfff4322e007597619cfdcac,Publish number of accounts being synced as statsd gauge.
emfree,2016-01-12 18:15:01,https://api.github.com/repos/nylas/sync-engine/git/commits/dada1e438c5496d8dba9fcc023698285c95237e7,dada1e438c5496d8dba9fcc023698285c95237e7,"Replace sync-host-to-shard affinity with 'zone' configuration.

Summary:
We no longer need or want to impose the constraint that ""accounts on shard 1
should only be synced by host A"". But it is useful to say ""accounts on shards
in us-west-2b should only be synced by hosts in us-west-2b"", for example. This
patch introduces configuration support for that. Specifically, read a 'ZONE'
value from the configuration of a sync host. If configured, that host will only
claim account syncs from shards that reside in the same zone.

Test Plan: Unit tests updated.

Reviewers: kav-ya

Reviewed By: kav-ya

Differential Revision: https://phab.nylas.com/D2429"
emfree,2016-01-12 05:08:06,https://api.github.com/repos/nylas/sync-engine/git/commits/f2607a055718763d90cb87734d3288f4bbf7a7a1,f2607a055718763d90cb87734d3288f4bbf7a7a1,"Ensure database load bypass doesn't miss rapid expunges.

This fixes an unlikely but possible issue with the previous commit. We rely on
the flags fetch result to detect expunges. A UID which is synced but then very
quickly deleted on the remote may never show up in the flags fetch response.
Ensure we still detect the expunge by also checking if the set of local UIDs
has changed."
emfree,2016-01-12 00:47:41,https://api.github.com/repos/nylas/sync-engine/git/commits/c0007289052c8dce98cf4dcbdd7fbaebda9cc74a,c0007289052c8dce98cf4dcbdd7fbaebda9cc74a,"Bypass database loads on unchanged IMAP flags refresh.

Flag refreshes for generic IMAP folders still account for a depressingly large
fraction of overall workload. But some optimization is possible. If a flags
fetch response is exactly the same as the last one we got from the server, then
there are no changes to commit, and so we don't need to issue any (potentially
expensive) database loads."
khamidou,2016-01-12 01:10:12,https://api.github.com/repos/nylas/sync-engine/git/commits/6674f6951a7d5c2e24c416144b817b5d5feb8add,6674f6951a7d5c2e24c416144b817b5d5feb8add,forgot inline import
khamidou,2016-01-12 01:09:12,https://api.github.com/repos/nylas/sync-engine/git/commits/60e89dafc8c702c752b352283e593ce2231cd8e7,60e89dafc8c702c752b352283e593ce2231cd8e7,remove import making test fail on jenkins.
khamidou,2016-01-12 00:20:19,https://api.github.com/repos/nylas/sync-engine/git/commits/c5aff24e01e3c2cccc58757317958a93aa92b8b7,c5aff24e01e3c2cccc58757317958a93aa92b8b7,"Various fixes to the iCalendar invite merging code.

Summary:
This diff fixes a couple problems with the way we process iCalendar invites. The main one being that we're discarding self-sent iCalendar invites on the basis that it would confuse people. I reverted this and made some changes to the RSVP code to prevent it from breaking.

As a bonus, we're now able to RSVP correctly to invites sent by iCloud and other meeting scheduling apps.

Test Plan:
Tested manually by:
1. Creating an event in the Outlook calendar and sending an invite to another email account. Checked that two events were created --- 1. in the ""Emailed events"" calendar and the other in the regular calendar.

I also wrote a regression test to test for this specific case.

Reviewers: emfree

Reviewed By: emfree

Differential Revision: https://phab.nylas.com/D2428"
emfree,2016-01-11 23:00:12,https://api.github.com/repos/nylas/sync-engine/git/commits/7bdf9646e57ee9eca5d0b7ae0ea776ea5b556715,7bdf9646e57ee9eca5d0b7ae0ea776ea5b556715,"Rework account scheduling (part 4): Remove 'cpu_id' constraint.

Summary:
This patch completes the transition to the new use of 'sync_host'. A sync
process may now claim any available account sync.

Test Plan: unit tests updated.

Reviewers: kav-ya

Reviewed By: kav-ya

Differential Revision: https://phab.nylas.com/D2426"
emfree,2016-01-11 21:53:18,https://api.github.com/repos/nylas/sync-engine/git/commits/c7051dbab47189c4e35dba6e486c9c486b4defa2,c7051dbab47189c4e35dba6e486c9c486b4defa2,"Bump mysqlclient version for faster datetime parsing.

See https://github.com/PyMySQL/mysqlclient-python/blob/master/HISTORY"
emfree,2016-01-11 20:06:15,https://api.github.com/repos/nylas/sync-engine/git/commits/77feac4f483315ebb3a35e5c2c0e983b30f56248,77feac4f483315ebb3a35e5c2c0e983b30f56248,"Ensure changes to message categories create revisions.

Fixes T6330."
spang,2016-01-11 19:41:30,https://api.github.com/repos/nylas/sync-engine/git/commits/4c9d8196bc81bafbb93ab7d1ca72ee080a245df8,4c9d8196bc81bafbb93ab7d1ca72ee080a245df8,Support blocks and parts in get-*
spang,2016-01-11 19:30:58,https://api.github.com/repos/nylas/sync-engine/git/commits/e17b41d1fcd223d3e4ae64176d0554d378920007,e17b41d1fcd223d3e4ae64176d0554d378920007,"Use global session in bin/get-*

These scripts have been broken since the sharding patches were merged."
emfree,2016-01-09 00:21:13,https://api.github.com/repos/nylas/sync-engine/git/commits/7266c52d949f32d04e845894452d70c4a37816a6,7266c52d949f32d04e845894452d70c4a37816a6,Fix occasional LoopExit in monitoring thread.
khamidou,2016-01-11 16:57:22,https://api.github.com/repos/nylas/sync-engine/git/commits/bd7e6f1d0d3ac6ab1c6ac6ceec9867d2a6b89e6e,bd7e6f1d0d3ac6ab1c6ac6ceec9867d2a6b89e6e,"stsci.edu uses Exchange, not GAFYD."
emfree,2016-01-08 19:18:51,https://api.github.com/repos/nylas/sync-engine/git/commits/7bab095e17f0da1edf44ce5ad7c4224fa8ce40af,7bab095e17f0da1edf44ce5ad7c4224fa8ce40af,"Fix folder canonical name assignment.

If you start out syncing an IMAP folder with no special role, and then the
provider later adds, say, the \\Junk flag to it, we now correctly update the
folder's canonical_name attribute rather than raising an exception. (This is
similar to 9500d5c5.)"
emfree,2016-01-08 03:07:58,https://api.github.com/repos/nylas/sync-engine/git/commits/6c5657daadc443e50bb7955057d00f37d330e1ba,6c5657daadc443e50bb7955057d00f37d330e1ba,Add new script in setup.py.
emfree,2016-01-07 22:30:57,https://api.github.com/repos/nylas/sync-engine/git/commits/c4e5fb0267eb9847d4946b01e258c88ab62a8540,c4e5fb0267eb9847d4946b01e258c88ab62a8540,"Rework account scheduling (part 3): Support programmatic rebalancing.

Add an ""unassign"" endpoint to the sync process's HTTP frontend. This endpoint
takes an account id and tells the process to stop syncing it.

In subsequent patches, we can:
* Implement an automated rebalancing service
* Change the sync-claiming logic such that less loaded processes claim more
  easily.

Test Plan: Unit tests added; manual testing of instrumentation."
emfree,2016-01-06 20:32:39,https://api.github.com/repos/nylas/sync-engine/git/commits/01e05599b209621f3bbf7727e61114144ccbb83c,01e05599b209621f3bbf7727e61114144ccbb83c,"Rework account scheduling (part 2): Restructure process instrumentation.

Summary:
* Expose process CPU average in addition to pending-greenlet averages. We'll
  start with those two numbers for load balancing.
* Restructure process instrumentation code. We'll build on this code to add an
  interface that supports programmatically reassigning accounts.

Test Plan: Manual testing of instrumentation.

Reviewers: kav-ya

Differential Revision: https://phab.nylas.com/D2417"
emfree,2016-01-05 23:56:10,https://api.github.com/repos/nylas/sync-engine/git/commits/e673afcdb7212f26b97702511dc8b1f492c34387,e673afcdb7212f26b97702511dc8b1f492c34387,"Rework account scheduling (part 1): Allow process specification.

Summary:
Allow accounts to be scheduled to run on a particular process, rather than
merely on a particular host. This is done by specifying
`account.sync_host = ""<hostname>:<process number>""`.

For the moment, we support both this, as well as the prior method for
specifying an account's sync host. This way we can transition smoothly or roll
back easily.

Also remove host-local account ""sync locking"". This is essentially useless, but
can break sync if an account is unscheduled, then rescheduled on the same
process.

Test Plan: Unit tests updated.

Reviewers: spang

Reviewed By: spang

Differential Revision: https://phab.nylas.com/D2244"
kav-ya,2016-01-08 01:21:01,https://api.github.com/repos/nylas/sync-engine/git/commits/6ef46b897225e4cdf5201032a9df6e478ffd277e,6ef46b897225e4cdf5201032a9df6e478ffd277e,In both tests.
kav-ya,2016-01-07 21:46:29,https://api.github.com/repos/nylas/sync-engine/git/commits/b549b63a55cc40627b80d637337c45a78aa9e010,b549b63a55cc40627b80d637337c45a78aa9e010,"Use gevent.joinall() to ensure connections checked out by the tests are
returned to the pool in a good state."
emfree,2016-01-07 21:13:15,https://api.github.com/repos/nylas/sync-engine/git/commits/391cc7963caae9337ac324fcfb25cbfa8802e148,391cc7963caae9337ac324fcfb25cbfa8802e148,Bump nylas-production-python dependency.
kav-ya,2016-01-07 19:51:17,https://api.github.com/repos/nylas/sync-engine/git/commits/04c8e54055d5aca2e1cd480e65d6a769421bcff7,04c8e54055d5aca2e1cd480e65d6a769421bcff7,Update script params.
kav-ya,2016-01-07 19:20:16,https://api.github.com/repos/nylas/sync-engine/git/commits/319fa5fd4d0320e0fd95817d502b84d664d15e78,319fa5fd4d0320e0fd95817d502b84d664d15e78,Update syncback scheduling tests to be deterministic.
kav-ya,2016-01-06 00:00:58,https://api.github.com/repos/nylas/sync-engine/git/commits/e46dec15a21fd89d78b7c3a36b28f96e8f61238f,e46dec15a21fd89d78b7c3a36b28f96e8f61238f,"Run the SyncbackService independantly of Account.sync_host

Summary:
This revision adds support for running multiple SyncbackService processes on a host
and introduces a scheme independant of the host to distribute accounts (to perform syncback for) across them.

The existing scheme -- one SyncbackService per sync host, and account selection based on the Account.sync_host --
is no longer suitable;  we want to be able to dynamically move account syncs between the different hosts
without interfering with syncback.

Test Plan:
Unit tests added, minimal manual testing.
Will test against staging.

Reviewers: emfree

Reviewed By: emfree

Differential Revision: https://phab.nylas.com/D2414"
emfree,2016-01-06 22:16:25,https://api.github.com/repos/nylas/sync-engine/git/commits/e5a67f580868570b48275589a6ec8419e5c916d1,e5a67f580868570b48275589a6ec8419e5c916d1,"Remove unused override_uids association proxy.

Funny stuff can happen on object instantiation of an association proxy is
declared without a creator lambda. But we're not actually using this
association proxy for anything, so simply remove it."
emfree,2016-01-06 02:31:28,https://api.github.com/repos/nylas/sync-engine/git/commits/638c105339a6f82c3c6bef6d1d595d0f728b73b3,638c105339a6f82c3c6bef6d1d595d0f728b73b3,Correctly handle missing ICS sequence number by defaulting to zero.
emfree,2016-01-06 02:19:59,https://api.github.com/repos/nylas/sync-engine/git/commits/5bd66470889d4f17c7e443c230197778ccd53212,5bd66470889d4f17c7e443c230197778ccd53212,"Revert ""Call SQLAlchemy's bake_lazy_loaders() for performance.""

This reverts commit 434abc07a2eea63331be2ae1f85e905ff29ecc55.

Reason for rollback: Breaks certain uses of `global_session_scope()`. Ho hum."
emfree,2016-01-06 00:40:20,https://api.github.com/repos/nylas/sync-engine/git/commits/434abc07a2eea63331be2ae1f85e905ff29ecc55,434abc07a2eea63331be2ae1f85e905ff29ecc55,Call SQLAlchemy's bake_lazy_loaders() for performance.
emfree,2016-01-04 19:16:18,https://api.github.com/repos/nylas/sync-engine/git/commits/22545a8a37f9cecc7cad99f99b1fc5a474c84ec6,22545a8a37f9cecc7cad99f99b1fc5a474c84ec6,Publish gevent loadavgs as statsd gauges.
emfree,2016-01-05 19:08:17,https://api.github.com/repos/nylas/sync-engine/git/commits/a7049136873d346c92bd1efeceda7251a7829e99,a7049136873d346c92bd1efeceda7251a7829e99,Fix deletion of folder objects without associated categories.
kav-ya,2016-01-05 01:32:44,https://api.github.com/repos/nylas/sync-engine/git/commits/7cce697c8ee9430f70660d6ba1ed6da3a85a644b,7cce697c8ee9430f70660d6ba1ed6da3a85a644b,"Strip legacy Gmail label prefixes.
Fixes T6329."
emfree,2016-01-04 09:47:14,https://api.github.com/repos/nylas/sync-engine/git/commits/7725881f5ec9583a15836d0d36b76669aa0b0a8e,7725881f5ec9583a15836d0d36b76669aa0b0a8e,Fix typo.
emfree,2016-01-04 09:17:39,https://api.github.com/repos/nylas/sync-engine/git/commits/8a3211d8f854fb477233ebfc89ff8fde8887d6a2,8a3211d8f854fb477233ebfc89ff8fde8887d6a2,"Use flask.stream_with_context in streaming API.

This keeps the request context around, so teardown_request handlers are
called only when the response terminates."
emfree,2015-12-31 08:08:17,https://api.github.com/repos/nylas/sync-engine/git/commits/f4aab74c32ea650ebf8c37a75f657238d3ebb49e,f4aab74c32ea650ebf8c37a75f657238d3ebb49e,"Constrain drafts to only messages in a drafts folder

Summary:
This excludes, for example, drafts that have been moved to a trash folder from
being marked as legitimate drafts. Some IMAP clients will do that when
deleting drafts (notably Apple Mail).

Includes changes to test fixture semantics for greater consistency.

Fixes T5696.

Test Plan: Unit tests added.

Reviewers: kav-ya

Maniphest Tasks: T5696

Differential Revision: https://phab.nylas.com/D2405"
emfree,2015-12-31 02:10:31,https://api.github.com/repos/nylas/sync-engine/git/commits/b2ed8518faed15a5647ed9da2de107cf0b2da298,b2ed8518faed15a5647ed9da2de107cf0b2da298,Simplify IMAP folder sync start logic.
emfree,2015-12-31 07:25:25,https://api.github.com/repos/nylas/sync-engine/git/commits/8dcedd052791b119a3728872d1cc01cba9dfd7aa,8dcedd052791b119a3728872d1cc01cba9dfd7aa,"Remove deprecated noload in custom threading.

This was originally added as a performance optimization, but is no longer
necessary, as an eager load of Message.namespace is no longer applied.
Declaring `noload('namespace')` causes problems with latest SQLAlchemy, because
it results in `message.namespace` becoming `None` and therefore interfering
with revision creation (trace:

```
Stacktrace (most recent call last):

  File ""inbox/util/concurrency.py"", line 46, in wrapped
    return func(*args, **kwargs)
  File ""inbox/mailsync/backends/imap/generic.py"", line 184, in _run_impl
    self.state = self.state_handlers[old_state]()
  File ""inbox/util/concurrency.py"", line 46, in wrapped
    return func(*args, **kwargs)
  File ""inbox/mailsync/backends/imap/generic.py"", line 290, in poll
    self.poll_impl()
  File ""inbox/mailsync/backends/imap/generic.py"", line 358, in poll_impl
    self.check_uid_changes(crispin_client)
  File ""inbox/mailsync/backends/imap/generic.py"", line 697, in check_uid_changes
    self.get_new_uids(crispin_client)
  File ""inbox/mailsync/backends/imap/generic.py"", line 593, in get_new_uids
    self.download_and_commit_uids(crispin_client, [uid])
  File ""inbox/mailsync/backends/imap/generic.py"", line 506, in download_and_commit_uids
    folder, msg)
  File ""inbox/mailsync/backends/imap/generic.py"", line 438, in create_message
    db_session.flush()
  File ""sqlalchemy/orm/session.py"", line 2027, in flush
    self._flush(objects)
  File ""sqlalchemy/orm/session.py"", line 2145, in _flush
    transaction.rollback(_capture_exception=True)
  File ""sqlalchemy/util/langhelpers.py"", line 60, in __exit__
    compat.reraise(exc_type, exc_value, exc_tb)
  File ""sqlalchemy/orm/session.py"", line 2113, in _flush
    self.dispatch.after_flush(self, flush_context)
  File ""sqlalchemy/event/attr.py"", line 256, in __call__
    fn(*args, **kw)
  File ""inbox/models/session.py"", line 100, in after_flush
    create_revisions(session)
  File ""inbox/models/transaction.py"", line 52, in create_revisions
    create_revision(obj, session, 'update')
  File ""inbox/models/transaction.py"", line 62, in create_revision
    namespace_id=obj.namespace.id)
```
)"
kav-ya,2015-12-29 22:36:31,https://api.github.com/repos/nylas/sync-engine/git/commits/0497350166f7bbeca0fae3b7eb663c9a48f4cee3,0497350166f7bbeca0fae3b7eb663c9a48f4cee3,"Introduce a separate test config for production builds.

Summary:
The Jenkins job sets the INBOX_CFG_PATH to point to this config
when running tests against the production build.

This is the simplest way to accomplish what we want
namely have concurrently running master/ production builds
complete without hanging due to tests contending for the same database
tables.

Other options considered were having a single test config
but selectively processing it/ updating it on the fly.

The corresponding changes to the Jenkins job definitions can be found here:
https://github.com/nylas/jenkins-job-definitions/commit/fc900f729fcc83f7be69b51158486efabe952808

Test Plan:
Tested manually.
- Unit tests pass with/ without setting the INBOX_CFG_PATH
- Dropped all test databases, revoked user permissions,
ran bin/create-test-db and then the tests as above.

Reviewers: emfree

Reviewed By: emfree

Differential Revision: https://phab.nylas.com/D2396"
emfree,2015-12-29 18:59:41,https://api.github.com/repos/nylas/sync-engine/git/commits/509e55a127cb41f79b4eeca0d4e5b0c834547923,509e55a127cb41f79b4eeca0d4e5b0c834547923,"Bump SQLAlchemy version.

See http://docs.sqlalchemy.org/en/latest/changelog/changelog_10.html#change-1.0.11.
Primarily for fixes to https://bitbucket.org/zzzeek/sqlalchemy/issues/3611
(blocked upgrade to 1.0.10) and https://bitbucket.org/zzzeek/sqlalchemy/issues/3612
(blocked use of systemwide `bake_lazy_loaders()`)."
khamidou,2015-12-24 01:26:53,https://api.github.com/repos/nylas/sync-engine/git/commits/d361c5ed78dc89ece1b4f4a0950acbd865b7dfbd,d361c5ed78dc89ece1b4f4a0950acbd865b7dfbd,add a new exchange domain.
emfree,2015-12-22 20:25:10,https://api.github.com/repos/nylas/sync-engine/git/commits/21fd9bc02b38e89d7ccb4fae1df887c10a1cce18,21fd9bc02b38e89d7ccb4fae1df887c10a1cce18,"Add gevent ""load average"" instrumentation."
emfree,2015-12-22 18:55:35,https://api.github.com/repos/nylas/sync-engine/git/commits/1dade7971d99cbfc2a288d7e54cd97e6562c5fb8,1dade7971d99cbfc2a288d7e54cd97e6562c5fb8,Correctly increment retry counter on syncback failure.
khamidou,2015-12-21 20:26:41,https://api.github.com/repos/nylas/sync-engine/git/commits/d2a094ae542dbef4793a753efef501e77a48e945,d2a094ae542dbef4793a753efef501e77a48e945,"Include the calendar id when serializing inflated recurring events

Summary: We weren't including the `calendar_id` when inflating a `RecurringEvent` into multiple `InflatedEvents`. This diff fixes this.

Test Plan: Tested manually.

Reviewers: emfree

Reviewed By: emfree

Differential Revision: https://phab.nylas.com/D2329"
emfree,2015-12-18 06:43:07,https://api.github.com/repos/nylas/sync-engine/git/commits/11fe680f7483d895d45d8f9ec3b0e01af578395f,11fe680f7483d895d45d8f9ec3b0e01af578395f,Remove superfluous commit in UID deletion; fix log indent.
emfree,2015-12-18 03:49:49,https://api.github.com/repos/nylas/sync-engine/git/commits/cc075fad0484889fc92b3541cd432a68465ea996,cc075fad0484889fc92b3541cd432a68465ea996,"Improve performance of bulk UID deletion.

From (sigh) O(n^2) to O(n)."
emfree,2015-12-18 00:28:10,https://api.github.com/repos/nylas/sync-engine/git/commits/c719dbb15c8c048718d9d020c29b6018f7965878,c719dbb15c8c048718d9d020c29b6018f7965878,Improve really bad query.
emfree,2015-12-17 22:24:50,https://api.github.com/repos/nylas/sync-engine/git/commits/520c27444449be13ca15c2d372404cc3a82cbda9,520c27444449be13ca15c2d372404cc3a82cbda9,"Better handle flags changes for lots and lots of UIDs.

Summary:
We now commit flag/label changes in reasonably-sized batches. This means that
if many flags or labels are changed all at once, they can be incrementally
synced; previously, if the sync was interrupted partway through, it'd have to
completely start over. This also helps avoid slowdown when very many objects
are all loaded in a single SQLAlchemy session.

Fixes T6262.

Test Plan: Unit tests added.

Reviewers: kav-ya

Reviewed By: kav-ya

Maniphest Tasks: T6262

Differential Revision: https://phab.nylas.com/D2369"
emfree,2015-12-17 21:37:08,https://api.github.com/repos/nylas/sync-engine/git/commits/7c20c44acdaed3404099495e5e51fea9d2e4e952,7c20c44acdaed3404099495e5e51fea9d2e4e952,"Do not create block objects for undecodeable MIME parts.

Doing so creates problems later. Previously, if calling `mimepart.body` raised
an exception midway through setting attributes on a new `Block` object, the
object would be committed, but with size 0 and null `data_sha256`, triggering
an assertion upon subsequent attempts to load it. Remove that as well.

Fixes T6257."
emfree,2015-12-17 19:18:37,https://api.github.com/repos/nylas/sync-engine/git/commits/67d421a5c0e59554f0e4b8a94250668194789205,67d421a5c0e59554f0e4b8a94250668194789205,Fix source in pool instrumentation.
emfree,2015-12-16 20:16:05,https://api.github.com/repos/nylas/sync-engine/git/commits/ae8f55c64b8ae6ba43d45926b909607e9ef117be,ae8f55c64b8ae6ba43d45926b909607e9ef117be,"Add additional instrumentation of database pool checkouts.

Summary:
This is an attempt to more easily hunt down connection pool overuse.
Basically we keep track of when and why active connections were checked
out, and expose that information at `localhost:$process_port/pool`. This is
arguably an incredibly whacky approach, but potentially very expedient.

Example output:
```
vagrant@precise64:~$ curl localhost:16384/pool
[{""source"": ""nylas.logging.log:44"", ""checkedout_at"": 1450296933.962305,
""context"": {""folder"": ""[Gmail]/All Mail"", ""provider"": ""gmail"", ""state"":
""initial"", ""account_id"": 1}}]
```

Test Plan: Tested locally by running a sync and curling it.

Reviewers: spang, khamidou

Reviewed By: khamidou

Differential Revision: https://phab.nylas.com/D2361"
khamidou,2015-12-17 04:02:59,https://api.github.com/repos/nylas/sync-engine/git/commits/801ae9eba08bd980471810384f043f477be015be,801ae9eba08bd980471810384f043f477be015be,"Fix an unbreak now bug in the RSVP API

Summary: This diff fixes T6254. I also added better tests.

Test Plan: Tested manually + wrote a regression test.

Reviewers: emfree

Reviewed By: emfree

Maniphest Tasks: T6254

Differential Revision: https://phab.nylas.com/D2362"
kav-ya,2015-12-16 19:54:13,https://api.github.com/repos/nylas/sync-engine/git/commits/fa0d198420a17f22fdff355e7e829be3b1235c45,fa0d198420a17f22fdff355e7e829be3b1235c45,Add generic IMAP invalid login message.
khamidou,2015-12-12 00:53:24,https://api.github.com/repos/nylas/sync-engine/git/commits/24e877353094569f49d0a8073fb0167d86fb9ad4,24e877353094569f49d0a8073fb0167d86fb9ad4,"[Arcanist] Call Pylint to detect undefined loop variables

Summary:
Earlier today Eben found out that a piece of code I wrote contained a reference to variable that wasn't iterated on:
```
l = [folder.name for folder in folders]
for folder_name in l:
    updated_metadata(folder.name)
    # The correct call should have been folder_name.
```

This diff very hacky diff changes our arcanist tooling to run the corresponding pylint before running flake8. This is the pylint output if it detects the condition:
```
Some linters failed:
    - CommandException: Command failed with error #4!
      COMMAND
      pylint -d all -e w0631 inbox

      STDOUT
      ************* Module inbox.mailsync.gc
      W:191,60: Using possibly undefined loop variable 'folder' (undefined-loop-variable)

      Report
      ======
      10496 statements analysed.

      Statistics by type
      ------------------

      +---------+-------+-----------+-----------+------------+---------+
      |type     |number |old number |difference |%documented |%badname |
      +=========+=======+===========+===========+============+=========+
      |module   |0      |0          |=          |0           |0        |
      +---------+-------+-----------+-----------+------------+---------+
      |class    |149    |149        |=          |NC          |NC       |
      +---------+-------+-----------+-----------+------------+---------+
      |method   |0      |0          |=          |0           |0        |
      +---------+-------+-----------+-----------+------------+---------+
      |function |0      |0          |=          |0           |0        |
      +---------+-------+-----------+-----------+------------+---------+

      External dependencies
      ---------------------
      ::

          in... (2,505 more bytes) ...

      STDERR
      No config file found, using default configuration
```

The code is very janky because arcanist makes it hard for us to do this, and I frankly didn't want to spend more time on this.

Test Plan: Tested by enabling and disabling a code path with this condition.

Reviewers: emfree

Reviewed By: emfree

Differential Revision: https://phab.nylas.com/D2336"
emfree,2015-12-11 02:59:40,https://api.github.com/repos/nylas/sync-engine/git/commits/110358d481a26c073d2f3cc83cfb368159c2fc27,110358d481a26c073d2f3cc83cfb368159c2fc27,"Restructure IMAP actions.

Summary:
Previously, a database connection would be held for the duration that it took
an IMAP action to execute. This severely limits the number of actions that can
execute concurrently. Restructure the code to avoid this. (Note that in the
interest of simplicity, folder/label CRUD actions still hold a database
connection. However, they are far less common than mass archiving or
unread-marking, and therefore much less problematic.)

Fixes T6209.

Test Plan: Unit tests added and updated.

Reviewers: kav-ya

Reviewed By: kav-ya

Maniphest Tasks: T6209

Differential Revision: https://phab.nylas.com/D2342"
khamidou,2015-12-10 22:26:37,https://api.github.com/repos/nylas/sync-engine/git/commits/9500d5c52a1c1154c8562d45bf4db32c574b8d40,9500d5c52a1c1154c8562d45bf4db32c574b8d40,"Relax Category lookup constraints

Summary:
Fixes T4423 and T5016. Some providers like Yahoo don't have an ""Archive"" folder. This isn't a problem per-se, but some of our API users went ahead and used the API to create one.

Unfortunately, because of the way `Category.find_or_create` is written, this caused us to create two categories instead of one (one during the syncback and another one when syncing the newly created folder). Confusion ensued.

Test Plan: Tested manually.

Reviewers: emfree

Reviewed By: emfree

Maniphest Tasks: T4467, T5016, T4423

Differential Revision: https://phab.nylas.com/D2280"
spang,2015-12-10 21:34:49,https://api.github.com/repos/nylas/sync-engine/git/commits/c3c00aa31bf1deacc4d257a237b6abe91ba0ab63,c3c00aa31bf1deacc4d257a237b6abe91ba0ab63,"Strip out ALL unicode control characters before sending to contact search.

Maybe now we can stop playing whack-a-mole."
emfree,2015-12-10 20:29:22,https://api.github.com/repos/nylas/sync-engine/git/commits/4ad4ec1f026696311c584262b70a7cda473474de,4ad4ec1f026696311c584262b70a7cda473474de,"Fix rate limit check in SMTP XOAUTH2.

Blind reauthentication attempts after getting a 454 error code lead to the
connection simply being terminated."
emfree,2015-12-10 19:59:56,https://api.github.com/repos/nylas/sync-engine/git/commits/ff9b8b303f181a06e0abced85b5bcd4ac169ce18,ff9b8b303f181a06e0abced85b5bcd4ac169ce18,"Bump pylint dependency.

Because its own dependency on astroid is broken."
grinich,2015-12-10 19:28:37,https://api.github.com/repos/nylas/sync-engine/git/commits/96e470c0d1f4825250ad7717535a08548965a9be,96e470c0d1f4825250ad7717535a08548965a9be,missed one docker file
grinich,2015-12-10 19:24:27,https://api.github.com/repos/nylas/sync-engine/git/commits/7194ae46fc2a45f4ff4d8af24f1f7b3c92b6949e,7194ae46fc2a45f4ff4d8af24f1f7b3c92b6949e,"Move bitrotted Docker config to https://github.com/nylas/sync-engine-docker

We don't actually use Docker to run anything in production, so this code is not consistently tested or supported. New developers are confused when they check out the project and assume that we support Docker, so I'm removing it.

I've created a new repo at https://github.com/nylas/sync-engine-docker for development of a Docker wrapper to run the sync engine. I think this is a better home for it, since the sync engine can be deployed a bunch of different ways."
kav-ya,2015-12-10 18:47:52,https://api.github.com/repos/nylas/sync-engine/git/commits/56fc236ca645aff82b507c14ef2fd26ae188fa30,56fc236ca645aff82b507c14ef2fd26ae188fa30,Remove unused import to fix failing Jenkins build.
emfree,2015-12-10 00:36:30,https://api.github.com/repos/nylas/sync-engine/git/commits/a2844622c80ab3f8098c988fe38ca397a858b259,a2844622c80ab3f8098c988fe38ca397a858b259,"Always sync inbox folder first for generic IMAP accounts.

Test Plan: Regression test added.

Reviewers: kav-ya

Reviewed By: kav-ya

Differential Revision: https://phab.nylas.com/D2334"
emfree,2015-12-09 22:29:56,https://api.github.com/repos/nylas/sync-engine/git/commits/5ae36f32240870689dffadf78030f55f7a46e93b,5ae36f32240870689dffadf78030f55f7a46e93b,"Revert ""Sync Gmail label renames""

This reverts commit 6d081fe29c424aca9cf3b181e07a1ffe9b67fc01.

Reason for rollback: Does not work with imapclient 0.13, can potentially
introduce arbitrary inconsistency, may leak resources."
khamidou,2015-12-09 22:35:04,https://api.github.com/repos/nylas/sync-engine/git/commits/563179dcab064f1071a2595c889f6cf0170296b5,563179dcab064f1071a2595c889f6cf0170296b5,"Make the RSVP sending endpoint idempotent

Summary:
This diff changes the RSVP endpoint to not send an email if the participant's status isn't actually getting updated. This should solve a bug N1 is having. Docs to follow.

Test Plan:
Testing plan: tested manually. Will wrap-up unit tests tomorrow.

Reviewers: emfree

Reviewed By: emfree

Subscribers: bengotow

Differential Revision: https://phab.nylas.com/D2320"
spang,2015-12-08 20:41:12,https://api.github.com/repos/nylas/sync-engine/git/commits/0f83a4dc07a1c0dc955cd2cf6f97982836f365a9,0f83a4dc07a1c0dc955cd2cf6f97982836f365a9,Strip out another mangled codepoint crashing contact search.
emfree,2015-12-08 07:06:10,https://api.github.com/repos/nylas/sync-engine/git/commits/5548eee9ef49286eecd5d14815183f1d24aedf1d,5548eee9ef49286eecd5d14815183f1d24aedf1d,Remove obsoleted tests.
emfree,2015-12-08 03:32:21,https://api.github.com/repos/nylas/sync-engine/git/commits/e3eab6de8276307e2406ba96c88e2a26db18ae65,e3eab6de8276307e2406ba96c88e2a26db18ae65,Remove now unnecessary writes in heartbeat publishing.
emfree,2015-12-08 03:41:37,https://api.github.com/repos/nylas/sync-engine/git/commits/697f40aff0ecba7640251268a6e35abf083206d3,697f40aff0ecba7640251268a6e35abf083206d3,"Make get_ping_status take a list of account_ids.

This is more efficient, especially if you want to get heartbeats for some
subset of all accounts."
emfree,2015-12-07 20:21:40,https://api.github.com/repos/nylas/sync-engine/git/commits/81d363d63b561ce534c3ddfc47a2ea863592cf55,81d363d63b561ce534c3ddfc47a2ea863592cf55,"Remove cruft in account sync heartbeat logic.

A mostly implicit design assumption for the original sync heartbeat logic was
that status should be computable using /only/ the data that you put in Redis.
This ended up being real problematic, involved a lot of complexity, and is no
longer true in practice.
Subsequently, several revisions of this logic were undertaken, but not all
fully completed. As a result, there is a lot of essentially unused code that
can be excised. Remove much of it. Note that we're not (yet) changing what
actually gets written to Redis when a heartbeat is published. That will follow
in a subsequent patch."
kav-ya,2015-12-05 23:06:35,https://api.github.com/repos/nylas/sync-engine/git/commits/b0deead212268ea42926579612db63e0b57e2216,b0deead212268ea42926579612db63e0b57e2216,Include provider in action errors shipped to Sentry too.
emfree,2015-12-04 23:53:47,https://api.github.com/repos/nylas/sync-engine/git/commits/fc625391f8c5e328cde156e99f65a261f34b2559,fc625391f8c5e328cde156e99f65a261f34b2559,"Revert changes to support imapclient 1.0.

Reason for rollback: Destructive blocking in gevent_openssl.

This reverts commits:
b13d8818bad94448b2922b3bf00203d4361c6c52
492991fcb082a2da49c2c2e87efffe38c3607878
d438e818f05f812245deaf302c29034cc07163d9
7a77e175eb4d925b58d300078bf02a5e20dad0a9
34e45dd0b5ce69446d6f373d0fe85d408adcc242
5b1c229c28ff9e017e8dc00413d3e01ceb25da0a
d5795a22696ff2e16e8c62bffccde2c90853c42c
1e050a6af342d1e8ea43cf943dcd1cab5df8fa28
66956f7e2cb7e726885d730daff2cd72896bd75b"
kav-ya,2015-12-03 07:54:45,https://api.github.com/repos/nylas/sync-engine/git/commits/39a2a0ceb5159f6ae9e87316ef2313d96706b63e,39a2a0ceb5159f6ae9e87316ef2313d96706b63e,"Include the account provider in Sentry exceptions.

Summary:
To correlate sync errors with providers.
We introduce the Account.verbose_provider property to expose the specific provider (Office365 versus Outlook etc.)
since this is what we care about. Ideally we'd directly use the existing Account.provider property,
but the existing (and hella messy) auth code uses this in all sorts of ways - for example, to determine the
auth_handler to use and the provider icon to display on the signup page.
So for now, in order to get at these crucial metrics in a timely manner, we use a new property instead
rather than embarking on a giant, cross-repo refactor.

Test Plan:
Unit test added.
Gmail/ Exchange/ Yahoo syncs run locally.

Reviewers: khamidou

Reviewed By: khamidou

Differential Revision: https://phab.nylas.com/D2312"
khamidou,2015-12-04 01:27:28,https://api.github.com/repos/nylas/sync-engine/git/commits/78feb2851bd1d947557ced348ab095e242e21a77,78feb2851bd1d947557ced348ab095e242e21a77,"Restore correct count query

Summary: The label rename diff was based off an old version of the label deletion diff. This old version included a `.count()` query, which is terrible with MySQL. This diff fixes that.

Test Plan: Ran the unit tests.

Reviewers: emfree

Reviewed By: emfree

Differential Revision: https://phab.nylas.com/D2316"
khamidou,2015-12-03 22:02:57,https://api.github.com/repos/nylas/sync-engine/git/commits/5567bc10fce90753ce063c1b4ae17274ddcfa3b0,5567bc10fce90753ce063c1b4ae17274ddcfa3b0,fix race condition in Jenkins.
khamidou,2015-12-02 23:27:22,https://api.github.com/repos/nylas/sync-engine/git/commits/0d1c748403924033f69efcad1e2d0c1e2a12d101,0d1c748403924033f69efcad1e2d0c1e2a12d101,"explicitly specify an Exchange server for one of our customers with a
dual GAFYD/Exchange setup."
emfree,2015-12-02 23:03:43,https://api.github.com/repos/nylas/sync-engine/git/commits/d438e818f05f812245deaf302c29034cc07163d9,d438e818f05f812245deaf302c29034cc07163d9,"Apply explicit timeout to IMAPClient objects.

Fixes critical regression with imapclient 1.0, in which an IMAPClient instance
instantiated with the default argument timeout=None will not get a timeout
specified by socket.setdefaulttimeout()."
khamidou,2015-12-02 23:01:25,https://api.github.com/repos/nylas/sync-engine/git/commits/ac6a4a1011330fd06443d5a95aa9fc6a88b741f8,ac6a4a1011330fd06443d5a95aa9fc6a88b741f8,fix non-ascii labels search bug.
kav-ya,2015-12-02 04:24:47,https://api.github.com/repos/nylas/sync-engine/git/commits/353c5fc7fab84cd8d247a221568fcd3bbf11bf1f,353c5fc7fab84cd8d247a221568fcd3bbf11bf1f,Remove unused import.
kav-ya,2015-12-02 04:11:54,https://api.github.com/repos/nylas/sync-engine/git/commits/8cfec12231f392f248e77c3d9c0f1c9123361fe1,8cfec12231f392f248e77c3d9c0f1c9123361fe1,Delete unused inbox/heartbeat/report.py file.
kav-ya,2015-12-02 04:08:22,https://api.github.com/repos/nylas/sync-engine/git/commits/759511df0babcd2c06cf44047461ea2fcdd5043a,759511df0babcd2c06cf44047461ea2fcdd5043a,"Instantiate the Redis ConnectionPool with the right host, port, db params."
khamidou,2015-12-02 03:26:39,https://api.github.com/repos/nylas/sync-engine/git/commits/362d6c0c5b1d44dafa7c75b4b081a43fde2e5a75,362d6c0c5b1d44dafa7c75b4b081a43fde2e5a75,fix typo
khamidou,2015-12-02 02:55:40,https://api.github.com/repos/nylas/sync-engine/git/commits/6d081fe29c424aca9cf3b181e07a1ffe9b67fc01,6d081fe29c424aca9cf3b181e07a1ffe9b67fc01,"Sync Gmail label renames

Summary:
This diff builds upon D2270 and allows us to sync label renames.

The problem: Because of a bug in Gmail, we don't get alerted when someone renames a label.
The ""solution"": To workaround this, whenever we encounter a Gmail label we haven't seen yet, we check that this isn't a renamed label. To do this, we:

1. Select the label
2. Get the X-GM-MSGID of all the messages in it
3. Sequentially go through [All mail, Spam, Trash] and
       Get the UIDs for the messages matching the X-GM-MSGIDs we have
       Update the metadata for the uids we found.

Test Plan: Tested manually. Checked that label adds, deletes and renames were synced correctly.

Reviewers: emfree, spang

Reviewed By: spang

Subscribers: spang

Maniphest Tasks: T4467

Differential Revision: https://phab.nylas.com/D2279"
khamidou,2015-12-02 02:54:43,https://api.github.com/repos/nylas/sync-engine/git/commits/8836a2505ba54bac01d21c9f46551008ccb7aec2,8836a2505ba54bac01d21c9f46551008ccb7aec2,"Revert ""Sync gmail labels deletes""
Landed the wrong commit --- they both were associated to the same
ticket.

This reverts commit 059dc24ae9c61ad91af0156467413d9ac1bd9079."
khamidou,2015-12-02 02:53:26,https://api.github.com/repos/nylas/sync-engine/git/commits/059dc24ae9c61ad91af0156467413d9ac1bd9079,059dc24ae9c61ad91af0156467413d9ac1bd9079,"Sync gmail labels deletes

Summary:
It's kind of tricky to detect label deletions because gmail users can exclude some labels from IMAP.
Because of this we can't do something trivial like `delete(set(old_labels) - set(new_labels))`.

My solution is to delete labels only if
(1) they don't show up in the output of the `LIST` command
(2) no messages are associated with them.

This allows us to deal with the various possible edge cases: a hidden label with attached messages, an empty label with no messages, etc.

To implement this I chose to use a two-step algorithm:

1. When listing folders, we get the list of labels which aren't present anymore on the remote server, and mark them as ""deleted"" by setting `Label.deleted_at`.

2. When updating the categories for a message, we delete labels which were marked as deleted and with no attached messages.

Test Plan:
Tested by:
1. creating a new label in gmail, deleting it and checking the API picked it up.
2. creating a label in gmail, adding messages to it, deleting the label, checking that the API picked it up.
3. creating a label in gmail, adding messages to it, hiding the label, checking that the API deleted the label.

Reviewers: emfree

Reviewed By: emfree

Maniphest Tasks: T4467

Differential Revision: https://phab.nylas.com/D2270"
kav-ya,2015-12-01 23:40:47,https://api.github.com/repos/nylas/sync-engine/git/commits/6278d34404e34ff070cafd6047432b26a874059f,6278d34404e34ff070cafd6047432b26a874059f,"Limit the number of Redis connections maintained in the per sync process ConnectionPool.
Also set a connection timeout.

Summary:
The MAX_CONNECTIONS constant is set by back-calculating from the number of sync processes
we have; the SOCKET_TIMEOUT has been picked somewhat arbitrarily.

Test Plan:
Tested manually.

Reviewers: khamidou, emfree

Reviewed By: emfree

Differential Revision: https://phab.nylas.com/D2302"
kav-ya,2015-12-01 23:06:01,https://api.github.com/repos/nylas/sync-engine/git/commits/009cfb4f8a6cfb4ffc920c66a78ebce3544804af,009cfb4f8a6cfb4ffc920c66a78ebce3544804af,Delete unused file.
kav-ya,2015-11-30 22:55:19,https://api.github.com/repos/nylas/sync-engine/git/commits/684ab523386323f295bbfbe244179b96804d64be,684ab523386323f295bbfbe244179b96804d64be,"Do not overwrite the ""sync_disabled_reason"" for a soft-deleted account."
grinich,2015-11-26 02:48:42,https://api.github.com/repos/nylas/sync-engine/git/commits/bbdbe55c34a579c3cff9dec090c056e490613e3a,bbdbe55c34a579c3cff9dec090c056e490613e3a,"Deprecate tags

Test Plan: passes tests

Reviewers: khamidou

Reviewed By: khamidou

Differential Revision: https://phab.nylas.com/D2292"
grinich,2015-11-25 18:21:47,https://api.github.com/repos/nylas/sync-engine/git/commits/5e564214ae7ce971c9d8705bd361844d93f9522f,5e564214ae7ce971c9d8705bd361844d93f9522f,"Deprecate /n/<namespace_id> prefix in API

Test Plan: passes tests. removed tests for legacy endpoints

Reviewers: spang

Reviewed By: spang

Differential Revision: https://phab.nylas.com/D2258"
spang,2015-11-24 19:22:10,https://api.github.com/repos/nylas/sync-engine/git/commits/a0c9e3da21ffe075498089b004951d927a42922c,a0c9e3da21ffe075498089b004951d927a42922c,More code points.
spang,2015-11-24 18:51:05,https://api.github.com/repos/nylas/sync-engine/git/commits/0cb9e9b4742fb476fc4ff450b80e502875ee3e3b,0cb9e9b4742fb476fc4ff450b80e502875ee3e3b,Fix contacts search crash.
spang,2015-11-24 04:37:05,https://api.github.com/repos/nylas/sync-engine/git/commits/bb1b273c02dcb4e8d5324347a2aba5b332a5e446,bb1b273c02dcb4e8d5324347a2aba5b332a5e446,Match bad codepoints in places other than the start of string.
emfree,2015-11-23 23:04:20,https://api.github.com/repos/nylas/sync-engine/git/commits/da2c7596035a861a148631bafcd19a0181b9d851,da2c7596035a861a148631bafcd19a0181b9d851,Fix handling of null SYNC_HOSTS configuration.
kav-ya,2015-11-23 22:25:57,https://api.github.com/repos/nylas/sync-engine/git/commits/568526645f39c6fd7205458a4f3c3f04d5f50780,568526645f39c6fd7205458a4f3c3f04d5f50780,Set Message.parsed_body on parse error as well.
khamidou,2015-11-23 21:38:14,https://api.github.com/repos/nylas/sync-engine/git/commits/b2362bfbd8fef22b69b2d55ed5478da37a7972ed,b2362bfbd8fef22b69b2d55ed5478da37a7972ed,forgot to add test file.
khamidou,2015-11-23 21:37:19,https://api.github.com/repos/nylas/sync-engine/git/commits/a4708bb220677b86dd0ceff1f1d9b47bedc90bff,a4708bb220677b86dd0ceff1f1d9b47bedc90bff,"Rework folder handling for generic IMAP

Summary:
Rework Generic IMAP folder handling

Fixes T4085 and T4262. One ""interesting"" feature of IMAP is that it doesn't support nested folders. The IMAP server returns a list of folders and it's the responsibility of the client to display it as a hierarchy. For example, the server will return us something like this:
```
INBOX.Accounting
INBOX.Accounting.Invoices
```

and the client will display it like this:
```
/Accounting
   /Invoices
```

Another funny feature of IMAP is that the path separator used is server-defined. Some use '/' (as in `INBOX/Accounting`), most use '.' (`INBOX.Accounting`), so we need to keep track of this.

What this diff fixes:
---------------------

T4262: Right now, we're exposing nested Gmail labels as a path (`Accounting/Invoices`) but don't do any kind of processing on nested IMAP folders (they still show up as `INBOX.Accounting.Invoices`). This diff fixes the API to return them as the latter. Of course, we're still using the same IMAP name under the hood.

T4085: We can't create folders on generic IMAP servers like Fastmail because they require the folder name to be of the form `INBOX.whatever`. This diff changes the syncback code a bit to accomodate that.

Test Plan: Tested manually by creating and renaming a Fastmail folder.

Reviewers: kav-ya

Reviewed By: kav-ya

Subscribers: emfree

Maniphest Tasks: T4262, T4085

Differential Revision: https://phab.nylas.com/D2266"
emfree,2015-11-21 03:54:01,https://api.github.com/repos/nylas/sync-engine/git/commits/3a3e78a8dbc53567694ed54c8f657a73e3f64c87,3a3e78a8dbc53567694ed54c8f657a73e3f64c87,"Allow account sync stealing on shards to be constrained to particular hosts.

Summary:
For the time being, this actually seems much simpler than adding a separate
scheduling service, and largely equivalent in functionality. We ship
configuration mapping shards->sync hosts, but use this mapping only when
starting new syncs. If no such configuration is provided, any host can claim
syncs from any shards (i.e., it works exactly as before).

Issues with too many connections have largely been resolved by e5fd379c1f.

Test Plan: Unit tests added.

Reviewers: spang

Reviewed By: spang

Differential Revision: https://phab.nylas.com/D2281"
khamidou,2015-11-20 23:33:05,https://api.github.com/repos/nylas/sync-engine/git/commits/85765f78b4a7b85bb4a54c72dd3988bacb24f52d,85765f78b4a7b85bb4a54c72dd3988bacb24f52d,"Sync gmail labels deletes

Summary:
It's kind of tricky to detect label deletions because gmail users can exclude some labels from IMAP.
Because of this we can't do something trivial like `delete(set(old_labels) - set(new_labels))`.

My solution is to delete labels only if
(1) they don't show up in the output of the `LIST` command
(2) no messages are associated with them.

This allows us to deal with the various possible edge cases: a hidden label with attached messages, an empty label with no messages, etc.

To implement this I chose to use a two-step algorithm:

1. When listing folders, we get the list of labels which aren't present anymore on the remote server, and mark them as ""deleted"" by setting `Label.deleted_at`.

2. When updating the categories for a message, we delete labels which were marked as deleted and with no attached messages.

Test Plan:
Tested by:
1. creating a new label in gmail, deleting it and checking the API picked it up.
2. creating a label in gmail, adding messages to it, deleting the label, checking that the API picked it up.
3. creating a label in gmail, adding messages to it, hiding the label, checking that the API deleted the label.

Reviewers: emfree

Reviewed By: emfree

Maniphest Tasks: T4467

Differential Revision: https://phab.nylas.com/D2270"
emfree,2015-11-20 22:16:01,https://api.github.com/repos/nylas/sync-engine/git/commits/e5fd379c1f03d34731e566792d7c28d53647adc7,e5fd379c1f03d34731e566792d7c28d53647adc7,"Suppress database connection pooling behavior in sync scheduling.

Let's say you have lots of sync engines and lots of MySQL shards. And say you
have de facto affinity of sync engines to shards. That is, a sync
engine is only actually responsible for accounts on one shard in general.
However, the sync engine still checks /all/ shards for account syncs to run,
and as a result acquires a persistent connection to each. MySQL doesn't like
having lots of connections. So for now at least, just explicitly close the
connection.

Of course, this is just a standin until a more fully-developed solution for
large-scale sync scheduling is fixed."
kav-ya,2015-11-18 04:17:20,https://api.github.com/repos/nylas/sync-engine/git/commits/e6a8b59c2fce183f1116e633beb0e6172831bfa9,e6a8b59c2fce183f1116e633beb0e6172831bfa9,"Changes needed for deploy of 8504298 Do not create Message.full_body Blocks:
* Split migration into two.
* s/full_body instance attribute/ parsed_body."
emfree,2015-11-18 03:19:28,https://api.github.com/repos/nylas/sync-engine/git/commits/23dd1e665cba9266d3f6cdc8866770868431c673,23dd1e665cba9266d3f6cdc8866770868431c673,"Do not publish heartbeat from HeartbeatStatusProxy constructor.

This is fundamentally misguided/misleading. It is also inefficient if the
HeartbeatStatusProxy is frequently reinstantiated (e.g., in Exchange sync).

Also remove unused code (`get_heartbeat_status`) which would be broken by this."
kav-ya,2015-11-18 02:39:39,https://api.github.com/repos/nylas/sync-engine/git/commits/7a77e175eb4d925b58d300078bf02a5e20dad0a9,7a77e175eb4d925b58d300078bf02a5e20dad0a9,Remove imapclient from setup.py
kav-ya,2015-11-18 02:20:46,https://api.github.com/repos/nylas/sync-engine/git/commits/8092f165138fa51ecad5f596eb2ea950a4aa6aae,8092f165138fa51ecad5f596eb2ea950a4aa6aae,Add explanatory comment.
emfree,2015-11-17 21:42:42,https://api.github.com/repos/nylas/sync-engine/git/commits/b732de0c23ac3c5bc2d093a4de782eea37f34665,b732de0c23ac3c5bc2d093a4de782eea37f34665,Fix potential KeyError in label updating.
spang,2015-11-17 22:55:28,https://api.github.com/repos/nylas/sync-engine/git/commits/bd2dbb91a519473fe17bfe7a54c86e530aba860b,bd2dbb91a519473fe17bfe7a54c86e530aba860b,"Normalize ""regex"" patterns in providers.py.

Summary:
The immediate reason to do this is because the current code is wrongly
interpreting 'ppsmtp.com' to be an MX server for Gmail, but altogether
the current plugging of things that were intended to be straight strings
into a regex has lots of room for misinterpretation, mostly with the '.'
character, which can stand for everything—but we generally intend for it
to be used literally, except in wildcard matches.

So as a compromise between legibility and being able to actually tell
what a given pattern does, we leave dots as literal dots and * as a glob
*, and substitute these into proper regexes before using them. Otherwise
we'd have to switch out '.' for '[.]' and '*' for '.*' everywhere.

Test Plan:
Unit tests, some manual testing

I added some new test cases for providers, but couldn't find good domains for
namecheap/godaddy that aren't likely to randomly stop working at some point
in the future.

Reviewers: khamidou

Reviewed By: khamidou

Differential Revision: https://phab.nylas.com/D2268"
kav-ya,2015-11-17 21:43:38,https://api.github.com/repos/nylas/sync-engine/git/commits/34e45dd0b5ce69446d6f373d0fe85d408adcc242,34e45dd0b5ce69446d6f373d0fe85d408adcc242,"Include pyopenssl, gevent_openssl in setup.py"
emfree,2015-11-17 19:22:32,https://api.github.com/repos/nylas/sync-engine/git/commits/cd6d04c136991ccabcdd8babe949b9ad220574ed,cd6d04c136991ccabcdd8babe949b9ad220574ed,"Handle nonsensical dates in Google calendar sync.

The Google calendar API is very liberal in what it accepts, and so can vend
back dates that are not actually valid. Handle such cases."
emfree,2015-11-17 04:18:06,https://api.github.com/repos/nylas/sync-engine/git/commits/7d408c323df8d9ec6006eaa5fc8da3ec67fe5446,7d408c323df8d9ec6006eaa5fc8da3ec67fe5446,Fix broken check in greenlet tracing.
emfree,2015-11-17 04:01:25,https://api.github.com/repos/nylas/sync-engine/git/commits/0d6a360dc324ec0c0e18f678d2d1a660c8a7364a,0d6a360dc324ec0c0e18f678d2d1a660c8a7364a,"Fix broken log statement.

`self.namespace` may be `None` in Category.find_or_create pre-flush, causing an
AttributeError to be raised. The logger should already have an account_id bound
via context-local magic anyways."
emfree,2015-11-17 03:56:52,https://api.github.com/repos/nylas/sync-engine/git/commits/b982ea1ea524a951f5edfa6d7b4f23d2581e6be1,b982ea1ea524a951f5edfa6d7b4f23d2581e6be1,Check for overlong reply_to fields.
emfree,2015-11-16 23:35:30,https://api.github.com/repos/nylas/sync-engine/git/commits/864d7e05e7b78eb66ff1a24e536fe9971d3d7dd2,864d7e05e7b78eb66ff1a24e536fe9971d3d7dd2,"Filter on account.sync_should_run in syncback worker.

This lets the query use the compound index on
`(account.sync_should_run, account.sync_host)`."
kav-ya,2015-11-12 00:29:06,https://api.github.com/repos/nylas/sync-engine/git/commits/626bcf56f35bd1ca298d9ce63f6ff46b7b6ee723,626bcf56f35bd1ca298d9ce63f6ff46b7b6ee723,"Do not create Message.full_body Blocks.

Summary:
Only attachments synced or created through the API are persisted
as Block objects.
This fixes the issue whereby entire raw message bodies would be incorrectly
returned by the /files endpoint. Additionally, it decreases the amount of data
we store for messages in the database, and lays the groundwork for future
refactoring for performance gains (for example, hoisting the persistance to S3
out of the open database session.)

Test Plan:
Regression test clauses added to tests in tests/general/test_message_parsing,
tests/api/test_files.
Manually tested as well.

Reviewers: emfree, ethanb

Reviewed By: ethanb

Differential Revision: https://phab.nylas.com/D2252"
emfree,2015-11-14 01:04:38,https://api.github.com/repos/nylas/sync-engine/git/commits/db5c7d145f2c202e222eb19f4402364cc402dba6,db5c7d145f2c202e222eb19f4402364cc402dba6,Remove irrelevant test case.
emfree,2015-11-14 00:56:13,https://api.github.com/repos/nylas/sync-engine/git/commits/f21c0c65bf409c733cbd89553e1d7ab4fb9f65f2,f21c0c65bf409c733cbd89553e1d7ab4fb9f65f2,Bump nylas-production-python version.
emfree,2015-11-13 02:24:57,https://api.github.com/repos/nylas/sync-engine/git/commits/1e050a6af342d1e8ea43cf943dcd1cab5df8fa28,1e050a6af342d1e8ea43cf943dcd1cab5df8fa28,Add backports.ssl in setup.py.
khamidou,2015-11-10 00:29:08,https://api.github.com/repos/nylas/sync-engine/git/commits/64373b6bacc4cdbdee60c459f49fb0a3eb640662,64373b6bacc4cdbdee60c459f49fb0a3eb640662,add a script to throttle/unthrottle accounts.
khamidou,2015-11-10 00:27:31,https://api.github.com/repos/nylas/sync-engine/git/commits/a560b66dbef7f18590daef112dcb5e0b7c0187e3,a560b66dbef7f18590daef112dcb5e0b7c0187e3,account start and stopping fixes.
kav-ya,2015-11-06 00:44:43,https://api.github.com/repos/nylas/sync-engine/git/commits/0ed766e381dccc9a97f2333111a8f401abc0906c,0ed766e381dccc9a97f2333111a8f401abc0906c,Recreate EASUid index.
kav-ya,2015-11-04 22:36:18,https://api.github.com/repos/nylas/sync-engine/git/commits/21ec16b82be967ffe5ba0c6ebe214ae3aa7046f6,21ec16b82be967ffe5ba0c6ebe214ae3aa7046f6,"EASUid migration and migration tooling.

Summary:
Migration to drop EASUid UniqueConstraint.
Script to run a migration against all enabled shards.

Test Plan:
Tested locally.
To be tested against staging.

Reviewers: emfree

Reviewed By: emfree

Differential Revision: https://phab.nylas.com/D2233"
khamidou,2015-11-04 20:20:57,https://api.github.com/repos/nylas/sync-engine/git/commits/ebbcf7f8b6ccdb4d87167c65f8c099971938e7fc,ebbcf7f8b6ccdb4d87167c65f8c099971938e7fc,commit the changes when using the --softdelete option.
khamidou,2015-11-04 19:22:37,https://api.github.com/repos/nylas/sync-engine/git/commits/cdab4abbba3fcbc945fb50612539f85e57ceaeab,cdab4abbba3fcbc945fb50612539f85e57ceaeab,"Truncate message-id header

Summary:
Fixes T5576 --- this account was broken because a single email it received had a very long Message-Id header. Given that the spec limits this header to 998, I think it's reasonable to truncate it.

Test Plan: Wrote regression test.

Reviewers: emfree

Reviewed By: emfree

Maniphest Tasks: T5576

Differential Revision: https://phab.nylas.com/D2225"
emfree,2015-11-04 02:12:50,https://api.github.com/repos/nylas/sync-engine/git/commits/10acebe70f876ed7499f933c102b56a38c102457,10acebe70f876ed7499f933c102b56a38c102457,Add new dependency.
khamidou,2015-11-04 02:13:22,https://api.github.com/repos/nylas/sync-engine/git/commits/9a442bdb930d5cde928f64f8037621d0b9c26419,9a442bdb930d5cde928f64f8037621d0b9c26419,fix softdelete option.
emfree,2015-11-04 01:36:27,https://api.github.com/repos/nylas/sync-engine/git/commits/4fa197ce1922bb728550e1d9b9ce3bb4f1472438,4fa197ce1922bb728550e1d9b9ce3bb4f1472438,Remove cruft.
emfree,2015-11-03 21:45:51,https://api.github.com/repos/nylas/sync-engine/git/commits/dc0f920ec0541092b7a225a9545033f3724effdd,dc0f920ec0541092b7a225a9545033f3724effdd,"Enrich sync process instrumentation.

Summary:
Previously, sync processes could make CPU profile data available via an HTTP
interface. Extend this approach to also vend data about which account syncs are
burning CPU time, as well as process memory usage. This can be used for smarter
sync scheduling as well as general diagnostics.

Examples
--------
```
vagrant@precise64:/vagrant$ curl localhost:16384/load
{
  ""idle_fraction"": 0.8340275158537014,
  ""times"": {
    ""changepoller:2:1"": 0.06864523887634277,
    ""contactsync:2"": 0.08022284507751465,
    ""deletehandler:2"": 0.011913537979125977,
    ""devicesyncmonitor:1:2"": 0.14741039276123047,
    ""easfoldersyncengine:1:11:2"": 0.001371622085571289,
    ""easfoldersyncengine:1:12:2"": 0.0020377635955810547,
    ""easfoldersyncengine:1:13:2"": 0.002016782760620117,
    ""easfoldersyncengine:1:14:2"": 0.0016682147979736328,
    ""easfoldersyncengine:1:15:2"": 0.0015306472778320312,
    ""easfoldersyncengine:1:16:2"": 0.0014035701751708984,
    ""easfoldersyncengine:1:18:2"": 0.0013549327850341797,
    ""easfoldersyncengine:1:19:2"": 0.0013511180877685547,
    ""easfoldersyncengine:1:20:2"": 0.0015370845794677734,
    ""eventsync:2"": 0.3499269485473633,
    ""foldersyncengine:2:1"": 21.214745044708252,
    ""hub"": 114.2245078086853,
    ""mailsyncmonitor:1"": 0.011388063430786133,
    ""mailsyncmonitor:2"": 0.010387897491455078,
    ""null"": 0.6152615547180176
  },
  ""total_switches"": 34160,
  ""total_time"": 136.95532298088074
}
```
```
vagrant@precise64:/vagrant$ curl localhost:16384/mem
                                             types |   # objects |   total size
================================================== | =========== | ============
                                              dict |       20512 |     17.49 MB
                                               set |        4856 |      5.83 MB
                                               str |       45593 |      5.13 MB
                                              list |        9779 |      2.78 MB
                                              long |       99763 |      2.66 MB
                                              type |        3074 |      2.65 MB
                                              code |       18399 |      2.25 MB
                                             tuple |       16551 |      1.19 MB
                                           unicode |        4147 |    971.59 KB
                                           weakref |        8073 |    693.77 KB
  <class 'sqlalchemy.util._collections.OrderedDict |         531 |    358.20 KB
                                 datetime.datetime |        7633 |    357.80 KB
                           collections.defaultdict |          48 |    307.12 KB
                                               int |        9772 |    229.03 KB
     <class 'sqlalchemy.sql.visitors.VisitableType |         214 |    188.92 KB

```
```
vagrant@precise64:/vagrant$ curl localhost:16384/profile
 # lots of stack data
```

Test Plan: Run syncs, curl instrumentation endpoints.

Reviewers: kav-ya

Reviewed By: kav-ya

Differential Revision: https://phab.nylas.com/D2223"
emfree,2015-10-28 20:28:23,https://api.github.com/repos/nylas/sync-engine/git/commits/3ad51021e2db9a49ffe71b36c7787cd5987cf5df,3ad51021e2db9a49ffe71b36c7787cd5987cf5df,Fix sign on latency metric.
kav-ya,2015-11-03 16:27:40,https://api.github.com/repos/nylas/sync-engine/git/commits/de83a064bd1b566a6161d762027aff09063be3c0,de83a064bd1b566a6161d762027aff09063be3c0,"Ensure Folder/ Label/ Category name updates respect column length constraints.

Summary:
Fixes T3908

The SQLAlchemy validates() decorator is invoked during instantiation and subsequent
updates, and ensures that the constraints are respected across both sync/ sync-eas code paths.

Test Plan: Regression test included.

Reviewers: emfree

Reviewed By: emfree

Maniphest Tasks: T3908

Differential Revision: https://phab.nylas.com/D2222"
spang,2015-11-01 22:32:51,https://api.github.com/repos/nylas/sync-engine/git/commits/3de9374ca7656886f6521674abb70d12592017e8,3de9374ca7656886f6521674abb70d12592017e8,Fix help text.
khamidou,2015-10-28 20:16:46,https://api.github.com/repos/nylas/sync-engine/git/commits/498a59bafb280f1a26c20d57ef00dd5b2016d965,498a59bafb280f1a26c20d57ef00dd5b2016d965,"Update the account migration tools

Summary: This is the companion diff to D2171. It changes our migration tools to specify a reason when disabling syncs. This way, we can catch the rare times when an account was migrated but never got restarted.

Test Plan: Tested manually.

Reviewers: spang

Reviewed By: spang

Differential Revision: https://phab.nylas.com/D2173"
emfree,2015-10-23 17:04:00,https://api.github.com/repos/nylas/sync-engine/git/commits/617b1d5df83adaf99a822b1e65a8bfde169b6cfb,617b1d5df83adaf99a822b1e65a8bfde169b6cfb,Instrument S3 save latency.
emfree,2015-10-28 03:25:13,https://api.github.com/repos/nylas/sync-engine/git/commits/54fa705130166a822303fe46f732fb0db2638f91,54fa705130166a822303fe46f732fb0db2638f91,"Catch SyntaxError when unpacking RRULEs.

This is causing streaming API requests to fail; catch it for now."
emfree,2015-10-27 00:20:46,https://api.github.com/repos/nylas/sync-engine/git/commits/2bc00d3b6a22cc09740d39cc2e14ebad23818e18,2bc00d3b6a22cc09740d39cc2e14ebad23818e18,Treat another error response in SMTP XOAUTH2 as temp rate-limiting.
kav-ya,2015-10-27 23:46:18,https://api.github.com/repos/nylas/sync-engine/git/commits/e1d38aee2f72ed5a20da61baaa06e01788e80846,e1d38aee2f72ed5a20da61baaa06e01788e80846,Do not include disabled shards since application services do not use them.
kav-ya,2015-10-24 22:33:28,https://api.github.com/repos/nylas/sync-engine/git/commits/6f29d0794727334b5e9c42e9c43f98ae3f4053b2,6f29d0794727334b5e9c42e9c43f98ae3f4053b2,"Verify shard auto_increments are set correctly.

Summary:
These should never be set incorrectly so ensure that cannot happen.
Both existing shards and newly created shards are verified.

Test Plan: Test added.

Reviewers: emfree

Reviewed By: emfree

Differential Revision: https://phab.nylas.com/D2192"
emfree,2015-10-26 19:15:51,https://api.github.com/repos/nylas/sync-engine/git/commits/fdeee59be8feea1c4fac4d9972b3462d128c25f2,fdeee59be8feea1c4fac4d9972b3462d128c25f2,"Handle non-ASCII Gmail labels.

Summary:
Non-ascii values in X-GM-LABELS must be converted from IMAP's modified UTF-7
encoding (see RFC 2060 section 5.1.3 for background on that). IMAPClient does
this automatically for folder names, but not for labels.

Fixes Github issues #212, #221; T4534.

Test Plan: Unit tests added.

Reviewers: khamidou

Reviewed By: khamidou

Differential Revision: https://phab.nylas.com/D2189"
dregitsky,2015-10-26 17:58:08,https://api.github.com/repos/nylas/sync-engine/git/commits/54c9e96846d339eda32efc9d39f191349d3e3a9b,54c9e96846d339eda32efc9d39f191349d3e3a9b,"Speed up batches of redis account folder queries using pipeline

Summary:
Querying redis for account folder heartbeats is done serially, by
account. Sending one request per query is slow when there are a lot
of accounts, so this change uses redis pipelining to batch the
queries.

Test Plan:
Manual verification that queries behave the same using the new
method

Reviewers: emfree

Reviewed By: emfree

Differential Revision: https://phab.nylas.com/D2194"
emfree,2015-10-23 20:36:58,https://api.github.com/repos/nylas/sync-engine/git/commits/d99a8fc3ed3ea7a5aaa1374a0b037526af4a01ca,d99a8fc3ed3ea7a5aaa1374a0b037526af4a01ca,Bump SyncService poll interval.
khamidou,2015-10-21 21:34:06,https://api.github.com/repos/nylas/sync-engine/git/commits/2f4ffa78539bb62634949e65adf39ca17efa4d70,2f4ffa78539bb62634949e65adf39ca17efa4d70,added a regression test.
khamidou,2015-10-21 20:42:32,https://api.github.com/repos/nylas/sync-engine/git/commits/2e623017aab7fa334744f5e458e252a296571591,2e623017aab7fa334744f5e458e252a296571591,fix unicode handling in iCalendar file generation.
emfree,2015-10-21 21:02:20,https://api.github.com/repos/nylas/sync-engine/git/commits/3ed18aa9d05f56b7a807f0a35941964b84c21326,3ed18aa9d05f56b7a807f0a35941964b84c21326,Fix tests.
emfree,2015-10-21 20:26:15,https://api.github.com/repos/nylas/sync-engine/git/commits/9ed32698a534444beddc9ab4bbf42d8f2db7ce85,9ed32698a534444beddc9ab4bbf42d8f2db7ce85,Fix typo.
emfree,2015-10-21 20:11:26,https://api.github.com/repos/nylas/sync-engine/git/commits/4cd429b51d8e3bddd2f76f8d0c7490cb31d7c34f,4cd429b51d8e3bddd2f76f8d0c7490cb31d7c34f,"Fix header encoding on download for long filenames.

Encoding via email.headers.Headers will cause the line to be split at some
small number of characters. Werkzeug subsequently raises
`ValueError: Detected newline in header`. Fix this."
brettgerry,2015-10-20 04:01:27,https://api.github.com/repos/nylas/sync-engine/git/commits/d61caf9e5d35eda22db8d063a83abd559d346307,d61caf9e5d35eda22db8d063a83abd559d346307,"Return 429s instead of 503s when provider is throttling

Summary:
Instead of 429s return 503s and the message ""Temporary provider send
throttling""

Test Plan: Ran unit tests in test_sending.py

Reviewers: emfree

Reviewed By: emfree

Subscribers: kav-ya, spang

Differential Revision: https://phab.nylas.com/D2172"
grinich,2015-10-19 18:31:56,https://api.github.com/repos/nylas/sync-engine/git/commits/3d61edab4f21c12e1d7f844e537b3f4cc12af6e1,3d61edab4f21c12e1d7f844e537b3f4cc12af6e1,"Merge pull request #220 from masylum/feature/allow-content-type-headers

Allow Content-Type headers"
emfree,2015-10-18 20:40:33,https://api.github.com/repos/nylas/sync-engine/git/commits/019160ce55d955afc0312fa34344a9fa16e29c65,019160ce55d955afc0312fa34344a9fa16e29c65,Fix session_scope call in bin/delete-account-data.
masylum,2015-10-18 11:29:00,https://api.github.com/repos/nylas/sync-engine/git/commits/9a7c9eb2942d0c48758ddfe67d00708a68e9859e,9a7c9eb2942d0c48758ddfe67d00708a68e9859e,Allow Content-Type headers
emfree,2015-10-16 23:59:03,https://api.github.com/repos/nylas/sync-engine/git/commits/ea4a9ecbc7cf6217abee0a21bede43589643adfb,ea4a9ecbc7cf6217abee0a21bede43589643adfb,Silence warnings on queries with binary literals for MySQL 5.6.27.
spang,2015-10-16 03:09:21,https://api.github.com/repos/nylas/sync-engine/git/commits/0b9525e8d45c091461d5eae6ab8d0c443780687d,0b9525e8d45c091461d5eae6ab8d0c443780687d,Coerce options.account_id to an int
spang,2015-10-16 03:03:56,https://api.github.com/repos/nylas/sync-engine/git/commits/9ac72f6b9edba593afa28ff94a22e48927751a08,9ac72f6b9edba593afa28ff94a22e48927751a08,Fix start-stop-account
emfree,2015-10-15 23:33:38,https://api.github.com/repos/nylas/sync-engine/git/commits/c045be92cc5725d31d37e9e4621b9151d26255a6,c045be92cc5725d31d37e9e4621b9151d26255a6,Add wrongly removed line in setup.sh.
emfree,2015-10-15 06:15:34,https://api.github.com/repos/nylas/sync-engine/git/commits/e5877e7029a387f90d9b8ad472cbce61706e2d2a,e5877e7029a387f90d9b8ad472cbce61706e2d2a,Fix typo in SMTP OAuth token refresh.
kav-ya,2015-10-13 21:03:26,https://api.github.com/repos/nylas/sync-engine/git/commits/bb9c0d6ecddfecf07bd0d8f96bb618815fdd3d71,bb9c0d6ecddfecf07bd0d8f96bb618815fdd3d71,"Shard utility functions.

Summary:
Concomitant diff to D2161.
Introduce utility functions to expose shards/ open shards
so consumers need not be aware of the underlying implementation
of the engine_manager.

Test Plan: Tested via the consumer functions.

Reviewers: emfree

Reviewed By: emfree

Differential Revision: https://phab.nylas.com/D2162"
emfree,2015-10-14 22:04:15,https://api.github.com/repos/nylas/sync-engine/git/commits/d5ccf6c3764be16e755498d07b17cfe808514fc7,d5ccf6c3764be16e755498d07b17cfe808514fc7,Don't look for eas code in setup.sh
emfree,2015-10-14 04:50:08,https://api.github.com/repos/nylas/sync-engine/git/commits/fc62ce15bc0916ccf5831650bf2afc1e1c293723,fc62ce15bc0916ccf5831650bf2afc1e1c293723,Remove noisy/not useful log statement.
emfree,2015-10-14 01:31:07,https://api.github.com/repos/nylas/sync-engine/git/commits/ac28a152e7d5794b624cc68a42acb0c2e138fda1,ac28a152e7d5794b624cc68a42acb0c2e138fda1,"Remove silly grant statement from create-db script.

Establishing user privileges should probably be done separately -- will deal
with that shortly."
emfree,2015-10-13 23:47:21,https://api.github.com/repos/nylas/sync-engine/git/commits/548a99c56c3f6f8aa9f0930574dd71ec3d0267d4,548a99c56c3f6f8aa9f0930574dd71ec3d0267d4,Declare missing indices.
emfree,2015-10-13 20:58:15,https://api.github.com/repos/nylas/sync-engine/git/commits/8e50c40442be42a86d9e05a28fddd9d358f8e678,8e50c40442be42a86d9e05a28fddd9d358f8e678,"Allow alembic revisions to run against 'disabled' shards.

A disabled shard is one which does not receive sync or API traffic, but it's
reasonable that you'd want to apply migrations to it (for example, if you're
bootstrapping a new shard)."
emfree,2015-10-13 20:57:46,https://api.github.com/repos/nylas/sync-engine/git/commits/15ff86ff45e334f60d6eb860da66a0c4c54d038f,15ff86ff45e334f60d6eb860da66a0c4c54d038f,"Fix typo in setup.sh

We really oughta deprecate this script..."
emfree,2015-10-13 18:10:25,https://api.github.com/repos/nylas/sync-engine/git/commits/a7735ae92a734aa386eba91eb92cbf69e27c6f6f,a7735ae92a734aa386eba91eb92cbf69e27c6f6f,Fix list of scripts included in setup.py.
emfree,2015-10-13 04:35:37,https://api.github.com/repos/nylas/sync-engine/git/commits/673a0900c39036e3f0d50fa59f962689432b54cd,673a0900c39036e3f0d50fa59f962689432b54cd,Limit bin/create-db by host rather than shard set.
emfree,2015-10-13 02:41:56,https://api.github.com/repos/nylas/sync-engine/git/commits/1945c651c26667bfba862893d9e79307aac40746,1945c651c26667bfba862893d9e79307aac40746,"Restructure shard configuration.

This makes it easier to generate the configuration file from a host inventory.
It will also hopefully makes things easier if we switch to one-pool-per-host
rather than one-pool-per-shard."
emfree,2015-10-12 22:34:25,https://api.github.com/repos/nylas/sync-engine/git/commits/4966470cf284be615838f0a9ffcda3977f02f942,4966470cf284be615838f0a9ffcda3977f02f942,Minimally update alembic configuration for sharding.
kav-ya,2015-10-12 20:48:26,https://api.github.com/repos/nylas/sync-engine/git/commits/f7bf770970b7e1ff7ecd8986f14f6f023d4f9e9f,f7bf770970b7e1ff7ecd8986f14f6f023d4f9e9f,Update bin/inbox-auth.
kav-ya,2015-10-11 21:09:05,https://api.github.com/repos/nylas/sync-engine/git/commits/ece7f6c8d271b8cedaf1413475dfebcab1e4ef9e,ece7f6c8d271b8cedaf1413475dfebcab1e4ef9e,"[Sharding] Auth changes II

* Support for two-phase commit.
* account_for_id() takes `target` shard_id; does not use global query.
* Updated configs."
emfree,2015-10-12 04:43:35,https://api.github.com/repos/nylas/sync-engine/git/commits/3d667f25d6380ad0258137159fa2a049197ef8b7,3d667f25d6380ad0258137159fa2a049197ef8b7,Update contact search indexing to work with multiple shards.
spang,2015-10-12 02:20:31,https://api.github.com/repos/nylas/sync-engine/git/commits/310c5dee2eb414f84f0d47ea84a9b774db7b0da1,310c5dee2eb414f84f0d47ea84a9b774db7b0da1,"Allow limiting bin/create-db to specific shards.

This allows us to use it to initialize new database hosts in production."
kav-ya,2015-10-10 22:44:09,https://api.github.com/repos/nylas/sync-engine/git/commits/0cd57b79b77a66e74bfc033fdb9f0fa255dc49a6,0cd57b79b77a66e74bfc033fdb9f0fa255dc49a6,"[Sharding] Auth changes I

State of testing
----------------
Existing tests adapted to pass.
Need tests for new functions:
account_or_none(), session_scope_by_shard_id(), get_for_shard_id(), commit_account()"
emfree,2015-10-11 01:48:18,https://api.github.com/repos/nylas/sync-engine/git/commits/244a70d405550c55a35918df7f3ba1e4d7b9d886,244a70d405550c55a35918df7f3ba1e4d7b9d886,Support sharding (5/5): Update API preprocessing.
emfree,2015-10-10 01:57:14,https://api.github.com/repos/nylas/sync-engine/git/commits/61401fcf279932d6ed7e35163aaaa3e5498b8556,61401fcf279932d6ed7e35163aaaa3e5498b8556,"Support sharding (4/5): tests.

Two test databases are now provisioned in order to specifically test
functionality like account sync scheduling. Most tests just hit one though."
emfree,2015-10-10 01:35:57,https://api.github.com/repos/nylas/sync-engine/git/commits/e29bf2139d14c11a51753acb0871ea1f7eb82972,e29bf2139d14c11a51753acb0871ea1f7eb82972,"Support sharding (3/5): engines and sessions.

A single global EngineManager maintains a mapping of shard ids to SQLAlchemy
engines. session_scope() now takes its id parameter and uses the appropriate
engine. A global_session_scope() is available for those few cases where queries
span multiple shards, but should be used only for reads, and then with caution,
because many nontrivial query patterns (COUNT, GROUP BY, etc.) will not work."
emfree,2015-10-10 01:19:39,https://api.github.com/repos/nylas/sync-engine/git/commits/04ae219d1230add1f7facc9d4f7094dd2f5cde89,04ae219d1230add1f7facc9d4f7094dd2f5cde89,"Support sharding(2/5): update declarative models.

Update declarative models to support 64-bit primary keys."
emfree,2015-10-03 22:48:10,https://api.github.com/repos/nylas/sync-engine/git/commits/10a25e9153b1fcc516d771ed61e96906ec58e272,10a25e9153b1fcc516d771ed61e96906ec58e272,"Support sharding (1/5): make session_scope take a key param.

Currently, this does nothing, but soon the key will be used to point the
session at the appropriate shard."
emfree,2015-10-03 22:35:30,https://api.github.com/repos/nylas/sync-engine/git/commits/bcbc46e29f6464073b8fc77b11307a6ec24670df,bcbc46e29f6464073b8fc77b11307a6ec24670df,Remove obsolete scripts in bin/.
grinich,2015-10-12 23:34:45,https://api.github.com/repos/nylas/sync-engine/git/commits/3af96a67eca64a8922b3440a76104347f1e46a05,3af96a67eca64a8922b3440a76104347f1e46a05,Revert TravisCI stuff. Now on travis-ci branch
grinich,2015-10-12 23:26:54,https://api.github.com/repos/nylas/sync-engine/git/commits/34d4a6d66b2ec1469a4092e0c9f292c1b5e724f1,34d4a6d66b2ec1469a4092e0c9f292c1b5e724f1,ci MySQL host
grinich,2015-10-12 23:26:10,https://api.github.com/repos/nylas/sync-engine/git/commits/2cfbb7ae7364f5bb07aa838f2a62241e7ca0e29b,2cfbb7ae7364f5bb07aa838f2a62241e7ca0e29b,another ci attempt
grinich,2015-10-12 23:02:49,https://api.github.com/repos/nylas/sync-engine/git/commits/2b073341b12961f65a94dc015a9015e5cbbaaa17,2b073341b12961f65a94dc015a9015e5cbbaaa17,img link
grinich,2015-10-12 23:02:04,https://api.github.com/repos/nylas/sync-engine/git/commits/77a7d9e310766918d8b456d496596f9ca59aba0c,77a7d9e310766918d8b456d496596f9ca59aba0c,Add build img
grinich,2015-10-12 22:38:35,https://api.github.com/repos/nylas/sync-engine/git/commits/e6cfd32c293031a7eeed39c20df5835ed97169e8,e6cfd32c293031a7eeed39c20df5835ed97169e8,no more zmq
grinich,2015-10-12 22:32:20,https://api.github.com/repos/nylas/sync-engine/git/commits/9b978aa6bd40c04bd180fa847e48f78174baebb0,9b978aa6bd40c04bd180fa847e48f78174baebb0,sudo make me a travisci
grinich,2015-10-12 22:18:09,https://api.github.com/repos/nylas/sync-engine/git/commits/9850b48ecd595f3e6b6b9fa0c1fd37ef57c68d7d,9850b48ecd595f3e6b6b9fa0c1fd37ef57c68d7d,Attempt TravisCI build config
emfree,2015-10-09 20:30:32,https://api.github.com/repos/nylas/sync-engine/git/commits/d7e365eaa9016e956538a3bbf858bf283ebc2bae,d7e365eaa9016e956538a3bbf858bf283ebc2bae,Use better logic for preemptive send timeouts.
kav-ya,2015-10-10 00:00:13,https://api.github.com/repos/nylas/sync-engine/git/commits/49efcb839e7744803a322b7a38a2fe2fc4488cb8,49efcb839e7744803a322b7a38a2fe2fc4488cb8,"Don't hold a database session open for the entire duration of connecting and
authenticating with a Gmail/ generic IMAP backend.

Summary:
The `_new_raw_connection()` function is unsurprisingly, consistently among
the leading culprits of holding long database sessions open (~1 minute long).

Test Plan:
Verified the account object in `connect_account()` is not attached to a database session.
Tested auth and sync works for a Gmail and Yahoo account.
Sync and redwood unit tests pass.

Reviewers: emfree

Reviewed By: emfree

Differential Revision: https://phab.nylas.com/D2142"
spang,2015-10-10 17:45:40,https://api.github.com/repos/nylas/sync-engine/git/commits/db60871c04f5adefee848097d4c5f98e10f6f599,db60871c04f5adefee848097d4c5f98e10f6f599,"Don't tell lies in comments, and strip bad codepoints in email addresses too.

The whackness is coming from us/email, not Exchange."
spang,2015-10-10 07:07:42,https://api.github.com/repos/nylas/sync-engine/git/commits/c4f4ed9ff97e8aaca2e7f35cb76755eb2fe4dd92,c4f4ed9ff97e8aaca2e7f35cb76755eb2fe4dd92,More bad codepoints.
spang,2015-10-10 07:04:38,https://api.github.com/repos/nylas/sync-engine/git/commits/e63fe10a894bff55511964e5296b524c16d97159,e63fe10a894bff55511964e5296b524c16d97159,"Batch fetch contacts during contact-search-index.

WAY FASTER."
khamidou,2015-10-09 17:29:23,https://api.github.com/repos/nylas/sync-engine/git/commits/22dc0429a5dbd08116f239c058134128bcb2a2bb,22dc0429a5dbd08116f239c058134128bcb2a2bb,"Remove @retry_crispin from generic IMAP actions.

Summary:
This fixes a bug one of our customers are having. They reported that we wouldn't save the mail we sent in the ""Sent"" folder. This is what the actionlog looks like for this actual user:
```
mysql> select action, status, record_id, retries from actionlog where namespace_id = 5154
+-----------------+---------+-----------+---------+
| action          | status  | record_id | retries |
+-----------------+---------+-----------+---------+
| create_folder   | pending |    120544 |       0 |
| create_folder   | pending |    120549 |       0 |
| create_folder   | pending |    120550 |       0 |
| create_folder   | pending |    120551 |       0 |
| create_folder   | pending |    120552 |       0 |
| create_folder   | pending |    120553 |       0 |
| create_folder   | pending |    120554 |       0 |
| create_folder   | pending |    120555 |       0 |
| save_draft      | pending | 109237518 |       0 |
| delete_draft    | pending | 109237518 |       0 |
| save_sent_email | pending | 109237518 |       0 |
...
```

How come those actions all have zero retries? Digging into the logs, we can see the following ImapClient error:
`Client tried to access nonexistent namespace. (Mailbox name should probably be prefixed with: INBOX.)'`. Here's the catch though: because the first action for the account is wrapped into `retry_crispin`, the crispin client will discard the connection and retry *forever*, thus blocking the actionlog for this account.

This diff remove `retry_crispin` for all the generic IMAP action. There's no sense retrying forever. In the worst case we could just bump the number of retries in the actionlog worker.

Test Plan: Stared at the code.

Reviewers: emfree

Reviewed By: emfree

Differential Revision: https://phab.nylas.com/D2127"
spang,2015-10-09 17:28:34,https://api.github.com/repos/nylas/sync-engine/git/commits/272bd07dd69d05bf765f49df29f8b91f38290a2a,272bd07dd69d05bf765f49df29f8b91f38290a2a,"Hint bad query optimization in contact indexer and other perf fixes.

Summary:
Other fixes in here:
* not sleeping while holding a transaction
* adding a joinedload on PhoneNumber in some cases, since we no longer
  eager load them by default
* fixing the index name which was added in migration 033 (seems the
  `table_name` column was since changed to `object_type`, but the index
  name on staging and production remain the old name)

Test Plan: manual

Reviewers: emfree

Reviewed By: emfree

Differential Revision: https://phab.nylas.com/D2136"
emfree,2015-10-08 23:21:42,https://api.github.com/repos/nylas/sync-engine/git/commits/c20a64259170a35b2dcdb93d39d22e25a3713737,c20a64259170a35b2dcdb93d39d22e25a3713737,Configure SENTRY_DSN in syncback service.
spang,2015-10-09 02:19:32,https://api.github.com/repos/nylas/sync-engine/git/commits/3f69d361179d0ba3f9b4625c2b38eecdd0f87304,3f69d361179d0ba3f9b4625c2b38eecdd0f87304,"Another bad codepoint.

Should probably figure out what actual classes of codepoints are bad
eventually, rather than shooting them down one by one..."
spang,2015-10-09 01:34:27,https://api.github.com/repos/nylas/sync-engine/git/commits/2c8ac7061c90cf0d7868f4eaa7909d1624e30b31,2c8ac7061c90cf0d7868f4eaa7909d1624e30b31,Make sure config overrides are loaded in contact-search-service
kav-ya,2015-10-08 23:56:39,https://api.github.com/repos/nylas/sync-engine/git/commits/afff11dc90f202394b1cbe533f439188d881105c,afff11dc90f202394b1cbe533f439188d881105c,Commit more frequently during message deduplication.
emfree,2015-10-08 22:53:59,https://api.github.com/repos/nylas/sync-engine/git/commits/1633ca423896ca0712d0224b4f2769a81e31f66b,1633ca423896ca0712d0224b4f2769a81e31f66b,Fix default args for MockIMAPClient.select_folder.
kav-ya,2015-10-08 22:46:05,https://api.github.com/repos/nylas/sync-engine/git/commits/3510928d38eaa0c66b432b173735486b50aaf1df,3510928d38eaa0c66b432b173735486b50aaf1df,Commit once only.
emfree,2015-10-08 22:33:09,https://api.github.com/repos/nylas/sync-engine/git/commits/f69fae7854026d72cc55d891ef105e9b771cf783,f69fae7854026d72cc55d891ef105e9b771cf783,Fix folder selection in draft deletion.
emfree,2015-10-08 20:07:04,https://api.github.com/repos/nylas/sync-engine/git/commits/ba6563ca9433dbe9720343385fb2d15cd82f50d3,ba6563ca9433dbe9720343385fb2d15cd82f50d3,"Commit aggressively in IMAP flags refresh/deletion.

Helps prevent super long transactions from occurring."
kav-ya,2015-10-08 20:22:16,https://api.github.com/repos/nylas/sync-engine/git/commits/ed443105d9463d21798f13b714021660255c0ce8,ed443105d9463d21798f13b714021660255c0ce8,Commit after processing each message in remove_deleted_uids().
emfree,2015-10-07 20:37:36,https://api.github.com/repos/nylas/sync-engine/git/commits/568623b61e4b534961e0019f6adc1fd3c25cf902,568623b61e4b534961e0019f6adc1fd3c25cf902,Impose sending timeout.
khamidou,2015-10-07 13:02:35,https://api.github.com/repos/nylas/sync-engine/git/commits/4f90903cb4043e1e0485e6bda164913fa2a4bcf1,4f90903cb4043e1e0485e6bda164913fa2a4bcf1,"Change `start-stop-account` to also accept parameters throught stdin.
examples:
bin/list-accounts --host precise64 --paying | start-stop-account --start --stdin
echo 'karim@nylas.com	account_id' | start-stop-account --start --stdin"
emfree,2015-10-07 02:35:01,https://api.github.com/repos/nylas/sync-engine/git/commits/e9d3b742cccfe7ffe1c6b7db963abf612542885e,e9d3b742cccfe7ffe1c6b7db963abf612542885e,"Do not start duplicate folder syncs.

Summary:
Previously, an uncaught exception in start_new_folder_sync_engines() would
cause a duplicate set of folder syncs to be started, because the set `folders`
of syncing folders would wrongly be reset to the empty set.

Test Plan: Manual.

Reviewers: kav-ya

Reviewed By: kav-ya

Differential Revision: https://phab.nylas.com/D2123"
spang,2015-10-06 00:18:00,https://api.github.com/repos/nylas/sync-engine/git/commits/4cfce2405a31db752721e49d0f0591db712116c2,4cfce2405a31db752721e49d0f0591db712116c2,Allow 'invalid' accounts to be considered deleted.
kav-ya,2015-10-05 22:11:04,https://api.github.com/repos/nylas/sync-engine/git/commits/b255ec1c2f13a89d06133cc34f7f55f94e61f6d3,b255ec1c2f13a89d06133cc34f7f55f94e61f6d3,"Turn on throttling after THROTTLE_COUNT messages downloaded.

Summary: Set to 200 for now.

Test Plan: Will manually test for Gmail, generic IMAP accounts before landing.

Reviewers: emfree

Reviewed By: emfree

Differential Revision: https://phab.nylas.com/D2112"
emfree,2015-10-05 22:27:37,https://api.github.com/repos/nylas/sync-engine/git/commits/5d57f6348982ef2848a9dee87c8d0053484eec3d,5d57f6348982ef2848a9dee87c8d0053484eec3d,Commit more frequently in contacts/events sync.
spang,2015-10-05 21:46:18,https://api.github.com/repos/nylas/sync-engine/git/commits/f1bc2ebcb62feebc604576c121bb7ca454371c17,f1bc2ebcb62feebc604576c121bb7ca454371c17,"Merge pull request #201 from toke/patch-1

Fix git clone link to be accessible from anon user"
kav-ya,2015-10-05 20:15:35,https://api.github.com/repos/nylas/sync-engine/git/commits/9fa6f920a5c06a68e20417cbd3117fb59baad882,9fa6f920a5c06a68e20417cbd3117fb59baad882,"Reintroduce throttling for IMAP/ Gmail initial sync.

Summary: To help with N1 launch database load issues.

Test Plan: Manually tested a generic IMAP, Gmail sync with account.throttled=True and False.

Reviewers: emfree

Reviewed By: emfree

Differential Revision: https://phab.nylas.com/D2110"
toke,2015-10-05 17:18:34,https://api.github.com/repos/nylas/sync-engine/git/commits/b002a6e58d21572344f64dbecd93674c501c8fa0,b002a6e58d21572344f64dbecd93674c501c8fa0,Fix git clone link to be accessible from anon user
spang,2015-10-04 19:16:16,https://api.github.com/repos/nylas/sync-engine/git/commits/60afc6147b35e792015d94e1da95597d75f4d54b,60afc6147b35e792015d94e1da95597d75f4d54b,"Explicitly specify index name in contacts API.

MySQL still gets it wrong."
spang,2015-10-04 18:59:02,https://api.github.com/repos/nylas/sync-engine/git/commits/f96f931eda754ed2cc5a3a52f3a9a7d1b374a117,f96f931eda754ed2cc5a3a52f3a9a7d1b374a117,"Don't order contact results by the primary key.

This induces the MySQL query planner into extreme confusion for some
accounts, skipping use of the proper index and resulting in contact
queries that take MINUTES to execute."
spang,2015-10-04 01:21:15,https://api.github.com/repos/nylas/sync-engine/git/commits/2abb92a3e89e614013300d5069c280c22e22a5a8,2abb92a3e89e614013300d5069c280c22e22a5a8,"No search config in dev by default.

Pinging cloudsearch for the service endpoints every time in dev mode is
super annoying. If you're specifically working on search, you can add to
your config locally."
emfree,2015-10-03 18:31:46,https://api.github.com/repos/nylas/sync-engine/git/commits/3fd832368b07cfe9a34ae87d13495935ed0cf88e,3fd832368b07cfe9a34ae87d13495935ed0cf88e,Remove problematic eager load.
spang,2015-10-03 06:51:59,https://api.github.com/repos/nylas/sync-engine/git/commits/661e13051ac7c21316499b44bc3ffb925ab9d4c6,661e13051ac7c21316499b44bc3ffb925ab9d4c6,More bad codepoints
spang,2015-10-03 06:48:40,https://api.github.com/repos/nylas/sync-engine/git/commits/f689c73ee5b801172a63b3dd19277e9fcd626d4f,f689c73ee5b801172a63b3dd19277e9fcd626d4f,Strip bad codepoints from cloudsearch document upload.
spang,2015-10-02 23:46:57,https://api.github.com/repos/nylas/sync-engine/git/commits/1326f37d2a7c25ae7bfb6a4de044b57b4221e8c5,1326f37d2a7c25ae7bfb6a4de044b57b4221e8c5,"Calendar webhooks tweaks.

* don't try to close db session if we don't have a db object
  (if e.g. somewhere else in the app has short-circuited out
   of the request)
* make route argument names consist with other routes
  (makes it easier to test with dummy args)"
emfree,2015-10-01 21:24:53,https://api.github.com/repos/nylas/sync-engine/git/commits/dae94ada8c7327255dabb952314a34e9bf13c2cc,dae94ada8c7327255dabb952314a34e9bf13c2cc,Fix miscellaneous flake8 errors.
emfree,2015-10-01 20:49:14,https://api.github.com/repos/nylas/sync-engine/git/commits/e299ed5fd68e04dff3c815c96b10daa18fd8f95b,e299ed5fd68e04dff3c815c96b10daa18fd8f95b,"Handle varying phrases on ""noreply"" addresses.

Previously, we'd just save the first phrase that we saw, giving misleading
results. Instead, set the name to be empty. This is real messy, but an
improvement for now, pending a bigger redesign of contacts sync and API."
emfree,2015-10-01 20:15:46,https://api.github.com/repos/nylas/sync-engine/git/commits/7c2734308964fbe38b4bf6e99ee3d28e7f90b7dc,7c2734308964fbe38b4bf6e99ee3d28e7f90b7dc,Avoid duplicating contacts in Google contacts sync.
spang,2015-10-01 21:07:35,https://api.github.com/repos/nylas/sync-engine/git/commits/c91b6f0f82118aac4fd4904155ba40b7acdc84f5,c91b6f0f82118aac4fd4904155ba40b7acdc84f5,"Clearer variable name.

This code was copied from the indexing function and doesn't really make
sense here."
spang,2015-10-01 21:07:08,https://api.github.com/repos/nylas/sync-engine/git/commits/93deb5a8cceb57cf8a9f813936a8be34f7622e19,93deb5a8cceb57cf8a9f813936a8be34f7622e19,Strip non-numeric characters from phone numbers before indexing
emfree,2015-09-30 22:13:24,https://api.github.com/repos/nylas/sync-engine/git/commits/edecd2264406998b0759bd3e829503501f8447fc,edecd2264406998b0759bd3e829503501f8447fc,"Remove explicit futures dependency.

Not actually directly needed by sync engine code; prior dependency conflicts
with boto3."
emfree,2015-09-30 22:08:31,https://api.github.com/repos/nylas/sync-engine/git/commits/dd17c30ff3366497b789adec2040f3283c900161,dd17c30ff3366497b789adec2040f3283c900161,Require boto3 in setup.py.
spang,2015-09-30 21:41:47,https://api.github.com/repos/nylas/sync-engine/git/commits/00ab3bdb65c809469122d37ef345aef7bb86ef54,00ab3bdb65c809469122d37ef345aef7bb86ef54,Fix logging import
spang,2015-09-30 21:31:50,https://api.github.com/repos/nylas/sync-engine/git/commits/14c814f606c3e3049e1f4b99305540b1fd9e2800,14c814f606c3e3049e1f4b99305540b1fd9e2800,Install contact search index scripts.
spang,2015-09-30 21:16:33,https://api.github.com/repos/nylas/sync-engine/git/commits/3319e8963716d1bf6880c0d9724078d19e3eba65,3319e8963716d1bf6880c0d9724078d19e3eba65,"Basic contacts searching through Amazon CloudSearch.

Summary:
This patch includes an adaptation of our old elasticsearch transaction log
indexer to index contacts with Amazon CloudSearch. If cloudsearch is not
configured, using the contacts endpoint returns no results.

Test Plan: Manual testing. Unit tests coming pending validation of design.

Reviewers: emfree

Reviewed By: emfree

Differential Revision: https://phab.nylas.com/D2088"
emfree,2015-09-25 04:16:08,https://api.github.com/repos/nylas/sync-engine/git/commits/f827a26aea9afe3bceb58c73e1f5716e198208b3,f827a26aea9afe3bceb58c73e1f5716e198208b3,"Rework draft update syncback for robustness.

Summary:
Fixes T3779. Previously, a draft update would be synced back as a ""save_draft""
action followed by a ""delete_draft"" action. The problem with the prior
implementation is that the save_draft action becomes a no-op if the draft has
subsequently been updated. So the delete can execute, causing the draft to
transiently vanish altogether from the backend.

Instead, schedule a single ""update_draft"" action, which proceeds as follows:

(1) Check if the draft already exists on the backend
(2) If not, create it.
(3) Delete any older versions on the backend.

This implementation satisfies the following properties:

* At least one version of the draft always exists on the backend, preventing
  transient deletions.
* The action can safely be retried if it fails partway through.

Test Plan:
Manual for now. Working on tests. You can fairly reliably reproduce
the original bug by creating a draft and updating it every few seconds until
you get a 404.

Reviewers: ethanb

Reviewed By: ethanb

Subscribers: kav-ya

Maniphest Tasks: T3779

Differential Revision: https://phab.nylas.com/D2077"
emfree,2015-09-24 21:48:42,https://api.github.com/repos/nylas/sync-engine/git/commits/06e88c53b9c311119a7ecb7e0950f4679dacfd92,06e88c53b9c311119a7ecb7e0950f4679dacfd92,"Double-check for new UIDs before removing deleted UIDs.

This patch is for CONDSTORE sync only."
emfree,2015-09-29 20:48:13,https://api.github.com/repos/nylas/sync-engine/git/commits/9ddad1708d2992dd74ca321d505377351bd419ee,9ddad1708d2992dd74ca321d505377351bd419ee,"Refine database transaction instrumentation.

Confusingly, the `after_transaction_create` event only fires after a database
flush, and not after a normal database transaction `BEGIN`. This means that if
you do something like

```
with session_scope() as db_session:
  a = db_session.query(Account).get(account_id)  # <- ""BEGIN"" is issued here
  gevent.sleep(22)  # or go do something else
  db_session.commit()                            # <- ""COMMIT"" is issued here
```

the 22-second lifetime of the underlying database transaction will not actually
be captured by the after_transaction_create / after_transaction_end events.

So use the `after_begin` / `after_commit` / `after_rollback` events instead."
emfree,2015-09-29 21:12:23,https://api.github.com/repos/nylas/sync-engine/git/commits/9f8312c9844cd5be8f3d20ee9810bfe994d410ed,9f8312c9844cd5be8f3d20ee9810bfe994d410ed,Print more in data deletion so we have some notion of progress.
emfree,2015-09-20 06:20:21,https://api.github.com/repos/nylas/sync-engine/git/commits/40b5d29aed63f3a9ea948bb8c04a7af2f914d493,40b5d29aed63f3a9ea948bb8c04a7af2f914d493,"Prevent spurious revision of Calendar objects.

Currently, transaction records for calendars are committed every time the
last_synced field is updated, which is not correct. Fix this."
emfree,2015-09-29 03:52:05,https://api.github.com/repos/nylas/sync-engine/git/commits/bec2ba1903cce1fc581bade8e178c91f4c3907a5,bec2ba1903cce1fc581bade8e178c91f4c3907a5,"Handle sporadic ""SSLError: EOF occurred ..."" in calendar sync."
emfree,2015-09-29 03:43:20,https://api.github.com/repos/nylas/sync-engine/git/commits/d8f2eee2369833ac837bd56699bd4b1e486288ad,d8f2eee2369833ac837bd56699bd4b1e486288ad,Properly format exception message for non-ascii folder names.
emfree,2015-09-29 03:38:03,https://api.github.com/repos/nylas/sync-engine/git/commits/217581c379357a88c72c64881abec72e9d58b498,217581c379357a88c72c64881abec72e9d58b498,Bump interim imapclient version and remove quoting workaround.
emfree,2015-09-29 00:43:40,https://api.github.com/repos/nylas/sync-engine/git/commits/351a331b0abc6141578bf3b4b29743111743da16,351a331b0abc6141578bf3b4b29743111743da16,"Only create contact objects from valid message recipients.

In particular, this prevents contacts from being created from garbage
recipients during draft composition.

Fixes T3431."
emfree,2015-09-27 00:57:20,https://api.github.com/repos/nylas/sync-engine/git/commits/86b18ba47a90f5f28da52df617aeafcfa72d0ff9,86b18ba47a90f5f28da52df617aeafcfa72d0ff9,"Save name attribute on generic accounts.

Fixes T3850."
emfree,2015-09-25 22:15:52,https://api.github.com/repos/nylas/sync-engine/git/commits/f7869f959c8592c45507b0ff18ccc87c809bcd8b,f7869f959c8592c45507b0ff18ccc87c809bcd8b,"Revert ""Upgrade setuptools""

This reverts commit 1292141f0ec2eb9ed5f872269f5272e39a23dc5a.

Reason for rollback: breaks starttls with imapclient 0.13."
spang,2015-09-25 20:53:56,https://api.github.com/repos/nylas/sync-engine/git/commits/a780e2a913dfe035fd3c8fba8b77789fb1c96811,a780e2a913dfe035fd3c8fba8b77789fb1c96811,start-stop-account: Print usage and exit if no email or account ID specified
emfree,2015-09-25 19:09:59,https://api.github.com/repos/nylas/sync-engine/git/commits/60904161b3388000cdeea6d6cd2903d0f36682df,60904161b3388000cdeea6d6cd2903d0f36682df,Catch UnicodeDecodeError in message parsing.
emfree,2015-09-25 17:25:01,https://api.github.com/repos/nylas/sync-engine/git/commits/9f882cd654b4790852e34598eaf096ce40d40f7a,9f882cd654b4790852e34598eaf096ce40d40f7a,"Remove SIGTERM handlers from service scripts.

Summary:
The existing signal handling was useless at best and actively harmful at worst.
In particular, it meant that sync processes running an unduly blocking greenlet
would not exit in a timely manner. The following script illustrates this
problem (it will fail to exit upon receiving SIGTERM):

```
import gevent
import gevent.monkey
gevent.monkey.patch_all()
import signal

class Service(object):
    def __init__(self):
        self.keep_running = True

    def run(self):
        gevent.spawn(bad_blocking_greenlet)
        while self.keep_running:
            gevent.sleep(1)

    def stop(self):
        self.keep_running = False

def bad_blocking_greenlet():
    while True:
        pass

s = Service()
signal.signal(signal.SIGTERM, lambda signum, frame: s.stop())
s.run()
```

Test Plan: kill -15.

Reviewers: khamidou

Reviewed By: khamidou

Differential Revision: https://phab.nylas.com/D2066"
spang,2015-09-25 02:03:28,https://api.github.com/repos/nylas/sync-engine/git/commits/6fc2a060823cdf75befa6b37d1ee3ea4285548c8,6fc2a060823cdf75befa6b37d1ee3ea4285548c8,"Use a class variable for PhoneNumber column lengths.

This enables sync code to use the constant to sanitize data before
creating model instances and not risk a hard-coded constant getting out
of date."
spang,2015-09-25 01:48:00,https://api.github.com/repos/nylas/sync-engine/git/commits/3284c5550a27c5149b31656fe5a7d6e7ddfad8aa,3284c5550a27c5149b31656fe5a7d6e7ddfad8aa,"Base support for contact phone numbers.

Summary:
This is an experimental new feature. This patch adds a new ""PhoneNumber""
model, which has a many-to-one relationship with Contacts, and modifies the
API to return the data in the spec'd out format, if it exists.

For performance reasons, the relationship is set to automatically do a joined
load with contacts. This seems reasonable to me, and I verified that it speeds
up API responses, but let me know if there's anywhere you think it doesn't make
sense to automatically load phone numbers with contacts. They're going to be
a pretty essential part of contacts.

Test Plan: Manual testing. API unit tests will be added once Google sync support is implemented. Sync unit tests for the Exchange support are included in the (forthcoming) Exchange patch.

Reviewers: emfree

Reviewed By: emfree

Subscribers: brett

Differential Revision: https://phab.nylas.com/D2068"
emfree,2015-09-24 20:50:06,https://api.github.com/repos/nylas/sync-engine/git/commits/86e7f41bad24d1e9bc548b59623c60d6884c981e,86e7f41bad24d1e9bc548b59623c60d6884c981e,"Fix typo.

http://i.imgur.com/2ngZocA.gif"
emfree,2015-09-24 19:44:42,https://api.github.com/repos/nylas/sync-engine/git/commits/ca87c507ee938fbfc1021ece25d1e9bb99948161,ca87c507ee938fbfc1021ece25d1e9bb99948161,Properly handle empty results in Gmail search proxy.
emfree,2015-09-24 18:16:37,https://api.github.com/repos/nylas/sync-engine/git/commits/2247312630073003f615ace3e481ff36562580eb,2247312630073003f615ace3e481ff36562580eb,"Proxy to Gmail API for Gmail search.

Summary:
This is much faster.

Fixes T3718, T3614.

Test Plan: Unit tests updated. Extensive manual evaluation.

Reviewers: khamidou

Reviewed By: khamidou

Maniphest Tasks: T3614, T3718

Differential Revision: https://phab.nylas.com/D2062"
emfree,2015-09-24 04:54:51,https://api.github.com/repos/nylas/sync-engine/git/commits/f39464b5d344406e285aa4379c0fbf606bd6ea61,f39464b5d344406e285aa4379c0fbf606bd6ea61,"Reduce error noise in Google contacts sync.

`PermissionsError`s raised are now in fact the result of API rate-limiting and
the like, so retry instead of raising an unhandled exception."
emfree,2015-09-22 17:29:37,https://api.github.com/repos/nylas/sync-engine/git/commits/0237f941735adb23d0b657412d2553ae7b582819,0237f941735adb23d0b657412d2553ae7b582819,"Revert ""IMAPClient 1.0a0""

This reverts commit 5b4e75b6b2a1b365b68c165740b19aa09a3a1ad1.

Reason for rollback: breaks sync."
khamidou,2015-09-22 13:05:42,https://api.github.com/repos/nylas/sync-engine/git/commits/01fe1e929b3579318d39088ea248215dd9724dd8,01fe1e929b3579318d39088ea248215dd9724dd8,"Revert ""add folder mapping for qq,qq_enterprise && foxmail""

This commit was reverted on production some time ago. I'm
reverting it on master to be consistent. IIRC there's some encoding
issues with some QQ accounts. I'll fix both problems at the same time.

Conflicts:
	inbox/providers.py"
khamidou,2015-09-22 09:45:54,https://api.github.com/repos/nylas/sync-engine/git/commits/2ae17a3efacde2c53a15c8f0f78d0c2592d162d5,2ae17a3efacde2c53a15c8f0f78d0c2592d162d5,"Detect another type of ""Sent Mail"" folder

Summary: We weren't detecting folders named ""INBOX.Sent"" as sent folders. This diff fixes this, as well as some pep8 issues.

Test Plan: Tested by running a full sync of a fastmail account. Note that fastmail accounts shouldn't be affected by this change, though.

Reviewers: emfree

Reviewed By: emfree

Projects: #sync-engine

Differential Revision: https://phab.nylas.com/D2047"
khamidou,2015-09-18 17:40:57,https://api.github.com/repos/nylas/sync-engine/git/commits/93bcc7586ac49fbacea38088272c009730be05b8,93bcc7586ac49fbacea38088272c009730be05b8,"[api] Always expose the content id

Summary:
We're currently exposing an attachment's content id when querying its parent message:
```
""account_id"": ""9yxc6p4peqfkectggzpddkvv5"",
...
""events"": [ ],
""files"":
[

    {
        ""content_id"": ""885D10B89C30144BA6E42592269E146F@nylas.com"",
        ""content_type"": ""image/png"",
        ""filename"": ""Capture d'écran 2015-09-05 21.05.47.png"",
        ""id"": ""34r14y6z8grytu9mcdfox3fsl"",
        ""size"": 25527
    }

],
```

but we don't do it when querying an individual file:
```
curl -X GET ""http://localhost:5555/files/?message_id=3nkrlxpas7zqal2u63rowt1hw""
[

{

""account_id"": ""9yxc6p4peqfkectggzpddkvv5"",
""content_type"": ""image/png"",
""filename"": ""Capture d'écran 2015-09-05 21.05.47.png"",
""id"": ""34r14y6z8grytu9mcdfox3fsl"",
""message_ids"":

        [
            ""3nkrlxpas7zqal2u63rowt1hw""
        ],
        ""object"": ""file"",
        ""size"": 25527
    }

]
```

This diff fixes this.

Test Plan: Tested manually.

Reviewers: emfree

Reviewed By: emfree

Differential Revision: https://phab.nylas.com/D1998"
grinich,2015-09-17 19:09:55,https://api.github.com/repos/nylas/sync-engine/git/commits/8c9c01654df998803dcc514cdf30ce9dd17b9eb7,8c9c01654df998803dcc514cdf30ce9dd17b9eb7,"Merge pull request #196 from brettgerry/imapclient-dependencies

Update dependencies for IMAPClient"
khamidou,2015-09-17 18:26:28,https://api.github.com/repos/nylas/sync-engine/git/commits/0184cd26d9fbe2398861d5ab07488e6d9c1c20ab,0184cd26d9fbe2398861d5ab07488e6d9c1c20ab,"Fix a `sequence_number` IntegrityError.

Summary:
This integrity error was caused by an iCalendar which didn’t follow the iCalendar spec: it defines a sequence number which is way bigger than a regular int.

This diff fixes this by:
1. changing the length of the `sequence_number` field to a bigint.
2. changing `download_and_commit_uids` to catch IntegrityErrors. I feel like an IntegrityError when committing a single message shouldn’t derail syncing the whole folder.  The exception is still logged and sent to Sentry, though.

What do you think of the latter?

Test Plan: Tested manually by triggering an IntegrityError inside the try/catch. Checked that the other messages in the folder synced correctly.

Reviewers: emfree

Reviewed By: emfree

Projects: #sync-engine

Maniphest Tasks: T3323

Differential Revision: https://phab.nylas.com/D2022"
khamidou,2015-09-17 13:42:08,https://api.github.com/repos/nylas/sync-engine/git/commits/78d7834ec07a18ddf8ecf0ee542e673b9849f6b6,78d7834ec07a18ddf8ecf0ee542e673b9849f6b6,"Fix another iCalendar unbreak now.

Summary:
This is bug was fun. According to our logs, we have some recurring events in our db which look like this:

mysql> select event.id, start, end, calendar_id, start_timezone from event, recurringevent where event.id = recurringevent.id and event.namespace_id = 1682 and start_timezone = 'Pacific Standard Time';
+-----------+---------------------+---------------------+-------------+-----------------------+
| id        | start               | end                 | calendar_id | start_timezone        |
+-----------+---------------------+---------------------+-------------+-----------------------+
| 105216274 | 2015-09-17 16:30:00 | 2015-09-17 17:00:00 |        9003 | Pacific Standard Time |
| 104374355 | 2015-08-04 18:00:00 | 2015-08-04 18:30:00 |        9003 | Pacific Standard Time |

« Pacific Standard Time » is a windows timezone spec and we should have translated it to an Olson timezone (e.g: ""Europe/Paris""). How did it end up here?

Here’s what our parsing code looks like:

```
            if isinstance(start, datetime) and isinstance(end, datetime):
                start_timezone = str(original_start.tzinfo)

                # icalendar doesn't parse Windows timezones yet
                # (see: https://github.com/collective/icalendar/issues/44)
                # so we look if the timezone isn't in our Windows-TZ
                # to Olson-TZ table.
                if original_start.tzinfo is None:
			# Guess the right timezone.
```

What happened is that iCalendar recently started parsing calendar timezones, so when we switched to running the iCalendar HEAD (https://github.com/nylas/sync-engine/commit/6dc94380b07fbaf574034f6a12c4449e92887133)we unexpectedly short-circuited this whole code block. Unfortunately, this means we have some wrong data in our db.

This diff introduces the following changes:
1. a program to fix the timezones in the db.
2. I tightened the timezone parsing code
3. move back to using the iCalendar module from PyPI. I think we should make it a rule to never run a package from HEAD, unless if it’s one we control.

Test Plan: Ran the tests and thought a long time about the code. Sadly, there's no easy way to write a regression test.

Reviewers: emfree

Reviewed By: emfree

Subscribers: spang

Maniphest Tasks: T3612

Differential Revision: https://phab.nylas.com/D2027"
grinich,2015-09-16 21:35:24,https://api.github.com/repos/nylas/sync-engine/git/commits/c9032524858b4ca660779a0524cbbfb2067c5aa5,c9032524858b4ca660779a0524cbbfb2067c5aa5,"Merge pull request #200 from ErinCall/master

Include mercurial in the VM's dependency list"
ErinCall,2015-09-16 20:58:29,https://api.github.com/repos/nylas/sync-engine/git/commits/dff970c9bfff46346e17c843f69401470499131a,dff970c9bfff46346e17c843f69401470499131a,"Include mercurial in the VM's dependency list

Mercurial is necessary because requirements.txt specifies an hg url (as
of 01035a24cd3d783a2326ebf77be0465c76cfbd71)"
khamidou,2015-09-15 10:19:19,https://api.github.com/repos/nylas/sync-engine/git/commits/5e668000a9b3630ac27801dcb683c319c7a542e1,5e668000a9b3630ac27801dcb683c319c7a542e1,"Fix `/events?expand_recurring=true`

Summary:
This bug is caused by SQLAlchemy trying to commit an `InflatedEvent` because it's referencing a message. I tried a variety of ways to avoid commiting this object, to no avail (using an event handler, making the message object transient, disabling autoflushing) so I chose the least ugly solution:

1. setting by default `self.message` and `self.message_id` to `None` for `InflatedEvent` instances.
2. when serializing `InflatedEvent` objects, have them expose a `master_event_id` attribute. This way, API users have a way to know the message from which the event was imported.

Test Plan: Tested locally.

Reviewers: emfree

Reviewed By: emfree

Maniphest Tasks: T3556

Differential Revision: https://phab.nylas.com/D2018"
spang,2015-09-15 04:12:33,https://api.github.com/repos/nylas/sync-engine/git/commits/cb0710d9757c4e1aeabbc88bd662e039998469dc,cb0710d9757c4e1aeabbc88bd662e039998469dc,Log provider name in sync logs
grinich,2015-09-12 23:08:49,https://api.github.com/repos/nylas/sync-engine/git/commits/824e7ec202baf8d6f0eaa40bfbaa509fde94fbd0,824e7ec202baf8d6f0eaa40bfbaa509fde94fbd0,Merge remote-tracking branch 'origin/master'
grinich,2015-09-12 23:07:48,https://api.github.com/repos/nylas/sync-engine/git/commits/aecfcef5f6d7916ac6efa25c3c27d1a49ae4416d,aecfcef5f6d7916ac6efa25c3c27d1a49ae4416d,"recursively set folder ownership on setup

closes #197"
emfree,2015-09-11 22:54:14,https://api.github.com/repos/nylas/sync-engine/git/commits/2ea6242e440c3c129d7c634826ec2c9727832531,2ea6242e440c3c129d7c634826ec2c9727832531,Fix bad indentation in IMAP connection discarding.
emfree,2015-09-11 21:08:06,https://api.github.com/repos/nylas/sync-engine/git/commits/a21674deb18e9fa4eba2393f33485cceafdb0db9,a21674deb18e9fa4eba2393f33485cceafdb0db9,"Expose sync_state on account/namespace objects.

Test Plan: Covered by unit tests.

Reviewers: kav-ya

Reviewed By: kav-ya

Subscribers: bengotow

Differential Revision: https://phab.nylas.com/D2015"
emfree,2015-09-11 01:43:55,https://api.github.com/repos/nylas/sync-engine/git/commits/d433986a959fb248b53baa9291336c10f962ef09,d433986a959fb248b53baa9291336c10f962ef09,Reduce error log volume due to failed IMAP logouts.
emfree,2015-09-11 01:18:09,https://api.github.com/repos/nylas/sync-engine/git/commits/6f6d15e07500e88a451adac608da3fa9a431d007,6f6d15e07500e88a451adac608da3fa9a431d007,Add IMAP invalid login error message.
emfree,2015-09-11 00:06:03,https://api.github.com/repos/nylas/sync-engine/git/commits/16021582530a32fed6b8f81f5405a226d9330d57,16021582530a32fed6b8f81f5405a226d9330d57,"Catch binascii.Error as message decoding error.

Raised by following trace:
```
Traceback (most recent call last):
	  File ""/usr/share/python/inbox-sync/local/lib/python2.7/site-packages/inbox/util/concurrency.py"", line 46, in wrapped
    return func(*args, **kwargs)
	  File ""/usr/share/python/inbox-sync/local/lib/python2.7/site-packages/inbox/mailsync/backends/imap/generic.py"", line 181, in _run_impl
    self.state = self.state_handlers[old_state]()
	  File ""/usr/share/python/inbox-sync/local/lib/python2.7/site-packages/inbox/util/concurrency.py"", line 46, in wrapped
    return func(*args, **kwargs)
	  File ""/usr/share/python/inbox-sync/local/lib/python2.7/site-packages/inbox/mailsync/backends/imap/generic.py"", line 275, in initial_sync
    self.initial_sync_impl(crispin_client)
	  File ""/usr/share/python/inbox-sync/lib/python2.7/site-packages/inbox/mailsync/backends/gmail.py"", line 188, in initial_sync_impl
    self.batch_download_uids(crispin_client, uids, g_metadata)
	  File ""/usr/share/python/inbox-sync/lib/python2.7/site-packages/inbox/mailsync/backends/gmail.py"", line 387, in batch_download_uids
    self.download_and_commit_uids(crispin_client, batch)
	  File ""/usr/share/python/inbox-sync/lib/python2.7/site-packages/inbox/mailsync/backends/gmail.py"", line 323, in download_and_commit_uids
    msg)
	  File ""/usr/share/python/inbox-sync/local/lib/python2.7/site-packages/inbox/mailsync/backends/imap/generic.py"", line 423, in create_message
    new_uid = common.create_imap_message(db_session, acct, folder, msg)
	  File ""/usr/share/python/inbox-sync/local/lib/python2.7/site-packages/inbox/mailsync/backends/imap/common.py"", line 177, in create_imap_message
    body_string=msg.body)
	  File ""/usr/share/python/inbox-sync/local/lib/python2.7/site-packages/inbox/models/message.py"", line 236, in create_from_synced
    html_parts, plain_parts)
	  File ""/usr/share/python/inbox-sync/local/lib/python2.7/site-packages/inbox/models/message.py"", line 328, in _parse_mimepart
    if mimepart.body is None:
	  File ""/usr/share/python/inbox-sync/local/lib/python2.7/site-packages/flanker/mime/message/part.py"", line 451, in body
    return self._container.body
	  File ""/usr/share/python/inbox-sync/local/lib/python2.7/site-packages/flanker/mime/message/part.py"", line 47, in body
    self._load_body()
	  File ""/usr/share/python/inbox-sync/local/lib/python2.7/site-packages/flanker/mime/message/part.py"", line 76, in _load_body
    self.stream.read(self.end - self._body_start + 1))
	  File ""/usr/share/python/inbox-sync/local/lib/python2.7/site-packages/flanker/mime/message/part.py"", line 578, in decode_body
    return decode_charset(content_type, body)
	  File ""/usr/share/python/inbox-sync/local/lib/python2.7/site-packages/flanker/mime/message/part.py"", line 594, in decode_charset
    body = charsets.convert_to_unicode(charset, body)
	  File ""/usr/share/python/inbox-sync/local/lib/python2.7/site-packages/flanker/mime/message/charsets.py"", line 13, in convert_to_unicode
    return to_unicode(value, charset=charset)
	  File ""/usr/share/python/inbox-sync/local/lib/python2.7/site-packages/flanker/utils.py"", line 73, in to_unicode
    value = _make_unicode(value, charset)
	  File ""/usr/share/python/inbox-sync/local/lib/python2.7/site-packages/flanker/utils.py"", line 59, in _make_unicode
    value = value.decode(charset, ""strict"")
	  File ""/usr/share/python/inbox-sync/lib/python2.7/encodings/base64_codec.py"", line 42, in base64_decode
    output = base64.decodestring(input)
	  File ""/usr/lib/python2.7/base64.py"", line 321, in decodestring
    return binascii.a2b_base64(s)
	Error: Incorrect padding
```"
khamidou,2015-09-10 14:22:33,https://api.github.com/repos/nylas/sync-engine/git/commits/eb15ef3f468d968781b0ce821cecc757c017db79,eb15ef3f468d968781b0ce821cecc757c017db79,"Fix `delete_namespace`

Summary:
This is the companion diff to D1984. It fixes the following:
- some cascades weren’t set for categories, preventing us from deleting namespaces. I added a migration to fix them.
- the `delete_namespace` function actually didn’t get rid of secrets and auth tokens.
- I added unit tests to make sure the function deleted Blocks, Secrets, Events, Contacts, etc.

Test Plan: Tested manually + unit tests.

Reviewers: kav-ya, spang

Reviewed By: spang

Maniphest Tasks: T2310

Differential Revision: https://phab.nylas.com/D1999"
emfree,2015-09-09 21:25:11,https://api.github.com/repos/nylas/sync-engine/git/commits/5efe577f6d2f917a1a589a6a5877fe16ad890e00,5efe577f6d2f917a1a589a6a5877fe16ad890e00,"Revert folder deletion patches.

This reverts commits be13de818,76d1fbfa53,be808dd3e56.

Reason for rollback: incorrect constraint changes."
emfree,2015-09-09 20:59:25,https://api.github.com/repos/nylas/sync-engine/git/commits/c75edc29ce0b45802ea99baabe54cd78284078dc,c75edc29ce0b45802ea99baabe54cd78284078dc,Fix query caching bug in /messages API.
brettgerry,2015-09-09 04:45:35,https://api.github.com/repos/nylas/sync-engine/git/commits/c3de65fd67ea4229b1fa4e3752b8fe094060e8b0,c3de65fd67ea4229b1fa4e3752b8fe094060e8b0,add mercurial
brettgerry,2015-09-09 04:43:17,https://api.github.com/repos/nylas/sync-engine/git/commits/a9b35fc2d86937fd903cf0ddd10309819e79d3ad,a9b35fc2d86937fd903cf0ddd10309819e79d3ad,bump mock to 1.3.0
khamidou,2015-09-03 09:56:56,https://api.github.com/repos/nylas/sync-engine/git/commits/b2b4fbb4e0ffa24cff0b832eae7d0aaf3c9cf54d,b2b4fbb4e0ffa24cff0b832eae7d0aaf3c9cf54d,fix indentation for providers file.
emfree,2015-09-02 22:24:56,https://api.github.com/repos/nylas/sync-engine/git/commits/4984e2d9adb6dcbdface6c182a742f85145b65ab,4984e2d9adb6dcbdface6c182a742f85145b65ab,"Catch exceptions in SMTP.rset() for proper error surfacing.

Test Plan: Unit tests added.

Reviewers: kav-ya

Reviewed By: kav-ya

Differential Revision: https://phab.nylas.com/D1975"
spang,2015-09-02 23:47:18,https://api.github.com/repos/nylas/sync-engine/git/commits/e068bcff2b22bc9ac5a806b585dc5255b0682176,e068bcff2b22bc9ac5a806b585dc5255b0682176,"Merge pull request #195 from Eagles2F/folderMappingForQQ

add folder mapping for qq,qq_enterprise && foxmail"
emfree,2015-09-02 19:11:17,https://api.github.com/repos/nylas/sync-engine/git/commits/1156541de7c8f4fead55fac62be667e7955d15b5,1156541de7c8f4fead55fac62be667e7955d15b5,"Simplify retry logic.

Summary:
The strategy of 'retry for a while, but fail if too many exceptions are seen in
succession' has largely outlived its usefulness. In particular, it means that
sync is not robust against extended provider outages, Route53 outages, etc.

Instead, just keep retrying forever. This may seem cavalier, but is in general
the better thing to do. Heartbeats allow us to detect stuckness. This commit
also removes `report_killed` methods, but folks can (and should) go look in the
logs for stack traces.

Test Plan:
Run syncs, unit tests. Introduce exceptions in sync and check that
retry happens.

Reviewers: khamidou

Reviewed By: khamidou

Differential Revision: https://phab.nylas.com/D1970"
khamidou,2015-09-02 14:56:08,https://api.github.com/repos/nylas/sync-engine/git/commits/cb33d5fd5f7ff3dcfac619fa1ac14fa5596af892,cb33d5fd5f7ff3dcfac619fa1ac14fa5596af892,"Fix failing tests. The latest version of flanker sometimes switches the
headers order."
khamidou,2015-09-02 13:21:35,https://api.github.com/repos/nylas/sync-engine/git/commits/20767ce49f1fa5cd4b11a02b0c885d30515023d5,20767ce49f1fa5cd4b11a02b0c885d30515023d5,"Fix both T3353 and T994

Summary:
Both bugs are caused by a tiny bug in flanker: it wouldn't detect correctly the file name of an inline attachment. I've sent the mailgun team a pull request to fix it (https://github.com/mailgun/flanker/pull/102/files --- could you review it too by the way?).

In the meantime, this diff changes our requirements.txt file to point to my flanker fork.

Test Plan: Tested manually + added regression test to flanker.

Reviewers: emfree

Reviewed By: emfree

Projects: #sync-engine

Differential Revision: https://phab.nylas.com/D1962"
emfree,2015-09-02 00:08:53,https://api.github.com/repos/nylas/sync-engine/git/commits/a970a5518330df7be71ab59633ef304a73bf3b70,a970a5518330df7be71ab59633ef304a73bf3b70,"Remove unused sync_raw_data column from account model.

Test Plan: Run migration; unit tests.

Reviewers: drew

Reviewed By: drew

Differential Revision: https://phab.nylas.com/D1969"
Eagles2F,2015-09-01 23:07:27,https://api.github.com/repos/nylas/sync-engine/git/commits/a3fcc4758c993a33d2a74661e9347439f27b7114,a3fcc4758c993a33d2a74661e9347439f27b7114,"add folder mapping for qq,qq_enterprise && foxmail"
emfree,2015-09-01 19:14:21,https://api.github.com/repos/nylas/sync-engine/git/commits/f50d34628d4179c63047cc1a9c2ba044c8e69b6a,f50d34628d4179c63047cc1a9c2ba044c8e69b6a,"Support expanded object view in delta API.

Summary: Fixes T2091.

Test Plan: Unit tests added.

Reviewers: khamidou

Maniphest Tasks: T2091

Differential Revision: https://phab.nylas.com/D1960"
spang,2015-09-01 18:44:01,https://api.github.com/repos/nylas/sync-engine/git/commits/570c600d8bb6a177b240ac0e29702f9ad8b58a17,570c600d8bb6a177b240ac0e29702f9ad8b58a17,"Remove deprecated rfc2822 messages endpoint.

We moved this to using an Accept header instead of a separate endpoint a while back.

Fixes T1936"
khamidou,2015-09-01 10:00:19,https://api.github.com/repos/nylas/sync-engine/git/commits/a3f6a22b53492fb6ca2c8575dcbb632bf2e0ee4d,a3f6a22b53492fb6ca2c8575dcbb632bf2e0ee4d,bump nylas-production-python version
dregitsky,2015-09-01 03:33:11,https://api.github.com/repos/nylas/sync-engine/git/commits/116a2e6d4dc52e54ee8d34f7a07bfacb8bb1b3e9,116a2e6d4dc52e54ee8d34f7a07bfacb8bb1b3e9,"Allow Gmail accounts with no email access to sync calendar/contacts

Summary:
This change allows Google accounts that have either IMAP disabled
or the entire Gmail app disabled to still have their calendar and
contacts synced. A new sync_email bit in Account controls whether
email sync is attempted, as well as whether exceptions for no IMAP
and no Gmail are raised during account creation.

Test Plan:
Manual testing. Tested on Gmail accounts with IMAP disabled and
with the Gmail app disabled, with the sync_email field set to
True and False.

Reviewers: emfree

Reviewed By: emfree

Differential Revision: https://phab.nylas.com/D1935"
emfree,2015-09-01 02:40:57,https://api.github.com/repos/nylas/sync-engine/git/commits/76486ebf77ce107044ac16fa5ebeb1858f319470,76486ebf77ce107044ac16fa5ebeb1858f319470,Catch ValueError parsing `STATUS ... (UIDNEXT)` response.
spang,2015-08-31 19:06:19,https://api.github.com/repos/nylas/sync-engine/git/commits/52abffb890ed3191ef6138d47728efe35467916f,52abffb890ed3191ef6138d47728efe35467916f,"Allow accounts with 'killed' state to be considered deleted.

Summary:
Not totally sure this is exactly the right fix here. It seems that
account.disable_sync() doesn't change account state to 'stopped'--so a
killed account which is marked as deleted will falsely trigger the 'make
sure account is marked as deleted' check at the beginning of
bin/delete-account-data, preventing account deletion.

The other possible fix would be to mark accounts as 'stopped' in
disable_sync(). If that is preferable, let me know. I chose this
strategy because I'm not sure if we want to preserve the 'killed' state
for any reason.

Test Plan: unit tests, manual testing

Reviewers: emfree

Reviewed By: emfree

Subscribers: kav-ya

Differential Revision: https://phab.nylas.com/D1952"
grinich,2015-08-17 21:38:00,https://api.github.com/repos/nylas/sync-engine/git/commits/f605b66987e6e7526b1777babed46c073708ad2d,f605b66987e6e7526b1777babed46c073708ad2d,"Change suggested by Thomas @ CloseIO to address an issue where ""thread"" might be None

Summary:
Closes #167

https://github.com/nylas/sync-engine/issues/167

Test Plan: trusting Thomas on this one

Reviewers: emfree

Subscribers: spang

Differential Revision: https://phab.nylas.com/D1903"
grinich,2015-08-25 03:33:03,https://api.github.com/repos/nylas/sync-engine/git/commits/16b15c38607387c503b39c4ef1eacf5b337ced24,16b15c38607387c503b39c4ef1eacf5b337ced24,fixes to setup script
grinich,2015-08-31 03:38:07,https://api.github.com/repos/nylas/sync-engine/git/commits/d98fefaf6ef2e335e5d293be44193ec1e1cedea0,d98fefaf6ef2e335e5d293be44193ec1e1cedea0,namespace object string repr
emfree,2015-08-28 21:00:45,https://api.github.com/repos/nylas/sync-engine/git/commits/837e3fd66da48531641b60cdbec133f992f7247e,837e3fd66da48531641b60cdbec133f992f7247e,"Restore IMAP socket timeout after idling.

Fixes a regression introduced by depending on upstream imapclient. This is
kinda hacky but works.

Fixes T3445."
systemizer,2015-08-28 17:44:02,https://api.github.com/repos/nylas/sync-engine/git/commits/8b53d2d480f40aec3d0b46b10481e86d31882ecb,8b53d2d480f40aec3d0b46b10481e86d31882ecb,upgrading nylas-production-python to 0.2.4
emfree,2015-08-27 22:20:46,https://api.github.com/repos/nylas/sync-engine/git/commits/90e4a776f53fe48b3c4dff8c6301a9b5fe68f96b,90e4a776f53fe48b3c4dff8c6301a9b5fe68f96b,"Redo uidinvalidity handling in generic IMAP sync.

Summary:
Previously, on encountering changed UIDVALIDITY for a folder, we would discard
local UIDs, then resync remote UIDs and attempt to reassociate them to the
message objects we had previously committed. This is a good idea in theory, but
in practice, this operation cannot complete incrementally. I.e., any
interruption -- an aborted IMAP connection, a database connection error, etc.
-- causes the resync to resume completely anew. This is particularly a problem
with large folders: foldersyncs can effectively get stuck in a resync.

Adapting the implementation to allow for incremental resync is not trivial.
Instead, simply delete UIDs and associate messages when the UIDVALIDITY
changes, and return to the 'initial' state to resync. This means that message
and thread public IDs will change, but also means that sync can actually
reliably proceed. Uidinvalid events are sufficiently rare that this tradeoff is
reasonable.

Fixes T3441.

Test Plan: Unit tests added.

Reviewers: kav-ya

Reviewed By: kav-ya

Maniphest Tasks: T3441

Differential Revision: https://phab.nylas.com/D1942"
khamidou,2015-08-27 19:59:03,https://api.github.com/repos/nylas/sync-engine/git/commits/efaead5b220dc05156418f0d1fc1242b35bb9c95,efaead5b220dc05156418f0d1fc1242b35bb9c95,"Fix a recurring events bug

Summary:
Fixes T3420. One of our customers reported a recurring events bug with one of their accounts. They share each other's calendars, so they all have multiple instance of the same recurring event (e.g: Eben shared his calendar with me --- we both have the same ""All hands"" event on our calendar) .

However,  it seems that Gmail gives the same uid to the same event on different calendars. Our recurring events code wasn't aware of this, so we would merge together recurring events on different calendars.

Fixed this + added a regression test.

Test Plan: Tested manually, checked that we wouldn't get recurring events from another calendar `b` when only asking for events in calendar `a`.

Reviewers: spang, emfree

Reviewed By: emfree

Projects: #calendars

Maniphest Tasks: T3420

Differential Revision: https://phab.nylas.com/D1930"
emfree,2015-08-27 17:58:21,https://api.github.com/repos/nylas/sync-engine/git/commits/7cd9003c780d3e6c047ef20e78821515e4d00848,7cd9003c780d3e6c047ef20e78821515e4d00848,Hansle missing UIDNEXT on sync startup.
emfree,2015-08-26 23:23:32,https://api.github.com/repos/nylas/sync-engine/git/commits/01035a24cd3d783a2326ebf77be0465c76cfbd71,01035a24cd3d783a2326ebf77be0465c76cfbd71,"Depend on intermediate IMAPClient with faster message list parsing.

This is basically the same as imapclient 0.13, except with much faster search
response parsing (https://bitbucket.org/mjs0/imapclient/commits/39f4cf55)."
emfree,2015-08-26 23:12:50,https://api.github.com/repos/nylas/sync-engine/git/commits/3e5e6beca7dc2a270928dcd1b31899f19fcc3254,3e5e6beca7dc2a270928dcd1b31899f19fcc3254,Cache result of should_idle() for generic IMAP.
emfree,2015-08-25 22:36:25,https://api.github.com/repos/nylas/sync-engine/git/commits/b147fc1df8fcc33e31b910bab3f5bf7f85d76db5,b147fc1df8fcc33e31b910bab3f5bf7f85d76db5,"Avoid aborted IMAP connections when fetching lots of flags.

Notably, Outlook.com IMAP appears to terminate connections if you pass long
sequence sets. Work around this."
emfree,2015-08-25 21:38:51,https://api.github.com/repos/nylas/sync-engine/git/commits/0e3a722fc8cd6bcaef747c5bff6752f045a2ba43,0e3a722fc8cd6bcaef747c5bff6752f045a2ba43,Update invalid auth error messages.
dregitsky,2015-08-25 21:38:19,https://api.github.com/repos/nylas/sync-engine/git/commits/e59cd9a156f6c209ee73cc04154f9062c92ff18c,e59cd9a156f6c209ee73cc04154f9062c92ff18c,add pycharm files to .gitignore
dregitsky,2015-08-25 21:33:19,https://api.github.com/repos/nylas/sync-engine/git/commits/3ff7bb5e42878c401c6ee4d469821a884b2f8116,3ff7bb5e42878c401c6ee4d469821a884b2f8116,"change vmware numvcpus to 1, fix for OSX vmware fusion"
emfree,2015-08-25 19:06:50,https://api.github.com/repos/nylas/sync-engine/git/commits/17e4dd04245f2010dd6f1ea8e41b3ceab309a371,17e4dd04245f2010dd6f1ea8e41b3ceab309a371,Handle 'Unexpected IDLE response' errors in IMAP polling.
emfree,2015-08-25 17:44:08,https://api.github.com/repos/nylas/sync-engine/git/commits/b49170f3d981bdd797d9863f2093d8a941f529f1,b49170f3d981bdd797d9863f2093d8a941f529f1,Fix result loading in /threads API.
emfree,2015-08-25 01:47:52,https://api.github.com/repos/nylas/sync-engine/git/commits/ae427b6db38e72666345e26a4dd7807257d4ccf6,ae427b6db38e72666345e26a4dd7807257d4ccf6,Fix typo in fallback logic for Gmail accounts with >1M messages.
emfree,2015-08-25 00:20:54,https://api.github.com/repos/nylas/sync-engine/git/commits/106f83bfd843db20b8d67d45b18e0214b4654a9d,106f83bfd843db20b8d67d45b18e0214b4654a9d,Properly handle nonconsecutively assigned UIDs / large UIDNEXT values.
emfree,2015-08-24 21:06:39,https://api.github.com/repos/nylas/sync-engine/git/commits/8234e25c94059546657a6ad57ab2f2518df6ea92,8234e25c94059546657a6ad57ab2f2518df6ea92,Handle unsolicited fetch responses in Gmail condstore_changed_flags.
emfree,2015-08-21 23:54:23,https://api.github.com/repos/nylas/sync-engine/git/commits/f74ac30173f25a2ee53cac7430c105504dc18c77,f74ac30173f25a2ee53cac7430c105504dc18c77,Fix missing state update in condstore sync.
emfree,2015-08-21 23:26:42,https://api.github.com/repos/nylas/sync-engine/git/commits/f2a44a42a3206692ba1e246c1159a52352285c10,f2a44a42a3206692ba1e246c1159a52352285c10,Add omitted logging in IMAP sync; make sure to handle missing UIDNEXT.
emfree,2015-08-21 21:41:46,https://api.github.com/repos/nylas/sync-engine/git/commits/0f4d6bd5c564e6fac4bb07095825a1f9bce7e4d9,0f4d6bd5c564e6fac4bb07095825a1f9bce7e4d9,Depend on latest hypothesis for IMAP sync tests.
emfree,2015-08-21 21:28:26,https://api.github.com/repos/nylas/sync-engine/git/commits/13697c99caa9441e8de44b1c6f0c53ca9fec7bbb,13697c99caa9441e8de44b1c6f0c53ca9fec7bbb,"Refine IMAP sync.

Summary:
This is a collection of changes aimed at decreasing latency and overall
resource consumption in sync, improving sync velocity and increasing overall
robustness.

Generic IMAP
------------

* Use UIDNEXT to efficiently detect new UIDs in generic IMAP sync.

* Separate generic flags refresh into ""fast"" and ""slow"" phases. Previously,
  we'd refresh flags for the 2000 most recent UIDs every 30 seconds. This is
  expensive and not necessary in general. So do a refresh of the 100 most
  recent UIDs every 30 seconds, and a fuller refresh every hour (these
  parameters can be changed).

* Do away with separate CondStoreFolderSyncEngine and CondStoreCrispinClient
  classes for simplicity, and just use IDLE or CONDSTORE when advertised in
  server capabilities. (Fixes Github issue #162.)

Gmail
-----

* Don't do a full upfront metadata fetch in Gmail initial sync. This could
  previously cause a multi-minute delay before any messages were downloaded on
  large accounts.

* Significantly improve overall velocity of Gmail initial sync by first getting
  message sizes and fetching message bodies in bounded batches (so that we
  don't have to worry about OOMing).

Miscellania
-----------

* Keep track of sync state (highestmodseq, uidnext, uidvalidity) in folder
  sync workers, instead of always reading them from the database, to reduce
  unnecessary overhead.

* Do away with semi-deprecated initial sync throttling. Maintaining support for
  throttling would add unwarranted complexity, since making things as slow
  as possible is somewhat at odds with making them as fast as possible, and I
  don't think we need this.

* Used baked queries in a few places where compilation overhead is recognizable
  in profiling.

* Update a few method names and signatures for greater clarity and consistency.

There is, of course, more we could do: e.g., flags refresh should probably be
totally asynchronous so that new message downloads are never delayed, and we
might want to do periodic full flags refreshes for all providers in order to be
robust against, say, buggy CONDSTORE implementations on the backend.

Test Plan:
Unit tests added; lots of manual testing. The hypothesis library is
awesome for declaratively generating plausible test data, and we now have lots
more unit test coverage for IMAP sync.

Reviewers: spang

Reviewed By: spang

Differential Revision: https://phab.nylas.com/D1912"
khamidou,2015-08-20 18:14:46,https://api.github.com/repos/nylas/sync-engine/git/commits/e26c43a68fd24b12d16d4ee1dd0dd3429f7b3d6e,e26c43a68fd24b12d16d4ee1dd0dd3429f7b3d6e,"Log UnicodeEncodeErrors when sending emails

Summary: It should help us debug this weird production error.

Test Plan: This is just an exception handler.

Reviewers: emfree

Reviewed By: emfree

Differential Revision: https://phab.nylas.com/D1923"
khamidou,2015-08-20 16:58:38,https://api.github.com/repos/nylas/sync-engine/git/commits/1ee1bedf31f0f4dce65c54a2c9f94658100ca6e4,1ee1bedf31f0f4dce65c54a2c9f94658100ca6e4,add more address validation tests.
emfree,2015-08-19 22:12:54,https://api.github.com/repos/nylas/sync-engine/git/commits/46e015ccf6bac24c2c446a354ee55d485fdbfdb3,46e015ccf6bac24c2c446a354ee55d485fdbfdb3,Avoid blind update in sync scheduling to reduce index lock contention.
emfree,2015-08-19 19:28:12,https://api.github.com/repos/nylas/sync-engine/git/commits/121c62960102318ab5a8ea0996834541d18dab91,121c62960102318ab5a8ea0996834541d18dab91,Fix broken serialization in /tags endpoint.
emfree,2015-08-19 01:05:27,https://api.github.com/repos/nylas/sync-engine/git/commits/dbaa9b008d516e3d8adbb4b125a667319f4adee3,dbaa9b008d516e3d8adbb4b125a667319f4adee3,"Exclude sent messages from thread-level folder moves.

Fixes T3345."
grinich,2015-08-19 08:57:02,https://api.github.com/repos/nylas/sync-engine/git/commits/e0bf6f01d5c4b3cd931fedacfdc99ce8d9a09695,e0bf6f01d5c4b3cd931fedacfdc99ce8d9a09695,Update README.md
grinich,2015-08-19 08:56:06,https://api.github.com/repos/nylas/sync-engine/git/commits/02a943692e1c49c067315f1eed5d4be9f1934e99,02a943692e1c49c067315f1eed5d4be9f1934e99,Update README.md
grinich,2015-08-19 01:08:06,https://api.github.com/repos/nylas/sync-engine/git/commits/be06b168214383710ab83ba31ed0368f79f71850,be06b168214383710ab83ba31ed0368f79f71850,"Add /delta/latest_cursor endpoint

Summary: I've always hated having to get the current timestamp. I'm sure this will help a lot of people. Perhaps we should even deprecate `/delta/generate_cursor` since when do you really need to get an old cursor?!

Test Plan: added tests

Reviewers: spang

Reviewed By: spang

Subscribers: bengotow, emfree

Differential Revision: https://phab.nylas.com/D1909"
spang,2015-08-18 20:25:03,https://api.github.com/repos/nylas/sync-engine/git/commits/38ad972ed1727487d338e56b03c5e89ec8652d71,38ad972ed1727487d338e56b03c5e89ec8652d71,"Bump nylas-production-python version again.

This mostly ports the library to the latest structlog, which gets rid of
some custom code which got merged upstream."
spang,2015-08-18 18:48:23,https://api.github.com/repos/nylas/sync-engine/git/commits/347848bef0c23fb0e793c31a95ed10dd20647104,347848bef0c23fb0e793c31a95ed10dd20647104,"Bump nylas-production-python version.

Fixes T3343."
khamidou,2015-08-18 09:35:44,https://api.github.com/repos/nylas/sync-engine/git/commits/32ea5a9b5f162efaecd0315a199d93e0781b5501,32ea5a9b5f162efaecd0315a199d93e0781b5501,"Use a built-in flanker function to get a part's filename

Summary:
Fixes a bug reported on Github (https://github.com/nylas/sync-engine/issues/185). Flanker has a `detected_file_name` function which guesses the filename of an attachment depending on the MIME headers. It works better than what we were doing before.

I also fixed a bug in flanker where it wouldn't detect filenames for inline attachments (https://github.com/mailgun/flanker/issues/44)--- I'll send them an pull request as soon as I have a regression test (here's the fix, for the curious: https://github.com/khamidou/flanker/commit/774dd238df507a09da7e632e790c2e2d7f0876cb)

Test Plan: Tested manually.

Reviewers: emfree, mg

Reviewed By: emfree, mg

Projects: #sync-engine

Differential Revision: https://phab.nylas.com/D1896"
khamidou,2015-08-18 09:33:44,https://api.github.com/repos/nylas/sync-engine/git/commits/abdd4f303db8d36604376b08c262660275db7174,abdd4f303db8d36604376b08c262660275db7174,"[generic accounts] Save sent message in ""Sent mail""

Summary: Contrary to Gmail and Exchange, generic providers (e.g: Dovecot, iCloud) don't save copies of sent messages into the ""Sent mail"" folder. This diff fixes this.

Test Plan: Tested manually.

Reviewers: emfree, spang

Reviewed By: spang

Projects: #sync-engine

Maniphest Tasks: T3337

Differential Revision: https://phab.nylas.com/D1887"
grinich,2015-08-18 02:29:22,https://api.github.com/repos/nylas/sync-engine/git/commits/4020ad447287ac93de89d0251e003838b99dbc7f,4020ad447287ac93de89d0251e003838b99dbc7f,"Be less confident we have a database session

Summary: For some reason an OPTIONS request will skip our before_request handler and not get a database session.

Test Plan:
Tested manually running the full stack with

curl -I -u $ACCESS_TOKEN: -X OPTIONS http://api.nylas.toad:5000/threads

Reviewers: emfree

Reviewed By: emfree

Subscribers: spang

Differential Revision: https://phab.nylas.com/D1907"
emfree,2015-08-17 23:29:59,https://api.github.com/repos/nylas/sync-engine/git/commits/fbe5c5c64537eac2927903c3ed34945956c413a9,fbe5c5c64537eac2927903c3ed34945956c413a9,Handle noncompliant backends that don't return UIDNEXT.
emfree,2015-08-17 20:30:15,https://api.github.com/repos/nylas/sync-engine/git/commits/ad2d4199f0d325a9276349c6b89a8bd2af4d24f4,ad2d4199f0d325a9276349c6b89a8bd2af4d24f4,Allow db pool timeout to be configured.
grinich,2015-08-17 19:30:01,https://api.github.com/repos/nylas/sync-engine/git/commits/1b45d657fce6689d075bc9df00faef7246d80a0e,1b45d657fce6689d075bc9df00faef7246d80a0e,"Accept `folder_id` and `label_ids` when updating messages/threads since that's what a developer is actually passing. (Not the full folder/label object.)

Summary: APIs are forever :(

Test Plan: Passes tests

Reviewers: emfree

Reviewed By: emfree

Subscribers: kav-ya, spang

Differential Revision: https://phab.nylas.com/D1900"
khamidou,2015-08-17 16:08:44,https://api.github.com/repos/nylas/sync-engine/git/commits/a84eae1c0a1e18bf843eff69522752a082968b76,a84eae1c0a1e18bf843eff69522752a082968b76,"Don't raise an assert inside an assert

Summary: Fixes T3341. Fetching `part.block.data` from S3 sometimes fail because of a networking/corrupted data error. I changed the code to use an intermediate variable, `part_data`, so that we don't raise an `AssertionError` inside of the exception handler.

Test Plan: Tested manually by raising an `AssertionError` inside the function.

Reviewers: spang, emfree

Reviewed By: emfree

Maniphest Tasks: T3341

Differential Revision: https://phab.nylas.com/D1895"
grinich,2015-08-14 21:45:53,https://api.github.com/repos/nylas/sync-engine/git/commits/4531dc5e9034a67e38d34f44d4ff52a3bc81555c,4531dc5e9034a67e38d34f44d4ff52a3bc81555c,"Remove namespace prefix from API

Summary:
{F4061}

Namespaces were a thing I originally designed to make it ""easier"" in the future to allow users to share mail data. The goal was to grant users a single token that could access multiple namespaces (à la shared folders) even if the threads in that namespace weren't part of their mailbox.

It's become apparent that this design decision was silly premature optimization. Any cross-namespace system for sharing mail that we build is going to have new requirements that don't fit into current design. Event the notion of having a token work for multiple namespaces will probably break a huge amount of things. I think all of our example code just uses `namespace[0]`.

So it's time to remedy this. This commit does the following.

**Remove the `/n/<namespace_public_id>`from all API prefixes by registering the flask blueprint twice.**
This means we have `https://api.nylas.com/threads`, `https://api.nylas.com/messages`, etc. So much easier to reason about. Access tokens are still passed the same way, and from those we can identity which namespace they correspond to. An access token will never grant more than one namespace. (This previously held true, but now it is a solid constraint.

**Merge namespace concept into account and add the `/account` endpoint**
Return general information about the account object, like name, email address, provider, and IMAP/etc. settings.

**Replace all instances of namespace_id with account_id**
Death to namespaces! I think we should actually just use the `namespace_id` as the public `account_id` because I assume developers are already using it to delineate users. However this will make it complicated for us internally since namespace=account and account=credential. Might need to clean up some nomenclature.

**Maintain backwards compatibility for `/n/<namespace_id>` style requests. **
Done through use of flask blueprints, and verifying namespace_id in a before_filter. Passes all the tests.

**Updated tests**
 I duplicated all the existing tests and put them in `test/api_legacy` and made sure they all pass. Then I updated everything in `tests/api` with new fixtures for the changed endpoints. We can remove `tests/api_legacy` once we migrate all folks over, but for now it runs both sets.

Open questions & tasks:
[x] How does this diff affect the transaction log's performance? (doesn't)
[x] Do we need to return //both// `account_id` and `namespace_id` params in objects in delta objects for a while? (probably yes) @bengotow what do you think?
[x] What fields should we return in the new `/account` endpoint? Some ideas: sync state, profile photo, provider settings (imap/smtp server/port/ssl)
[x] Identify any & all performance regressions. (ben ran edgehill agains it and it seems fine)
[x] Verify compatibility with redwood: oauth flow & API auth
[] Update SDKs
[x] Write new docs, removing all references to namespaces in any of our docs, APIs, or SDKs,
[x] Figure out a game plan for talking to customers and helping them migrate

Todo later:
[] Consider how we are going to add versioning to our API. We don't necessarily need it here, except perhaps with the delta API.
[] Add API for folks to POST to some endpoint that creates `/account` and returns a new access_token (see T2518)
[] For development simplicity, consider dropping the `Account.public_id` property or aliasing it to `Account.namespace.public_id`

Test Plan: Passes all the tests, old and new.

Reviewers: spang

Reviewed By: spang

Subscribers: karim, khamidou, kav-ya, bengotow, spang

Projects: #platform-team, #sync-engine

Differential Revision: https://phab.nylas.com/D1826"
emfree,2015-08-14 17:58:17,https://api.github.com/repos/nylas/sync-engine/git/commits/d160deefe3b5005c1de67be2ab8922e2438210c6,d160deefe3b5005c1de67be2ab8922e2438210c6,"Save IMAP UIDNEXT value.

Summary:
We'll soon be able to use this for much improved generic IMAP sync. In order to
be able to efficiently migrate, start saving the reported UIDNEXT value
whenever we poll a folder. (We're not actually using it for anything yet.)

Test Plan: run syncs, verify that uidnext values are persisted.

Reviewers: spang

Reviewed By: spang

Differential Revision: https://phab.nylas.com/D1892"
emfree,2015-08-14 00:17:36,https://api.github.com/repos/nylas/sync-engine/git/commits/e3ad7ea1126a75f0d0c7b97d08491d3e3a68471f,e3ad7ea1126a75f0d0c7b97d08491d3e3a68471f,"Make streaming API less expensive when there are no changes.

Summary:
The query that gets new transactions is kind of expensive to set up, and
difficult to optimize (because you can't bake a query that passes a variable
number of elements to an in_ clause). So first do a simple check to see if
there are any new transactions at all.

Test Plan: Covered by unit tests.

Reviewers: kav-ya

Reviewed By: kav-ya

Differential Revision: https://phab.nylas.com/D1894"
spang,2015-08-13 22:38:57,https://api.github.com/repos/nylas/sync-engine/git/commits/7bd620113aa406e025e372432d9ee5e91d94f92c,7bd620113aa406e025e372432d9ee5e91d94f92c,Remove deprecated SENTRY_EXCEPTIONS config option
spang,2015-08-13 21:49:20,https://api.github.com/repos/nylas/sync-engine/git/commits/5466958af5b0a25ba6a9aeb30d4f8f65f4e9f56a,5466958af5b0a25ba6a9aeb30d4f8f65f4e9f56a,"Don't require SENTRY_DSN.

This feature is disabled if this config variable isn't available."
spang,2015-08-13 19:32:53,https://api.github.com/repos/nylas/sync-engine/git/commits/0a3512879dd46dba5a5e073462eb5a1322d516ac,0a3512879dd46dba5a5e073462eb5a1322d516ac,Actually configure SENTRY_DSN and log to sentry
kav-ya,2015-08-11 05:51:36,https://api.github.com/repos/nylas/sync-engine/git/commits/6e34816451406cfacfb584e0cfdf2885bf8bd0b8,6e34816451406cfacfb584e0cfdf2885bf8bd0b8,"Create Transactions for Account.sync_state changes

Summary: Required to support Account Webhooks.

Test Plan: Unit test added.

Reviewers: emfree

Reviewed By: emfree

Differential Revision: https://phab.nylas.com/D1868"
emfree,2015-08-12 22:29:11,https://api.github.com/repos/nylas/sync-engine/git/commits/13a13713f182a8c68085c50fd7964bd3f75f3b20,13a13713f182a8c68085c50fd7964bd3f75f3b20,"Use mysqlclient instead of PyMySQL.

Summary:
mysqlclient is an updated fork of MySQLdb. It seems to be a fair bit more
performant in general than pymysql.

Test Plan: Run tests, sync, api.

Reviewers: spang, kav-ya

Reviewed By: kav-ya

Differential Revision: https://phab.nylas.com/D1885"
emfree,2015-08-12 22:18:12,https://api.github.com/repos/nylas/sync-engine/git/commits/2a7ff4bff22cbc650efc4b105f79aa0f57eec7da,2a7ff4bff22cbc650efc4b105f79aa0f57eec7da,Fix incorrect dictionary lookup in add_new_imapuids.
kav-ya,2015-08-12 18:54:30,https://api.github.com/repos/nylas/sync-engine/git/commits/9bfd4bba8ef9eacdc875a58c89d62c982bfca22e,9bfd4bba8ef9eacdc875a58c89d62c982bfca22e,"Actually version 'File' objects.

Summary: Block objects were never versioned; fix that.

Test Plan: Regression test added.

Reviewers: emfree

Reviewed By: emfree

Differential Revision: https://phab.nylas.com/D1883"
emfree,2015-07-24 20:58:25,https://api.github.com/repos/nylas/sync-engine/git/commits/8c7cf8773e35bc323fbd3f0a9c2954269f1b40af,8c7cf8773e35bc323fbd3f0a9c2954269f1b40af,"Don't delete label objects in save_folder_names for now.

Causes issues when labels have ""show in IMAP"" unchecked, and with proper
cascading to category and labelitem objects.

(This was missing on branch master)

Conflicts:
	inbox/mailsync/backends/gmail.py"
systemizer,2015-08-12 20:18:43,https://api.github.com/repos/nylas/sync-engine/git/commits/0424d39da2fa4f006a086662d317a40ed6f4088d,0424d39da2fa4f006a086662d317a40ed6f4088d,gevent doesn't handle unicode hostnames. Fix statsd
emfree,2015-08-12 20:07:30,https://api.github.com/repos/nylas/sync-engine/git/commits/8732d862bcb2603cb32c83e918385233c046b188,8732d862bcb2603cb32c83e918385233c046b188,"Handle Gmail accounts with IMAP support disabled.

Summary:
A few Gmail accounts persistently encounter IMAP login failures. Ordinarily,
invalid credentials for Gmail maniphest themselves at token refresh time; for
these problem accounts, we can get a token but can't use it. This appears to be
the result of IMAP access being disabled, a condition which is frustratingly
difficult to reproduce.

We treat this as a special case of invalid credentials (i.e., stop the sync),
but raise an `ImapSupportDisabledError` so that we can present this to the user
on reauth.

Also handle `GmailSettingError` the same way, so that sync will be properly
shut down if the All Mail folder is disabled after a sync is started.

Fixes T2396, T1889.

Test Plan:
Raise exceptions and verify that sync is stopped and accounts are
marked as invalid.

Reviewers: spang

Reviewed By: spang

Maniphest Tasks: T1889, T2396

Differential Revision: https://phab.nylas.com/D1880"
emfree,2015-08-12 18:49:37,https://api.github.com/repos/nylas/sync-engine/git/commits/09baf27a83ce7a4a78f2444bf9f1fd787161d016,09baf27a83ce7a4a78f2444bf9f1fd787161d016,"Only execute save_folder_names if remote folder list changes.

Calling save_folder_names (repeatedly) is surprisingly expensive. In general,
we don't need to, since the folder list rarely changes. So just keep track of
the folder list we got from the backend last time, and don't do anything if it
hasn't changed."
emfree,2015-08-12 18:18:55,https://api.github.com/repos/nylas/sync-engine/git/commits/ed60ad81d75979db5d61903726d8f8db06c9eaf7,ed60ad81d75979db5d61903726d8f8db06c9eaf7,"Bake database queries for /messages performance.

Summary:
The /messages endpoint is popular, and backed by a relatively complicated
schema. By ""baking"" and caching the compiled SQL query, we can actually save a
substantial amount of API CPU, especially for queries where the result set is
small (e.g., getting messages on a single thread, or messages from the past few
hours).

Test Plan: Covered by unit tests in tests/api/test_filtering.py.

Reviewers: khamidou, spang

Reviewed By: spang

Subscribers: kav-ya

Differential Revision: https://phab.nylas.com/D1867"
systemizer,2015-08-12 18:12:43,https://api.github.com/repos/nylas/sync-engine/git/commits/f3ea764d195922d483819f3a8191442c31dab495,f3ea764d195922d483819f3a8191442c31dab495,"Adding foldersyncstats start/stop columns for initial sync timing again

Summary: making linter happy. SORRY this should have been push to master. I had to create the diff due to newly added migrations

Test Plan: ran alembic upgrade and it worked

Reviewers: kav-ya

Reviewed By: kav-ya

Differential Revision: https://phab.nylas.com/D1879"
kav-ya,2015-08-11 23:30:44,https://api.github.com/repos/nylas/sync-engine/git/commits/fbca3665876d6878cc645deabef55f469e066af1,fbca3665876d6878cc645deabef55f469e066af1,"[SCHEMA] Changes to ""Sync updates Message.categories only when it will not overwrite recent local
modifications made through the API.""

Summary:
* Includes revert of original fix to T2375 (commit 34515).
* Repurpose Message.state to obviate the need for a new column.

Test Plan:
Tested manually locally:
- API message update action sets the message.state = 'actions_pending';
sync does not overwrite message.categories for such a message.
- Sync sets message.categories when message.state != 'actions_pending'.

Reviewers: emfree

Reviewed By: emfree

Differential Revision: https://phab.nylas.com/D1872"
spang,2015-08-11 23:15:39,https://api.github.com/repos/nylas/sync-engine/git/commits/a22715d2f0c824da8469447b533eb1e221683354,a22715d2f0c824da8469447b533eb1e221683354,"Depend on nylas-production-python.

Summary:
nylas-production-python is new library which lives at
https://github.com/nylas/nylas-production-python and contains two pieces split
out from the sync engine:

1. our logging configuration, including sentry integration
2. our special WSGI adaptor for running in production

It's useful to split this out into its own library so we can use it in all
of our production server-side Python code without pulling in the entire sync
engine as a dependency.

We rarely change this code anymore, so it shouldn't be a hassle to have it
in its own repo. To change code in the library, we require a version bump and
a release to PyPI.

I've already shipped version 0.1.0 to PyPI. Only thing left to do is update
the repo's README to be a bit more illuminating on its use and maintenance.

Test Plan: unit tests, run sync locally

Reviewers: emfree

Reviewed By: emfree

Differential Revision: https://phab.nylas.com/D1866"
emfree,2015-08-11 20:47:47,https://api.github.com/repos/nylas/sync-engine/git/commits/ae50e4d413d68c8226d18ed8f99a01891049d0f9,ae50e4d413d68c8226d18ed8f99a01891049d0f9,"Prevent sent messages from being revised as drafts.

Summary:
Previously, message objects created on sending would first be flushed as
drafts, leading to potentially confusing behavior for clients consuming the
delta API (who would see a ""create draft"" delta rather than a ""create message""
delta).

Test Plan: Regression test added.

Reviewers: spang

Reviewed By: spang

Differential Revision: https://phab.nylas.com/D1870"
spang,2015-08-11 03:45:12,https://api.github.com/repos/nylas/sync-engine/git/commits/c12e2089430ae25399e43dfd1d2f6d7e34567ede,c12e2089430ae25399e43dfd1d2f6d7e34567ede,And requirements and setup.py too
spang,2015-08-11 03:44:14,https://api.github.com/repos/nylas/sync-engine/git/commits/fbe02e93f364ecc4628f9974cdd10407ce8d53b4,fbe02e93f364ecc4628f9974cdd10407ce8d53b4,Delete more elasticsearch crvft
spang,2015-08-10 23:54:42,https://api.github.com/repos/nylas/sync-engine/git/commits/95dc4aff6f5adf4056a49c999a2622208dda6d94,95dc4aff6f5adf4056a49c999a2622208dda6d94,"Remove deprecated CACHE_BASEDIR and related code

We haven't used this code since we removed the janky caching of various
IMAP metadata from Gmail sync for consistency reasons."
emfree,2015-08-10 23:00:07,https://api.github.com/repos/nylas/sync-engine/git/commits/e37e82661f5395b956665a121d5427017b882799,e37e82661f5395b956665a121d5427017b882799,"Refine profiling instrumentation.

Summary:
Previous instrumentation of the codebase used pyinstrument out of the box, and
dumped its output to stdout on receiving SIGTRAP. This worked for ad-hoc
investigation of a single process, but is not amenable to collecting profiles
from multiple sync instances, tracking changes over time, etc.

Instead, expose raw profile data over a simple embedded HTTP interface, using
the line format popularized by https://github.com/brendangregg/FlameGraph. This
is easy to collect, slice, dice, visualise, etc.

Note: this is currently only for sync, mostly because it's easy to have each
sync process listen on a distinct, deterministic port. Don't have a good story
for API worker processes yet.

Test Plan: Run sync locally. Curl exposed profile endpoint.

Reviewers: kav-ya

Reviewed By: kav-ya

Differential Revision: https://phab.nylas.com/D1862"
spang,2015-08-10 22:19:57,https://api.github.com/repos/nylas/sync-engine/git/commits/3203110ad5f69971147afea736ed7246ef871ab7,3203110ad5f69971147afea736ed7246ef871ab7,Remove legacy InboxSession
emfree,2015-08-10 18:29:19,https://api.github.com/repos/nylas/sync-engine/git/commits/a1186d5da1758a470ec1ed18b36f17009fa7791d,a1186d5da1758a470ec1ed18b36f17009fa7791d,"Revert ""Default limit URL param set to 99 to appease microsoft""

This reverts commit 1818d20cc375ac6e4c2a93332dc9aa251c4b5722.

Reason for rollback: not thought through."
khamidou,2015-08-10 11:01:58,https://api.github.com/repos/nylas/sync-engine/git/commits/6d9b5d597c1c883d0fb2386c55d1ab7279b5eafa,6d9b5d597c1c883d0fb2386c55d1ab7279b5eafa,"Support more Hotmail/Outlook.com domains.

+ Fix tabs/spaces for Chinese providers"
khamidou,2015-08-10 10:58:07,https://api.github.com/repos/nylas/sync-engine/git/commits/e523305acdb7a178c707cfef91e3764a88b21191,e523305acdb7a178c707cfef91e3764a88b21191,fix migration order
khamidou,2015-08-10 10:35:39,https://api.github.com/repos/nylas/sync-engine/git/commits/4259446be941a8354d7d8ddad657c06a4df60f93,4259446be941a8354d7d8ddad657c06a4df60f93,"sync-engine changes for D1846

Summary: This diff adds a migration to add an `outlook_account` column to the `easaccount` table.

Test Plan: Tested manually

Reviewers: kav-ya, emfree

Subscribers: spang, mg

Differential Revision: https://phab.nylas.com/D1847"
khamidou,2015-08-07 11:15:25,https://api.github.com/repos/nylas/sync-engine/git/commits/4a70ef5140e9a41b8ad56999543d9d8d1ccbd763,4a70ef5140e9a41b8ad56999543d9d8d1ccbd763,Forgot a unit test when merging.
khamidou,2015-08-07 11:09:19,https://api.github.com/repos/nylas/sync-engine/git/commits/28ec985bf967145787e8ad8671953eebf000d318,28ec985bf967145787e8ad8671953eebf000d318,"Add received_before and received_after to the API

Summary:
`received_before=timestamp` returns all the messages received before `timestamp`
`received_after=timestamp` returns all the messages received after `timestamp`

Test Plan: Tested manually + added unit tests.

Reviewers: spang, emfree

Reviewed By: emfree

Differential Revision: https://phab.nylas.com/D1835"
khamidou,2015-08-07 10:02:28,https://api.github.com/repos/nylas/sync-engine/git/commits/cbe21b88b728f55512f0c3ea22dc6e218cefb0a1,cbe21b88b728f55512f0c3ea22dc6e218cefb0a1,"Clean up `noop_event_update`

Summary: This has been gnawing at me this weekend. This diff cleans up the code to be a bit more future-proof + we weren't saving updates to the `busy` attribute.

Test Plan: Tested manually + ran regression tests.

Reviewers: emfree

Reviewed By: emfree

Differential Revision: https://phab.nylas.com/D1767"
emfree,2015-08-06 23:11:06,https://api.github.com/repos/nylas/sync-engine/git/commits/5eea67927606a05106d2fa92746d873eb1352b55,5eea67927606a05106d2fa92746d873eb1352b55,"Properly allow API filtering by category ID.

Once again we have to hack around the stupid bitpacked UUID storage format."
emfree,2015-08-06 19:35:26,https://api.github.com/repos/nylas/sync-engine/git/commits/1d49e222312672e43e6e1b08528873d64559222e,1d49e222312672e43e6e1b08528873d64559222e,"Don't reset sync state on process restart.

Summary:
This logic is really brittle and demonstrably continues to produce spurious
reported dead account spikes on process restart. In my opinion, we should be
treating heartbeats akin to logs: written to by the application, and
interpreted by consumers. It would be pretty whack if your application had to
selectively delete logs in order for you to interpret them.

Test Plan: Run syncs. Needs proving at larger scale though.

Reviewers: spang

Reviewed By: spang

Differential Revision: https://phab.nylas.com/D1850"
kav-ya,2015-08-06 20:53:38,https://api.github.com/repos/nylas/sync-engine/git/commits/c93e4b36cbd715b5b2552701bd168e1fc78cb3ff,c93e4b36cbd715b5b2552701bd168e1fc78cb3ff,"Elementary input validation in update_thread(), update_message().
Fixes T2505, T2482."
emfree,2015-08-06 17:55:15,https://api.github.com/repos/nylas/sync-engine/git/commits/ab8366d4c39968411fa17931b0b63f93f54812ae,ab8366d4c39968411fa17931b0b63f93f54812ae,"Improve Google calendar initial sync strategy.

Summary:
* Commit updates in batches to avoid locking calendar table rows for extended
  periods of time.

* Improve database lookup strategy during first sync --
  previously we'd do always do a database query for each event to check if we
  already have it, which is not optimal when you have lots of new events and
  no already-synced ones. (Reduces time spent in `handle_event_updates` from
  ~40s to ~10s on a calendar with 1500 events).

Fixes T2422.

Test Plan:
Run initial sync, concurrently update calendar rows. There are still
lock waits but they are short.

Reviewers: spang

Reviewed By: spang

Maniphest Tasks: T2422

Differential Revision: https://phab.nylas.com/D1849"
emfree,2015-08-06 06:07:34,https://api.github.com/repos/nylas/sync-engine/git/commits/00418ccba5a7e7e06c5cff9ddbea42e313858ece,00418ccba5a7e7e06c5cff9ddbea42e313858ece,"Delete orphan threads on draft deletion.

Handle wrongly orphaned threads in receivedrecentdate calculation too so we
don't 500."
emfree,2015-08-05 21:55:07,https://api.github.com/repos/nylas/sync-engine/git/commits/e0a1188f06ede81b365894ede70c9402f3b8b548,e0a1188f06ede81b365894ede70c9402f3b8b548,Fix receivedrecentdate rendering for only-sent threads.
spang,2015-08-05 21:40:35,https://api.github.com/repos/nylas/sync-engine/git/commits/750e378f20b3c746a8f4019fc9861a52a37f8054,750e378f20b3c746a8f4019fc9861a52a37f8054,"Also start a database session when starting a console without an email address

Can't think of a time I wanted a console and NOT a database session."
emfree,2015-08-05 21:22:23,https://api.github.com/repos/nylas/sync-engine/git/commits/623d90e417bcdca72f0e06f58b8985de800c6a32,623d90e417bcdca72f0e06f58b8985de800c6a32,"Merge pull request #184 from closeio/limit-gc

Limit number of messages we fetch at a time when doing gc"
thomasst,2015-08-05 00:03:57,https://api.github.com/repos/nylas/sync-engine/git/commits/6153a3f26923147b21d973a143b411c9e96b1169,6153a3f26923147b21d973a143b411c9e96b1169,Limit number of messages we fetch at a time when doing gc
emfree,2015-08-05 20:25:22,https://api.github.com/repos/nylas/sync-engine/git/commits/a196d52d612a9163f75ebf63593e4b944e65d782,a196d52d612a9163f75ebf63593e4b944e65d782,"Fix typo giving wrong message folders/labels in expanded thread view.

Fixes Github issues #183, #180."
emfree,2015-08-05 18:53:44,https://api.github.com/repos/nylas/sync-engine/git/commits/ec42516a560c5527336915cd432a0cc2c85f6524,ec42516a560c5527336915cd432a0cc2c85f6524,"Increase retry count on IMAP errors.

Because of the current retry implementation, this means that a retry will
always occur on IMAP errors. We need to generally revisit this retry logic.
But this is better for now."
spang,2015-08-04 23:48:15,https://api.github.com/repos/nylas/sync-engine/git/commits/180657c75313c2ec7e3adadac0e997f954f3852c,180657c75313c2ec7e3adadac0e997f954f3852c,Fix namespace deletion test.
spang,2015-08-04 23:17:32,https://api.github.com/repos/nylas/sync-engine/git/commits/f8f14a479fa7e1549e57ea0d6cae7cc12818cdfc,f8f14a479fa7e1549e57ea0d6cae7cc12818cdfc,"Also print # of rows, not just batches, when batch deleting from a table"
spang,2015-08-04 22:50:23,https://api.github.com/repos/nylas/sync-engine/git/commits/68c52c595aeb5aa882e8be29b735458cd4b376ac,68c52c595aeb5aa882e8be29b735458cd4b376ac,"Make some table deletions more explicit in namespace deletion code.

This was working properly still because of database cascades, but this
makes things more explicit."
emfree,2015-08-04 22:41:59,https://api.github.com/repos/nylas/sync-engine/git/commits/83660d0b42e5491336709ae58be74a970273a8aa,83660d0b42e5491336709ae58be74a970273a8aa,"Use database name from config in pool instrumentation.

Summary:
If we opt to use MySQLdb rather than PyMySQL (as we might for result-fetching
performance), then `dbapi_connection` in the event listener is an instance of
`MySQLdb.connections.Connection` and does not expose a `db` attribute. So
instead just grab the database name from the config.

Test Plan:
change database URI to `mysql+mysqldb://...` and check that it
works.

Reviewers: systemizer

Reviewed By: systemizer

Differential Revision: https://phab.nylas.com/D1845"
systemizer,2015-08-04 22:10:08,https://api.github.com/repos/nylas/sync-engine/git/commits/8ddb97173d8e538e3f59fe7c2c9733fc5b0352e7,8ddb97173d8e538e3f59fe7c2c9733fc5b0352e7,Adding check-db script
spang,2015-08-04 22:03:59,https://api.github.com/repos/nylas/sync-engine/git/commits/06252a048ab91d7c8dd7cc9ee0ba7077885c4bb1,06252a048ab91d7c8dd7cc9ee0ba7077885c4bb1,"Remove search index deletion from delete-account-data.

The elasticsearch search service is currently deprecated."
spang,2015-08-04 21:40:41,https://api.github.com/repos/nylas/sync-engine/git/commits/61c7ac6b26934e23497e8da933bd915ff678a6ef,61c7ac6b26934e23497e8da933bd915ff678a6ef,Make console support exchange accounts
systemizer,2015-08-04 20:23:13,https://api.github.com/repos/nylas/sync-engine/git/commits/9740e5eb085fa02101fcb1418e15999677fa1cdf,9740e5eb085fa02101fcb1418e15999677fa1cdf,"Catch, Log, and Reraise encoding errors

Summary: Wrap encode function with a catchall exception. log and reraise

Test Plan: tested locally

Reviewers: emfree

Reviewed By: emfree

Differential Revision: https://phab.nylas.com/D1839"
emfree,2015-08-04 19:20:33,https://api.github.com/repos/nylas/sync-engine/git/commits/966c04a057e7e9c47fdd2bb44236510657f020ad,966c04a057e7e9c47fdd2bb44236510657f020ad,Add debugging profiler to API.
emfree,2015-08-04 18:53:59,https://api.github.com/repos/nylas/sync-engine/git/commits/c1483b9fe63c95df1c7d02b04b61d53fd8e85e77,c1483b9fe63c95df1c7d02b04b61d53fd8e85e77,"Use bakedquery, smarter loading patterns for performance.

Summary:
* Add rudimentary use of SQLAlchemy 1.0's bakedquery extension
  (http://docs.sqlalchemy.org/en/rel_1_0/orm/extensions/baked.html) to avoid
  repeatedly paying query compilation overhead on API requests.

* Improve loading pattern in message_read_api to avoid lazy loads.

The baked query stuff seems a bit clunky at first glance. We will surely
iterate on it, and can probably eventually produce a more idiomatic/reusable
interface. But we might as well ship this now.

Test Plan: Covered by unit tests.

Reviewers: systemizer, spang

Reviewed By: systemizer, spang

Subscribers: kav-ya

Differential Revision: https://phab.nylas.com/D1837"
spang,2015-08-04 18:47:52,https://api.github.com/repos/nylas/sync-engine/git/commits/4fe18fc0e830cc29612ed76440b4c4a465218b43,4fe18fc0e830cc29612ed76440b4c4a465218b43,"Fix unit test I broke.

No change too trivial to accidentally break the unit tests by not running them."
spang,2015-08-04 17:51:23,https://api.github.com/repos/nylas/sync-engine/git/commits/e4bfc5d66a6f3da4df6eae3dd7e3fc64e5606f50,e4bfc5d66a6f3da4df6eae3dd7e3fc64e5606f50,Clarify error message when SMTP server fails to verify
khamidou,2015-08-04 10:27:44,https://api.github.com/repos/nylas/sync-engine/git/commits/06aa3468bf67760ddc15c50e3ff98218264fdfce,06aa3468bf67760ddc15c50e3ff98218264fdfce,"Fix EAS folder id length

Summary:
Fixes T2458. Note that because we're using MySQL 5.6, the migration happens offline and locks the table. However, since we only have about 20k columns, it shouldn't take too long.

Test Plan: Upgraded a db dump.

Reviewers: kav-ya, emfree

Reviewed By: emfree

Subscribers: spang

Maniphest Tasks: T2458

Differential Revision: https://phab.nylas.com/D1827"
spang,2015-08-04 01:10:42,https://api.github.com/repos/nylas/sync-engine/git/commits/2937b3770fcb6d097b5801137271eac5a1658ba8,2937b3770fcb6d097b5801137271eac5a1658ba8,"Return 503 during send when SMTP cert validation fails for TLS-using SMTP servers.

The previous code only worked properly for straight SSL SMTP
connections, and the unit test only covered that case. Unfortunately, I
tried to add a unit test for the starttls case, but couldn't quite get
the socket upgrade working correctly. Just fixing the bug for now.

Fixes T2471"
spang,2015-08-04 00:45:52,https://api.github.com/repos/nylas/sync-engine/git/commits/34e7a810c31c29a303432caa71932046a246f833,34e7a810c31c29a303432caa71932046a246f833,Make inbox-console -c error out usefully without Python SDK.
spang,2015-08-04 00:40:51,https://api.github.com/repos/nylas/sync-engine/git/commits/3ba1437f31c464a0b26790ce210dcb386b027f52,3ba1437f31c464a0b26790ce210dcb386b027f52,Fix inbox-console with generic IMAP accounts.
kav-ya,2015-08-04 00:13:21,https://api.github.com/repos/nylas/sync-engine/git/commits/301d920a254ab9a69eccb771ad221cd57e6e962f,301d920a254ab9a69eccb771ad221cd57e6e962f,Add support for querying `/messages?in=<id>` as well.
systemizer,2015-08-03 17:03:08,https://api.github.com/repos/nylas/sync-engine/git/commits/1beb63c1b6b36b2f58ac8344f851684ae0cd7d3d,1beb63c1b6b36b2f58ac8344f851684ae0cd7d3d,"Change PROCESS_NUM to PROCESS_NAME since we want metrics everything
(not just mailsync)"
systemizer,2015-08-03 16:50:24,https://api.github.com/repos/nylas/sync-engine/git/commits/af836bf644bf331f2a32cb5dc221abb1b24aca95,af836bf644bf331f2a32cb5dc221abb1b24aca95,"Making process_num available through config via ENV vars

This is for reporting. Currently we only required process_num to be available to syncservice in order to shard accounts. However we also want metrics per process, and process_num + hostname acts as a good unique ID."
emfree,2015-07-31 23:45:33,https://api.github.com/repos/nylas/sync-engine/git/commits/0b739fac9d4b58daecf1f94a863160fe8634ef6a,0b739fac9d4b58daecf1f94a863160fe8634ef6a,"Fix message metadata update in IMAP UID resync; simplify.

Previously, `uid.message` could be None when we tried to call
`uid.message.update_metadata(...)`. Fixes T2445."
emfree,2015-07-31 01:21:52,https://api.github.com/repos/nylas/sync-engine/git/commits/c66efe47fa72a585adfada912f083c582de22c75,c66efe47fa72a585adfada912f083c582de22c75,Don't repeatedly add folders/labels to delta sync exclude_types.
jennielees,2015-07-30 23:08:44,https://api.github.com/repos/nylas/sync-engine/git/commits/30ed92cb9c8c863cb386cb535c5b5fdd314a3386,30ed92cb9c8c863cb386cb535c5b5fdd314a3386,"Check start time when deciding to include recurring event overrides

Summary: We were previously checking the UID on recurring event overrides to determine whether to include the 'inflated' version of an event or not. This worked because Google override UIDs are stored in the form ""originaluid_DATETIME"". However, EAS overrides have completely unique UIDs, so this patch changes the logic to check the time directly rather than making too-clever assumptions about the UID format.

Test Plan: Ensure unit tests still pass; also tested against a live EAS calendar with expand_recurring=True.

Reviewers: kav-ya

Differential Revision: https://phab.nylas.com/D1813"
systemizer,2015-07-30 20:26:15,https://api.github.com/repos/nylas/sync-engine/git/commits/cf7d7bea40efca0f49e5f7db61408e7648ce1cb0,cf7d7bea40efca0f49e5f7db61408e7648ce1cb0,remove unused hostname variable
systemizer,2015-07-30 19:23:06,https://api.github.com/repos/nylas/sync-engine/git/commits/465deab5af3d8d92975e87d0c8d302a9749ea7e8,465deab5af3d8d92975e87d0c8d302a9749ea7e8,"Adding stats for db pool

Summary: Adds DB Pool size stats to statsd

Test Plan: ran tests locally

Reviewers: emfree

Reviewed By: emfree

Differential Revision: https://phab.nylas.com/D1818"
spang,2015-07-30 18:49:10,https://api.github.com/repos/nylas/sync-engine/git/commits/86adc9fe859b10f30c92b6c5c5530c95db447019,86adc9fe859b10f30c92b6c5c5530c95db447019,"Merge pull request #178 from Eagles2F/chinesemail

Add major chinese mail providers"
Eagles2F,2015-07-30 04:49:04,https://api.github.com/repos/nylas/sync-engine/git/commits/f3d0dbe2ee9130f741736b384a1320feea67c0ec,f3d0dbe2ee9130f741736b384a1320feea67c0ec,update foxmail settings
Eagles2F,2015-07-30 04:39:34,https://api.github.com/repos/nylas/sync-engine/git/commits/38e2a501b1197932fd0acc37c8223ddfec233171,38e2a501b1197932fd0acc37c8223ddfec233171,double check foxmail
kav-ya,2015-07-30 04:14:00,https://api.github.com/repos/nylas/sync-engine/git/commits/345157894457bef45f6ac1da1aaadb39b2dffc83,345157894457bef45f6ac1da1aaadb39b2dffc83,"Revert ""[SCHEMA] Sync updates Message.categories only when it will not overwrite""

This reverts commit be1b951fe93fbf05647b88de54a71b8876e35473."
kav-ya,2015-07-29 23:35:48,https://api.github.com/repos/nylas/sync-engine/git/commits/be1b951fe93fbf05647b88de54a71b8876e35473,be1b951fe93fbf05647b88de54a71b8876e35473,"[SCHEMA] Sync updates Message.categories only when it will not overwrite
recent local modifications made through the API.

Summary:
Fixes 2375.

* Message.update_metadata() - called during sync - checks the ActionLog table for pending actions or recently successful actions.
These are indicative of recent local modifications to message.categories made through the API, so in these cases -
it does /not/ overwrite message.categories.
* API actions that modify a message's labels/ folder increment the message's categories_change_count.
This is an optimization and indicates whether Message.update_metadata()  need check the ActionLog table at all;
if categories_change_count=0, there are no recent local modifications to the message, and so it can directly
overwrite message.categories.

NOTE:
Inbox-eas requires a matching `update_message_categories()` function that queries the EASActionLog table too;
will submit that in a separate revision.

Test Plan:
Manual testing:
i. Sync with no API relevant actions runs as before
ii. Sync with pending actions/ recently successful actions does not overwrite message.categories
iii. Sync with no pending actions/ ""stale"" successful actions overwrites message.categories
iv. Repro reported issue and verify it is a non-issue.

Reviewers: emfree

Reviewed By: emfree

Differential Revision: https://phab.nylas.com/D1796"
systemizer,2015-07-30 00:20:22,https://api.github.com/repos/nylas/sync-engine/git/commits/d2bcd13ad614530c51cf115e0c2cf7513376d137,d2bcd13ad614530c51cf115e0c2cf7513376d137,Add database name to the namespace
systemizer,2015-07-29 23:42:29,https://api.github.com/repos/nylas/sync-engine/git/commits/c2e5ef0092a8af0539f05bf3ffb50f08b4ffc2ba,c2e5ef0092a8af0539f05bf3ffb50f08b4ffc2ba,"Initial mysql metrics. If this looks good, will add more

Summary: This adds a the 'name' parameter to the session_scope function. If the session is named (i.e. includes a name), then we will report metrics on the transaction latency to statsd

Test Plan: ran unit tests locally

Reviewers: emfree

Reviewed By: emfree

Differential Revision: https://phab.nylas.com/D1817"
jennielees,2015-07-29 17:57:06,https://api.github.com/repos/nylas/sync-engine/git/commits/19e7f02998fe5865573788df4bd7d676800f5658,19e7f02998fe5865573788df4bd7d676800f5658,Fix setup.sh logo formatting
kav-ya,2015-07-28 23:06:40,https://api.github.com/repos/nylas/sync-engine/git/commits/1358c3dd8197ee9b2ab045c591772d53611bcca6,1358c3dd8197ee9b2ab045c591772d53611bcca6,"Provide optional ""exclude_folders"" to Delta APIs.
Default is to exclude the folder and label objects from the Delta APIs, but
setting this parameter=False exposes them."
jennielees,2015-07-27 23:44:59,https://api.github.com/repos/nylas/sync-engine/git/commits/740127bee359c3c28db619b4721bde18bc23e96f,740127bee359c3c28db619b4721bde18bc23e96f,"Minor updates to folders/labels API

Summary:
* Return a single folder/label from the GET endpoint, instead of a list
* Allow use of the folder/label ID for the thread/message 'in' query
* Fix error message

(These all came up while working on the Python SDK.)

Test Plan: Ensured existing tests still pass.

Reviewers: kav-ya

Reviewed By: kav-ya

Differential Revision: https://phab.nylas.com/D1809"
systemizer,2015-07-25 00:02:09,https://api.github.com/repos/nylas/sync-engine/git/commits/6584a9da3ab79cd815d9eb81415d6388d4fee078,6584a9da3ab79cd815d9eb81415d6388d4fee078,"Adding first_message latency metric for imap/gmail

Summary: This will measure the latency between when the account was created and when the first message was synced for a given folder. This does add a database query, however this event happens only rarely, so it shouldn't affect performance too much

Test Plan: ran unit tests locally

Reviewers: emfree

Reviewed By: emfree

Differential Revision: https://phab.nylas.com/D1802"
khamidou,2015-07-24 11:48:35,https://api.github.com/repos/nylas/sync-engine/git/commits/b536c74b6c3ce3f17f77c5943552faa0a1eada34,b536c74b6c3ce3f17f77c5943552faa0a1eada34,"Fix bugs in the RSVP code. Notably:
- having the RSVP reply both in the body of the message and as an
  attachment was confusing Gmail.
- not setting DTSTAMP to datetime.datetime.utcnow() caused Gmail to not
  update the event's status."
emfree,2015-07-24 06:31:44,https://api.github.com/repos/nylas/sync-engine/git/commits/349eb9d087de39f90a400da9d5a32417777ba07b,349eb9d087de39f90a400da9d5a32417777ba07b,"Improve thread loading pattern in delta sync.

Also eager load Message.events in messages API, and remove unnecessary
Message.namespace default joinedload."
spang,2015-07-24 03:23:07,https://api.github.com/repos/nylas/sync-engine/git/commits/0ccd4c8c60a1ab964def4ec6e7706d8e89518d77,0ccd4c8c60a1ab964def4ec6e7706d8e89518d77,Fix /messages eager loading.
spang,2015-07-24 03:14:42,https://api.github.com/repos/nylas/sync-engine/git/commits/bfcd7e1a1b413bcf5ee977fa39c04c99872ca5f4,bfcd7e1a1b413bcf5ee977fa39c04c99872ca5f4,Fix subqueryloads for /threads.
emfree,2015-07-24 04:01:36,https://api.github.com/repos/nylas/sync-engine/git/commits/f289505ef1db03a24167d4f744ba8b2c0a94d027,f289505ef1db03a24167d4f744ba8b2c0a94d027,"Handle messages with no associated folder (e.g., local drafts)"
emfree,2015-07-23 20:32:08,https://api.github.com/repos/nylas/sync-engine/git/commits/0a322fc6943d647407b470399678ccf5a966939a,0a322fc6943d647407b470399678ccf5a966939a,"Add backcompat support for tags detail API, tag=unread filtering.

Fixes T2390."
emfree,2015-07-23 19:26:43,https://api.github.com/repos/nylas/sync-engine/git/commits/5b2eac9316caca3467fc65180bcae15363bd450d,5b2eac9316caca3467fc65180bcae15363bd450d,"Suppress folders and labels from delta API for now.

Fixes T2380."
kav-ya,2015-07-23 04:07:14,https://api.github.com/repos/nylas/sync-engine/git/commits/65d52bcfd93073d23eebe2c3161b08b9946f4990,65d52bcfd93073d23eebe2c3161b08b9946f4990,Update test as well.
kav-ya,2015-07-23 03:35:57,https://api.github.com/repos/nylas/sync-engine/git/commits/ffadddf8668e90ff7e35218eee1690be53742677,ffadddf8668e90ff7e35218eee1690be53742677,"Suppress ""Starred"" from the list of Gmail labels.
Fixes T2364."
emfree,2015-07-23 01:19:14,https://api.github.com/repos/nylas/sync-engine/git/commits/f30754b3584cfcee1a60b35687b3c470dc1bf7ac,f30754b3584cfcee1a60b35687b3c470dc1bf7ac,"Add minimal detection of excessive lazy-loading.

Summary:
Basically just keep track of how many queries are issued with a given
connection before commit() is called, and log a warning if that number is
high. This is a good way to tell if, for example, lots of things are being
lazily loaded. Also bind more logging context in the API, so that we can tell
which endpoints are doing these bad things.

Fixes T1098.

Test Plan: Run API. Issue some requests. Inspect logs. Recoil in horror.

Reviewers: spang

Reviewed By: spang

Maniphest Tasks: T1098

Differential Revision: https://phab.nylas.com/D1788"
emfree,2015-07-23 01:00:34,https://api.github.com/repos/nylas/sync-engine/git/commits/2c3aadf778f5eebf46553a849cb4cc24371ecfde,2c3aadf778f5eebf46553a849cb4cc24371ecfde,"Don't fail on UIDs for which no FETCH data is returned.

Some servers (GoDaddy) report the existence of UIDs, but don't return anything
if you try to go and fetch the body. For now, skip over these.

Note that we'll still repeatedly attempt to download these UIDs. That's better
than failing though.

Fixes T2014."
systemizer,2015-07-22 22:21:00,https://api.github.com/repos/nylas/sync-engine/git/commits/5a109e2ca0bf76610cb45b81ac496d33d564c0b7,5a109e2ca0bf76610cb45b81ac496d33d564c0b7,"Add message_velocity metric for gmail

I didn't notice that gmail overrides the download_and_commit_uids function. I could have put the logic in the download_uids function, however gmail also has a different way for downloading the All Mail folder not using download_uids. BUT it does use download_and_commit_uids, so I decided to keep the logic there. I abstracted away some of the logic to a _report_message_latency function"
emfree,2015-07-22 21:28:26,https://api.github.com/repos/nylas/sync-engine/git/commits/f64d26d35925f4558cf0e1471e9498f94a44b804,f64d26d35925f4558cf0e1471e9498f94a44b804,"Quote labels before mutating them.

Otherwise ""My Awesome Label"" gets added as three labels, ""My"", ""Awesome"",
""Label"".

Fixes T2381."
spang,2015-07-22 19:30:17,https://api.github.com/repos/nylas/sync-engine/git/commits/ea324ce1d7b5e4955cf85118e09d437a9e9f1e0b,ea324ce1d7b5e4955cf85118e09d437a9e9f1e0b,s/Inbox/Nylas (or sync engine)/
spang,2015-07-22 18:53:21,https://api.github.com/repos/nylas/sync-engine/git/commits/9fc194d235fadcbf00dbb301c3065fb3065b0ee5,9fc194d235fadcbf00dbb301c3065fb3065b0ee5,"Merge pull request #175 from closeio/optimize-fetch-corresponding-thread

fetch_corresponding_thread SQL performance optimization"
spang,2015-07-22 18:47:34,https://api.github.com/repos/nylas/sync-engine/git/commits/030d45b71ae43e93c07c842ed71b69907a19fdd3,030d45b71ae43e93c07c842ed71b69907a19fdd3,"Merge pull request #170 from closeio/fix-html-overflow-error

Catch OverflowError in handle_charref"
Eagles2F,2015-07-22 18:46:26,https://api.github.com/repos/nylas/sync-engine/git/commits/b13e403a19e948950e1ab370712d347201726b66,b13e403a19e948950e1ab370712d347201726b66,align indent
spang,2015-07-22 18:45:38,https://api.github.com/repos/nylas/sync-engine/git/commits/cc89db2a65a7fb5c497aa26987e3a432dea1da51,cc89db2a65a7fb5c497aa26987e3a432dea1da51,"Merge pull request #161 from closeio/fix-content-id-parsing

Fix database error when Content-ID is too long"
systemizer,2015-07-21 21:40:59,https://api.github.com/repos/nylas/sync-engine/git/commits/b745ef932ece2468678d61b55f4d129588ebe799,b745ef932ece2468678d61b55f4d129588ebe799,"Adding per-provider syncback, message latency, message velocity metrics

Summary:
per provider metrics for message latency

Adding message_velocity metric per provider

Test Plan: ran unit tests locally. my arc is still borked

Reviewers: emfree

Reviewed By: emfree

Differential Revision: https://phab.nylas.com/D1781"
kav-ya,2015-07-21 19:33:28,https://api.github.com/repos/nylas/sync-engine/git/commits/20fa8489c7a8f3d3900c2d2f6494b00160642025,20fa8489c7a8f3d3900c2d2f6494b00160642025,"Add Thread.has_attachments boolean
Fixes T2298."
Eagles2F,2015-07-21 19:30:22,https://api.github.com/repos/nylas/sync-engine/git/commits/ade6f5425f8daabc25633982b552458a0f65f348,ade6f5425f8daabc25633982b552458a0f65f348,improve domain for aliyun
kav-ya,2015-07-21 18:42:11,https://api.github.com/repos/nylas/sync-engine/git/commits/cffdbe3785c1445fe685387ad527b46974cfa4ce,cffdbe3785c1445fe685387ad527b46974cfa4ce,"Remove provider-prefix (currently only ""[Gmail]/"") in the API-returned ""display_name"".
Fixes T2349."
khamidou,2015-07-21 18:20:00,https://api.github.com/repos/nylas/sync-engine/git/commits/bb7d2f608a9a58564fbac77a1d062b26f7fc16c6,bb7d2f608a9a58564fbac77a1d062b26f7fc16c6,"[iCalendar] Fix a sync-breaking error

Summary: It seems we've found a special snowflake: a message in the ""Sent"" folder with no `From:` field. This diff simply adds some code to discard messages like this one.

Test Plan: Not really tested :(

Reviewers: emfree, jennie

Reviewed By: jennie

Maniphest Tasks: T2368

Differential Revision: https://phab.nylas.com/D1778"
emfree,2015-07-21 18:13:37,https://api.github.com/repos/nylas/sync-engine/git/commits/a1db45933abcaf02392fd445f87dd0842dcbb79c,a1db45933abcaf02392fd445f87dd0842dcbb79c,Fix TypeError in thread actions.
khamidou,2015-07-21 18:12:36,https://api.github.com/repos/nylas/sync-engine/git/commits/ef04730354af0a605f6df35e74ecf7ce35273ec5,ef04730354af0a605f6df35e74ecf7ce35273ec5,"Fix PytestTestEngine to work with the latest version of arcanist

Summary:
Updating to the latest version of arcanist broke PytestTestEngine. We were failing with the error `Attempt to write to undeclared property`.

It seems that the phab developers changed a couple properties on the object and it's now read-only. Fixed this by using a local variable.

Test Plan: The tests run.

Reviewers: jennie

Reviewed By: jennie

Differential Revision: https://phab.nylas.com/D1777"
Eagles2F,2015-07-21 06:34:25,https://api.github.com/repos/nylas/sync-engine/git/commits/9c46335adf799b14a07666367a1d21b5fe85b933,9c46335adf799b14a07666367a1d21b5fe85b933,Add major chinese mail providers
emfree,2015-07-21 02:40:30,https://api.github.com/repos/nylas/sync-engine/git/commits/d3d8d1153fae9d63d6cf9dc73a5d5cf020aed389,d3d8d1153fae9d63d6cf9dc73a5d5cf020aed389,"Fix message-level modifications inferred from thread update API.

Previously, updating a thread's labels would cause all those labels to be
applied to each message, which is wrong. For example, archiving a thread you've
replied to would cause the API to try to apply the 'sent' label to each
message.

Fixes T2325."
emfree,2015-07-20 21:54:11,https://api.github.com/repos/nylas/sync-engine/git/commits/ce251e14551d786e3b1eb8fb35ad757115cc5950,ce251e14551d786e3b1eb8fb35ad757115cc5950,"Synchronously delete drafts in IMAP sync.

Fixes T2353."
emfree,2015-07-19 00:54:41,https://api.github.com/repos/nylas/sync-engine/git/commits/88ac4d886c3b2b5b38f3884428fa6d809bdcc3de,88ac4d886c3b2b5b38f3884428fa6d809bdcc3de,Fix tests.
emfree,2015-07-19 00:47:18,https://api.github.com/repos/nylas/sync-engine/git/commits/8de23074eca274cae5b9a3069bbbc2b1849f37fc,8de23074eca274cae5b9a3069bbbc2b1849f37fc,Better manage Gmail inbox label.
emfree,2015-07-18 21:58:24,https://api.github.com/repos/nylas/sync-engine/git/commits/a58bc4d6ec7d4d421d90a56449814e82db1b3b9f,a58bc4d6ec7d4d421d90a56449814e82db1b3b9f,"Support view/limit/offset on folders/labels endpoint.

Also fix related bugs in which the view parameter was not implemented correctly
for calendars or contacts. Add some tests.

Fixes T2320."
emfree,2015-07-18 21:11:13,https://api.github.com/repos/nylas/sync-engine/git/commits/822c40aa92dcd2db67cd033587e8fb7b6d323ae0,822c40aa92dcd2db67cd033587e8fb7b6d323ae0,"Don't fail in event import if message From header is missing.

Fixes T2326."
emfree,2015-07-17 21:56:33,https://api.github.com/repos/nylas/sync-engine/git/commits/504c74607b5c9413ccb638730dc7a3057765e661,504c74607b5c9413ccb638730dc7a3057765e661,Fix management of Gmail 'canonical' labels.
jennielees,2015-07-17 22:25:55,https://api.github.com/repos/nylas/sync-engine/git/commits/c5f8cf4acf9bfe0b9c33544f8def28332cef0463,c5f8cf4acf9bfe0b9c33544f8def28332cef0463,"Fully reset sync status

Summary:
Builds on the 'reset heartbeat when sync starts' logic to also reset the folder sync_should_run flag, and then flip it back to the right state when we know for sure that folder should be running. The goal is to avoid stale state when an account restarts, which can lead to a temporary 'dead' status. There is still a short period between resetting state and having every folder report in, which makes sense and should be dealt with at the reporting level.

Context in T2315.

Test Plan: Restart syncs while observing status.

Reviewers: emfree

Reviewed By: emfree

Differential Revision: https://phab.nylas.com/D1756"
emfree,2015-07-17 03:14:05,https://api.github.com/repos/nylas/sync-engine/git/commits/3d594e28cbbcb1d426a7b9bab2575ac7868ff460,3d594e28cbbcb1d426a7b9bab2575ac7868ff460,Depend on upstream PyNaCl.
emfree,2015-07-17 03:03:01,https://api.github.com/repos/nylas/sync-engine/git/commits/eb3d5c78255e3b9d60f7b1f1a1379017058c0417,eb3d5c78255e3b9d60f7b1f1a1379017058c0417,Add migration for Exchange bookkeeping.
emfree,2015-07-17 01:19:00,https://api.github.com/repos/nylas/sync-engine/git/commits/d1cea09aa6f15295b709c46b4105505a7d82425d,d1cea09aa6f15295b709c46b4105505a7d82425d,"Simplify SMTP auth; don't fail if AUTH PLAIN is unsupported.

Remove some misguided code that attempted to check for AUTH PLAIN support. Some
servers only do AUTH LOGIN. Remove equally nonsensical code that attempted to
do a manual fallback if login() failed. This code failed to check the response
code, instead catching an exception that can never be thrown. As a result,
attempts to send without valid credentials could return a misleading error
respoonse."
emfree,2015-07-17 00:43:26,https://api.github.com/repos/nylas/sync-engine/git/commits/bbfdd0b37536f2b521642232bf0c6cf6c63fda5d,bbfdd0b37536f2b521642232bf0c6cf6c63fda5d,"Fix view=count for contacts API.

Fixes T2321."
systemizer,2015-07-16 23:15:51,https://api.github.com/repos/nylas/sync-engine/git/commits/623841189d3e68925d03491309bd346e535929d4,623841189d3e68925d03491309bd346e535929d4,Fix bug if folders array is empty during initial_sync metric calculation
systemizer,2015-07-16 22:27:44,https://api.github.com/repos/nylas/sync-engine/git/commits/41cafff196414e09ee3c3165c42a07a7f0d8f6e3,41cafff196414e09ee3c3165c42a07a7f0d8f6e3,"Add overall metric for message sync latency

In addition to per account metrics, it would be nice to have an aggregated metric 'overall'"
systemizer,2015-07-16 21:47:22,https://api.github.com/repos/nylas/sync-engine/git/commits/c2eaf12496fc61ed9f6474125e2f5873d228df66,c2eaf12496fc61ed9f6474125e2f5873d228df66,Use utcnow instead of created_at because the field may not yet be populated
thomasst,2015-07-16 20:59:25,https://api.github.com/repos/nylas/sync-engine/git/commits/1b3c6d15d720548040e3ed0ddc2657d3580a36fe,1b3c6d15d720548040e3ed0ddc2657d3580a36fe,fetch_corresponding_thread SQL performance optimization
emfree,2015-07-16 21:22:33,https://api.github.com/repos/nylas/sync-engine/git/commits/91272b544489e57f11ac508aa389dc36cd72031c,91272b544489e57f11ac508aa389dc36cd72031c,Fix typos.
khamidou,2015-07-16 21:06:16,https://api.github.com/repos/nylas/sync-engine/git/commits/61f176a04e9cab15da94c4160f30ae9f333006b3,61f176a04e9cab15da94c4160f30ae9f333006b3,"Don't syncback event updates if we don't have to

Summary: It seems syncing back every change, all the time can trigger weird race conditions in some backends.

Test Plan: Added lots of tests. Stared at the code for a long time.

Reviewers: emfree

Projects: #calendars

Differential Revision: https://phab.nylas.com/D1757"
systemizer,2015-07-16 21:02:04,https://api.github.com/repos/nylas/sync-engine/git/commits/ffda3f20236dc8f938dcb17d77f4f870b962ad59,ffda3f20236dc8f938dcb17d77f4f870b962ad59,"Adding statsd metrics for message sync latency during poll

also checnaging messages_downloaded metric to be a gauge of the total downloaded messages instead of a rate."
khamidou,2015-07-16 15:47:12,https://api.github.com/repos/nylas/sync-engine/git/commits/341c357e143d47852f6246f7d597b26442365172,341c357e143d47852f6246f7d597b26442365172,"Fix QA bugs in invite sending

Summary:
This diff fixes three things:

1. iCalendar invites sent through EAS now have a description field. We were including the field in the iCalendar files we generate but EAS was silently stripping it. After staring for a long time at the iCalendar files Outlook 2010 generates, I noticed that this field must be at the top of the file to be processed by Exchange (!).
2.When sending an update to an event, the subject of the email is now ""Updated invitation: ...""
3. I refactored the `generate_invite_message` function to not take an HTML string as a parameter.

Test Plan: Tested manually by sending an invite, updating it and cancelling the event.

Reviewers: jennie, spang

Reviewed By: spang

Projects: #calendars

Maniphest Tasks: T2307

Differential Revision: https://phab.nylas.com/D1752"
khamidou,2015-07-16 09:38:02,https://api.github.com/repos/nylas/sync-engine/git/commits/57c7a65de1c8299c20ae13e24e8170fff38529b8,57c7a65de1c8299c20ae13e24e8170fff38529b8,"[api] Disable updates to recurring events

Summary:
We don't support syncing back recurring events, so it doesn't make sense to allow people updating them.

Note that this diff doesn't make recurring events read-only because it would make things needlessly complicated when we'll add syncback support.

Test Plan: Tested by trying to update an override to a recurring event.

Reviewers: emfree, jennie

Reviewed By: jennie

Maniphest Tasks: T1267

Differential Revision: https://phab.nylas.com/D1747"
systemizer,2015-07-15 21:36:05,https://api.github.com/repos/nylas/sync-engine/git/commits/39d8571f5044e5a8e512c235bcf95b0adfbbfde7,39d8571f5044e5a8e512c235bcf95b0adfbbfde7,Adding syncback statsd metrics
systemizer,2015-07-15 19:19:49,https://api.github.com/repos/nylas/sync-engine/git/commits/a677d9da01680ab713d58358b23104052474516f,a677d9da01680ab713d58358b23104052474516f,Adding statsd and new metric in report_progress method
systemizer,2015-07-15 19:22:41,https://api.github.com/repos/nylas/sync-engine/git/commits/0186e6a34a89dfeb38e8d1b47ece80ded0fff11e,0186e6a34a89dfeb38e8d1b47ece80ded0fff11e,"Add column initial_synced_at to Folder that reports when initial_sync is done

Summary:
This must be done at the folder level because the initial/poll/etc state occurs
at the folder level. To help determine when an account has completed initial
sync, I've added a @property function that looks at the folders for that
account to determine when all the folders completed that sync

Test Plan: Looking at the current tests, it was not obvious to me how to add tests in the situation where syncs are actually run. We have tests that create foldersyncengines but I couldn't find any that ran the syncs. Given this is only for metrics, the code is simple, and it doesn't break current tests, I thought this is good enough. If you disagree I can spend more time looking into adding a test.

Reviewers: emfree

Reviewed By: emfree

Differential Revision: https://phab.nylas.com/D1733"
emfree,2015-07-15 06:28:21,https://api.github.com/repos/nylas/sync-engine/git/commits/e6e144c38edb9121f7f03b5b8ed164692e4b36b9,e6e144c38edb9121f7f03b5b8ed164692e4b36b9,"Remove failing test assertion.

The expected invite body contents were removed in 7cab58f5f4."
emfree,2015-07-14 22:47:13,https://api.github.com/repos/nylas/sync-engine/git/commits/a86cd6fa314b3f5b653d5dd4dd8a00a04454b667,a86cd6fa314b3f5b653d5dd4dd8a00a04454b667,"Explicitly delete messages to ensure delete revisions are created.

Fixes T2296.

Test plan: Regression test added."
spang,2015-07-14 21:04:36,https://api.github.com/repos/nylas/sync-engine/git/commits/7cab58f5f47a80d7265028be480e7cfcb3650fe3,7cab58f5f47a80d7265028be480e7cfcb3650fe3,"Use blank bodies for invites/cancellations for first version.

The previous code contained dates in a confusing format. IMHO it's
better to leave the body blank by default and let the client pull out
whatever information it wants to display."
kav-ya,2015-07-10 22:40:15,https://api.github.com/repos/nylas/sync-engine/git/commits/1353138c5b7fab4d21272b7bcaa93056042fffb8,1353138c5b7fab4d21272b7bcaa93056042fffb8,"Create, update APIs and syncback for folders, labels.

Summary:
* Support to create and update the folders (generic IMAP, Exchange) and labels (Gmail)
of an account.
* Syncback to the remote backend.

Test Plan:
Tested manually against Gmail, generic IMAP accounts.
(Unit tests for all the folders, labels APIs is pending for
some point in the future).

Reviewers: emfree

Reviewed By: emfree

Differential Revision: https://phab.nylas.com/D1738"
khamidou,2015-07-14 15:39:57,https://api.github.com/repos/nylas/sync-engine/git/commits/6c32c2c8390d42e05829d593af88fd10d8203728,6c32c2c8390d42e05829d593af88fd10d8203728,"[feat] Send invites to events

Summary:
**Summary**: This diff is massive rework of the previous version. Here’s what changed:

1. Better iCalendar merging algorithms. It’s now possible to send an invite, have the participants RSVP to us and the sync engine will transparently update the participants statuses in the db and on the backend (for Google and EAS).

2. Better compatibility with Gmail and Exchange. Gmail has this very annoying bug/feature where sending invites between two gmail accounts uses an internal API instead of sending emails. This is a problem because we would send invites, people would RSVP and we wouldn’t know. I fixed this by changing the ORGANIZER and UID fields from the event to values Google calendar uses (ORGANIZER=calendar_address@groups.google.com and UID=event_uid@google.com) and amazingly it works!

**Migrations**: I had to add a new column to the event table, `sequence_number`. It’s an integer which used as a revision number of sorts for iCalendar events.

**API**: This diff only has a debug api (GET /events/<id>/invite will send an invite to all the participants). I’m planning to change it to something similar to the RSVP api (i.e: sending a POST with no body to /events/<id>/invite will send an invite to every participant)

**What needs to be done**:
- general code cleanup
- settle on an API
- unit tests
- I still need to address Eben’s comments from D1673 about sending emails
- there’s an annoying version-related bug with EAS where it won’t accept invites from Gmail accounts because of an EAS-version issue (https://community.office365.com/en-us/f/158/t/352990).

I can’t wait to ship this!

Test Plan: Tested manually with EAS and Gmail. Unit tests are coming, though it's complicated to test compatibility with providers.

Reviewers: emfree, jennie

Reviewed By: jennie

Subscribers: ethanb, spang

Projects: #calendars

Maniphest Tasks: T2274, T1873

Differential Revision: https://phab.nylas.com/D1703"
emfree,2015-07-13 17:39:16,https://api.github.com/repos/nylas/sync-engine/git/commits/80ba666793d863d7c2430238ddcc88acae5e227e,80ba666793d863d7c2430238ddcc88acae5e227e,"Merge pull request #173 from closeio/fix-migration-187

Fix migration 187 for non-EAS"
thomasst,2015-07-11 03:59:40,https://api.github.com/repos/nylas/sync-engine/git/commits/7544dddc7137b0805a3db4941f4c55846c23cf1d,7544dddc7137b0805a3db4941f4c55846c23cf1d,Fix migration for non-EAS
emfree,2015-07-10 20:57:40,https://api.github.com/repos/nylas/sync-engine/git/commits/f925617e2fb36b1e06acf639cb4a3253f3aef237,f925617e2fb36b1e06acf639cb4a3253f3aef237,"Revert ""[feat] Send invites to events""

This reverts commit 91d5eb98c5789c56c8a2958fa904f86ea2506ff2.

Reason for rollback: Breaks sync."
jennielees,2015-07-10 19:17:35,https://api.github.com/repos/nylas/sync-engine/git/commits/72406dbc9f1da099fdca7df82fe0abcbf38c5f3a,72406dbc9f1da099fdca7df82fe0abcbf38c5f3a,Clear heartbeats before initializing a new account sync
khamidou,2015-07-10 13:41:44,https://api.github.com/repos/nylas/sync-engine/git/commits/91d5eb98c5789c56c8a2958fa904f86ea2506ff2,91d5eb98c5789c56c8a2958fa904f86ea2506ff2,"[feat] Send invites to events

Summary:
**Summary**: This diff is massive rework of the previous version. Here’s what changed:

1. Better iCalendar merging algorithms. It’s now possible to send an invite, have the participants RSVP to us and the sync engine will transparently update the participants statuses in the db and on the backend (for Google and EAS).

2. Better compatibility with Gmail and Exchange. Gmail has this very annoying bug/feature where sending invites between two gmail accounts uses an internal API instead of sending emails. This is a problem because we would send invites, people would RSVP and we wouldn’t know. I fixed this by changing the ORGANIZER and UID fields from the event to values Google calendar uses (ORGANIZER=calendar_address@groups.google.com and UID=event_uid@google.com) and amazingly it works!

**Migrations**: I had to add a new column to the event table, `sequence_number`. It’s an integer which used as a revision number of sorts for iCalendar events.

**API**: This diff only has a debug api (GET /events/<id>/invite will send an invite to all the participants). I’m planning to change it to something similar to the RSVP api (i.e: sending a POST with no body to /events/<id>/invite will send an invite to every participant)

**What needs to be done**:
- general code cleanup
- settle on an API
- unit tests
- I still need to address Eben’s comments from D1673 about sending emails
- there’s an annoying version-related bug with EAS where it won’t accept invites from Gmail accounts because of an EAS-version issue (https://community.office365.com/en-us/f/158/t/352990).

I can’t wait to ship this!

Test Plan: Tested manually with EAS and Gmail. Unit tests are coming, though it's complicated to test compatibility with providers.

Reviewers: emfree, jennie

Reviewed By: jennie

Subscribers: ethanb, spang

Projects: #calendars

Maniphest Tasks: T1873

Differential Revision: https://phab.nylas.com/D1703"
emfree,2015-07-09 18:05:59,https://api.github.com/repos/nylas/sync-engine/git/commits/caa0fdbdd41f964716b6debdec062c1f495baf72,caa0fdbdd41f964716b6debdec062c1f495baf72,Also randomize retry interval on calendar API 500s.
emfree,2015-07-09 17:22:50,https://api.github.com/repos/nylas/sync-engine/git/commits/eb02dae5259283b5fef534985f92e0a7f5de08c3,eb02dae5259283b5fef534985f92e0a7f5de08c3,Introduce some randomness into calendar sync retry to prevent herding.
khamidou,2015-07-09 15:45:20,https://api.github.com/repos/nylas/sync-engine/git/commits/17e4424ab6bb9c05792bd7aa7a65e3427f026462,17e4424ab6bb9c05792bd7aa7a65e3427f026462,"Log bogus iCalendar files and fix this UnboundLocalError

Summary:
I've tried fixing yesterday's UnboundLocalError but without the iCalendar file causing the bug I could only make guesses.

My theory is that somehow we got an event with a `start` as a datetime and an `end` as a date. I've added an assert to check this and logging code to save the iCalendar file. I feel it's better than randomly fixing something and hoping we won't get the same error in two weeks.

Test Plan: Inspected the code.

Reviewers: emfree

Reviewed By: emfree

Subscribers: spang

Projects: #calendars

Maniphest Tasks: T2213

Differential Revision: https://phab.nylas.com/D1712"
kav-ya,2015-06-02 21:21:20,https://api.github.com/repos/nylas/sync-engine/git/commits/aab410f36458e38af4c07c06dc7896fdeacb9875,aab410f36458e38af4c07c06dc7896fdeacb9875,"[SCHEMA] The Folders and Labels APIs.

This monstrous commit introduces the folders and labels APIs,
a set of provider-dependent APIs to retrieve and modify the
folders/labels associated with messages and threads:

* Provider-dependent APIs -
Depending on the provider, an account may be organized by folders (Exchange, generic IMAP) or
labels (Gmail); folders and labels have fundamentally different semantics, and these are
preserved in the APIs.

* Expose folders/ labels at both the message, thread -levels -
- The 'message' object returned by the API includes the folder a message is in/ labels associated with it;
the 'thread' object includes a list of all the folders the thread has messages in/ labels on the thread.
- The messages/ threads in a certain folder/ label can be retrieved using a new filter query param ('in')
as well.

* Syncback support to modify the folders/ labels of messages, threads -
A message can be moved between folders/ its labels can be updated;
the thread operations are a convenient shortcut to perform bulk operations on messages,
whereby an operation on a thread is performed on all the messages in the thread.

The folders and labels APIs are intended to eventually replace the tags APIs.
However, both are currently supported and this commit does /not/ remove support
for the latter.

NOTE:
The following changes are also included:
* 'unread', 'starred' as independent message and thread -level attributes
that can be read and modified as above.
* Support for syncing multiple IMAP folders with same flag."
emfree,2015-07-08 19:23:43,https://api.github.com/repos/nylas/sync-engine/git/commits/1fdbcd0032b9fcaa327feb91223a2c431332131a,1fdbcd0032b9fcaa327feb91223a2c431332131a,"Handle deleted app credentials in OAuth token renewal.

Fixes T2260."
khamidou,2015-07-06 11:57:27,https://api.github.com/repos/nylas/sync-engine/git/commits/872f319fd051ae8959872d52860497dae35e8d5a,872f319fd051ae8959872d52860497dae35e8d5a,"Filter cancelled recurring events too.

Summary: We were filtering regular events when `show_cancelled` was false, but we weren't doing the same for recurring events.

Test Plan: Tested manually.

Reviewers: jennie

Reviewed By: jennie

Subscribers: spang

Projects: #api

Maniphest Tasks: T2214

Differential Revision: https://phab.nylas.com/D1706"
grinich,2015-07-05 21:17:23,https://api.github.com/repos/nylas/sync-engine/git/commits/9fe07cb0bca0fb3ca2a009fb5cd929f0aea00eab,9fe07cb0bca0fb3ca2a009fb5cd929f0aea00eab,"Add final support for the /delta/longpoll API endpoint

Summary: This is similar to streaming endpoint, but is designed to be used client-side by web browsers that cannot parse incomplete reponses from the server. If no data is available it will hang the HTTP connection (i.e. ""long poll"") for the specified `timeout` or until new data is available.

Test Plan: passes tests!

Reviewers: spang

Reviewed By: spang

Maniphest Tasks: T1317

Differential Revision: https://phab.nylas.com/D1716"
spang,2015-07-05 16:29:33,https://api.github.com/repos/nylas/sync-engine/git/commits/6dc94380b07fbaf574034f6a12c4449e92887133,6dc94380b07fbaf574034f6a12c4449e92887133,"[DEP] Switch to icalendar HEAD.

We submitted a bugfix for a performance issue upstream over three weeks
ago and they still haven't cut a new release though they said they'd do
it that week.

Fixes T1967"
thomasst,2015-07-03 20:00:34,https://api.github.com/repos/nylas/sync-engine/git/commits/097ed2c7256d22faec6627ad5317bac7cf10b3db,097ed2c7256d22faec6627ad5317bac7cf10b3db,Catch OverflowError in handle_charref
spang,2015-07-02 21:48:41,https://api.github.com/repos/nylas/sync-engine/git/commits/d172b89a882b3262918961bdd8c519142fb15c0b,d172b89a882b3262918961bdd8c519142fb15c0b,Document that accounts must be marked as deleted before their data can be deleted.
emfree,2015-07-01 21:49:29,https://api.github.com/repos/nylas/sync-engine/git/commits/410c209d00a01b8a765a81c3c57eb2eb856bafc5,410c209d00a01b8a765a81c3c57eb2eb856bafc5,"Store last_sync timestamp on Calendars, not Accounts.

Summary:
Previously, this timestamp would only be persisted after events for all
calendars were synced. If an account has multiple large calendars, this can
create a condition in which initial sync resumes completely from the beginning
if it's interrupted for any reason.

Instead, just maintain the timestamp on a per-calendar basis. Initial sync of
an individual calendar will still restart de novo if interrupted, but that's
less problematic.

Test Plan: Run migration, syncs.

Reviewers: danny, kav-ya

Reviewed By: kav-ya

Subscribers: khamidou

Differential Revision: https://phab.nylas.com/D1711"
khamidou,2015-07-02 10:47:23,https://api.github.com/repos/nylas/sync-engine/git/commits/90b87d1c39a5551e2c0c29798bff615a3dddb0b6,90b87d1c39a5551e2c0c29798bff615a3dddb0b6,"A tiny script to make querying objects quicker

Summary:
This script is `get-id`'s little brother. Instead of printing the id of an object, `get-object` fetches the object and drops you inside a REPL with the object in scope.

Gone are the days of writing a one-off script because you need to query a python property of an object!

Test Plan: Tested manually.

Reviewers: spang, jennie

Reviewed By: jennie

Differential Revision: https://phab.nylas.com/D1699"
emfree,2015-07-01 20:18:53,https://api.github.com/repos/nylas/sync-engine/git/commits/8ead16b2b6d68eb552dd58208232a9c9b8ac6d7e,8ead16b2b6d68eb552dd58208232a9c9b8ac6d7e,"Also defer loading ImapUid.folder in `update_metadata`.

The folder is also not needed, in general."
emfree,2015-07-01 19:37:03,https://api.github.com/repos/nylas/sync-engine/git/commits/e27e16eac7856d33de24cd5364ba0400bf555625,e27e16eac7856d33de24cd5364ba0400bf555625,"Remove expensive joinedload in IMAP sync's `update_metadata`.

We can still get a lot smarter here with our flags refresh strategy. But in the
meantime, this is an improvement, because in general we don't end up actually
updating messages in generic IMAP flags refresh."
emfree,2015-07-01 19:16:39,https://api.github.com/repos/nylas/sync-engine/git/commits/a247bc12b0b91c2b9461d4b2a84bf6ed76ec234d,a247bc12b0b91c2b9461d4b2a84bf6ed76ec234d,"Depend on SQLAlchemy 1.0.

The potential issue described in d58bded3c has been fixed."
khamidou,2015-07-01 18:51:28,https://api.github.com/repos/nylas/sync-engine/git/commits/5baa00ab6b2e424cdb8d225e1ff4b1a62e89da3a,5baa00ab6b2e424cdb8d225e1ff4b1a62e89da3a,"Fix UnboundLocalError in ical.py

Summary: I added a bunch of common exceptions too.

Test Plan: not really tested.

Reviewers: emfree

Reviewed By: emfree

Maniphest Tasks: T2216

Differential Revision: https://phab.nylas.com/D1708"
emfree,2015-06-30 23:25:47,https://api.github.com/repos/nylas/sync-engine/git/commits/f33957dc5b5cb8ef8d7894aadb637815923af8bd,f33957dc5b5cb8ef8d7894aadb637815923af8bd,Depend on upstream IMAPClient.
emfree,2015-06-30 21:05:05,https://api.github.com/repos/nylas/sync-engine/git/commits/eaaa0c940a9a840ed85e2e27eeb5450d8eee9c8d,eaaa0c940a9a840ed85e2e27eeb5450d8eee9c8d,Make calendar sync poll interval configurable.
emfree,2015-06-29 20:10:17,https://api.github.com/repos/nylas/sync-engine/git/commits/86229076b942e225639902ad563c95ad3c7a8a68,86229076b942e225639902ad563c95ad3c7a8a68,"Simplify contacts filtering API to prevent performance degradation.

Fixes T1883."
emfree,2015-06-26 23:18:18,https://api.github.com/repos/nylas/sync-engine/git/commits/009dc37c6d04c6da78c678a17b1b71c18ecb2d78,009dc37c6d04c6da78c678a17b1b71c18ecb2d78,Add missing fixture dependency.
emfree,2015-06-26 23:08:37,https://api.github.com/repos/nylas/sync-engine/git/commits/91f4f17647a70315d67b5218214ffcda26e400fb,91f4f17647a70315d67b5218214ffcda26e400fb,Don't need autouse in tests.
emfree,2015-06-26 22:26:58,https://api.github.com/repos/nylas/sync-engine/git/commits/cd2cd08a8434ef50fd01c6e10d8bafed9de1a82a,cd2cd08a8434ef50fd01c6e10d8bafed9de1a82a,Add conftest file missing from previous commit.
emfree,2015-06-25 22:39:02,https://api.github.com/repos/nylas/sync-engine/git/commits/be59126ef239b48f6ad6503ee457e421fe8cb6d1,be59126ef239b48f6ad6503ee457e421fe8cb6d1,"Redo tests to not depend on dump file.

This allows for substantially faster and more maintainable tests. There are
still many rough edges, but this works. A test database is now generated from
declarative models at the start of a test session instead of being loaded from
a dumpfile.  The `default_account`/`default_namespace` fixtures can be used to
create a new Account/Namespace object for each test function. This means that
for most tests that operate on only a single namespace, any other state in the
test database is irrelevant."
khamidou,2015-06-26 16:53:07,https://api.github.com/repos/nylas/sync-engine/git/commits/73a936695278e3d8ee5cc1a18a30ccead3fb607d,73a936695278e3d8ee5cc1a18a30ccead3fb607d,"Fix an EAS reconciling bug

Summary:
This bug is funny ;) Some messages (particularly self-sent messages, or sent through a mailing list) were not reconciled correctly. This is because the reconciliation code does this to get all potentially-related messages:

```
 msgs = db_session.query(Message).filter(
        Message.namespace_id == new_message.namespace_id,
        Message.subject == new_message.subject,
        Message.message_id_header == new_message.message_id_header).all()
```

The problem is that when we're sending a draft we're not setting `message_id_header` before sending it, which means we won't find it afterwards.

Test Plan: Tested manually.

Reviewers: kav-ya, emfree

Reviewed By: emfree

Maniphest Tasks: T1904

Differential Revision: https://phab.nylas.com/D1691"
khamidou,2015-06-26 13:54:06,https://api.github.com/repos/nylas/sync-engine/git/commits/fa5e163e8923edd1993b49a2ba342bac30a443c4,fa5e163e8923edd1993b49a2ba342bac30a443c4,"Fix read_only permissions for Google events (again!)

Summary:
After thinking a bit more about this bug and testing how D1682 worked with shared calendars, I decided to scrap my previous diff and instead rely on the ACL data google gives us.

This required some very light changes to the the calendar and event sync and in return we get to support regular calendars, shared calendars and free/busy calendars.

Test Plan: Tested manually.

Reviewers: jennie

Reviewed By: jennie

Projects: #calendars

Maniphest Tasks: T2073

Differential Revision: https://phab.nylas.com/D1690"
khamidou,2015-06-25 15:37:16,https://api.github.com/repos/nylas/sync-engine/git/commits/37251c688b546479bfc8282e2577e26284498c30,37251c688b546479bfc8282e2577e26284498c30,upgraded test dump
khamidou,2015-06-25 10:17:17,https://api.github.com/repos/nylas/sync-engine/git/commits/d14f2161af4f01d71d710f6d00080d652c074bc2,d14f2161af4f01d71d710f6d00080d652c074bc2,"Add an option to disable the greenlet tracer

Summary: The greenlet tracer is annoying when using pdb because it prints a warning every 30 seconds. This diff adds a switch to disable it. It's still on by default, though.

Test Plan: Tested manually.

Reviewers: emfree

Reviewed By: emfree

Projects: #sync-engine

Differential Revision: https://phab.nylas.com/D1681"
emfree,2015-06-24 19:35:04,https://api.github.com/repos/nylas/sync-engine/git/commits/5e39ebd8d958d9faeb98fff1e7e50166727c52f0,5e39ebd8d958d9faeb98fff1e7e50166727c52f0,Actually fix migration.
emfree,2015-06-24 19:03:54,https://api.github.com/repos/nylas/sync-engine/git/commits/62e5d2179004f534d384e8d13b4249e4c0e36648,62e5d2179004f534d384e8d13b4249e4c0e36648,"Enlarge event.description field (part 2).

Test Plan: Unit tests.

Reviewers: khamidou

Reviewed By: khamidou

Differential Revision: https://phab.nylas.com/D1678"
emfree,2015-06-24 18:55:03,https://api.github.com/repos/nylas/sync-engine/git/commits/005f73c1bb43547d670a5ed4d5528eb6f7d00d18,005f73c1bb43547d670a5ed4d5528eb6f7d00d18,Fix migration.
emfree,2015-06-24 17:55:14,https://api.github.com/repos/nylas/sync-engine/git/commits/d9c54201d2bec17b82aa19c9c9fd6ed923eea715,d9c54201d2bec17b82aa19c9c9fd6ed923eea715,"Enlarge event.description field (part 1).

Summary:
Do this via the usual rigamarole:

1) Add new column
2) Update code to write to both
3) Migrate existing data to new column
4) Update code to only read/write new column
5) Drop old column.

Fixes T2062.

Test Plan: Run sync; migrations.

Reviewers: khamidou

Reviewed By: khamidou

Maniphest Tasks: T2062

Differential Revision: https://phab.nylas.com/D1677"
emfree,2015-06-22 22:47:06,https://api.github.com/repos/nylas/sync-engine/git/commits/04c1f3b5b3acb1e8ea23a51e414dad953ae38e3d,04c1f3b5b3acb1e8ea23a51e414dad953ae38e3d,"Prevent post-send exceptions from causing false error response.

Summary:
Previously, improperly handled database exceptions /after/ actual sending could
cause a request to the /send endpoint to return an error despite the message
having been sent. Fix this by performing all work and flushing updated
state upfront, so that a prepared response can be returned after a successful
send.

Also properly handle `ActionError`s that are raised if requests are refused
because the account's stored credentials are invalid.

Fixes T2037, T1857, T808.

Test Plan:
Run unit tests; patch inbox.api.kellogs.encode to raise an unhandled
exception, and verify that no message is sent.

Reviewers: kav-ya

Reviewed By: kav-ya

Maniphest Tasks: T2037

Differential Revision: https://phab.nylas.com/D1670"
jennielees,2015-06-23 20:23:56,https://api.github.com/repos/nylas/sync-engine/git/commits/4c578e0a3cd273ff0b8c50550c38984cf99282cc,4c578e0a3cd273ff0b8c50550c38984cf99282cc,Add owner to event serialization
emfree,2015-06-22 23:42:44,https://api.github.com/repos/nylas/sync-engine/git/commits/c012e6617be4cb27eb74645201f201a8957779f5,c012e6617be4cb27eb74645201f201a8957779f5,Also allow drafts to be excluded from delta API.
jennielees,2015-06-22 17:32:48,https://api.github.com/repos/nylas/sync-engine/git/commits/ca13da7526ebcdb44d7b4be2bfeb991aef531def,ca13da7526ebcdb44d7b4be2bfeb991aef531def,"Add lightweight HeartbeatPing

Summary: Exposes a lightweight object that only reads the redis indices to make account status easier to access.

Test Plan: Added two new unit tests. See also D1662.

Reviewers: emfree

Reviewed By: emfree

Differential Revision: https://phab.nylas.com/D1663"
jennielees,2015-06-22 17:24:36,https://api.github.com/repos/nylas/sync-engine/git/commits/7cdde78e9990a2a80a5beb1b44ef77f7bd0d222c,7cdde78e9990a2a80a5beb1b44ef77f7bd0d222c,"Merge pull request #166 from elasticsales/fix-heartbeat-strptime

Fix ValueError in get_heartbeat_status"
thomasst,2015-06-22 08:38:50,https://api.github.com/repos/nylas/sync-engine/git/commits/3112d3bb7027dd72d713541857f6bb0cc957509e,3112d3bb7027dd72d713541857f6bb0cc957509e,Fix strptime failing with a ValueError if the millisecond portion of the heartbeat is 0.
emfree,2015-06-19 21:12:57,https://api.github.com/repos/nylas/sync-engine/git/commits/57732fbf60295b7be3b6dc53a36289b196aed6a7,57732fbf60295b7be3b6dc53a36289b196aed6a7,"Prevent dropped UIDs in IMAP sync.

Summary:
Previously, Gmail All Mail UIDs would not be saved if they referenced a
message which already existed (as identified by its g_msgid). This is an
artefact of the old Inbox/All Mail split. But it meant that, for example, UIDs
would not properly be committed for messages moved from the Trash to the All
Mail folder. Fix this.

Also fix race condition in managing pending UIDs. Previously, code that
downloaded uids looked like this:
```
while not download_stack.empty():
    uid, metadata = download_stack.peek()
    self.download_and_commit_uids(crispin_client, self.folder_name,
                                  [uid])
    download_stack.get()
```

The idea was that if you just popped the UID off the stack, it could end up
being concurrently added back to the stack by the `poll_for_changes` greenlet
while the download is ongoing.

However, it can happen that a different UID is concurrently added to the stack.
So `download_stack.get()` would remove the wrong UID. Fix this too.

Test Plan:
Introduce latency and debug logging in the original code; observe
the condition described.

Reviewers: spang, kav-ya

Reviewed By: kav-ya

Differential Revision: https://phab.nylas.com/D1667"
emfree,2015-06-19 01:47:16,https://api.github.com/repos/nylas/sync-engine/git/commits/1d545741e3465af4e23e2f324d463e1922e794ef,1d545741e3465af4e23e2f324d463e1922e794ef,Upgrade test database dump.
khamidou,2015-06-18 16:42:45,https://api.github.com/repos/nylas/sync-engine/git/commits/10f9c38926a9e0ed3e320523724d694f0c3db0ba,10f9c38926a9e0ed3e320523724d694f0c3db0ba,changed again from our hotfix branch to master
khamidou,2015-06-18 10:10:07,https://api.github.com/repos/nylas/sync-engine/git/commits/999ae8f3a3afa40ea2af3e3f54c7af008530ba49,999ae8f3a3afa40ea2af3e3f54c7af008530ba49,Use our imapclient timeout hotfix instead of our regular fork
kav-ya,2015-06-18 05:08:31,https://api.github.com/repos/nylas/sync-engine/git/commits/66f448dcbb6a128b621616bb3ce2c2eb55b97759,66f448dcbb6a128b621616bb3ce2c2eb55b97759,Add regression test for deltasync timestamp validation.
kav-ya,2015-06-18 04:56:58,https://api.github.com/repos/nylas/sync-engine/git/commits/d3af8e224fc8ff6001863540b0904f020581bd99,d3af8e224fc8ff6001863540b0904f020581bd99,Validate timestamp passed to deltasync endpoint.
kav-ya,2015-06-16 23:08:28,https://api.github.com/repos/nylas/sync-engine/git/commits/ca1a0366ea811993a66be1e3105853937cbcc229,ca1a0366ea811993a66be1e3105853937cbcc229,"Introduce Message.get_header() method.
Needed by T1978 fix."
khamidou,2015-06-16 09:52:07,https://api.github.com/repos/nylas/sync-engine/git/commits/f6c9044ef94b2c681ab45884fb3db73ac0df20dd,f6c9044ef94b2c681ab45884fb3db73ac0df20dd,"Set a default timeout for sockets

Summary:
We weren't setting a default timeout for socket, which seem to be why we'd have so many accounts randomly dying. This diff does this using `socket.setdefaulttimout()`. We could have used a finer approach (Elasticsales does this by monkey patching `imaplib` inside their fork of `imapclient`) but we need to set a timeout for HTTP and db sockets too.

Test Plan: Tested manually. Checked that setting a timeout didn't break syncs.

Reviewers: emfree, kav-ya

Reviewed By: kav-ya

Projects: #sync-engine

Differential Revision: https://phab.nylas.com/D1630"
emfree,2015-06-16 01:32:51,https://api.github.com/repos/nylas/sync-engine/git/commits/09c0d84bd5f9959f61b1dfab1b0a94c76528791c,09c0d84bd5f9959f61b1dfab1b0a94c76528791c,Validate API offset parameter.
kav-ya,2015-06-15 20:25:11,https://api.github.com/repos/nylas/sync-engine/git/commits/037fca2d99a51c5ab1f99e92981e10c6a726be5c,037fca2d99a51c5ab1f99e92981e10c6a726be5c,"Fix T1963: Event deletion through the API causes incorrect eventIDs to be returned by the events, delta sync endpoints.

Summary:
The event deletion API simply marks the local event as 'cancelled' instead of deleting it.
This fixes three issues -

* the event will NOT get a different public_id on syncing the delete back from the remote
(we set showDeleted=True while syncing events from the remote).
Previously, a /new/ event with a different public_id would be created (with status='cancelled').
* the delta matches what is returned when a deleted event is synced from the remote.
* the event will be returned by the /events endpoint when show_cancelled=true.

Test Plan: Unit test updated.

Reviewers: emfree

Reviewed By: emfree

Differential Revision: https://phab.nylas.com/D1632"
emfree,2015-06-15 23:19:18,https://api.github.com/repos/nylas/sync-engine/git/commits/e45e754819eb5217d53045df20a085dd6cdd29c7,e45e754819eb5217d53045df20a085dd6cdd29c7,"Suppress tracebacks on client disconnects.

Summary:
Override gevent.pyswgi.WSGIHandler.handle_error to not log a spurious traceback
on ""error: [Errno 32] Broken pipe"" exceptions.

Fixes T1813.

Test Plan:
Issue a request to the streaming API, then close the connection
before it completes.

Reviewers: systemizer

Reviewed By: systemizer

Maniphest Tasks: T1813

Differential Revision: https://phab.nylas.com/D1635"
thomasst,2015-06-14 04:01:36,https://api.github.com/repos/nylas/sync-engine/git/commits/33110e391aa0ccddb99fec8053eafe98c2a1caea,33110e391aa0ccddb99fec8053eafe98c2a1caea,Fix database error when Content-ID is too long
emfree,2015-06-12 19:00:13,https://api.github.com/repos/nylas/sync-engine/git/commits/a6b90d9f7e851da1ec6a24c20e52781d054b07e6,a6b90d9f7e851da1ec6a24c20e52781d054b07e6,"Verify SMTP settings for custom IMAP accounts.

Summary: Fixes T1960.

Test Plan:
Auth a custom IMAP account, with both valid and invalid SMTP
server/port.

Reviewers: spang

Reviewed By: spang

Maniphest Tasks: T1960

Differential Revision: https://phab.nylas.com/D1626"
emfree,2015-06-11 20:36:12,https://api.github.com/repos/nylas/sync-engine/git/commits/355b1f94cb5fe1800a2a94c64f0ff4f95e5465e5,355b1f94cb5fe1800a2a94c64f0ff4f95e5465e5,"Log context/id of blocking greenlet, not just stack."
emfree,2015-06-10 23:44:08,https://api.github.com/repos/nylas/sync-engine/git/commits/25acbed898daf94100e23ef799cc8a457e49489b,25acbed898daf94100e23ef799cc8a457e49489b,"Use a watcher thread to detect ongoing greenlet blocking.

Summary:
Previous instrumentation of mailsync would warn if a greenlet blocked the event
loop, but only after it unblocked. This is not useful if something gets stuck
for a really long time. Instead, use a separate watcher thread to check for
blocking. Consolidate similar code that previously did the same thing for the
API.

Test Plan:
Introduce blocking in both API and mailsync (""while True: pass""),
check that appropriate warning is logged.

Reviewers: kav-ya

Reviewed By: kav-ya

Differential Revision: https://phab.nylas.com/D1615"
spang,2015-06-11 14:05:16,https://api.github.com/repos/nylas/sync-engine/git/commits/6e6b845791fce91c7eedffe42d31abf8b8ded64d,6e6b845791fce91c7eedffe42d31abf8b8ded64d,get-id: Stick to more canonical dashes in arguments.
spang,2015-06-11 14:04:56,https://api.github.com/repos/nylas/sync-engine/git/commits/fb9526d4e4502fa8d0389f700462e98a1eae947c,fb9526d4e4502fa8d0389f700462e98a1eae947c,get-id: Exit with error message if invalid type specified.
kav-ya,2015-06-10 23:26:59,https://api.github.com/repos/nylas/sync-engine/git/commits/085b8bc10dde8094fdd7be3497582d90b3828784,085b8bc10dde8094fdd7be3497582d90b3828784,"Fix T1924: Deleting a Google event that no longer exists on the remote should not fail.

Summary: Causes spurious alerts.

Test Plan:
Manually tested that inbox.events.actions.gmail.remote_delete_event() does not err out
on attempting to delete an event again.

Reviewers: emfree

Reviewed By: emfree

Differential Revision: https://phab.nylas.com/D1614"
emfree,2015-06-10 18:54:24,https://api.github.com/repos/nylas/sync-engine/git/commits/5e217bff710de2ff32b67012a1fa8c9e65bca606,5e217bff710de2ff32b67012a1fa8c9e65bca606,"Fix logging context for IMAP sync.

The real problem is that because we use thread-local logging, calling log.new()
in the CrispinClient constructor overwrites any previously bound context in its
greenlet. Previously this was only ever invoked in its own greenlet, so it
didn't matter. But as of 400381b it does."
khamidou,2015-06-10 17:42:07,https://api.github.com/repos/nylas/sync-engine/git/commits/4676b13c30793086444576f4672bae47ed4994ae,4676b13c30793086444576f4672bae47ed4994ae,"Make the FoldersyncEngines use a bound logger

Summary: While trying to understand why some gmail folders are marked as dead, I noticed that we weren't using the bound logger in the `FoldersyncEngines`. This diff fixes this.

Test Plan: Tested manually, checked that the current folder was logged.

Reviewers: emfree, spang

Reviewed By: spang

Subscribers: spang

Projects: #sync-engine

Differential Revision: https://phab.nylas.com/D1612"
emfree,2015-06-10 03:20:15,https://api.github.com/repos/nylas/sync-engine/git/commits/69d2f940ebba66d33134c566c405a57d1443a592,69d2f940ebba66d33134c566c405a57d1443a592,"Handle out-of-range charrefs in HTML parsing.

Fixes T585; Github issue #148."
emfree,2015-06-10 01:05:52,https://api.github.com/repos/nylas/sync-engine/git/commits/1bf59ec3051ce2d349d26043021e85419943a553,1bf59ec3051ce2d349d26043021e85419943a553,"Merge pull request #151 from elasticsales/fix-uidinvalid-exception

Encode folder name when throwing UidInvalid"
emfree,2015-06-09 22:19:23,https://api.github.com/repos/nylas/sync-engine/git/commits/8a064934d74df0d6646b0f6b13f078e2e4c3dbcc,8a064934d74df0d6646b0f6b13f078e2e4c3dbcc,"Properly parse encoded-words in message address headers.

Summary:
See unit tests for examples.

Fixes T1875.

Test Plan: Regression tests added.

Reviewers: spang

Reviewed By: spang

Maniphest Tasks: T1875

Differential Revision: https://phab.nylas.com/D1611"
emfree,2015-06-09 22:43:43,https://api.github.com/repos/nylas/sync-engine/git/commits/79be46cffa8d6760ac599893d5555c8a03892680,79be46cffa8d6760ac599893d5555c8a03892680,"Better catch invalid credentials in generic IMAP auth.

Fixes Github issue #153."
emfree,2015-06-10 00:16:00,https://api.github.com/repos/nylas/sync-engine/git/commits/d6207ff89f5a33490a0acfb7bb9aa30b3f316e3e,d6207ff89f5a33490a0acfb7bb9aa30b3f316e3e,Remove superfluous tests.
emfree,2015-06-09 23:52:05,https://api.github.com/repos/nylas/sync-engine/git/commits/ea0eb6cbbc7ab00d98cdfcdb91ada7ff50b5c746,ea0eb6cbbc7ab00d98cdfcdb91ada7ff50b5c746,"Save text/calendar and similar text/* MIME parts as attachments.

Needed for creating-events-from-mail to work."
emfree,2015-06-09 17:18:47,https://api.github.com/repos/nylas/sync-engine/git/commits/a50a13291489faae44b2b22324707649169574a8,a50a13291489faae44b2b22324707649169574a8,"Rework MIME parsing.

Summary:
* Don't save separate Part/Block objects for message headers and individual
  MIME parts. Instead, just save the full raw MIME message, as well as actual
  attachments.

* Don't save MIME parts as attachments if they have text type and no filename
  or Content-Id. These should generally just be part of the body. (Fixes T908)

* Concatenate multiple HTML/plaintext parts when parsing out the body text.
  Fixes an issue where body text would be truncated when clients split e.g. the
  body text into multiple parts separated by inline attachments. (Fixes T726)

* Don't use HTML or plaintext parts that are explicitly attachments to form the
  body text. (Fixes T1880)

Test Plan:
Regression tests added, and unit tests generally overhauled. Tests
now mostly use MIME messages generated by flanker rather than random data
files, for simplicity and maintainability (and to make it clear what's actually
being tested).

Reviewers: spang, khamidou

Reviewed By: khamidou

Maniphest Tasks: T908, T726, T1880

Differential Revision: https://phab.nylas.com/D1606"
thomasst,2015-06-06 07:38:45,https://api.github.com/repos/nylas/sync-engine/git/commits/e2c6d00552810fd0f73a32f7440c6f97cd27b554,e2c6d00552810fd0f73a32f7440c6f97cd27b554,Encode folder name when throwing UidInvalid
khamidou,2015-06-04 12:32:46,https://api.github.com/repos/nylas/sync-engine/git/commits/c9d81d25b7552691748fb0de94a6335b25c21a4b,c9d81d25b7552691748fb0de94a6335b25c21a4b,"Fix the race-condition preventing updating an EAS event more than once

Summary:
This bug was tricky to debug. So, according to the report, updating an event /once/ would work but not twice, which is super weird.

My first step was looking at the EAS action log and stepping through the code when syncing back an event.
After a lot of head scratching I noticed that we weren’t even going through this portion of the code. That’s when it dawned on me that we had a little piece of code that would « collapse » updates to the same object. Lo and behold, the code in question isn’t aware of the fact that EAS events have both a `status` and `secondary_status` column, and would helpfully collapse events for us. Because more often than not, the secondary device has run before the first, we would have an event where `status=pending` and `secondary_status=successful` which made our EAS action log handler ignore the update.

Also, this is unrelated but why are we syncing back anything for the primary device?

Test Plan: Tested manually --- checked that updating an event twice worked.

Reviewers: kav-ya, emfree

Subscribers: spang

Projects: #eas, #calendars

Maniphest Tasks: T1826

Differential Revision: https://phab.nylas.com/D1593"
spang,2015-06-03 02:44:25,https://api.github.com/repos/nylas/sync-engine/git/commits/c4a9f0557499bf32b0f8019cb0b2ce7fc35f7ef5,c4a9f0557499bf32b0f8019cb0b2ce7fc35f7ef5,Update test db dump
spang,2015-06-03 02:15:09,https://api.github.com/repos/nylas/sync-engine/git/commits/5d50fddb33f4824d11595ff5329e11f202b83b19,5d50fddb33f4824d11595ff5329e11f202b83b19,Move merged migration to alembic head
thomasst,2015-05-20 02:32:17,https://api.github.com/repos/nylas/sync-engine/git/commits/652fceb8f7d22c6cb22a81e4ce048ff8edd34e8b,652fceb8f7d22c6cb22a81e4ce048ff8edd34e8b,Undo revision changes to previous migration
thomasst,2015-05-20 02:30:41,https://api.github.com/repos/nylas/sync-engine/git/commits/655d522383f8305b815063b34926840d1487c77b,655d522383f8305b815063b34926840d1487c77b,Fix migration revision
thomasst,2015-04-03 23:00:06,https://api.github.com/repos/nylas/sync-engine/git/commits/1f5b8ca281164454083bda129e93a0986452dad1,1f5b8ca281164454083bda129e93a0986452dad1,Fix reply-to in MessageContactAssociation
thomasst,2015-04-01 12:34:41,https://api.github.com/repos/nylas/sync-engine/git/commits/c591fe7d9a654e9c2cc635a7b840c2ba15572c34,c591fe7d9a654e9c2cc635a7b840c2ba15572c34,Adding Reply-To to MessageContactAssociation
khamidou,2015-06-02 12:44:00,https://api.github.com/repos/nylas/sync-engine/git/commits/0aaf761b7869138ed086e874cab6abc4e099dc53,0aaf761b7869138ed086e874cab6abc4e099dc53,forgot a unit test
khamidou,2015-06-02 09:56:12,https://api.github.com/repos/nylas/sync-engine/git/commits/538fc6e6f5cb7589afe5fb0c904e66eff18544d5,538fc6e6f5cb7589afe5fb0c904e66eff18544d5,"Very minimal fix for T1767 (the ""UID of death"" bug)

Summary:
According to various forum posts, this bug could be caused by a corrupted file on the server. I chose to fix it by downloading files one-by-one and ignoring fetch errors. It seems to cause a minor performance hit. I think it's okay because it isn't worth implementing some sort of dichotomic search but that's, like, my opinion. Tell me if you think differently.

Sorry for the lint errors, I wanted to get this out quickly.

Test Plan: Tested manually. Will add test case.

Reviewers: kav-ya, emfree

Reviewed By: emfree

Subscribers: spang

Projects: #sync-engine

Maniphest Tasks: T1767

Differential Revision: https://phab.nylas.com/D1580"
jennielees,2015-05-29 22:48:18,https://api.github.com/repos/nylas/sync-engine/git/commits/018172a47450eb5500d330803a2e5a7429891016,018172a47450eb5500d330803a2e5a7429891016,Update migration 177 to check for table existence first
emfree,2015-06-02 00:01:24,https://api.github.com/repos/nylas/sync-engine/git/commits/a25792e0fe41b7b394935375dd343ffbaafa6d7c,a25792e0fe41b7b394935375dd343ffbaafa6d7c,"Issue IMAP ID command after login.

Summary:
Some servers require this, although they aren't supposed to. It's a recommended
practice in any case -- server operators can get in touch with us if they want.
See e.g. https://developers.google.com/gmail/imap_extensions.

Note that this depends on https://github.com/nylas/imapclient/commit/d3967e84a,
although as written it won't break sync if you're using upstream imapclient --
it'll just log an error.

Fixes T1725.

Test Plan: Tested with problem account.

Reviewers: khamidou, spang

Reviewed By: spang

Maniphest Tasks: T1725

Differential Revision: https://phab.nylas.com/D1588"
emfree,2015-06-01 18:55:34,https://api.github.com/repos/nylas/sync-engine/git/commits/400381b84a253e55377a8706f0fd7dad72d4c9f3,400381b84a253e55377a8706f0fd7dad72d4c9f3,"Rework IMAP connection handling

Summary:
* geventconnpool has a rather serious flaw in which uncaught exceptions raised
  when creating a new connection can silently deplete the pool, causing
  deadlock. Instead, use a simple queue to safely manage connections.
  Connections are now instantiated lazily and synchronously. This means that if
  no connection is available, a call to CrispinConnectionPool.get() will
  instantiate a new connection in the calling greenlet's. So any exceptions can
  be appropriately handled by the caller instead of vanishing into the void.

* Remove unnecessary token validation step when renewing OAuth access tokens.
  You only need to validate tokens if you're doing client-side/implicit OAuth.

* Improve 'invalid' state handling for OAuth accounts. For these accounts, the
  right way to tell that the user has revoked access is to inspect the error
  returned when renewing an access token. IMAP login errors should never
  translate to ""invalid credentials"" for OAuth accounts. This could cause OAuth
  accounts to be wrongly marked invalid.

* Simplify error handling on connection instantiation and login. Remove the
  dubious distinction between `ConnectionError` and `TransientConnectionError`.
  Instead of keeping a list of IMAP LOGIN error responses which we consider
  transient, keep a list of error responses which we consider permanent. That
  way if we get some unfamiliar error response, we'll at least keep trying.

* Don't set account-level ""connerror"" state.

Fixes Github issues #141 and #123.

Test Plan:
Unit tests for pooling behavior added. Sync tested with a variety of
providers for both normal sync and invalid credential handling. Could still use
more unit tests for code not previously covered.

Reviewers: spang, khamidou

Reviewed By: khamidou

Differential Revision: https://phab.nylas.com/D1573"
khamidou,2015-06-01 12:53:04,https://api.github.com/repos/nylas/sync-engine/git/commits/2652c475aeac24ba01763c6d2de09583c24dc652,2652c475aeac24ba01763c6d2de09583c24dc652,add another yahoo error message
emfree,2015-05-31 02:20:43,https://api.github.com/repos/nylas/sync-engine/git/commits/d58bded3ce0ea6637ca7157e9360856891a46c10,d58bded3ce0ea6637ca7157e9360856891a46c10,"Actually revert to SQLAlchemy 0.9.8

Due to potentially critical bug with the mutable extension:
https://bitbucket.org/zzzeek/sqlalchemy/issue/3427. I remain unconvinced that
we should use sqlalchemy.ext.mutable, at all, ever."
emfree,2015-05-30 21:57:15,https://api.github.com/repos/nylas/sync-engine/git/commits/9a920794169bacd42447ee23b40fde406c0a6681,9a920794169bacd42447ee23b40fde406c0a6681,Fix SQLAlchemy version mismatch in setup.py/requirements.txt.
jennielees,2015-05-29 21:55:32,https://api.github.com/repos/nylas/sync-engine/git/commits/767fa204a8b5926bc31cbc7f1aa6308661004c66,767fa204a8b5926bc31cbc7f1aa6308661004c66,"Folder-level tracking of sync_should_run state.

Summary: Part of T1646. In order to easily determine whether an account is in good standing, store the expected run state for a folder directly in that folder's sync status entry. This is somewhat trivial for IMAP (for now) since all folders should be syncing, but will allow us to simplify the state rollup logic regardless.

Test Plan: Added new tests.

Reviewers: emfree

Reviewed By: emfree

Differential Revision: https://phab.nylas.com/D1572"
jennielees,2015-05-29 20:12:02,https://api.github.com/repos/nylas/sync-engine/git/commits/bf057dd45fa17604a92e9a4608f43c0613ad9986,bf057dd45fa17604a92e9a4608f43c0613ad9986,Handle more nonexistent folder messages
jennielees,2015-05-29 19:03:35,https://api.github.com/repos/nylas/sync-engine/git/commits/da0d7159095542acc13146542f53c024e5b8aeb6,da0d7159095542acc13146542f53c024e5b8aeb6,Standardize folder name sanitization
khamidou,2015-05-29 17:22:08,https://api.github.com/repos/nylas/sync-engine/git/commits/826f9b6bc82352e8c1e6f28a9ae362646fdfbf42,826f9b6bc82352e8c1e6f28a9ae362646fdfbf42,"A very small change to how we parse addresses.

Summary: This is the companion diff to D1560. Briefly, we used to return a list of tuple for addresses. This diff changes this to return a list of lists. It makes it easier to compare ""fresh"" addresses to addresses loaded from the db.

Test Plan: Unit tests.

Reviewers: emfree

Reviewed By: emfree

Maniphest Tasks: T1105

Differential Revision: https://phab.nylas.com/D1574"
khamidou,2015-05-29 17:20:45,https://api.github.com/repos/nylas/sync-engine/git/commits/583ff4d084c7e90889be388ec896ec528abf697a,583ff4d084c7e90889be388ec896ec528abf697a,"Output RRULEs as valid JSON

Summary: We were serializing RRULEs as strings in API responses. This diff changes this to normal objects (i.e: instead of returning `""rrule"": '[""RRULE:FREQ=WEEKLY;BYDAY=SU,TU,FR""]'`, we're now returning `""rrule"": [""RRULE:FREQ=WEEKLY;BYDAY=SU,TU,FR""],`

Test Plan: Tested manually.

Reviewers: jennie

Reviewed By: jennie

Differential Revision: https://phab.nylas.com/D1577"
kav-ya,2015-05-28 23:15:41,https://api.github.com/repos/nylas/sync-engine/git/commits/70307b32bd4e7ebe074a2c8628b548ceb1beed9c,70307b32bd4e7ebe074a2c8628b548ceb1beed9c,"Speed up account deletion.

Summary:
Use 'DELETE FROM...LIMIT' query to delete in batches.

Deleting a prod account with ~11,500 Messages and ~46,500 Transaction records
took ~2 minutes, which is about an order of magnitude faster than the previous strategy.

Test Plan:
Unit tests pass.
Deleted an account on prod.

Reviewers: emfree

Reviewed By: emfree

Differential Revision: https://phab.nylas.com/D1569"
kav-ya,2015-05-28 22:16:35,https://api.github.com/repos/nylas/sync-engine/git/commits/96699409cf6f993b75e3fd9cf4ddca64b1cd5cd3,96699409cf6f993b75e3fd9cf4ddca64b1cd5cd3,"Speed up account deletion.

Summary:
Use 'DELETE FROM...LIMIT' query to delete in batches.

Deleting a prod account with ~11,500 Messages and ~46,500 Transaction records
took ~2 minutes, which is about an order of magnitude faster than the previous strategy.

Test Plan:
Unit tests pass.
Deleted an account on prod.

Reviewers: emfree

Differential Revision: https://phab.nylas.com/D1569"
grinich,2015-05-28 00:27:51,https://api.github.com/repos/nylas/sync-engine/git/commits/0f5c5a2bc1bc6e82b3e713034719421bbfd7a16d,0f5c5a2bc1bc6e82b3e713034719421bbfd7a16d,update repo path
grinich,2015-05-28 00:26:45,https://api.github.com/repos/nylas/sync-engine/git/commits/3f5f989adbb9cda649159f6413d63b73a36ac414,3f5f989adbb9cda649159f6413d63b73a36ac414,very important ascii art update
kav-ya,2015-05-27 19:14:41,https://api.github.com/repos/nylas/sync-engine/git/commits/90a1e8554beb4417a18b9f61d39f85b218883ac4,90a1e8554beb4417a18b9f61d39f85b218883ac4,Move delete_namespace().
kav-ya,2015-05-27 18:47:38,https://api.github.com/repos/nylas/sync-engine/git/commits/8a3e18bb4e1e76803bc2c7cafddcc4e2fee3c6d4,8a3e18bb4e1e76803bc2c7cafddcc4e2fee3c6d4,Update test.
khamidou,2015-05-27 14:59:45,https://api.github.com/repos/nylas/sync-engine/git/commits/f8b4a135bd9704f9b285bfbe3cb61decde0f329d,f8b4a135bd9704f9b285bfbe3cb61decde0f329d,remove unneeded assignment. It makes things harder to debug.
khamidou,2015-05-27 14:59:26,https://api.github.com/repos/nylas/sync-engine/git/commits/9495413ea368ebe36ac1be44adefc64cae1efbae,9495413ea368ebe36ac1be44adefc64cae1efbae,use our imapclient fork instead of the PyPI version
kav-ya,2015-05-27 00:50:19,https://api.github.com/repos/nylas/sync-engine/git/commits/d1852c571175c2062d85b2ff651bd9d0eaf28713,d1852c571175c2062d85b2ff651bd9d0eaf28713,"Improve account deletion performance, progress indication."
jennielees,2015-05-27 00:38:19,https://api.github.com/repos/nylas/sync-engine/git/commits/b048e61aaec2539f9d1a6e10a7c063e3c21e5b67,b048e61aaec2539f9d1a6e10a7c063e3c21e5b67,"Don't clear heartbeat if folder exits with error

Summary: Fixes T1726. We were erroneously clearing the heartbeat however a folder exited, which sorta defeats the point of having folder-level heartbeats in the first place.

Test Plan: Tested manually by throwing an exception inside the folder sync.

Reviewers: emfree

Reviewed By: emfree

Maniphest Tasks: T1726

Differential Revision: https://phab.nylas.com/D1562"
emfree,2015-05-26 18:25:58,https://api.github.com/repos/nylas/sync-engine/git/commits/e390bd61b7965e0ca0811f40d7af7694df2d8eb0,e390bd61b7965e0ca0811f40d7af7694df2d8eb0,"Pin Flask-Restful in setup.py.

New release broke reqparse.Argument subclassing."
jennielees,2015-05-26 17:12:42,https://api.github.com/repos/nylas/sync-engine/git/commits/153dd117240856caee01757831b5230e74aba6c6,153dd117240856caee01757831b5230e74aba6c6,"Search improvements

Summary:
Updates the query structure to add the following:

* Searches nested fields on the `all` query. The `multi_match` by default doesn't do this, so we need to expand the query to explicitly include these fields.
* Searches child Message documents' `body` and `files` for the `all` query on Threads, again by composing multiple queries together. Queries now match on these fields as expected.
* Switches from `phrase` matching to `and`/`or` matching, to allow for split tokens in fields (e.g. Ulysses B. Grant now matches ""ulysses grant"").

Side-effects:
* The `all` query uses `should` and `or`, as the `and` query requires that matches be found in the same field (e.g. a search for ""jack flights"" would not match an email from ""jack"" with ""flights"" in the body). This means the results are possibly too loose, and further testing is needed to tighten these up.
* May be a bit slower due to all the query composition
* Relevance ranking may be degraded slightly as boosting isn't passed through to nested/child queries

Test Plan:
Working on updating the tests and adding some more. So far, been testing manually with queries like:

```
curl -X POST http://token:@localhost:5001/n/namespace/threads/search -d '{""query"": [{""all"": ""ulysses grant""}], ""sort"": ""datetime""}' | tee >(jq '.total') 2&>1 >(jq '.results | .[] | .object.subject')
```

which generates a query that looks like:

```
{""query"": {""bool"": {""should"": [{""multi_match"": {""operator"": ""or"", ""fields"": [""last_message_timestamp"", ""tags^3"", ""object"", ""participants^3"", ""first_message_timestamp"", ""id"", ""subject^3""], ""lenient"": true, ""type"": ""most_fields"", ""query"": ""ulysses grant""}}, {""nested"": {""path"": ""participants"", ""score_mode"": ""avg"", ""query"": {""bool"": {""should"": [{""match"": {""participants.email"": {""operator"": ""or"", ""query"": ""ulysses grant"", ""lenient"": true}}}, {""match"": {""participants.name"": {""operator"": ""or"", ""query"": ""ulysses grant"", ""lenient"": true}}}]}}}}, {""nested"": {""path"": ""tags"", ""score_mode"": ""avg"", ""query"": {""bool"": {""should"": [{""match"": {""tags.name"": {""operator"": ""or"", ""query"": ""ulysses grant"", ""lenient"": true}}}]}}}}, {""has_child"": {""query"": {""bool"": {""should"": [{""match"": {""body"": {""operator"": ""or"", ""query"": ""ulysses grant"", ""lenient"": true}}}]}}, ""type"": ""message"", ""min_children"": 1}}, {""has_child"": {""query"": {""bool"": {""should"": [{""nested"": {""path"": ""files"", ""score_mode"": ""avg"", ""query"": {""bool"": {""should"": [{""match"": {""files.content_type"": {""operator"": ""or"", ""query"": ""ulysses grant"", ""lenient"": true}}}, {""match"": {""files.filename"": {""operator"": ""or"", ""query"": ""ulysses grant"", ""lenient"": true}}}]}}}}]}}, ""type"": ""message"", ""min_children"": 1}}]}}}
```

Reviewers: kav-ya

Reviewed By: kav-ya

Differential Revision: https://phab.nylas.com/D1542"
khamidou,2015-05-26 12:10:19,https://api.github.com/repos/nylas/sync-engine/git/commits/2baf189720a148d37829fabfb722c7020b8475bf,2baf189720a148d37829fabfb722c7020b8475bf,also check that the migration is actually needed.
khamidou,2015-05-26 12:01:50,https://api.github.com/repos/nylas/sync-engine/git/commits/db9b756dbf68fde9930da8ab6b4594fa3f1d361e,db9b756dbf68fde9930da8ab6b4594fa3f1d361e,"Fix cascades for RecurringEventOverride table

Summary: We weren't defining an `ON DELETE CASCADE` cascade on the RecurringEventOverride table. This made it impossible to run the account reset script for accounts which had recurring event overrides. Fix this.

Test Plan: Ran the migration, checked that the account reset script worked.

Reviewers: jennie, kav-ya

Projects: #eas

Maniphest Tasks: T1383

Differential Revision: https://phab.nylas.com/D1557"
khamidou,2015-05-26 12:00:15,https://api.github.com/repos/nylas/sync-engine/git/commits/3970106ae0244c869cab790029664522a1e8910c,3970106ae0244c869cab790029664522a1e8910c,"Fix migration 166

Summary: The body format migration throws an error when run on an empty db dump. I'm sending you a diff because I don't know whether your migration has run or is running --- it's not very clear from the `production` branch.

Test Plan: Migrated an empty db dump.

Reviewers: emfree

Reviewed By: emfree

Differential Revision: https://phab.nylas.com/D1545"
spang,2015-05-26 05:41:38,https://api.github.com/repos/nylas/sync-engine/git/commits/935cfc20ec9fe74ba3c051afd4130b5283fafe2e,935cfc20ec9fe74ba3c051afd4130b5283fafe2e,Fix migration
grinich,2015-05-25 18:43:28,https://api.github.com/repos/nylas/sync-engine/git/commits/e2e1e4a6cead540be601f744d05e836ba47a6bb4,e2e1e4a6cead540be601f744d05e836ba47a6bb4,update authors and the like
grinich,2015-05-24 23:13:31,https://api.github.com/repos/nylas/sync-engine/git/commits/82da1d1accd404921f22a8f32e377481104f087e,82da1d1accd404921f22a8f32e377481104f087e,"Update Outlook.com OAuth test credentials to valid app ""Nylas - Open Source Dev"""
grinich,2015-05-24 23:12:24,https://api.github.com/repos/nylas/sync-engine/git/commits/191c6b75551df61699bef6ce36b248d57e23875f,191c6b75551df61699bef6ce36b248d57e23875f,Remove docs from sync-engine repo. They can now be found at https://nylas.com/docs
grinich,2015-05-23 20:22:24,https://api.github.com/repos/nylas/sync-engine/git/commits/485357f322556a16751c00a6550a44ff2dfbc111,485357f322556a16751c00a6550a44ff2dfbc111,"Disable Outlook.com single sign-on OAuth scope

Having this enabled means that if the user has a current authenticated sesion with Outlook.com/Hotmail, then the MSN OAuth flow will force single sign-on with the existing signed-in account and quietly disregarding any login_hint email we supplied."
grinich,2015-05-23 19:43:21,https://api.github.com/repos/nylas/sync-engine/git/commits/76a49e8691fbb4de72bbe340357524714820d849,76a49e8691fbb4de72bbe340357524714820d849,Set Outlook.com client ID and secret in auth flow
emfree,2015-05-22 18:05:44,https://api.github.com/repos/nylas/sync-engine/git/commits/7d1888af39bc427f3cc66f4ece2924128504816e,7d1888af39bc427f3cc66f4ece2924128504816e,Refine migration.
emfree,2015-05-22 22:02:21,https://api.github.com/repos/nylas/sync-engine/git/commits/e154263c35703e45b2465d5d009c4cbba0e401c0,e154263c35703e45b2465d5d009c4cbba0e401c0,"Trim trailing whitespace from folder names.

Summary:
Fixes T1369 in the short term. For non-Gmail IMAP users, we still
won't properly sync multiple folders that differ only by trailing whitespace,
but this unbreaks Gmail syncs with labels differing only by trailing
whitespace. (We will expose those labels as being the same, but I think that's
acceptable for now.)

Test Plan: Regression test added.

Reviewers: spang

Maniphest Tasks: T1369

Differential Revision: https://phab.nylas.com/D1552"
kav-ya,2015-05-22 20:43:34,https://api.github.com/repos/nylas/sync-engine/git/commits/c949702c487c21cedc0fac4f177c8299bd373be0,c949702c487c21cedc0fac4f177c8299bd373be0,Fix migration 173.
kav-ya,2015-05-22 20:13:04,https://api.github.com/repos/nylas/sync-engine/git/commits/22946b67aa75db31d5f00fdbc8d95797e6bddb2c,22946b67aa75db31d5f00fdbc8d95797e6bddb2c,s/_owner2/owner
khamidou,2015-05-22 19:30:29,https://api.github.com/repos/nylas/sync-engine/git/commits/6941fe109264ac985c27c117568ec3a0e52f1091,6941fe109264ac985c27c117568ec3a0e52f1091,"Remove all references to owner

Summary: This is a pretty short diff. The tests didn't run because of some sort of VM issue.

Test Plan: Who needs testing?

Reviewers: kav-ya

Reviewed By: kav-ya

Subscribers: emfree

Differential Revision: https://phab.nylas.com/D1555"
kav-ya,2015-05-22 19:15:47,https://api.github.com/repos/nylas/sync-engine/git/commits/4ed7cf2f2c8b26884c4710a68dc08495c3aed511,4ed7cf2f2c8b26884c4710a68dc08495c3aed511,Fix migration 160 as reported by @thomasst.
khamidou,2015-05-22 15:05:29,https://api.github.com/repos/nylas/sync-engine/git/commits/bb3d0a1c68a6320efa6535b1394bbadc62245f80,bb3d0a1c68a6320efa6535b1394bbadc62245f80,Ship migrations too.
khamidou,2015-05-22 12:29:41,https://api.github.com/repos/nylas/sync-engine/git/commits/280de2170f1844c837d4eafcfa0b13fd79f437f7,280de2170f1844c837d4eafcfa0b13fd79f437f7,"Fix T1113: Data too long for column owner

Summary:
This is another bug caused by differences between our prod db and the schema our code expects. This time, it’s because the `owner` column defined on prod is a `varchar(255)` while our code expects it to be a `varchar(1024)`. This diff adds a migration to fix this.

Please note that the diff is based off master because I noticed our db dump had the same problem. Given that `ALTER TABLE` seems to be idempotent with MySQL (i.e when running the statement twice, the second time MySQL doesn’t match any column), I thought it would be okay.

Test Plan:
Tested manually:
- ran the migration inside mysql
- upgraded a db dump

Reviewers: spang, emfree, jennie

Reviewed By: spang

Projects: #sync-engine

Maniphest Tasks: T1113

Differential Revision: https://phab.nylas.com/D1488"
emfree,2015-05-22 02:13:38,https://api.github.com/repos/nylas/sync-engine/git/commits/25433fc05f338cafbc5a75b816c606879278d32e,25433fc05f338cafbc5a75b816c606879278d32e,"Only condense ""modify"" deltas

Summary:
Previously we'd condense any deltas for a given object, which meant that you
could see a ""modify"" event for an object without ever having seen a ""create"".
This was confusing clients.

Fixes T1266.

Test Plan: Unit tests updated.

Reviewers: khamidou, spang

Reviewed By: spang

Subscribers: spang

Maniphest Tasks: T1266

Differential Revision: https://phab.nylas.com/D1543"
emfree,2015-05-21 23:52:55,https://api.github.com/repos/nylas/sync-engine/git/commits/34b002f2f0917f1c4b8f88b23b5fbdbb74fcf862,34b002f2f0917f1c4b8f88b23b5fbdbb74fcf862,Add migrations for EASUid storage format (part 2 of 3).
emfree,2015-05-22 01:08:31,https://api.github.com/repos/nylas/sync-engine/git/commits/6a161a8d248ae1bcba204e3833914a373702f14c,6a161a8d248ae1bcba204e3833914a373702f14c,Fix alembic branching.
emfree,2015-05-21 23:33:31,https://api.github.com/repos/nylas/sync-engine/git/commits/0d9519527986eb2255d185ec833f7c415ad5dbd3,0d9519527986eb2255d185ec833f7c415ad5dbd3,Add migrations for EASUid storage format (part 1 of 3).
khamidou,2015-05-21 10:37:30,https://api.github.com/repos/nylas/sync-engine/git/commits/d07d8e04100f9a0e9807c389f17bfc7c68dfb2bf,d07d8e04100f9a0e9807c389f17bfc7c68dfb2bf,fix test broken by pull request #147
khamidou,2015-05-21 10:12:07,https://api.github.com/repos/nylas/sync-engine/git/commits/adb410c06530b942b51e0e87c3d9b6709100bdf9,adb410c06530b942b51e0e87c3d9b6709100bdf9,"Handle iCloud transient errors

Summary: It seems iCloud has problems authing users right now. This diff adds a couple transient error messages we're getting.

Test Plan: Testing on one of our staging accounts that this solves the problem (i.e: the account isn't wrongly marked as invalid).

Differential Revision: https://phab.nylas.com/D1544"
emfree,2015-05-15 18:32:08,https://api.github.com/repos/nylas/sync-engine/git/commits/ced193110fe1083de655c22b5864c007d316d84f,ced193110fe1083de655c22b5864c007d316d84f,"Drop obsolete column message.sanitized_body.

Summary:
The final piece of the puzzle. Message body reads and writes now operate
exclusively on the _compacted_body column.

Test Plan: Run migration; run sync as sanity-check.

Reviewers: kav-ya

Reviewed By: kav-ya

Differential Revision: https://review.inboxapp.com/D1508

Conflicts:
	tests/data/base_dump.sql"
jennielees,2015-05-20 23:54:37,https://api.github.com/repos/nylas/sync-engine/git/commits/7bd1613cbadc09ddc67813a51a23d0e252210b14,7bd1613cbadc09ddc67813a51a23d0e252210b14,"Merge pull request #147 from elasticsales/fix-unread-sync

Fix read/unread status sync"
kav-ya,2015-05-20 22:07:01,https://api.github.com/repos/nylas/sync-engine/git/commits/003ed4290af9b5e4a25539e31510d8b06be42adf,003ed4290af9b5e4a25539e31510d8b06be42adf,Fix test dumps.
thomasst,2015-05-20 18:39:27,https://api.github.com/repos/nylas/sync-engine/git/commits/850895e842275af6364e6c41a542bfe3eded3290,850895e842275af6364e6c41a542bfe3eded3290,Fix read/unread status sync by only marking all messages in a thread as read/unread when an action is performed.
khamidou,2015-05-20 12:00:59,https://api.github.com/repos/nylas/sync-engine/git/commits/94e63a48c2471601dc83c3e27dc59e0817200bc3,94e63a48c2471601dc83c3e27dc59e0817200bc3,"Correctly catch transient yahoo errors

Summary:
So, it seems that when Yahoo returns a an auth error with the message `[UNAVAILABLE] (#AUTH701) Service is not available; please try again later.`, it actually means it's a transient error. Treat those as such.

Test Plan: Tested the code path by manually triggerring an exception.

Reviewers: spang, kav-ya, jennie

Reviewed By: jennie

Projects: #sync-engine

Maniphest Tasks: T1114

Differential Revision: https://phab.nylas.com/D1499"
khamidou,2015-05-20 11:14:58,https://api.github.com/repos/nylas/sync-engine/git/commits/e5a9b33da7c29fb79f3d8c31762fb97ae6c5a567,e5a9b33da7c29fb79f3d8c31762fb97ae6c5a567,"A script to restart invalid accounts

Summary:
This diff does two things:
- it adds a script to restart invalid accounts
- it changes a bit how we log invalid accounts, to make it easier to set up a logstash alert. Sorry for putting this in the same diff, but since it's a 4-line changes and that it's somewhat related to the former, I thought it would save us both time.

Test Plan: Tested the script by manually marking an account as invalid and checking that it got started by the script

Reviewers: systemizer, jennie

Reviewed By: jennie

Differential Revision: https://phab.nylas.com/D1526"
emfree,2015-05-20 04:13:03,https://api.github.com/repos/nylas/sync-engine/git/commits/1946dac03703fc7ac1bee691ed61c3ddc1cd4173,1946dac03703fc7ac1bee691ed61c3ddc1cd4173,"Add missing sleep().

Looks like this was erroneously removed in 1ee400533..."
kav-ya,2015-05-20 00:25:05,https://api.github.com/repos/nylas/sync-engine/git/commits/617bee2d41b9d8bf8276e365778169b35ef61b77,617bee2d41b9d8bf8276e365778169b35ef61b77,Update setup.py
kav-ya,2015-05-13 18:30:07,https://api.github.com/repos/nylas/sync-engine/git/commits/e35ad63a3b8be5c8fc002ed37e322bfadcc5fb46,e35ad63a3b8be5c8fc002ed37e322bfadcc5fb46,"Script to delete an account and all its data.

Summary:
Deletes all the data for an account marked for deletion.

Includes the deletion of:
* Data indexed for search (in Elasticsearch).
* All data in the database.
* Account liveness/status data (in Redis).

NOTE:
The data stored in the block store (disk/ s3) is /not/ deleted for
simplicity, performance reasons.

Test Plan:
Unit tests added -
general/test_namespace.py
general/test_message_deduplication.py
search/test_util.py
s3/

Tested against prod replica too.

Reviewers: emfree

Reviewed By: emfree

Subscribers: spang

Differential Revision: https://review.inboxapp.com/D1482"
spang,2015-05-19 23:17:48,https://api.github.com/repos/nylas/sync-engine/git/commits/050e54d49c3f29d50b90979a4d3e7db6eb803fd6,050e54d49c3f29d50b90979a4d3e7db6eb803fd6,"Add an index to make querying for messages sent via the Nylas API fast.

Test Plan: ran manually on staging

Reviewers: emfree

Reviewed By: emfree

Differential Revision: https://phab.nylas.com/D1535"
spang,2015-05-19 19:38:00,https://api.github.com/repos/nylas/sync-engine/git/commits/f7a2996d2bf1a9b3d5371dd1562a4f2f33eba1b6,f7a2996d2bf1a9b3d5371dd1562a4f2f33eba1b6,"Provide an option to create a db session with SQL echoing enabled.

Summary:
Super handy when tuning scripts.

Also removes deprecated ignore_soft_deletes session option. No code actually
uses this anymore (I checked our other repos too); it was just left in for
backcompat.

Test Plan: unit tests

Reviewers: emfree

Reviewed By: emfree

Differential Revision: https://phab.nylas.com/D1528"
grinich,2015-05-19 01:16:19,https://api.github.com/repos/nylas/sync-engine/git/commits/d41f458e2b4abad2c84e90cbf1a65fa3c9b8a5a7,d41f458e2b4abad2c84e90cbf1a65fa3c9b8a5a7,upgrade flanker 0.4.26 -> 0.4.28
grinich,2015-05-19 01:12:38,https://api.github.com/repos/nylas/sync-engine/git/commits/e2e0f15f736764e7699a11a0ccc76fd21501bb4b,e2e0f15f736764e7699a11a0ccc76fd21501bb4b,add some more sensible my.cnf settings
emfree,2015-05-18 18:01:45,https://api.github.com/repos/nylas/sync-engine/git/commits/a04a8295abf3e89d492bb03fafc4647beb32b1bb,a04a8295abf3e89d492bb03fafc4647beb32b1bb,Update Conduit URI.
grinich,2015-05-17 01:36:25,https://api.github.com/repos/nylas/sync-engine/git/commits/f17ced73760af66540a148ea4271621fdbabe8f9,f17ced73760af66540a148ea4271621fdbabe8f9,Slack channel invite link
emfree,2015-05-16 22:39:45,https://api.github.com/repos/nylas/sync-engine/git/commits/00d52a0af2eb29865e632cdbeebbff08b9737d01,00d52a0af2eb29865e632cdbeebbff08b9737d01,"Upgrade to SQLAlchemy 1.0.

Summary:
SQLAlchemy 1.0 promises a variety of performance and behavioral improvements,
as well as some appealing new features we might want to take advantage of -- in
particular, the ""baked query"" feature [1] as well as the Session.invalidate()
method, which might help resolve the mysterious ResourceClosedErrors we
occasionally see.

I reviewed the list of behavioral changes and didn't see anything that looked
problematic, except for a single case in Gmail uidinvalidity handling where we
do a potentially disallowed yield_per. But on testing this code path, it turns
out to be okay.

[1] http://docs.sqlalchemy.org/en/rel_1_0/changelog/migration_10.html#baked-queries

Test Plan: Run unit tests and test syncs. Let simmer on staging for a while.

Reviewers: spang

Reviewed By: spang

Differential Revision: https://review.inboxapp.com/D1517"
spang,2015-05-15 22:13:13,https://api.github.com/repos/nylas/sync-engine/git/commits/25d60ce27cf056a017bd554380375e73b0c81119,25d60ce27cf056a017bd554380375e73b0c81119,"Merge pull request #125 from elasticsales/imap-starttls

Support for IMAP STARTTLS"
emfree,2015-05-15 19:13:53,https://api.github.com/repos/nylas/sync-engine/git/commits/64e67e8bb939850855ac8ddd2e1668f1bbb7aab1,64e67e8bb939850855ac8ddd2e1668f1bbb7aab1,"Revert ""Drop obsolete column message.sanitized_body.""

This reverts commit 15bf8ae0da0169056828ddcef22fd7047c161202.

Reason for rollback: Deployment issues."
emfree,2015-05-15 18:32:08,https://api.github.com/repos/nylas/sync-engine/git/commits/15bf8ae0da0169056828ddcef22fd7047c161202,15bf8ae0da0169056828ddcef22fd7047c161202,"Drop obsolete column message.sanitized_body.

Summary:
The final piece of the puzzle. Message body reads and writes now operate
exclusively on the _compacted_body column.

Test Plan: Run migration; run sync as sanity-check.

Reviewers: kav-ya

Reviewed By: kav-ya

Differential Revision: https://review.inboxapp.com/D1508"
emfree,2015-05-14 23:42:12,https://api.github.com/repos/nylas/sync-engine/git/commits/b197807141fc9bfbdb3dc8909db8b028632d9c73,b197807141fc9bfbdb3dc8909db8b028632d9c73,Fix performance deficits with expanded thread view.
emfree,2015-05-14 20:09:50,https://api.github.com/repos/nylas/sync-engine/git/commits/8ab44e0ddd4a4720974ef43dd62ae4a53696df16,8ab44e0ddd4a4720974ef43dd62ae4a53696df16,"Fix error in delta response when initial result set is empty.

Previously, format_transactions_after_pointer could fail with an IndexError if
it got transactions, but all referenced objects had been deleted (causing the
result set to end up empty). In this case, keep traversing the log until actual
results are returned, or until the end of the log is reached.

Test plan: regression test included."
emfree,2015-05-14 19:31:52,https://api.github.com/repos/nylas/sync-engine/git/commits/22de3a0ca28797498031f146c229ac1b57e5eac4,22de3a0ca28797498031f146c229ac1b57e5eac4,Don't use versioned session to migrate message bodies.
kav-ya,2015-05-14 19:13:14,https://api.github.com/repos/nylas/sync-engine/git/commits/cc77c6affaa34333e3eebc6638a53f56f1323348,cc77c6affaa34333e3eebc6638a53f56f1323348,Remove extraneous import.
emfree,2015-05-14 18:51:48,https://api.github.com/repos/nylas/sync-engine/git/commits/6d5fd7f5b5e58e56d0839e4e0b014595fd760725,6d5fd7f5b5e58e56d0839e4e0b014595fd760725,Add bin/migrate-bodies to setuptools script; clean up miscellania.
khamidou,2015-05-14 10:48:48,https://api.github.com/repos/nylas/sync-engine/git/commits/b21b9d7479843fd2ff21c149a3b26e2b1bb49dd9,b21b9d7479843fd2ff21c149a3b26e2b1bb49dd9,"[Recurring events] Make sure we're giving naive datetimes everywhere

Summary: The EAS recurring events code explicitly serializes every datetime as an UTC-timestamp. Because of this, we may get tz-aware exdates from the db, and this is no bueno in the case of an all-day event.

Test Plan: Tested manually.

Reviewers: jennie

Reviewed By: jennie

Differential Revision: https://review.inboxapp.com/D1497"
emfree,2015-05-06 18:55:18,https://api.github.com/repos/nylas/sync-engine/git/commits/e3adf95b4d1e95046f00eff1bdb11d6c692ea0f9,e3adf95b4d1e95046f00eff1bdb11d6c692ea0f9,"Add support for compressing/encrypting message bodies before persisting.

Summary:
We accomplish this by adding a new column, `message._compacted_body`. For now,
compression is always enabled, but encryption is configurable via the
`ENCRYPT_SECRETS` config value. See `inbox/security/blobstorage.py` for details
on the storage format.

Data migration is supported both via alembic migration (for the convenience of
folks running the sync engine locally), and via a `bin/migrate-bodies` script
with builtin parallelization, for online migration of large databases. The
`message.sanitized_body` column can be dropped once this migration is complete.

Test Plan: Unit tests added.

Reviewers: spang, kav-ya

Reviewed By: spang, kav-ya

Differential Revision: https://review.inboxapp.com/D1487"
emfree,2015-05-06 18:49:14,https://api.github.com/repos/nylas/sync-engine/git/commits/3e1f62e5738423f201cbbcf6512f28b019de5c98,3e1f62e5738423f201cbbcf6512f28b019de5c98,Remove unused code.
emfree,2015-05-14 02:05:20,https://api.github.com/repos/nylas/sync-engine/git/commits/82a06f2d94c0cc25b483e23d003ba083216142ee,82a06f2d94c0cc25b483e23d003ba083216142ee,"Properly set ""object"": ""draft"" for drafts in delta API.

Summary: Fixes T1095.

Test Plan: Unit tests added.

Reviewers: jennie

Reviewed By: jennie

Maniphest Tasks: T1095

Differential Revision: https://review.inboxapp.com/D1504"
spang,2015-05-14 02:10:21,https://api.github.com/repos/nylas/sync-engine/git/commits/c75514565e5e8575fcc7849facafdc9ecd756252,c75514565e5e8575fcc7849facafdc9ecd756252,"Tighten error-handling in message parsing.

Summary:
Prior to this patch, we aborted message parsing and marked a message as
broken if *any* MIME part failed to parse. This could cause problems like
having a blank body on a message even though the body MIME part parsed
properly, simply because an attachment part had a filename that broke
the parser.

This patch makes it so we handle errors for each MIME part separately.
We'll still mark the message as having a decode error if any MIME part
is broken, but we will attempt to parse every MIME part regardless of
other MIME parts being broken.

This patch also removes our logging of raw message bodies to disk in the
case of a decode error. Now that we store full message bodies in S3
(regardless of parse errors later), it's simpler and more durable to
access them there than to collect them across all of our sync engine
disks.

Fixes T994.

Test Plan: regression test included

Reviewers: emfree

Reviewed By: emfree

Maniphest Tasks: T994, T944

Differential Revision: https://review.inboxapp.com/D1500"
spang,2015-05-13 20:31:53,https://api.github.com/repos/nylas/sync-engine/git/commits/d3659f8cfc1c4649786d37c5782677706b13ad50,d3659f8cfc1c4649786d37c5782677706b13ad50,Revert partial unrelated patch which arcanist weirdly merged with D1498.
spang,2015-05-13 18:46:28,https://api.github.com/repos/nylas/sync-engine/git/commits/1db312e7bb107d081521ae095ecee9386d7dff7a,1db312e7bb107d081521ae095ecee9386d7dff7a,"Add index on message.decode_error

Summary:
I want queries like this to be fast:

    mysql> select count(*) from message where decode_error = 1;

Hard to improve our message parsing if it's not easy to get stats on
which messages are b0rked.

Test Plan: looked at `show create table message` after running migration

Reviewers: emfree

Reviewed By: emfree

Differential Revision: https://review.inboxapp.com/D1498"
khamidou,2015-05-13 17:34:43,https://api.github.com/repos/nylas/sync-engine/git/commits/1869de48d109e694b8064667750b3ad4d1506b5b,1869de48d109e694b8064667750b3ad4d1506b5b,fixed file name. Consistency is the hobgoblin of programmers.
khamidou,2015-05-13 17:28:57,https://api.github.com/repos/nylas/sync-engine/git/commits/18590a204f6aa6c90e0afe60e30a0cc3e32c6fd0,18590a204f6aa6c90e0afe60e30a0cc3e32c6fd0,"A tiny script to convert from a public_id to a db id

Summary: This way we won't have to fire up `inbox-console` whenever we want to get the db id of an object.

Test Plan: Tested manually

Reviewers: spang, jennie

Reviewed By: jennie

Subscribers: emfree

Differential Revision: https://review.inboxapp.com/D1476"
emfree,2015-05-06 18:32:31,https://api.github.com/repos/nylas/sync-engine/git/commits/aa6ce0a4d0c3fc2c5fc934fc3ec6bda666084b99,aa6ce0a4d0c3fc2c5fc934fc3ec6bda666084b99,Remove object snapshots from transaction table.
spang,2015-05-12 21:47:44,https://api.github.com/repos/nylas/sync-engine/git/commits/c3d39389293196fbd92934a7bcdf14a79881252e,c3d39389293196fbd92934a7bcdf14a79881252e,Add a script which checks SMTP endpoint auth
emfree,2015-05-12 21:29:54,https://api.github.com/repos/nylas/sync-engine/git/commits/d5f8522d59af9fdb8351e56152ec0a962836ee12,d5f8522d59af9fdb8351e56152ec0a962836ee12,Fix test.
emfree,2015-05-12 21:06:33,https://api.github.com/repos/nylas/sync-engine/git/commits/1b000626b90eb931224da5c098a2e8ae18f30f7f,1b000626b90eb931224da5c098a2e8ae18f30f7f,"Send newline 'heartbeat' in streaming API.

This lets us easily detect when the client has disconnected (and lets clients
do the same)."
emfree,2015-05-12 01:53:37,https://api.github.com/repos/nylas/sync-engine/git/commits/c50d1e707b345f9132bbb05a58529143b845a770,c50d1e707b345f9132bbb05a58529143b845a770,"Tighten unique constraint on Folder table.

Summary:
Mitigates a race condition in which duplicate Folder rows may be created both
in an individual folder sync and in `ImapSyncMonitor.prepare_sync()` (T1151).

Test Plan: Run migration.

Reviewers: spang

Reviewed By: spang

Differential Revision: https://review.inboxapp.com/D1494"
emfree,2015-05-12 01:44:48,https://api.github.com/repos/nylas/sync-engine/git/commits/44390b1cfb962743a2a7f052a80303e294595756,44390b1cfb962743a2a7f052a80303e294595756,Remove potentially expensive query in streaming API.
emfree,2015-05-11 23:38:33,https://api.github.com/repos/nylas/sync-engine/git/commits/e98b98c31468cda70cafc47a4f3c53554726aad3,e98b98c31468cda70cafc47a4f3c53554726aad3,Clarify that some tags are read-only in API responses.
emfree,2015-05-11 22:43:49,https://api.github.com/repos/nylas/sync-engine/git/commits/3f115f3020121bce569f574667ce60513b1e3546,3f115f3020121bce569f574667ce60513b1e3546,"Fix typo in threads API error message.

Fixes T1144."
emfree,2015-05-11 19:49:52,https://api.github.com/repos/nylas/sync-engine/git/commits/6c2c9a9764ffa55945ddf2ceacc4139bdd22a02b,6c2c9a9764ffa55945ddf2ceacc4139bdd22a02b,"Fix regression when feeding datetimes to Elasticsearch.

Summary: Fixes T1122.

Test Plan:
Verify that new documents are indexed with dates in Unix timestamp
format, rather than ISO8601.

Reviewers: kav-ya

Maniphest Tasks: T1122

Differential Revision: https://review.inboxapp.com/D1491"
spang,2015-05-11 20:47:52,https://api.github.com/repos/nylas/sync-engine/git/commits/d9e5e12e1f4a613c9e3d497c2b0207c2951b466a,d9e5e12e1f4a613c9e3d497c2b0207c2951b466a,"Verify certificates in SMTP SSL/TLS.

Summary:
This mitigates a potential MITM attack where a site could attempt to
masquerade as an SMTP server (specified in providers.py or by a user for
generic IMAP servers) via DNS poisoning, and intercept outgoing mail.

This commit also adds proper handling of socket errors in SMTP connections.

Fixes T616.

Depends on D1485.

Test Plan: unit test for failing cert included, plus existing test_send.py

Reviewers: emfree

Reviewed By: emfree

Subscribers: mg

Maniphest Tasks: T616

Differential Revision: https://review.inboxapp.com/D1486"
spang,2015-05-10 18:49:05,https://api.github.com/repos/nylas/sync-engine/git/commits/2abffb7264f60590ae2df3dde658a28d6694ddd4,2abffb7264f60590ae2df3dde658a28d6694ddd4,"Fix api_client test fixture with non-default test accounts.

Summary:
It's not clear to me that the custom namespace_id substitution ever
worked... the message tests worked using the argument simply because
they happened to also be expecting the default account's namespace,
which is what the api_client fixture was hardcoded to use.

I am fixing this in order to be able to use api_client with an account other
than default_account.

Test Plan: unit tests

Reviewers: emfree

Reviewed By: emfree

Differential Revision: https://review.inboxapp.com/D1485"
grinich,2015-05-10 04:42:22,https://api.github.com/repos/nylas/sync-engine/git/commits/eac13ec10acd8916f7709a3192ecafa272a33296,eac13ec10acd8916f7709a3192ecafa272a33296,Actually make sure IMAPclient exception is rom the bad UID SEARCH request
grinich,2015-05-10 02:51:42,https://api.github.com/repos/nylas/sync-engine/git/commits/d3a22d9786476c460632ef2f84023cba3ec6400d,d3a22d9786476c460632ef2f84023cba3ec6400d,"Catch exception when Mail2World IMAP servers fail on `UID SEARCH ALL` and fall-back to a similar-but-actually-broken query `UID SEARCH ALL UID`. The company Name.com runs this IMAP server.

So broken: http://www.limilabs.com/blog/mail2world-imap-search-all-bug"
spang,2015-05-09 21:01:56,https://api.github.com/repos/nylas/sync-engine/git/commits/aaaaea3d8c1a97178e84dbcf6f6722b98627a11c,aaaaea3d8c1a97178e84dbcf6f6722b98627a11c,"Given that this is now a yield_fixture, this comment must be outdated."
spang,2015-05-10 02:27:37,https://api.github.com/repos/nylas/sync-engine/git/commits/90835da583cdaee6332b819e014162366cd683a2,90835da583cdaee6332b819e014162366cd683a2,"Fix test_auth_error_handling.

It turns out the refresh token we had saved in the database was invalid,
and the attempt to set it to an invalid value in the test was broken,
causing the test to fail once the test database contained a valid
refresh token."
spang,2015-05-09 15:13:13,https://api.github.com/repos/nylas/sync-engine/git/commits/c8bc582adb979e706322c2165639d9a98696c667,c8bc582adb979e706322c2165639d9a98696c667,Fix bitrot in test_send.py.
spang,2015-05-09 15:12:45,https://api.github.com/repos/nylas/sync-engine/git/commits/57d9ac9efbb46f8a8d4efb9dd3fea4f9e8974048,57d9ac9efbb46f8a8d4efb9dd3fea4f9e8974048,"Update refresh token for test dump account.

It is invalid. Expired or revoked, probably."
emfree,2015-05-08 22:46:07,https://api.github.com/repos/nylas/sync-engine/git/commits/b8dee7dc7dceeb57c21f7a47bedf27dc64581eff,b8dee7dc7dceeb57c21f7a47bedf27dc64581eff,"Use more sophisticated query strategy in delta API.

Summary:
Serially loading objects to be rendered proves to be insufficiently performant,
so instead we undertake the slightly more complicated approach of loading all
objects of a given type at once.

Test Plan:
Unit tests; make same requests against this code and the original
implementation and compare timing and results.

Reviewers: kav-ya

Reviewed By: kav-ya

Differential Revision: https://review.inboxapp.com/D1481"
jennielees,2015-05-08 21:20:12,https://api.github.com/repos/nylas/sync-engine/git/commits/7d44761269da8c1514f7d46687f79ae5a21912fa,7d44761269da8c1514f7d46687f79ae5a21912fa,"Handle false alarm folder deletions

Summary: First, preserves case when creating new folders while adding labels to a thread. By using lowercase names, we created folders whose names don't match the names returned by crispin, leading to immediate deletions. Secondly, ensure that crispin resyncs folder names when we are refreshing the folder list, so we don't get stale folder data causing spurious deletes.

Test Plan: Tested manually with a live gmail account

Reviewers: emfree, kav-ya

Reviewed By: kav-ya

Differential Revision: https://review.inboxapp.com/D1480"
jennielees,2015-05-07 21:46:00,https://api.github.com/repos/nylas/sync-engine/git/commits/5ee43dd7b63f7e21a988e5ec09bb2a2613333a0c,5ee43dd7b63f7e21a988e5ec09bb2a2613333a0c,Handle Hotmail format for validationerror
grinich,2015-04-29 23:22:45,https://api.github.com/repos/nylas/sync-engine/git/commits/2e8ce8c33df1cca52fae07f12034335ce554567c,2e8ce8c33df1cca52fae07f12034335ce554567c,"Get UIDs using FETCH command, which seems to paginate and not timeout for very large folders

Summary:
For folders with a larger number of items (i.e. >25k) a the SEARCH UNDELETED command was often timing out or taking forever. IMAP servers seem to paginate FETCH commands more efficiently, so hopefully this will solve those issues.

Fixes T1046

Test Plan: Need to test it on staging with accts 55, 69

Reviewers: kav-ya, emfree

Reviewed By: emfree

Subscribers: emfree

Maniphest Tasks: T1046

Differential Revision: https://review.inboxapp.com/D1455"
grinich,2015-05-07 21:59:01,https://api.github.com/repos/nylas/sync-engine/git/commits/cee3fd58655bd4f2d63d44932aa36b9ff76e094d,cee3fd58655bd4f2d63d44932aa36b9ff76e094d,Update 04_namespaces.mdown
emfree,2015-05-07 19:21:09,https://api.github.com/repos/nylas/sync-engine/git/commits/3103c23e9b2eb356468d2321cd0e90bcdd9afda8,3103c23e9b2eb356468d2321cd0e90bcdd9afda8,Fix query pattern in custom threading.
emfree,2015-05-07 18:13:49,https://api.github.com/repos/nylas/sync-engine/git/commits/050cb626c67ab77237afe5772473dcbb758ad839,050cb626c67ab77237afe5772473dcbb758ad839,Remove unintended change to THROTTLE_WAIT value.
emfree,2015-05-07 17:25:53,https://api.github.com/repos/nylas/sync-engine/git/commits/f2a0072a4f00c4020b9a008b71ba92e3dba8d2d1,f2a0072a4f00c4020b9a008b71ba92e3dba8d2d1,"Remove unnecessary join when loading local ImapUids.

Test Plan: Run IMAP sync.

Reviewers: spang, kav-ya

Reviewed By: spang, kav-ya

Subscribers: spang

Differential Revision: https://review.inboxapp.com/D1477"
jennielees,2015-05-07 00:43:51,https://api.github.com/repos/nylas/sync-engine/git/commits/be2ee6a3e03c3d1026e24f7dde9627eb3b3cead3,be2ee6a3e03c3d1026e24f7dde9627eb3b3cead3,"Gmail monitor manages folder changes

Summary: Removes the call to `save_folder_names` from the condstore folder sync engine, preventing parallel folder sync engines from trying to update the overall folder hierarchy at the same time. In doing so, updates the Gmail sync monitor logic to use the generic logic, checking for new folders after an interval. We originally thought this wasn't necessary since we don't need to sync individual folders in Gmail, but we do need to pick up the fact that they exist.

Test Plan: Tested manually by adding/removing folders via crispin and checking that they show up as Folders (and don't become folder sync engines). I attempted to write a unit test for this but ended up having to patch so much of the code it wasn't really testing anything at all.

Reviewers: emfree

Reviewed By: emfree

Differential Revision: https://review.inboxapp.com/D1474"
jennielees,2015-05-07 00:43:08,https://api.github.com/repos/nylas/sync-engine/git/commits/84be6f694e87d6f61da971cc203c94ceb2127169,84be6f694e87d6f61da971cc203c94ceb2127169,Another syntax for remotely deleted folders
emfree,2015-05-06 22:38:06,https://api.github.com/repos/nylas/sync-engine/git/commits/a2265be2af4285184e5eb14c3560d60ebf5741e0,a2265be2af4285184e5eb14c3560d60ebf5741e0,"Don't require object snapshots in transaction log.

Summary:
This is a prerequisite to further reworking the message storage format. There
is some performance impact, but it seems tenable for now. Optimizations to
follow in subsequent patches as needed.

Test Plan: Unit tests; run search-index service.

Reviewers: kav-ya

Reviewed By: kav-ya

Differential Revision: https://review.inboxapp.com/D1473"
jennielees,2015-05-06 21:42:16,https://api.github.com/repos/nylas/sync-engine/git/commits/2a77dd236bce90c18d052a9089564857cf716bea,2a77dd236bce90c18d052a9089564857cf716bea,"Deal with user created folders with reserved (canonical) names

Summary:
Users may have folders with the same names as canonical folders. This can cause IntegrityErrors and false tag deletions (T1079), since we key off name alone.

This diff updates `Folder.get_associated_tag` to check the `public_id` on the tag as well as the name if it's not a canonical tag, thereby ensuring we don't return the canonical tag when we really should be creating a user-local tag. As a result, the unique constraint on Tag has to change too.

Test Plan: Added a unit test to cover this (and a second to check for a race condition that I suspected was happening but appears not to be -- but seems worth keeping around). Also triggered this issue manually by adding a folder 'spam' on a Gmail account and then deleting it.

Reviewers: emfree

Reviewed By: emfree

Differential Revision: https://review.inboxapp.com/D1469"
khamidou,2015-05-06 09:25:08,https://api.github.com/repos/nylas/sync-engine/git/commits/6e9230f8f680578ad91fe1a1006b9b3ac2fb7573,6e9230f8f680578ad91fe1a1006b9b3ac2fb7573,"Fix T1073: add a basic folder mapping

Summary: T1073 is caused by the fact we don't detect canonical folders for generic ""custom"" IMAP accounts because we don't have a default mapping. This diff adds this mapping. It should work for generic Cyrus servers. I didn't test it with other providers (e.g dovecot) though.

Test Plan: Tested by creating a ""custom"" generic account with a Cyrus server and syncing emails.

Reviewers: jennie

Reviewed By: jennie

Projects: #sync-engine

Maniphest Tasks: T1073

Differential Revision: https://review.inboxapp.com/D1471"
kav-ya,2015-05-04 20:40:32,https://api.github.com/repos/nylas/sync-engine/git/commits/3e5e1f3f386f9184182a71945ad1a57dadc8d873,3e5e1f3f386f9184182a71945ad1a57dadc8d873,Filter dns.query.udp() results for the MX record type.
kav-ya,2015-05-04 19:28:54,https://api.github.com/repos/nylas/sync-engine/git/commits/18d9b3d69aabde458a3fd52cfb2e45fa23ebec35,18d9b3d69aabde458a3fd52cfb2e45fa23ebec35,Migration 161 == updated migration 160 for prod db.
jennielees,2015-05-04 17:04:50,https://api.github.com/repos/nylas/sync-engine/git/commits/b54b133a74677324a3167cb6a9631121cfe1225c,b54b133a74677324a3167cb6a9631121cfe1225c,"Don't require spam folder for unread syncback

Summary: Fixes T1059. Not having a spam folder breaks Gmail syncback on 'mark unread' -- this diff relaxes that constraint.

Test Plan: Tested manually by setting spam_folder_id to null.

Reviewers: khamidou

Reviewed By: khamidou

Maniphest Tasks: T1059

Differential Revision: https://review.inboxapp.com/D1463"
khamidou,2015-05-01 09:30:17,https://api.github.com/repos/nylas/sync-engine/git/commits/00348183460c9aae947e0df9938c2406c567dbab,00348183460c9aae947e0df9938c2406c567dbab,"Add support for EAS event overrides in the sync-engine code

Summary:
This is the companion diff to D1444. From what I understand, google calendar autoexpands event overrides.

Unfortunately, EAS doesn't do this for us, so we have to do it ourselves.

We do it by:
1. converting the event exception to an `EXDATE` (see D1444 for this)
2. automatically creating `RecurringEventOverrides` when instantiating a new `RecurringEvent` which has a defined `exdate`.

Test Plan: SOON.

Reviewers: jennie

Reviewed By: jennie

Subscribers: kav-ya

Differential Revision: https://review.inboxapp.com/D1449"
jennielees,2015-04-30 03:45:06,https://api.github.com/repos/nylas/sync-engine/git/commits/2b8407e299ac23ad232d43c01940a37ba548b5a1,2b8407e299ac23ad232d43c01940a37ba548b5a1,Update validation to match what updated client SDK sends
jennielees,2015-04-30 02:56:02,https://api.github.com/repos/nylas/sync-engine/git/commits/912bed6dbf1ac2bb8c5707981a1348f58709615f,912bed6dbf1ac2bb8c5707981a1348f58709615f,Update arguments in create_email to new style
jennielees,2015-04-30 02:23:39,https://api.github.com/repos/nylas/sync-engine/git/commits/8e0d28d23c7ceb6a200773dde035b85965273ac6,8e0d28d23c7ceb6a200773dde035b85965273ac6,Add args flexibility to event create to match EAS requirements
jennielees,2015-04-30 01:14:12,https://api.github.com/repos/nylas/sync-engine/git/commits/09e0eab6ed83f8cd10b2798bd1228bfbce6fd5b1,09e0eab6ed83f8cd10b2798bd1228bfbce6fd5b1,fix heartbeat-debug over-eager matching
kav-ya,2015-04-29 21:24:07,https://api.github.com/repos/nylas/sync-engine/git/commits/3622de86f2339031db8deb24e834ef5ff4a31362,3622de86f2339031db8deb24e834ef5ff4a31362,Include ActionLog downgrade migration.
grinich,2015-04-29 19:51:06,https://api.github.com/repos/nylas/sync-engine/git/commits/6cdb9b32ee21c2dc3317a42702aeb11785936a09,6cdb9b32ee21c2dc3317a42702aeb11785936a09,formatting typo
grinich,2015-04-29 18:34:57,https://api.github.com/repos/nylas/sync-engine/git/commits/77a163aba1663a1e5774c7c5cbe394227668fe06,77a163aba1663a1e5774c7c5cbe394227668fe06,"Enforce single objects in `from` and `reply_to` for API requests instead of special-casing how we format name/address pairs.

Summary: simplicity with good err messages. also linting

Test Plan: updated tests

Reviewers: kav-ya

Differential Revision: https://review.inboxapp.com/D1454"
jennielees,2015-04-29 17:55:56,https://api.github.com/repos/nylas/sync-engine/git/commits/957fb0ed4a1672c9510c2a59a0939f104deb2e48,957fb0ed4a1672c9510c2a59a0939f104deb2e48,helper script to clear all heartbeats
jennielees,2015-04-29 17:55:27,https://api.github.com/repos/nylas/sync-engine/git/commits/4b855670cc9eb6a57ecf6040bb533a4040752327,4b855670cc9eb6a57ecf6040bb533a4040752327,"Delete the Tag when a remote folder is deleted

Summary: When a remote folder is deleted, make sure we also clean up the Tag associated with that folder. This cascades to TagItems in that tag. Fixes T1016

Test Plan: Added two new unit tests. Tested manually with Gmail. Also verified manually that Transactions appear for these events.

Reviewers: kav-ya

Reviewed By: kav-ya

Subscribers: mg

Maniphest Tasks: T1016

Differential Revision: https://review.inboxapp.com/D1450"
grinich,2015-04-29 17:25:38,https://api.github.com/repos/nylas/sync-engine/git/commits/d2b30a2e37fad046cd5c0ecc65f300d0a0265e81,d2b30a2e37fad046cd5c0ecc65f300d0a0265e81,Clarify docs about from / reply_to fields
kav-ya,2015-04-29 03:30:37,https://api.github.com/repos/nylas/sync-engine/git/commits/125bf9e98c5f16c723181e3d979829336a7b78f3,125bf9e98c5f16c723181e3d979829336a7b78f3,"Conditional check in test_unread_tag().
This is intended as a temporary workaround."
kav-ya,2015-04-29 03:01:36,https://api.github.com/repos/nylas/sync-engine/git/commits/c7ef939007c00d2f7f8602de0c24e08458593386,c7ef939007c00d2f7f8602de0c24e08458593386,"Commit message add, thread updated in test_unread_tags()."
kav-ya,2015-04-29 01:37:29,https://api.github.com/repos/nylas/sync-engine/git/commits/8cf91a84af92f2b07fff87a35d1b5e85201b0a27,8cf91a84af92f2b07fff87a35d1b5e85201b0a27,"Fix typo, formatting."
kav-ya,2015-04-27 00:35:53,https://api.github.com/repos/nylas/sync-engine/git/commits/7723fb7de6e299018fc6556afbfcd772adfa6aed,7723fb7de6e299018fc6556afbfcd772adfa6aed,"Merge pull request #137 from EthanBlackburn/sync-engine

This commit adds support for:
* Sending via an alias
* Setting the optional `Reply-To:` header"
khamidou,2015-04-28 09:58:00,https://api.github.com/repos/nylas/sync-engine/git/commits/0919f3e500b9bc81a8ab4d877914fc1234a500f6,0919f3e500b9bc81a8ab4d877914fc1234a500f6,use our dateutil fork instead of the one from pypi.
jennielees,2015-04-28 00:15:32,https://api.github.com/repos/nylas/sync-engine/git/commits/818be20ac4a23d60c6d6288fef538142736db958,818be20ac4a23d60c6d6288fef538142736db958,"Better handling of deleted folders within FolderSyncEngine

Summary:
There are some cases where the folder a FolderSyncEngine is operating on could be deleted while the folder is running. This diff handles those cases from within the sync engine, raising MailsyncDone appropriately.

The first case is that the folder row gets deleted from the database while the sync is starting up, causing an IntegrityError when the sync engine tries to insert its sync status row (T881). This has been observed live repeatedly with Yahoo accounts auto-deleting the Y! Conversations folder.

The second case is that the crispin connection fails on `select_folder` with a specific 'Folder does not exist' message. This can happen any time a `select_folder` is performed in the main sync loop, and has again been observed live with Y! Conversations folders.

We handle these cases by watching for `IntegrityError` in the former case and having crispin throw a `FolderMissingError` in the latter. Both raise `MailsyncDone` and we let the monitor logic deal with deleting the folder rows if necessary, and recreating sync engines as required.

Test Plan: Added test coverage to make sure the new errors behave as expected. Am attempting to manually trigger the Y! specific bug on local dev, but would probably benefit from more extended run testing.

Reviewers: kav-ya

Reviewed By: kav-ya

Subscribers: khamidou, spang, emfree

Differential Revision: https://review.inboxapp.com/D1442"
jennielees,2015-04-28 00:10:26,https://api.github.com/repos/nylas/sync-engine/git/commits/7d3a2894ddaeea352aa1d9442d3b28cea75f6042,7d3a2894ddaeea352aa1d9442d3b28cea75f6042,"Don't commit duplicate ActionLog entries

Summary: In investigating T1035 (threads can end up with 'inbox' and 'archive' tags), I noticed a lot of duplicated events in the ActionLog table. This is because clients using the pattern ""add tag 'archive', remove tag 'inbox'"" to archive mail end up generating two identical 'archive' ActionLog entries. Rather than require clients to be aware of this, this patch prevents us from inserting an identical row if one is already pending.

Test Plan: Added new test in tests/api/test_tags.py

Reviewers: kav-ya

Reviewed By: kav-ya

Subscribers: khamidou

Differential Revision: https://review.inboxapp.com/D1447"
jennielees,2015-04-28 00:10:17,https://api.github.com/repos/nylas/sync-engine/git/commits/46c56c43d46f2e900ec2d4008b7e09b62110196d,46c56c43d46f2e900ec2d4008b7e09b62110196d,"Fix cancelled Event (not RecurringEvent) error

Summary: If an event is cancelled and made recurring at the same time, don't try to delete its overrides, because it won't have any. (Fixes T1023)

Test Plan: Added new test in tests/events/test_recurrence.py

Reviewers: mg, kav-ya

Reviewed By: kav-ya

Subscribers: kav-ya

Maniphest Tasks: T1023

Differential Revision: https://review.inboxapp.com/D1446"
kav-ya,2015-04-27 19:03:05,https://api.github.com/repos/nylas/sync-engine/git/commits/a36577bff30627d3f550ccd96b1d6917837298e4,a36577bff30627d3f550ccd96b1d6917837298e4,Fix typo.
grinich,2015-04-27 18:38:16,https://api.github.com/repos/nylas/sync-engine/git/commits/9fce9d04f3ba89370fa57ef8ccbe50636e199fcb,9fce9d04f3ba89370fa57ef8ccbe50636e199fcb,"Add `Message-ID` header when we create a new MIME message

Closes T195"
grinich,2015-04-27 18:24:11,https://api.github.com/repos/nylas/sync-engine/git/commits/f7bab376054fa773f57b59a6bc9ef81fc72fdc9f,f7bab376054fa773f57b59a6bc9ef81fc72fdc9f,add attachment tag
kav-ya,2015-04-26 23:59:02,https://api.github.com/repos/nylas/sync-engine/git/commits/b33eaedefa10156769121141af375e1d050190cd,b33eaedefa10156769121141af375e1d050190cd,Optional action_id for error logging.
kav-ya,2015-04-20 22:29:18,https://api.github.com/repos/nylas/sync-engine/git/commits/1ee27d911848550bf2b2a932b676bae3bd384b4d,1ee27d911848550bf2b2a932b676bae3bd384b4d,"[SCHEMA] Exchange-specific actions table, scheduling.

Summary:
Dependant revision: D1438

Also includes the following change to tag actions:
Local apply/remove for 'unread' tag occurs at the time the action is scheduled for syncback rather
than when syncback is performed.

Test Plan:
Unit test included.
Migration tested locally.

Reviewers: emfree

Reviewed By: emfree

Differential Revision: https://review.inboxapp.com/D1439"
emfree,2015-04-23 18:22:22,https://api.github.com/repos/nylas/sync-engine/git/commits/51f9b9e5623cf6a3eadef620dbcf0e16fc7b6bc8,51f9b9e5623cf6a3eadef620dbcf0e16fc7b6bc8,"Sanitize null bytes in message subjects.

Summary: Fixes T1018.

Test Plan: Unit test added.

Reviewers: spang

Reviewed By: spang

Maniphest Tasks: T1018

Differential Revision: https://review.inboxapp.com/D1434"
jennielees,2015-04-22 17:03:18,https://api.github.com/repos/nylas/sync-engine/git/commits/c98c3d9c29d45ae169cb4c39c66dfaf67e6b4544,c98c3d9c29d45ae169cb4c39c66dfaf67e6b4544,"Check Trash folder is enabled (as well as just All Mail)

Summary:
Extends the check in `GmailCrispinClient.sync_folders` to also include Trash, which is required for deletions.

Includes a test provider which overrides Gmail auth to allow easy triggering of these failure states.

Test Plan: Updated `tests/general/folders.py`. To manually trigger flow, auth with test gmail provider and a live account, e.g. `foobar+no_trash@gmail.com`.

Reviewers: emfree

Reviewed By: emfree

Subscribers: spang

Differential Revision: https://review.inboxapp.com/D1427"
spang,2015-04-21 17:44:26,https://api.github.com/repos/nylas/sync-engine/git/commits/b27ddde9311136f76e9ad754b25c35e28ac55954,b27ddde9311136f76e9ad754b25c35e28ac55954,"Validate draft subjects and bodies.

Summary: This fixes API 500s caused by passing in arbitrary JSON to these fields.

Test Plan: unit tests included

Reviewers: emfree

Reviewed By: emfree

Differential Revision: https://review.inboxapp.com/D1424"
emfree,2015-04-21 01:17:07,https://api.github.com/repos/nylas/sync-engine/git/commits/ada3240779d4c47b3a0344efe0d99ada0bd89f34,ada3240779d4c47b3a0344efe0d99ada0bd89f34,"Fix HTTP headers for non-latin-1 filenames.

Summary:
Encode such filenames per RFC2047 instead. See
https://tools.ietf.org/html/rfc7230#section-3.2.4

Fixes T1017.

Test Plan: Regression test added.

Reviewers: khamidou, spang, kav-ya

Reviewed By: spang, kav-ya

Subscribers: spang

Maniphest Tasks: T1017

Differential Revision: https://review.inboxapp.com/D1423"
jennielees,2015-04-20 20:54:31,https://api.github.com/repos/nylas/sync-engine/git/commits/d5bd96538f82f0a257d65824c839e08858308ea9,d5bd96538f82f0a257d65824c839e08858308ea9,Clearer test auth provider module path.
jennielees,2015-04-20 20:39:29,https://api.github.com/repos/nylas/sync-engine/git/commits/0c1a8445262920bda55f220bb82ab845f50d6585,0c1a8445262920bda55f220bb82ab845f50d6585,Add stub for test auth providers
khamidou,2015-04-17 18:07:18,https://api.github.com/repos/nylas/sync-engine/git/commits/15543a59ac91968424aebbb242bf1c136ab311d2,15543a59ac91968424aebbb242bf1c136ab311d2,"Save deleted events as ‘cancelled’ instead of deleting them.

Summary:
D1371 changed the way we stored deleted events — instead of deleting them we save them as « cancelled ». This diff updates the google event sync code to do the same.

What I changed:
- removed the event deletion code from remote_sync.py
- split the `SyncResponse` named tuple into `SyncResponse` and `CalendarResponse`  --- the reasoning being that we want to treat event deletes as regular updates, but we still need to distinguish calendar deletes from updates.

Test Plan: Tested manually.

Reviewers: jennie, emfree

Reviewed By: emfree

Projects: #calendars

Differential Revision: https://review.inboxapp.com/D1401"
emfree,2015-04-15 04:42:03,https://api.github.com/repos/nylas/sync-engine/git/commits/ff6ba5f206a91e1eaff72b86c7969a610571d742,ff6ba5f206a91e1eaff72b86c7969a610571d742,"Minimally handle multi-million message mailboxes.

Summary:
It's still really slow to fetch all the g_metadata upfront, but at least we can
prevent it from failing with an IMAP error.

Test Plan: Run IMAP commands on the offending really large Gmail accounts.

Reviewers: spang

Reviewed By: spang

Subscribers: kav-ya

Differential Revision: https://review.inboxapp.com/D1415"
emfree,2015-04-14 21:20:44,https://api.github.com/repos/nylas/sync-engine/git/commits/95ff0359b1990367b3a9b6f785cb8f5b02dc1ad6,95ff0359b1990367b3a9b6f785cb8f5b02dc1ad6,Fix typos in docs.
kav-ya,2015-04-09 21:03:03,https://api.github.com/repos/nylas/sync-engine/git/commits/e7664d31192c117cba5a12b42d2d1b8c5b592b12,e7664d31192c117cba5a12b42d2d1b8c5b592b12,"Perform consistent event.when validation and creation.

Validation of the `when` param for event API fns. uses arrow.get() which accepts
ints or floats, or strings that convert to a float.
However the Event.when setter used datetime.utcfromtimestamp() which does not
accept strings.
As a result of this inconsistency, it is possible for an event API call
like create_event() to cause a 500; fix that.

Rather than disallowing valid Unix timestamps in string format by
making the validation stricter, we use the arrow library to convert
and store them as naive datetimes representing UTC."
khamidou,2015-04-08 17:52:07,https://api.github.com/repos/nylas/sync-engine/git/commits/855d7e8eba72f6eef3171094398bc9c2f99009d9,855d7e8eba72f6eef3171094398bc9c2f99009d9,"Fix safer_yield_per

Summary:
I got bitten by a weird interaction between SQLAlchemy and MySQL: sometimes a call to `safer_yield_per` wouldn't return all the rows we asked. It seems it's because MySQL is opportunistic and doesn't return the rows in order.

I fixed this by sorting rows ascendingly.

Test Plan: Tested manually

Reviewers: kav-ya, emfree

Reviewed By: emfree

Differential Revision: https://review.inboxapp.com/D1407"
grinich,2015-04-08 07:02:32,https://api.github.com/repos/nylas/sync-engine/git/commits/03497af4a1997239af7519928875a5cfa241d566,03497af4a1997239af7519928875a5cfa241d566,"Merge pull request #134 from Analect/master

Changed 'admin' to 'root' in postinstall-src file."
emfree,2015-04-07 00:03:46,https://api.github.com/repos/nylas/sync-engine/git/commits/4dc5f684cbfaf756cb68e09d950a95382e76d395,4dc5f684cbfaf756cb68e09d950a95382e76d395,"Add migrations for EAS schema changes.

Summary: Companion to D1390.

Test Plan: Tested locally. Will also test on replicas.

Reviewers: kav-ya

Differential Revision: https://review.inboxapp.com/D1403"
kav-ya,2015-04-07 23:02:13,https://api.github.com/repos/nylas/sync-engine/git/commits/285d8694f8a4a4492f2f5b0d80ab4d190c0230c4,285d8694f8a4a4492f2f5b0d80ab4d190c0230c4,"Fix provider_resolution, add support to bypass autodiscovery for certain Exchange servers.

Summary:
This revision fixes two issues with the provider_from_address() method:

1. incorrect identification using domain -
Previously x@inboxapp.onmicrosoft.com would fail the domain check
despite the eas provider info dict containing the 'onmicrosoft.com' domain.
(The MX check passes, hence this method still returned 'eas' correctly).

2. incorrectly breaking out of the MX, NS check loops -
If /any/ of the retrieved mx_domains/ ns_records are in the provider info dict for a
provider, we can return the provider. Previously however, the check failed if any
of the retrieved records were /not/ in the dict.

The additional changes included to support bypassing autodiscovery are:
* Update the 'eas' MX domains list
* Split the mx logic out into separate functions.

Test Plan: Provider tests pass.

Reviewers: emfree

Reviewed By: emfree

Differential Revision: https://review.inboxapp.com/D1404"
kav-ya,2015-04-07 21:01:44,https://api.github.com/repos/nylas/sync-engine/git/commits/7e071bb1af2ff624f3a511bbd4641bd33cf98c17,7e071bb1af2ff624f3a511bbd4641bd33cf98c17,"Fix failing provider resolution test.
MX record check correctly returns eas, not outlook."
Analect,2015-04-06 18:37:58,https://api.github.com/repos/nylas/sync-engine/git/commits/aa70d088e622133ba09b670cb7ba2c430e3f161d,aa70d088e622133ba09b670cb7ba2c430e3f161d,"Changed 'admin' to 'root' in postinstall-src file.

This may have been missed in nylas#109
Was preventing the syncengine_inbox container from being built with error:
""Installing inbox-start script to /usr/local/bin
error: /usr/local/bin/inbox-start: Permission denied"""
khamidou,2015-04-06 14:34:29,https://api.github.com/repos/nylas/sync-engine/git/commits/14c2f41edb6ab800f0a59e48f40e117bbcf40dab,14c2f41edb6ab800f0a59e48f40e117bbcf40dab,"[iCal] Merge events participants

Summary:
So, this is a somewhat complicated diff. Here’s a short walkthrough.

The iCalendar protocol is a little annoying. For example, let’s say I create a meeting inviting Alice, Bob and Eve. The invite will contain all three. However, if Alice RSVPs to the event, the invite she will send will only list her as a participant. The organizer is responsible for making sense of everything.

There’s a second problem. Let’s say I only know Bob’s address and not his name — some servers, like Exchange, will helpfully generate an iCalendar file with his email address as his name. In this case, we need an algorithm to merge correctly names.

The third problem is that some people may not have an email address, or the organizer doesn’t know it.

The two parts I’d like you to check out first are:
1. the merging algorithm itself. The idea behind it is that:
   - email addresses are mostly unique
   - names are not
   When looking up participants for merging we first look if we have an already existing entry with this email address. If yes, we update it. If no, we use the name field.

A thing I’m unsure about is whether it’s okay to consider that two participants with the same names are the same person. On the one hand, it allows us to fill out a participant’s email address after the fact. On the other hand, if we get two Bob Smiths attending the same meeting, they’ll get merged together. The latter is somewhat mitigated by the fact that since we use RSVP responses to merge participants, we’re almost certain that we have valid email addresses, so this shouldn’t happen.

2. The trick I’m using to merge participants from older RSVPs. It should work but you never know

Sorry for the wall of text.

Test Plan: Tested manually + unit tests.

Reviewers: emfree, spang, jennie

Reviewed By: jennie

Differential Revision: https://review.inboxapp.com/D1381"
khamidou,2015-04-06 13:44:57,https://api.github.com/repos/nylas/sync-engine/git/commits/ffbcf14bab7e6aeefe883784c2888d967e2b578f,ffbcf14bab7e6aeefe883784c2888d967e2b578f,"Revert ""Revert ""[iCal] Handle cancelled events""""

79bf592081cb04774e37d25298a0587e048a2f92 should have fixed the flaky
tests."
grinich,2015-04-02 22:34:40,https://api.github.com/repos/nylas/sync-engine/git/commits/29b2e9061a841cc991c66b7f840699da07d7b668,29b2e9061a841cc991c66b7f840699da07d7b668,"nilas -> nylas

Test Plan: passes tests

Reviewers: spang, emfree

Reviewed By: emfree

Differential Revision: https://review.inboxapp.com/D1393"
emfree,2015-04-03 00:40:07,https://api.github.com/repos/nylas/sync-engine/git/commits/79bf592081cb04774e37d25298a0587e048a2f92,79bf592081cb04774e37d25298a0587e048a2f92,Fix flaky tests by making them timing-independent.
emfree,2015-04-03 19:45:59,https://api.github.com/repos/nylas/sync-engine/git/commits/1073de4288dc19e29b3c167bbdacd21c2b7bba97,1073de4288dc19e29b3c167bbdacd21c2b7bba97,"Avoid using a single transaction for bulk message deletion.

Summary:
The current code is not very performant for bulk deletion, but it does have the
advantage of limiting collateral damage. We can optimize later as needed.

Test Plan:
Execute bulk delete, and check that concurrent inserts don't fail
with lock wait timeouts.

Reviewers: spang

Reviewed By: spang

Differential Revision: https://review.inboxapp.com/D1395"
khamidou,2015-04-03 17:20:29,https://api.github.com/repos/nylas/sync-engine/git/commits/ba09c807201bd2a2e2f7675a33677a904b7a03f7,ba09c807201bd2a2e2f7675a33677a904b7a03f7,"Revert ""[iCal] Handle cancelled events""

This reverts commit 09f5342e00b986ceabe579e31aaeb0c3e9eb0d32.
Reason: they won't build cleanly on jenkins."
khamidou,2015-04-03 13:33:41,https://api.github.com/repos/nylas/sync-engine/git/commits/09f5342e00b986ceabe579e31aaeb0c3e9eb0d32,09f5342e00b986ceabe579e31aaeb0c3e9eb0d32,"[iCal] Handle cancelled events

Summary:
This diff adds minimal support for cancelled events. Here's a summary of the changes:
- I added a new column, `status`, to store the status of an event. It can take the values specified by the iCalendar spec: `confirmed`, `tentative` and `cancelled`.
- I removed the `cancelled` column from RecurringEventOverride and added a `cancelled` property that updates `status` instead
- added parsing code to handle both google and icloud cancellations + tests

Test Plan: Tested manually + unit tests.

Reviewers: spang, jennie

Reviewed By: jennie

Projects: #calendars

Differential Revision: https://review.inboxapp.com/D1371"
emfree,2015-04-03 00:44:42,https://api.github.com/repos/nylas/sync-engine/git/commits/02c91f3c1483aecc53ce2cb215be3c26e099b62b,02c91f3c1483aecc53ce2cb215be3c26e099b62b,Also add mysql_length on cleaned_subject index for MySQL 5.6
emfree,2015-04-03 00:13:37,https://api.github.com/repos/nylas/sync-engine/git/commits/47d9a8df136e235f49921d4782c5e392b0101107,47d9a8df136e235f49921d4782c5e392b0101107,"Make _cleaned_subject migration match declared schema.

Test Plan: Upgrade old database to head.

Reviewers: kav-ya

Reviewed By: kav-ya

Differential Revision: https://review.inboxapp.com/D1394"
emfree,2015-04-02 23:26:17,https://api.github.com/repos/nylas/sync-engine/git/commits/5ceb64be35152dd6edb8976b094d9db49ece0f71,5ceb64be35152dd6edb8976b094d9db49ece0f71,"Version calendar objects in delta API.

Summary:
Includes some changes to text fixtures that would formerly incorrectly commit
the account.emailed_events_calendar object with null namespace_id.

Test Plan: Unit tests added.

Reviewers: jennie

Reviewed By: jennie

Differential Revision: https://review.inboxapp.com/D1391"
emfree,2015-04-02 22:05:10,https://api.github.com/repos/nylas/sync-engine/git/commits/dd766f4033b21bc45131099bc86d27132bb36278,dd766f4033b21bc45131099bc86d27132bb36278,"Simplify configure_logging.

Summary:
Previously we'd color the log output for humans if the is_prod flag was False.
This is unnecessarily clunky. Instead just check if stdout is a TTY.

Test Plan:
Compare output of `bin/inbox-start` (pretty colors) and
`bin/inbox-start | tee /dev/null` (monochrome).

Reviewers: kav-ya

Reviewed By: kav-ya

Differential Revision: https://review.inboxapp.com/D1392"
khamidou,2015-04-01 17:26:31,https://api.github.com/repos/nylas/sync-engine/git/commits/9387e3115c214fb9a38899b6888c629bca9d3c3a,9387e3115c214fb9a38899b6888c629bca9d3c3a,"[iCal] Handle multiple summaries

Summary: Fixes T967. This is a pretty simple patch --- in the case where there's multiple SUMMARY lines in an iCalendar file, we join them with a "" - "". It's the best we can do because every provider handles this differently, sometimes ignoring the second line (or the first) or joining them in random order.

Test Plan: Added regression test.

Reviewers: spang

Reviewed By: spang

Maniphest Tasks: T967

Differential Revision: https://review.inboxapp.com/D1385"
kav-ya,2015-04-01 00:02:53,https://api.github.com/repos/nylas/sync-engine/git/commits/acbefb77ea6f43340384d8832c19dad821a50a38,acbefb77ea6f43340384d8832c19dad821a50a38,Create inbox-eas testdb if needed too.
emfree,2015-03-31 19:07:47,https://api.github.com/repos/nylas/sync-engine/git/commits/65fe3893857da90b3b6c677a223377505f06780e,65fe3893857da90b3b6c677a223377505f06780e,"Do database-side counting of threads per tag.

Summary:
Loading `tag.threads` is relatively CPU-intensive when there are many elements
in the collection. It's somewhat more performant to have the database do the
counting, particularly since our API workload is generally CPU-heavy.

(Observed from ""greenlet blocking"" warnings in the API when a request blocks
the event loop for >1sec.)

Test Plan:
Unit tests; run example queries to observe speedup (~2-10x for large
collections).

Reviewers: jennie

Reviewed By: jennie

Differential Revision: https://review.inboxapp.com/D1382"
emfree,2015-03-30 17:13:55,https://api.github.com/repos/nylas/sync-engine/git/commits/1f5602d2aa81686e067b1bdbfcd291a1e78b04ef,1f5602d2aa81686e067b1bdbfcd291a1e78b04ef,Fix performance regression in handling IMAP FETCH responses.
emfree,2015-03-27 20:52:56,https://api.github.com/repos/nylas/sync-engine/git/commits/ae39a9baf7406895a6861955296994f1f1bb12a2,ae39a9baf7406895a6861955296994f1f1bb12a2,"Use broader check for AUTHENTICATIONFAILED in IMAP auth.

Otherwise we may fail to renew our access token and retry."
grinich,2015-03-27 18:32:37,https://api.github.com/repos/nylas/sync-engine/git/commits/5b8a8883322c0cd4208a541b3410ae5777574edf,5b8a8883322c0cd4208a541b3410ae5777574edf,Remove long polling updates endpoint docs for now. I want to change how this is structured/named.
emfree,2015-03-27 05:26:51,https://api.github.com/repos/nylas/sync-engine/git/commits/ed16b406e0a4eb2aad14a722249fc554c0a08ad5,ed16b406e0a4eb2aad14a722249fc554c0a08ad5,"Fix timestamp-dependent tests.

This fixes MySQL-version-dependent problems with some of the unit tests. These
problems all center around the fact that fractional seconds are discarded from
timestamp fields in MySQL < 5.6.4, but *rounded* in MySQL >= 5.6.4. See
http://dev.mysql.com/doc/refman/5.6/en/fractional-seconds.html. This means that
you can see something like
```
>>> ts = datetime.datetime(2015, 03, 26, 12, 22, 44, 777)
>>> m = Message(...)
>>> m.deleted_at = ts
>>> db_session.commit()
>>> db_session.query(Message).filter(Message.deleted_at <= ts).all()
[]
```

For now we hack around this in tests, but we probably want a better solution in
code (e.g., truncating fractional seconds ourselves prior to insert) to make
this sort of counterintuitive behavior impossible."
emfree,2015-03-26 22:07:45,https://api.github.com/repos/nylas/sync-engine/git/commits/d5bfe938a5868b628cc5f057f3c4980b65dd80de,d5bfe938a5868b628cc5f057f3c4980b65dd80de,"Add indices to message table.

* Add index on data_sha256.
* Include index on received_date in table declaration (added via migration in
  migration 130, but should have been added to declarative model too)."
emfree,2015-03-26 21:09:42,https://api.github.com/repos/nylas/sync-engine/git/commits/6a45fb29dbd3c5898e429972c75d1c34713f246b,6a45fb29dbd3c5898e429972c75d1c34713f246b,Fix typo in iCloud contacts sync.
emfree,2015-03-25 23:45:08,https://api.github.com/repos/nylas/sync-engine/git/commits/54c1370c0c114ebb54d1f1cf99d36766c5c0143b,54c1370c0c114ebb54d1f1cf99d36766c5c0143b,"Revert ""Make Accounts unique""

This reverts commit c96e9fc6eb7f3f73f324858d78992dcb07c2ad66.

Reason for rollback: Constraint does not hold in real life.

Conflicts:
	migrations/versions/133_add_unique_account_constraint.py"
emfree,2015-03-25 21:41:31,https://api.github.com/repos/nylas/sync-engine/git/commits/0ef41f3c8a98edd20638420399443ee45f05f35f,0ef41f3c8a98edd20638420399443ee45f05f35f,"Fix regression in delta cursor generation.

Without filtering the secondary sort on namespace_id, we may give you a cursor
for another namespace, which you then can't use for anything."
emfree,2015-03-25 20:24:08,https://api.github.com/repos/nylas/sync-engine/git/commits/0671627093c841ac8098a4dc2b8570364248b047,0671627093c841ac8098a4dc2b8570364248b047,"Handle Google all-day events with matching start and end date.

Summary:
Normally, one-day events Google calendar events have e.g.
```
  ""start"": {""date"": ""2015-03-25""},
  ""end"": {""date"": ""2015-03-26""}
```
*but* you can create an event via their API with identical start and end date:
```
  ""start"": {""date"": ""2015-03-25""},
  ""end"": {""date"": ""2015-03-25""}
```
and it will subsequently be returned as such. So we can't automatically
subtract a day off the end.

Fixes T957.

Test Plan: Regression test added.

Reviewers: jennie, spang

Reviewed By: spang

Maniphest Tasks: T957

Differential Revision: https://review.inboxapp.com/D1347"
emfree,2015-03-24 23:31:14,https://api.github.com/repos/nylas/sync-engine/git/commits/dfd8c4ba47d963c58758000c4266cb83b989dbb8,dfd8c4ba47d963c58758000c4266cb83b989dbb8,"Only run ""preflight"" checks when prod flag is off.

Summary:
The primary motivation for this is to remove a bit of the pain around
concurrently deploying code and schema changes. In nearly all cases, refusing
to start services when there is an alembic version mismatch is
counterproductive to what we actually want to do. E.g., if we're adding a
column we want to first add the column, then update the code. The opposite if
we're dropping a column.

We retain this check as a convenience for developers who may be juggling
branches and schemas, upgrading local VMs, etc.

Test Plan: Run service scripts with and without --prod flag.

Reviewers: jennie

Reviewed By: jennie

Differential Revision: https://review.inboxapp.com/D1343"
emfree,2015-03-24 22:29:58,https://api.github.com/repos/nylas/sync-engine/git/commits/6ee6ae004aa9bc9dbf2f7e518506b8f5c688a878,6ee6ae004aa9bc9dbf2f7e518506b8f5c688a878,"Avoid quoted-printable message encoding for server compatibility.

Summary: Fixes issue with Exchange message garbling.

Test Plan: Regression test added.

Reviewers: spang

Reviewed By: spang

Differential Revision: https://review.inboxapp.com/D1342"
emfree,2015-03-24 19:27:49,https://api.github.com/repos/nylas/sync-engine/git/commits/005b306c62a64e9a12aabc15d7ce6f00b0c0e84f,005b306c62a64e9a12aabc15d7ce6f00b0c0e84f,Fix indentation in generic IMAP actions.
grinich,2015-03-24 18:58:04,https://api.github.com/repos/nylas/sync-engine/git/commits/9be35cbe23fe793118dfc03f5d266adcacd05f94,9be35cbe23fe793118dfc03f5d266adcacd05f94,"Rename ""Delta Sync"" to just ""Delta""

Summary: Much more clear and matches what the API actually provides. From now on the nomenclature is saying ""delta enpoint"" which returns ""deltas"". Apps need to generate a ""delta cursor"" which is also used for the ""streaming delta endpoint"".

Test Plan: Only documenetation changes

Reviewers: spang

Reviewed By: spang

Differential Revision: https://review.inboxapp.com/D1339"
jennielees,2015-03-24 00:20:24,https://api.github.com/repos/nylas/sync-engine/git/commits/90d53c61487e6389774e9fbd3dcc59487244c2af,90d53c61487e6389774e9fbd3dcc59487244c2af,"basic feature flag for ical autoimport

Summary: adds a `FEATURE_FLAGS` variable to config (which can be overridden with an env variable). by default the ical autoimport is only called if `ical_autoimport` is in the feature flags.

Test Plan: tested manually by uncommenting `test_integrated_ical_parsing` and setting feature flags to empty. the ical parsing doesn't run, and the test fails.

Reviewers: spang

Reviewed By: spang

Subscribers: emfree

Differential Revision: https://review.inboxapp.com/D1336"
emfree,2015-03-23 18:45:06,https://api.github.com/repos/nylas/sync-engine/git/commits/a80fa83554e85682e772953990aebc4af33da302,a80fa83554e85682e772953990aebc4af33da302,"Remove Message.thread_order column.

Summary:
`Message.thread_order` was supposed to be used for custom threading, to
support ordering messages on a thread by something other than date. This was
to be used in conjunction with the `sqlalchemy.ext.orderinglist` facility.
However, astute readers will notice that the ordering list part was never
actually implemented in code. As a result, computing custom message ordering is
entirely pointless.

I claim that always ordering messages on a thread by date is in any case
simpler, and all around the better thing to do.

Test Plan: Unit tests.

Reviewers: spang

Reviewed By: spang

Differential Revision: https://review.inboxapp.com/D1331"
jennielees,2015-03-23 21:01:09,https://api.github.com/repos/nylas/sync-engine/git/commits/7a93ca44d85d35a4aeb8dac17afe9327d0ec63fa,7a93ca44d85d35a4aeb8dac17afe9327d0ec63fa,"make parse_datetime more robust

Summary: allow None values, and handling of more strings via dateutil

Test Plan: tests/events/test_datetime.py::test_parse_datetime

Reviewers: emfree

Reviewed By: emfree

Subscribers: spang

Differential Revision: https://review.inboxapp.com/D1333"
grinich,2015-03-23 20:06:11,https://api.github.com/repos/nylas/sync-engine/git/commits/acc776693e83b3e78f153ac7f1ce273b0cadb99f,acc776693e83b3e78f153ac7f1ce273b0cadb99f,expand --> expanded
grinich,2015-03-21 01:10:16,https://api.github.com/repos/nylas/sync-engine/git/commits/05320027ee99fefe47f05355dfe841e7592ad14d,05320027ee99fefe47f05355dfe841e7592ad14d,Change API param for expanding threads from `expand=true` to simply adding another view parameter. i.e. `view=expanded.`
jennielees,2015-03-23 18:12:04,https://api.github.com/repos/nylas/sync-engine/git/commits/2abb2366565fd21f3398e4b7027103ff82fda6f1,2abb2366565fd21f3398e4b7027103ff82fda6f1,Fix typo in migration 150
emfree,2015-03-20 23:52:48,https://api.github.com/repos/nylas/sync-engine/git/commits/d067b294688319fb835ed6c231d27f13e4541472,d067b294688319fb835ed6c231d27f13e4541472,"Add `expanded` parameter for returning message metadata on threads.

Revert other extraneous changes for simplicity."
emfree,2015-03-20 23:39:34,https://api.github.com/repos/nylas/sync-engine/git/commits/93274f200a6013a2e00777fa7e3ad3d7c18b5fb5,93274f200a6013a2e00777fa7e3ad3d7c18b5fb5,"Revert ""Add `expanded` parameter for returning message metadata on threads.""

This reverts commit 76e5b10c4f750efbd1976501546b93d0cf01f995.

Reason for rollback: breaks things.

Conflicts:
	inbox/api/kellogs.py
	requirements.txt"
jennielees,2015-03-20 21:42:58,https://api.github.com/repos/nylas/sync-engine/git/commits/cffc4e4bed86b308239dbfedda0d9b37abe23e5a,cffc4e4bed86b308239dbfedda0d9b37abe23e5a,"Add read-only support for recurring events

Summary:
Adds additional models and handling for recurring events.

Model changes:
* New classes `RecurringEvent` and `RecurringEventOverride` store additional metadata for recurring events (via joined table inheritance to `Event`)
* New class `InflatedEvent` represents a temporary event instance when expanding a recurring event, and cannot be committed to the database.
* When instantiating an `Event`, if appropriate arguments are passed then one of these subclasses will be created instead.
* Datetime handling in `Event` now uses `arrow`: added new `FlexibleDateTime` column type to handle conversions and comparisons. This allows for simpler code around datetimes, timezones, naive vs aware, and so forth.
* Added more properties and excitement to `When`.

Sync changes:
* Event sync extracts information about an event override's original recurring event, and creates the appropriate relationship.
* If a one-off override for a recurring event is deleted, we sync it as a `RecurringEventOverride` with `cancelled=True`. This is necessary for expansion purposes, as the cancellations aren't always present in the recurrence rule EXDATE.
* When a recurring event is deleted, we delete any overrides we have for it.

API changes:
* New parameter `expand_recurring` (bool) on `/events/` (filtering endpoint). If true, returns single instances of recurring events within the requested time range.

The logic for this expansion involves expanding the RRULE to a series of dates and times (accounting for daylight savings changes, so an event at 9:30 local time remains that way) - then removing any EXDATE exceptions, and dates already covered by Override instances, which refer back to their original start time. There are a bunch of tests for this logic.

Required changes on deploy:
* Migration to add new event types; one-off function to convert existing Events, and unwrap data from `raw_data` into new types.
* Reset the `last_synced_events` timestamp on all accounts to null, so that one-off cancellations can re-sync.

Test Plan: Run all the shiny new tests!

Reviewers: emfree

Reviewed By: emfree

Subscribers: mg, khamidou, spang

Differential Revision: https://review.inboxapp.com/D1315"
emfree,2015-03-20 21:07:26,https://api.github.com/repos/nylas/sync-engine/git/commits/743337d88225a00451742dda01aba9b73b315464,743337d88225a00451742dda01aba9b73b315464,Fix duplicated requirement; setup.py.
grinich,2015-03-20 20:55:26,https://api.github.com/repos/nylas/sync-engine/git/commits/76e5b10c4f750efbd1976501546b93d0cf01f995,76e5b10c4f750efbd1976501546b93d0cf01f995,"Add `expanded` parameter for returning message metadata on threads.

Test plan: Unit tests added."
emfree,2015-03-20 18:32:13,https://api.github.com/repos/nylas/sync-engine/git/commits/6b3fb685363de75b6ceef4d51685485684c93260,6b3fb685363de75b6ceef4d51685485684c93260,"Do secondary sort of near-simultaneous transactions when generating cursor.

Test Plan: Unit tests.

Reviewers: mg

Differential Revision: https://review.inboxapp.com/D1325"
khamidou,2015-03-20 18:02:51,https://api.github.com/repos/nylas/sync-engine/git/commits/afa68e190aecd145531c79097c4dcd18ad70fdc4,afa68e190aecd145531c79097c4dcd18ad70fdc4,"[iCalendar] Fix an edge case

Summary: The `icalendar` python module has a peculiar API --- getting the list of attendees for an event when there's no attendees returns `None` instead of `[]`. This diff fixes the code to handle this case and adds a regression test.

Test Plan: The tests pass.

Reviewers: spang

Reviewed By: spang

Projects: #sync-engine

Differential Revision: https://review.inboxapp.com/D1324"
grinich,2015-03-20 17:11:13,https://api.github.com/repos/nylas/sync-engine/git/commits/b51aa7754856b4f98ae6fb73258c31aab02ae436,b51aa7754856b4f98ae6fb73258c31aab02ae436,"Add long-polling option for delta sync endpoint

Summary:
Web browsers can't parse partial responses, which makes the streaming endpoint useless to them. This change adds a URL param to enable long-polling. This will effectively ""hang"" the connection open for 2 minutes or until there is a new change.

Rob Ochshorn wanted something like this. I think it makes a lot of sense to add.

Test Plan: I tested this manually, but I'm not sure how to write a test for it given the async nature.

Reviewers: spang, emfree

Reviewed By: emfree

Subscribers: spang

Differential Revision: https://review.inboxapp.com/D1302"
grinich,2015-03-20 05:10:12,https://api.github.com/repos/nylas/sync-engine/git/commits/fc3f81f53d071a241befd058eb7b10d91b58a741,fc3f81f53d071a241befd058eb7b10d91b58a741,some fixes for the setup script
emfree,2015-03-20 03:14:52,https://api.github.com/repos/nylas/sync-engine/git/commits/30d4803e305ec6b169c217bf0ed6bab199887932,30d4803e305ec6b169c217bf0ed6bab199887932,"Instrument API worker to detect greenlet blocking.

Summary:
This is a bit of an experiment. API logs contain intimations of greenlets
blocking for longer than they should, but we don't have a way to definitively
tell when that happens. This patch adds basic instrumentation in our worker
class to detect greenlet blocking.

This is inspired by https://github.com/mozilla-services/mozservices/blob/master/mozsvc/gunicorn_worker.py.
We spawn a real genuine OS thread, which periodically checks to see if a
greenlet context switch has happened on the main serving thread since the last
sample; if not, it logs a warning. This is a little different from the approach
to similar instrumentation for mailsync in `inbox.util.debug.Tracer`, where we
check for blocking at context switch time.  We don't need to gather statistics
here, so just doing periodic sampling minimizes context-switching overhead.

Note that this doesn't work with `bin/inbox-api`; you have to do something like
```
gunicorn --worker-class inbox.api.wsgi.InboxWSGIWorker --logger-class \
inbox.api.wsgi.GunicornLogger --workers=1 --bind 0.0.0.0:5555 inbox.api.srv:app
```

Test Plan:
Introduce blocking code into API route; check that warning and
stacktrace are logged.

Reviewers: spang

Reviewed By: spang

Differential Revision: https://review.inboxapp.com/D1323"
grinich,2015-03-20 04:09:33,https://api.github.com/repos/nylas/sync-engine/git/commits/c413e17d5dec317c71c7f4ef3f036d245875fb94,c413e17d5dec317c71c7f4ef3f036d245875fb94,"Add fix for https://github.com/pypa/pip/issues/2438

Closes https://github.com/inboxapp/inbox/issues/119"
emfree,2015-03-19 20:35:24,https://api.github.com/repos/nylas/sync-engine/git/commits/7b2f93e04966bf4c3d14aa1310d1c2685e56a627,7b2f93e04966bf4c3d14aa1310d1c2685e56a627,Fix performance regression in Gmail initial sync.
khamidou,2015-03-19 18:47:46,https://api.github.com/repos/nylas/sync-engine/git/commits/196ee6308c2bf100aa9f52ef73b9bd89e2efe18f,196ee6308c2bf100aa9f52ef73b9bd89e2efe18f,forgot to add backfill script to setup.py
khamidou,2015-03-19 16:03:14,https://api.github.com/repos/nylas/sync-engine/git/commits/f40e2df1df8fca897247beae611327b9db80b157,f40e2df1df8fca897247beae611327b9db80b157,"add ""emailed events"" calendar creation script"
khamidou,2015-03-19 02:46:13,https://api.github.com/repos/nylas/sync-engine/git/commits/a0dcbf435d565125952e989392f8ad1d5927a4ed,a0dcbf435d565125952e989392f8ad1d5927a4ed,"Autoimport calendar attachments

Summary:
By popular demand, here's my WIP diff for autoimporting calendar events. Right now, it autoimports events in a specific calendar, ""Attached Events"". My next steps are going to be:
1. Tightening up ICS parsing (i.e: handling cases like different timezones, participants fields, etc.)
2. ""reconciling"" received events with already existing calendar events. This will require a number of changes to the EAS backend, notably actually storing UIDs for EAS events and adding a timestamp field to the event model, to store an event's last modification time. I haven't thought a lot about this but I'm probably going to either subclass Event into an EASEvent class or simply add an eas_uid field to the event structure. I'm favoring the former but the last time I tried something like this I ran into mysterious SqlAlchemy inheritance bugs.

Test Plan: Tested manually + automated tests.

Reviewers: emfree, spang

Reviewed By: spang

Projects: #sync-engine

Differential Revision: https://review.inboxapp.com/D1269"
khamidou,2015-03-18 16:57:56,https://api.github.com/repos/nylas/sync-engine/git/commits/3cade4b3292394a05bad30bff03b2f135022434e,3cade4b3292394a05bad30bff03b2f135022434e,forgot to add metadata lock timeout
emfree,2015-03-17 18:04:45,https://api.github.com/repos/nylas/sync-engine/git/commits/94e15107b399118a0a24766f7ae6bc39fb776345,94e15107b399118a0a24766f7ae6bc39fb776345,"Don't increment calendar sync timestamp when API access isn't enabled.

Otherwise we wouldn't sync old events if the API is subsequently enabled."
emfree,2015-03-17 00:35:53,https://api.github.com/repos/nylas/sync-engine/git/commits/9d1d15762fe76e7bdd3f790810e0fb409979be60,9d1d15762fe76e7bdd3f790810e0fb409979be60,"Improve error handling in Google calendar sync.

Summary:
* If the API isn't enabled, log a warning and return no results. This is not
  ideal, but seems like the best option for now. Otherwise calendar syncs will
  appear dead for accounts that don't have the calendar API enabled.

* If we're being rate-limited, sleep and retry. This way, a single failed call
  will not cause the calendar sync to appear dead, but repeated failed calls
  will. Which is what we want. Originally, the sync could potentially fail for
  an arbitrarily long amount of time with no indication of this in heartbeats.

* In case of internal server errors, wait and retry.

* In case of other unexpected errors, raise an exception.

Test Plan: Unit tests added.

Reviewers: jennie, spang

Reviewed By: spang

Differential Revision: https://review.inboxapp.com/D1307"
khamidou,2015-03-17 01:48:31,https://api.github.com/repos/nylas/sync-engine/git/commits/0108cf5f402ab08c4189d5e3cfd990805e83f48e,0108cf5f402ab08c4189d5e3cfd990805e83f48e,"A script to regenerate labels and tags

Summary: I repurposed `bin/regen-labels` to regenerate tags too. The script is a bit of a hack because it drops all folder-related tags only to re-add them a couple lines down.

Test Plan: Tested on a replica of the staging db.

Reviewers: spang, emfree

Reviewed By: emfree

Subscribers: mg

Projects: #sync-engine

Differential Revision: https://review.inboxapp.com/D1285"
emfree,2015-03-16 22:20:43,https://api.github.com/repos/nylas/sync-engine/git/commits/fe7496488ae086c943b86354be7170fc29ca50e3,fe7496488ae086c943b86354be7170fc29ca50e3,"Fix log context binding in contacts/events sync.

Also improve logging on HTTP errors from the Google Calendar API."
emfree,2015-03-16 17:59:24,https://api.github.com/repos/nylas/sync-engine/git/commits/d7fbec56b67c2f11c4c4b71cadda9a803f79334e,d7fbec56b67c2f11c4c4b71cadda9a803f79334e,"Issue first heartbeat outside retry loop in IMAP sync.

Summary:
Otherwise, if there's a problem starting the sync, the folder sync may
repeatedly ""eagerly signal"" its status as it retries, meaning that it appears
alive when it is in fact dead.

Test Plan:
Break sync by raising exception in ImapFolderSyncEngine._run_impl;
check that it stays dead in admin dashboard.

Reviewers: jennie

Reviewed By: jennie

Differential Revision: https://review.inboxapp.com/D1304"
grinich,2015-03-16 04:54:50,https://api.github.com/repos/nylas/sync-engine/git/commits/dc6d99b5478944be9c5b71d87d88acee07f4f385,dc6d99b5478944be9c5b71d87d88acee07f4f385,clear up docs about reply_to_message_id when sending
grinich,2015-03-15 05:19:59,https://api.github.com/repos/nylas/sync-engine/git/commits/f22fa635c34ce99e11f6e7895669b289233a577e,f22fa635c34ce99e11f6e7895669b289233a577e,"monkeypatch imaplib INTERNALDATE regex

Summary:
Even though RFC 2060 says that the date component must have two characters (either two digits or space+digit), it seems that some IMAP servers only return one digit. Fun times.

```
date_day_fixed  ::= (SPACE digit) / 2digit
                    ;; Fixed-format version of date_day
```
from https://james.apache.org/server/rfclist/imap4/rfc2060.txt

Example of breakage:

Account 1382

```
Traceback (most recent call last):
      File ""/usr/share/python/inbox-sync/local/lib/python2.7/site-packages/inbox/util/concurrency.py"", line 73, in wrapped
    return func(*args, **kwargs)
      File ""/usr/share/python/inbox-sync/local/lib/python2.7/site-packages/inbox/mailsync/backends/imap/generic.py"", line 208, in _run_impl
    self.state = self.state_handlers[old_state]()
      File ""/usr/share/python/inbox-sync/local/lib/python2.7/site-packages/inbox/util/concurrency.py"", line 73, in wrapped
    return func(*args, **kwargs)
      File ""/usr/share/python/inbox-sync/local/lib/python2.7/site-packages/inbox/mailsync/backends/imap/generic.py"", line 257, in initial_sync
    self.initial_sync_impl(crispin_client)
      File ""/usr/share/python/inbox-sync/local/lib/python2.7/site-packages/inbox/mailsync/backends/imap/generic.py"", line 304, in initial_sync_impl
    self.download_uids(crispin_client, download_stack)
      File ""/usr/share/python/inbox-sync/local/lib/python2.7/site-packages/inbox/mailsync/backends/imap/generic.py"", line 389, in download_uids
    [uid])
      File ""/usr/share/python/inbox-sync/local/lib/python2.7/site-packages/inbox/mailsync/backends/imap/generic.py"", line 494, in download_and_commit_uids
    raw_messages = safe_download(crispin_client, uids)
      File ""/usr/share/python/inbox-sync/local/lib/python2.7/site-packages/inbox/mailsync/backends/imap/generic.py"", line 586, in safe_download
    raw_messages = crispin_client.uids(uids)
      File ""/usr/share/python/inbox-sync/local/lib/python2.7/site-packages/inbox/crispin.py"", line 449, in uids
    ['BODY.PEEK[] INTERNALDATE FLAGS'])
      File ""/usr/share/python/inbox-sync/local/lib/python2.7/site-packages/imapclient/imapclient.py"", line 834, in fetch
    return parse_fetch_response(data, self.normalise_times, self.use_uid)
      File ""/usr/share/python/inbox-sync/local/lib/python2.7/site-packages/imapclient/response_parser.py"", line 107, in parse_fetch_response
    msg_data[word] = _convert_INTERNALDATE(value, normalise_times)
      File ""/usr/share/python/inbox-sync/local/lib/python2.7/site-packages/imapclient/response_parser.py"", line 131, in _convert_INTERNALDATE
    raise ValueError(""couldn't parse date %r"" % date_string)
    ValueError: couldn't parse date '6-Mar-2015 07:02:32 +0900'
```

Test Plan: passes tests

Reviewers: emfree

Reviewed By: emfree

Subscribers: spang

Differential Revision: https://review.inboxapp.com/D1303"
grinich,2015-03-15 04:30:56,https://api.github.com/repos/nylas/sync-engine/git/commits/a69985146ee3df43b31af84ba48ad90dd88cc932,a69985146ee3df43b31af84ba48ad90dd88cc932,slow computer
grinich,2015-03-15 03:13:12,https://api.github.com/repos/nylas/sync-engine/git/commits/9327b363b02bf51992a0a827bceb0ab655950aa4,9327b363b02bf51992a0a827bceb0ab655950aa4,add preflight check for UTC timezone (necessary for tests too)
grinich,2015-03-15 01:34:55,https://api.github.com/repos/nylas/sync-engine/git/commits/dd94099ab0ba66b4fd315d870499ee7a3aedcf6c,dd94099ab0ba66b4fd315d870499ee7a3aedcf6c,add a little more sleep and stricter types to help tests pass
emfree,2015-03-14 20:20:20,https://api.github.com/repos/nylas/sync-engine/git/commits/f838c33438c1b547bcad41a5fd860364941447e8,f838c33438c1b547bcad41a5fd860364941447e8,"Set smaller default timeout for streaming API.

Summary:
This timeout value is pretty arbitrary. But it has to be less than the
proxy_read_timeout configured in nginx (currently 3600s). Otherwise the proxy
may wrongly return 504s.

Fixes T934.

Test Plan: Not needed.

Reviewers: khamidou, spang

Reviewed By: spang

Subscribers: spang

Maniphest Tasks: T934

Differential Revision: https://review.inboxapp.com/D1301"
emfree,2015-03-14 00:06:53,https://api.github.com/repos/nylas/sync-engine/git/commits/44a15f0e3fc3c1b4b13467ca893b4e820216e7c0,44a15f0e3fc3c1b4b13467ca893b4e820216e7c0,"Lowercase addresses when canonicalizing.

Otherwise we may end up saving distinct contacts for support@nilas.com and
Support@nilas.com.

Test plan: tests updated."
khamidou,2015-03-13 00:04:19,https://api.github.com/repos/nylas/sync-engine/git/commits/114fff872b7d45e441d9d333110363f16b698beb,114fff872b7d45e441d9d333110363f16b698beb,"Make our threading algorithm a little more smarter

Summary:
This is a potential fix for the email threading issue a customer reported this morning. I'm saying ""potential"" because it's going to be more expensive in term of requests than what we already do.

Previously we would blindly group threads together if they had the same subject. This diff changes this to the following:
1. Look if the message we're ""threading"" is a reply to an existing message
2. Look if there's a reply to the message we're threading
3. Look if there's thread who share the same title and a subset of participants with the current message.

I think this should be enough for most cases.

Test Plan: Tested manually on my gandi account. Checked that threads were weaved correctly.

Reviewers: kav-ya, spang, emfree

Reviewed By: emfree

Subscribers: mg

Projects: #customers, #sync-engine

Differential Revision: https://review.inboxapp.com/D1243"
grinich,2015-03-12 23:34:35,https://api.github.com/repos/nylas/sync-engine/git/commits/aa8a973f93b87a10f4aaf8a81f4b47d09cb67252,aa8a973f93b87a10f4aaf8a81f4b47d09cb67252,"Deprecate rfc2822 endpoint and move to Accept header param

Summary:
I thought about this more, and it really should just be in the `Accept` header since it's an alternate representation of the same data.

We also need to update the SDKs for this and remove the old endpoint once usage drops off.

Test Plan: passes test

Reviewers: emfree

Subscribers: spang

Differential Revision: https://review.inboxapp.com/D1280"
emfree,2015-03-12 23:25:03,https://api.github.com/repos/nylas/sync-engine/git/commits/7a3b7266d4aac6b48dc2d8ca31507ac106154717,7a3b7266d4aac6b48dc2d8ca31507ac106154717,Fix typo in MIME message construction.
emfree,2015-03-05 22:09:14,https://api.github.com/repos/nylas/sync-engine/git/commits/b1f019407843d0071be51c37d9d3f1ab9816c3c3,b1f019407843d0071be51c37d9d3f1ab9816c3c3,"Clean up calendar/events API.

Summary:
* Don't include a list of all event ids in /calendars and
 /calendars/<calendar_id> responses.

* Remove `filter` parameter from /calendars endpoint. This doesn't seem like
  something anybody would actually use, and the docs for this were
  typo-ridden and confusing.

* Remove API support for creating/updating/deleting calendars. Since we don't
  actually sync these back to the provider, having these endpoints is just
  confusing.

* Remove support for creating events from an uploaded ics file. These would be
  added to the ""default"" calendar, whatever that is, and no syncback would
  happen, so the support here seems unsatisfactory.

* Don't allow event updates to change the calendar_id. Doing so would break
  syncback.

* Don't accept `reminders` or `recurrence` values when creating or updating an
  event. This is undocumented, and we don't expose these in responses either.

* Remove commented-out code for RSVPs. This was patently silly anyways,
  because the original motivation was something about being able to email
  out RSVP links to participants. But the route requires an auth header...

* Consolidate trivial logic from `inbox.events.crud` into API functions for
  simplicity.

Test Plan: Unit tests.

Reviewers: spang, jennie

Reviewed By: jennie

Differential Revision: https://review.inboxapp.com/D1274"
emfree,2015-03-09 18:19:10,https://api.github.com/repos/nylas/sync-engine/git/commits/a2b79468b112044c88707143cc70db9e7ee36fa7,a2b79468b112044c88707143cc70db9e7ee36fa7,Clean up idiosyncratic import.
emfree,2015-03-12 01:23:07,https://api.github.com/repos/nylas/sync-engine/git/commits/b4b7d73d4e1474e526ad522ddd0e368d90460b59,b4b7d73d4e1474e526ad522ddd0e368d90460b59,"Properly set plaintext MIME part content-type

Fixes T922."
emfree,2015-03-11 22:05:14,https://api.github.com/repos/nylas/sync-engine/git/commits/e5833f3b0f06a4c251fbc40a87f6095e9e5b60ff,e5833f3b0f06a4c251fbc40a87f6095e9e5b60ff,"Pin SQLAlchemy==0.9.6 in setup.py.

SQLAlchemy 0.9.9 seems to break
`from sqlalchemy.ext.declarative import as_declarative`."
emfree,2015-03-11 01:28:04,https://api.github.com/repos/nylas/sync-engine/git/commits/c8940f2487ab7e94f064aa6fa3d5ce62c5170969,c8940f2487ab7e94f064aa6fa3d5ce62c5170969,"Don't set account.sync_host to null in enable_sync.

Setting the sync_host to None without setting account.sync_should_run to False
can cause issues if the sync gets picked up by another host before it stops on
the original host, causihng the original host to erroneously keep holding the
lock.

(We really need a better worker lock system)"
emfree,2015-03-10 20:53:54,https://api.github.com/repos/nylas/sync-engine/git/commits/6919c835871d592649420958b70596d3fedd0e98,6919c835871d592649420958b70596d3fedd0e98,"More robustly convert br tags in snippet calculation.

Test Plan: Regression tests added.

Reviewers: mg

Reviewed By: mg

Differential Revision: https://review.inboxapp.com/D1275"
spang,2015-03-10 22:19:06,https://api.github.com/repos/nylas/sync-engine/git/commits/50f0d1ffd39099006fa0c182eac260bb54a752e1,50f0d1ffd39099006fa0c182eac260bb54a752e1,"Merge pull request #127 from elasticsales/always-store-full-body

Store full_body before attempting to parse the message.

Assigning the full_body early ensures we can still access the full RFC2822 body even if there's an error while parsing the actual message."
emfree,2015-03-10 06:41:15,https://api.github.com/repos/nylas/sync-engine/git/commits/4b59c70eb8ea0610f50217a2d9ffaa439be88041,4b59c70eb8ea0610f50217a2d9ffaa439be88041,"Revert ""forgot to remove migration""

This reverts commit 41c9fa093909eced94c18acd03a68a3843fb359f.

Reason for rollback: Assuming original commit was a mistake."
emfree,2015-03-10 05:59:08,https://api.github.com/repos/nylas/sync-engine/git/commits/855dc72d65c6731d1cc8ae5b5d1bb6e7546f9988,855dc72d65c6731d1cc8ae5b5d1bb6e7546f9988,"Add lxml to requirements.

Needed for CardDAV support with deb packaging."
thomasst,2015-03-10 05:18:53,https://api.github.com/repos/nylas/sync-engine/git/commits/f61278920338c75408bfee9c9a1d2ef7d2557765,f61278920338c75408bfee9c9a1d2ef7d2557765,Unit test + moving the code even further up
thomasst,2015-03-10 01:49:47,https://api.github.com/repos/nylas/sync-engine/git/commits/e56eda7bd39b71abe0eafb74a8fc1ff9a9b03999,e56eda7bd39b71abe0eafb74a8fc1ff9a9b03999,Store full_body before attempting to parse the message.
emfree,2015-03-09 22:03:53,https://api.github.com/repos/nylas/sync-engine/git/commits/c44b25d731251f273c47d03cdd8b2904889e5259,c44b25d731251f273c47d03cdd8b2904889e5259,Add missing vobject requirement.
emfree,2015-03-09 20:27:25,https://api.github.com/repos/nylas/sync-engine/git/commits/ad103b229f6999edf1fee4251b3bf3e08333c6cf,ad103b229f6999edf1fee4251b3bf3e08333c6cf,Fix hanging test by ensuring syncback service exits.
grinich,2015-03-09 20:25:25,https://api.github.com/repos/nylas/sync-engine/git/commits/41c9fa093909eced94c18acd03a68a3843fb359f,41c9fa093909eced94c18acd03a68a3843fb359f,forgot to remove migration
grinich,2015-03-09 20:23:54,https://api.github.com/repos/nylas/sync-engine/git/commits/129743d7fb7d9f3b2aea9d376c16187ee48e8500,129743d7fb7d9f3b2aea9d376c16187ee48e8500,"Add preliminary support for syncing contacts from iCloud via CardDav

Summary: Hacky first version of contacts import for iCloud. AgentBright needs this asap

Test Plan: Test manually with iCloud account

Reviewers: spang, jennie

Reviewed By: jennie

Projects: #sync-engine

Differential Revision: https://review.inboxapp.com/D1166"
jennielees,2015-02-28 00:15:24,https://api.github.com/repos/nylas/sync-engine/git/commits/6b10798e04d680b5ea5d066048f0471e04abe91d,6b10798e04d680b5ea5d066048f0471e04abe91d,Heartbeat debug helper <3
thomasst,2015-03-07 01:40:04,https://api.github.com/repos/nylas/sync-engine/git/commits/f6f9d4e75a2ca88cb65d31bde96353e74e4e0984,f6f9d4e75a2ca88cb65d31bde96353e74e4e0984,Support for IMAP STARTTLS
khamidou,2015-03-06 21:24:03,https://api.github.com/repos/nylas/sync-engine/git/commits/135e8be0cb526b908e9ba408e28fe08da6227616,135e8be0cb526b908e9ba408e28fe08da6227616,"[gmail] Correctly update read status for already downloaded ImapUids

Summary:
We don't update the read status when creating an ImapUid for a message we already have. This is a problem in the following scenario:
Let's say I have a new, unread message in my Inbox. I read it quickly and move it to the trash. We don't pick up that the message's read status has changed.

This diff fixes this.

Test Plan: Tested manually.

Reviewers: spang, jennie, emfree, kav-ya

Reviewed By: kav-ya

Projects: #sync-engine

Differential Revision: https://review.inboxapp.com/D1244"
emfree,2015-03-04 19:42:13,https://api.github.com/repos/nylas/sync-engine/git/commits/6404bd42fcdb5e249c605433c2be5668114e7e98,6404bd42fcdb5e249c605433c2be5668114e7e98,"Fix account sync start logic given concurrent actors.

Summary:
We set account.sync_host for any given account sync as a primitive sort of sync
mutex. Previously, a sync process would set this /after/ starting the account
sync. This is obviously a problem in the face of multiple hosts contending for
the sync: they will all start a sync, one of them will set the host, and then
the others will shut their sync down. This can lead to a variety of undesirable
behavior.

Instead, simply have sync processes atomically set the sync_host for a new sync
/before/ actually starting it.

Fixes T880.

Test Plan: Regression test added.

Reviewers: spang

Reviewed By: spang

Maniphest Tasks: T880

Differential Revision: https://review.inboxapp.com/D1261"
khamidou,2015-03-04 20:28:44,https://api.github.com/repos/nylas/sync-engine/git/commits/6f5a8ac8dd7eddd90f19a96d6e95fffdb73d7f68,6f5a8ac8dd7eddd90f19a96d6e95fffdb73d7f68,added regen labels script + removed delete-account.
emfree,2015-03-03 20:02:55,https://api.github.com/repos/nylas/sync-engine/git/commits/f961a69a9ee06019c65fb335ab07d24708f1faf0,f961a69a9ee06019c65fb335ab07d24708f1faf0,"Handle extra IMAP FETCH responses.

Summary:
This fixes an issue in which we failed to handle unsolicited FETCH responses
from an IMAP server. An example: say you do
`resp = crispin_client.conn.fetch([1764], ['X-GM-MSGID', 'X-GM-THRID'])`. This
may result in something like the following IMAP exchange:
```
C: CH6 UID FETCH 1764 (X-GM-MSGID X-GM-THRID)
S: * 1231 FETCH (X-GM-THRID 1494576757102068682 X-GM-MSGID 1494576757102068682 UID 1764 MODSEQ (95020))
S: * 1198 FETCH (UID 1731 MODSEQ (95215) FLAGS ())
```
Note that you got an unsolicited flags change for another UID. So the
IMAPClient result ends up being
```
ret == {
    1731: {'FLAGS': ('\\Seen',), 'SEQ': 1198, 'MODSEQ': (95125,)},
    1764: {'X-GM-MSGID': 1494576757102068682,
           'X-GM-THRID': 1494576757102068682, 'SEQ': 1231,
           'MODSEQ': (95020,)}
}
```

Previously we'd iterate through all key/value pairs of this dictionary and try
to extract the 'X-GM-MSGID' and 'X-GM-THRID' values from each. Obviously, this
won't work in this situation. Instead, only extract and return data for the
UIDs we actually requested.

Fixes T523.

Test Plan: Regression tests added.

Reviewers: spang

Reviewed By: spang

Maniphest Tasks: T523

Differential Revision: https://review.inboxapp.com/D1258"
kav-ya,2015-03-03 18:13:50,https://api.github.com/repos/nylas/sync-engine/git/commits/262322a0efc63ba502755152a4a66d3da98302fd,262322a0efc63ba502755152a4a66d3da98302fd,"[SCHEMA] Supporting changes for EAS calendar sync fixes.

Summary:

Includes:
1. Changes to delete_event()
2. Schema changes.

for revision D1239.

Test Plan: None, tests pass.

Reviewers: emfree

Reviewed By: emfree

Differential Revision: https://review.inboxapp.com/D1252"
grinich,2015-03-03 03:21:25,https://api.github.com/repos/nylas/sync-engine/git/commits/a404bd5abcbafe3827a62fdb027be96ecff7a3d4,a404bd5abcbafe3827a62fdb027be96ecff7a3d4,borked test file name
khamidou,2015-02-27 20:29:47,https://api.github.com/repos/nylas/sync-engine/git/commits/cf7a09258d736b8ffeb6a7a64429de614c684d0f,cf7a09258d736b8ffeb6a7a64429de614c684d0f,fix typo
emfree,2015-02-27 04:59:33,https://api.github.com/repos/nylas/sync-engine/git/commits/ba9a668db8f4eab2865428b6bccc1d00b560af0a,ba9a668db8f4eab2865428b6bccc1d00b560af0a,Fix typo.
jennielees,2015-02-27 01:30:32,https://api.github.com/repos/nylas/sync-engine/git/commits/9de9922b893c6a3d03e40dadb70a3402c2d1791f,9de9922b893c6a3d03e40dadb70a3402c2d1791f,[heartbeats] Fix bug with phantom heartbeats when device deleted
jennielees,2015-02-27 00:59:35,https://api.github.com/repos/nylas/sync-engine/git/commits/acd868b1f01dff67ee85effa5dd314964734a929,acd868b1f01dff67ee85effa5dd314964734a929,[heartbeats] Remove zscan_iter; too slow.
emfree,2015-02-27 00:29:37,https://api.github.com/repos/nylas/sync-engine/git/commits/5c28c67628650cf20cca4cf0d4a646663336db50,5c28c67628650cf20cca4cf0d4a646663336db50,"Log original exception when OperationalError occurs on rollback.

We're seeing strange ResourceClosedErrors, possibly related to the recent
changes here. This should help diagnose."
khamidou,2015-02-26 23:53:24,https://api.github.com/repos/nylas/sync-engine/git/commits/9e5471868a2d6d9ef85d9e2b9cd8eb8d1af6bb0e,9e5471868a2d6d9ef85d9e2b9cd8eb8d1af6bb0e,"Fix a label update issue reported by a customer.

Summary:
This one is pretty fun ;) One customer had a problem was that marking a message as read would work but moving it to the trash wouldn't. Here's what I think happened:

1. The customer marks a thread as read and moves it to the trash. It works.
2. he receives a new email related to this thread. Gmail's behaviour in this case is to move the thread back into Inbox and to discard its ""trash"" label. We don't pick this up.
3. He repeats 1. This time moving to trash doesn't work because we think the thread is already in the trash.

My solution was to manually discard the trash folder from a thread's folders if the newest UID doesn't have it. I understand that the code isn't super pretty and I'm open to alternatives.

Test Plan: Tested manually.

Reviewers: spang, kav-ya, emfree

Reviewed By: emfree

Projects: #sync-engine

Differential Revision: https://review.inboxapp.com/D1121"
jennielees,2015-02-26 23:26:37,https://api.github.com/repos/nylas/sync-engine/git/commits/3f9b7ff515550787b09a820713a3180c05ad6985,3f9b7ff515550787b09a820713a3180c05ad6985,[heartbeats] Prevent attribute errors if folder data incomplete
emfree,2015-02-26 22:49:07,https://api.github.com/repos/nylas/sync-engine/git/commits/713815f5aeaaf440f38760e8e3b3354932614c4f,713815f5aeaaf440f38760e8e3b3354932614c4f,"Execute syncback actions in order; don't sync back stale drafts.

Summary:
It's worth seriously evaluating making all syncback actions execute
synchronously. In the meantime, here are some changes that address major issues
with the current strategy.

* When the save_draft action executes, it reads the object state at syncback
  time and saves that. This is a problem in the face of successive updates:
```
  |
  | schedule_action('save_draft', version=0)
  |                                         \
  | schedule_action('save_draft', version=1) \
  |                                         \ \
  | schedule_action('save_draft', version=2) \ \
  |                                         \ \ \
  | schedule_action('save_draft', version=3) \ \ \
  |                                         \ \ \ \
  |                                          \ \ \ save_draft()
  |                                           \ \ \
  |                                            \ \ save_draft()
  |                                             \ \
  |                                              \ save_draft()
  |                                               \
  |                                                save_draft()
  V
 time
```

All save_draft actions read the same latest state, so the same message gets
separately saved four times. To work around this, pass the version when
scheduling the action, and only actually save the draft if that version matches
the object's version at syncback time.

* Execute actions for any given account in the order they were scheduled. This
  way, when you update a draft, the new version is definitely synced back
  before the old version is deleted, preventing the problem where we delete the
  draft locally in mailsync because it has no IMAP UIDs associated to it.

* When reconciling messages, decompose the X-Inbox-Id header into its public_id
  and version components. Otherwise mailsync can sync a UID for an old version
  of a draft and create a new, separate message object from it.

Test Plan:
Extensive manual testing -- tricky to write unit tests that exhibit
these race conditions.

Reviewers: spang

Reviewed By: spang

Differential Revision: https://review.inboxapp.com/D1240"
jennielees,2015-02-26 19:43:51,https://api.github.com/repos/nylas/sync-engine/git/commits/5cbb94610dd2173383f3181d45ec0c815c935234,5cbb94610dd2173383f3181d45ec0c815c935234,Fix heartbeat summary bug
khamidou,2015-02-26 00:59:46,https://api.github.com/repos/nylas/sync-engine/git/commits/e85d185c7ad289f97a3a18740a968414c0790e6e,e85d185c7ad289f97a3a18740a968414c0790e6e,"Marked synced back drafts as read

Summary: Previously we weren't adding the `\\Seen` IMAP flag to synced back drafts. This would make drafts appear as unread in Gmail.

Test Plan: Tested manually.

Reviewers: spang, mg

Reviewed By: mg

Projects: #sync-engine

Differential Revision: https://review.inboxapp.com/D1237"
jennielees,2015-02-25 23:29:54,https://api.github.com/repos/nylas/sync-engine/git/commits/5972291aca437fd110ab26715af60ef53c73b93c,5972291aca437fd110ab26715af60ef53c73b93c,Fix up heartbeat publishing issues surfaced from testing.
jennielees,2015-02-25 22:28:13,https://api.github.com/repos/nylas/sync-engine/git/commits/b0c77de8de404483dc24c37cbbe40980e16d333c,b0c77de8de404483dc24c37cbbe40980e16d333c,Heartbeat fixes.
jennielees,2015-02-25 20:31:39,https://api.github.com/repos/nylas/sync-engine/git/commits/9ce0e29a486ef88c40b193966282bb773626d258,9ce0e29a486ef88c40b193966282bb773626d258,Add mockredis requirement
jennielees,2015-02-25 20:06:47,https://api.github.com/repos/nylas/sync-engine/git/commits/ac18b8bc2b79ffd84fce302d68be32b8bffeee0c,ac18b8bc2b79ffd84fce302d68be32b8bffeee0c,"Refactor heartbeats to use sorted set indexes.

Summary:
Heartbeat updates to improve speed, ease of querying, and overall maintainability.

* Introduced `HeartbeatStore` to present a friendlier interface to the heartbeat-specific Redis commands.
* Replaced `scan_iter` (which is slow across thousands of keys) with a sorted set index.
* Added account-level heartbeat tracking as part of the index. This allows fast querying of accounts which haven't reported a heartbeat in a specific time period.
* Simplified to one expiry threshold for easier checking and upkeep.
* Publish mechanism has an initialize step which means per-folder metadata only needs to be populated once.
* Status checking scripts cleaned up.

Test Plan:
Added new tests in tests/heartbeat.

To avoid backwards-incompatibility errors locally, you will probably need to issue a `FLUSHALL` command in your local redis DB: `redis-cli FLUSHALL`.

With the sync engine running, `bin/check-heartbeat-report -h localhost` will show you dead accounts (try manually changing `ALIVE_THRESHOLD`) and `bin/show-heartbeat-status -h localhost` gives the full report. `bin/heartbeat-metrics -h localhost` is a first stab at a 'summary metrics' check.

Reviewers: systemizer

Reviewed By: systemizer

Subscribers: spang

Differential Revision: https://review.inboxapp.com/D1232"
emfree,2015-02-24 19:55:51,https://api.github.com/repos/nylas/sync-engine/git/commits/4c84cb03001bb77de2e41a3db5ec47ad6e453280,4c84cb03001bb77de2e41a3db5ec47ad6e453280,"Reraise original exception on OperationalError during rollback.

Summary:
If we catch an `OperationalError` in the `rollback()` call in
`session_scope()`, we want to reraise the original exception. Otherwise, if you
were trying to kill a greenlet, the `GreenletExit` exception is swallowed and
execution improperly continues.

Despite prior discussion, it turns out that it's not necessary to also
explicitly invalidate the underlying DBAPI connection -- in this scenario, that
already happens in `Connection._handle_dbapi_exception` when the
`OperationalError` is raised.

Test Plan:
The OperationalError scenario can be reproduced with something like
the following script:
```
import gevent
from gevent import monkey
monkey.patch_all()

from inbox.models.session import *
from inbox.models import *
from inbox.log import configure_logging
configure_logging(False)

def f():
    try:
        with session_scope() as db_session:
            print db_session.connection()
            while True:
                # Killing the greenlet in the midst of reading any sort of
                # SELECT result triggers the rollback --> OperationalError
                # scenario, so just loop fetching something.
                db_session.query(Tag).all()
    except BaseException as e:
        # We want to see GreenletExit here
        print type(e)

gr = gevent.spawn(f)

gevent.sleep(1)
gr.kill()
gevent.sleep(1)
```

Reviewers: jennie

Reviewed By: jennie

Differential Revision: https://review.inboxapp.com/D1229"
kav-ya,2015-02-24 18:03:28,https://api.github.com/repos/nylas/sync-engine/git/commits/7b5b33b42e93638aed07d60fc06429d985cdadb1,7b5b33b42e93638aed07d60fc06429d985cdadb1,"Revert ""Include `version` attribute in deltas returned for deleted drafts; /temporary/ fix for T853.""

This reverts commit 45012bb450e895e086dd15d5002d209c0a0d705e.

Reason for revert:
Was intended as a temp fix only, NR anymore."
emfree,2015-02-24 00:30:18,https://api.github.com/repos/nylas/sync-engine/git/commits/5c905b2787dd3e304ab6e7960e660ee25720d024,5c905b2787dd3e304ab6e7960e660ee25720d024,"Don't create 'delete' transactions for marked-deleted objects.

Summary:
We're using the `deleted_at` column to mark messages for async deletion. This
means that we *shouldn't* create a delete revision when `deleted_at` is set!

Fixes T853.

Test Plan: Unit tests.

Reviewers: kav-ya

Reviewed By: kav-ya

Maniphest Tasks: T853

Differential Revision: https://review.inboxapp.com/D1227"
jennielees,2015-02-24 02:41:42,https://api.github.com/repos/nylas/sync-engine/git/commits/e7245517f9a30a8d39c623077541b72ff2f019e9,e7245517f9a30a8d39c623077541b72ff2f019e9,Don't assume session rollbacks succeed.
khamidou,2015-02-23 23:27:22,https://api.github.com/repos/nylas/sync-engine/git/commits/341a4273a73571faa51ee386bdbca8790d6ab15d,341a4273a73571faa51ee386bdbca8790d6ab15d,add more setup.py scripts
jennielees,2015-02-23 22:53:22,https://api.github.com/repos/nylas/sync-engine/git/commits/fe2f0937124a3c7b0d6fb82f7713b27a99bd2296,fe2f0937124a3c7b0d6fb82f7713b27a99bd2296,[test] Fix event system tests
emfree,2015-02-23 18:05:14,https://api.github.com/repos/nylas/sync-engine/git/commits/71d4ff4ac49b137845b43a8264700ba4317345cb,71d4ff4ac49b137845b43a8264700ba4317345cb,"Add facility to reply to a specific message.

Summary:
This commit adds support for specifying that a draft is composed in response to
a specific message. Right now all this does is set the In-Reply-To and
References headers from that message.

To accomplish this:

* Restructure the drafts code a bit to reduce code duplication. Logic that was
  previously split across `draft_create_api`, `draft_send_api`, `create_draft`
  and `create_and_save_draft` is consolidated into `create_draft`.

* Repurpose the deprecated `resolved_message_id` column on the message table to
  be `reply_to_message_id`. Set this to point to the message you're replying
  to.

* Include a `""reply_to_message_id""` value in API responses for drafts.

We retain support for specifying a `thread_id` on drafts, with the following
semantics:
* If you specify both `reply_to_message_id` and `thread_id`, both the message
  and the thread have to exist, and the message has to belong to the thread.
  Otherwise an HTTP 400 error is returned.
* If you specify only `thread_id`, `reply_to_message_id` is set to be the most
  recent message on the thread at creation time.

Test Plan: Needs more unit tests -- still working on them.

Reviewers: kav-ya

Reviewed By: kav-ya

Differential Revision: https://review.inboxapp.com/D1219"
kav-ya,2015-02-20 23:37:55,https://api.github.com/repos/nylas/sync-engine/git/commits/45012bb450e895e086dd15d5002d209c0a0d705e,45012bb450e895e086dd15d5002d209c0a0d705e,"Include `version` attribute in deltas returned for deleted drafts; /temporary/ fix for T853.

Summary:
For drafts that are deleted, we store the version number in
Transaction.snapshot and include a `version` attribute in the
delete deltas returned.

Test Plan: Tests added.

Reviewers: spang

Reviewed By: spang

Subscribers: bengotow

Differential Revision: https://review.inboxapp.com/D1223"
jennielees,2015-02-21 01:21:26,https://api.github.com/repos/nylas/sync-engine/git/commits/a0be9bd5323d902aaca5ac0c14310da0290ba230,a0be9bd5323d902aaca5ac0c14310da0290ba230,update enum dependency
jennielees,2015-02-20 22:40:17,https://api.github.com/repos/nylas/sync-engine/git/commits/d7cd14d0c66437fad8a1a5271155e1b52f8f0f1d,d7cd14d0c66437fad8a1a5271155e1b52f8f0f1d,[tests] unthrottle system test account
jennielees,2015-02-20 21:56:18,https://api.github.com/repos/nylas/sync-engine/git/commits/ef05d6b3b0a21042b330e5c9ad3e142b18705a79,ef05d6b3b0a21042b330e5c9ad3e142b18705a79,Update enum->enum34 to handle namespace conflict
jennielees,2015-02-20 20:17:34,https://api.github.com/repos/nylas/sync-engine/git/commits/4949b1051656566ce544a8240b0328a61259868a,4949b1051656566ce544a8240b0328a61259868a,Fix migration history bug introduced with merge
jennielees,2015-02-20 18:20:20,https://api.github.com/repos/nylas/sync-engine/git/commits/3277617d905efbb03da14e50ea2564f9f379c2d5,3277617d905efbb03da14e50ea2564f9f379c2d5,Modify setup.sh to tolerate apt-get update failure
jennielees,2015-02-20 17:55:31,https://api.github.com/repos/nylas/sync-engine/git/commits/6b029b424aa3b88a50592f125794d8b339146983,6b029b424aa3b88a50592f125794d8b339146983,"Add flag to indicate whether an account should be syncing or not.

Summary:
Cleans up some of the sync start logic by using a boolean flag to denote whether an account should sync. This ties in to the heartbeat reporting in that if this flag is True, the heartbeat should also be True unless there is a problem.

This flag is set to True by default and flipped to False if the account has invalid credentials or if external factors disable the account. The `sync_state` field sticks around (for now) but reflects a record of the state, rather than an instruction.

To tie heartbeats and database status more closely, this patch also updates the folder status when they are cleanly stopped, to avoid red herrings (missing heartbeats for 'running' folders).

Test Plan: Added a little more test coverage; test manually by starting, stopping and killing syncs.

Reviewers: emfree

Reviewed By: emfree

Differential Revision: https://review.inboxapp.com/D1216"
grinich,2015-02-20 07:54:19,https://api.github.com/repos/nylas/sync-engine/git/commits/c21db138ee185b9c58b8ab41da5a35cdcc77f4b6,c21db138ee185b9c58b8ab41da5a35cdcc77f4b6,"more explicit when sending heartbeat format, softer requirements on schema"
grinich,2015-02-20 07:38:51,https://api.github.com/repos/nylas/sync-engine/git/commits/4cac9adf03674eb670f9368fadc5de947bd9b383,4cac9adf03674eb670f9368fadc5de947bd9b383,Start heartbeat proxy with correct params
grinich,2015-02-20 06:02:12,https://api.github.com/repos/nylas/sync-engine/git/commits/6e6c03e193cf0e2791d2d59e8b8b2d18b0c7ce76,6e6c03e193cf0e2791d2d59e8b8b2d18b0c7ce76,"Remove 3-way sync for contacts; make contacts API read-only

Summary:
The big change here is getting us closer to removing the crazy overly-abstrated 3-way merge sync system for contacts and event objects. I started with contacts here because events are a bit more complicated due to syncback.

This change also makes the contacts API read-only. Previously you could create events by issuing a PUT command, but that is confusing and silly because we don't sync them back. I will eat my hat if anyone actually misses this feature.

Notable changes:

- Simplify the `base_sync` module as a Greenlet subclass
- Pull sync code from base_sync into specific event and contact remote_sync
- Refactor a some of the basic sync logic for events
- Remove `source` field on contacts [migration]
- Delete contacts with `remote` source [migration]
- Remove API endpoint for creating contacts
- Update docs with API removal
- Fix all the corresponding tests
- Remove tests for deprecated APIs

There are still a few ugly things I want to change, like how the BaseSyncMonitor has a notion of folder_id, but that should involve deeper thinking about how we're mapping greenlets with hearbeats.

Test Plan: Run the tests. We should put this through it's paces on staging a bit. It works in my VM but there may be performance regressions or god knows what.

Reviewers: khamidou, spang, emfree, kav-ya

Reviewed By: kav-ya

Subscribers: kav-ya, spang

Projects: #sync-engine, #api

Differential Revision: https://review.inboxapp.com/D1207"
emfree,2015-02-20 00:24:52,https://api.github.com/repos/nylas/sync-engine/git/commits/18e7611f07465b09a582d070ad15538579c235c9,18e7611f07465b09a582d070ad15538579c235c9,"When getting transactions, only use index hint if namespace_id is specified.

Otherwise the search indexer gets really slow."
khamidou,2015-02-19 19:28:42,https://api.github.com/repos/nylas/sync-engine/git/commits/cab1e8ff24fd8a6d06a191e0c51c5d4412ab58e8,cab1e8ff24fd8a6d06a191e0c51c5d4412ab58e8,"[Utility] A small script to start and stop account syncs.

Summary: I got tired of moving accounts manually from `sync-engine` to `sync-engine-debug` so I wrote a small script to simplify things.

Test Plan: Tested manually.

Reviewers: kav-ya, emfree, jennie

Reviewed By: jennie

Projects: #sync-engine

Differential Revision: https://review.inboxapp.com/D1220"
emfree,2015-02-19 00:14:50,https://api.github.com/repos/nylas/sync-engine/git/commits/fd84a5b05ecac33d39a2da77a7d869221b3436ec,fd84a5b05ecac33d39a2da77a7d869221b3436ec,"Fix performance regression in delta sync.

Summary:
Perhaps an explanation is in order.

Recall that InnoDB automatically creates indexes on foreign keys. So let's say
you start with a `transaction` table that looks like this (some fields omitted
for simplicity):
```
| transaction | CREATE TABLE `transaction` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `namespace_id` int(11) NOT NULL,
  `deleted_at` datetime DEFAULT NULL,
  `created_at` datetime NOT NULL,
  `object_type` varchar(20) NOT NULL,
  `record_id` int(11) NOT NULL,
  `command` enum('insert','update','delete') NOT NULL,
  PRIMARY KEY (`id`),
  KEY `namespace_id` (`namespace_id`),
  CONSTRAINT `transaction_ibfk_1` FOREIGN KEY (`namespace_id`) REFERENCES `namespace` (`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 |
```

Now you want to get the transaction rows for a given `namespace_id` starting at
a given point. So basically
```
mysql> SELECT * FROM transaction WHERE namespace_id=22 AND id>3141
    -> ORDER BY id ASC LIMIT 100;
```
No problem! Secondary indices in an InnoDB table actually have the primary key
values concatenated to them, so the `namespace_id` index can be used to
efficiently satisfy the ORDER BY. See
http://www.psce.com/blog/2012/05/17/can-mysql-use-primary-key-values-from-a-secondary-index/
for more.

Okay, now let's say you identify another query that's slow, and fix it by
adding a multi-column index:
```
mysql> ALTER TABLE transaction ADD INDEX `namespace_id_created_at`
    -> (`namespace_id, created_at`);
```

The query is fast, and you move on with your life.
Unfortunately, when you do this, InnoDB just decides that you don't need that
foreign key index on `namespace_id` any more. So your table looks like this:
```
| transaction | CREATE TABLE `transaction` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `namespace_id` int(11) NOT NULL,
  `deleted_at` datetime DEFAULT NULL,
  `created_at` datetime NOT NULL,
  `object_type` varchar(20) NOT NULL,
  `record_id` int(11) NOT NULL,
  `command` enum('insert','update','delete') NOT NULL,
  PRIMARY KEY (`id`),
  KEY `ix_transaction_namespace_id_created_at` (`namespace_id`, `created_at`),
  CONSTRAINT `transaction_ibfk_1` FOREIGN KEY (`namespace_id`) REFERENCES `namespace` (`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 |
```

This means that your original query can no longer be satisfied with an index,
and can become DEADLY SLOW.

We could fix this by explicitly re-adding an index on `namespace_id`. But in
our case, we actually already have an index
```
`namespace_id_deleted_at` (`namespace_id`, `deleted_at`)`
```
from the days of soft-deletion, so it's more expedient to trivially change the
query to
```
mysql> SELECT * FROM transaction USE INDEX (`namespace_id_deleted_at`)
    -> WHERE namespace_id=22 AND id>3141 AND
    -> deleted_at IS NULL ORDER BY id ASC LIMIT 100;
```
Because `deleted_at` is explicitly constant here, and because MySQL needs to
die in a fire, this is again fast.

Test Plan: Unit tests; experimentation.

Reviewers: mg

Reviewed By: mg

Subscribers: kav-ya, spang

Differential Revision: https://review.inboxapp.com/D1212"
khamidou,2015-02-19 02:50:43,https://api.github.com/repos/nylas/sync-engine/git/commits/3cb96a90c147ea9c07414bc50c338cf149a96c82,3cb96a90c147ea9c07414bc50c338cf149a96c82,mirror prod migration 135/f32220b884bae
khamidou,2015-02-18 22:53:17,https://api.github.com/repos/nylas/sync-engine/git/commits/8c34ea28a4e3e51ac533ea59f9ce21ef27ad6833,8c34ea28a4e3e51ac533ea59f9ce21ef27ad6833,"Refactor out participants_by_email

Summary: Store an event's participants using a list instead of a hash. There was also a lot of support code for the base_sync merge algorithm which I took the liberty of removing. Are you okay with this? I didnt' fix the tests because I wasn't sure.

Test Plan: Tested manually.

Reviewers: kav-ya, emfree

Reviewed By: emfree

Projects: #eas

Maniphest Tasks: T803

Differential Revision: https://review.inboxapp.com/D1189"
grinich,2015-02-18 22:43:59,https://api.github.com/repos/nylas/sync-engine/git/commits/c7127eae419e4eb059a63d010c257deb86aef13d,c7127eae419e4eb059a63d010c257deb86aef13d,"Add compound index for contacts and events

Summary: I've got the need. The need for speed.

Test Plan: Passes tests.

Reviewers: emfree

Reviewed By: emfree

Differential Revision: https://review.inboxapp.com/D1205"
jennielees,2015-02-18 22:35:19,https://api.github.com/repos/nylas/sync-engine/git/commits/543fba26b1252fc436784b9310713170eca9e656,543fba26b1252fc436784b9310713170eca9e656,"Handle minimum modification time error

Summary: If a request is made to the Google Calendar API with a minimum modification time too far in the past, a HttpError occurs. This can happen if sync is stopped on an account for a while, and then restarted. This patch fixes that error.

Test Plan: Two new tests in tests.general.events.test_remote_sync

Reviewers: khamidou

Reviewed By: khamidou

Differential Revision: https://review.inboxapp.com/D1210"
khamidou,2015-02-18 16:31:46,https://api.github.com/repos/nylas/sync-engine/git/commits/53f55a74c7b52952e74374e1eae671bb78b87aa4,53f55a74c7b52952e74374e1eae671bb78b87aa4,"Split the migrations in D1189

Summary:
This diff contains three things:
- a basic online migration to add a `participants` column
- some fixes to the code to update both `participants_by_email` and `participants`. Note that it didn't work using an SA validator (for some reason the validator would only get called when the object is initialized by SA), so I had to modify all the places were `participants_by_email` is called to update `participants`.
- a script to migrate db rows to the new format

Test Plan: Tested manually.

Reviewers: kav-ya, emfree

Reviewed By: emfree

Projects: #sync-engine

Maniphest Tasks: T803

Differential Revision: https://review.inboxapp.com/D1204"
grinich,2015-02-18 03:55:17,https://api.github.com/repos/nylas/sync-engine/git/commits/4aa9852e8c759e12087f643a3a6b1225b47e6241,4aa9852e8c759e12087f643a3a6b1225b47e6241,"Fix a couple Google Calendar parsing bugs by relaxing our requirements for events

Summary:
Turns out some events from Google calendar contain recipients without email addresses

The change of

```
- assert abs((message.deleted_at - datetime.utcnow()).total_seconds()) < 1
+ assert abs((message.deleted_at - datetime.utcnow()).total_seconds()) < 2
```

is because my VM is slow. :(

Test Plan: Fixed bugs occuring in mgrinich@gmail.com calenadr

Reviewers: spang, emfree

Differential Revision: https://review.inboxapp.com/D1164"
emfree,2015-02-17 21:17:40,https://api.github.com/repos/nylas/sync-engine/git/commits/b3b37c26b2c1bb2ebdd162d29437f3475d5c39bb,b3b37c26b2c1bb2ebdd162d29437f3475d5c39bb,"Handle permanent sending failures due to message content.

Summary:
Messages can be rejected because they're too large, contain attachments
forbidden by security policy, etc. This is basically a permanent rejection, so
we should return an appropriate API error response. Handle some of these
accordingly. More conditions are possible in theory (e.g., ""This message
appears to be spam""), but I haven't been able to produce them. So just handle the
known cases for now.

Test Plan: Unit tests added.

Reviewers: kav-ya

Reviewed By: kav-ya

Differential Revision: https://review.inboxapp.com/D1196"
emfree,2015-02-17 21:07:05,https://api.github.com/repos/nylas/sync-engine/git/commits/e4af06c9f0845492f21336f675d1374c45100764,e4af06c9f0845492f21336f675d1374c45100764,"Re-silence the Google API client logger.

Originally done in d7d68ac01aa, needs to be fixed now that the package name has
apparently changed."
emfree,2015-02-17 20:32:31,https://api.github.com/repos/nylas/sync-engine/git/commits/25d124a1e0c25ab3820cade4cbc4d2cb40ccc31d,25d124a1e0c25ab3820cade4cbc4d2cb40ccc31d,"Refetch IMAP folder list in case of IMAP connection errors.

Some backends (Outlook) close inactive IMAP connections very quickly. In such
cases, fetching the folder list in `prepare_sync()` may fail, causing the
sync to fail to start properly unless we retry."
jennielees,2015-02-13 19:33:44,https://api.github.com/repos/nylas/sync-engine/git/commits/4e987b4b3d697f0949e18ed2d9c0a85e426f5279,4e987b4b3d697f0949e18ed2d9c0a85e426f5279,Add summary option to heartbeat script
emfree,2015-02-13 07:04:51,https://api.github.com/repos/nylas/sync-engine/git/commits/69a00b619944f102a75bd16bfba093ef3aeee872,69a00b619944f102a75bd16bfba093ef3aeee872,"Implement new draft/thread versioning.

Summary:
* Threads get a version! The version parameter is incremented each time the
  thread changes.
* PUT requests to /threads/<thread_id> now accept an optional ""version"" value.
  Requests are rejected with a 409 error if a version is provided and it
  doesn't match what we have stored.
* Draft versions are now incrementing versions rather than opaque values. This
  way clients repeatedly updating a draft can discard old versions that they
  get back via the delta sync API.
* The X-Inbox-Id header is now constructed as {public_id}-{version}.

The actual versioning bookkeeping is done a little differently for the two
object types. Draft versions change only when the draft is changed via the
API. Thread versions change whenever the object does, via a pre-flush hook.
This implementation might change in the future.

Finally, a few bugfixes as a result:
* Correctly version threads when a message on the thread is removed. This
  is a bit messy right now, but we probably want to separately overhaul the
  thread/message data model.
* The test database session fixture versions objects, for consistency with the
  rest of our code.

Test Plan: Unit tests added/updated.

Reviewers: jennie, spang

Reviewed By: spang

Subscribers: kav-ya

Differential Revision: https://review.inboxapp.com/D1188"
khamidou,2015-02-13 02:17:04,https://api.github.com/repos/nylas/sync-engine/git/commits/58a725113867cc0ecf0639981dae2a6ff7bab918,58a725113867cc0ecf0639981dae2a6ff7bab918,"For gmail accounts, make mark as read work on all folders

Summary:
We used to mark as read only messages in All Mail. Fix this for messages in Spam and Trash.

Note: I would have made the same change for staring messages but it seems you can't star messages in trash.

Test Plan: Tested manually.

Reviewers: emfree

Reviewed By: emfree

Projects: #sync-engine

Maniphest Tasks: T777

Differential Revision: https://review.inboxapp.com/D1191"
jennielees,2015-02-12 18:15:21,https://api.github.com/repos/nylas/sync-engine/git/commits/514c7b12e29991b9e9f8b34eb3845aced525dc02,514c7b12e29991b9e9f8b34eb3845aced525dc02,"Reformat heartbeat check output

Summary: A little more readability and verbosity. Groups output by providers. Verbose flag shows full email addresses for all dead accounts; disabled by default as it's pretty noisy. Newly dead are always verbose.

Test Plan: Tested with -h [sync status host] and observed output.

Reviewers: emfree

Reviewed By: emfree

Subscribers: spang

Differential Revision: https://review.inboxapp.com/D1182"
emfree,2015-02-12 00:34:41,https://api.github.com/repos/nylas/sync-engine/git/commits/e5799ab3529cb6e0e3ec0dd05b5b5fa00d15905d,e5799ab3529cb6e0e3ec0dd05b5b5fa00d15905d,"Don't break on MIME parts with invalid content-disposition.

Summary: Fixes T766.

Test Plan: Regression test added.

Reviewers: spang

Reviewed By: spang

Maniphest Tasks: T766

Differential Revision: https://review.inboxapp.com/D1185"
emfree,2015-02-11 21:15:26,https://api.github.com/repos/nylas/sync-engine/git/commits/e5c42391a4e5deb8aff0f62a01797295b845c9d6,e5c42391a4e5deb8aff0f62a01797295b845c9d6,"Tweak syncback service schema and queries for performance.

Summary:
As the table grows, it turns out to be faster to fetch all pending actions
(with the right index) than to page the query.

Test Plan:
Run migration and example queries against prod replica; run unit
tests.

Reviewers: spang

Differential Revision: https://review.inboxapp.com/D1181"
jennielees,2015-02-11 22:28:59,https://api.github.com/repos/nylas/sync-engine/git/commits/0c39321d4e3cf50d3d5c8e4c36d7733600404838,0c39321d4e3cf50d3d5c8e4c36d7733600404838,Fix typo in heartbeat status
emfree,2015-02-11 20:25:32,https://api.github.com/repos/nylas/sync-engine/git/commits/531e8cef62871e0be6649944b391e413a3ea2f6a,531e8cef62871e0be6649944b391e413a3ea2f6a,"Use faster query when deduplicating by g_msgid.

Summary:
Messages didn't use to have a namespace_id, but now they do, and filtering
directly on it is substantially faster.

Test Plan: Run sync as sanity-check.

Reviewers: spang

Reviewed By: spang

Differential Revision: https://review.inboxapp.com/D1180"
emfree,2015-02-11 04:53:38,https://api.github.com/repos/nylas/sync-engine/git/commits/ff9a0270e38ba9943df84426b333dbb800d85901,ff9a0270e38ba9943df84426b333dbb800d85901,Fix typo in SMTP retrying.
jennielees,2015-02-11 02:01:48,https://api.github.com/repos/nylas/sync-engine/git/commits/cb9675d613851fdc23cd26fa858749da66c89ba7,cb9675d613851fdc23cd26fa858749da66c89ba7,"Per-tag unread and thread counts

Summary: Add `unread_count` and `thread_count` to the /tag/<tag_id> endpoint.

Test Plan: New test in tests/api/test_tags.py

Reviewers: emfree

Reviewed By: emfree

Subscribers: spang

Differential Revision: https://review.inboxapp.com/D1175"
emfree,2015-02-11 01:44:00,https://api.github.com/repos/nylas/sync-engine/git/commits/8b25aea234ee59eb9b70321cce8d925ca25243cb,8b25aea234ee59eb9b70321cce8d925ca25243cb,Fix typos.
emfree,2015-02-11 01:39:26,https://api.github.com/repos/nylas/sync-engine/git/commits/36c51d2d25b46bdd3ff26158d0d26c72766feb18,36c51d2d25b46bdd3ff26158d0d26c72766feb18,"Narrow thread filtering criteria when joining to messages.

Improves query performance."
emfree,2015-02-10 03:03:28,https://api.github.com/repos/nylas/sync-engine/git/commits/320292ca06cdf27c0595955d0a2f6deab02589cb,320292ca06cdf27c0595955d0a2f6deab02589cb,"Improve SMTP error handling and retrying.

Summary:
* Surface known temporary errors when authenticating the connection as 503
  (""Service temporarily unavailable"") rather than 403 (""Invalid credentials"").

* If sending fails altogether, retry once rather than failing to the client
  immediately. (T763)

Test Plan: Tested manually.

Reviewers: spang, kav-ya

Reviewed By: kav-ya

Differential Revision: https://review.inboxapp.com/D1173"
jennielees,2015-02-09 23:13:09,https://api.github.com/repos/nylas/sync-engine/git/commits/928105693f44c77bf5bbf504eb5965e190a6ceac,928105693f44c77bf5bbf504eb5965e190a6ceac,Fix heartbeat status typo
emfree,2015-02-09 18:49:20,https://api.github.com/repos/nylas/sync-engine/git/commits/6b862280639df3caba34ea27d23a5d3bc8a86cf7,6b862280639df3caba34ea27d23a5d3bc8a86cf7,"Fix tag create/update endpoint when namespace_id is provided.

Test Plan: Unit tests fixed to actually exercise this case.

Reviewers: jennie

Reviewed By: jennie

Differential Revision: https://review.inboxapp.com/D1169"
emfree,2015-02-09 17:51:27,https://api.github.com/repos/nylas/sync-engine/git/commits/fec1246da078d964183f07d0e6071db8f003a2ee,fec1246da078d964183f07d0e6071db8f003a2ee,"Properly handle challenges in SMTP XOAUTH2 authentication.

See https://developers.google.com/gmail/xoauth2_protocol"
grinich,2015-02-09 09:27:14,https://api.github.com/repos/nylas/sync-engine/git/commits/18125600dddce44f686d600b4fc1f2de9376fb47,18125600dddce44f686d600b4fc1f2de9376fb47,"Correct dt_to_timestamp

>>> import datetime, time
>>> dt = datetime.datetime(2014, 5, 3, 0, 26, 5)
>>> int((dt - datetime.datetime(1970, 1, 1)).total_seconds())
1399076765

12:26:05 am UTC  |  Saturday, May 3, 2014
http://www.wolframalpha.com/input/?i=1399076765+seconds+since+unix+epoch+in+utc

>>> int(time.mktime(dt.utctimetuple()))
1399105565

8:26:05 am UTC  |  Saturday, May 3, 2014
http://www.wolframalpha.com/input/?i=1399105565+seconds+since+unix+epoch+in+utc"
emfree,2015-02-08 21:49:34,https://api.github.com/repos/nylas/sync-engine/git/commits/ef6b5ca32a337185c48d6b2afb63d49a428f44c7,ef6b5ca32a337185c48d6b2afb63d49a428f44c7,Fix dt_to_timestamp helper for non-UTC environments.
grinich,2015-02-08 07:14:28,https://api.github.com/repos/nylas/sync-engine/git/commits/13bc846d6e3d894f999c077b2e9bbcdf5d4e83a4,13bc846d6e3d894f999c077b2e9bbcdf5d4e83a4,move sentence
grinich,2015-02-06 21:46:49,https://api.github.com/repos/nylas/sync-engine/git/commits/c728b68ed974b67be3aaa16064bef54028459df1,c728b68ed974b67be3aaa16064bef54028459df1,"Don't strip `Re: ` from message subjects & support for german threading

Summary:
Subject of the thread is the first message in the thread. Stripping out `Re: ` for individual messages can be done client-side.

Also add support for `AW` and `WG` in threading prefixes.

Test Plan: Run tests

Reviewers: spang

Reviewed By: spang

Subscribers: emfree, bengotow

Differential Revision: https://review.inboxapp.com/D1158"
emfree,2015-02-07 06:07:32,https://api.github.com/repos/nylas/sync-engine/git/commits/c7252d6d68dd51f71d1f3c09dde32581b4efa26e,c7252d6d68dd51f71d1f3c09dde32581b4efa26e,"Properly handle SMTP auth errors when using XOAUTH2.

Summary:
Previously we'd use `smtplib.SMTP.docmd()` to implement XOAUTH2 auth, and try
to catch `smtplib.SMTPAuthenticationError`. Unfortunately, the `docmd()` method
never throws `SMTPAuthenticationError`. You have to actually check the return
code. Do that instead.

Test Plan:
Patch token manager to return fake tokens. Verify that sending then
fails appropriately with a 403 status code returned.

Reviewers: kav-ya, mg, jennie

Reviewed By: jennie

Differential Revision: https://review.inboxapp.com/D1161"
grinich,2015-02-06 20:39:54,https://api.github.com/repos/nylas/sync-engine/git/commits/90364571b4b3b5edc4868936d91e6773006d6254,90364571b4b3b5edc4868936d91e6773006d6254,remove old trimmed_subjects since we're now using Flanker's
jennielees,2015-02-06 19:56:49,https://api.github.com/repos/nylas/sync-engine/git/commits/48f65897c952dbd3ae6986e46d2904e76d716d71,48f65897c952dbd3ae6986e46d2904e76d716d71,correct version of google-api-python-client: 1.3.1
jennielees,2015-02-06 19:53:52,https://api.github.com/repos/nylas/sync-engine/git/commits/77fa41b678ad1facad76b4b66280db4af2944707,77fa41b678ad1facad76b4b66280db4af2944707,"revert google-api-python-client change

Tested locally with 1.3 and can't repro the issue that caused me to downgrade it. 1.2 pulls in its own oauth2client so we shouldn't use it."
filipposironi,2015-02-06 19:30:03,https://api.github.com/repos/nylas/sync-engine/git/commits/a099334aae4bc878e0b4aa5e3238a1f09043820e,a099334aae4bc878e0b4aa5e3238a1f09043820e,"Refactor the heartbeat status infrastructure.

Summary:
This commit changes the heartbeat status infrastructure in many ways.

1. It introduces the {Account,Folder,Device}HeartbeatStatus classes to
   improve code reability (i.e., object.field is much better than
   object[0]). Each class has its own .jsonify() method to output a
   dictionary with the class's content;

2. It updates all the pieces of code to use the new classes (e.g.,
   bin/show-heartbeat-status). Notably, the get_heartbeat_status()
   function now returns a dictionary which maps an account ID with an
   object of type AccountHeartbeatStatus;

3. It publishes the email address alongside the other parameters to
   improve reporting;

4. It updates the bin/check-heartbeat-report script to output the
   account ID, the email address, and the email provider and improves
   the type-safety in the inbox.heartbeat.report module;

5. It (slightly) improves the code (e.g., .exists() is better then
   .keys() when accessing Redis).

Fix T755.

NOTE: when deploying, make sure to clear the second (2) db in Redis
and to update mt-st-helena, which is the machine that runs the
bin/check-heartbeat-report script.

Test Plan:
Sync a few accounts (at least gmail and eas) and make sure the system
isn't broken -- try running the bin/show-heartbeat-status and
bin/check-heartbeat-report scripts.
Start the admin dashboard to double check the integration (be sure to
pull the changes).

Reviewers: jennie

Reviewed By: jennie

Subscribers: mg, spang

Projects: #sync-engine

Maniphest Tasks: T755

Differential Revision: https://review.inboxapp.com/D1153"
emfree,2015-02-06 19:02:04,https://api.github.com/repos/nylas/sync-engine/git/commits/0820a52efec4b28f4dc63e93b963a32f9ba89d88,0820a52efec4b28f4dc63e93b963a32f9ba89d88,Fix migration linearity.
emfree,2015-02-06 05:29:08,https://api.github.com/repos/nylas/sync-engine/git/commits/77cf9d9affc68325bb7784638696446d670c5e7b,77cf9d9affc68325bb7784638696446d670c5e7b,"Add index on message table for async deletion performance.

Test Plan: Run migration on replica; verify that queries are fast.

Reviewers: spang

Reviewed By: spang

Differential Revision: https://review.inboxapp.com/D1152"
filipposironi,2015-02-06 10:41:36,https://api.github.com/repos/nylas/sync-engine/git/commits/c6f6de5facc542e3a60da052fb3f6fa4ab7c59be,c6f6de5facc542e3a60da052fb3f6fa4ab7c59be,Fix migrations order between #132 and #133.
kav-ya,2015-02-05 22:37:13,https://api.github.com/repos/nylas/sync-engine/git/commits/7c0480aa670b96ca7751226dba0a7e0c2180a9b1,7c0480aa670b96ca7751226dba0a7e0c2180a9b1,"Update retry_and_report_killed() for custom EAS support.

Summary: See corresponding inbox-eas revision (D1145)

Test Plan: Tested EAS, non-EAS syncs locally.

Reviewers: emfree

Reviewed By: emfree

Differential Revision: https://review.inboxapp.com/D1146"
emfree,2015-02-05 20:40:53,https://api.github.com/repos/nylas/sync-engine/git/commits/1ea3b241f7e8e52977fbc62157b088be1ece7932,1ea3b241f7e8e52977fbc62157b088be1ece7932,Also extend path in inbox/models/__init__.py
emfree,2015-02-05 20:15:52,https://api.github.com/repos/nylas/sync-engine/git/commits/8f48f4fda5d10bca06a626df1fc0bc49e4fee6c0,8f48f4fda5d10bca06a626df1fc0bc49e4fee6c0,Remove outdated comment.
jennielees,2015-02-05 19:49:30,https://api.github.com/repos/nylas/sync-engine/git/commits/02b43111e1a6bebe9a6f9ecd086a17a1ed94129f,02b43111e1a6bebe9a6f9ecd086a17a1ed94129f,Fix incompatible google-api-python-client version
emfree,2015-02-05 19:13:16,https://api.github.com/repos/nylas/sync-engine/git/commits/579f6d66d1c022f2c40dbdea5ed6f49a7f708f12,579f6d66d1c022f2c40dbdea5ed6f49a7f708f12,"Update __init__ files for proper namespace packaging.

Summary:
If you have a namespace package, the contents of corresponding `__init__.py`
files in your different projects really have to match, or things break if you
import the wrong file first. To enable this:

* Move contents of `inbox/actions/__init__.py` to `inbox/actions/base.py`.
* Similarly move `inbox/auth/__init__.py` to `inbox/auth/base.py`.
* Remove registration of auth handlers via setuptools entry_points. Not worth
  maintaining this. Register them via module constants for simplicity.
* Move imports out of `inbox/models/__init__.py` so that they don't have to be
  duplicated across repos. But enable statements like
  `from inbox.models import Account` via arcane trickery. See the file
  docstring for details.

Test Plan:
Run unit tests. Change easy-install.pth so things get imported in
the ""wrong"" order and check that things still work.

Reviewers: kav-ya, spang, systemizer

Reviewed By: systemizer

Differential Revision: https://review.inboxapp.com/D1136"
filipposironi,2015-02-05 15:02:13,https://api.github.com/repos/nylas/sync-engine/git/commits/1992bc702a52a742d4d40110ccdd359e502fadef,1992bc702a52a742d4d40110ccdd359e502fadef,Fix oauth2client version.
filipposironi,2015-02-05 14:56:37,https://api.github.com/repos/nylas/sync-engine/git/commits/24ac3dbf1387380b8cdf057290bd1be986ed2c95,24ac3dbf1387380b8cdf057290bd1be986ed2c95,Fix requirements order.
filipposironi,2015-02-05 10:41:13,https://api.github.com/repos/nylas/sync-engine/git/commits/99052e1305e0b8ce5ca04fc2541f67f84f8d8514,99052e1305e0b8ce5ca04fc2541f67f84f8d8514,Fix EAS heartbeat status configuration.
filipposironi,2015-02-05 09:13:55,https://api.github.com/repos/nylas/sync-engine/git/commits/fb2039e1155edd9f1f2d09339ac3c9739be97986,fb2039e1155edd9f1f2d09339ac3c9739be97986,"Add ON DELETE CASCADE to part.block_id.

Summary:
This revision fixes an error in the 091_parts_block_ids.py migration.

Fix T765.

Test Plan: N/A.

Reviewers: emfree

Reviewed By: emfree

Subscribers: spang

Maniphest Tasks: T765

Differential Revision: https://review.inboxapp.com/D1130"
jennielees,2015-02-04 19:45:12,https://api.github.com/repos/nylas/sync-engine/git/commits/eb159e9447d48fddc133948f7b8b26ec11c55f4a,eb159e9447d48fddc133948f7b8b26ec11c55f4a,"Add API doc for views

Summary: Per T645, this wasn't documented. Now it is.

Test Plan: Read docs. /docs/api#views

Reviewers: khamidou

Reviewed By: khamidou

Subscribers: spang

Differential Revision: https://review.inboxapp.com/D1126"
jennielees,2015-02-04 19:44:04,https://api.github.com/repos/nylas/sync-engine/git/commits/cd23c6119afd920a1c41b84cf215d96d144d41e9,cd23c6119afd920a1c41b84cf215d96d144d41e9,Release port 5009 for other VMs to use.
filipposironi,2015-02-04 14:35:19,https://api.github.com/repos/nylas/sync-engine/git/commits/29c31d70492ef0491129820dce13b14e59a56bd7,29c31d70492ef0491129820dce13b14e59a56bd7,Update heartbeat status to support the EAS refactor.
khamidou,2015-02-04 14:20:33,https://api.github.com/repos/nylas/sync-engine/git/commits/622e5f66badd204b56c3c0d20732fb67f2a2cbe5,622e5f66badd204b56c3c0d20732fb67f2a2cbe5,fix migration order
filipposironi,2015-02-04 14:09:22,https://api.github.com/repos/nylas/sync-engine/git/commits/53bb96b2e8ec174998ccf850dc787e1f409285ab,53bb96b2e8ec174998ccf850dc787e1f409285ab,Sync alive thresholds.
khamidou,2015-02-04 14:07:20,https://api.github.com/repos/nylas/sync-engine/git/commits/c96e9fc6eb7f3f73f324858d78992dcb07c2ad66,c96e9fc6eb7f3f73f324858d78992dcb07c2ad66,"Make Accounts unique

Summary: This is the sister diff to D1106. Mostly, I added a unique constraint to the `_canonicalized_address` field of the `Account` table. Please note that to do this I had to redefine the field in the `Account` table, otherwise SQLAlchemy crashed (it seems to be the same bug I had when I was working on D972 --- SA doesn't like much extending `__table_args__` in a child class).

Test Plan: Authed and synced accounts. Ran migration.

Reviewers: kav-ya, emfree

Reviewed By: emfree

Projects: #sync-engine

Differential Revision: https://review.inboxapp.com/D1114"
filipposironi,2015-02-04 09:23:03,https://api.github.com/repos/nylas/sync-engine/git/commits/2381b071a2cd2d75a4f94026de9a3851c62f43e5,2381b071a2cd2d75a4f94026de9a3851c62f43e5,"Add passive_deletes=True to parts backrefs.

Summary:
The parts backrefs in the Message and Block classes were missing the
passive_deletes=True option.

Fix T765.

Test Plan: N/A.

Reviewers: emfree

Reviewed By: emfree

Subscribers: spang

Maniphest Tasks: T765

Differential Revision: https://review.inboxapp.com/D1120"
emfree,2015-02-04 03:22:27,https://api.github.com/repos/nylas/sync-engine/git/commits/4c1b814b9758bdafe30720a15f4b93ee9f8a93d7,4c1b814b9758bdafe30720a15f4b93ee9f8a93d7,"Update transaction indices for delta sync performance.

Summary:
Add index on (`namespace_id`, `created_at`) to make generating a sync cursor
from a timestamp fast.

Fixes T776.

Test Plan: Run migration against replica.

Reviewers: spang

Reviewed By: spang

Maniphest Tasks: T776

Differential Revision: https://review.inboxapp.com/D1122"
emfree,2015-02-03 01:06:24,https://api.github.com/repos/nylas/sync-engine/git/commits/fe5c43121bf3c01ae1651cf8a4d2ce8928b21e43,fe5c43121bf3c01ae1651cf8a4d2ce8928b21e43,"Properly update thread attributes when a draft is updated.

Summary:
* If the thread only contains the one draft, update its
  subject/recentdate/subjectdate when the draft is updated.
* Replace `original_draft` by `draft` in the `update_draft()` function for
  simplicity, since only one object is being operated on.
* Ensure that the scheduled `delete_draft` action uses the prior inbox_uid
  value. Fixes a regression introduced in commit e9be738.

Fixes T775.

Test Plan: Unit tests updated.

Reviewers: kav-ya

Reviewed By: kav-ya

Maniphest Tasks: T775

Differential Revision: https://review.inboxapp.com/D1118"
filipposironi,2015-02-03 11:13:37,https://api.github.com/repos/nylas/sync-engine/git/commits/e1dfab3de840c172a2955b4aa92907d285c6ccb1,e1dfab3de840c172a2955b4aa92907d285c6ccb1,Sub uid (of type ImapUid - a table entry) with remote_uid (of type int).
filipposironi,2015-02-03 10:27:24,https://api.github.com/repos/nylas/sync-engine/git/commits/5d30f194ba059647a48e7365f906f685c71d9bb7,5d30f194ba059647a48e7365f906f685c71d9bb7,"Sub folder_id with folder_name.

download_and_commit_uids() takes the folder_name and not the folder_id."
filipposironi,2015-02-03 10:00:48,https://api.github.com/repos/nylas/sync-engine/git/commits/e7dfbfa783db463e83bf88691dd1e49c550c63f2,e7dfbfa783db463e83bf88691dd1e49c550c63f2,Publish heartbeat status on UIDVALIDITY change.
emfree,2015-02-02 21:52:26,https://api.github.com/repos/nylas/sync-engine/git/commits/f55ce1d08915c0f07a44cb111ca11a1375961b15,f55ce1d08915c0f07a44cb111ca11a1375961b15,"Update delta sync cursor generation for performance.

Summary:
Filtering by `created_at` but ordering by `id` causes MySQL to perform an
expensive filesort. So simply order by `created_at` instead. This still
achieves the semantic guarantees we want for the cursor (you give us a
timestamp, we give you the public id of the last transaction committed before
that timestamp).

Fixes T776.

Test Plan: Check that query is fast now; unit tests.

Reviewers: kav-ya

Reviewed By: kav-ya

Maniphest Tasks: T776

Differential Revision: https://review.inboxapp.com/D1115"
filipposironi,2015-02-02 19:47:31,https://api.github.com/repos/nylas/sync-engine/git/commits/1ee400533366aa3b2c5a9b0f3dca1c3b0f2085b9,1ee400533366aa3b2c5a9b0f3dca1c3b0f2085b9,"Handle UIDVALIDITY changes for standard IMAP.

Summary:
This revisions implements handling of UIDVALIDITY changes for standard IMAP.

Test Plan:
Sync an IMAP account, stop syncing, update the cached UIDVALIDITY for
one of the folder, restart syncing, and let the magic begin!

Reviewers: emfree

Reviewed By: emfree

Subscribers: spang

Projects: #sync-engine

Differential Revision: https://review.inboxapp.com/D1112"
emfree,2015-01-30 03:57:52,https://api.github.com/repos/nylas/sync-engine/git/commits/cf81b9e96b0937aef75deb48f7fb79de43b18082,cf81b9e96b0937aef75deb48f7fb79de43b18082,"Don't save a Message object if sending fails.

Summary:
If you try to send a new message and it fails, we don't want to end up with an
orphaned message/draft object.

Test Plan: Regression test added.

Reviewers: kav-ya

Reviewed By: kav-ya

Differential Revision: https://review.inboxapp.com/D1109"
filipposironi,2015-01-30 08:41:23,https://api.github.com/repos/nylas/sync-engine/git/commits/2a076d80d8c5e77c8c68f72ac7430bc0faf83a6c,2a076d80d8c5e77c8c68f72ac7430bc0faf83a6c,Add note on EAS case insensitive folder names.
filipposironi,2015-01-29 14:56:09,https://api.github.com/repos/nylas/sync-engine/git/commits/f1752afccd75f1214d3956a9a424becc79ca0915,f1752afccd75f1214d3956a9a424becc79ca0915,Add uritemplate 0.6.
filipposironi,2015-01-29 14:46:34,https://api.github.com/repos/nylas/sync-engine/git/commits/1bccee50fbb8e47996241483fe425d26a5e44387,1bccee50fbb8e47996241483fe425d26a5e44387,"Bump google-api-python-client and oauth2client.

Summary:
Google API Python Client used to bring oauth2client with itself. This
isn't the case anymore and with our previous requirements (versione 1.2
and 1.3, respectively) we had import errors.

Test Plan:
Deploy on dev or staging and make sure we don't run into troubles as
we previously did.

Reviewers: khamidou

Reviewed By: khamidou

Subscribers: spang, emfree

Differential Revision: https://review.inboxapp.com/D1105"
filipposironi,2015-01-29 09:52:53,https://api.github.com/repos/nylas/sync-engine/git/commits/01efc73ba3acbc5fe705d40eb716a685cf9068d6,01efc73ba3acbc5fe705d40eb716a685cf9068d6,"Make killing the poll_for_changes greenlet asynchronous.

Summary:
This revision makes killing the poll_for_changes greenlet an asynchronous
operation, which doesn't block the main greenlet that is syncing a folder and
thus the monitor greenlet, which is meant to start additional greenlet as soon
as the main greenlet joined with the poll_for_changes greenlet and transitioned
from initial to poll.

Test Plan:
This isn't disruptive, deploy on staging and prod since I was never able to
reproduce on dev.

Reviewers: emfree

Reviewed By: emfree

Subscribers: spang

Differential Revision: https://review.inboxapp.com/D1084"
emfree,2015-01-27 17:47:49,https://api.github.com/repos/nylas/sync-engine/git/commits/82d78951d645362c4bc4895fdbd0d31c9fdf74c6,82d78951d645362c4bc4895fdbd0d31c9fdf74c6,Pin right versions of pynacl and oauth2client.
emfree,2015-01-27 17:23:03,https://api.github.com/repos/nylas/sync-engine/git/commits/0ded79c7517b304588d29907c179c7377f1d546b,0ded79c7517b304588d29907c179c7377f1d546b,"Add OAuthAccount.verify method back.

Used in redwood."
jennielees,2015-01-27 07:01:23,https://api.github.com/repos/nylas/sync-engine/git/commits/bd83700294c1e8be734992b9ae7e6e1afc402439,bd83700294c1e8be734992b9ae7e6e1afc402439,"update api docs and README to refer to Nilas instead of Inbox

Summary: See above. There are still many `inbox` references but this at least makes it consistent.

Test Plan: read the words

Reviewers: spang

Reviewed By: spang

Subscribers: bengotow, mg

Differential Revision: https://review.inboxapp.com/D1090"
emfree,2015-01-27 04:30:43,https://api.github.com/repos/nylas/sync-engine/git/commits/7df3d4bfc0433e945be951fb971356572966b01a,7df3d4bfc0433e945be951fb971356572966b01a,"Clarify/clean up API documentation.

Summary:
A quick first pass at cleaning up confusing or outdated parts of the API
documentation:

* Put ""threads"" section before ""tags"" section for more logical flow.
* Remove stray references to ""sending"" state that are obsoleted by synchronous
  sending.
* Remove misleading admonition to not include quoted text in reply messages.
* Fix miscellaneous typos.

Test Plan: Read docs.

Reviewers: spang

Reviewed By: spang

Differential Revision: https://review.inboxapp.com/D1083"
emfree,2015-01-27 04:26:48,https://api.github.com/repos/nylas/sync-engine/git/commits/fb243565517e0c9211a2e023765e330846604eef,fb243565517e0c9211a2e023765e330846604eef,"Clean up files API endpoint.

Summary:
* Remove `file_id` query parameter. Confusing to have both
  `/files?file_id=<id>` and `/files/<id>`.

* Don't suppress inline attachments from results.

* Remove `is_attachment` query parameter. Previously `/files`,
  `/files?is_attachment=true` and `/files?is_attachment=false` could return
  three different result sets, confusingly.

Fixes T693.

Test Plan: Unit tests.

Reviewers: spang

Reviewed By: spang

Maniphest Tasks: T693

Differential Revision: https://review.inboxapp.com/D1082"
emfree,2015-01-27 04:26:08,https://api.github.com/repos/nylas/sync-engine/git/commits/3a0284b964718e3cfe070818876a38cd8a558609,3a0284b964718e3cfe070818876a38cd8a558609,"Improve query construction in /messages API.

Summary:
The /messages query with no filters was proving to be really slow on large
mailboxes. Adding the right index and using a slightly better query strategy
makes a big difference for some requests.

Test Plan: Test example queries against prod read replica; run unit tests.

Reviewers: kav-ya

Reviewed By: kav-ya

Differential Revision: https://review.inboxapp.com/D1081"
kav-ya,2015-01-27 02:57:46,https://api.github.com/repos/nylas/sync-engine/git/commits/fe9e4d0b25b79b4be723a19e3a9d5bd041f80808,fe9e4d0b25b79b4be723a19e3a9d5bd041f80808,"EAS heartbeat interval is set according to inbox-eas/inbox/mailsync/backends/eas/ping.THRESHOLD

Summary: This is the max interval we'd go without syncing a folder.

Test Plan: TBT on staging.

Reviewers: emfree

Reviewed By: emfree

Differential Revision: https://review.inboxapp.com/D1092"
jennielees,2015-01-26 23:49:18,https://api.github.com/repos/nylas/sync-engine/git/commits/18513a244c3c047c9f3fd55ff336d2ef1cb5b2b3,18513a244c3c047c9f3fd55ff336d2ef1cb5b2b3,Minor doc updates to remove out of date info
filipposironi,2015-01-26 11:04:48,https://api.github.com/repos/nylas/sync-engine/git/commits/1ec4ffcc1e279c490129d674fda2d78c991b6404,1ec4ffcc1e279c490129d674fda2d78c991b6404,Prompt email address in bin/delete-account.
filipposironi,2015-01-26 10:51:05,https://api.github.com/repos/nylas/sync-engine/git/commits/2073fcf5e1821f7c806f4ad9b689802d81260b9b,2073fcf5e1821f7c806f4ad9b689802d81260b9b,Remove lower() when dealing with folder names.
filipposironi,2015-01-26 10:20:57,https://api.github.com/repos/nylas/sync-engine/git/commits/0643c472a6df175bbdf9504dd7a3caaa72ed0c58,0643c472a6df175bbdf9504dd7a3caaa72ed0c58,Update test db.
filipposironi,2015-01-26 10:20:45,https://api.github.com/repos/nylas/sync-engine/git/commits/e71326e7e285f23b76d9b3022db9b708c9f926c0,e71326e7e285f23b76d9b3022db9b708c9f926c0,Fix migration 129.
filipposironi,2015-01-26 09:24:27,https://api.github.com/repos/nylas/sync-engine/git/commits/5437d2e04c99598ee5447465a7f2a67e988e19db,5437d2e04c99598ee5447465a7f2a67e988e19db,"Support case sensitive folders.

Summary:
This revision introduces support for case sensitive folders like INBOX.Test and
INBOX.test.

Fix T744.

Test Plan: Sync the first fastmail.fm test account.

Reviewers: emfree

Reviewed By: emfree

Subscribers: spang

Maniphest Tasks: T744

Differential Revision: https://review.inboxapp.com/D1056"
emfree,2015-01-25 00:34:38,https://api.github.com/repos/nylas/sync-engine/git/commits/e9be738262afadd4bd723be16dd1c3b4c46da041,e9be738262afadd4bd723be16dd1c3b4c46da041,"Implement synchronous sending.

Summary:
Fixes T730. Instead of scheduling a sending action, the API now attempts to
actually send the message before returning. An appropriate status code is
returned if sending fails.

Various cleanups are included as a result of this work:
 * Consolidate `BaseSMTPClient` and `SMTPClient` classes. There was no reason
   to have a separate abstract base class.

 * Consolidate input validation in draft update/delete/send endpoints
   into a single `get_draft()` function.

 * Consolidate `send_new/send_reply` and `create_email/create_reply` methods
   into just `send` and `create_email`.

 * Simplify the construction of a MIME message from a draft object.
   `inbox.sendmail.message.create_email` now just gives you a string
   representing an RFC2821-compliant, ready-for-action MIME message.

 * Update a thread's `last_message_timestamp` attribute after a draft on it is
   sent (Fixes T604).

Test Plan: Substantial unit tests added.

Reviewers: kav-ya

Reviewed By: kav-ya

Maniphest Tasks: T604, T730

Differential Revision: https://review.inboxapp.com/D1076"
emfree,2015-01-25 00:33:59,https://api.github.com/repos/nylas/sync-engine/git/commits/4749cb3794aca9c21f0e2d783a60d30f1231c849,4749cb3794aca9c21f0e2d783a60d30f1231c849,"Simplify OAuth error handling; better manage OAuth access tokens.

Summary:
There are a few reasons to do this:
* The TokenManager class can now easily be replaced with a stub for testing. It
  was proving difficult to write tests for the SMTP code previously.
* Fixes the race condition described in T487, in which concurrent token
  renewals could cause a KeyError to be raised. (Note that concurrent calls to
  token_manager.get_token() may still result in two tokens being fetched, and
  only one of them being cached. But that isn't really a problem.)
* Having the exception hierarchy
```
    class ValidationError(AuthError):
      # ...

    class OAuthError(ValidationError):
      # ...

    class OAuthValidationError(OAuthError):
      # ...
```
was a little whacky. Plus we defined classes OAuthValidationError and
OAuthInvalidGrantError that subclassed OAuthError, but only ever caught the
base class OAuthError. Kinda pointless.

Also remove the unused inbox-cred-checker script (mostly so we can get rid of
OAuth code that only it uses).

Fixes T487.

Test Plan: Test manually; run on staging.

Reviewers: kav-ya

Reviewed By: kav-ya

Maniphest Tasks: T487

Differential Revision: https://review.inboxapp.com/D1075"
emfree,2015-01-24 01:22:43,https://api.github.com/repos/nylas/sync-engine/git/commits/b398c08a4b97ebc3eca4715a8de6ba5960dc6619,b398c08a4b97ebc3eca4715a8de6ba5960dc6619,Simplify test.
filipposironi,2015-01-23 17:44:15,https://api.github.com/repos/nylas/sync-engine/git/commits/8dc1f1e3640eaf30ada9e44d5a4534453f74eafb,8dc1f1e3640eaf30ada9e44d5a4534453f74eafb,Fix pip syntax.
filipposironi,2015-01-23 17:32:22,https://api.github.com/repos/nylas/sync-engine/git/commits/d008fbd8160a3d73d6a5af82c894262549e9b926,d008fbd8160a3d73d6a5af82c894262549e9b926,Add mock 1.0.1 among requirements.
emfree,2015-01-22 19:55:39,https://api.github.com/repos/nylas/sync-engine/git/commits/807b872906d8a8687bb544a3e5df1f364443edc7,807b872906d8a8687bb544a3e5df1f364443edc7,"Don't save block hash in S3 metadata.

Summary:
Rarely, for unclear reasons, when we save a block to S3 the data_sha256
metadata doesn't get set. This breaks sync if you try to save the same
block again later, because the saved metadata doesn't match the hash.

In any case, setting this metadata is patently pointless, because the S3 object
key is already the hash. So just remove this code.

Fixes T758.

Test Plan: Stare at code.

Reviewers: kav-ya

Reviewed By: kav-ya

Maniphest Tasks: T758

Differential Revision: https://review.inboxapp.com/D1073"
khamidou,2015-01-22 10:08:52,https://api.github.com/repos/nylas/sync-engine/git/commits/b15139bf47483c9cd5a10acde0ba2944491b73d3,b15139bf47483c9cd5a10acde0ba2944491b73d3,"Allow deleting locally-created events

Summary:
This is another fun bug: the original event creation code (written by Charles IIRC) created events with the 'inbox' provider. It made sense when we didn't have event syncback. However, Kavya's EAS events refactor made some SQL queries stricter, for example by filtering on the provider type. This led to a bug where we couldn't delete an event we had created because we were looking for an 'eas' event and it was stored in the db as an 'inbox' event.

I fixed this by replacing 'inbox' with the name of the provider.

Test Plan: Manual tests.

Reviewers: kav-ya, siro, emfree

Reviewed By: siro, emfree

Projects: #eas, #calendars

Differential Revision: https://review.inboxapp.com/D1041"
emfree,2015-01-22 05:50:19,https://api.github.com/repos/nylas/sync-engine/git/commits/4a1a18656ceb8f51932fcb646210d0d28736493a,4a1a18656ceb8f51932fcb646210d0d28736493a,"Fix UnicodeEncodeError on invalid non-ascii addresses.

Fixes T760."
emfree,2015-01-21 22:18:49,https://api.github.com/repos/nylas/sync-engine/git/commits/82ef62c55b9bb5ebc45e8c9506c0c1079e70704c,82ef62c55b9bb5ebc45e8c9506c0c1079e70704c,"s/NOT DELETED/UNDELETED/ in IMAP search for compatibility.

Summary:
Some backends don't support 'NOT DELETED' as a search criterion. UNDELETED
seems to be more widely accepted.

Fixes T739.

Test Plan:
Check that SEARCH UNDELETED works with the problematic provider as
well as with Gmail and other supported IMAP backends.

Reviewers: spang

Reviewed By: spang

Maniphest Tasks: T739

Differential Revision: https://review.inboxapp.com/D1071"
jennielees,2015-01-22 00:23:28,https://api.github.com/repos/nylas/sync-engine/git/commits/ffe4d9c5ad67ce704feeb0f8c53c03fae3a754ab,ffe4d9c5ad67ce704feeb0f8c53c03fae3a754ab,Less opaqueness around heartbeat fake folders
filipposironi,2015-01-21 16:15:25,https://api.github.com/repos/nylas/sync-engine/git/commits/04fd605d081264268f8e13172224051a9b6f9118,04fd605d081264268f8e13172224051a9b6f9118,Improve heartbeat status cleanup after stop.
filipposironi,2015-01-21 16:12:14,https://api.github.com/repos/nylas/sync-engine/git/commits/a976d6d806cb11ca1d1ca029af589f1e88fec70a,a976d6d806cb11ca1d1ca029af589f1e88fec70a,Fix the bin/clear-kv script to clear the key-value store.
filipposironi,2015-01-21 08:59:47,https://api.github.com/repos/nylas/sync-engine/git/commits/ba6db4205e99c13d0cb113a72f402ba2906e1ef7,ba6db4205e99c13d0cb113a72f402ba2906e1ef7,"Increase alive thresholds.

This commit increases the alive thresholds to give the mailsync
processes a little more time to assign the CPU to each greenlet."
jennielees,2015-01-21 02:05:09,https://api.github.com/repos/nylas/sync-engine/git/commits/db3eb0197d7ada69efda2c5efd5c07615a85d1bf,db3eb0197d7ada69efda2c5efd5c07615a85d1bf,Store and log connection errors by account
jennielees,2015-01-21 00:05:51,https://api.github.com/repos/nylas/sync-engine/git/commits/3fe2e69b9274dc7cf692d6c13a40c3f4cce0f7e4,3fe2e69b9274dc7cf692d6c13a40c3f4cce0f7e4,"Check IMAP is fully enabled by trying to list folders.

Summary: Turns out this is somewhat specific to Godaddy accounts, in that unless a user has the most expensive tier of account, their account will allow IMAP login but then fail at the listing folders stage. So this adds a check for that.

Test Plan: added new test py.test tests/imap/test_full_imap_enabled.py

Reviewers: emfree

Reviewed By: emfree

Subscribers: spang

Differential Revision: https://review.inboxapp.com/D1062"
filipposironi,2015-01-20 18:08:45,https://api.github.com/repos/nylas/sync-engine/git/commits/47fcc032bd79930b6bfde646e6d504aab035720d,47fcc032bd79930b6bfde646e6d504aab035720d,"Support account (and namespace) deletion.

Summary:
This revision introduces account (and namespace) deletion support. It makes a
few changes to our models (mostly on cascading operations) either at the DBMS-
or the ORM-level.

NOTE: this revision also applies migration version 127 (it was missing).

Test Plan: Test the migration on a snapshot of the prod db to get insights about timing.

Reviewers: emfree

Reviewed By: emfree

Subscribers: spang

Differential Revision: https://review.inboxapp.com/D1025"
jennielees,2015-01-20 17:03:25,https://api.github.com/repos/nylas/sync-engine/git/commits/ba418c8be774c094ef1852beb47126bcfef4e0cb,ba418c8be774c094ef1852beb47126bcfef4e0cb,"Unwrap heartbeat into helper classes

Summary: Added helper classes to `heartbeat/status.py` to make it easier to consistently interpret the heartbeat result (for a single account). The goal is to make code which inspects the heartbeat status a lot easier to read.

Test Plan: Tested manually against heartbeat output. To test, simply pipe the output of `get_heartbeat_status(account_id=foo)` into `HeartbeatAccountStatus()`.

Reviewers: siro

Reviewed By: siro

Differential Revision: https://review.inboxapp.com/D1051"
filipposironi,2015-01-20 14:35:28,https://api.github.com/repos/nylas/sync-engine/git/commits/cf85991c526ff0e06842ddad96455061fdef1610,cf85991c526ff0e06842ddad96455061fdef1610,"Improve heartbeat status reporting.

Summary:
This revision improves heartbeat status reporting. If there are new dead
accounts, the script reports them and exits with status 2 (error, both Slack
and PD). If there are dead accounts but no new dead accounts, the script
reports them and exits with status 1 (warning, only Slack).

Test Plan: Ship it!

Reviewers: khamidou

Reviewed By: khamidou

Subscribers: spang

Differential Revision: https://review.inboxapp.com/D1042"
spang,2015-01-19 20:09:47,https://api.github.com/repos/nylas/sync-engine/git/commits/2d81f4d81d5519dda375a0d7b0a6fe16c4f9519b,2d81f4d81d5519dda375a0d7b0a6fe16c4f9519b,"Remove deprecated monocle status app.

Summary:
Since this code is out-of-date and questionably useful at this point,
it makes sense to remove it entirely and reduce confusion for new folks
getting into the code repository. It will live on in `git log`. :)

Test Plan: n/a

Reviewers: kav-ya

Reviewed By: kav-ya

Subscribers: emfree

Differential Revision: https://review.inboxapp.com/D1040"
emfree,2015-01-19 20:06:34,https://api.github.com/repos/nylas/sync-engine/git/commits/4b463b0792977f4849782197746e516e347418aa,4b463b0792977f4849782197746e516e347418aa,"Simplify API error handling.

Summary:
This is an outgrowth of sanely implementing synchronous sending. We can remove
a bunch of boilerplate by making better use of Flask error handlers. Functional
changes are minimal, although in a few cases 400 errors are now returned
instead of 404s where appropriate.

Test Plan: Unit tests.

Reviewers: kav-ya

Reviewed By: kav-ya

Differential Revision: https://review.inboxapp.com/D1033"
spang,2015-01-18 20:41:13,https://api.github.com/repos/nylas/sync-engine/git/commits/5c637edde069e7f3f23e5bed9b5df6d16c156cb7,5c637edde069e7f3f23e5bed9b5df6d16c156cb7,Fix documentation for getting the messages in a thread.
kav-ya,2015-01-16 20:19:10,https://api.github.com/repos/nylas/sync-engine/git/commits/04591d82eed1ad1c80838de87fc66fc2dc14bdf1,04591d82eed1ad1c80838de87fc66fc2dc14bdf1,Import Secret model too.
filipposironi,2015-01-15 15:38:32,https://api.github.com/repos/nylas/sync-engine/git/commits/3c1b6b61f3e1f935ff7e330c86e38f2830245bce,3c1b6b61f3e1f935ff7e330c86e38f2830245bce,"Fix exit status issues for various scripts.

Summary:
This revision fixes various exit status issues for variou scripts. In addition,
it updates the bin/clear-kv script, which now flushes both the kv-stores we're
using.

Fix T734.

Test Plan: Pass.

Reviewers: khamidou

Reviewed By: khamidou

Maniphest Tasks: T734

Differential Revision: https://review.inboxapp.com/D1023"
emfree,2015-01-15 00:20:57,https://api.github.com/repos/nylas/sync-engine/git/commits/b5bad3ac653d2ed5c45fa7933d3a71b85cb2e20e,b5bad3ac653d2ed5c45fa7933d3a71b85cb2e20e,"Remove flaky test.

Summary:
This test succeeds locally but fails on jenkins. It tests asynchronous sending,
which I am removing in very short order. So it's reasonable and expedient to
simply remove this test.

Test Plan: Run jenkins on branch.

Reviewers: spang

Reviewed By: spang

Differential Revision: https://review.inboxapp.com/D1021"
spang,2015-01-14 17:53:06,https://api.github.com/repos/nylas/sync-engine/git/commits/82330e5b01f9696396481127cbcb927afe110e34,82330e5b01f9696396481127cbcb927afe110e34,Bump flanker dep to fix unicode regression.
filipposironi,2015-01-14 10:17:55,https://api.github.com/repos/nylas/sync-engine/git/commits/e143d862c2a5c2f9f923ac8d3f0104b557761599,e143d862c2a5c2f9f923ac8d3f0104b557761599,"Remove CPU affinity.

Summary:
This revision removes CPU affinity support from the code. We are going to use
taskset directly.

Test Plan: None.

Reviewers: systemizer, emfree

Reviewed By: emfree

Differential Revision: https://review.inboxapp.com/D1007"
emfree,2015-01-14 05:03:56,https://api.github.com/repos/nylas/sync-engine/git/commits/9eb096be12b4ee81e344889a4e15ab04676f32ae,9eb096be12b4ee81e344889a4e15ab04676f32ae,Fix typos in calendar event docs.
kav-ya,2015-01-14 00:37:16,https://api.github.com/repos/nylas/sync-engine/git/commits/b34dab8d15dcfd868f7de2e11fcb63068f771c2e,b34dab8d15dcfd868f7de2e11fcb63068f771c2e,Raise explicit SendError exceptions.
kav-ya,2015-01-10 01:03:47,https://api.github.com/repos/nylas/sync-engine/git/commits/353edcdcfae15f06b998a4ad1481b3ad99e514bd,353edcdcfae15f06b998a4ad1481b3ad99e514bd,Remove easeventuid migration.
emfree,2015-01-13 19:20:30,https://api.github.com/repos/nylas/sync-engine/git/commits/785fef925877742fd45588c2607d3994d31667af,785fef925877742fd45588c2607d3994d31667af,"Depend on upstream flanker despite prior rollback.

Can't roll back to our fork apparently."
emfree,2015-01-13 19:04:53,https://api.github.com/repos/nylas/sync-engine/git/commits/df95c4f81b65caeab0d30e580353173e7df2f72b,df95c4f81b65caeab0d30e580353173e7df2f72b,"Revert ""Work around flanker bug and revert back to flanker latest release.""

This reverts commit 4b399e280b36792221fba23263f4c4bcd6e8eebb.

Reason for rollback: breaks sending."
filipposironi,2015-01-13 18:20:30,https://api.github.com/repos/nylas/sync-engine/git/commits/3ee93d4d1a14f676290f1bd6b75958b640cab2e2,3ee93d4d1a14f676290f1bd6b75958b640cab2e2,Disable (temporarily) CPU affinity.
khamidou,2015-01-13 10:24:37,https://api.github.com/repos/nylas/sync-engine/git/commits/adf1e02d57e35594b1a984da0b098b7a74cae045,adf1e02d57e35594b1a984da0b098b7a74cae045,Fix assert to handle unicode strings too
filipposironi,2015-01-12 21:41:36,https://api.github.com/repos/nylas/sync-engine/git/commits/5392e405330fb307371a308a8e816687c897cbb9,5392e405330fb307371a308a8e816687c897cbb9,Added missing parameter to get_redis_client.
filipposironi,2015-01-12 21:13:25,https://api.github.com/repos/nylas/sync-engine/git/commits/48a3c124d58c50cc189d243a2c1180d6f09e3542,48a3c124d58c50cc189d243a2c1180d6f09e3542,"Merge delete_device and clear_heartbeat_status.

NOTE: also remove an old SyncStatus."
filipposironi,2015-01-12 20:56:57,https://api.github.com/repos/nylas/sync-engine/git/commits/32b315b0fbb2b87615929a76989dc9dee0cb82e3,32b315b0fbb2b87615929a76989dc9dee0cb82e3,"Clear heartbeat status on account stop.

Summary:
This revision supports clearing the heartbeat status on account stop, thus
avoiding misleading statistics on the number of alive/dead accounts.

Test Plan:
Sync an account, stop sync from redwood, make sure the account is reported as
neither alive nor dead.

Reviewers: emfree, kav-ya

Reviewed By: kav-ya

Subscribers: spang

Differential Revision: https://review.inboxapp.com/D987"
filipposironi,2015-01-12 20:42:22,https://api.github.com/repos/nylas/sync-engine/git/commits/695b7fac44eb576d9901cade5a5bb8c429d45417,695b7fac44eb576d9901cade5a5bb8c429d45417,"Refactor heartbeat status related code.

Summary:
This revision moves bin/inbox-syncstatus to bin/show-heartbeat-status and
basically changes most of the *sync_status* references to *heartbeat_status*.
In addition, the get_heartbeat_status (once get_sync_status) loses some useless
parameters.
NOTE: finally, since we're going to use more Redis databases in the future, it
makes sense to fix which database we use for a certain functionality, without
making it configurable.

This revision finishes the refactor by renaming sync_status (i.e., handlers to
access Redis) objects into heartbeat_status and the SyncStatus and
SyncStatusKey classes into HeartbeatStatus and HeartbeatStatusKey classes,
respectively.

This revision renames inbox/status/sync.py into inbox/status/heartbeat.py.

This revision completely overhauls the inbox.status package, which is now
inbox.heartbeat. It splits the inbox/status/sync.py blob to improve
maintenance.

This revision adds a script to generate the heartbeat report, which is stored
in the REPORT_DATABASE in Redis (as of now). This script is inteded to be run
periodically by Sensu it also outputs the result of its analysis (the dying
sync engines - greenlets) and return a an appropriate value.
NOTE: the script returns 0 - everything went well - if there were no additional
dead sync engines while it returns 2 if there were additional dead sync
engines.

Test Plan:
Run the unit test to make sure the refactor is non-disruptive and sync both a
classic and an EAS account while running Redwood to make sure monitoring is
good too.

In the mean time, run the script to generate the heartbeat report, stop the
sync, wait a few minutes (let's say 5 minutes) and re-run the script to
generate the heartbeat report, which should signal dead sync engines.

Reviewers: emfree, kav-ya

Reviewed By: kav-ya

Differential Revision: https://review.inboxapp.com/D977"
jennielees,2015-01-12 17:35:36,https://api.github.com/repos/nylas/sync-engine/git/commits/fa4c7717d2b5a7324bec7b0359a3f16250b29c1c,fa4c7717d2b5a7324bec7b0359a3f16250b29c1c,"Deal with missing refresh token edge cases

Summary:
Raise an error if we want a refresh token but didn't get one, also handle missing secrets properly (T668).

There is a corresponding frontend change which handles these situations appropriately during auth flow.

Test Plan: Ensure all existing auth tests pass. New tests in frontend, also tested manually.

Reviewers: emfree

Differential Revision: https://review.inboxapp.com/D894"
spang,2015-01-10 20:52:56,https://api.github.com/repos/nylas/sync-engine/git/commits/e8632bb7de08c71abbe4ba345fcc87307e7ff457,e8632bb7de08c71abbe4ba345fcc87307e7ff457,"Depend on an explicit client SDK version.

We update this infrequently, so it shouldn't be too hard to keep this in
sync, and it makes packaging easier."
spang,2015-01-10 19:40:02,https://api.github.com/repos/nylas/sync-engine/git/commits/ae3603c8777cf028855aa3f12a408463a3c91b93,ae3603c8777cf028855aa3f12a408463a3c91b93,Remove talon dependency. We're not using it.
spang,2015-01-10 19:32:59,https://api.github.com/repos/nylas/sync-engine/git/commits/4b399e280b36792221fba23263f4c4bcd6e8eebb,4b399e280b36792221fba23263f4c4bcd6e8eebb,Work around flanker bug and revert back to flanker latest release.
kav-ya,2015-01-08 02:41:20,https://api.github.com/repos/nylas/sync-engine/git/commits/0e3dbe6c4c7efade7201bb6d129598d843e7c388,0e3dbe6c4c7efade7201bb6d129598d843e7c388,"Basic search utility to verify a namespace is correctly indexed into Elasticsearch +
script to verify the search backfiller script correctly indexed the desired
namespaces.

Summary:
Elasticsearch is queried for the documents whose ids == the public_ids of
the last thread, message that fits the `namespace_id`, `created_before`
criteria specified.

Test Plan: Tested on prod, with a namespace_id that was ""backfilled"".

Reviewers: spang

Reviewed By: spang

Differential Revision: https://review.inboxapp.com/D976"
filipposironi,2015-01-08 18:31:14,https://api.github.com/repos/nylas/sync-engine/git/commits/12778b60ccb8375ad83e323054724e56dcad9ccc,12778b60ccb8375ad83e323054724e56dcad9ccc,"Remove the @inboxapp.com domain from the provider resolution test.

Summary: This revision removes the @inboxapp.com domain from provider resolution test.

Test Plan: Run the unit test.

Reviewers: spang, emfree

Reviewed By: emfree

Differential Revision: https://review.inboxapp.com/D978"
filipposironi,2015-01-08 13:18:15,https://api.github.com/repos/nylas/sync-engine/git/commits/5ef5d6bf2744cdd0faeebee3549432baa0df2d55,5ef5d6bf2744cdd0faeebee3549432baa0df2d55,"Add a script to clear an account's heartbeat status.

Summary:
This revision adds a script to clear an account's heartbeat status. It takes an
account ID (as in our DB) as an input and may optionally take an hostname, a
port, and a database number in case you don't want to use the local
configuration.

Test Plan:
Sync an account and try to remove it's heartbeat status. Double-check that the
account's heartbeat status is removed by executing bin/inbox-syncstatus.

Reviewers: emfree, kav-ya

Reviewed By: kav-ya

Differential Revision: https://review.inboxapp.com/D971"
emfree,2015-01-07 23:32:02,https://api.github.com/repos/nylas/sync-engine/git/commits/d05d9c919b1865f3bee6fbbe899ac59c02790574,d05d9c919b1865f3bee6fbbe899ac59c02790574,"Explicitly specify subject index length.

Summary:
Only the first 191 characters of the `Message.subject` column and
`Thread.subject` columns can be indexed. We need to explicitly specify the
index length for `bin/create-db` to work with MySQL 5.6.

Note that this doesn't actually change the schema. (Running `bin/create-db` against a MySQL 5.5 database previously would give you the same indices of length 191. As would starting with an old database and applying migration 105.)

Test Plan:
Drop and recreate database, compare `SHOW CREATE TABLE message`,
`SHOW CREATE TABLE thread` before and after.

Reviewers: spang, kav-ya

Reviewed By: kav-ya

Differential Revision: https://review.inboxapp.com/D974"
emfree,2015-01-07 02:31:45,https://api.github.com/repos/nylas/sync-engine/git/commits/3593bb5ab8e7fc00ccc571929e5439b6a98eb921,3593bb5ab8e7fc00ccc571929e5439b6a98eb921,"Deduplicate repeated address header entries.

Summary:
Messages can include duplicated headers. In some cases clients are so broken
that a message has like 2200 copies of the same From: header, which breaks
sync because the from_addr field is too long :(

Test Plan: Regression test added.

Reviewers: spang

Reviewed By: spang

Differential Revision: https://review.inboxapp.com/D969"
filipposironi,2015-01-07 08:33:56,https://api.github.com/repos/nylas/sync-engine/git/commits/2fb15f942a6130ea64610806bc2402ae136b1d64,2fb15f942a6130ea64610806bc2402ae136b1d64,"Improve logging for Contacts and Events sync.

Summary:
This revision improves logging for Contacts and Events sync in case a
`ConnectionError` occurs. Up to now, we're relying on the heartbeat status
which correctly signals the greenlet is in the `poll error` state. However,
there is nothing in our logs that says what's going on.

NOTE: this revison also removes the `except PermissionError` turning it into an
uncaught error since we now start contacts and events sync if and only if we
have the permissions to access them.

Fix 703.

Test Plan:
Sync a Gmail account with permissions to access mails, contacts, and events.
Inhibit access to either contacts and events (e.g., change `/etc/hosts`) and
make sure `ConnectionError`s get logged.

Reviewers: khamidou, emfree

Reviewed By: emfree

Differential Revision: https://review.inboxapp.com/D959"
emfree,2015-01-06 22:13:32,https://api.github.com/repos/nylas/sync-engine/git/commits/037774268b88c27967f7390eefb991542fd185ee,037774268b88c27967f7390eefb991542fd185ee,"Refine Google calendar event parsing.

Summary:
Fixes some unnecessary MalformedEventErrors found in the wild. Also fixes
little bug in which read_only would always be set to False.

Test Plan: Run sync.

Reviewers: khamidou

Reviewed By: khamidou

Differential Revision: https://review.inboxapp.com/D921"
filipposironi,2015-01-06 08:17:15,https://api.github.com/repos/nylas/sync-engine/git/commits/c617a96f679583fe0be2e70bdd7dbdd7a580ad8a,c617a96f679583fe0be2e70bdd7dbdd7a580ad8a,"Remove offending labels.

Summary:
This commit adds a script to remove offending labels (e.g., '[Google',
'Mail]/Bin') from accounts that present the ParseError reported in T681.
This is kind of rough since it doens't search for folders or offending
labels.

Make the script to remove offeding labels more generic.

This commit changes the -l parameter of the aforementioned script to
accept multiple labels and adds the -f parameter to specifie the folder
on which we should operate.

The script should be run as follows:
```
$ bin/remove-offending-labels -a 1 -f '[Google Mail]/All Mail' -f '[Google Mail]/Trash' -f '[Google Mail]/Spam' -l '[Google' -l 'Mail]/Bin'
```
where 1 is the account ID as in our database.

Fix T681.

Test Plan:
Run the script on a test account with any label you want to remove as a
parameter.

Reviewers: spang, emfree

Reviewed By: emfree

Maniphest Tasks: T681

Differential Revision: https://review.inboxapp.com/D952"
filipposironi,2015-01-05 08:39:09,https://api.github.com/repos/nylas/sync-engine/git/commits/5e896e6f4153e81eba46c4eee639253287d7348e,5e896e6f4153e81eba46c4eee639253287d7348e,"Add CPU affinity support to the syncengine.

Summary:
This revision adds CPU affinity support to the syncengine by means of the
cpu_affinity package.

Fix T574.

Test Plan:
Start the syncengine with --cpu=0 or --cpu=1 on the development VM and make
sure all the syncengine threads (there is more than one thread per syncengine
process) are pinned to the CPU of choice.

Reviewers: spang, emfree

Reviewed By: emfree

Maniphest Tasks: T574

Differential Revision: https://review.inboxapp.com/D950"
emfree,2015-01-03 01:08:18,https://api.github.com/repos/nylas/sync-engine/git/commits/6158b69c3d5bb8ece3fc8164858f47917d226097,6158b69c3d5bb8ece3fc8164858f47917d226097,Log context in greenlet blocking warning.
kav-ya,2015-01-02 21:47:40,https://api.github.com/repos/nylas/sync-engine/git/commits/4e914df3463248887b7ffe343391ad99f69097c6,4e914df3463248887b7ffe343391ad99f69097c6,Search scripts edits.
emfree,2015-01-02 21:34:59,https://api.github.com/repos/nylas/sync-engine/git/commits/c74ccdeedd399ce1d9e45c16b7d8ef31c968820c,c74ccdeedd399ce1d9e45c16b7d8ef31c968820c,Remove unnecessary set operation in generic IMAP sync.
emfree,2015-01-02 19:40:17,https://api.github.com/repos/nylas/sync-engine/git/commits/1d36a13b98459eda47c615fed83db7774ad65777,1d36a13b98459eda47c615fed83db7774ad65777,Move misplaced comment.
emfree,2014-12-31 23:53:45,https://api.github.com/repos/nylas/sync-engine/git/commits/cae1c7a0ab16e3c6edc7ea99b0c4f0775db13261,cae1c7a0ab16e3c6edc7ea99b0c4f0775db13261,"Only fetch Google events that changed since last sync.

Summary:
Calendar event sync is otherwise mad expensive.

Fixes T700.

Test Plan: run locally.

Reviewers: khamidou, spang

Reviewed By: spang

Maniphest Tasks: T700

Differential Revision: https://review.inboxapp.com/D949"
emfree,2014-12-31 22:17:51,https://api.github.com/repos/nylas/sync-engine/git/commits/030cd9fd50d5b716f161291f29dd9d6f32edea2a,030cd9fd50d5b716f161291f29dd9d6f32edea2a,"Log most expensive greenlets, not least expensive.

Whoops."
emfree,2014-12-31 22:02:25,https://api.github.com/repos/nylas/sync-engine/git/commits/8fafe218509866ab59f9e1058df5c6898a303609,8fafe218509866ab59f9e1058df5c6898a303609,"Add minimal greenlet tracing.

Summary:
We use greenlet's settrace() facility to track time spent in each greenlet, as
well as greenlets that block for a long time. This is a very expedient way to
determine if particular accounts or components are especially expensive.

Test Plan: Run locally.

Reviewers: kav-ya, spang

Reviewed By: spang

Differential Revision: https://review.inboxapp.com/D944"
kav-ya,2014-12-30 19:45:01,https://api.github.com/repos/nylas/sync-engine/git/commits/63ba803cb93cb5a5dfb49c0ddb76c2a17129fb3b,63ba803cb93cb5a5dfb49c0ddb76c2a17129fb3b,"Index threads, messages affected by past Transaction table deletions into Elasticsearch as well.

Summary:
The search-index-service uses the Transaction table to index namespaces into Elasticsearch
(and perform updates, deletions too).

However, the first transaction we have a record of was created_at 2014-11-11 03:07:12, although
there are threads and messages created before then. The reason for the missing Transaction
records is the Transaction table deletions in the past.

This revision indexes the affected threads, messages into Elasticsearch as well.
Note: only index creation for these needs to be supported, future updates + deletions
to them will be picked up by the search-index-service.

Test Plan: Run on staging.

Reviewers: emfree

Differential Revision: https://review.inboxapp.com/D942"
emfree,2014-12-30 05:06:14,https://api.github.com/repos/nylas/sync-engine/git/commits/911c4ac4d8bf49d69f0525c1e76d95b30d20bd9e,911c4ac4d8bf49d69f0525c1e76d95b30d20bd9e,"Use rfc822 address parser for robustness.

Summary:
Flanker's address parser is pretty strict in what it will accept, compared to
what's actually out there in the wild. In mailsync we generally want to parse
what we can whenever possible, even if it's not strictly conformant to the
spec. To this end, use the parser provided by the rfc822 stdlib module, which
handles a lot more.

Fixes T695 (for newly synced messages).

Test Plan: Regression tests added based on a sample of observed failures.

Reviewers: spang

Reviewed By: spang

Maniphest Tasks: T695

Differential Revision: https://review.inboxapp.com/D939"
filipposironi,2014-12-30 13:46:25,https://api.github.com/repos/nylas/sync-engine/git/commits/1eb57f23f6cdd6e190edfc2e1b44696705779de9,1eb57f23f6cdd6e190edfc2e1b44696705779de9,Improve readability.
filipposironi,2014-12-30 10:44:50,https://api.github.com/repos/nylas/sync-engine/git/commits/a3a835dd73cc0591dd650f497139efefdcbe1079,a3a835dd73cc0591dd650f497139efefdcbe1079,"Leverage the heartbeats infrastructure for Contacts and Events.

Summary:
This revision introduces heartbeats for Contacts and Events sync.
Since with ""classic"" sync, contacts and events aren't assigned a folder and
folder ID as in EAS sync, we use ad-hoc folder IDs (-1 and -2) for contacts
and events, respectively.

NOTE: this revision removes a personalized event poll frequency for Outlook.com
accounts since we were not even synchronizing events for those accounts. If we
discover we need something different than the default we will reintroduce it.

Test Plan: Make sure heartbeats flows from greenlets to the Redis datastore.

Reviewers: khamidou, emfree

Reviewed By: emfree

Subscribers: spang

Differential Revision: https://review.inboxapp.com/D893"
emfree,2014-12-30 01:22:47,https://api.github.com/repos/nylas/sync-engine/git/commits/d08f8b2f25c25efd126846217d12ae03fa2ead53,d08f8b2f25c25efd126846217d12ae03fa2ead53,"Implement asynchronous message/thread deletion in IMAP sync.

Summary:
This prevents e.g. message objects from being deleted and recreated if the
message is moved between folders on the IMAP backend, or if a draft update
causes an old UID to be deleted and a new one to be created.

Fixes T477.

Test Plan: Unit tests added.

Reviewers: spang, kav-ya

Reviewed By: kav-ya

Maniphest Tasks: T477

Differential Revision: https://review.inboxapp.com/D933"
emfree,2014-12-29 23:49:45,https://api.github.com/repos/nylas/sync-engine/git/commits/3903d1100f11980e85a27fd587d994028065ceb1,3903d1100f11980e85a27fd587d994028065ceb1,"Clean up unit tests a bit.

Summary:
Splitting out some housekeeping undertaken while writing tests for D933.
* Remove miscellaneous cruft.
* Add fixtures that commit linked Message, Thread, Folder, and ImapUid objects,
  for more concise tests.

Test Plan: Run the tests.

Reviewers: kav-ya

Reviewed By: kav-ya

Differential Revision: https://review.inboxapp.com/D932"
emfree,2014-12-29 23:39:35,https://api.github.com/repos/nylas/sync-engine/git/commits/03b004d41de1bd951bad5195ca4a524278be24c7,03b004d41de1bd951bad5195ca4a524278be24c7,Fix GoDaddy MX records.
emfree,2014-12-29 23:21:12,https://api.github.com/repos/nylas/sync-engine/git/commits/db5111d4a4a23650f560463a3eed4f29e3258e7e,db5111d4a4a23650f560463a3eed4f29e3258e7e,"Escape parameters in log statement to prevent downstream parse errors.

Test Plan: Relentless optimism.

Reviewers: kav-ya

Reviewed By: kav-ya

Differential Revision: https://review.inboxapp.com/D936"
filipposironi,2014-12-29 18:06:45,https://api.github.com/repos/nylas/sync-engine/git/commits/110149e37f70835b4b08ba82b72dfa750bd2a0f9,110149e37f70835b4b08ba82b72dfa750bd2a0f9,"Batch device delete operations.

Summary:
This commit introduces batching for device delete operations. When the
EAS code invokes del_device() for a certain account, we have to make a
first round-trip to collect all the keys (account:folder) for that
account and, for each key, perform a device delete operation. By
batching these operations, we avoid multiple rount-trips.

Test Plan: Sync an EAS account.

Reviewers: khamidou, kav-ya

Reviewed By: kav-ya

Differential Revision: https://review.inboxapp.com/D935"
filipposironi,2014-12-29 09:01:38,https://api.github.com/repos/nylas/sync-engine/git/commits/5674509635a1b2f70b5aa88eb7a2b6df2f99493c,5674509635a1b2f70b5aa88eb7a2b6df2f99493c,"Reduce retries from 100 in 5 minutes to 5.

Summary:
This revision reduces the maximum number of retries in the 5 minutes span from
100 to 5 since we definitely cannot reach 100 retries in 5 minutes given the
current load we have.
This should prevent never-ending loops between the account monitors and the
folder engines, something we were observing in our EAS code.

Fix T670.

Test Plan: Non-disruptive change. Nothing bad should happen.

Reviewers: emfree, kav-ya

Reviewed By: kav-ya

Subscribers: spang

Maniphest Tasks: T670

Differential Revision: https://review.inboxapp.com/D925"
kav-ya,2014-12-26 00:58:27,https://api.github.com/repos/nylas/sync-engine/git/commits/c96772cf4932c3bdd75013bba422cafebdbb745c,c96772cf4932c3bdd75013bba422cafebdbb745c,"Ignore ValueError on loading JSON columns with invalid utf-8, instead log and return None.
Adapt the search indexer code to treat None values correctly.

Fixes T692.

Summary:
Python's native json loads(), dumps() fns. (wrapped by the bson.json_util library
we use) differ in how they treat invalid utf-8 - loads() is strict about invalid
utf-8 whereas dumps() is not. This can result in ValueErrors during decoding
JSON columns; merely log them for now.

We also adapt the search indexer code to treat the None values that can
now occur due to this change, correctly - we choose not to index objects
that could not be decoded rather than index incompletely/ incorrectly.

Note: An alternate, longer-term solution is to convert these problem values
into valid values and re-store in the database, but this should fix the
issue for now.

Test Plan:
Tested on prod - fixes the issue we were seeing on trying to start
the search-index-service.

Reviewers: emfree

Reviewed By: emfree

Differential Revision: https://review.inboxapp.com/D929"
emfree,2014-12-23 23:12:20,https://api.github.com/repos/nylas/sync-engine/git/commits/dbef65579abd8af84314b746ee98f1cbe38ac685,dbef65579abd8af84314b746ee98f1cbe38ac685,"Optimize IMAP update_metadata function.

Summary:
recompute_thread_labels() proves to be a relatively expensive function. The
problem with this is that in generic IMAP sync, we refetch flags for up to
refresh_flags_max=2000 UIDs, and recompute thread labels for each associated
thread, even if there weren't actually any changes. This turns out to be really
expensive in CPU time and query volume.

Instead, check if there are actual flag changes. In the process, rename
`ImapUid.update_imap_flags` to `ImapUid.update_flags_and_labels ` for clarity,
and clean up the relevant code a bit.

Test Plan: Unit tests.

Reviewers: spang

Reviewed By: spang

Differential Revision: https://review.inboxapp.com/D926"
emfree,2014-12-23 22:11:43,https://api.github.com/repos/nylas/sync-engine/git/commits/cf3d21486dfb5df078df8b878420ddc68e9bd477,cf3d21486dfb5df078df8b878420ddc68e9bd477,"Short-circuit in _choose_existing_thread_for_gmail.

This avoids an unecessarily expensive lazy load in the common case that there's
exactly one prior thread."
spang,2014-12-23 22:06:49,https://api.github.com/repos/nylas/sync-engine/git/commits/466476e5cf9cbad99abc4f0a156f37d3c977b938,466476e5cf9cbad99abc4f0a156f37d3c977b938,Upgrade test db dump
emfree,2014-12-23 18:55:43,https://api.github.com/repos/nylas/sync-engine/git/commits/87669f5684d0b9242d9f2bcff1e5ce11d6d6344f,87669f5684d0b9242d9f2bcff1e5ce11d6d6344f,"Add regression test for numeric Gmail label parsing.

We've had enough regressions with this."
filipposironi,2014-12-23 09:16:40,https://api.github.com/repos/nylas/sync-engine/git/commits/8d790e0a48071ca5fac61f1a7b53bbe67a2bc896,8d790e0a48071ca5fac61f1a7b53bbe67a2bc896,"Support apps hints for Gmail Contacts and Events sync.

Summary:
This revision supports applications proposals to sync contacts and events. The
application that requests the authentication of an account decleare if it is
interested in contacts and events sync (see Application and Proposal in
redwood.git), the hint is recorded in the RDB and is used to start greenlets
as needed.

NOTE: this revision disables event sync for Outlook.com temporarily since we
don't support requesting permission to access them.

Test Plan:
The behavior within this repository should remain the same before and after
this revision. However, some applications of those we've in prod don't require
contacts and events sync; for those applications new accounts shouldn't start
useless greenlets.

Reviewers: khamidou, emfree

Reviewed By: emfree

Subscribers: spang

Differential Revision: https://review.inboxapp.com/D908"
emfree,2014-12-23 02:20:35,https://api.github.com/repos/nylas/sync-engine/git/commits/7f1c417f3604e3dd1413d2fd9a10c4f18aecc201,7f1c417f3604e3dd1413d2fd9a10c4f18aecc201,"Ensure IMAP connections get taken out of IDLE mode.

Summary:
This fixes an issue in which CrispinClient instances would get returned to the
connection pool while still in IDLE mode (e.g., if their containing greenlet
was killed). If reused in other contexts the connections could end up silently
hanging.

Fixes T688.

Test Plan:
Difficult to write a real regression test without committing account
credentials. But it does fix the issue on the problematic database dump.

Reviewers: siro, spang

Reviewed By: spang

Subscribers: spang

Maniphest Tasks: T688

Differential Revision: https://review.inboxapp.com/D924"
emfree,2014-12-23 00:17:48,https://api.github.com/repos/nylas/sync-engine/git/commits/1e48d55d4882b7d322d4d469a6459b4647269f5a,1e48d55d4882b7d322d4d469a6459b4647269f5a,Handle edge case in migration removing Gmail folder syncs.
emfree,2014-12-22 19:45:41,https://api.github.com/repos/nylas/sync-engine/git/commits/60db8c1f49d79e39d1e97d1ae139529ac444b7d9,60db8c1f49d79e39d1e97d1ae139529ac444b7d9,Skip rendering search docs.
filipposironi,2014-12-22 08:11:53,https://api.github.com/repos/nylas/sync-engine/git/commits/5507483f7a79c6c8b176e382d9338ff043396621,5507483f7a79c6c8b176e382d9338ff043396621,"Move heartbeats emission to eagerly signal bad status.

Summary:
This commits move heartbeats emission after downloading and commiting a
message. If something happen during the download/commit (e.g., anything
related to the connection, IMAP interaction, DB interaction), the retry
mechanism should kick in before emitting heartbeats, thus signal bad
status faster.

Test Plan:
The bugs this commit might uncover cannot be reproduced in a simple manner.
Syncing a bunch of accounts and make sure heartbeats get reported is what we
should check.

Reviewers: emfree, spang

Reviewed By: emfree

Differential Revision: https://review.inboxapp.com/D916"
spang,2014-12-21 01:18:38,https://api.github.com/repos/nylas/sync-engine/git/commits/450ea1cad661b7a87b59bce1c38790b0de61a4f9,450ea1cad661b7a87b59bce1c38790b0de61a4f9,Note in /files docs that inline attachments are not included.
spang,2014-12-21 00:55:02,https://api.github.com/repos/nylas/sync-engine/git/commits/f5ff15ec7cb347bb660e7baa020c3bd6bd4aa502,f5ff15ec7cb347bb660e7baa020c3bd6bd4aa502,Fix content-type bit of files API docs.
emfree,2014-12-19 00:44:54,https://api.github.com/repos/nylas/sync-engine/git/commits/d41cb60fdf6225c7c3302abd39e4e9c172307c93,d41cb60fdf6225c7c3302abd39e4e9c172307c93,"Simplify syncmanager_lock.

Summary:
Acquiring syncmanager_lock formerly meant acquiring both a gevent lock and a
file lock. But the latter is patently unnecessary, because the
Account.sync_lock() and Account.sync_unlock() methods (invoked in
inbox.mailsync.service) already guard against an account sync running on
distinct processes on the same machine.

We probably don't actually need any sort of lock most places where we hold
syncmanager_lock, but that's a patch that needs a bit more thought and care.

Test Plan: Run sync as sanity check.

Reviewers: spang, siro

Reviewed By: siro

Differential Revision: https://review.inboxapp.com/D913"
emfree,2014-12-19 00:25:55,https://api.github.com/repos/nylas/sync-engine/git/commits/4890aa799a9c3130d7db6004690a66d0002aa455,4890aa799a9c3130d7db6004690a66d0002aa455,"Coerce Gmail labels to unicode if necessary.

Turns out that if you have label ""22"", imapclient will parse the response
< * 82 FETCH (X-GM-LABELS (""\\Inbox"" 5) UID 395 MODSEQ (40256))
into
{395: {u'X-GM-LABELS': (u'\\Inbox', 5), u'SEQ': 82, u'MODSEQ': (40256,)}}
so we have to turn that int into a unicode string."
emfree,2014-12-18 22:12:46,https://api.github.com/repos/nylas/sync-engine/git/commits/ef41e2956241bc6fd9c984d3ca29ac177f109261,ef41e2956241bc6fd9c984d3ca29ac177f109261,"Fix Gmail spam/trash syncback actions.

Summary:
In the vaguely Rube-Goldberg-esque world that is Gmail IMAP, either of the
following two actions will actually move a UID to the trash folder:
* copy the UID to the '[Gmail]/Trash' [1] folder
* add the '\\Trash' label.

However, we were adding a '[Gmail]/Trash' *label*, which does *not* actually
remove the UID from the All Mail folder or move it to the trash folder.

Finally, removing a thread from trash or spam wouldn't work either, because you
have to select the appropriate folder first.

(Similar observations apply to spam.)

Mostly fixes T628, in a roundabout way.

\[1\] Or '[Gmail]/Papierkorb' or whatever, depending on your localization.

Test Plan: Check that syncback actions actually do what they promise.

Reviewers: spang, kav-ya

Reviewed By: kav-ya

Maniphest Tasks: T628

Differential Revision: https://review.inboxapp.com/D912"
khamidou,2014-12-18 11:31:47,https://api.github.com/repos/nylas/sync-engine/git/commits/06bb28a562579c17607c96ee621881e66a5ad2f4,06bb28a562579c17607c96ee621881e66a5ad2f4,"[Refactor] Move Participants inside Event

Summary:
This is most of the code for the refactor, with some caveats:
1. This is somehow working. I tested it basically: synced a calendar, created and update event participants. I haven't run the system tests yet
2. There's still some flake8 style issues
3. I haven't written a migration yet.

Still, many bothans died to fix this code so I thought it would be nice to get something reviewable asap.

Test Plan: Manual tests.

Reviewers: kav-ya, emfree

Reviewed By: kav-ya, emfree

Subscribers: spang

Projects: #calendars

Maniphest Tasks: T631

Differential Revision: https://review.inboxapp.com/D865"
emfree,2014-12-18 01:02:20,https://api.github.com/repos/nylas/sync-engine/git/commits/bb8b24a1582eeb476f0b83e184ab7ced450d3c8c,bb8b24a1582eeb476f0b83e184ab7ced450d3c8c,"Delete empty threads on draft deletion.

Summary: Otherwise we end up with empty dangling threads.

Test Plan: Regression test added.

Reviewers: kav-ya

Differential Revision: https://review.inboxapp.com/D910"
emfree,2014-12-18 01:18:48,https://api.github.com/repos/nylas/sync-engine/git/commits/c1c54754e51b9ceae3b2e4c342b46abfa6a7162f,c1c54754e51b9ceae3b2e4c342b46abfa6a7162f,"Fix logging for tests.

logging.fileHandler will create a file, but not a directory, for you, so we
need to make sure the directory (now just /tmp/log) exists."
emfree,2014-12-17 23:40:59,https://api.github.com/repos/nylas/sync-engine/git/commits/c0a50fb4e4746fb13f809d4cbbfe0e02e5bc2a27,c0a50fb4e4746fb13f809d4cbbfe0e02e5bc2a27,"Configure passive_deletes=True on message.imapuids relationship.

Needed for database-level message --> imapuid delete cascades to work properly."
emfree,2014-12-17 02:13:22,https://api.github.com/repos/nylas/sync-engine/git/commits/8da70a8fcd37c5768c89bdf6004a3c4902737be6,8da70a8fcd37c5768c89bdf6004a3c4902737be6,"Use port 465, not 587, for godaddy SMTP.

Since they support neither SMTP message submission on port 587 per RFC2476, nor
STARTTLS on port 25 as far as we can tell, SMTP-over-SSL it is."
emfree,2014-12-17 01:47:25,https://api.github.com/repos/nylas/sync-engine/git/commits/e61684ad63697db35f9c4aadf0c780809234d683,e61684ad63697db35f9c4aadf0c780809234d683,"Add support for SMTP-over-SSL.

Summary:
This is needed to support some backends (looking at you, GoDaddy) that don't
support STARTTLS. We just see if the port is 465, and use smtplib.SMTP_SSL
instead of smtplib.SMTP if so.

Fixes T661.

Test Plan:
Basic unit test added. Manually check that sending works via either
mechanism on backends that support both.

Reviewers: spang, kav-ya

Reviewed By: kav-ya

Maniphest Tasks: T661

Differential Revision: https://review.inboxapp.com/D905"
kav-ya,2014-12-16 21:55:32,https://api.github.com/repos/nylas/sync-engine/git/commits/88ac2887c93c7805b42bb97308816ed0ead58ba6,88ac2887c93c7805b42bb97308816ed0ead58ba6,Tests log to a different log directory.
emfree,2014-12-16 18:40:56,https://api.github.com/repos/nylas/sync-engine/git/commits/cee18c89b56f85557b2cdfa341f9cc193ec9a0f2,cee18c89b56f85557b2cdfa341f9cc193ec9a0f2,"Remove soft-delete mechanism.

Summary:
We weren't using it for any real purpose, and it tended just to complicate
queries and reasoning about relationships. In particular, drafts may be
soft-deleted via the API, which can cause major problems during IMAP sync
(where soft deletes are ignored).

* Syncing back deleted objects (drafts and events, currently) has to work
  without access to the object itself (because the object is deleted for real).
* Some relationships now require `passive_deletes=True` to be configured in
  order for database-level delete cascades to work properly.
* `session_scope()` and `InboxSession()` still accept an `ignore_soft_deletes`
  argument so that client code doesn't need to be updated immediately. This
  argument does nothing, and can be removed once all client code is updated.

Depends on D881.

Test Plan:
Run unit tests; should run on staging for a bit to shake out any
lingering issues.

Reviewers: kav-ya, spang

Reviewed By: kav-ya, spang

Differential Revision: https://review.inboxapp.com/D882"
spang,2014-12-16 17:13:42,https://api.github.com/repos/nylas/sync-engine/git/commits/e703678947d9fbc5feeaddcc3096388d1d8c8c3d,e703678947d9fbc5feeaddcc3096388d1d8c8c3d,"Merge pull request #109 from aidanhs/docker-fixes

Assorted fixes for running in docker"
filipposironi,2014-12-16 14:04:28,https://api.github.com/repos/nylas/sync-engine/git/commits/a06e25a38d72849142ade5c0c98f9a8cd9e77669,a06e25a38d72849142ade5c0c98f9a8cd9e77669,"Change exception handling in inbox.status.

Summary: This revision makes exception handling more ""Pythonic"".

Test Plan: Test with unicode string in /etc/inboxapp/config.json.

Reviewers: khamidou

Reviewed By: khamidou

Differential Revision: https://review.inboxapp.com/D899"
emfree,2014-12-16 03:23:44,https://api.github.com/repos/nylas/sync-engine/git/commits/4c0167850d635a3a17d0830f39134d1cf3d77515,4c0167850d635a3a17d0830f39134d1cf3d77515,"Also remove Gmail inbox syncs from Redis.

Otherwise account sync heartbeat logic gets confused."
emfree,2014-12-16 01:12:57,https://api.github.com/repos/nylas/sync-engine/git/commits/8b45f50922efc0f3488e09f3d4aebae3bc85ab0f,8b45f50922efc0f3488e09f3d4aebae3bc85ab0f,"Don't sync the Gmail Inbox folder.

Summary:
Now that we correctly sync X-GM-LABELS and can quickly fetch changed UIDs for a
given HIGHESTMODSEQ value, we don't actually need to sync the Gmail Inbox
folder separately. This lets us use fewer IMAP connections, generally
removes much complexity, and improves sync performance.

We still order the uid download stack in initial sync such that threads in the
inbox get downloaded first.

Test Plan: Run sync. Watch sync run. Run, sync, run!

Reviewers: khamidou, spang

Reviewed By: spang

Differential Revision: https://review.inboxapp.com/D889"
aidanhs,2014-12-14 15:00:13,https://api.github.com/repos/nylas/sync-engine/git/commits/d4110d13f12adf7ad597d892a1f8d252ffbb1f19,d4110d13f12adf7ad597d892a1f8d252ffbb1f19,Docker entrypoint must be run as root
aidanhs,2014-12-14 13:24:33,https://api.github.com/repos/nylas/sync-engine/git/commits/f6394805a7b42c58faff028bff072759d92d66e7,f6394805a7b42c58faff028bff072759d92d66e7,Missing import
aidanhs,2014-12-14 12:17:23,https://api.github.com/repos/nylas/sync-engine/git/commits/027ae71204c845c4c6e9af41da6eaed4c2b7991f,027ae71204c845c4c6e9af41da6eaed4c2b7991f,Dockerfile path fixes
emfree,2014-12-12 21:40:46,https://api.github.com/repos/nylas/sync-engine/git/commits/13e452be544e4811f4189353091db44984728fb7,13e452be544e4811f4189353091db44984728fb7,"Overhaul IMAP draft deletion.

Summary:
Basically, in order to do away with soft-deletes we have to restructure
syncback actions such that the syncback service doesn't need to access database
objects that have been legitimately deleted. So we need a strategy for deleting
drafts that were created on the remote (and hence have no X-Inbox-Id header).
Previously we'd delete the entire thread (!), which in any case is definitely
not what we want to do. Now we instead just use either the X-Inbox-Id header or
the Message-Id header to locate the message on the remote.

(This is a prerequisite to fixing T666.)

Test Plan: All manual for now.

Reviewers: kav-ya

Reviewed By: kav-ya

Differential Revision: https://review.inboxapp.com/D881"
filipposironi,2014-12-11 18:08:15,https://api.github.com/repos/nylas/sync-engine/git/commits/6d4213130211334a46a7c03e54db7ba7814d6168,6d4213130211334a46a7c03e54db7ba7814d6168,Improve setup.sh to avoid installing software in production.
filipposironi,2014-12-11 13:53:48,https://api.github.com/repos/nylas/sync-engine/git/commits/c36a96456f833a5369e93fc13a1644d30ccf58ce,c36a96456f833a5369e93fc13a1644d30ccf58ce,Allow account-restricted checks with bin/inbox-syncstatus.
kav-ya,2014-12-11 04:39:32,https://api.github.com/repos/nylas/sync-engine/git/commits/240d7b99e295ba6884f04a7c8dd72b24b1aa60b0,240d7b99e295ba6884f04a7c8dd72b24b1aa60b0,"Optimize search time format conversion

Summary: Convert datetime to Unix timestamp at index-time rather than at search result processing.

Test Plan: Tested manually.

Reviewers: emfree

Reviewed By: emfree

Differential Revision: https://review.inboxapp.com/D877"
kav-ya,2014-12-11 01:19:04,https://api.github.com/repos/nylas/sync-engine/git/commits/881f58fa8aeda0736de5465417bb73bf6d17de5d,881f58fa8aeda0736de5465417bb73bf6d17de5d,Import SearchIndexCursor model too.
jennielees,2014-12-11 00:19:56,https://api.github.com/repos/nylas/sync-engine/git/commits/e0273294337d7f3c8576e0b9c9731d179f19bddc,e0273294337d7f3c8576e0b9c9731d179f19bddc,fix TypeError
emfree,2014-12-10 23:49:55,https://api.github.com/repos/nylas/sync-engine/git/commits/ca02e06764a8a49d8b0d1a565f75805b774b10cb,ca02e06764a8a49d8b0d1a565f75805b774b10cb,"Handle spurious UIDVALIDITY changes in generic IMAP.

Summary:
We're actually seeing this in the wild. We still can't do a full resync, but at
least this keeps syncs from getting totally stuck in the face of flaky
UIDVALIDITY responses.

Test Plan:
Poison sync logic to sporadically raise UidInvalid, check that
sync cleanly enters and exits uidinvalid state.

Reviewers: siro, spang

Reviewed By: spang

Differential Revision: https://review.inboxapp.com/D876"
jennielees,2014-12-10 23:45:10,https://api.github.com/repos/nylas/sync-engine/git/commits/815180b819643ac53bb6814a8d6ca331d0ee9e58,815180b819643ac53bb6814a8d6ca331d0ee9e58,"make default test event local, since remote ones suppress transactions"
kav-ya,2014-12-10 22:19:22,https://api.github.com/repos/nylas/sync-engine/git/commits/0a7e5539e09a0ade15b96197825404ce5b3e3ac2,0a7e5539e09a0ade15b96197825404ce5b3e3ac2,"[SCHEMA] Migration for easeventuid.

Summary:
Note this does not include a script to backfill the table
for existing events.

Also note this does not include the msg_uid index because we don't need it
(will update code too).

Test Plan: Run it, visually inspect.

Reviewers: emfree

Reviewed By: emfree

Differential Revision: https://review.inboxapp.com/D874"
khamidou,2014-12-10 19:07:53,https://api.github.com/repos/nylas/sync-engine/git/commits/6a3a1682e82be94efd9d405c7bd3f72e54b2aa64,6a3a1682e82be94efd9d405c7bd3f72e54b2aa64,"Don't show remote events in the delta sync API

Summary:
So, Esper have reported that they've got duplicate events in the delta sync output. I turns out that was because of a subtlety of the events sync engine. When we're syncing events, we store two different objects pointing to the same event: a local version (with local changes) and a remote version. The problem is we surface both objects in the delta sync API, which is confusing for our customers.

This patch fixes this, in a myopic way. Going forward, I think we'll have to break up the delta sync API to have one endpoint for each resource. As is, it's pretty complicated to have custom filtering/formatting of the data.

Test Plan: Tested manually. Checked that only local events surfaced.

Reviewers: kav-ya, emfree

Reviewed By: emfree

Subscribers: spang

Projects: #sync-engine, #customers

Maniphest Tasks: T663

Differential Revision: https://review.inboxapp.com/D871"
filipposironi,2014-12-10 08:09:19,https://api.github.com/repos/nylas/sync-engine/git/commits/8a8057bc8f3faf94c364e72dcef5b7892d895695,8a8057bc8f3faf94c364e72dcef5b7892d895695,"Reduce code duplication between inbox.git and redwood.git.

Summary:
This revision consolidates everthing under inbox.status.* into
inbox.status.sync. In addition, it simplifies the bin/inbox-syncstatus script,
which now shares plenty of code with the admin dashboard.

Addresses https://review.inboxapp.com/T656.

Test Plan: Check if inbox and redwood are working correctly.

Reviewers: emfree, jennie

Reviewed By: jennie

Differential Revision: https://review.inboxapp.com/D863"
emfree,2014-12-10 00:04:54,https://api.github.com/repos/nylas/sync-engine/git/commits/fe38937179cf2387c5cff587bbe927634eb16b04,fe38937179cf2387c5cff587bbe927634eb16b04,"Fetch all events in Google calendar sync.

Summary:
Previously we'd unwittingly only sync the first 250 events returned by the
Google calendar API for any given calendar. Fixes T658.

Test Plan:
Run sync, check that more events are synced for large calendars than
were previously.

Reviewers: khamidou, kav-ya

Reviewed By: kav-ya

Maniphest Tasks: T658

Differential Revision: https://review.inboxapp.com/D870"
kav-ya,2014-12-09 01:26:44,https://api.github.com/repos/nylas/sync-engine/git/commits/1555b7015c8db7b6b688a35a34e0c37bc8aff5db,1555b7015c8db7b6b688a35a34e0c37bc8aff5db,"Convert the default string datetime format returned by Elasticsearch to Unix timestamp format.

Summary:
Fixes T653.

This is intended as a quick fix so Edgehill is not blocked on it.
A better solution is to change our mapping and reconfigure the index,
this is what we'll do for prod.

Test Plan: Tested manually.

Reviewers: emfree

Reviewed By: emfree

Subscribers: bengotow

Maniphest Tasks: T653

Differential Revision: https://review.inboxapp.com/D859"
emfree,2014-12-09 00:58:36,https://api.github.com/repos/nylas/sync-engine/git/commits/76b0009f8be7dbb4230a6aa5174122a4493ec36f,76b0009f8be7dbb4230a6aa5174122a4493ec36f,"Make async test less flaky.

Poll until timeout rather than just sleeping before checking the syncback
result."
emfree,2014-12-08 22:05:26,https://api.github.com/repos/nylas/sync-engine/git/commits/16f2d0a93f2affa790d575ad6b4187f465ceea95,16f2d0a93f2affa790d575ad6b4187f465ceea95,"Set the 'state' property for drafts synced from the remote.

Summary:
This way drafts created locally and remotely have the same
representation.

Fixes T343.

Test Plan:
Check that drafts created on the backend have the 'state' property
set.

Reviewers: kav-ya

Reviewed By: kav-ya

Maniphest Tasks: T343

Differential Revision: https://review.inboxapp.com/D855"
kav-ya,2014-12-08 22:44:05,https://api.github.com/repos/nylas/sync-engine/git/commits/0b51fc149dd904055e58eedc23e71da45871a172,0b51fc149dd904055e58eedc23e71da45871a172,"Support EAS contacts, events modules."
jennielees,2014-12-08 23:17:34,https://api.github.com/repos/nylas/sync-engine/git/commits/7bd42557f31258932c43c27e0794585a558d4af6,7bd42557f31258932c43c27e0794585a558d4af6,"Add merge to InboxSession

Summary: Adds merge to InboxSession.

Test Plan: Tested trivially. The motivation for this change is to unbreak a test elsewhere.

Reviewers: emfree

Reviewed By: emfree

Differential Revision: https://review.inboxapp.com/D857"
emfree,2014-12-06 03:18:26,https://api.github.com/repos/nylas/sync-engine/git/commits/56b32c340ca317387492ba43667fcfedb3324c64,56b32c340ca317387492ba43667fcfedb3324c64,"Preserve IMAP folder sync order.

We want to make sure that we sync e.g. the Inbox folder before other ones
during initial sync."
jennielees,2014-12-05 20:05:50,https://api.github.com/repos/nylas/sync-engine/git/commits/f601645d5f3c440f7c44222515ebe0530392c23b,f601645d5f3c440f7c44222515ebe0530392c23b,"Use pipeline to batch execute Redis fetches

Summary:
Instead of sequential hgetall() calls, use a pipeline to
execute calls in bulk for a big speed improvement.

Test Plan:
Tested locally with staging redis DB. Will need to test
against production redis in case the count parameter needs tweaking.

Reviewers: siro

Reviewed By: siro

Differential Revision: https://review.inboxapp.com/D848"
emfree,2014-12-04 20:39:38,https://api.github.com/repos/nylas/sync-engine/git/commits/08fc1c4c26110247c501155de70a2afcf185d7ff,08fc1c4c26110247c501155de70a2afcf185d7ff,"s/subqueryload/joinedload to prevent weird bugs.

tests.test_drafts.test_draft_filtering was failing sporadically for some
strange reason apparently related to subquery loading?"
emfree,2014-12-04 19:19:45,https://api.github.com/repos/nylas/sync-engine/git/commits/4a0aefbc951b286b3de8f69ec3c1788675c14a35,4a0aefbc951b286b3de8f69ec3c1788675c14a35,"Fix regression in Gmail-special-folder-handling.

This fixes a regression introduced in commit e9624a728, in which syncing Gmail
threads marked e.g. as starred or important would fail if the corresponding
folder was disabled from appearing in IMAP, or not present for some other
reason when we synced folder names."
emfree,2014-12-04 02:50:53,https://api.github.com/repos/nylas/sync-engine/git/commits/21894604880aa6ecc54541970ee67b64f9e101ee,21894604880aa6ecc54541970ee67b64f9e101ee,"Eager-load attributes necessary to construct Message representation.

Summary:
This makes the /messages API endpoint a fair bit faster (~ 3x as
measured against example requests from production).

Test Plan: Run example requests; unit tests.

Reviewers: kav-ya

Reviewed By: kav-ya

Differential Revision: https://review.inboxapp.com/D840"
filipposironi,2014-12-04 18:13:52,https://api.github.com/repos/nylas/sync-engine/git/commits/7fc8bb344d08e46bbdb4ff4c88dd62aece65315d,7fc8bb344d08e46bbdb4ff4c88dd62aece65315d,"Support adding new IMAP folders without restarting.

Summary:
We didn't support adding new IMAP folders without restarting the IMAP monitor
and thus the IMAP folder sync engines handling an IMAP account since
prepare_sync, which was the function doing the ""dirty work"", was called only
once in sync.  We now support it by calling sync() on a regular basis within
the IMAP monitor.

In addition, this revision refactor the Gmail monitor. Conversely to a classic
IMAP account, Gmail accounts don't require to pick up new IMAP folders since
Gmail doesn't really support them. Thus, it overrides sync calling prepare_sync
over and over.
Moreover, this revision also removes code duplications between IMAP and Gmail
monitor. This requires adding the should_block property to the IMAP folder sync
engine, which is then overloaded by the Gmail folder sync engine (which has its
own policy). The former always returns True to make sure we only have one IMAP
folder sync engine in the 'initial' state per IMAP monitor.

Fix https://review.inboxapp.com/T586.

Test Plan:
Sync an IMAP account (e.g., Fastmail), add a new IMAP folder from the webapp
make sure Inbox picks it up.

Reviewers: khamidou, emfree

Reviewed By: emfree

Subscribers: spang

Differential Revision: https://review.inboxapp.com/D675"
filipposironi,2014-12-04 15:05:23,https://api.github.com/repos/nylas/sync-engine/git/commits/f4dd79c82833ab332c94663fcb479e1878cbe64e,f4dd79c82833ab332c94663fcb479e1878cbe64e,"Bump python-dateutil version in requirements.txt

I ran the regression test against a virtual machine with version 2.3.
The regression passes without troubles. In addition, one of our staging
machine is already running with version 2.3 (I don't know why this is
the case so we would better update it)."
filipposironi,2014-12-04 14:43:11,https://api.github.com/repos/nylas/sync-engine/git/commits/14151b7a208e28e98b567a7ce86c0d9ffd8197be,14151b7a208e28e98b567a7ce86c0d9ffd8197be,"Simplify bin/inbox-syncstatus usage.

Add defaults to parameters and a --pretty switch to ease reading the
output of the script."
filipposironi,2014-12-04 09:59:49,https://api.github.com/repos/nylas/sync-engine/git/commits/c7b9c5d4ac3319df1ab0628286ced2386c67c891,c7b9c5d4ac3319df1ab0628286ced2386c67c891,Move SyncStatus initialization outside of try/except.
filipposironi,2014-12-04 09:36:48,https://api.github.com/repos/nylas/sync-engine/git/commits/2315779e37e3474a9aa8275b428b2c45a37f23f8,2315779e37e3474a9aa8275b428b2c45a37f23f8,Include 'action' in the sync status monitoring output.
filipposironi,2014-12-04 09:33:03,https://api.github.com/repos/nylas/sync-engine/git/commits/2457aae2405f91d175e7871fe172a5993a7f396a,2457aae2405f91d175e7871fe172a5993a7f396a,"Improve the heartbeat mechanism.

Summary:
This revision changes the Redis database from 0 to 1 (see
/etc/inboxapp/config.json) - NOTE: we can use any database from 1 to 15;
introduces support for the heartbeat mechanism for EAS; improves both the
location and the parameters of calls to publish() to improve reporting; avoids
unnecessary branches when retrieving a Redis client; improves error handling
with better logging.

In addition, this revision overhauls the bin/monitor-syncstatus script, which
is now bin/inbox-syncstatus. The script now prints JSON on stdout and exits
with either 0, 1, or 2, which makes it play nicely with our sensu-based
monitoring.

Test Plan:
```
vagrant up
vagrant ssh
cd /vagrant
bin/inbox-start

vagrant up
vagrant ssh
cd /vagrant
bin/inbox-auth ADDRESS

vagrant up
vagrant ssh
cd /vagrant
bin/inbox-syncstatus --redis-hostname='localhost' --redis-port=6379 --redis-database=1
```
Happy monitoring :)

Reviewers: emfree, kav-ya

Reviewed By: emfree, kav-ya

Subscribers: khamidou, jennie, spang

Differential Revision: https://review.inboxapp.com/D771"
kav-ya,2014-12-04 02:04:49,https://api.github.com/repos/nylas/sync-engine/git/commits/f4217871258f616ee58becc47d064e1357179692,f4217871258f616ee58becc47d064e1357179692,"Support pagination in search queries -
return total number of matches in the search response."
emfree,2014-12-04 01:16:19,https://api.github.com/repos/nylas/sync-engine/git/commits/7c75dfe28e26d575a4f63c5610d59713b406a2ef,7c75dfe28e26d575a4f63c5610d59713b406a2ef,"Properly update draft objects after sending failure; remove smtpconn_retry.

Summary:
* It doesn't make sense to have retry logic in both the syncback service and in
  the smtpconn_retry decorator; doing so can cause sending actions to get stuck
  for an arbitrarily long amount of time.

* Properly set a draft object's 'state' property to 'sending failed' if we
  can't send it.

Test Plan: Unit tests added.

Reviewers: kav-ya

Reviewed By: kav-ya

Differential Revision: https://review.inboxapp.com/D829"
kav-ya,2014-12-04 00:50:29,https://api.github.com/repos/nylas/sync-engine/git/commits/2b5ee695cfcb309c8692451f3e2f49359e5199d2,2b5ee695cfcb309c8692451f3e2f49359e5199d2,Do not raise SearchEngineError on deleting an ES index that does not exist.
emfree,2014-12-02 22:41:29,https://api.github.com/repos/nylas/sync-engine/git/commits/5fe25e18492e48392260b7e84feeed7e2788c35c,5fe25e18492e48392260b7e84feeed7e2788c35c,s/namespace/namespace_id for API calendar representation.
emfree,2014-12-02 03:03:46,https://api.github.com/repos/nylas/sync-engine/git/commits/d015a02bea8b09dc4a12e9d12c0a7ec5b0dfea4d,d015a02bea8b09dc4a12e9d12c0a7ec5b0dfea4d,Fix bin/regen-labels script for large datasets.
emfree,2014-12-02 01:58:33,https://api.github.com/repos/nylas/sync-engine/git/commits/e9624a728da404424cdad83fe3371617ca092dc3,e9624a728da404424cdad83fe3371617ca092dc3,"Correctly update thread tags in IMAP sync.

Summary:
With this commit, we update a thread's tags by aggregating over all ImapUid
folders and labels to figure out what the tags should be. Previously, we
wouldn't remove the inbox tag if the \Inbox *label* was removed from an All
Mail UID -- only if we synced a deleted Inbox UID. This wouldn't work if the
Inbox folder syncs lagged such that we never actually saw an Inbox UID for the
message.

Fixes T632.

Test Plan:
Run syncs and check that the inbox tag is removed from archived
threads. Automated tests to come, but I want to put this on staging sooner
rather than later.

Reviewers: spang, khamidou

Reviewed By: khamidou

Maniphest Tasks: T632

Differential Revision: https://review.inboxapp.com/D810"
colhom,2014-11-17 07:36:18,https://api.github.com/repos/nylas/sync-engine/git/commits/35119f5396f4a231bae6c9d2322ab4bd40bb7c68,35119f5396f4a231bae6c9d2322ab4bd40bb7c68,"Dockerfile now builds using new dynamic notation, modify config parser to override mysql host and port information from docker links"
kav-ya,2014-12-01 22:11:39,https://api.github.com/repos/nylas/sync-engine/git/commits/490687723597970aa8590414f0bdda57bae13046,490687723597970aa8590414f0bdda57bae13046,Bump python-dateutil version in requirements.txt
kav-ya,2014-11-26 21:51:42,https://api.github.com/repos/nylas/sync-engine/git/commits/ddfe91328b6810b6f28cc11102b5924ec3022406,ddfe91328b6810b6f28cc11102b5924ec3022406,Search index bulk deletes should ignore parent relation.
khamidou,2014-11-26 11:18:48,https://api.github.com/repos/nylas/sync-engine/git/commits/3b9321ce7f4e015d8fe45cb2ee95702868b17dbb,3b9321ce7f4e015d8fe45cb2ee95702868b17dbb,"[tests] Verify that Google calendars events are actually synced back

Summary:
This is probably not the prettiest test ever: there's a lot of copy paste from test_events (I'm welcoming your suggestions on how to solve this btw -- I tried to use fixtures and stuff but this just wouldn't work with py.test).

The test already paid itself by catching not one but two bugs!

Test Plan: Ran the test

Reviewers: emfree, kav-ya

Reviewed By: kav-ya

Projects: #testing

Differential Revision: https://review.inboxapp.com/D788"
emfree,2014-11-26 00:47:28,https://api.github.com/repos/nylas/sync-engine/git/commits/7be70ea98bca4580c711808af50009508ce2ab0c,7be70ea98bca4580c711808af50009508ce2ab0c,"Add content_id to API so clients can support embedded images

Summary:
The HTML body of a message can contain image tags which reference a `cid` aka Content-ID. This is a string that represents which MIME attachment to display inline. Since we're not modifying the HTML, we need to expose the Content-ID value so clients can (optionally) load and render the image inline via our API.

More info on Content-ID: https://www.ietf.org/rfc/rfc2392.txt

Test Plan: passes tests

Reviewers: mg, spang

Reviewed By: spang

Subscribers: kav-ya, emfree

Differential Revision: https://review.inboxapp.com/D756"
kav-ya,2014-11-25 22:23:26,https://api.github.com/repos/nylas/sync-engine/git/commits/a8f62d812d2abc52ad90edc0dfe7245e4b32fc4d,a8f62d812d2abc52ad90edc0dfe7245e4b32fc4d,Fix argument.
kav-ya,2014-11-25 21:22:16,https://api.github.com/repos/nylas/sync-engine/git/commits/706d720b7167f3e4da460fd70b6ce51069a946b2,706d720b7167f3e4da460fd70b6ce51069a946b2,Script to check for extra eas folders.
kav-ya,2014-11-22 23:17:16,https://api.github.com/repos/nylas/sync-engine/git/commits/1caa4d10442058b2df33cdc13003a005745fa6d3,1caa4d10442058b2df33cdc13003a005745fa6d3,"[SCHEMA] Search index operations through the transaction log.

Summary:
We currently re-index all the namespaces (i.e. all messages, threads) in the database periodically.
This suffers from a few key shortcomings:
1. Changes due to sync, syncback are not reflected in search until the next re-index is complete (run as an hourly cron job right now).
2. Deletes are not supported.
3. Is obviously slow/inefficient.

So, leverage our transaction logic instead.
The SearchIndexService - run as a separate process - periodically polls the Transaction table (set to 30s),
translates the database changes for the messages, threads of all namespaces to the corresponding
Elasticsearch index operations and performs them.

* Support for index insert, update, delete operations.

* Support for process restarts - the id of the last processed (i.e. indexed) transaction is
persisted to/retrieved from the database.

Note:
The current implementation of the SearchIndexService is namespace agnostic.
An alternate implementation would be to perform the polling/indexing per-namespace and store the
last_processed_txn per-namespace too.
I don't have a compelling argument for the latter, which is more complicated too, and hence went with the former.

The `searchindexcursor` table will only ever have one row (Alembic uses the `alembic_version` table in a similar way too).

Migration included.
Test underway.

Test Plan:
Tested locally, manually.
Will be tested on staging.

Reviewers: emfree

Reviewed By: emfree

Differential Revision: https://review.inboxapp.com/D801"
emfree,2014-11-25 00:48:06,https://api.github.com/repos/nylas/sync-engine/git/commits/62458a4e408b347007cb3252a47a9cfa76f7e1ab,62458a4e408b347007cb3252a47a9cfa76f7e1ab,"Remove deleted UIDs after adding new ones in IMAP sync.

Summary:
Say we sync a draft update back to the IMAP backend, so delete the UID for the
old draft and add a new one. In normal mailsync, if we first sync the delete
and then the add, the odds are high that the actual draft object gets deleted
as being orphaned, and that we then create a new different draft object once we
sync the add. This would cause a baffling 404 error if you went to send the
draft or update it again. (T621)

As aesthetically unappealing as this solution is, it drastically lessens the
likelihood of that scenario in an expedient way.

Test Plan:
Repeatedly update draft and check that sync runs correctly without
deleting it.

Reviewers: spang

Reviewed By: spang

Differential Revision: https://review.inboxapp.com/D794"
emfree,2014-11-25 00:37:27,https://api.github.com/repos/nylas/sync-engine/git/commits/a288cc9a7c72c48d368c805abadf44c96dfc2c7f,a288cc9a7c72c48d368c805abadf44c96dfc2c7f,Handle event create API requests that lack Content-Type header.
kav-ya,2014-11-19 23:32:39,https://api.github.com/repos/nylas/sync-engine/git/commits/98fc234dd64ac2df455aa11ffd8e729c2d3c505f,98fc234dd64ac2df455aa11ffd8e729c2d3c505f,"Search tests -
Refresh ES index after recreation so tests pass with repeated creation/deletion.
Test bulk indexing."
emfree,2014-11-24 07:22:18,https://api.github.com/repos/nylas/sync-engine/git/commits/b5cba48e2ba9ac148746a7c946d4acc80b3a6368,b5cba48e2ba9ac148746a7c946d4acc80b3a6368,"Allow database queue pool max overflow to be set in config.

For the sync workload we really want a small pool size and a large max
overflow, but in any case it makes sense for both parameters to be tunable."
emfree,2014-11-22 22:48:06,https://api.github.com/repos/nylas/sync-engine/git/commits/a2273386aa7b2416ed3ec36e0f9f4ab64945ca3b,a2273386aa7b2416ed3ec36e0f9f4ab64945ca3b,"Add support for rate-limiting the sending API.

Summary:
Limit each account to a quota of 300 sent messages (by default) in a rolling 24
hour window. The quota value can be changed via the DEFAULT_SENDING_LIMIT
config value.

Fixes T449.

Test Plan: Unit test added.

Reviewers: spang, kav-ya

Reviewed By: kav-ya

Maniphest Tasks: T449

Differential Revision: https://review.inboxapp.com/D796"
emfree,2014-11-22 04:53:41,https://api.github.com/repos/nylas/sync-engine/git/commits/da9963cf79ced2aa69380aa5d82391f02a3f5b79,da9963cf79ced2aa69380aa5d82391f02a3f5b79,Fix session scoping bug.
emfree,2014-11-22 02:28:57,https://api.github.com/repos/nylas/sync-engine/git/commits/9bc78165a2e0c29c408152e15697200b44a14b7f,9bc78165a2e0c29c408152e15697200b44a14b7f,Add syncback execution latency to logs.
emfree,2014-11-21 22:31:35,https://api.github.com/repos/nylas/sync-engine/git/commits/441fe710bc638a88abebaba05f5e8b1df49f3f3a,441fe710bc638a88abebaba05f5e8b1df49f3f3a,"Don't try to create IMAP folders before starting sync.

Summary:
This is breaking at least one custom IMAP account sync with `error: create
failed: u'[ALREADYEXISTS] Mailbox already exists'`.

Fixes T571.

Test Plan: Run test sync as sanity-check.

Reviewers: kav-ya

Reviewed By: kav-ya

Maniphest Tasks: T571

Differential Revision: https://review.inboxapp.com/D790"
khamidou,2014-11-21 18:05:13,https://api.github.com/repos/nylas/sync-engine/git/commits/0cdbae2a230c4916898cb3c70b4c9e4c4c03d749,0cdbae2a230c4916898cb3c70b4c9e4c4c03d749,typo
khamidou,2014-11-21 15:30:51,https://api.github.com/repos/nylas/sync-engine/git/commits/f32e5d11f9b2dc2ae7dddf0fcb6e86f73d25e248,f32e5d11f9b2dc2ae7dddf0fcb6e86f73d25e248,"Fixes to the system tests for event creation

Summary:
I made the events system tests pass for EAS (at least for the syncback operations we support on EAS -- namely creating and updating events)

Also, I fixed to additional auth bugs:
- we wouldn't take into account the Office365 MX servers when detecting providers
- we matched mx domains using `re.match` which matches only at the beginning of the line. I swapped this with `re.search` which gets us the behaviour we want (e.g: we can match inboxapp.mail.outlook.com using mail.outlook.com). Not sure if this would help with people getting unknown provider errors.

Test Plan: Ran the tests

Reviewers: emfree, kav-ya

Reviewed By: kav-ya

Differential Revision: https://review.inboxapp.com/D780"
spang,2014-11-20 23:50:50,https://api.github.com/repos/nylas/sync-engine/git/commits/a27e7215d290d8e839d76c9e2c7e90371f7304b6,a27e7215d290d8e839d76c9e2c7e90371f7304b6,"Fix error message pass through in API for events and drafts.

Summary:
I'm not sure how we ended up using `e.message` in the first place, but
as far as I can tell, it does not work. For example, try using an invalid
calendar ID when creating an event. You'll get a blank error message,
which makes debugging the request being sent very difficult.

I did not verify that this is the case for all of these API endpoints (I
just verified a couple of the events ones), but the code paths all look
similar to me.

Test Plan:
vagrant@precise64:/vagrant$ curl -X POST http://localhost:5555/n/dl75gys73g7t5ujkheyfauo2b/events -d '{ ""calendar_id"": ""foobar"", ""title"": ""Friday meeting"", ""when"": {""start_time"": ""1417233600"", ""end_time"": ""1417237200"" }, ""location"": ""Inbox HQ"", ""participants"": [ { ""email"": ""spang@inboxapp.com"", ""name"": ""Christine Spang"" } ] }'
{
  ""message"": ""Invalid calendar public id foobar"",
    ""type"": ""invalid_request_error""

whereas ""message"" was blank before, etc.

Reviewers: emfree

Reviewed By: emfree

Differential Revision: https://review.inboxapp.com/D784"
spang,2014-11-20 23:20:43,https://api.github.com/repos/nylas/sync-engine/git/commits/7c6c2de4fac9ec70ebb2d7aedc5b1f22048b365f,7c6c2de4fac9ec70ebb2d7aedc5b1f22048b365f,"Fix bad epoch quoting in events docs.

Start/end time parsing actually fails if you quote epoch timestamps.
They should be specified unquoted."
spang,2014-11-20 22:25:07,https://api.github.com/repos/nylas/sync-engine/git/commits/9228d52907363b5017061ebbd37322ad611e3ba9,9228d52907363b5017061ebbd37322ad611e3ba9,Also update note about syncback in the Calendars doc section
khamidou,2014-11-20 10:49:11,https://api.github.com/repos/nylas/sync-engine/git/commits/ded59c97ea01d7517ceef02013441a5f18478efd,ded59c97ea01d7517ceef02013441a5f18478efd,update docs to note that calendar events are synced back.
khamidou,2014-11-20 10:37:58,https://api.github.com/repos/nylas/sync-engine/git/commits/ebe2c4a7dac678ebadcda1dac357e85e35143b33,ebe2c4a7dac678ebadcda1dac357e85e35143b33,"System tests for events creation

Summary: This is a simple smoke test to check that event creation and deletion works. I'll be interested in your thoughts on whether it's necessary to test syncback (e.g: by connecting to the google backend and querying directly).

Test Plan: Ran the tests

Reviewers: emfree, kav-ya

Reviewed By: kav-ya

Subscribers: spang

Differential Revision: https://review.inboxapp.com/D772"
kav-ya,2014-11-20 01:15:41,https://api.github.com/repos/nylas/sync-engine/git/commits/ecfac199523a623bd6403767c3eb719d7cfcf2c4,ecfac199523a623bd6403767c3eb719d7cfcf2c4,Remove unused params in api/kellogs.encode()
kav-ya,2014-11-20 00:30:29,https://api.github.com/repos/nylas/sync-engine/git/commits/9e2466046681c64c2f4723609aa870f98b52d476,9e2466046681c64c2f4723609aa870f98b52d476,"Update more attrs in reconcile_message().

Summary:
Like full_body, msg.sanitized_body, msg.snippet need to be
updated when reconciled too.

Test Plan: Tests pass as before.

Reviewers: emfree

Reviewed By: emfree

Differential Revision: https://review.inboxapp.com/D777"
jennielees,2014-11-19 21:21:48,https://api.github.com/repos/nylas/sync-engine/git/commits/53cae8a7d95832a0f95a537468552254028a0668,53cae8a7d95832a0f95a537468552254028a0668,"Add a system test to check for expected broken accounts

Summary:
This is the system test for D765 and finishes up the sync engine side
of T495 - checking for All Mail folder and failing gracefully if it's
absent.

This test specifically adds another check in `test_auth` based on a
new list of live, bad credentials in accounts.py. It's purposefully
general, so other known bad credentials could be added if we want to
test for more error cases.

There are two changes required in Jenkins to make this run:

* Add another string parameter broken_accounts to identify
  broken test accounts.
* In the build script, after the line:
  `echo ""credentials = $test_accounts"" > tests/system/accounts.py`
  add:
  `echo ""broken_credentials = $broken_accounts"" >> tests/system/accounts.py`

It looks like I can make the changes myself but I'd appreciate input
from folks more familiar with the jenkins setup.

Test Plan: If you want to test locally, ping me for some broken credentials you can use.

Reviewers: emfree

Reviewed By: emfree

Subscribers: spang

Differential Revision: https://review.inboxapp.com/D773"
emfree,2014-11-19 02:29:20,https://api.github.com/repos/nylas/sync-engine/git/commits/86016cf23ac846d0de14e8b1aa998865c1097e0e,86016cf23ac846d0de14e8b1aa998865c1097e0e,Don't try to insert ImapUids we already have.
jennielees,2014-11-19 18:38:01,https://api.github.com/repos/nylas/sync-engine/git/commits/6cdc150ccccccf53ea105fc6b6bb68b2e3594f31,6cdc150ccccccf53ea105fc6b6bb68b2e3594f31,"Check for All Mail folder when creating Gmail accounts

Summary:
This is the sync engine half of T495. UI part in progress.

Adds a Gmail-specific config check to GmailAuthHandler.
This checks for an 'All Mail' folder before creating an account.
Throws a ConfigError for the UI to handle if the folder's not found.

Test Plan:
tests/general/test_folders.py - uses a mocked out auth handler.

System test using real credentials coming separately (per spang's suggestion).

Reviewers: emfree

Reviewed By: emfree

Subscribers: kav-ya, mg, spang

Differential Revision: https://review.inboxapp.com/D765"
khamidou,2014-11-19 18:01:55,https://api.github.com/repos/nylas/sync-engine/git/commits/29930db5ef9c1385b49710aa2d51a051075a1031,29930db5ef9c1385b49710aa2d51a051075a1031,"Fix broken syncing tests

Summary: In an epic feat of backpedaling, I realized that the ""refactors"" I made to the syncing algorithm made it susceptible to a race condition. I reverted the fixes and the tests now pass.

Test Plan: Ran the tests

Reviewers: emfree

Reviewed By: emfree

Subscribers: spang

Differential Revision: https://review.inboxapp.com/D770"
kav-ya,2014-11-19 03:51:37,https://api.github.com/repos/nylas/sync-engine/git/commits/d4e22cb9ecfada6a0cd3a54c499c14837264d1dd,d4e22cb9ecfada6a0cd3a54c499c14837264d1dd,"Script to delete the extra Folders for an EASAccount.

Summary: To back-fix the prod account affected by T600.

Test Plan: Will test against a restored snapshot.

Reviewers: emfree

Reviewed By: emfree

Differential Revision: https://review.inboxapp.com/D769"
spang,2014-11-19 01:55:32,https://api.github.com/repos/nylas/sync-engine/git/commits/d203d1cfb06ad8b0f2178ee43f729ccce2dbebb2,d203d1cfb06ad8b0f2178ee43f729ccce2dbebb2,"Temporarily proxy Gmail SMTP connections.

Investigating a spam issue."
filipposironi,2014-11-18 20:06:33,https://api.github.com/repos/nylas/sync-engine/git/commits/7f4ed7b6207fbcfca293683591a1c440ba73bb11,7f4ed7b6207fbcfca293683591a1c440ba73bb11,"Fix IMAP UIDVALIDITY for Gmail.

Summary:
This commit implements the resync_uids_from in GmailFolderSyncEngine.
Gmail makes our life easier here, we exploit the availability of
X-GM-MSGIDs to update the messages with their new UIDs and the folder
with the new UIDVALIDITY.

Close T601.

Test Plan:
Bring up a virtual machine, restore this
https://inboxapp.slack.com/files/emfree/F02V5ALCJ/bad_uidvalidity_dump.sql
database dump, run bin/inbox-start, and make sure the 'uidinvalid' folder gets
fixed.

Reviewers: spang, emfree

Subscribers: khamidou

Maniphest Tasks: T601

Differential Revision: https://review.inboxapp.com/D736"
emfree,2014-11-18 19:21:01,https://api.github.com/repos/nylas/sync-engine/git/commits/808d1d9c58bead062d73e63ecbf3cbde3ffa544f,808d1d9c58bead062d73e63ecbf3cbde3ffa544f,"Don't strip quoted text.

Summary:
Too unreliable for our use case without significant changes to Talon's
internals.

Test Plan: Run message-parsing unit tests.

Reviewers: spang, mg

Reviewed By: mg

Differential Revision: https://review.inboxapp.com/D761"
emfree,2014-11-18 01:18:45,https://api.github.com/repos/nylas/sync-engine/git/commits/64bb16e69f363d2f50061ac2295cfc33c448e2b6,64bb16e69f363d2f50061ac2295cfc33c448e2b6,"Add support for excluding object types from delta sync API.

Summary:
This allows clients who don't care about, say, calendar events to limit
the changeset they get from the /delta and /delta/streaming endpoints, for
better performance.

Test Plan: Unit tests updated.

Reviewers: khamidou

Subscribers: bengotow

Differential Revision: https://review.inboxapp.com/D757"
khamidou,2014-11-18 18:23:35,https://api.github.com/repos/nylas/sync-engine/git/commits/17b78b95290d762819e2e7ba81aaa5b503fe58d1,17b78b95290d762819e2e7ba81aaa5b503fe58d1,"Silence some flake8 errors

Summary:
I find some flake8 errors very annoying, particularly those about hanging indent. This code triggers a flake8 error:
```
very_long_function_name(
      param1, param2, param3)
```
While this one does not:
```
very_long_function_(
param1, param2, param3)
```

I personally find the former way more readable. This diff disables this warning.

Test Plan: Manual tests.

Reviewers: emfree, kav-ya

Reviewed By: kav-ya

Differential Revision: https://review.inboxapp.com/D759"
khamidou,2014-11-18 18:21:58,https://api.github.com/repos/nylas/sync-engine/git/commits/57c8702512044a3afe1563773d5c935d9ae727ec,57c8702512044a3afe1563773d5c935d9ae727ec,"Support for multiple Google Calendars + a bunch of fixes

Summary: This diff adds support for syncing and syncback of all the calendars available to an user. I also fixed some ""bugs"" with the syncback code -- notably, it's now possible to add participants to an event.

Test Plan: Tested manually.

Reviewers: emfree, kav-ya

Reviewed By: kav-ya

Subscribers: spang

Projects: #sync-engine

Maniphest Tasks: T613

Differential Revision: https://review.inboxapp.com/D745"
grinich,2014-11-03 00:46:44,https://api.github.com/repos/nylas/sync-engine/git/commits/ad155959bd36e308edaf5c2634797bba5ba164e6,ad155959bd36e308edaf5c2634797bba5ba164e6,fail gently when checking git commit
dlitz,2014-11-18 00:09:42,https://api.github.com/repos/nylas/sync-engine/git/commits/c6d3c4ebf8398e06b3598738011534debcfd702f,c6d3c4ebf8398e06b3598738011534debcfd702f,"docker: Support for running non-root cron/anacron jobs installed to /srv/cron.{hourly,daily,weekly,monthly}/

Test Plan: Ran inbox; ran 'ps'; saw that /usr/sbin/cron was running

Reviewers: spang

Subscribers: colhom

Differential Revision: https://review.inboxapp.com/D749"
filipposironi,2014-11-17 21:01:27,https://api.github.com/repos/nylas/sync-engine/git/commits/0627559aba0dbe643fdf520eabdff2dc0e5b46eb,0627559aba0dbe643fdf520eabdff2dc0e5b46eb,"Add draft infrastructure to monitor the sync status.

Summary:
This commit introduces a draft infrastructure to monitor the sync
status. When an account monitor starts a new folder engine, the folder
engine ctor instantiates an object of type SyncStatus and eagerly signal
its presence to the world by publishing a timestamp on Redis with a key
composed of the account and folder identifier (this makes searches for
all folders of a given account really simple with a ""regex"" like
""(<account idenfitier>, *)"").
As of now, folder engines keeps signaling their ""state"" every 60 seconds
(this is a configurable parameter at SyncStatus instantiation) and
eagerly do so when the ""state"" changes (e.g., on startup or state
transition).

NOTE: reducing the interval between subsequent signal operations (e.g.,
from 60 to 10 seconds) may not work correctly since the folder engines
are sleeping for ""poll_frequency"" and might also idle. This should not
be a huge limitation since having up to date monitoring within a minute
should be totally reasonable.

WARNING: This commit also add a very primitive script to flush ALL the
keys of ALL the dbs handled by the Redis instance pointed by the
REDIS_HOSTNAME, REDIS_PORT contained in /etc/inboxapp/config.json.

Add Redis configuration parameters to etc/config-test.json.

NOTE: this revision also revert a few commits I made on when I was ""playing""
with sync status.

Test Plan:
Nothing really. You can see very basic information by accessing Redis from its
CLI. Try redis-cli from within the virtual machine and then scan 0 while
accounts are sycing.

Reviewers: kav-ya, emfree

Reviewed By: emfree

Subscribers: spang

Differential Revision: https://review.inboxapp.com/D746"
khamidou,2014-11-17 13:09:26,https://api.github.com/repos/nylas/sync-engine/git/commits/5ac6d74e20c04cdab37647c77588bbe355458aa3,5ac6d74e20c04cdab37647c77588bbe355458aa3,better names
emfree,2014-11-16 23:01:12,https://api.github.com/repos/nylas/sync-engine/git/commits/76063204ee6ef4f34ff9e999681eef38cf651874,76063204ee6ef4f34ff9e999681eef38cf651874,"Remove RETRY_FAIL_CLASSES in mailsync.

For better or for worse, we really have to keep retrying on things like
transient IntegrityErrors due to race condition, or strange errors raised in
message parsing."
emfree,2014-11-16 20:36:45,https://api.github.com/repos/nylas/sync-engine/git/commits/d1c4259ed66fee0b29628197d459d0af58bf42c7,d1c4259ed66fee0b29628197d459d0af58bf42c7,"Also catch ValueError in message parsing.

Summary: This will let us diagnose T612.

Test Plan: None.

Reviewers: khamidou

Differential Revision: https://review.inboxapp.com/D751"
dlitz,2014-11-14 05:18:13,https://api.github.com/repos/nylas/sync-engine/git/commits/398eb945a4b6769e7ddc0640d69d43895f9b437b,398eb945a4b6769e7ddc0640d69d43895f9b437b,blockhead
dlitz,2014-11-13 17:36:56,https://api.github.com/repos/nylas/sync-engine/git/commits/fa3047a54380e0422752af21b60414690a7f5944,fa3047a54380e0422752af21b60414690a7f5944,"config: Support loading config from INBOX_CFG_PATH environment variable

Summary:
This makes it easier to change the configuration from within a
separate development environment.

Test Plan: None

Reviewers: colhom, spang

Reviewed By: spang

Differential Revision: https://review.inboxapp.com/D739"
dlitz,2014-11-13 17:36:39,https://api.github.com/repos/nylas/sync-engine/git/commits/f119697535556083631872e62ead72577d1a9027,f119697535556083631872e62ead72577d1a9027,"Support Docker-based development environment

Summary:
- Merge Dockerfile.base -> Dockerfile
- ""docker build ."" now works.
- ""fig build && fig up"" now works.

The full command I use to build everything from clean sources is:

    sudo git clean -dfx && chmod -R u=rwX,g=rX,o=rX . && git-set-mtimes && fig build && fig up -d && fig logs

git-set-mtimes ensures that we don't build the requirements more often
than we have to.  It comes from here:

    https://raw.githubusercontent.com/docker-library/official-images/0bb1458242ca42b1ff117da9b7aed076c68688fc/bashbrew/git-set-mtimes

Test Plan:
    fig build && fig run inbox tox

(Note: Some tests seem to fail right now for some reason, but this
appears to be unrelated to this change.)

Reviewers: colhom, spang

Reviewed By: spang

Differential Revision: https://review.inboxapp.com/D738"
dlitz,2014-11-13 03:39:55,https://api.github.com/repos/nylas/sync-engine/git/commits/9fcdc3da1f3d1e1011bcc1fee7b6f7491cfe579e,9fcdc3da1f3d1e1011bcc1fee7b6f7491cfe579e,"Fix exception in break_to_interpreter when running with a PID < 1024 (i.e. Docker)

Test Plan:
Check that the service no longer fails when running under
Docker.

Reviewers: khamidou

Reviewed By: khamidou

Differential Revision: https://review.inboxapp.com/D733"
kav-ya,2014-11-13 00:30:08,https://api.github.com/repos/nylas/sync-engine/git/commits/aa8f80c2e78c697cb5b03072ec8a3e120ae3f370,aa8f80c2e78c697cb5b03072ec8a3e120ae3f370,"Support for ES nested objects, basic nested queries.
Note: does not support cross parent/child nested relations.

Plus, test search response returns complete API repr."
kav-ya,2014-11-12 19:49:08,https://api.github.com/repos/nylas/sync-engine/git/commits/193ab019fc63b7863dc6a9dd79a85ed8b06ccf02,193ab019fc63b7863dc6a9dd79a85ed8b06ccf02,Fix ES datetime field parse error.
filipposironi,2014-11-12 23:41:25,https://api.github.com/repos/nylas/sync-engine/git/commits/373cccd96be2de68c775c192aef56b2a4017d9a2,373cccd96be2de68c775c192aef56b2a4017d9a2,"Add Redis its dependencies and configuration.

Summary:
Modify setup.sh to install and configure redis. setup.sh downloads
redis-2.8.17, which is the same available through AWS (Debian/Ubuntu's version
is far too old), compiles and installs it (through stow), configures it using
the utils/install_server.sh redis.io distributes.

Add Redis configuration parameters to etc/config-dev.json (nothing for
etc/config-test.json yet).

Test Plan:
Bring up a new virtual machine and make sure Redis is running by connecting
through redis-cli. Fire up the Python console and run the following piece of
code to make sure the redis pip package works correctly:

```
from redis import StrictRedis

client = StrictRedis(host='localhost')
print client.ping()
```

Reviewers: dlitz, kav-ya

Reviewed By: kav-ya

Subscribers: emfree

Differential Revision: https://review.inboxapp.com/D730"
filipposironi,2014-11-12 21:48:23,https://api.github.com/repos/nylas/sync-engine/git/commits/eb929246f22a721bfb0ee928e0c6e3f6fbe166d1,eb929246f22a721bfb0ee928e0c6e3f6fbe166d1,"Remove unnecessary chmod commands from setup.sh.

Summary:
Commit e540d08add1161e301f563b12cc8f182a2fed0b0 removes `cp` commands,
which are followed by `chmod 644` commands (introduced in
a84e8be0c84b62ad099dd0ba38a352a9795b103d as a first fix to non-standard
umasks), in favor off `install -m0644` commands to copy configuration
files from the host to the guest. This makes `chmod 644` commands
useless.

Test Plan:
Create a brand new virtual machine starting with vagrant up and make sure
/etc/inboxapp/config.json and /etc/inboxapp/secrets.yml are world-readable.

Reviewers: dlitz

Reviewed By: dlitz

Differential Revision: https://review.inboxapp.com/D663"
spang,2014-11-12 19:10:16,https://api.github.com/repos/nylas/sync-engine/git/commits/528a1b8125820b259a526f9c12f609388f2f87b7,528a1b8125820b259a526f9c12f609388f2f87b7,Bump version in setup.py
khamidou,2014-11-12 18:28:51,https://api.github.com/repos/nylas/sync-engine/git/commits/1b960ba9ffac469a4b24d02468395d23f2e7b118,1b960ba9ffac469a4b24d02468395d23f2e7b118,"Fix events IntegrityError for Esper and other accounts

Summary:
Hey,

This one was super annoying. I was expecting some crazy concurrency bug with Kavya's dual-sync but in the end the bug was much more lame. EAS is actually sending us some duplicate events -- my guess is that in some cases editing an event creates a duplicate event with the exact same `UID` but different `ServerIds`. Madness.

My solution is to assume the event with the highest ServerId is the most recent one. Instead of trying to dedupe the list of events we get from EAS I chose to `flush()` the session whenever we add a new event. This solves the problem because in the case where we get a duplicate event it's considered as an update of the older event which makes the code work.

Test Plan: Tested on prod ;) More seriously, this fixed Esper's test account.

Reviewers: emfree, kav-ya

Reviewed By: kav-ya

Subscribers: spang

Projects: #eas, #sync-engine

Maniphest Tasks: T556

Differential Revision: https://review.inboxapp.com/D731"
kav-ya,2014-11-11 19:31:19,https://api.github.com/repos/nylas/sync-engine/git/commits/90c3ced24a0a89473dd275c0e5a79ca3c19b8021,90c3ced24a0a89473dd275c0e5a79ca3c19b8021,"Script to delete the extra EASDevices for an account.

Summary:
Certain EASAccounts have more than one pair of EASDevices due to reauth. I plan to roll out a
real fix for the issue shortly (updated: revision D727).
To back-fix, prune the superseded EASDevice pairs for these accounts.

Test Plan:
Tested on a prod replica.

Planning to run online in prod -
There are 6 affected accounts, the script takes ~5minutes to run (due to the EASUid deletes).

Reviewers: emfree

Reviewed By: emfree

Differential Revision: https://review.inboxapp.com/D726"
emfree,2014-11-11 20:49:09,https://api.github.com/repos/nylas/sync-engine/git/commits/bfc9aa2f7a3d9c1eb8c3e85390e6f1bb060d7371,bfc9aa2f7a3d9c1eb8c3e85390e6f1bb060d7371,"Add logging when assertion fails in blob saving.

Summary:
This is happening on prod, bafflingly. Add some logging so we can see what's
up.

Test Plan: None.

Reviewers: kav-ya

Reviewed By: kav-ya

Differential Revision: https://review.inboxapp.com/D723"
spang,2014-11-10 22:19:21,https://api.github.com/repos/nylas/sync-engine/git/commits/432a7e1a14f3c35d84a677d8a26d61fc0dd3c46e,432a7e1a14f3c35d84a677d8a26d61fc0dd3c46e,"-Document docker env var naming conventions.
-Uncomment client base my.cnf"
colhom,2014-11-08 01:31:52,https://api.github.com/repos/nylas/sync-engine/git/commits/a93f4a70737d329b44537f8d9cec0816b23f5a04,a93f4a70737d329b44537f8d9cec0816b23f5a04,"-update my.cnf, dockerfile stuff now expects to be one directory level up
-clear out pyc files and chown source dir to admin in Dockerfile
-attempt to grab mysql host/port info from docker link env vars before falling back to config file"
emfree,2014-11-10 22:17:24,https://api.github.com/repos/nylas/sync-engine/git/commits/14e4894045ca0041c3dec155789c35e5aed5e33c,14e4894045ca0041c3dec155789c35e5aed5e33c,"Allow Gmail threads to be split among multiple Inbox threads.

Summary:
This is a short-term fix for an uncommon situation that nonetheless breaks
sync. See T599 for details.

Test Plan:
Trigger the breaking condition by sending multiple identical emails;
check that they're reconciled correctly, and that replies get threaded with the
message they're replying to.

Reviewers: spang, kav-ya

Reviewed By: kav-ya

Differential Revision: https://review.inboxapp.com/D713"
kav-ya,2014-11-08 00:19:10,https://api.github.com/repos/nylas/sync-engine/git/commits/51f06fe6c979eea20bda76b2461b69413b99cdce,51f06fe6c979eea20bda76b2461b69413b99cdce,"Script to delete ES namespace indexes.
Needed to change mappings (for e.g. to support nested queries)."
emfree,2014-11-07 22:26:41,https://api.github.com/repos/nylas/sync-engine/git/commits/2d3ec8c3dbea4ff2dc0d4f796499ad7922515eff,2d3ec8c3dbea4ff2dc0d4f796499ad7922515eff,"Reject sending to an empty list of recipients.

Previously we'd just reject your post body if you didn't include the recipients
field at all.

Fixes T589."
emfree,2014-11-06 19:53:36,https://api.github.com/repos/nylas/sync-engine/git/commits/f7b9e4a2efd88cbcff482c4862f55103d76aea57,f7b9e4a2efd88cbcff482c4862f55103d76aea57,"Ensure syncs are restarted if necessary after reauth.

Summary:
This is a bit of a stopgap fix for the problem of syncs not being automatically
restarted if they were previously stopped because of invalid credentials, but
the user actually reauths.

Test Plan:
Set test account state to invalid; check that sync gets restarted
after reauth.

Reviewers: kav-ya

Differential Revision: https://review.inboxapp.com/D701"
emfree,2014-11-06 04:54:53,https://api.github.com/repos/nylas/sync-engine/git/commits/130208d3d84857afe041fceeec2f954fb29d5813,130208d3d84857afe041fceeec2f954fb29d5813,"Remove unnecessary imports from util/rdb.py.

Summary: Fixes T592.

Test Plan: Run unit test suite.

Reviewers: khamidou

Maniphest Tasks: T592

Differential Revision: https://review.inboxapp.com/D697"
kav-ya,2014-11-06 22:46:21,https://api.github.com/repos/nylas/sync-engine/git/commits/f211304f7d321259e78cfe1ec58b027be79df507,f211304f7d321259e78cfe1ec58b027be79df507,"Optimize namespace indexing script.

Summary:
1. Parallelize - 2 greenlets per namespace, one for messages + one for threads)
2. Use ES.bulk_index() to index - uses default chunk_size of 500.
3. Use safer_yield_per to load messages, threads.

Test Plan:
None (run locally but doesn't count!)
Will run on staging.

Reviewers: emfree

Reviewed By: emfree

Differential Revision: https://review.inboxapp.com/D707"
kav-ya,2014-11-07 01:54:16,https://api.github.com/repos/nylas/sync-engine/git/commits/c793401befa1efed0b5ad1eb77809c23f6855372,c793401befa1efed0b5ad1eb77809c23f6855372,Fix ES thread mapping.
kav-ya,2014-11-06 22:10:15,https://api.github.com/repos/nylas/sync-engine/git/commits/62089a158cecc1c98540f70e92582769c6341ee9,62089a158cecc1c98540f70e92582769c6341ee9,Log search errors in ns_api.py.
filipposironi,2014-11-06 19:42:00,https://api.github.com/repos/nylas/sync-engine/git/commits/0a356c3e87149680a986b3bff77cd786a4dce01f,0a356c3e87149680a986b3bff77cd786a4dce01f,"Eagerly signal sync status.

Summary:
The greenlet executing the sync engine wasn't talking to the sync status
consumer greenlet till the first state transition.
This commit fixes this misbehavior.

Test Plan:
Verifying the previously present bug is kind of tricky, I just noticed it
because I was working on replicating the sync status on Redis.

Reviewers: khamidou, emfree

Reviewed By: emfree

Differential Revision: https://review.inboxapp.com/D698"
emfree,2014-11-06 03:44:10,https://api.github.com/repos/nylas/sync-engine/git/commits/a385931b2a4fc970651e9fc0384d2ce12e0df1a2,a385931b2a4fc970651e9fc0384d2ce12e0df1a2,Fix indentation typo in Gmail throttling.
emfree,2014-11-05 21:02:00,https://api.github.com/repos/nylas/sync-engine/git/commits/6a4af9d06bb867ac141c9030865d05da58241838,6a4af9d06bb867ac141c9030865d05da58241838,Fix outdated docstring.
kav-ya,2014-11-05 11:15:16,https://api.github.com/repos/nylas/sync-engine/git/commits/3b02c0662c8431264c34a71004640994e11f7056,3b02c0662c8431264c34a71004640994e11f7056,Define THROTTLE_WAIT in mailsync/base.py
khamidou,2014-11-05 19:48:27,https://api.github.com/repos/nylas/sync-engine/git/commits/629604a5ecdfa3933857dcc2f5ec18a3ada14744,629604a5ecdfa3933857dcc2f5ec18a3ada14744,"Calendar bug fixes

Summary:
This diff fixes a bunch of bugs with the Gmail calendars.

The most egregious one is a weird issue with the mapping we used to assign participants to an event. I changed it to use one of SQLAlchemy's default mapping.

There's also a couple fixes in the way we handle changes in events -- previously we'd barf if an event field was updated on the server. I modified the merging strategy to ""barf if setting an field to None"". I think this should be okay most of the time and eventually consistent.

Finally, I changed the gmail update code to export more of our db fields.

Also, I think I'm going to release code like this, in daily batches. This should make thing easier to review.

Test Plan: Tested manually.

Reviewers: kav-ya, emfree

Reviewed By: kav-ya, emfree

Subscribers: spang

Projects: #sync-engine

Differential Revision: https://review.inboxapp.com/D693"
dlitz,2014-11-05 00:38:56,https://api.github.com/repos/nylas/sync-engine/git/commits/2fed3a76df71e5c584f128752afd28a00d4b46c5,2fed3a76df71e5c584f128752afd28a00d4b46c5,"requirements: Update 'requests' from v2.3.0 to v2.4.3

Summary: This lets us use use the `json` parameter in a request.

Test Plan: Ran `pip install -r requirements.txt`

Reviewers: spang, emfree

Reviewed By: emfree

Differential Revision: https://review.inboxapp.com/D686"
emfree,2014-11-05 01:26:07,https://api.github.com/repos/nylas/sync-engine/git/commits/5970881226cefae7de12d13ae565aaff82a6d6d5,5970881226cefae7de12d13ae565aaff82a6d6d5,"Revert to forked flanker with upstream fixes.

They still can't unicode; breaks everything."
dlitz,2014-11-05 00:12:03,https://api.github.com/repos/nylas/sync-engine/git/commits/a5b64e69b635e92049f936c89d3f070288c5c749,a5b64e69b635e92049f936c89d3f070288c5c749,bin/providers-as-json: Pretty-print JSON & use deterministic sort ordering
dlitz,2014-10-30 17:54:23,https://api.github.com/repos/nylas/sync-engine/git/commits/3caac942684986e1e09efcab7f34c6f7892f098b,3caac942684986e1e09efcab7f34c6f7892f098b,"Add support for using tox to run tests

Summary:
tox aims to automate and standardize testing in Python.  See docs:
http://tox.readthedocs.org/

If you have tox installed (`pip install tox`), you can now run the tests
simply by running `tox` in the same directory as tox.ini.

Test Plan: Installed tox; Ran tox.

Reviewers: emfree, kav-ya

Reviewed By: kav-ya

Subscribers: khamidou, siro

Differential Revision: https://review.inboxapp.com/D657"
khamidou,2014-11-04 19:08:00,https://api.github.com/repos/nylas/sync-engine/git/commits/0087a28ece82935137513af738f64d526c231687,0087a28ece82935137513af738f64d526c231687,"Basic syncback for google calendars

Summary:
This is a basic implementation of syncback. I did two things:
- adapted the syncback code to handle additional actions. I copied the structure of the IMAP syncback code: there's a inbox.events.actions which mirrors inbox.actions, with a backend/ subfolder.
- wrote a syncback module for gmail. So far, it only supports saving to the primary calendar.

Test Plan: Tested manually.

Reviewers: kav-ya, emfree

Reviewed By: emfree

Subscribers: spang

Projects: #sync-engine

Differential Revision: https://review.inboxapp.com/D679"
khamidou,2014-11-04 18:34:39,https://api.github.com/repos/nylas/sync-engine/git/commits/60a8d31694ba1bf12755e8bf39bcedc38ac18383,60a8d31694ba1bf12755e8bf39bcedc38ac18383,"Fixes nameerror on prod

Summary: https://app.getsentry.com/inbox/prod/group/38940736/ -- I mistakenly removed an import while refactoring this part of the code.

Test Plan: That's an import.

Reviewers: emfree

Reviewed By: emfree

Differential Revision: https://review.inboxapp.com/D680"
kav-ya,2014-10-26 00:37:17,https://api.github.com/repos/nylas/sync-engine/git/commits/0f3bd8d7264aca1b7d97387a0781a71e93de52ee,0f3bd8d7264aca1b7d97387a0781a71e93de52ee,"Search v1.0: Thread, message search for a namespace.

Summary:
1. Script to create an Elasticsearch index for each namespace and index its Threads, Messages
s.t. they can be queried on both thread/message attributes.

2. DSL query constructor to construct Elasticsearch DSL queries for
* no restrictions/ field-restricted/ all fields
* exact phrase/ any match
* equally weighted/ boosted
searches.

3. API functions.
4. Docs.

Test Plan:
Tests for:
Index creation.
Thread, message search.
Cross-attribute search.

Reviewers: emfree

Reviewed By: emfree

Differential Revision: https://review.inboxapp.com/D672"
filipposironi,2014-11-04 08:05:38,https://api.github.com/repos/nylas/sync-engine/git/commits/7d16221d5150271a992d12b5a1c57a4dd302966a,7d16221d5150271a992d12b5a1c57a4dd302966a,"Fix T569.

Summary:
resync_uids() was correctly asking for an additinal paramter... self.
However, being a closure, it takes self directly from the environment,
thus we don't need to declare it.

Test Plan:
Just sync a bunch of accounts, we should not encounter the TypeError reported
in https://review.inboxapp.com/T569 anymore. We should see a
NotImplementedError, which should be gracefully by the retry wrapper.

Reviewers: dlitz, khamidou, emfree

Reviewed By: emfree

Subscribers: spang

Differential Revision: https://review.inboxapp.com/D677"
filipposironi,2014-11-03 08:10:30,https://api.github.com/repos/nylas/sync-engine/git/commits/d6f84bc5d42bed6ac9c199ea72e9a1ed88920c48,d6f84bc5d42bed6ac9c199ea72e9a1ed88920c48,"Fix for ArcanistBaseUnitTestEngine deprecation.

Summary:
As reported in https://secure.phabricator.com/D9983 arcanist deprecated
a few base classes. Among them there is ArcanistBaseUnitTest, which we
were using.

As suggested by arcanist itself, PytestTestEngine now extends
ArcanistUnitTestEngine instead of ArcanistBaseUnitTestEngine.

Test Plan:
Checkout 52947cfd92b331916adffa1ff3233546446c881b for arcanist and
43a0b6d17bb097d76ef5ef936c91fa7448212cc2 for libphutil to see the warning
message from arcanist.
This patch removes the warning message.

Note: this patch may require all the developers to update their version of
arcanist and libphtil.

Reviewers: emfree

Reviewed By: emfree

Subscribers: spang, khamidou, kav-ya, emfree, dlitz

Differential Revision: https://review.inboxapp.com/D665"
filipposironi,2014-11-03 08:09:30,https://api.github.com/repos/nylas/sync-engine/git/commits/9c42e06cdfd22d5f1bdc4ebb79cee10c99c5cbe0,9c42e06cdfd22d5f1bdc4ebb79cee10c99c5cbe0,"Refactor folder sync status management.

Summary:
Every sync monitor creates a single reader/multiple writer queue, which
will contain folder sync status events. The sync monitor spawns an
additional greenlet to consume the events in the aforementioned queue
(i.e., consumer greenlet). Greenlets executing the sync engine (i.e.,
producer greenlets) don't perform table (ImapFolderSyncStatus) updates
anymore; they push events to the queue, which is consumed by the
consumer greenlet that is in charge of performing table updates.

Events are tuples consisting of a folder identifier and the new state of
the producer greenlet managing said folder. The consumer greenlet keeps
a map from the folder identifier to the table (ImapFolderSyncStatus)
entry.

Test Plan:
Fire up the virtual machine, start bin/inbox-start and bin/inbox-auth to added
a few accounts. Start bin/redwood-start admin and double-check that folder sync
status gets changed from 'initial' to 'poll'.
This set of changes should not modify the behavior of inbox as a system.

Reviewers: khamidou, emfree

Reviewed By: emfree

Differential Revision: https://review.inboxapp.com/D656"
filipposironi,2014-11-02 02:12:51,https://api.github.com/repos/nylas/sync-engine/git/commits/716d1aa40534666b702a760722b7b8211b1d9bc3,716d1aa40534666b702a760722b7b8211b1d9bc3,"Switch from dnspython 1.12.0 to dnspython 1.11.1 .

Summary:
flanker 0.4.22 requires dnsq>=1.1.3. The latest version of dnsq
available is 1.1.3, which requires dnspython=1.11.1.
Wwe were installing dnspython 1.12.0 since
0e0f70614df2a3992e037e760a7097056ed17859 to avoid
https://github.com/rthalley/dnspython/issues/31 .
8a4b8c96eeffb950194c088df18ebe5437f2dcf2 of dnspython fixes the
aforementioned issue and is included in dnspython 1.11.1 so we safely
un-bump it.

Test Plan:
Create a new virtual machine from master (as is, before this fix), start
bin/inbox-start from /vagrant . /vagrant/inbox/util/startup.py should complain
indicating flanker 0.4.22 as the offending package (we should definitely
improve our error reporting on this kind of issues). bin/inbox-start won't
actually start.
Doing the same with this patch should solve the issue.

Reviewers: dlitz, emfree

Reviewed By: emfree

Differential Revision: https://review.inboxapp.com/D664"
emfree,2014-11-02 00:11:18,https://api.github.com/repos/nylas/sync-engine/git/commits/7fb3772fdced3dd005ad724f6bbe078824657f73,7fb3772fdced3dd005ad724f6bbe078824657f73,"Return actual deltas in the streaming API; consolidate code.

Summary:
Instead of sending basically just a ping, `/delta/streaming` now returns actual
change responses, in the same format as the existing `/delta` endpoint.

Concretely, this means that response chunks look something like this (formatted
for clarity):
```
{
    ""cursor"": ""4ya4oyxo7rurxamyt9brfju5b"",
    ""object"": ""thread"",
    ""event"": ""update"",
    ""id"": ""71ormxuivtg52p141tpgjk3vi"",
    ""attributes"": {
        ""namespace_id"": ""f3b0j663wmm2bluq77uc4db9m"",
        ""tags"": [{""name"": ""drafts"", ""id"": ""drafts""},
                 {""name"": ""starred"", ""id"": ""starred""}],
        ""last_message_timestamp"": 1414778436,
        ""object"": ""thread"",
        ""message_ids"": [],
        ""snippet"": """",
        ""participants"": [],
        ""draft_ids"": [""diu1tytx7p9wnx64hdbxsypqe""],
        ""first_message_timestamp"": 1414778436,
        ""id"": ""71ormxuivtg52p141tpgjk3vi"",
        ""subject"": ""Hello World!""
    }
}
```
The ""cursor"" value can be used to fetch subsequent changes if the client is
disconnected. As a client, you can keep track of the cursor for the latest
event you've processed, and query
`/n/<namespace_id>/delta/streaming?cursor=<cursor>` to get all changes starting
from that point and onwards.

To this end, consolidate logic for the `/delta` and `/delta/streaming`
endpoints, and update docstrings, etc.

Test Plan: Unit tests added/updated.

Reviewers: spang, kav-ya

Reviewed By: kav-ya

Differential Revision: https://review.inboxapp.com/D667"
emfree,2014-11-01 21:18:24,https://api.github.com/repos/nylas/sync-engine/git/commits/85baadee4f3d9155432c8c18927ffa5125d0292c,85baadee4f3d9155432c8c18927ffa5125d0292c,"[SCHEMA] Simplify transaction log construction; rework delta sync.

Summary:
Implement a leaner and meaner transaction log:

* Instead of storing an ORM-derived 'delta', only store a snapshot of the API
  representation of the versioned object. We weren't using the delta for
  anything.

* This lets us simplify the rather hairy ORM-history-inspection we were doing
  to figure out whether to create an update revision or not. On versioned
  objects, we just look at column-mapped attributes, and at relationship
  attributes named in the `versioned_relationships` property. If any of these
  have changes, we create a revision.
  (We don't look at all relationship attributes, because you don't
  need to version a Message instance if it gets a new ImapUid, for example.)

* Simplify and consolidate the revision creation code.

* Simplify the construction of delta sync responses.

Fixes T567.

Test Plan: Unit tests added.

Reviewers: spang, kav-ya

Reviewed By: kav-ya

Maniphest Tasks: T567

Differential Revision: https://review.inboxapp.com/D655"
emfree,2014-10-31 04:42:33,https://api.github.com/repos/nylas/sync-engine/git/commits/7c1dd109cb65cae69ca2567068fa4426b755f310,7c1dd109cb65cae69ca2567068fa4426b755f310,"Apply gevent monkey-patching before running tests.

Fixes test failure."
grinich,2014-10-30 23:30:46,https://api.github.com/repos/nylas/sync-engine/git/commits/8cbc2f18ffeb0212d10e2087fca444c1b3e740e3,8cbc2f18ffeb0212d10e2087fca444c1b3e740e3,"Switch to mainline flanker

Summary:
Our fork for flanker is out of date and my previous bugs have been fixed by them in other commits. Our fork only had 3 changes.

This issue is closed and I validated the fix: https://github.com/mailgun/flanker/pull/36#issuecomment-50381678

Do we still need this? Can we configure our VM to use the proper DNS server elsewhere? https://github.com/inboxapp/flanker/commit/ecbb70a133324fb5e6ff06b9546456905c7537aa

And I believe this was fixed in some other flanker commit: https://github.com/inboxapp/flanker/commit/32524df59b2ff27fd3236073210bde750ae4b24b

At least one user has also complained about decoding errors that are probably likely to our fork being left behind. I couldn't replicate the error with the latest version on PyPI.

I'm not sure the best way to get this deployed since our `pip install` has been cloing our fork locally. Running setup.sh worked in my VM to overwrite our fork with the new version, but this might need some TLC during production rollout.

Test Plan: All tests should still pass.

Reviewers: spang, emfree

Reviewed By: emfree

Differential Revision: https://review.inboxapp.com/D661"
emfree,2014-10-30 19:19:58,https://api.github.com/repos/nylas/sync-engine/git/commits/e88ce11037d2de9f4e6f56f861e482c762605275,e88ce11037d2de9f4e6f56f861e482c762605275,"Create canonical tag objects at Namespace creation time.

Summary:
We assume that tags like 'sent' and 'drafts'are always available, for example
in the drafts/sending API functionality, but we previously only ensured
that they existed when we started a sync. This only caused problems.

Instead, just create the tag objects when a new Namespace is initialized.

Test Plan: Run unit tests; auth and sync an account.

Reviewers: kav-ya

Reviewed By: kav-ya

Differential Revision: https://review.inboxapp.com/D659"
khamidou,2014-10-30 13:59:33,https://api.github.com/repos/nylas/sync-engine/git/commits/e7ebc570a7448b5d8def2a35b736c9253c317247,e7ebc570a7448b5d8def2a35b736c9253c317247,"Store labels in ImapUid

Summary:
This is a minimal patch to store label information per-folder. Note that this is only about storing data, not updating thread info using it.

I'd like you to take a look at the MutableList class I've added -- this SQLAlchemy thing is black magic.

There's one big question though: how do we update this info in prod? I was thinking we could have a one-off program that would go through every message of every account and query label information but this sounds super complicated to get right.

Test Plan: Ran a sync.

Reviewers: kav-ya, emfree

Reviewed By: emfree

Projects: #sync-engine

Differential Revision: https://review.inboxapp.com/D617"
emfree,2014-10-29 22:07:15,https://api.github.com/repos/nylas/sync-engine/git/commits/820dc487fd2b8516c26dacfb603053bfedacfb42,820dc487fd2b8516c26dacfb603053bfedacfb42,"Add super simple streaming API endpoint.

Summary:
This commit adds support for a long-polling API changes endpoint at
/n/<namespace_id>/delta/streaming. Soon we can directly stream the same updates
as the old delta sync endpoint, but for the moment we just send a really basic
ping when there are changes detected.

Test Plan: Unit tests added.

Reviewers: bengotow, kav-ya

Reviewed By: kav-ya

Subscribers: spang

Differential Revision: https://review.inboxapp.com/D647"
emfree,2014-10-29 19:40:53,https://api.github.com/repos/nylas/sync-engine/git/commits/0ec8902e5accf61196bcce6e5cda0334452732fe,0ec8902e5accf61196bcce6e5cda0334452732fe,Fix OutlookAuthHandler.create_account() arguments.
emfree,2014-10-28 23:00:55,https://api.github.com/repos/nylas/sync-engine/git/commits/16d3d068be21dc8e9c0c3958b54ce26e366946ee,16d3d068be21dc8e9c0c3958b54ce26e366946ee,Remove unused code.
khamidou,2014-10-29 13:37:40,https://api.github.com/repos/nylas/sync-engine/git/commits/65af06a91970c5ac83fea8d19ab7337a5425f74c,65af06a91970c5ac83fea8d19ab7337a5425f74c,fix migration branch
khamidou,2014-10-29 13:35:47,https://api.github.com/repos/nylas/sync-engine/git/commits/2c5292fefd259f5dfc881e71d9bb17274090af9f,2c5292fefd259f5dfc881e71d9bb17274090af9f,"Implement a ""raw"" message endpoint

Summary: This patch adds a new endpoint: ""/messages/<id>/rfc2822"" which returns the raw message.

Test Plan: Ran the code.

Reviewers: emfree

Reviewed By: emfree

Projects: #sync-engine

Differential Revision: https://review.inboxapp.com/D640"
kav-ya,2014-10-28 19:06:18,https://api.github.com/repos/nylas/sync-engine/git/commits/60129ee94e21030d4f5ffb992a2839cd57261ffe,60129ee94e21030d4f5ffb992a2839cd57261ffe,Fix post cherry-pick migration ordering.
kav-ya,2014-10-20 20:26:02,https://api.github.com/repos/nylas/sync-engine/git/commits/d9b9920d52020dd6e6232b1fc6de80d52a5be634,d9b9920d52020dd6e6232b1fc6de80d52a5be634,"[SCHEMA] EAS Two-Device-Per-Account migrations.

Also,
Add BaseMailSyncMonitor._cleanup()
Move thread state fns out of BaseMailSyncMonitor.
Update bin/clear-db.

And,
Migration to fix EASUid cascade deletes.

Summary: Matching changes to D629.

Test Plan: None

Reviewers: emfree

Reviewed By: emfree

Differential Revision: https://review.inboxapp.com/D632"
emfree,2014-10-25 22:13:17,https://api.github.com/repos/nylas/sync-engine/git/commits/8a5f9305472b0d3ad5cdd59bfdeb27f1870ecf2d,8a5f9305472b0d3ad5cdd59bfdeb27f1870ecf2d,"Add super simple search interface and indexing script to API.

Test Plan: None, for now.

Reviewers: kav-ya

Reviewed By: kav-ya

Differential Revision: https://review.inboxapp.com/D644"
emfree,2014-10-25 18:37:48,https://api.github.com/repos/nylas/sync-engine/git/commits/a3a0a079ad172a1434510ce62b6206429ad5d560,a3a0a079ad172a1434510ce62b6206429ad5d560,Also fix create_account parameters in unit tests.
emfree,2014-10-25 17:58:33,https://api.github.com/repos/nylas/sync-engine/git/commits/3b98ea4b52f248f629b04124529d232f88ee53de,3b98ea4b52f248f629b04124529d232f88ee53de,Fix typos in OAuth interactive auth.
emfree,2014-10-25 01:41:30,https://api.github.com/repos/nylas/sync-engine/git/commits/441ef94cb2922e05f12362552a469f15537e60cf,441ef94cb2922e05f12362552a469f15537e60cf,"Add support for user-provided IMAP settings; refactor auth.

Summary:
This commit implements support for user-provided IMAP and SMTP settings, along
with related cleanup and refactoring in the auth code.

* Allow IMAP and SMTP endpoints for ImapAccounts to be overridden on a
  per-account basis.
* Define a ""custom"" provider for accounts with such overrides.
* Refactor auth modules to move functionality into AuthHandler classes.
* Refactor OAuth code, consolidating functionality split between the
  inbox.oauth and inbox.auth.oauth modules.
* Define interactive_auth() method on AuthHandler subclasses, to handle the
  flow of authing via bin/inbox-auth. Previously, this functionality was partly
  implemented in create_auth_account functions, and partly scattered.

Test Plan:
Add unit tests; add account with custom settings and ensure that
sync and sending works; run bin/inbox-auth for different account types.

Reviewers: charles

Reviewed By: charles

Differential Revision: https://review.inboxapp.com/D639"
khamidou,2014-10-24 16:32:21,https://api.github.com/repos/nylas/sync-engine/git/commits/24fc7746fc621e3b2e95d035ab3659272cdf476d,24fc7746fc621e3b2e95d035ab3659272cdf476d,"Spawn a remote debugger in a separate greenlet

Summary: This code adds support for spawning a remote debugger if the DEBUG_CONSOLE_ON is specified. The debuggers listens on localhost on port $PID for telnet connections. It gives access to a simple REPL with the possibility of using the heapy heap profiler to inspect the heap.

Test Plan: Ran the code.

Reviewers: emfree, charles

Reviewed By: charles

Projects: #sync-engine

Differential Revision: https://review.inboxapp.com/D637"
dlitz,2014-10-24 15:52:37,https://api.github.com/repos/nylas/sync-engine/git/commits/e540d08add1161e301f563b12cc8f182a2fed0b0,e540d08add1161e301f563b12cc8f182a2fed0b0,"[build/setup.sh] Fix install permissions when the host has umask 0077

Test Plan:
- Add ""umask 0077"" to my .bashrc
- vagrant destroy
- vagrant up --provision
- Check the permissions of
  /usr/local/lib/python2.7/dist-packages/pip-1.5.6.egg-info/entry_points.txt
  inside the VM.  It should be world-readable.

Reviewers: siro

Reviewed by: siro"
emfree,2014-10-23 22:04:45,https://api.github.com/repos/nylas/sync-engine/git/commits/5a7833ee25e1a12ef3347f54a7d6f17b292eb1b0,5a7833ee25e1a12ef3347f54a7d6f17b292eb1b0,Fix set_starred syncback actions.
khamidou,2014-10-23 09:51:06,https://api.github.com/repos/nylas/sync-engine/git/commits/8df36b6740ef6518aa581b79a7e05846288dfd48,8df36b6740ef6518aa581b79a7e05846288dfd48,"The one where we create a special case just for iCloud

Summary:
iCloud is pretty weird: sending an email from SMTP/IMAP doesn't save it under the ""Sent"". This patch introduces a special case for iCloud and a new action to save a message (`save_sent_message`).

I'd like to have your opinion on this, especially about the default vars I added to make things work.

Test Plan: Ran test_sending.py and checked that two files were created.

Reviewers: kav-ya, emfree

Reviewed By: emfree

Projects: #sync-engine

Maniphest Tasks: T478

Differential Revision: https://review.inboxapp.com/D631"
emfree,2014-10-22 22:34:53,https://api.github.com/repos/nylas/sync-engine/git/commits/132ace9ae71e19c26219562d3300c0bd28611c57,132ace9ae71e19c26219562d3300c0bd28611c57,"Ensure we can log message decoding errors from non-ASCII folder names.

Test Plan: Regression test added.

Reviewers: kav-ya

Reviewed By: kav-ya

Differential Revision: https://review.inboxapp.com/D636"
dlitz,2014-10-22 23:00:29,https://api.github.com/repos/nylas/sync-engine/git/commits/b0c925a439282d38d2cb027c83a6065a96aa77dd,b0c925a439282d38d2cb027c83a6065a96aa77dd,"[build/setup.sh] Add libsodium setup to install flow.

Summary:
Workaround for the ""error: sodium.h: No such file or directory"" bug in
pynacl and/or cffi: https://github.com/pyca/pynacl/issues/79

Fixes https://github.com/inboxapp/inbox/issues/95

Test Plan: `vagrant up --provision` from scratch

Reviewers: charles

Reviewed By: charles

Subscribers: mg

Differential Revision: https://review.inboxapp.com/D635"
khamidou,2014-10-22 14:55:16,https://api.github.com/repos/nylas/sync-engine/git/commits/5c328795a8b958521eaa2805418d31f88e3fc6fc,5c328795a8b958521eaa2805418d31f88e3fc6fc,"Merge pull request #96 from filipposironi/master

setup: changed config file mode bits"
filipposironi,2014-10-22 14:46:08,https://api.github.com/repos/nylas/sync-engine/git/commits/a84e8be0c84b62ad099dd0ba38a352a9795b103d,a84e8be0c84b62ad099dd0ba38a352a9795b103d,"setup: changed config file mode bits

Changed the configuration file mode bits from 600 to 644 for the
/etc/inboxapp/config.json and /etc/inboxapp/secrets.yml configuration
files to avoid issues when starting bin/inbox-start."
emfree,2014-10-21 16:15:59,https://api.github.com/repos/nylas/sync-engine/git/commits/2358692d82f447ff02b9eb744f94401ac233f4fe,2358692d82f447ff02b9eb744f94401ac233f4fe,"Specify gevent.event import.

You can't do
```
import gevent
e = gevent.event.Event()
```
before monkeypatching, which mostly may affect tests."
khamidou,2014-10-21 10:05:18,https://api.github.com/repos/nylas/sync-engine/git/commits/a6a539a14225e5fc6a5790ce283cd8883774d4a3,a6a539a14225e5fc6a5790ce283cd8883774d4a3,"Handle threads spanning multiple folders in generic actions

Summary:
This is a diff that fixes T501 and T549. It's only a proof of concept on the generic actions. Here's some of the changes:
- refactor the generic actions to remove `syncback_action`. The whole higher-order stuff was used only because we wanted to retry actions and it didn't mesh well with executing the same action on multiple folders. Also note that the code doesn't care about retrying things on IMAP failures because (in theory) the syncback service handles this for us.
- I made some cleanups to the syncback code and I bundled some fixes to the tests (sorry but this branch originally started as test fixes).

Test Plan: Ran the actions on a fastmail account.

Reviewers: kav-ya, emfree

Reviewed By: emfree

Projects: #sync-engine

Maniphest Tasks: T501

Differential Revision: https://review.inboxapp.com/D622"
emfree,2014-10-20 22:43:19,https://api.github.com/repos/nylas/sync-engine/git/commits/95aecacc478acd466d32e2a6653f1411ae2a7b8b,95aecacc478acd466d32e2a6653f1411ae2a7b8b,"[SCHEMA] Properly cascade folder deletions to imap bookkeeping.

Summary:
If we sync a folder deletion from the remote, we have to cascade it to
ImapFolderInfo and ImapFolderSyncStatus rows, or we get
```
IntegrityError: (IntegrityError) (1048, u""Column 'folder_id' cannot be null"")
'UPDATE imapfoldersyncstatus SET updated_at=%s, folder_id=%s WHERE
imapfoldersyncstatus.id = %s' (datetime.datetime(2014, 10, 20, 19, 22, 47,
851225), None, 1524)
```

Note that we already do precisely this cascade for ImapUids.

Test Plan: Regression test added.

Reviewers: kav-ya

Reviewed By: kav-ya

Differential Revision: https://review.inboxapp.com/D633"
dlitz,2014-10-15 01:45:56,https://api.github.com/repos/nylas/sync-engine/git/commits/9b5e4ebd5ec15863b3e7308621b943c98eb5409b,9b5e4ebd5ec15863b3e7308621b943c98eb5409b,"Add providers-as-json script

Test Plan: Run the test

Reviewers: kav-ya

Reviewed By: kav-ya

Differential Revision: https://review.inboxapp.com/D621"
kav-ya,2014-10-20 20:43:25,https://api.github.com/repos/nylas/sync-engine/git/commits/1aac15c77727e7a94185e2fc1901b29c73671b38,1aac15c77727e7a94185e2fc1901b29c73671b38,Fix args in save_draft().
emfree,2014-10-17 03:43:41,https://api.github.com/repos/nylas/sync-engine/git/commits/2c29579dbeea08b77caccea40a97388bf0a7652f,2c29579dbeea08b77caccea40a97388bf0a7652f,"Add godaddy to providers file.

Summary: Stopgap for now until we support custom IMAP settings.

Test Plan: None, don't have test account :(

Reviewers: charles

Reviewed By: charles

Differential Revision: https://review.inboxapp.com/D628"
emfree,2014-10-17 01:05:01,https://api.github.com/repos/nylas/sync-engine/git/commits/33a6d162eaf25e3441b13e7fa206ebd793b95f51,33a6d162eaf25e3441b13e7fa206ebd793b95f51,Remove extraneous diff.
emfree,2014-10-17 00:34:25,https://api.github.com/repos/nylas/sync-engine/git/commits/5046041e51efd1116b84848b835c6be8e8c9bbb7,5046041e51efd1116b84848b835c6be8e8c9bbb7,Fix variable definition.
emfree,2014-10-16 19:40:15,https://api.github.com/repos/nylas/sync-engine/git/commits/9a5e93f908264710bfbe02a97023e390e7c77c87,9a5e93f908264710bfbe02a97023e390e7c77c87,"Implement fallback DNS query for NoAnswer; add postini MX servers.

Test Plan: Regression tests added.

Reviewers: charles

Reviewed By: charles

Differential Revision: https://review.inboxapp.com/D626"
emfree,2014-10-16 17:25:46,https://api.github.com/repos/nylas/sync-engine/git/commits/6ab85023b5d0333b457627c0f21d69fbd2d17b2a,6ab85023b5d0333b457627c0f21d69fbd2d17b2a,"Use a more performant IMAP command for CONDSTORE queries.

Summary:
Doing a search by MODSEQ is deadly slow on Gmail, but doing
FETCH 1:* (...) (CHANGEDSINCE <modseq>) is pretty fast, particularly for modseq
values close to the highest modseq.

Note that this commit changes the semantics of
CrispinClient.new_and_updated_uids(modseq): previously, this would return UIDs
with MODSEQ >= modseq. Now it returns UIDs with MODSEQ > modseq. But this is
also what we actually want whenever we call it.

Test Plan:
Run both the old and new IMAP commands for a bunch of
randomly-chosen modseq values, and check that they return consistent results.

Reviewers: spang

Reviewed By: spang

Differential Revision: https://review.inboxapp.com/D625"
emfree,2014-10-15 23:09:22,https://api.github.com/repos/nylas/sync-engine/git/commits/886d48112add7867c1e240ed75ecad2f14675696,886d48112add7867c1e240ed75ecad2f14675696,Limit contact subqueries by namespace for API filtering performance.
kav-ya,2014-10-15 22:01:42,https://api.github.com/repos/nylas/sync-engine/git/commits/6a54dda102d8d6e36285371131cf57506616eb4f,6a54dda102d8d6e36285371131cf57506616eb4f,Fix migration 108.
emfree,2014-10-14 20:39:08,https://api.github.com/repos/nylas/sync-engine/git/commits/c859a02426e5ad69c1cbcb8623d99173600029f0,c859a02426e5ad69c1cbcb8623d99173600029f0,"[SCHEMA] Add account.name column, and ""name"" attribute to API namespaces.

Summary:
Right now we have this for Gmail and Outlook, and set it from the OAuth
response. But we really need to save this for all accounts, so that we can set
the `From:` header appropriately when sending mail. (We'll add a field to the
login form for generic/eas accounts.) Also expose it in the API's namespace
representation.

Test Plan: Run migration; curl /n/ endpoint.

Reviewers: kav-ya

Reviewed By: kav-ya

Differential Revision: https://review.inboxapp.com/D620"
emfree,2014-10-14 06:10:16,https://api.github.com/repos/nylas/sync-engine/git/commits/ffe133406d57f0d370104261bcedcb993908cba2,ffe133406d57f0d370104261bcedcb993908cba2,"[SCHEMA] Add index on thread table for improved API performance.

Summary:
Diminishes API response times for /n/<ns_id>/threads?tag=inbox from >10 seconds
to ~780ms.

Test Plan:
Run migration script; benchmark against read replica of prod DB with
and without index.

Reviewers: khamidou

Reviewed By: khamidou

Differential Revision: https://review.inboxapp.com/D616"
kav-ya,2014-10-11 21:22:44,https://api.github.com/repos/nylas/sync-engine/git/commits/68cb497b91a9f9b03b45e48648980ffd2d31d681,68cb497b91a9f9b03b45e48648980ffd2d31d681,"Fix reconcile_messages() regression to only reconcile with local Inbox-created messages.

Summary:
Filtering by the inbox-uid header alone is not sufficient; more than one
message on the remote backend may have the same inbox-uid header.
Reconciliation should only occur with messages created locally, not messages synced;
that is incorrect and also causes issues like T550.

Test Plan: Regression test in inbox-eas.

Reviewers: emfree

Reviewed By: emfree

Differential Revision: https://review.inboxapp.com/D596"
emfree,2014-10-11 22:45:01,https://api.github.com/repos/nylas/sync-engine/git/commits/3ccb2f48d84a7a2b62c87c35f18930d5cb2c7c32,3ccb2f48d84a7a2b62c87c35f18930d5cb2c7c32,Add clarifying comment.
emfree,2014-10-11 18:32:35,https://api.github.com/repos/nylas/sync-engine/git/commits/b01e87dc67264b63966f585bfffe7b3b82a4ea85,b01e87dc67264b63966f585bfffe7b3b82a4ea85,"Improve connection error handling in IMAP syncback actions.

Summary:
Previously, when executing IMAP syncback actions, we'd catch our custom
ConnectionError/TransientConnectionError exceptions. This makes no sense
whatsoever, because those are only thrown when a connection is authed, and with
connection pooling, connection auth always happens asynchronously in a separate
greenlet.

But what can happen is that the syncback action fails with a socket error; see
T554. Handle this using the same retry_crispin decorator that we use to handle
analogous socket errors in IMAP sync.

Test Plan: System tests.

Reviewers: kav-ya

Reviewed By: kav-ya

Differential Revision: https://review.inboxapp.com/D595"
dlitz,2014-10-08 22:44:46,https://api.github.com/repos/nylas/sync-engine/git/commits/0a17c6cbaeab4870578e1da4e135d14b872b7a8f,0a17c6cbaeab4870578e1da4e135d14b872b7a8f,"[auth] Pluggable auth handlers with pluggable mixin classes

Summary:
This will allow plugins to hook into the auth process, e.g. to redirect IMAP
connections to a proxy, or to modify the login information.

Test Plan:
- Unit tests
- Manual testing

Reviewers: charles

Subscribers: kav-ya, emfree

Differential Revision: https://review.inboxapp.com/D571"
kav-ya,2014-10-10 18:45:36,https://api.github.com/repos/nylas/sync-engine/git/commits/d772663fb9f703ae3b7477ab2d997d3942b13f44,d772663fb9f703ae3b7477ab2d997d3942b13f44,"Simplify account sync start logic.

Summary:
This commit simplifies our sync start logic.

Our whole sync start/stop/reporting deal is due for an overhaul
but till that happens, this makes the sync start/stop +
admin dash interaction easier to understand and faster to debug.

Other changes included:
1. Remove sync_type - never used.
2. Always update sync_start_time - this is what the dash displays.
If we want the original sync_start time, we can go look at the db.

Test Plan:
Started a sync.
While it ran, authed another account.
While both ran, stopped the first.
Restarted the first.

Please do stare at it carefully nonetheless.

Reviewers: emfree, charles

Reviewed By: charles

Differential Revision: https://review.inboxapp.com/D591"
emfree,2014-10-10 21:33:08,https://api.github.com/repos/nylas/sync-engine/git/commits/6759aa7677421ba7ab1660f9bd7dfee0f56ebe5f,6759aa7677421ba7ab1660f9bd7dfee0f56ebe5f,"Unify invalid credential handling across event/contact syncs.

Summary:
One of the reasons our error count is so high is that we try to sync contacts
for invalid accounts every five minutes and log a bunch of errors. To be
consistent with events sync, simply exit the sync loop in such cases.

Test Plan: Unit test added.

Reviewers: charles

Reviewed By: charles

Differential Revision: https://review.inboxapp.com/D588"
emfree,2014-10-10 19:50:17,https://api.github.com/repos/nylas/sync-engine/git/commits/9d4e58549bad2f9a23ceb403dc109559ed78402c,9d4e58549bad2f9a23ceb403dc109559ed78402c,"Fix uidvalidity_valid check.

Summary:
It appears that server UIDVALIDITY values sometimes *decrease*.  Per RFC3501
the server is supposed to *increase* the UIDVALIDITY if UIDS are actually
invalid. So it should in theory be safe to ignore a decremented UIDVALIDITY? In
practice, that appears to be the case for the actually affected accounts.

Anyways, flip the comparison. Fixes T471, sort of.

Test Plan: Stare at code; RFC.

Reviewers: spang

Reviewed By: spang

Maniphest Tasks: T471

Differential Revision: https://review.inboxapp.com/D583"
khamidou,2014-10-10 09:58:21,https://api.github.com/repos/nylas/sync-engine/git/commits/a4ac4e56ea1c7631311139c55f9ebda11333d3dd,a4ac4e56ea1c7631311139c55f9ebda11333d3dd,"Limit the maximum number of retries for failed actions

Summary:
Currently a failed action will run until it works -- for some of them, it means running forever. This diff limits the number of retries to 20 and adds a specific log message when giving up on an action.

It should be interesting to have add to the kibana dashboard a panel with the top failing actions and accounts.

Test Plan:
Ran an always failing action -- checked that it worked
Ran a working action -- checked that it worked

Reviewers: kav-ya, emfree

Reviewed By: kav-ya, emfree

Projects: #sync-engine

Differential Revision: https://review.inboxapp.com/D562"
emfree,2014-10-10 01:12:04,https://api.github.com/repos/nylas/sync-engine/git/commits/32f0f24c3e6846e7f1b0922839b326ff0d8ea43e,32f0f24c3e6846e7f1b0922839b326ff0d8ea43e,"Don't fail in syncback when a Gmail account has no labels.

Summary:
It's entirely possible for the result of GmailCrispinClient.folder_names() to
not contain a 'labels' key. Previously this could cause syncback actions to
fail with KeyError.

Test Plan:
Check that the unarchive action can now succeed for a test account
with no labels.

Reviewers: kav-ya

Reviewed By: kav-ya

Differential Revision: https://review.inboxapp.com/D582"
emfree,2014-10-10 00:14:53,https://api.github.com/repos/nylas/sync-engine/git/commits/98332b7a4cda0633680b109f12ea65278fbdfa6d,98332b7a4cda0633680b109f12ea65278fbdfa6d,"Fix UID command errors in actions syncback.

Summary:
* Chunk UID fetch in generic IMAP syncback.  Fixes ""BAD ['Command line too
  large']"" error when there are lots of messages in a trash folder, and you try
  to fetch the headers for all of them.

* Make crispin_client.copy_uids a no-op when the uids argument is empty,
  instead of trying to issue a malformed command. Fixes T500.

Test Plan:
Check via bin/inbox-console that offending IMAP commands no longer
raise errors.

Reviewers: kav-ya

Reviewed By: kav-ya

Maniphest Tasks: T500

Differential Revision: https://review.inboxapp.com/D580"
dlitz,2014-10-08 11:08:24,https://api.github.com/repos/nylas/sync-engine/git/commits/33c766e9a7a72d503febb2bb750876fb9414636e,33c766e9a7a72d503febb2bb750876fb9414636e,"[auth] provider_info now accepts an email address argument

Test Plan: Added a unit test.  Ran the unit tests.

Reviewers: kav-ya, charles, emfree

Reviewed By: emfree

Projects: #cypress

Differential Revision: https://review.inboxapp.com/D570"
dlitz,2014-10-08 08:24:10,https://api.github.com/repos/nylas/sync-engine/git/commits/b473785570593faaf962d5ed631398868eb375e2,b473785570593faaf962d5ed631398868eb375e2,"[auth] Rename private functions: auth_account, supports_condstore

Summary:
Make it clear that these functions are not part of the auth-module
interface.

Test Plan: Unit tests and running the app (as part of a larger test)

Reviewers: emfree, charles

Reviewed By: charles

Subscribers: kav-ya

Projects: #cypress

Differential Revision: https://review.inboxapp.com/D569"
dlitz,2014-10-08 08:22:08,https://api.github.com/repos/nylas/sync-engine/git/commits/0d00f986b0f3c7ea112ce41104e88e941653b921,0d00f986b0f3c7ea112ce41104e88e941653b921,"[auth] Remove unused `delete_account()` function

Summary:
This was added by Karim in 7d9244507bfc0a62b300ae036879c94d8c7682d2,
but the last reference to it was subsequently removed by Charles in
e5d98fdf2cf8bca566a822bb54f4a6ad18ce63b5.

Test Plan: Nothing much.  Nothing calls this, as far as grep tells me.

Reviewers: charles, emfree, khamidou

Reviewed By: emfree

Projects: #cypress

Differential Revision: https://review.inboxapp.com/D568"
kav-ya,2014-10-09 20:11:06,https://api.github.com/repos/nylas/sync-engine/git/commits/4ba1ead42123aa0c79d4dfa1e6af5383afb98add,4ba1ead42123aa0c79d4dfa1e6af5383afb98add,Fix a NoneType error on sync start/stop.
khamidou,2014-10-08 08:32:22,https://api.github.com/repos/nylas/sync-engine/git/commits/00d71b768986dc3b4f0e29ef82f4320972e26dd4,00d71b768986dc3b4f0e29ef82f4320972e26dd4,"Log current greenlet

Summary: Log the currently executing greenlet.

Test Plan: Ran the service and checked the log output.

Reviewers: emfree

Reviewed By: emfree

Projects: #sync-engine

Differential Revision: https://review.inboxapp.com/D564"
spang,2014-10-04 22:06:49,https://api.github.com/repos/nylas/sync-engine/git/commits/ad0191927ac45bcdc78926579adef33955c34954,ad0191927ac45bcdc78926579adef33955c34954,"Disable SyncException triggered by folder name change.

Summary:
There's not really any reason why we shouldn't just... update the folder
to the new name. This occurs when e.g. users on Gmail change their
locale. And as far as I can tell, never otherwise. We expect the backend
account provider to return the correct mapping if the name changes,
rather than us bailing out here and not handling the case.

Tags are named by `canonical_name`, so they do not need to be updated
when the folder name changes as long as the folder row remains the same
(same id).

Fixes T4.

Test Plan:
Manually changed locale in Gmail UI for locally syncing account, verified
folders list, changed back, verified folders list again. Also manually verified
that logic for dealing with ""dangled"" Gmail IMAP folders (core folders which
have been disabled via the ""Show in IMAP"" checkbox) still works.

Reviewers: khamidou

Maniphest Tasks: T4

Differential Revision: https://review.inboxapp.com/D553"
grinich,2014-10-07 21:01:13,https://api.github.com/repos/nylas/sync-engine/git/commits/479e4b1ee8a33b95d0f45154b6f186c83289da67,479e4b1ee8a33b95d0f45154b6f186c83289da67,"add yandex settings

closes #90"
emfree,2014-10-07 18:49:39,https://api.github.com/repos/nylas/sync-engine/git/commits/a7839ee731f0b32c95b05e31cf6982bd36dd0f01,a7839ee731f0b32c95b05e31cf6982bd36dd0f01,Fix broken queries in API.
khamidou,2014-10-07 09:59:43,https://api.github.com/repos/nylas/sync-engine/git/commits/73f3dc4e6394e6b3d90f1d7bcb17111c1afac831,73f3dc4e6394e6b3d90f1d7bcb17111c1afac831,"Add support for &view=ids to the API

Summary: Basic support + minimal tests

Test Plan: Manual tests + ran the unit tests.

Reviewers: emfree

Reviewed By: emfree

Projects: #sync-engine

Differential Revision: https://review.inboxapp.com/D545"
emfree,2014-10-07 05:37:42,https://api.github.com/repos/nylas/sync-engine/git/commits/589b632cd30521911c68b9003d385d9b0e635625,589b632cd30521911c68b9003d385d9b0e635625,"Fix deletion of non-Inbox created drafts.

Summary:
* Arguments were misordered when calling remote_delete().
* Don't select All Mail before moving UIDs to the trash -- otherwise, if
  you want to delete a draft on a thread, you might delete the whole thread!
  Arguably, the real shortcoming is that all our actions are assumed to
  operate on threads. But for now, let's at least do the right thing.

Test Plan:
Check that we can actually delete a draft created in the Gmail web
UI.

Reviewers: kav-ya

Reviewed By: kav-ya

Differential Revision: https://review.inboxapp.com/D560"
emfree,2014-10-07 04:09:37,https://api.github.com/repos/nylas/sync-engine/git/commits/8964bf839b7ee6a4dcc02fdf9c53a4b5e0164752,8964bf839b7ee6a4dcc02fdf9c53a4b5e0164752,"Fail gracefully when syncing back a missing draft.

Summary:
This can happen if, for example, the draft is deleted before saving it
succeeds.

Test Plan: Stare at code.

Reviewers: kav-ya

Reviewed By: kav-ya

Differential Revision: https://review.inboxapp.com/D561"
emfree,2014-10-07 03:42:04,https://api.github.com/repos/nylas/sync-engine/git/commits/8bf7311edc471cb045ec9a6fa25190b68e9dfeec,8bf7311edc471cb045ec9a6fa25190b68e9dfeec,Update retry_with_logging to work with new retry semantics.
emfree,2014-10-07 02:44:12,https://api.github.com/repos/nylas/sync-engine/git/commits/bac4088c34bc3266c4be1303b07e2dfaa4a57ea9,bac4088c34bc3266c4be1303b07e2dfaa4a57ea9,"Fix logging in retry decorator.

If we catch an exception we don't want to retry on, don't execute
exc_callback() -- otherwise we get confusing log messages."
kav-ya,2014-10-05 03:44:02,https://api.github.com/repos/nylas/sync-engine/git/commits/924518bca5cb10d38df8ba4d150e3114a7d71d1f,924518bca5cb10d38df8ba4d150e3114a7d71d1f,"EAS AD may require username.

Summary:
1. Console auth flow permits username to be entered for password_auth.
2. Migration to add easaccount.username easaccount.eas_auth columns.

Test Plan:
Run the console auth flow.
Run the migration on test db.

Reviewers: khamidou, emfree

Reviewed By: emfree

Differential Revision: https://review.inboxapp.com/D554"
emfree,2014-10-07 01:42:19,https://api.github.com/repos/nylas/sync-engine/git/commits/aadd45fa430654ff09ee94fa27177afd3daf332e,aadd45fa430654ff09ee94fa27177afd3daf332e,Fix merge error in tests.
emfree,2014-10-07 00:15:33,https://api.github.com/repos/nylas/sync-engine/git/commits/b14952bc4df7ec25e9700bfcbc27fa1228722d46,b14952bc4df7ec25e9700bfcbc27fa1228722d46,"Don't disable autoflush in IMAP update_metadata().

Summary:
As the included regression test illustrates, invoking
imap.common.update_metadata() could fail when
* You add a label 'some_new_label' to thread A and thread B.
* We haven't seen 'some_new_label' before
* We sync the changes to threads A and B at the same time.

In such a case, disabling autoflush would lead us to try to create the
'some_new_label' tag twice, this would fail at flush time with an
IntegrityError.

Test Plan: Unit test added.

Reviewers: kav-ya

Reviewed By: kav-ya

Maniphest Tasks: T518

Differential Revision: https://review.inboxapp.com/D557"
kav-ya,2014-10-07 00:42:07,https://api.github.com/repos/nylas/sync-engine/git/commits/42181f5e42220a2359295ff7145199d18db39e02,42181f5e42220a2359295ff7145199d18db39e02,"Fix T521, T552: Data too long for raw_data (Event, Contact) tables.

Summary: Two EAS prod account errors.

Test Plan: None.

Reviewers: emfree

Reviewed By: emfree

Differential Revision: https://review.inboxapp.com/D558"
khamidou,2014-10-06 13:11:52,https://api.github.com/repos/nylas/sync-engine/git/commits/9f006ceca1f8d83dcadbe3ecc33b747c504a7c17,9f006ceca1f8d83dcadbe3ecc33b747c504a7c17,added message_id to the stack locals whitelist
emfree,2014-10-06 06:08:21,https://api.github.com/repos/nylas/sync-engine/git/commits/c3959af393eaba75dc5c92f345bd638531e22e70,c3959af393eaba75dc5c92f345bd638531e22e70,"Catch TypeError in message parsing.

This is a temporary measure, so that we can properly debug the following
exciting new error in flanker, and not have it break mailsync entirely.

```
Traceback (most recent call last):
	  File ""/srv/inbox/inbox/util/concurrency.py"", line 74, in wrapped
    return func(*args, **kwargs)
	  File ""/srv/inbox/inbox/mailsync/backends/imap/generic.py"", line 194, in _run_impl
    self.state = self.state_handlers[old_state]()
	  File ""/srv/inbox/inbox/util/concurrency.py"", line 74, in wrapped
    return func(*args, **kwargs)
	  File ""/srv/inbox/inbox/mailsync/backends/imap/generic.py"", line 233, in initial_sync
    self.initial_sync_impl(crispin_client)
	  File ""/srv/inbox/inbox/mailsync/backends/gmail.py"", line 156, in initial_sync_impl
    self.__download_queued_threads(crispin_client, download_stack)
	  File ""/srv/inbox/inbox/mailsync/backends/gmail.py"", line 336, in __download_queued_threads
    message.g_metadata.thrid, thread_uids)
	  File ""/srv/inbox/inbox/mailsync/backends/gmail.py"", line 391, in __download_thread
    crispin_client, crispin_client.selected_folder_name, uids)
	  File ""/srv/inbox/inbox/mailsync/backends/gmail.py"", line 290, in download_and_commit_uids
    raw_messages, self.create_message)
	  File ""/srv/inbox/inbox/mailsync/backends/base.py"", line 130, in create_db_objects
    uid = msg_create_fn(db_session, acc, folder, msg)
	  File ""/srv/inbox/inbox/mailsync/backends/imap/generic.py"", line 333, in create_message
    msg)
	  File ""/srv/inbox/inbox/mailsync/backends/imap/common.py"", line 239, in create_imap_message
    body_string=msg.body)
	  File ""/srv/inbox/inbox/models/message.py"", line 239, in create_from_synced
    msg._parse_mimepart(mimepart, mid, i, account.namespace.id)
	  File ""/srv/inbox/inbox/models/message.py"", line 284, in _parse_mimepart
    if mimepart.content_disposition[0] is not None:
	  File ""/usr/local/lib/python2.7/dist-packages/flanker/mime/message/part.py"", line 403, in content_disposition
    return self.headers.get('Content-Disposition', WithParams(None))
	  File ""/usr/local/lib/python2.7/dist-packages/flanker/mime/message/part.py"", line 389, in headers
    return self._container.headers
	  File ""/usr/local/lib/python2.7/dist-packages/flanker/mime/message/part.py"", line 42, in headers
    self._load_headers()
	  File ""/usr/local/lib/python2.7/dist-packages/flanker/mime/message/part.py"", line 65, in _load_headers
    self.stream.seek(self.start)
	TypeError: an integer is required
```"
spang,2014-10-05 01:26:24,https://api.github.com/repos/nylas/sync-engine/git/commits/83f850f9bbb340371106b4ce5ef6a12586d294e9,83f850f9bbb340371106b4ce5ef6a12586d294e9,Fix NoneType error in remove_messages().
spang,2014-10-04 18:00:38,https://api.github.com/repos/nylas/sync-engine/git/commits/5186004abe86a4884bcd03e741abacdefbe39cd1,5186004abe86a4884bcd03e741abacdefbe39cd1,"Strip message body parts.

Fixes a ParserError where we accidentally try to do quote extraction
from blank HTML."
spang,2014-10-04 03:42:48,https://api.github.com/repos/nylas/sync-engine/git/commits/dc9495e4e0a2ed59188c95975e8d8c2994e50001,dc9495e4e0a2ed59188c95975e8d8c2994e50001,Call crispin_client.select_folder() with proper args.
emfree,2014-10-04 01:30:31,https://api.github.com/repos/nylas/sync-engine/git/commits/6f38a4b441fff4efe50838e2e9279ecb3d415c32,6f38a4b441fff4efe50838e2e9279ecb3d415c32,Ensure All Mail folder is selected when doing thread download.
emfree,2014-10-04 00:58:42,https://api.github.com/repos/nylas/sync-engine/git/commits/09c68921605df036f9e50abc5b898495f049564a,09c68921605df036f9e50abc5b898495f049564a,"Allow Gmail inbox and All Mail initial syncs to proceed in parallel.

Summary:
This is, for now, the most straightforward way for us to get changes to mail
that's not in the inbox while the inbox initial sync is ongoing.

Main changes:
* We do thread expansion in both the All Mail and inbox syncs.
* Thread downloads are serialized via the thread_download_lock, so that we
  don't end up trying to download the same thread twice concurrently. We might
  not *technically* have to do this, but it's definitely easier to reason
  about.

Arguably a better approach would be to have one greenlet responsible for
downloading, one for checking changes on the inbox, and one for checking
changes on All Mail, instead of having two download threads. But that's a
refactor for another day.

Associated changes:
 * Don't cache g_metadata on disk. Gnarly stuff can happen with the
   highestmodseq update, in which you're syncing, your change poller greenlet
   detects a changed highestmodseq, so you get the uids, put them on the
   download queue and update your saved highestmodseq. Then you kill the
   process. Now when you restart, you have the new highestmodseq, but not the
   uids that were dropped. So don't realize that you should actually update the
   cache, and you just lost those uids forever.

Test Plan:
Um, well, it seems to work. It definitely is correctly syncing
messages that were sent via the Inbox API (so appear in All Mail in Gmail, but
not in the inbox). I'll add a system test for this behavior.

Reviewers: spang

Differential Revision: https://review.inboxapp.com/D550"
emfree,2014-10-03 20:05:46,https://api.github.com/repos/nylas/sync-engine/git/commits/459754deab0aceb8823d41c99fe84fb624c3872c,459754deab0aceb8823d41c99fe84fb624c3872c,"Handle excessively many message recipients.

Summary:
We do this by emptying out the offending field and logging it as a decode error
for now.

Test Plan: Regression test added.

Reviewers: kav-ya

Differential Revision: https://review.inboxapp.com/D552"
dlitz,2014-10-03 19:23:57,https://api.github.com/repos/nylas/sync-engine/git/commits/3376f685ab3bd12c23e8ed686b036fd0053f161b,3376f685ab3bd12c23e8ed686b036fd0053f161b,"Add tests/data/* to .agignore

Summary:
Removes some noise from the results when grepping the source code with
'ag'.

References:

- The Silver Searcher (ag)
    http://geoff.greer.fm/ag/

- Vim plugin for the_silver_searcher, 'ag'
    https://github.com/rking/ag.vim

Test Plan: None

Reviewers: emfree

Reviewed By: emfree

Differential Revision: https://review.inboxapp.com/D551"
dlitz,2014-10-03 18:45:15,https://api.github.com/repos/nylas/sync-engine/git/commits/d35260f7f21bf444bf8ca00e680a48f12da61a47,d35260f7f21bf444bf8ca00e680a48f12da61a47,"Provider plugins via setuptools entry_points

Test Plan:
Ran the unit tests, added a couple of tests, and played with it on
my Vagrant VM.  It seems to work.

Reviewers: emfree

Reviewed By: emfree

Differential Revision: https://review.inboxapp.com/D549"
kav-ya,2014-10-03 18:15:25,https://api.github.com/repos/nylas/sync-engine/git/commits/ffe7f07715cdd13714076c9c7eaef0779d94d81c,ffe7f07715cdd13714076c9c7eaef0779d94d81c,Remove unneeded account_id arg.
kav-ya,2014-10-03 18:12:44,https://api.github.com/repos/nylas/sync-engine/git/commits/24628b53d152bd62d970590508778cecb1acb5a7,24628b53d152bd62d970590508778cecb1acb5a7,Don't log account_id again.
kav-ya,2014-10-03 17:42:22,https://api.github.com/repos/nylas/sync-engine/git/commits/aaea296b85c482b94124a83b5c514ebd348635d1,aaea296b85c482b94124a83b5c514ebd348635d1,"Log account_id, provider_name in commit_uids() for more
dashboard graphs."
emfree,2014-10-03 03:22:58,https://api.github.com/repos/nylas/sync-engine/git/commits/a93833b59ba1359d1c3a83f91e5205f6427b8498,a93833b59ba1359d1c3a83f91e5205f6427b8498,Fix uidvalidity_cb in inbox.console.
khamidou,2014-10-03 09:44:13,https://api.github.com/repos/nylas/sync-engine/git/commits/7ec5d6db1556e56746fb12336d9a69f6ef94de17,7ec5d6db1556e56746fb12336d9a69f6ef94de17,"Basic test case for labels

Summary:
Emfree,

I've got a basic system test for labels. The idea is to use a crispin client to modify the IMAP backend and check that mailsync picks up the changes. So far, I haven't been able to find a bug but I'm sure I'll find something ;)

Test Plan: Yo dawg I herd you liked tests so I put a test in your test

Reviewers: emfree

Reviewed By: emfree

Projects: #sync-engine

Differential Revision: https://review.inboxapp.com/D541"
dlitz,2014-10-02 21:34:10,https://api.github.com/repos/nylas/sync-engine/git/commits/081cf830f65ae99b1d7df55b4aaa1ca64ea68168,081cf830f65ae99b1d7df55b4aaa1ca64ea68168,"Providers: Also configuring the port for IMAP; Use consistent syntax.

Test Plan:
Ran the unit tests, changed the port number, and tried it out.  It seems to
have worked.

Reviewers: emfree

Reviewed By: emfree

Differential Revision: https://review.inboxapp.com/D548"
dlitz,2014-10-02 23:39:23,https://api.github.com/repos/nylas/sync-engine/git/commits/94827b533d7b2da78797a00c191d7d31c8f61fb8,94827b533d7b2da78797a00c191d7d31c8f61fb8,setup.py: pep8
kav-ya,2014-10-01 19:35:05,https://api.github.com/repos/nylas/sync-engine/git/commits/0f43db65e6f6b09d40d80a165356b752698c6834,0f43db65e6f6b09d40d80a165356b752698c6834,Migration to drop easaccount.eas_state column.
emfree,2014-10-02 18:43:28,https://api.github.com/repos/nylas/sync-engine/git/commits/874d24313840167aba09a21c7091d855f2929b66,874d24313840167aba09a21c7091d855f2929b66,"Validate recipients before sending a draft.

Summary:
We shouldn't let people try to send drafts when the recipients are patently
invalid. So check them before sending.

Test Plan: Unit test added.

Reviewers: khamidou

Reviewed By: khamidou

Differential Revision: https://review.inboxapp.com/D544"
khamidou,2014-10-02 18:03:53,https://api.github.com/repos/nylas/sync-engine/git/commits/98afd372f9e8719933329f6cbd96b1b7cb2958ea,98afd372f9e8719933329f6cbd96b1b7cb2958ea,"[sentry] Whitelist stack locals

Summary: Stack locals contain valuable debugging information. Keep some of them which are not PII (so far, only `account_id`).

Test Plan: Triggered an exception, tested that locals got stripped.

Reviewers: dlitz, emfree

Reviewed By: emfree

Projects: #sync-engine

Differential Revision: https://review.inboxapp.com/D546"
emfree,2014-10-02 04:53:08,https://api.github.com/repos/nylas/sync-engine/git/commits/0dd9d51f54ea5bd28935b137f338522eabf7918f,0dd9d51f54ea5bd28935b137f338522eabf7918f,"Directly filter messages by namespace_id for API queries.

Summary:
Now that messages have a namespace_id, we don't need to do the wonky
joining-to-threads thing. This makes the /messages endpoint two to three times
faster on large mailboxes.

Test Plan: Unit tests.

Reviewers: khamidou

Reviewed By: khamidou

Differential Revision: https://review.inboxapp.com/D539"
kav-ya,2014-10-02 00:57:13,https://api.github.com/repos/nylas/sync-engine/git/commits/744b1d53fc466f11c74c8f312ef36980e4bc2bbe,744b1d53fc466f11c74c8f312ef36980e4bc2bbe,Log exception type when mail sync dies.
emfree,2014-10-01 21:02:07,https://api.github.com/repos/nylas/sync-engine/git/commits/6359e977a78cca18e4ee48dfb5a9aa9a09d92b1b,6359e977a78cca18e4ee48dfb5a9aa9a09d92b1b,Also index message.received_date.
emfree,2014-10-01 18:41:04,https://api.github.com/repos/nylas/sync-engine/git/commits/e6f12840ec39ce2bb34396e6a49542abda11de53,e6f12840ec39ce2bb34396e6a49542abda11de53,"Add indexes to Thread.{recent|subject}date for great performance.

Since API results for /threads are *ordered by* recentdate, it's kind of
important to have this field be indexed."
emfree,2014-10-01 17:59:21,https://api.github.com/repos/nylas/sync-engine/git/commits/f9dba5eb7f3843bfd459fb07a3e05ea38f2d1450,f9dba5eb7f3843bfd459fb07a3e05ea38f2d1450,Fix broken link in docs.
emfree,2014-10-01 02:58:45,https://api.github.com/repos/nylas/sync-engine/git/commits/5ab17c504751c10e390df6676c6d3f6a6bf3f4e3,5ab17c504751c10e390df6676c6d3f6a6bf3f4e3,"Create canonical tags before saving folder names.

Otherwise if a user has their own 'archive' folder or similar, we may not map
it correctly to our canonical tags."
emfree,2014-09-30 22:36:31,https://api.github.com/repos/nylas/sync-engine/git/commits/707754fd9a54ff86d462eee75e86f170a10eca58,707754fd9a54ff86d462eee75e86f170a10eca58,"Download Gmail threads oldest-to-newest for better reconciliation.

Summary:
This fixes the following situation:
1) You send a message via the Inbox API. We create a Message object m1 and thread t1.

2) Somebody replies to that message.

3) We sync that reply, and create a new message m2 and new thread t2.

4) We sync the next oldest message in the thread, which was the message we sent originally. How do we reconcile? Currently, we don't create a new thread, and just update t1 with the g_thrid. But now we've actually split the thread across t1 and t2, and have two objects with the same g_thrid. That's not good.

You could imagine alternatively deleting m1 and t1 at this point, and adding a
new message m3 onto t2. But this breaks the API for users who might want to do
things like ""check the original thread t1 for replies to the message that they
sent via the API"".

So this seems like the best alternative solution to me. Now the first message
you sync is your original one, so the replies can be bolted on to t1.
This adds a few seconds of latency if you get new mail on a long thread during
initial sync, but that seems like a relatively small cost.

Test Plan: Not really sure how to programatically test this :/

Reviewers: spang

Reviewed By: spang

Subscribers: khamidou

Differential Revision: https://review.inboxapp.com/D535"
kav-ya,2014-09-30 22:23:41,https://api.github.com/repos/nylas/sync-engine/git/commits/f873bedf6d18443cc9c10aa085eb81a49d0c5ae3,f873bedf6d18443cc9c10aa085eb81a49d0c5ae3,"We probably want the greenlet running the sync fn to also use self.retry_fail_classes.

Summary:
This way, when the EAS sync monitor encounters EAS exceptions a retry won't help with
(for e.g. during provisioning), we don't.

Test Plan: None.

Reviewers: emfree

Reviewed By: emfree

Differential Revision: https://review.inboxapp.com/D534"
kav-ya,2014-09-30 22:07:18,https://api.github.com/repos/nylas/sync-engine/git/commits/070139ecdcf23c2256ca570f97d414cd6ae159a4,070139ecdcf23c2256ca570f97d414cd6ae159a4,retry_with_logging takes optional account_id arg.
emfree,2014-09-30 20:36:55,https://api.github.com/repos/nylas/sync-engine/git/commits/76524144013b8f17e588af0d0cc1d8c353f8857a,76524144013b8f17e588af0d0cc1d8c353f8857a,Fix logging when g_thrid duplicate is encountered.
emfree,2014-09-30 17:59:14,https://api.github.com/repos/nylas/sync-engine/git/commits/2b0691a512f06d8227f87c2911b007d6216138cd,2b0691a512f06d8227f87c2911b007d6216138cd,"Add indexes to message.subject and thread.subject.

Summary:
Otherwise API queries that filter by ?subject=<...> get slow. This also skews
our response time metrics, since the monitoring does a bunch of these queries.

Test Plan: Nada.

Reviewers: khamidou, spang

Reviewed By: spang

Subscribers: spang

Differential Revision: https://review.inboxapp.com/D531"
kav-ya,2014-09-30 03:00:59,https://api.github.com/repos/nylas/sync-engine/git/commits/1d6f8374a0959c64da41703c0d3adcc3dbd8811e,1d6f8374a0959c64da41703c0d3adcc3dbd8811e,"Only raise actions exceptions if it's useful.

Summary:
To reduce error-reporting noise.
For example EAS exceptions require special handling that a blind retry won't fix.
Therefore until we allow custom-retry for the actions code too, we simply log.

Test Plan: None.

Reviewers: emfree

Reviewed By: emfree

Differential Revision: https://review.inboxapp.com/D530"
khamidou,2014-09-30 09:08:24,https://api.github.com/repos/nylas/sync-engine/git/commits/b5cb29297dcb3ffb2da361fbf0238dfb3ad9c6ba,b5cb29297dcb3ffb2da361fbf0238dfb3ad9c6ba,"Add a basic &view=count parameter

Summary:
I decided to break implementing ""view=count"" into three subtasks:
- the one you're reading now
- adding a ""view=ids"" to display a list of ids
- defining a set syntax for parameters ""+"", ""^"", ""-"".

This diff adds support for ""view"" parameter wherever it makes sense. Also not that there's places where the code returns directly a dict to serialize. This is because the python json library doesn't let us override how basic types (int, long, etc.) get serialized.

Test Plan: Tested that it worked for /threads and /messages

Reviewers: emfree

Reviewed By: emfree

Subscribers: mg, bengotow

Projects: #inbox-api

Maniphest Tasks: T324

Differential Revision: https://review.inboxapp.com/D499"
emfree,2014-09-30 07:32:59,https://api.github.com/repos/nylas/sync-engine/git/commits/7630f6e925662bbbb2a9d94abae3ceb02b72a3fa,7630f6e925662bbbb2a9d94abae3ceb02b72a3fa,"Create tags when we create folders in save_folder_names.

Fixes an odd bug in which, when a user somehow has both a [Gmail]/Trash folder
and a Trash label, we try to create the 'trash' tag twice, causing
IntegrityErrors."
emfree,2014-09-30 03:27:13,https://api.github.com/repos/nylas/sync-engine/git/commits/16708488169628c7d30ffbbbcc7d3807e50fa6f5,16708488169628c7d30ffbbbcc7d3807e50fa6f5,"Limit scope of reconciliation test.

EAS seems to be stripping the X-INBOX-ID header. Needs more investigation;
restrict the test to other providers for now."
emfree,2014-09-30 02:33:14,https://api.github.com/repos/nylas/sync-engine/git/commits/b97242f46be50ed1337b3e9562cb727e2f2f9753,b97242f46be50ed1337b3e9562cb727e2f2f9753,"[SCHEMA] Properly reconcile Inbox-created messages in IMAP sync.

Summary:
If we sync a message with an X-INBOX-ID header and already have it in that
namespace's data store, don't create a new message. Just update the existing
thread instead.

Fixes a bug in which a message sent via the Inbox API causes duplicate threads
to appear once you sync the sent message from the backend.

Note: Requires migration, but can be run online. Takes <15 minutes.

Test Plan:
Check that syncing a sent message updates the existing thread,
instead of creating an old one.

Reviewers: spang, kav-ya

Reviewed By: kav-ya

Differential Revision: https://review.inboxapp.com/D528"
dlitz,2014-09-29 19:37:12,https://api.github.com/repos/nylas/sync-engine/git/commits/d1479ec2766a9e795075b6d2f6658db53439f4c6,d1479ec2766a9e795075b6d2f6658db53439f4c6,"crypto: move encryption & decryption into abstract ""oracle"" objects

Summary:
This will allow us to do more interesting key management.

This also decouples 096_migrate_secret_data.py from the oracle code so
that it doesn't break again the next time we change it.  (We shouldn't
be doing re-encryption inside an Alembic migration anyway.)

Test Plan:
- Ran the unit tests.
- Manually tested migrating the database from v0.3.0 (alembic rev
  2b89164aa9cd)

Reviewers: emfree

Reviewed By: emfree

Subscribers: dlitz

Differential Revision: https://review.inboxapp.com/D511"
emfree,2014-09-29 09:30:09,https://api.github.com/repos/nylas/sync-engine/git/commits/df2b90c22ee71cfdc7fc732a9e7c66050638222c,df2b90c22ee71cfdc7fc732a9e7c66050638222c,"Check during IMAP sync to see if throttled state has changed.

If you flip the Account.throttled bit during initial sync, it should
immediately accelerate."
kav-ya,2014-09-29 07:17:12,https://api.github.com/repos/nylas/sync-engine/git/commits/e3435e85de26c1ee5e596031eeb9b030d241b6ba,e3435e85de26c1ee5e596031eeb9b030d241b6ba,"Generic IMAP remote_delete_draft() deletes from Trash too.

Summary: As for Gmail.

Test Plan: None.

Reviewers: khamidou

Reviewed By: khamidou

Subscribers: emfree

Differential Revision: https://review.inboxapp.com/D522"
kav-ya,2014-09-29 06:33:52,https://api.github.com/repos/nylas/sync-engine/git/commits/a7f4e0003dfed03d489bf7b1cfa709f2abe6f68a,a7f4e0003dfed03d489bf7b1cfa709f2abe6f68a,"Gmail's remote_delete_draft fns delete from Trash too.

Summary:
Can't circumvent the Trash folder, so just delete+expunge from it too.
Still needed for generic IMAP.

Test Plan:
tests/imap/network/test_drafts_syncback.py seems broken
so tested manually using the IMAPClient cli.

Reviewers: emfree

Reviewed By: emfree

Subscribers: khamidou

Differential Revision: https://review.inboxapp.com/D521"
emfree,2014-09-29 05:26:25,https://api.github.com/repos/nylas/sync-engine/git/commits/f7adef2750f08bf0bcf887466bef45c9b3a03e5d,f7adef2750f08bf0bcf887466bef45c9b3a03e5d,"Properly create contact-draft associations.

Summary:
Otherwise you can't find Inbox-created drafts via API query parameter
filtering, e.g. /threads?any_email=<...>

Test Plan: Regression test added.

Reviewers: kav-ya

Reviewed By: kav-ya

Differential Revision: https://review.inboxapp.com/D520"
spang,2014-09-28 18:31:34,https://api.github.com/repos/nylas/sync-engine/git/commits/10e4071a3a0380b5ab52a1a3e8e6e6de4ef16451,10e4071a3a0380b5ab52a1a3e8e6e6de4ef16451,"Remove outdated comment.

The logic for this ended up in add_message_attrs()."
emfree,2014-09-28 02:55:41,https://api.github.com/repos/nylas/sync-engine/git/commits/d5e985d2394e0c74baf2089385a3913318535c4b,d5e985d2394e0c74baf2089385a3913318535c4b,"Log warning instead of error in Google contacts sync.

If there's a RequestError, it pretty much means that the developer hasn't
enabled the Google Contacts API. This shouldn't feed into error metrics.

Fixes T490."
spang,2014-09-27 18:25:26,https://api.github.com/repos/nylas/sync-engine/git/commits/dc471b4cb870b3db76ed5baba38d1c885e7e725c,dc471b4cb870b3db76ed5baba38d1c885e7e725c,Fix KeyError in add_new_imapuids().
emfree,2014-09-27 05:44:01,https://api.github.com/repos/nylas/sync-engine/git/commits/f445c929a9df88814fd412d3353fcdaa214b646b,f445c929a9df88814fd412d3353fcdaa214b646b,Fix typo in remove_messages.
spang,2014-09-27 05:23:02,https://api.github.com/repos/nylas/sync-engine/git/commits/7182739417ccb9b73ee5e9211077d1a6207e8bb7,7182739417ccb9b73ee5e9211077d1a6207e8bb7,Fix NoneType error with message.references in threading algo.
emfree,2014-09-26 22:00:44,https://api.github.com/repos/nylas/sync-engine/git/commits/3fbe0d41f073436cc49fcee5a9b050566f39b9c3,3fbe0d41f073436cc49fcee5a9b050566f39b9c3,Fix TypeError in cleanup_subject() when subjecct is None.
khamidou,2014-09-26 18:32:13,https://api.github.com/repos/nylas/sync-engine/git/commits/8a20800f89fb20ad67a929085fd80db6df66c426,8a20800f89fb20ad67a929085fd80db6df66c426,"broke the build -- it's not possible to modify a list and iterate it at
the same time with SQLAlchemy"
khamidou,2014-09-26 18:13:09,https://api.github.com/repos/nylas/sync-engine/git/commits/568737e1176e11ca30c8478d83affe5b57e41db9,568737e1176e11ca30c8478d83affe5b57e41db9,"Deletes messages which aren't associated to an UID.

Summary: Fixes T464.

Test Plan: Synced an account, created a draft. Sent it and checked that the draft wasn't there anymore.

Reviewers: emfree

Reviewed By: emfree

Subscribers: mg

Maniphest Tasks: T464

Differential Revision: https://review.inboxapp.com/D491"
emfree,2014-09-25 20:17:19,https://api.github.com/repos/nylas/sync-engine/git/commits/7ca8d3ddcc170ce63909bf5ce0272242147801fc,7ca8d3ddcc170ce63909bf5ce0272242147801fc,Fix bug in extracting pending UIDs from download stack.
emfree,2014-09-25 18:53:07,https://api.github.com/repos/nylas/sync-engine/git/commits/cb431571b12779b3893e3005464420b7a7491d7d,cb431571b12779b3893e3005464420b7a7491d7d,"Bound thread length when doing custom threading.

Summary:
This should fix the recursion depth exceeded error we keep seeing. It's also
probably not a good idea to let threads get super long anyways.

Fixes T434.

Test Plan: Unit test added.

Reviewers: khamidou

Reviewed By: khamidou

Maniphest Tasks: T434

Differential Revision: https://review.inboxapp.com/D508"
emfree,2014-09-25 18:50:10,https://api.github.com/repos/nylas/sync-engine/git/commits/9fc2fe112a6536b8fccacecff252b074cc2cb8db,9fc2fe112a6536b8fccacecff252b074cc2cb8db,"Fix typos when removing uids from download stack in IMAP sync.

This wasn't actually breaking anything, because we'd just end up trying to
download a UID that wasn't there. But still."
emfree,2014-09-25 18:37:05,https://api.github.com/repos/nylas/sync-engine/git/commits/f36ed87ca35a1b72958baeb44ebd5a7c4648c752,f36ed87ca35a1b72958baeb44ebd5a7c4648c752,Remove no-longer-valid test.
emfree,2014-09-25 18:22:44,https://api.github.com/repos/nylas/sync-engine/git/commits/fcca39a5f6d1567824df153ab3c7254f2c8a7133,fcca39a5f6d1567824df153ab3c7254f2c8a7133,"Don't refuse to schedule syncback actions for accounts in 'connerror' state.

Our ludicrously broken mismanagement of account.sync_state means that accounts
can more or less be in `connerror` for arbitrary reasons at arbitrary times. In
such cases, don't return HTTP 503 when a syncback action is scheduled."
khamidou,2014-09-25 09:39:24,https://api.github.com/repos/nylas/sync-engine/git/commits/c42615d0e2535fd82a1a58cb877ae399951de894,c42615d0e2535fd82a1a58cb877ae399951de894,"Disable failing test for iCloud

Test Plan: Ran the test

Reviewers: charles

Reviewed By: charles

Differential Revision: https://review.inboxapp.com/D500"
dlitz,2014-09-25 03:04:32,https://api.github.com/repos/nylas/sync-engine/git/commits/b7e5c4c2b87508b32d4a5e26afe607067ab0099d,b7e5c4c2b87508b32d4a5e26afe607067ab0099d,"Add bin/inbox-consistency-check debugging tool for gmail accounts

Summary:
There are still some differences that haven't been ironed out, and some stuff
isn't implemented (e.g. labels, tags, flags), but the major pieces are here,
and they should already be useful.

This also serves as an example of how to use setuptools entry_points to
make plugins.

Test Plan: manual testing

Reviewers: emfree

Reviewed By: emfree

Differential Revision: https://review.inboxapp.com/D507"
emfree,2014-09-24 23:33:46,https://api.github.com/repos/nylas/sync-engine/git/commits/dff3385b8358a8171792544e43d0dcfb2d3e17a2,dff3385b8358a8171792544e43d0dcfb2d3e17a2,"Only IDLE on the inbox folder for Gmail.

Summary:
This fixes a more than slightly mortifying regression in which we were idling
on ALL folders that we sync for Gmail. The problem with this is that it was
consuming all available crispin connections. Because the sync on the inbox
folder goes and gets a new all_mail_crispin_client to download threads, this
was causing the polling on the inbox folder to potentially block for an
unbounded amount of time. No bueno.

Test Plan:
Verify in sync logs that only the inbox folder sync idles, and that
it is not blocked.

Reviewers: spang

Reviewed By: spang

Subscribers: dlitz

Differential Revision: https://review.inboxapp.com/D510"
emfree,2014-09-24 17:58:19,https://api.github.com/repos/nylas/sync-engine/git/commits/638275188d9cf7560008605538e68a4897b2221f,638275188d9cf7560008605538e68a4897b2221f,"Defer initialization of Crispin connection pool so that it can be retried.

CrispinConnectionPool.__init__ calls CrispinConnectionPool._set_account_info(),
which does auth and related stuff. We were calling this in the FolderSyncEngine
constructor, which meant that the folder sync would just silently die if some
sort of error occurred. Not good.

In general we really shouldn't be doing this sort of work in any class
constructors at all."
emfree,2014-09-24 17:58:19,https://api.github.com/repos/nylas/sync-engine/git/commits/426fe6d3e5d6341be9021d43748ec73e9b27f72f,426fe6d3e5d6341be9021d43748ec73e9b27f72f,Condense successive alter tables in migrations.
emfree,2014-09-24 05:39:28,https://api.github.com/repos/nylas/sync-engine/git/commits/530d62112d3b2a0e5f05cc3c80f9df154d933acf,530d62112d3b2a0e5f05cc3c80f9df154d933acf,"Update GMessage namedtuple construction in Gmail sync.

Need to pass a value for 'throttled' now."
emfree,2014-09-24 05:35:35,https://api.github.com/repos/nylas/sync-engine/git/commits/180051dbce74aa3f53472872762b306d406cc3f3,180051dbce74aa3f53472872762b306d406cc3f3,Fix missing argument in BaseSync provider specialization.
emfree,2014-09-24 05:12:22,https://api.github.com/repos/nylas/sync-engine/git/commits/ae11065efe2a022f3820b0fe8687ca967f5740f0,ae11065efe2a022f3820b0fe8687ca967f5740f0,Fix argument ordering in mime parsing.
emfree,2014-09-24 04:40:36,https://api.github.com/repos/nylas/sync-engine/git/commits/e39c4fe7107e0c444b49fc8642d52794d0cf6ab4,e39c4fe7107e0c444b49fc8642d52794d0cf6ab4,"[SCHEMA] s/account_id/namespace_id/ for contacts,events,calendars.

Summary:
This makes contacts and events consistent with the rest of our objects, wihich
we partition by namespace rather than account.

Test Plan: Unit tests.

Reviewers: charles

Reviewed By: charles

Differential Revision: https://review.inboxapp.com/D502"
emfree,2014-09-24 04:36:04,https://api.github.com/repos/nylas/sync-engine/git/commits/47006e6483126d0505da3d740b8f777575e59055,47006e6483126d0505da3d740b8f777575e59055,"[SCHEMA] Add Message.namespace_id column, part 2.

Summary:
This is just the followup schema change, in which we set
Message.namespace_id to be non-nullable once we've populated it for all rows.

Test Plan: Run migration.

Reviewers: charles

Reviewed By: charles

Differential Revision: https://review.inboxapp.com/D498"
emfree,2014-09-24 04:34:53,https://api.github.com/repos/nylas/sync-engine/git/commits/ea6030d448d55d47f9ed1c7b516c040bc9a8a2d9,ea6030d448d55d47f9ed1c7b516c040bc9a8a2d9,"[SCHEMA] Add Message.namespace_id column, part 1.

Summary:
This is important both for performance and for assurance of namespace
isolation. In this commit, we merely add the column without requiring that it
be non-null. This is so that we can run the (time-consuming) migration online,
and then alter the column to be non-nullable in a subsequent (faster)
migration.

Associated cleanups:
* Move the contents of Message.__init__, which previously was responsible
  for constructing a Message instance from synced data, to a
  Message.create_from_synced method for greater clarity. Remove unused flags
  argument.
* Remove Message.create_draft_message, which wasn't really doing much.

Test Plan: Run syncs, unit tests.

Reviewers: charles

Reviewed By: charles

Subscribers: spang, mg

Differential Revision: https://review.inboxapp.com/D496"
emfree,2014-09-24 04:27:44,https://api.github.com/repos/nylas/sync-engine/git/commits/2fe0ddfecfde1360c092fec7e46e824b53ea202a,2fe0ddfecfde1360c092fec7e46e824b53ea202a,"[SCHEMA] Optionally throttle IMAP initial sync for certain accounts.

Summary:
Needs some more testing, but here is the basic gist of it for IMAP. We only
sleep after downloading a message from the initial sync backlog, not after
downloading a message more recent than the sync start. This means that there
may still be up to a minute's latency, but at least you will still get your
new mail if you're getting more than one new message a minute. (It may be
possible to get cleverer.)

Note that we also do one thread per minute rather than one message per minute
on Gmail inbox folders, for simplicity.

Test Plan:
Run syncs for accounts with the 'throttled' flag set to both True
and False. Check that we sleep and output the according debug logging only in
the latter case.

Reviewers: spang

Reviewed By: spang

Differential Revision: https://review.inboxapp.com/D505"
emfree,2014-09-23 21:23:06,https://api.github.com/repos/nylas/sync-engine/git/commits/a402c1e21165084a9c23185a35da2906dafcdafd,a402c1e21165084a9c23185a35da2906dafcdafd,Properly limit query for existing calendar object by account.
emfree,2014-09-23 20:38:03,https://api.github.com/repos/nylas/sync-engine/git/commits/0e0f70614df2a3992e037e760a7097056ed17859,0e0f70614df2a3992e037e760a7097056ed17859,"[DEPENDENCIES] Bump dnspython version.

In order to get the fix for https://github.com/rthalley/dnspython/issues/31,
which we were encountering in the wild."
emfree,2014-09-23 19:06:59,https://api.github.com/repos/nylas/sync-engine/git/commits/177e8219fd4ae42f5124379ec285c1f4cb084d2d,177e8219fd4ae42f5124379ec285c1f4cb084d2d,"Remove provider prefixes from tags; add 'readonly' attribute.

Summary:
Instead of mangling label names like 'jobs' to tag names like
'gmail-jobs', keep the original name. Instead add a 'readonly' attribute to the
tag representation.

Test Plan:
Run data migration script; sync a new account; check that tag names
look good for both.

Reviewers: khamidou, bengotow

Reviewed By: khamidou, bengotow

Subscribers: bengotow

Differential Revision: https://review.inboxapp.com/D497"
dlitz,2014-09-23 17:44:09,https://api.github.com/repos/nylas/sync-engine/git/commits/7967fc458584bf5b9cdab35a59e877e7d0b4070d,7967fc458584bf5b9cdab35a59e877e7d0b4070d,"startup: Remove clean_pyc; log a warning if ./src/ is detected.

Summary:
This caused a race condition that would break startup when multiple
parallel sync engines were started at the same time.

clean_pyc() should be a no-op now anyway, since our requirements.txt no
longer has any `-e git+https://` lines in it.

Also:
- Removed `sys.dont_write_bytecode = True`.  It doesn't really make
  sense to do it here, since we've already started importing things and
  writing .pyc files at this point.  If we actually want to avoid
  writing .pyc files at all (which I doubt), we should set
  PYTHONDONTWRITEBYTECODE=1 in the environment before starting Python.

- Moved `find . -name \*.pyc -delete` to earlier in the setup process
  so that old pyc files are removed before we start installing Python
  stuff, rather than afterwards.

Test Plan:
Run bin/inbox-start once under Vagrant to make sure it
doesn't crash.

Reviewers: charles

Reviewed By: charles

Maniphest Tasks: T463

Differential Revision: https://review.inboxapp.com/D479"
emfree,2014-09-23 17:40:41,https://api.github.com/repos/nylas/sync-engine/git/commits/52989327c296b8c81e943fb654d55729acce3b1e,52989327c296b8c81e943fb654d55729acce3b1e,"Strip all stack locals from Sentry exception messages.

Summary:
Having them is nice for debugging, but per discussion with @dlitz there's just
too much potential to leak information.

Test Plan: Unit test added.

Reviewers: dlitz

Reviewed By: dlitz

Subscribers: dlitz

Differential Revision: https://review.inboxapp.com/D487"
emfree,2014-09-23 00:59:43,https://api.github.com/repos/nylas/sync-engine/git/commits/6dba48bb9ddf0a737a975393bd478a2de1916bf8,6dba48bb9ddf0a737a975393bd478a2de1916bf8,"Remove deprecated ""message_id"" field from Block representation.

Also update docs."
emfree,2014-09-22 21:40:18,https://api.github.com/repos/nylas/sync-engine/git/commits/5a56ba2d50a49e98d584392f11acd7be49f23223,5a56ba2d50a49e98d584392f11acd7be49f23223,"Install inbox under 'inbox-sync' egg to avoid namespace collision.

The Python SDK is now 'inbox', so call this 'inbox-sync' instead."
emfree,2014-09-22 19:24:34,https://api.github.com/repos/nylas/sync-engine/git/commits/8747525f85ddb683851a334f56c20c3fb024cda6,8747525f85ddb683851a334f56c20c3fb024cda6,"Log additional request context in custom WSGI handler.

Test Plan: Check that request logging for bin/inbox-api is still sensible.

Reviewers: charles

Differential Revision: https://review.inboxapp.com/D490"
khamidou,2014-09-22 17:11:56,https://api.github.com/repos/nylas/sync-engine/git/commits/a32a4b30048a980cff5ac42eb0b81bb5a07d7fbc,a32a4b30048a980cff5ac42eb0b81bb5a07d7fbc,"Regression test for T441

Summary:
This is a very basic regression test for T441. Two things to note:
- To make things easier to test, I moved the thread fetching code into a separate function, `fetch_similar_threads`
- I had to resort to monkeypatching a function FolderSyncMonitor needed to get this to work. I think it's okay since we only instantiate a monitor to call `fetch_similar_threads`.

Test Plan: Ran the test.

Reviewers: charles, emfree

Reviewed By: emfree

Differential Revision: https://review.inboxapp.com/D472"
khamidou,2014-09-22 12:47:22,https://api.github.com/repos/nylas/sync-engine/git/commits/83c87b0fab2dad8877addee01db4fa26e9862aca,83c87b0fab2dad8877addee01db4fa26e9862aca,added pytest parallel build plugin
khamidou,2014-09-22 07:59:38,https://api.github.com/repos/nylas/sync-engine/git/commits/2902098990748796f4f451b84a525a60fc9ea3ff,2902098990748796f4f451b84a525a60fc9ea3ff,"Fix typo in README

It's GANDI not GANDHI."
khamidou,2014-09-22 07:52:46,https://api.github.com/repos/nylas/sync-engine/git/commits/82546b0ba0f713de45432272a8aaed9d98b81e82,82546b0ba0f713de45432272a8aaed9d98b81e82,"[tests] Fixturize for_all_availlable_clients

Summary: Breaks `for_all_availlable_clients` in two fixtures. The first one is executed only once per session. The second one depends on the first and simply gets a client for the current email address.

Test Plan: Ran the tests.

Reviewers: charles

Reviewed By: charles

Differential Revision: https://review.inboxapp.com/D477"
emfree,2014-09-22 06:06:20,https://api.github.com/repos/nylas/sync-engine/git/commits/8f0c2c19e938f5daa8bbb83a48754a03c6e7a9a4,8f0c2c19e938f5daa8bbb83a48754a03c6e7a9a4,"More strictly validate recipient fields.

Previously we'd accept things like

""to"": [{""email"": [""hello@example.com""]}],

which we shouldn't."
emfree,2014-09-19 23:27:24,https://api.github.com/repos/nylas/sync-engine/git/commits/3219b136d2c6c4f47976b50c7a3bcc6bdbbf147d,3219b136d2c6c4f47976b50c7a3bcc6bdbbf147d,"Update call to create_account() in test_secret.py.

Arguments were changed in commit 800e457."
emfree,2014-09-19 23:12:13,https://api.github.com/repos/nylas/sync-engine/git/commits/b75d0025dab6a7b3a5be5f46568c1f083112a46b,b75d0025dab6a7b3a5be5f46568c1f083112a46b,"Fix default secrets config copying in setup.sh.

config.py looks for /etc/inboxapp/secrets.json, but the setup script was
copying to /etc/inboxapp/secrets-dev.json."
kav-ya,2014-09-18 02:03:42,https://api.github.com/repos/nylas/sync-engine/git/commits/a3452669cb5d4265615cd311573783bf8619d6b4,a3452669cb5d4265615cd311573783bf8619d6b4,"[SCHEMA] Optionally encrypt database secrets.

Summary:
This is the ""secrets-only"" part of D462, split out from the block-storage
stuff. Notable changes from the original revision:
 * Only encrypt secrets when the ENCRYPT_SECRETS config value is set.
 * Remove hook to cascade soft-deletion from accounts to secrets. I don't
   think we need this facility right now.
 * Do EAS schema migration before encryption migration.
 * Split encryption migration into several smaller parts for sanity.

Test Plan:
1. Auth all test accounts using old schema
2. Run migrations
3. Ensure that account credentials still work
4. Delete and reauth all accounts using new schema
5. Ensure that account credentials are stored and retrieved correctly.

Do this with config['ENCRYPT_SECRETS'] set to both True and False.

Reviewers: dlitz

Subscribers: dlitz

Differential Revision: https://review.inboxapp.com/D484

Conflicts:
	tests/general/test_vault.py"
emfree,2014-09-19 22:24:49,https://api.github.com/repos/nylas/sync-engine/git/commits/6ddbe06afd59db2970a7326f71b704095de66d64,6ddbe06afd59db2970a7326f71b704095de66d64,"Fix edge case when modifying thread tags; don't mark system test as xfail.

When modifying thread tags, we previously had some logic that tried to not
match against tag public ids if the input wasn't a valid public ID. But it
wasn't quite right, and in any case tag public IDs are special snowflakes in
that they can be any string! So just remove this. Also enable the system test
for modifying custom tags, which should after all work now."
emfree,2014-09-19 20:14:02,https://api.github.com/repos/nylas/sync-engine/git/commits/b5b847e3d7a9ec8445a42ca403078cb55bd99de1,b5b847e3d7a9ec8445a42ca403078cb55bd99de1,"Avoid filtering messages query by empty in-predicate.

Doing db_session.query(Message).filter(Message.id.in_(ids)) when ids is empty
causes
```
/usr/local/lib/python2.7/dist-packages/sqlalchemy/sql/default_comparator.py:33:
SAWarning: The IN-predicate on ""message.id"" was invoked with an empty sequence.
This results in a contradiction, which nonetheless can be expensive to
evaluate.  Consider alternative strategies for improved performance.```

But we can simply short-circuit instead of doing the query."
dlitz,2014-09-19 18:07:32,https://api.github.com/repos/nylas/sync-engine/git/commits/c0b100c0ef937b304bbe2cbbf1144422c1da5454,c0b100c0ef937b304bbe2cbbf1144422c1da5454,"Add Vagrantfile.local & Vagrantfile.local.d, allowing user to override memory, cpu, etc.

Summary:
Recently, I bumped the memory allocated to Vagrant to 1024 MiB.  That's
way too much for some people's poor laptops.  Allow local overrides via
Vagrantfile.local or Vagrantfile.local.d/*.

Includes an example.

Test Plan: Manual testing

Reviewers: khamidou

Reviewed By: khamidou

Differential Revision: https://review.inboxapp.com/D485"
khamidou,2014-09-19 16:34:06,https://api.github.com/repos/nylas/sync-engine/git/commits/6d16ecac654547f26560b0b1303c54cd83ba7b55,6d16ecac654547f26560b0b1303c54cd83ba7b55,"Syncback ""spam"" and ""trash"" tags

Summary:
Kavya, Eben,

This is a basic implemention of the ""mark as spam"" and ""trash"" actions. Could you tell me what you think of it?

Test Plan: Triggered the actions using the API on gmail and fastmail.

Reviewers: kav-ya, emfree

Reviewed By: emfree

Projects: #sync-engine

Differential Revision: https://review.inboxapp.com/D449"
emfree,2014-09-18 21:45:49,https://api.github.com/repos/nylas/sync-engine/git/commits/138d17790e0a1cde8058de1165da3182b0e52372,138d17790e0a1cde8058de1165da3182b0e52372,"Remove unused TestZeroRPC class.

Breaks tests on fresh Inbox installs, because zerorpc is no longer a
dependency."
emfree,2014-09-18 21:15:01,https://api.github.com/repos/nylas/sync-engine/git/commits/284b1aca93399201cd1bb1ab74cd90a6335725ce,284b1aca93399201cd1bb1ab74cd90a6335725ce,"Allow thread tags to be modified either by name or public id.

Summary:
Previously we would only check tag names, which works fine for things
like the 'inbox' tag, where the tag name and public_id values generally
coincide. But this is not good for user-created tags, where the public_id is
constant but the name may actually change.

Fixes T467.

Test Plan: Regression test added.

Reviewers: charles

Reviewed By: charles

Subscribers: bengotow

Maniphest Tasks: T467

Differential Revision: https://review.inboxapp.com/D480"
khamidou,2014-09-18 17:22:06,https://api.github.com/repos/nylas/sync-engine/git/commits/89d022c094e5abd4818c8774789b373eb0c594b0,89d022c094e5abd4818c8774789b373eb0c594b0,"[util] Update bin/inbox-console

Summary: Fixed code rot and added an option to instantiate a REPL with an APIClient available.

Test Plan: Checked the code paths.

Reviewers: charles

Reviewed By: charles

Differential Revision: https://review.inboxapp.com/D401"
emfree,2014-09-18 00:24:09,https://api.github.com/repos/nylas/sync-engine/git/commits/06c03d6a8fc29447b90f2bf5b512680d9cf64451,06c03d6a8fc29447b90f2bf5b512680d9cf64451,Fix typo and add regression test.
emfree,2014-09-18 00:19:59,https://api.github.com/repos/nylas/sync-engine/git/commits/2b5778968127e631b332c736394ceafd2b8bd08a,2b5778968127e631b332c736394ceafd2b8bd08a,"Actually fix message result ordering in API call.

Thanks @charles for pointing out the regression."
emfree,2014-09-17 23:50:55,https://api.github.com/repos/nylas/sync-engine/git/commits/fbfcf9c94613dc456cbac91594ad3c2c2b4eea4d,fbfcf9c94613dc456cbac91594ad3c2c2b4eea4d,"Fix message result ordering in API call.

Fixes regression introduced by 3f1a1828."
bengotow,2014-09-17 19:23:25,https://api.github.com/repos/nylas/sync-engine/git/commits/c8f5ab3fee49cf248f6e4971b5ee29c6055d17d3,c8f5ab3fee49cf248f6e4971b5ee29c6055d17d3,[docs] Add unread to the sample message repsonse
grinich,2014-09-17 19:20:20,https://api.github.com/repos/nylas/sync-engine/git/commits/923a53eaffed559fa7aa721fa8a34c0c71cf9bcc,923a53eaffed559fa7aa721fa8a34c0c71cf9bcc,Update 07_messages.mdown
khamidou,2014-09-17 13:24:11,https://api.github.com/repos/nylas/sync-engine/git/commits/56f53e694748b950dddbc221871f12afc8a0e371,56f53e694748b950dddbc221871f12afc8a0e371,disable failing test for now
khamidou,2014-09-17 09:52:28,https://api.github.com/repos/nylas/sync-engine/git/commits/4da6954a54d85788d90f98b8f450e2041aba09ff,4da6954a54d85788d90f98b8f450e2041aba09ff,"Fixes T443

Summary: Prevent users to access or delete files belonging to an other namespace.

Test Plan: Tested manually

Reviewers: dlitz, emfree

Reviewed By: emfree

Projects: #security

Maniphest Tasks: T443

Differential Revision: https://review.inboxapp.com/D471"
emfree,2014-09-17 02:32:23,https://api.github.com/repos/nylas/sync-engine/git/commits/3f1a1828d02e4d84c3489623e053c6dc2622916e,3f1a1828d02e4d84c3489623e053c6dc2622916e,"Apply stopgap fix for message API slowness.

Basically the way we have to join messages to threads to filter by mailboxes is
crushingly slow on large mailboxes. This commit at least remedies the worst of
it by first loading only message ids, then loading the actual messages in a
second pass."
emfree,2014-09-17 01:06:27,https://api.github.com/repos/nylas/sync-engine/git/commits/becfc545c3ed520e8d724d3ed998a2edb29852f2,becfc545c3ed520e8d724d3ed998a2edb29852f2,"Reduce default crispin connection pool size to 4.

Pretty sure this is still a safe number. We can probably go lower, but should
check that first."
emfree,2014-09-17 01:03:58,https://api.github.com/repos/nylas/sync-engine/git/commits/a83e984991eb5df2362cef399ce63859bcbb2c4e,a83e984991eb5df2362cef399ce63859bcbb2c4e,Always relinquish IMAP connections before sleeping.
emfree,2014-09-16 23:21:02,https://api.github.com/repos/nylas/sync-engine/git/commits/c2f0a0d03876f4c906d90542babb928c01814a95,c2f0a0d03876f4c906d90542babb928c01814a95,"Fix race condition in condstore IMAP sync.

We need to take both local_uids and stack_uids into account when figuring out
which uids are new in highestmodseq_update.

In order for this to work, also replace the GMessageStack and UIDStack
implementations with a single UIDStack, which maintains a stack of pairs (uid,
metadata), where the metadata field is optional. This is still a bit clunky,
but less so, and works across both Gmail and generic IMAP."
dlitz,2014-09-16 23:19:53,https://api.github.com/repos/nylas/sync-engine/git/commits/e33c217fb1cb1b93d7060f7a67d6028185ac038e,e33c217fb1cb1b93d7060f7a67d6028185ac038e,"vagrant: Respect setup.sh's shebang line

setup.sh says #!/bin/bash, but 'vagrant provision' was running it under
/bin/sh anyway."
dlitz,2014-09-16 23:17:11,https://api.github.com/repos/nylas/sync-engine/git/commits/9e979cbbb1d948dad8deda7b8c3d6ee902dc7677,9e979cbbb1d948dad8deda7b8c3d6ee902dc7677,"vagrant: Use 1024 MiB memory & 2 vcpus when using virtualbox

Now it's the same as with vmware_fusion."
emfree,2014-09-16 21:37:09,https://api.github.com/repos/nylas/sync-engine/git/commits/bc973bc7122a4917dd8aaafc302b81bfab90f8b7,bc973bc7122a4917dd8aaafc302b81bfab90f8b7,Fix typo in Gmail sync.
emfree,2014-09-16 16:39:49,https://api.github.com/repos/nylas/sync-engine/git/commits/feaef7161d264b93708cc5d5eae3c38c9418bfaf,feaef7161d264b93708cc5d5eae3c38c9418bfaf,"Revert ""Config v9.0""

This reverts commit 3d5114820ff1f0282dcb80849dc47051cb3f4080."
emfree,2014-09-16 16:39:38,https://api.github.com/repos/nylas/sync-engine/git/commits/b5705c06c171d3137207aac1e0c7fdc45134caeb,b5705c06c171d3137207aac1e0c7fdc45134caeb,"Revert ""[tests] Fix the full_coverage script to support new parameter option.""

This reverts commit d35069172ae169add510675f2a9404d737d6e421."
spang,2014-09-16 16:35:19,https://api.github.com/repos/nylas/sync-engine/git/commits/88de6beeaa31328e03205a616feb4265ccc75794,88de6beeaa31328e03205a616feb4265ccc75794,"Quote tag values in custom tag example.

This was tripping someone up."
kav-ya,2014-09-15 16:52:24,https://api.github.com/repos/nylas/sync-engine/git/commits/6bcb55d879a0f5c0702277a78997b68ed54ff914,6bcb55d879a0f5c0702277a78997b68ed54ff914,"Actually support EAS tags.

Summary:
EAS used Folder.canonical_name to store the eas_folder_id - a unique identifier
from the server, required to perform any action at all.
At the time it was implemented, using the canonical_name provided
the ease of filtering on both name, eas_folder_id thereby preventing
duplicate entry errors we were seeing (the specific issue then was the user had
two different folders of the same name).

This doesn't fare so well for EAS tags.
Therefore introduce an extra 'identifier' column.

I looked into a couple of ways to avoid a schema change
but things like the inability to override SqlAlchemy validators
in subclasses makes this the logically cleanest way to do it.

Test Plan:
Visual inspection of an EAS account.
Sync runs, test passes.

Reviewers: emfree

Reviewed By: emfree

Differential Revision: https://review.inboxapp.com/D468"
kav-ya,2014-09-05 18:10:48,https://api.github.com/repos/nylas/sync-engine/git/commits/3d5114820ff1f0282dcb80849dc47051cb3f4080,3d5114820ff1f0282dcb80849dc47051cb3f4080,"Config v9.0

Summary:
This (umpteenth) rev of our config aims to solve a few
issues with the current config -

1. inbox-auth and inbox-start may use different configs.
In particular, we can't use a custom config with inbox-auth.

2. The use of the INBOX_ENV env var is fraught with peril in that
we must remember to change it when needed and forgetting to do so
can have messy consequences. This was especially true when we had
a secrets config file too.

3. config.config is modified by code outside config.py
(e.g. load_overrides())

4. config.config is set implicitly at module import time, so
the order of imports have to be reasoned about.

The proposed rev favors explicitness, the primary changes are:

* Deprecate the use of INBOX_ENV. Instead use the --env
flag to explicitly declare the config to use.

* All our server scripts accept the --env, --config flags
(where --config specifies the path to a custom config file that
may override all/part of the base config as before.).
This allows inbox-auth, inbox-start to use the same config for example.

* config.config is set by an explicit call to load_config().
It is set once by the ""entry points"" (for e.g. the server scripts) and
is simply imported as before otherwise.

* Configuration directly loads file + creates config dict.
Introduce ConfigurationManager.

Also, a read: http://vladikk.com/2013/05/14/uncoupling-configuration-files/

Test Plan:
Sync works.
No test regressions.

Reviewers: spang, emfree

Reviewed By: emfree

Subscribers: dlitz

Differential Revision: https://review.inboxapp.com/D431"
emfree,2014-09-16 00:34:40,https://api.github.com/repos/nylas/sync-engine/git/commits/b5fd5ef2e89bd46b175d287f3316d64bfcf4aca6,b5fd5ef2e89bd46b175d287f3316d64bfcf4aca6,"[DEPENDENCIES] Require msgpack-python.

We were previously implicitly installing msgpack via ZeroRPC, so removing the
ZeroRPC dependency broke fresh installs."
emfree,2014-09-15 17:18:58,https://api.github.com/repos/nylas/sync-engine/git/commits/60f697196ce6a9c4224be0d87cb0e0d9a3c8214f,60f697196ce6a9c4224be0d87cb0e0d9a3c8214f,"[Schema] Fix typo in account type polymorphism for Outlook accounts.

Summary: Do not want to get bit by this again.

Test Plan: Run migration on a database with Outlook accounts.

Reviewers: kav-ya

Reviewed By: kav-ya

Differential Revision: https://review.inboxapp.com/D467"
emfree,2014-09-15 17:09:49,https://api.github.com/repos/nylas/sync-engine/git/commits/bf2c7703b8f641c7b4de02cdc2ce6c16a4968c57,bf2c7703b8f641c7b4de02cdc2ce6c16a4968c57,"Store original message if quote-stripping removes everything.

Summary:
False positives in quote detection can sometimes remove everything, leaving a
blank message.  In this case, we now store the un-stripped message instead.
This is far from a perfect heuristic, but better than nothing.

Test Plan:
Run Message.calculate_sanitized_body on messages both where quote
detection works correctly and where it would strip the whole message. Run a
sync as a sanity check.

Reviewers: mg

Reviewed By: mg

Differential Revision: https://review.inboxapp.com/D463"
kav-ya,2014-09-15 16:45:47,https://api.github.com/repos/nylas/sync-engine/git/commits/fff95299c53535aa75fe1058b04d70d49eb622ed,fff95299c53535aa75fe1058b04d70d49eb622ed,Namespace filtering in events.crud
emfree,2014-09-15 08:45:51,https://api.github.com/repos/nylas/sync-engine/git/commits/e3e599269e3e587817ff2d3dcc7c3c7e7cb9d35c,e3e599269e3e587817ff2d3dcc7c3c7e7cb9d35c,"Remove reference to deprecated order_by parameter in docs.

Also fix example start parameter in delta sync docs."
kav-ya,2014-09-15 00:32:18,https://api.github.com/repos/nylas/sync-engine/git/commits/e7ae28c760cb54875a107a15346a4132b55116e5,e7ae28c760cb54875a107a15346a4132b55116e5,Filter ImapThread by namespace in generic Imap actions code too.
kav-ya,2014-09-15 00:27:02,https://api.github.com/repos/nylas/sync-engine/git/commits/d820dc1c3559d0412e80f70875b4d4c162c7378c,d820dc1c3559d0412e80f70875b4d4c162c7378c,Filter ImapThread by namespace in generic Imap threading algorithm.
kav-ya,2014-09-15 00:05:43,https://api.github.com/repos/nylas/sync-engine/git/commits/654e39e4c56ae8db25beede7ae55a6ab2f1778e4,654e39e4c56ae8db25beede7ae55a6ab2f1778e4,Don't return all namespaces if email_address=None for the test client.
emfree,2014-09-12 23:17:03,https://api.github.com/repos/nylas/sync-engine/git/commits/05d5311d62d8a84133ac1e785a5681ca895821e7,05d5311d62d8a84133ac1e785a5681ca895821e7,"Don't make CondstoreFolderSyncEngine.idle_wait method private.

Forgot that prefixing with __ mangles the name so that it can't be used by the
GmailFolderSyncEngine derived class."
emfree,2014-09-12 23:04:05,https://api.github.com/repos/nylas/sync-engine/git/commits/8de1e2d36fc78e6a7dc8c86429bc50daff9186c1,8de1e2d36fc78e6a7dc8c86429bc50daff9186c1,"[SCHEMA] Remove webhooks and zerorpc dependency.

Summary:
Webhooks are being replaced by the ping API; this commit just rips out a bunch
of now deprecated code, and finally gets rid of the last of our ZeroRPC
dependencies.

Test Plan: py.test tests

Reviewers: charles

Reviewed By: charles

Differential Revision: https://review.inboxapp.com/D459"
emfree,2014-09-11 17:06:07,https://api.github.com/repos/nylas/sync-engine/git/commits/3fe9be3121d228035478572bd1628f6dab011feb,3fe9be3121d228035478572bd1628f6dab011feb,"Fix uidvalidity_cb arguments in actions.backends.imap.

Thanks @khamidou for pointing this out."
kav-ya,2014-09-10 22:51:37,https://api.github.com/repos/nylas/sync-engine/git/commits/2f350b7dec30e7e3e4156efdd8db5d48b4aaf45d,2f350b7dec30e7e3e4156efdd8db5d48b4aaf45d,"Actions are only scheduled for a valid account, api returns an HTTP 403/503 error otherwise.
Fixes T420.

Summary:
We check account.sync_state to determine validity.
403: invalid
503: connerror

Test Plan:
Test added to tests/api/test_validation.py

Reviewers:
emfree

Reviewed By:
emfree

Subscribers:
charles

Maniphest Tasks:
T420

Differential Revision:
https://review.inboxapp.com/D451"
emfree,2014-09-10 04:15:56,https://api.github.com/repos/nylas/sync-engine/git/commits/96089da357c4aa702d26c94eb7094f0ae2d7babd,96089da357c4aa702d26c94eb7094f0ae2d7babd,"[DEPENDENCIES] Install talon from our fork.

Our fork of talon rips out the signature-detection part and its associated
dependencies (PyML, numpy), making it much less painful to install.

Fixes T416 and 417."
emfree,2014-09-10 01:04:37,https://api.github.com/repos/nylas/sync-engine/git/commits/3c800a9a123222ebb617aa319a6e2fe5317e02c9,3c800a9a123222ebb617aa319a6e2fe5317e02c9,"Add default value for Message.subject to prevent TypeError.

Missing subject should be the empty string, not None."
emfree,2014-09-10 00:36:11,https://api.github.com/repos/nylas/sync-engine/git/commits/0ee858fa9d56035e8e7e5fd27651d33ed0b2df67,0ee858fa9d56035e8e7e5fd27651d33ed0b2df67,"Detect flag changes during initial sync.

Summary:
In this chapter of the IMAP sync saga, we restructure the Gmail and condstore
sync engines to allow us to detect flag changes during initial sync.

For Gmail, we'd previously run __check_new_g_thrids() in a separate greenlet
during initial sync. However, this wouldn't detect flag changes (marking a
thread as read, etc.). There were also some similar issues for generic IMAP
with condstore.

The key observation is that during initial sync, we should really be doing the
same highestmodseq-updating that we do when polling, in order to fully detect
changes. The only difference is that during initial sync, actual downloading of
messages happens asynchronously on the main greenlet.

This commit replaces the `check_new_uids()`, `__check_new_g_thrids()`,
`__imap_flag_change_poller()`, and `__check_flags()` greenlets by a single
`poll_for_changes()` greenlet, which has one implementation for condstore and
one for non-condstore IMAP sync. This greenlet is responsible for updating
metadata, removing deleted uids, and adding new uids onto the download stack.

Smaller associated changes:
 * Define classes UIDStack and GMessageStack that wrap gevent.LifoQueue, to
   allow for more concise manipulations of the download stacks.
 * Don't track `update_uid_count` or `delete_uid_count` when calling
   update_uid_counts() -- we don't actually use those numbers for anything.
 * Change uidvalidity_cb parameters for simpler invocation.
 * Return the crispin client before sleeping in generic non-condstore poll.
   This was blocking syncs on folders with more accounts than the size
   of the connection pool
 * Actually sync Gmail Inbox most-recent-thread first, and not in arbitrary order.

Fixes T322.

Test Plan: Working on it :/ Suggestions welcome.

Reviewers: khamidou, spang

Reviewed By: spang

Maniphest Tasks: T322

Differential Revision: https://review.inboxapp.com/D433"
kav-ya,2014-09-09 22:41:15,https://api.github.com/repos/nylas/sync-engine/git/commits/c0ac0a27f31d65173018700aaf775fc5320fdf76,c0ac0a27f31d65173018700aaf775fc5320fdf76,"Disable autoflush in mailsync.backends.imap.common.update_metadata().
Fixes T413.

Summary:
When we're updating multiple messages in the same thread and a
call to update_thread_labels() results in a Folder.find_or_create(),
a subsequent access of that thread would trigger a flush,
raising an IntegrityError.

Test Plan:
None really as is typical for these errors, ideas welcome.
Sync runs as before.

Reviewers: emfree

Reviewed By: emfree

Differential Revision: https://review.inboxapp.com/D444"
emfree,2014-09-09 19:08:26,https://api.github.com/repos/nylas/sync-engine/git/commits/6aca6f47cc762b8da5c83b8fee10b51ea67be6a5,6aca6f47cc762b8da5c83b8fee10b51ea67be6a5,"Remove report_stopped functionality.

The problem is that report_stopped when a sync monitor is gracefully stopped.
But report_stopped actually invokes Account.stop_sync, which sets sync_state to
'stopped' in the database, which STOPS THE SYNC FOREVER. And commit
3af2c000 attempts to gracefully stop all syncs when you kill bin/inbox-start
with SIGTERM. NOT GOOD."
emfree,2014-09-09 18:37:30,https://api.github.com/repos/nylas/sync-engine/git/commits/c1ab53258c05f88d95251385c1e6795b458b7dab,c1ab53258c05f88d95251385c1e6795b458b7dab,"Properly sync back draft deletions for generic IMAP.

Summary:
The previous implementation of this would try to figure out the IMAP uid of the
draft to delete by looking for a recoonciled message object and getting its
IMAP uid. This has some problems -- it only works if the account's drafts
folder has been fully synced; it will take forever on large databases because
it tries to filter messages by the version column; and it won't work at all now
that we don't do any message reconciliation.

Instead, implement draft deletions the way we do for Gmail, by directly
querying the IMAP backend to figure out the IMAP uid to delete. A complication
is that Yahoo at least doesn't appear to support searching by message headers.
We work around this by fetching the X-INBOX-ID header for all uids in the
remote drafts folder, and doing the filtering client-side.

Fixes T335.

Test Plan:
Verify that draft deletions are synced back for Yahoo and Outlook
test accounts.

Reviewers: kav-ya

Reviewed By: kav-ya

Maniphest Tasks: T335

Differential Revision: https://review.inboxapp.com/D442"
khamidou,2014-09-09 16:15:39,https://api.github.com/repos/nylas/sync-engine/git/commits/3fc8d5f03736ede083cc86e39864b2574e9995ae,3fc8d5f03736ede083cc86e39864b2574e9995ae,"Test more tagging functionality

Summary:
Charles,

I've added two test cases for tagging, one about archiving and the other about marking as spam and trashing.
The latter crashes the syncback service with a NotImplementedException. I'll look into fixing this.

Could you tell me what you think of the code? Do you have other ideas for tagging test cases?

Test Plan: Ran the tests. Checked that they (mostly) passed.

Reviewers: charles

Reviewed By: charles

Differential Revision: https://review.inboxapp.com/D441"
emfree,2014-09-09 02:37:38,https://api.github.com/repos/nylas/sync-engine/git/commits/8bd5857110d33dfb77046c269926823559f910d1,8bd5857110d33dfb77046c269926823559f910d1,"Improve syncback concurrency limit.

Summary:
There's obviously more work to be done here, but in the meantime this commit
removes the global limit on the number of syncback actions that can be tried
concurrently. Instead, it bounds the number of concurrent syncback greenlets
for each (account_id, action_type) pair.

The reason for this is that previously, if say archiving was broken for a
particular account, but there were a bunch of archive actions outstanding for
it, the entire syncback service could grind to a halt. Not ideal.

Smaller associated changes:
 * Make the SyncbackWorker class just be a simple function.
 * Refactor to hoist sleeping-before-retrying out of the database session
   scope.
 * Remove nested database session in delete_draft.

Test Plan: Run some syncback actions.

Reviewers: charles

Reviewed By: charles

Differential Revision: https://review.inboxapp.com/D440"
emfree,2014-09-09 01:54:39,https://api.github.com/repos/nylas/sync-engine/git/commits/4a8d854b1e4ae0b94926df82154992abda8bf891,4a8d854b1e4ae0b94926df82154992abda8bf891,"Log committed message count for all providers.

Summary:
This lets us easily measure raw sync throughput for all accounts, not just
Gmail ones. Fixes T408.

Test Plan: Run Gmail and Exchange syncs and check that the logs look good.

Reviewers: kav-ya

Reviewed By: kav-ya

Maniphest Tasks: T408

Differential Revision: https://review.inboxapp.com/D437"
emfree,2014-09-08 22:44:24,https://api.github.com/repos/nylas/sync-engine/git/commits/d6d5331614719e2f890c67b6d4289696cf63ed13,d6d5331614719e2f890c67b6d4289696cf63ed13,"Remove message reconciliation.

Summary:
Commit acbf607d8c9 changed the message reconciliation query to
```
         message = db_session.query(Message).filter(
            Message.version == inbox_uid).one()
```
which is grindingly slow, because the version column is not indexed. But we're
not actually deduping objects when we reconcile, or otherwise doing anything
with the resolved_message property, so just remove reconciliation altogether.

Needs trivial accompanying change to remove reconcile_message() call from EAS
code as well.

(In a follow-up commit, we should remove Message.resolved_message_id, and
either actually dedupe objects during reconciliation, or do no reconciliation
at all.)

Test Plan: Run a sync.

Reviewers: kav-ya

Reviewed By: kav-ya

Differential Revision: https://review.inboxapp.com/D436"
kav-ya,2014-09-08 21:20:12,https://api.github.com/repos/nylas/sync-engine/git/commits/59dc229880656b647f6c5ca63aa89c27fc542692,59dc229880656b647f6c5ca63aa89c27fc542692,"Don't create a new engine in init_db()

Summary:
SQLAlchemy engines are lazily initialized so it doesn't have
any negative effects; it's just unnecessary.

Test Plan: Run create-db, clear-db scripts.

Reviewers: emfree

Differential Revision: https://review.inboxapp.com/D435"
khamidou,2014-09-08 21:36:28,https://api.github.com/repos/nylas/sync-engine/git/commits/24b3aa9a83b57de3cef522d91284a54d62a76e43,24b3aa9a83b57de3cef522d91284a54d62a76e43,"Correctly remove sent drafts

Summary:
Kavya,

This is a fix for T406. The syncback code would trigger an exception because it wouldn't search the right db column.

Test Plan: Tested that the exception wasn't triggered.

Reviewers: kav-ya

Reviewed By: kav-ya

Projects: #inbox-sync

Maniphest Tasks: T406

Differential Revision: https://review.inboxapp.com/D434"
emfree,2014-09-07 22:21:41,https://api.github.com/repos/nylas/sync-engine/git/commits/2cf426097d7b3f1b62dfb6656d3921548ab74923,2cf426097d7b3f1b62dfb6656d3921548ab74923,"[DEPENDENCIES] Switch back to upstream html2text.

PR got merged in the latest release, don't need to use our fork anymore."
emfree,2014-09-07 04:15:59,https://api.github.com/repos/nylas/sync-engine/git/commits/a4fbe6e3410ae9d5ea16a9d1c9320c250ddb8f44,a4fbe6e3410ae9d5ea16a9d1c9320c250ddb8f44,"Remove assertion when syncing back drafts.

We can occasionally try to sync back a draft that isn't actually a draft
anymore. This isn't really a problem, so just return instead of throwing an
AssertionError."
kav-ya,2014-09-07 03:12:02,https://api.github.com/repos/nylas/sync-engine/git/commits/f32bc58346388e2dac743a1b04483b52e3fc46aa,f32bc58346388e2dac743a1b04483b52e3fc46aa,"Remove migration 091, not needed anymore."
kav-ya,2014-09-07 00:41:53,https://api.github.com/repos/nylas/sync-engine/git/commits/3099b8ba7d34314cdbe6471f0befb71f9a010874,3099b8ba7d34314cdbe6471f0befb71f9a010874,[SCHEMA] Revert EAS passwords migration.
spang,2014-09-06 23:47:42,https://api.github.com/repos/nylas/sync-engine/git/commits/f3c89983b88bab734c6fca68286d9bd125f77042,f3c89983b88bab734c6fca68286d9bd125f77042,"Consolidate ALTER statements for migration performance.

Summary:
Doing multiple ALTERs separately may result in multiple table copies. This
modification makes this migration run in ~3min on production. (Not sure what
it was before except for ""longer"".)

Test Plan: comparison of emitted SQL with echo=True

Reviewers: charles

Reviewed By: charles

Differential Revision: https://review.inboxapp.com/D430"
spang,2014-09-06 23:39:43,https://api.github.com/repos/nylas/sync-engine/git/commits/1d93e6646e1f8f8baf438d6df2957a533bdacbf3,1d93e6646e1f8f8baf438d6df2957a533bdacbf3,"Consolidate ALTER statements and remove subquery within DELETE.

MySQL won't allow a DELETE with a subquery on the same table in case of
cycles, so we need to execute the subquery separately. We also combine
ALTER statements on the same table to let the database optimize the
operation."
kav-ya,2014-09-06 22:19:59,https://api.github.com/repos/nylas/sync-engine/git/commits/cbbd6b6b189b132b674055dcb18dd1844d368204,cbbd6b6b189b132b674055dcb18dd1844d368204,Revert encryption migration.
kav-ya,2014-09-06 03:12:03,https://api.github.com/repos/nylas/sync-engine/git/commits/bb3e06497ee62de34208d40c570f62c403bacb1c,bb3e06497ee62de34208d40c570f62c403bacb1c,Remove tests/general/test_storage.py too
emfree,2014-09-06 02:45:46,https://api.github.com/repos/nylas/sync-engine/git/commits/863bc480d5a27f11ca0d6b979cf0b82f02e8e8a2,863bc480d5a27f11ca0d6b979cf0b82f02e8e8a2,"Revert ""Fail more informatively when tests are affected by syncback race condition.""

This reverts commit 2495171ea09ac48f08b8e1bf82b17041acb5fa5f.

Reason for rollback: causes IOError when you try to run the whole test suite."
kav-ya,2014-09-06 01:32:56,https://api.github.com/repos/nylas/sync-engine/git/commits/05b4d08406346445638d4575dc450aeced53cc13,05b4d08406346445638d4575dc450aeced53cc13,"Revert encryption of secrets, blocks.

Existing data on s3 has to be encrypted before this is rolled out
so as to preserve data integrity and ensure accurate encryption status
is stored in the Block table.

Commits reverted -
a8f4be: ""Check for None in migration 088.""
c9bd77: ""Helper script to re-encrypt secrets.""
af6cb8: ""New scheme for EAS passwords encryption.""
eb47f4: ""[SCHEMA][DEPENDENCIES] Encryption of secrets (passwords, refresh_tokens) and blocks.""
        Conflicts:
	        inbox/models/roles.py
	        requirements.txt
	        tests/data/base_dump.sql
	        tests/general/test_storage.py

Migrations renamed, test DB updated too.

Sync runs as before.
All tests pass."
emfree,2014-09-06 02:18:16,https://api.github.com/repos/nylas/sync-engine/git/commits/14e7c06f097ee51f44f1c975d09cd1a8af1f3b42,14e7c06f097ee51f44f1c975d09cd1a8af1f3b42,Remove unused test fixture.
emfree,2014-09-06 02:14:01,https://api.github.com/repos/nylas/sync-engine/git/commits/2495171ea09ac48f08b8e1bf82b17041acb5fa5f,2495171ea09ac48f08b8e1bf82b17041acb5fa5f,"Fail more informatively when tests are affected by syncback race condition.

If you have a syncback service running in the background and talking to the
test database, it will grab actions enqueued by the tests, causing the tests to
fail cryptically. Detect this case, and raise a more informative error."
emfree,2014-09-05 22:18:54,https://api.github.com/repos/nylas/sync-engine/git/commits/044234dd099c32b0bd345fae9f4fe1e49927fd00,044234dd099c32b0bd345fae9f4fe1e49927fd00,"Don't explicitly kill greenlets in unit tests.

We don't actually need to do this."
dlitz,2014-09-05 20:56:01,https://api.github.com/repos/nylas/sync-engine/git/commits/cee8181e8c03406fb14b2d41a675f7dbdd676436,cee8181e8c03406fb14b2d41a675f7dbdd676436,"setup.sh: Try harder to upgrade setuptools

Summary:
Ubuntu precise and Debian wheezy come with an old version of
python-setuptools, which is actually an obsolete fork of setuptools
called 'distribute'.  distribute prevents itself from upgrading to the
original setuptools, i.e. ""easy_install 'setuptools>=5.3'"" is a no-op.

distribute has since been merged back into setuptools, and new versions
of pip are capable of properly upgrading setuptools, so we must upgrade
pip before upgrading setuptools.

It looks like I broke this in 8f0fa83a3bf3a2fdd9120a42e72e9deffac9b791.

Test Plan:
- Fully provisioning from scratch is still broken, but after some manual
  tweaking of unrelated stuff, ""easy_install --version"" now returns
  ""setuptools 5.7"".

Reviewers: charles, spang

Reviewed By: spang

Differential Revision: https://review.inboxapp.com/D423"
emfree,2014-09-05 19:35:07,https://api.github.com/repos/nylas/sync-engine/git/commits/4d294f8e05d2e16c03f0d837cf1f67bf3d5d183a,4d294f8e05d2e16c03f0d837cf1f67bf3d5d183a,"Validate recipients for drafts/sending.

Summary:
Add logic to validate the formatting of the to/cc/bcc fields for the drafts and
Fsending APIs. Also validate the actual email addresses to the extent possible
for the /send endpoint, since we might as well fail directly if you try to send
to an invalid email address.

Fixes T374.

Test Plan: Unit tests added.

Reviewers: charles

Reviewed By: charles

Maniphest Tasks: T374

Differential Revision: https://review.inboxapp.com/D426"
emfree,2014-09-05 19:01:42,https://api.github.com/repos/nylas/sync-engine/git/commits/9dbd08dc0a7f5424096407cad7778a68522dc422,9dbd08dc0a7f5424096407cad7778a68522dc422,"Mark individual messages as read/unread when the unread tag is removed/added.

Summary: Fixes T375.

Test Plan: Unit tests added.

Reviewers: kav-ya

Reviewed By: kav-ya

Maniphest Tasks: T375

Differential Revision: https://review.inboxapp.com/D422"
kav-ya,2014-09-05 18:13:45,https://api.github.com/repos/nylas/sync-engine/git/commits/82917fa6adc6b956659c6110900053036130e306,82917fa6adc6b956659c6110900053036130e306,Fix imports + global var in ./bin/syncback-service
grinich,2014-09-05 04:20:52,https://api.github.com/repos/nylas/sync-engine/git/commits/d5953dec57de3f365233541c963a5eae0df07616,d5953dec57de3f365233541c963a5eae0df07616,share ports 5000-5009 with host
kav-ya,2014-09-04 20:22:16,https://api.github.com/repos/nylas/sync-engine/git/commits/15a196d6a679c6f0d8a924ef970dfe4bf0f79b31,15a196d6a679c6f0d8a924ef970dfe4bf0f79b31,"Sendmail refactor.

Summary:
Code duplication increases the likelihood of bugs,
makes it hard to read/reason about and also makes
updating it not fun.

Gmail/generic sendmail code was identical, therefore
restructure to eliminate the duplication.

Test Plan:
Tests pass as before.
imap/network/test_send.py added too

Reviewers: charles

Reviewed By: charles

Differential Revision: https://review.inboxapp.com/D412"
khamidou,2014-09-04 08:41:18,https://api.github.com/repos/nylas/sync-engine/git/commits/bea50f482869b0724a9780d7751bdf88c8e58583,bea50f482869b0724a9780d7751bdf88c8e58583,"Fix self-sending with namecheap

Summary: Charles, I looked into T334. It was simply a configuration issue. Also, I've added a couple commented lines to postel.py to enable debug logging. It may come handy someday.

Test Plan: tested a self send using the client.

Reviewers: charles

Reviewed By: charles

Projects: #inbox-sync

Maniphest Tasks: T334

Differential Revision: https://review.inboxapp.com/D400"
spang,2014-09-04 03:21:24,https://api.github.com/repos/nylas/sync-engine/git/commits/e27b72622f5729036c0f698f95ee1c065c8effaa,e27b72622f5729036c0f698f95ee1c065c8effaa,"Use raw SQL queries in migration 084 for performance.

Summary:
Even after the ALTER TABLE completes, this migration is hella slow. This
update eliminates unnecessary work by executing raw SQL instead of queries
via the ORM.

Test Plan: Ran it. Way faster.

Reviewers: kav-ya

Reviewed By: kav-ya

Differential Revision: https://review.inboxapp.com/D406"
kav-ya,2014-09-04 01:39:13,https://api.github.com/repos/nylas/sync-engine/git/commits/4fd1e0860e37f8dd424af340ab7ff34c4581d2ea,4fd1e0860e37f8dd424af340ab7ff34c4581d2ea,"Revert ""[SCHEMA] Store Message.to_addr as a BigJSON (rather than a JSON).""
This reverts commit cb749b26e8484da0aea7eafb014284b791deb022; it's overkill."
kav-ya,2014-09-04 01:25:50,https://api.github.com/repos/nylas/sync-engine/git/commits/cb749b26e8484da0aea7eafb014284b791deb022,cb749b26e8484da0aea7eafb014284b791deb022,"[SCHEMA] Store Message.to_addr as a BigJSON (rather than a JSON).
We expand rather than truncate since this field may be used in sending
for e.g. if the message is a draft that was created on the remote.

Fixes T387."
kav-ya,2014-09-04 01:08:34,https://api.github.com/repos/nylas/sync-engine/git/commits/a8f4befba27c9cf072d6253a0b7535a89a8fc309,a8f4befba27c9cf072d6253a0b7535a89a8fc309,Check for None in migration 088.
kav-ya,2014-09-03 23:28:11,https://api.github.com/repos/nylas/sync-engine/git/commits/c9bd776ab5e103ea530305407d3786e9de28a4ae,c9bd776ab5e103ea530305407d3786e9de28a4ae,Helper script to re-encrypt secrets.
kav-ya,2014-09-03 23:29:39,https://api.github.com/repos/nylas/sync-engine/git/commits/6a2fd504378cd1a8804eefca87afed3abf939aca,6a2fd504378cd1a8804eefca87afed3abf939aca,"Syncback deletes of non-Inbox created drafts.
Fixes T345."
spang,2014-09-03 23:26:51,https://api.github.com/repos/nylas/sync-engine/git/commits/3af26a73619293c70b939cec3ed6ba4cc34f6bb5,3af26a73619293c70b939cec3ed6ba4cc34f6bb5,"Define polling greenlet vars outside try/finally block.

Fixes T388."
dlitz,2014-09-03 19:33:32,https://api.github.com/repos/nylas/sync-engine/git/commits/8f0fa83a3bf3a2fdd9120a42e72e9deffac9b791,8f0fa83a3bf3a2fdd9120a42e72e9deffac9b791,"setup/startup: ensure recent pip; ignore VCS URIs in check_requirements()

Summary:
This will hopefully fix this exception when deploying under Debian
wheezy:

    Traceback (most recent call last):
      File ""/srv/inbox/bin/inbox-start"", line 70, in <module>
        main()
      File ""/usr/local/lib/python2.7/dist-packages/click/core.py"", line 488, in __call__
        return self.main(*args, **kwargs)
      File ""/usr/local/lib/python2.7/dist-packages/click/core.py"", line 474, in main
        self.invoke(ctx)
      File ""/usr/local/lib/python2.7/dist-packages/click/core.py"", line 659, in invoke
        ctx.invoke(self.callback, **ctx.params)
      File ""/usr/local/lib/python2.7/dist-packages/click/core.py"", line 325, in invoke
        return callback(*args, **kwargs)
      File ""/srv/inbox/bin/inbox-start"", line 43, in main
        preflight()
      File ""/srv/inbox/inbox/util/startup.py"", line 133, in preflight
        check_requirements(requirements_path)
      File ""/srv/inbox/inbox/util/startup.py"", line 32, in check_requirements
        require(x)
      File ""/usr/local/lib/python2.7/dist-packages/pkg_resources.py"", line 745, in require
        needed = self.resolve(parse_requirements(requirements))
      File ""/usr/local/lib/python2.7/dist-packages/pkg_resources.py"", line 603, in resolve
        requirements = list(requirements)[::-1]
      File ""/usr/local/lib/python2.7/dist-packages/pkg_resources.py"", line 2717, in parse_requirements
        ""version spec"")
      File ""/usr/local/lib/python2.7/dist-packages/pkg_resources.py"", line 2682, in scan_list
        raise ValueError(msg, line, ""at"", line[p:])
    ValueError: ('Expected version spec in', 'git+https://github.com/inboxapp/zerorpc-python.git@master#egg=zerorpc', 'at', '+https://github.com/inboxapp/zerorpc-python.git@master#egg=zerorpc')

Test Plan:
Manually check that bin/inbox-start works either in my dev VM, or we'll just
test it in staging before we deploy.

Reviewers: spang, charles

Differential Revision: https://review.inboxapp.com/D403"
kav-ya,2014-09-03 20:27:44,https://api.github.com/repos/nylas/sync-engine/git/commits/5fb936fdfe3571f4e33be56cc679696257d0a4e6,5fb936fdfe3571f4e33be56cc679696257d0a4e6,Migration 084 update.
kav-ya,2014-09-03 07:57:44,https://api.github.com/repos/nylas/sync-engine/git/commits/af6cb824dc79bfa5e98de63393185d3c5e48e286,af6cb824dc79bfa5e98de63393185d3c5e48e286,New scheme for EAS passwords encryption.
kav-ya,2014-09-03 07:56:40,https://api.github.com/repos/nylas/sync-engine/git/commits/f0a74accce4ce373f01e36a7a27f6b54447cbc42,f0a74accce4ce373f01e36a7a27f6b54447cbc42,Move migrations imports into upgrade/downgrade fns
spang,2014-09-03 05:14:19,https://api.github.com/repos/nylas/sync-engine/git/commits/471be62c96104c33b110d924d89a77a92264700c,471be62c96104c33b110d924d89a77a92264700c,"Rewrite migration 085 for performance.

We now make only 3 queries (one of which can be quite slow, but not TOO
slow) followed by O(n) inserts, rather than... what the ORM was doing.
Whatever that might have been.

We also no longer fail to run due to the addition of columns to Blocks,
which was added more recently."
dlitz,2014-09-03 02:46:52,https://api.github.com/repos/nylas/sync-engine/git/commits/69685d62727b106fb8f3d82ca2e7f8b334a85c79,69685d62727b106fb8f3d82ca2e7f8b334a85c79,"Fix 'error: sodium.h: No such file or directory' and related issues

Summary:
- Revert ""Fix pushd usage in setup.sh""
- Revert ""[setup/libsodium] Update to latest version of libsodium.""
- Revert ""[build/setup.sh] Add libsodium setup to install flow. NOTE: for some reason we hang on pip install -e .""
- Fix 'error: sodium.h: No such file or directory' while installing pynacl
- requirements.txt: Consistently use HTTPS to fetch code from GitHub
- Don't ship with editable (-e) repos in requirements.txt

Test Plan: - Destroy my vagrant VM, then run ""vagrant up"" to re-provision it.

Reviewers: charles, kav-ya

Reviewed By: kav-ya

Subscribers: charles, khamidou

Differential Revision: https://review.inboxapp.com/D394"
dlitz,2014-09-02 23:54:18,https://api.github.com/repos/nylas/sync-engine/git/commits/18db5722ff6cca9e76e94a51ab01ccd18d6f535a,18db5722ff6cca9e76e94a51ab01ccd18d6f535a,"Don't ship with editable (-e) repos in requirements.txt

pip clones such repos into src/, and it prompts you if you try to change the
location of the remote:

    Obtaining zerorpc from git+https://github.com/inboxapp/zerorpc-python.git@master#egg=zerorpc (from -r requirements.txt (line 21))
      git clone in ./src/zerorpc exists with URL git://github.com/inboxapp/zerorpc-python.git
      The plan is to install the git repository https://github.com/inboxapp/zerorpc-python.git
    What to do?  (s)witch, (i)gnore, (w)ipe, (b)ackup Your response ('exit') was not one of the expected responses: s, i, w, b
    What to do?  (s)witch, (i)gnore, (w)ipe, (b)ackup Exception:
    Traceback (most recent call last):
      File ""/usr/lib/python2.7/dist-packages/pip/basecommand.py"", line 126, in main
        self.run(options, args)
      File ""/usr/lib/python2.7/dist-packages/pip/commands/install.py"", line 223, in run
        requirement_set.prepare_files(finder, force_root_egg_info=self.bundle, bundle=self.bundle)
      File ""/usr/lib/python2.7/dist-packages/pip/req.py"", line 930, in prepare_files
        req_to_install.update_editable(not self.is_download)
      File ""/usr/lib/python2.7/dist-packages/pip/req.py"", line 378, in update_editable
        vcs_backend.obtain(self.source_dir)
      File ""/usr/lib/python2.7/dist-packages/pip/vcs/git.py"", line 105, in obtain
        if self.check_destination(dest, url, rev_options, rev_display):
      File ""/usr/lib/python2.7/dist-packages/pip/vcs/__init__.py"", line 204, in check_destination
        response = ask('What to do?  %s' % prompt[0], prompt[1])
      File ""/usr/lib/python2.7/dist-packages/pip/util.py"", line 103, in ask
        response = raw_input(message)
    EOFError: EOF when reading a line

The git repos in src/ also don't get cleaned by git-clean, which is
slightly annoying."
dlitz,2014-09-01 08:45:26,https://api.github.com/repos/nylas/sync-engine/git/commits/231a5b2a9b6ccff854e21f924d7c22482de28957,231a5b2a9b6ccff854e21f924d7c22482de28957,requirements.txt: Consistently use HTTPS to fetch code from GitHub
dlitz,2014-09-01 08:43:32,https://api.github.com/repos/nylas/sync-engine/git/commits/139f7a6e61dcee21667c890d86de9c0ec5631ab1,139f7a6e61dcee21667c890d86de9c0ec5631ab1,"Fix 'error: sodium.h: No such file or directory' while installing pynacl

This removes -e (`pip install --editable`) from the pynacl line in
requirements.txt, and uses git+https:// because pip will break if the
URI isn't in the format `vcs+protocol://...`

This may be related to the following pynacl issue:

    https://github.com/pyca/pynacl/issues/79"
dlitz,2014-09-03 00:41:20,https://api.github.com/repos/nylas/sync-engine/git/commits/0874d5fe35e89f8bca20359485fe999004911a7f,0874d5fe35e89f8bca20359485fe999004911a7f,"Revert ""[build/setup.sh] Add libsodium setup to install flow. NOTE: for some reason we hang on pip install -e .""

This reverts commit 4f9e5e24b4cbde7effeea4e5c38dba335ca74668."
dlitz,2014-09-03 00:41:19,https://api.github.com/repos/nylas/sync-engine/git/commits/4011a211ac9b5da7ec8f866852870a0042d25bff,4011a211ac9b5da7ec8f866852870a0042d25bff,"Revert ""[setup/libsodium] Update to latest version of libsodium.""

This reverts commit 453e6c141434ce28482580ec054f6d87948321c2."
dlitz,2014-09-03 00:41:18,https://api.github.com/repos/nylas/sync-engine/git/commits/ca2ccacee35fd1ca27346b6e2b591b2d0d0e295b,ca2ccacee35fd1ca27346b6e2b591b2d0d0e295b,"Revert ""Fix pushd usage in setup.sh""

This reverts commit af90e2c989664c76c78a6b24e135c370fa41a0a4."
spang,2014-09-02 22:45:32,https://api.github.com/repos/nylas/sync-engine/git/commits/0e7d9591c09df3a9174a4915bc8f25cf92751f10,0e7d9591c09df3a9174a4915bc8f25cf92751f10,Fix a typo.
kav-ya,2014-09-02 21:27:27,https://api.github.com/repos/nylas/sync-engine/git/commits/2e710fe584022df2fcabc1e8ab920cb690ed66d3,2e710fe584022df2fcabc1e8ab920cb690ed66d3,s/message/message_id in File API repr
spang,2014-09-02 21:08:01,https://api.github.com/repos/nylas/sync-engine/git/commits/0392ca2efccec4cbcc604479fbf060ea77472266,0392ca2efccec4cbcc604479fbf060ea77472266,"Don't validate S3 buckets.

This is an extra call every time that's pretty much wasted."
spang,2014-09-02 20:19:05,https://api.github.com/repos/nylas/sync-engine/git/commits/f6440ed5af7ed12f69d0a64226941d33b9a61755,f6440ed5af7ed12f69d0a64226941d33b9a61755,"Revert ""Show API-uploaded files along attachments""

This reverts commit 8f55c46e4b5f73864df7247e4b2bdb33fc9007f4, which
fails regression."
spang,2014-09-02 19:48:26,https://api.github.com/repos/nylas/sync-engine/git/commits/961884ffa2c5f8f3b19445107b872d617f5258f3,961884ffa2c5f8f3b19445107b872d617f5258f3,Fix another bug in console.
spang,2014-09-02 19:44:52,https://api.github.com/repos/nylas/sync-engine/git/commits/c6b85c1d3beb41e92ddc57aaa515a0c29713a114,c6b85c1d3beb41e92ddc57aaa515a0c29713a114,Fix console.
spang,2014-09-02 15:52:02,https://api.github.com/repos/nylas/sync-engine/git/commits/af90e2c989664c76c78a6b24e135c370fa41a0a4,af90e2c989664c76c78a6b24e135c370fa41a0a4,Fix pushd usage in setup.sh
spang,2014-09-02 15:47:56,https://api.github.com/repos/nylas/sync-engine/git/commits/ba402d3bb374ebc02b3cae9469ac2bdbd8f4c073,ba402d3bb374ebc02b3cae9469ac2bdbd8f4c073,Fix spacing.
khamidou,2014-09-02 15:35:54,https://api.github.com/repos/nylas/sync-engine/git/commits/8f55c46e4b5f73864df7247e4b2bdb33fc9007f4,8f55c46e4b5f73864df7247e4b2bdb33fc9007f4,"Show API-uploaded files along attachments

Summary:
The problem: a GET request on /files/ returns only email attachments. To change this I modified the filtering options. Instead of only querying Parts I changed the code to query Blocks and filter blocks who don't have a content type (IIRC email parts must have a content type and we force API-uploaded files to have one too).

Emfree, could you tell me what you think of this?

Also, could you tell me why we are making an api-uploaded file a block? Wouldn't it make more sense to have it be a part which could be linked to a Draft?

Fixes T298.

Test Plan: Applied the changes. Checked that a request on /files returned API-uploaded files.

Reviewers: emfree, spang

Reviewed By: spang

Maniphest Tasks: T298

Differential Revision: https://review.inboxapp.com/D334"
spang,2014-09-01 23:45:44,https://api.github.com/repos/nylas/sync-engine/git/commits/8d0f571483d0a1f51c9c94686b9243228d296c44,8d0f571483d0a1f51c9c94686b9243228d296c44,"Fix bugs in migration 085 which caused OOM on large datasets.

It was trying to load all threads and all messages into memory at the
same time, and also does not seem to explicitly commit changed data."
kav-ya,2014-08-20 21:55:30,https://api.github.com/repos/nylas/sync-engine/git/commits/eb47f407c99661422beb9ad6f4dcf88ac4b668f6,eb47f407c99661422beb9ad6f4dcf88ac4b668f6,"[SCHEMA][DEPENDENCIES] Encryption of secrets (passwords, refresh_tokens) and blocks.

Summary:
We use PyNaCl's symmetric key encryption scheme, which implements
the Salsa20 stream cipher algorithm, with a unique 24-byte nonce that
is generated at each invocation and a static key that:
- is generated using the bin/create-encryption-keys script
- stored in the secrets config file specified in the config.
(defaults are: etc/secrets-dev.yml, etc/secrets-test.yml)

This implementation replaces our previous local/remote vault.

NOTE:
We currently use our own fork of pynacl, due to install issues with pyca/pynacl.
See dicussion here: https://github.com/pyca/pynacl/pull/106
Our fork does *not* change any functionality, merely fixes a typo in the name of a test.
TODO: Move to PyNaCl once that's resolved and we can actually install it.

Test Plan:
Added -
tests/general/test_secret.py
tests/general/test_storage.py

All tests pass.
Sync runs as before for an oauth and password test account.

Reviewers: spang, dlitz

Reviewed By: dlitz

Subscribers: dlitz, emfree

Differential Revision: https://review.inboxapp.com/D358"
kav-ya,2014-08-29 23:14:45,https://api.github.com/repos/nylas/sync-engine/git/commits/59c0d196b460c3b8a18f287278299aa9e315b659,59c0d196b460c3b8a18f287278299aa9e315b659,s/namespace/namespace_id in tests/api/test_events.py
emfree,2014-08-29 21:18:56,https://api.github.com/repos/nylas/sync-engine/git/commits/95eb587d0c671923b3a2cb03c824b819e59c1236,95eb587d0c671923b3a2cb03c824b819e59c1236,"Update API terminology.

Summary:
This commit makes the following changes to the API:

* Rename the 'namespace' attribute of all objects to 'namespace_id'.
* Rename the 'thread' attribute of messages and drafts to 'thread_id'
* Rename the 'messages' and 'drafts attributes of threads to 'message_ids' and
  'draft_ids', respectively.
* Rename the 'thread' query parameter for filtering messages and drafts to
  'thread_id'.

The point is to consistently differentiate id fields from actual object
representations in the API.
Fixes T316.

Test Plan: Run unit tests, grep docs.

Reviewers: bengotow, kav-ya

Reviewed By: kav-ya

Maniphest Tasks: T316

Differential Revision: https://review.inboxapp.com/D369"
emfree,2014-08-29 21:02:17,https://api.github.com/repos/nylas/sync-engine/git/commits/9bb1d88b7cae007eb50a715fc320395bb388ec49,9bb1d88b7cae007eb50a715fc320395bb388ec49,"[SCHEMA] Rename account.default_calendar_id foreign key constraint.

Summary:
This is an attempt to work around this bug:
http://bugs.mysql.com/bug.php?id=70171
in MySQL versions 5.6.12 and 5.6.13, which was causing migration 083 to fail
when run against RDS.

Test Plan:
Run migrations both on a local VM previously synced to head, and on
gunks.

Reviewers: charles

Reviewed By: charles

Differential Revision: https://review.inboxapp.com/D388"
emfree,2014-08-29 19:05:21,https://api.github.com/repos/nylas/sync-engine/git/commits/dc90916bc4b5dfdacdcc3fc87cad6c65c2051e78,dc90916bc4b5dfdacdcc3fc87cad6c65c2051e78,"Refactor IMAP sync.

Summary:
This commit restructures the IMAP sync engine logic to use a more
object-oriented design, favoring implementation inheritance over explicit
state-and-implementation passing.

The primary motivation for this is that I was finding it really challenging to
do surgery on the mailsync code, for two reasons. First, passing functions
around made it very difficult to see where any given function is being invoked,
because you have to know that create_gmail_message(...) may actually be called
as msg_create_fn(...), etc. Second, it's really hard to modify the state
that's being passed around, because you have to change like seven levels of
function parameters. This pattern was leading us to do weird stuff like reading the
account_id from the crispin_client, or repeatedly query for things we already in
principle know, like the active Namespace instance.
This carries a significant performance cost when aggregated over the lifetime
of a sync.

So this commit is essentially preparation for making targeted changes
to address both performance and correctness. Concretely, it does the following:
* Implement most logic in methods of the FolderSyncEngine class, which runs the
  sync state machine. Implement derived classes CondstoreFolderSyncEngine and
  GmailFolderSyncEngine, which override specific functionality for condstore
  sync and Gmail sync.

* Move the SyncMonitor logic (the thing that gets instantiated from the
  SyncService and starts the individual folder syncs) into its own module
  backends.imap.monitor. The SyncService actually instantiates lightweight
  derived classes GmailSyncMonitor, GenericSyncMonitor, etc. depending on
  provider, but the only difference among them is which type of
  FolderSyncEngine gets instantiated.

Smaller associated changes:
* Rename backends.imap.account to backends.imap.common, to prevent confusion
  over whether 'account' is an Account instance or a module.
* Use structlog's greenlet-local context facility to bind context to the logger
  on a per-greenlet basis. This means that we can just do log = get_logger() in
  in a greenlet and have it come with the right bound attributes, instead of
  needing to pass around a log object.
* Define 'mailsync_session_scope' as an alias for
  'session_scope(ignore_soft_deletes=False)'
* Remove some unused code.
* Clean up some parameter mismatches in condstore code.

This is obviously a pretty gnarly patch, but I think if we eat our wheaties now
it will pay off later.

Test Plan:
Working on it. Probably going to do a 'sync-diff' for various
providers, by running a sync with and without this change, and checking that
the results are the same.

Reviewers: khamidou, spang

Reviewed By: khamidou, spang

Subscribers: kav-ya, charles

Differential Revision: https://review.inboxapp.com/D378"
emfree,2014-08-29 18:03:15,https://api.github.com/repos/nylas/sync-engine/git/commits/1a70d982e672afb1053a02fb16e64cce4b86a92a,1a70d982e672afb1053a02fb16e64cce4b86a92a,"Reduce IDLE timeout.

Summary:
This seems like the most expedient way to ensure that we detect flag changes
with at least reasonable latency.

Fixes T319.

Test Plan:
Mark a thread as read in the Gmail web UI; check that this gets
propagated to the API within a reasonable amount of time if (and only if) a
short idle timeout is set.

Reviewers: spang

Reviewed By: spang

Maniphest Tasks: T319

Differential Revision: https://review.inboxapp.com/D387"
emfree,2014-08-29 03:13:08,https://api.github.com/repos/nylas/sync-engine/git/commits/69630688f5400daaa97d24ef9b8ec0d7b602ca23,69630688f5400daaa97d24ef9b8ec0d7b602ca23,"Eager-load account.namespace

We really never want the account but not the namespace."
khamidou,2014-08-28 13:37:54,https://api.github.com/repos/nylas/sync-engine/git/commits/7d9244507bfc0a62b300ae036879c94d8c7682d2,7d9244507bfc0a62b300ae036879c94d8c7682d2,"Delete accounts

Summary:
Christine, Charles, Eben

I've implemented the minimum viable code for deleting accounts. There's not a lot of changes in this differential;  mostly I changed foreign keys definitions where needed. I also extended session_scope() to autocommit when needed.

One thing I'd like you to review in priority is the deletion logic. Right now it consists in stopping the account syncing, waiting 60 secs and and then marking the account as deleted.

This is needed because otherwise inbox-start may crash. I think it's okay to wait like this, though one minute is a little optimistic. What do you think about it?

Finally, I added a small script, `garbage-collect-db`, which removes accounts marked as deleted older than ten days.

Ps: migrations are coming in the next version of the review.

Test Plan: Ran a test which deleted accounts at teardown. Checked that the accounts were deleted.

Reviewers: spang, charles, emfree

Reviewed By: emfree

Differential Revision: https://review.inboxapp.com/D351"
khamidou,2014-08-28 09:12:16,https://api.github.com/repos/nylas/sync-engine/git/commits/1fda5a2a57abd6200186a840331e8e6ceba90016,1fda5a2a57abd6200186a840331e8e6ceba90016,"Wrap greenlet-spawning code inside a try/finally block

Summary:
Eben,

This is a patch extracted from the account deletion diff. It simply wraps the initial sync code inside a try/finally block so that the greenlets we spawn during the initial sync get killed when the main greenlet is killed.

Test Plan: Ran a sync.

Reviewers: emfree

Reviewed By: emfree

Maniphest Tasks: T330

Differential Revision: https://review.inboxapp.com/D380"
emfree,2014-08-28 01:36:34,https://api.github.com/repos/nylas/sync-engine/git/commits/7599b3d87ccbad35d8eae01ea50af4e64ae7b705,7599b3d87ccbad35d8eae01ea50af4e64ae7b705,Fix system auth tests.
emfree,2014-08-27 20:57:05,https://api.github.com/repos/nylas/sync-engine/git/commits/b4ffbba68df28d7f8cb6eaa9b83fa1121b757772,b4ffbba68df28d7f8cb6eaa9b83fa1121b757772,"Also install EAS-specific dependencies in setup.sh, when applicable."
dlitz,2014-08-27 20:38:41,https://api.github.com/repos/nylas/sync-engine/git/commits/56d8b9ba88888c33e466771e91956c3daff7e15b,56d8b9ba88888c33e466771e91956c3daff7e15b,"Vagrantfile: Fix `config.vm` -> `override.vm` :-(

Summary:
Oops.  This fixes the following error:

    The checksum of the dowloaded box did not match the expected
    value. Please verify that you have the proper URL setup and that
    you're downloading the proper file.

    Expected: b79e900774b6a27500243d28bd9b1770e428faa3d8a3e45997f2a939b2b63570
    Received: 9a8bdea70e1d35c1d7733f587c34af07491872f2832f0bc5f875b536520ec17e

Test Plan:
1. Wipe out my ~/.vagrant.d and my .vagrant directory
2. Run `vagrant up` on Linux (using the default virtualbox provider)

Reviewers: emfree

Reviewed By: emfree

Differential Revision: https://review.inboxapp.com/D381"
kav-ya,2014-08-27 18:43:57,https://api.github.com/repos/nylas/sync-engine/git/commits/acbf607d8c9f90a7a58f91517044b334022f9279,acbf607d8c9f90a7a58f91517044b334022f9279,"Draft reconciliation should use version, not public_id.
tests/general/test_reconcile_message updated too."
emfree,2014-08-27 17:33:06,https://api.github.com/repos/nylas/sync-engine/git/commits/e6dbffb563872e9ab9d2a6c720132801ccb89ceb,e6dbffb563872e9ab9d2a6c720132801ccb89ceb,"More efficiently update contacts from messages.

Summary:
When we update contacts after syncing a message, it's faster* to do one database
query to get existing contacts, instead of doing a bunch of queries serially,
one for each participant in the message.

* faster = ~50-100ms less time for messages with many recipients.

Test Plan: Unit tests added.

Reviewers: khamidou

Reviewed By: khamidou

Differential Revision: https://review.inboxapp.com/D379"
emfree,2014-08-27 17:31:47,https://api.github.com/repos/nylas/sync-engine/git/commits/b0e0d53a029b723403501db39363880429cd65b6,b0e0d53a029b723403501db39363880429cd65b6,"Properly convert HTML character refs in snippets.

Summary:
Instead of dropping character references like &#225; or &amp;, convert them to
unicode. Fixes Github issue #82.

Test Plan: Regression test added.

Reviewers: khamidou

Reviewed By: khamidou

Differential Revision: https://review.inboxapp.com/D370"
emfree,2014-08-27 01:15:32,https://api.github.com/repos/nylas/sync-engine/git/commits/08dec045515eb5336aa810a6177a2d6a2877303d,08dec045515eb5336aa810a6177a2d6a2877303d,"Fix Message.references values in test DB dump.

We save them as lists when syncing, but they were saved as tab-joined strings
in the test database dump. Which is probably why unit tests didn't catch T338."
emfree,2014-08-26 21:54:50,https://api.github.com/repos/nylas/sync-engine/git/commits/174c9f4446caf2ad9008e9287d1a5568e06c9257,174c9f4446caf2ad9008e9287d1a5568e06c9257,"Keep calendar table when running bin/clear-db

Otherwise you get 'Cannot delete or update a parent row: a foreign key
constraint fails', because the accoutn table maintains a foreign key reference
to a default calendar."
emfree,2014-08-26 21:10:46,https://api.github.com/repos/nylas/sync-engine/git/commits/2d8dc6849aa3907ee587b7f2cdac481b325eb3af,2d8dc6849aa3907ee587b7f2cdac481b325eb3af,"Apply distinct() to filtered API results.

Summary:
If we don't do this, the problem is that when we join threads to messages, the
limit parameter is applied to the resulting thread-message pairs, not to
threads alone. This leads to wrong behavior when multiple messages on a thread
match, say, the recipient address you're filtering on.

Fixes T336 and T337.

Test Plan: Regression test added.

Reviewers: kav-ya

Reviewed By: kav-ya

Maniphest Tasks: T336

Differential Revision: https://review.inboxapp.com/D376"
kav-ya,2014-08-26 20:13:55,https://api.github.com/repos/nylas/sync-engine/git/commits/cf0902a07c9d9cc104e266e35198ad826f219e10,cf0902a07c9d9cc104e266e35198ad826f219e10,"Correctly set references header for reply drafts.

Summary: Fixes 338.

Test Plan: None

Reviewers: emfree

Reviewed By: emfree

Differential Revision: https://review.inboxapp.com/D375"
emfree,2014-08-26 18:22:04,https://api.github.com/repos/nylas/sync-engine/git/commits/b8d68f6f51c1c171f566854fe135bae92e42c672,b8d68f6f51c1c171f566854fe135bae92e42c672,"Support the 'attachment' tag on threads.

Summary:
If at least one message on a thread has attachments, add the 'attachment'
tag to that thread.

Note that this code doesn't properly handle the case in which you create a
draft with attachments, then update it to a draft that has no attachments.
Since we're in the process of redoing draft versioning, I propose that we make
a bug to fix this after the new drafts stuff lands.

Fixes T323.

Test Plan:
Run migration script, and run a fresh sync. Each time, check
responses to /n/ns_id/threads?tag=attachment. Also update drafts unit
tests.

Reviewers: kav-ya

Reviewed By: kav-ya

Maniphest Tasks: T323

Differential Revision: https://review.inboxapp.com/D363"
kav-ya,2014-08-22 23:08:28,https://api.github.com/repos/nylas/sync-engine/git/commits/e799442f48251ccee3f7e9971350f349b01467ce,e799442f48251ccee3f7e9971350f349b01467ce,"[SCHEMA] Mutable drafts.

Summary:
Updating a draft does not create a new draft; merely updates the existing attrs +
bumps the version.

Key resulting changes -
* Draft update, delete, send API calls now require a 'version' in the request body.
This is used to determine if the operation can proceed.

* The X-INBOX-HEADER set at message creation and used to identify messages on the remote
(for reconciliation during mailsync, draft deletes) is now set to the version rather than
the public_id.

* remote_delete_draft fns operate on the version rather than the public_id.
We introduce an `extra_args` column in the ActionLog table - we don't really care about
the Message record for `delete_draft`; the version == inbox_uid of the Message may have been
updated since the time of the ActionLog record creation.
Therefore, store the inbox_uid too.

Test Plan:
api/test_drafts.py, general/system/test_drafts.py updated + pass.

Reviewers:
emfree

Differential Revision:
https://review.inboxapp.com/D364"
dlitz,2014-08-26 02:56:56,https://api.github.com/repos/nylas/sync-engine/git/commits/dac5a6531737ff4d47e2321f20800383da287349,dac5a6531737ff4d47e2321f20800383da287349,"Vagrantfile security improvements

Summary:
- Add SHA256 'box_download_checksum' to ensure integrity of boxes after
  downloading them over plaintext HTTP.

- Warn if 'vagrant-rekey-ssh' plugin is missing.

- Try to bind forwarded ports to localhost-only by default.  Note: Some
  (all?) versions of the vmware_fusion provider ignore this setting.

Test Plan: Ran 'vagrant up' on my machine, and looked at the results of 'netstat -tnlp'.

Reviewers: mg, emfree

Reviewed By: emfree

Differential Revision: https://review.inboxapp.com/D373"
emfree,2014-08-25 22:16:47,https://api.github.com/repos/nylas/sync-engine/git/commits/6ffa7837f103186d3fe6996c498f572dbd2f1b82,6ffa7837f103186d3fe6996c498f572dbd2f1b82,"Validate public_id values in URL paths.

We should consider changing the HasPublicID mixin design so that comparisons to
an invalid public id return no results, instead of raising StatementError. But
in the interim, just validate these URL fragments at the API level."
khamidou,2014-08-25 17:38:26,https://api.github.com/repos/nylas/sync-engine/git/commits/7b43d3624ba14dea7bb8c2c4d405654013b0c9c6,7b43d3624ba14dea7bb8c2c4d405654013b0c9c6,"Better (but not faster) system tests

Summary:
Charles,

I made a couple changes to the system tests:
- for_all_available_providers now sets up and teardowns test accounts (fixes T311).
- I extended test_sending to archive the email and then trash it.

I found a race condition in mailsync - sending would crash if tried to early in the sync because the folder mapping isn't stored in the db. I added a 30 seconds sleep to handle this. I don't know if it's worth it to go after this bug.

Test Plan: Ran the tests for a couple accounts.

Reviewers: charles

Reviewed By: charles

Maniphest Tasks: T311, T315

Differential Revision: https://review.inboxapp.com/D360"
spang,2014-08-25 16:58:30,https://api.github.com/repos/nylas/sync-engine/git/commits/7d595b00f4afec127fb485ad7015b1b553e0ed0b,7d595b00f4afec127fb485ad7015b1b553e0ed0b,Update outdated comment.
khamidou,2014-08-25 14:13:26,https://api.github.com/repos/nylas/sync-engine/git/commits/e7b8a395fba6d6af140f11d8e4babdf021f33c2b,e7b8a395fba6d6af140f11d8e4babdf021f33c2b,"Create archive folder when needed

Summary: It seems someone tried to archive emails for a non-gmail provider on Beta. This resulted into a large number of errors (https://app.getsentry.com/inbox/beta/group/29293091/). This diff fixes this bug (T328).

Test Plan: Added an archived tag to a thread in yahoo. Checked that the folder was created.

Reviewers: spang, emfree

Reviewed By: emfree

Maniphest Tasks: T328

Differential Revision: https://review.inboxapp.com/D367"
emfree,2014-08-22 21:40:56,https://api.github.com/repos/nylas/sync-engine/git/commits/7d489fafeb35193cf5c91ef0143970953e5eabac,7d489fafeb35193cf5c91ef0143970953e5eabac,"Propagate unread status changes to threads in update_metadata.

Test Plan:
Mark a Gmail thread as read in the web interface, and check that the
change gets propagated to the API response for the thread, when it wouldn't
before.

Reviewers: spang

Reviewed By: spang

Differential Revision: https://review.inboxapp.com/D359"
emfree,2014-08-22 19:10:17,https://api.github.com/repos/nylas/sync-engine/git/commits/da24d78716519502001177f3f2787eca2b67bc60,da24d78716519502001177f3f2787eca2b67bc60,"Reraise exceptions in the SyncbackWorker.

We need to do this so that the database session can be rolled back!"
bengotow,2014-08-21 20:30:09,https://api.github.com/repos/nylas/sync-engine/git/commits/9efa86a5efdf3791e49c242b4e80a6c405ba52e8,9efa86a5efdf3791e49c242b4e80a6c405ba52e8,"[docs] Sending should mention providing to,cc for replies"
emfree,2014-08-21 18:58:11,https://api.github.com/repos/nylas/sync-engine/git/commits/4ef5460dbc621fbf43b935a64f74a5720d88cfe8,4ef5460dbc621fbf43b935a64f74a5720d88cfe8,"Validate the namespace_id part of API URL paths.

This prevents a StatementError from being raised if you try to do something
like /n/bad%20id/threads, where the namespace_id part can't be decoded to an
integer.

Fixes T321."
emfree,2014-08-21 03:45:11,https://api.github.com/repos/nylas/sync-engine/git/commits/d7d68ac01aaefc3be624807adaf4e78533df7681,d7d68ac01aaefc3be624807adaf4e78533df7681,"Silence the Google apiclient logger.

We really don't need it to tell us what URL is being requested every single
time we sync events. Because logstash can't parse these, this was making it
hard to look at logstash error logs and figure out whether logstash is dropping
messages."
emfree,2014-08-21 00:52:48,https://api.github.com/repos/nylas/sync-engine/git/commits/ab47cde1c396b3cba6d00d83c5d16d2600a13ccc,ab47cde1c396b3cba6d00d83c5d16d2600a13ccc,"Don't use an SMTPConnectionPool.

Summary:
We don't really need to maintain an SMTP connection pool, because in general we
only rarely need an SMTP connection for an account. Currently, once we open a
connection we try to keep it around forever, which is not ideal.

Instead, we just open and close a connection on an as-needed basis. This
resolves issues we were seeing around messages not being sent because of
improperly handled SMTPServerDisconnected errors.

Test Plan:
Use system tests to send messages for various providers; use added
raise_once utility in inbox/util/debug.py to check that sending succeeds when
retrying after an SMTPServerDisconnected error.

Reviewers: kav-ya

Reviewed By: kav-ya

Differential Revision: https://review.inboxapp.com/D357"
emfree,2014-08-20 23:55:58,https://api.github.com/repos/nylas/sync-engine/git/commits/64bb6d22498c518bb1afc4426698ac1371fa6c9c,64bb6d22498c518bb1afc4426698ac1371fa6c9c,Remove outdated comment about ZeroRPC sync interface.
emfree,2014-08-20 22:49:52,https://api.github.com/repos/nylas/sync-engine/git/commits/9b009f3ee9cb480d7fbf38d591c3b5421ca7893e,9b009f3ee9cb480d7fbf38d591c3b5421ca7893e,"Make system auth tests work with EAS.

Summary:
They weren't working with EAS, because only inbox.auth.handler_from_provider
turns an 'unknown' provider into 'eas'.

Test Plan:
Run py.test tests/system/test_auth, as well as bin/inbox-auth, on
test accounts for Gmail, Outlook, Yahoo and EAS. Also verify that none of the
affected code is called from redwood.

Reviewers: charles

Reviewed By: charles

Differential Revision: https://review.inboxapp.com/D355"
emfree,2014-08-20 20:55:23,https://api.github.com/repos/nylas/sync-engine/git/commits/9ed7649d98bc4b1d3412047d0d5c50c1a5c8116c,9ed7649d98bc4b1d3412047d0d5c50c1a5c8116c,Fix check for accounts.py file in system tests.
kav-ya,2014-08-20 19:02:08,https://api.github.com/repos/nylas/sync-engine/git/commits/ccb31d149a697fa6dd34d5ed1ebfb4ab7e761fdb,ccb31d149a697fa6dd34d5ed1ebfb4ab7e761fdb,"Reset account.state='running' on a subsequent successful retry.

Summary:
I think this entire flow could use some refactoring,
this is intended to be a temp fix.

Test Plan: None

Reviewers: emfree

Reviewed By: emfree

Differential Revision: https://review.inboxapp.com/D354"
khamidou,2014-08-20 10:29:54,https://api.github.com/repos/nylas/sync-engine/git/commits/3ec9f17f952f8015035147fdc92dc15ea22d7e0b,3ec9f17f952f8015035147fdc92dc15ea22d7e0b,"Condstore support for MobileMe

Summary:
Briefly, there was a couple bugs with the mailsync code:

1. Some backends need to receive a condstore-enabling message to activate condstore. This is done using a ""STATUS CONDSTORE"" command.

2. MobileMe sends HIGHESTMODSEQ values bigger than Integer. I changed the db field to be a BigInteger instead. I made the same change to UIDVALIDITY because it's probably the same.

Test Plan: Ran a sync with MobileMe, added a gmail account, checked that condstore worked for both.

Reviewers: emfree, charles

Reviewed By: charles

Projects: #inbox-sync

Maniphest Tasks: T311

Differential Revision: https://review.inboxapp.com/D352"
emfree,2014-08-19 22:42:20,https://api.github.com/repos/nylas/sync-engine/git/commits/e3e2ece33351b6b8fbe4a3287f1f054386d7009d,e3e2ece33351b6b8fbe4a3287f1f054386d7009d,"Update docs to clarify that message recipients will never be prepopulated.

Test Plan: Look at the docs as served by redwood.

Reviewers: bengotow

Differential Revision: https://review.inboxapp.com/D338"
khamidou,2014-08-19 09:22:30,https://api.github.com/repos/nylas/sync-engine/git/commits/01083a13d48da135fb55168bd5a6cb4ed1b82bf8,01083a13d48da135fb55168bd5a6cb4ed1b82bf8,"[Testing] Basic end-to-end tests

Summary:
Christine, Charles, emfree,

I've started working on basic end-to-end tests. So far, the code only tests email sending and thread deletion.
The diff is quite short but here's some things I'd like you to take a look at:

1. I wrote object-oriented tests, which doesn't seem to be the blessed way in pytest. My reasoning was it would be simpler to define a main test class with all the test code and extending it using mixins for every provider. I'm open to suggestions to make the code simpler.

2. What's the scope of this testing? I decided on testing only whether calls on the API propagate to the IMAP backend. I guess we are planning on testing things the other way too? What's the priority?

3. How clean are we about testing? Is it okay to query the db to get an user's password? Right now user credentials are hard-coded into mixins which is kinda bad.

Test Plan: Run the tests.

Reviewers: spang, charles

Subscribers: emfree

Projects: #inbox-sync

Differential Revision: https://review.inboxapp.com/D316"
emfree,2014-08-18 21:10:46,https://api.github.com/repos/nylas/sync-engine/git/commits/d52631194522f82f5239b5fb3e336fdc8efc1f60,d52631194522f82f5239b5fb3e336fdc8efc1f60,"Don't use geventconnpool.retry in sendmail code.

It doesn't play nice with structlog. Use our own retry decorator instead."
emfree,2014-08-16 20:40:40,https://api.github.com/repos/nylas/sync-engine/git/commits/4bb4d2100029ee1746f3bf4a96e3906d80c290c3,4bb4d2100029ee1746f3bf4a96e3906d80c290c3,Arc land onto master by default
spang,2014-08-16 19:26:29,https://api.github.com/repos/nylas/sync-engine/git/commits/49d43a95ceabb32f17ec5e1df20cdffc4862b11b,49d43a95ceabb32f17ec5e1df20cdffc4862b11b,Merge branch 'dev'
emfree,2014-08-14 02:04:22,https://api.github.com/repos/nylas/sync-engine/git/commits/329e3ad5b215e695700f4855884f6b839e026b97,329e3ad5b215e695700f4855884f6b839e026b97,"Manage multiprocessing via supervisor, not startup script.

Summary:
An issue with our current setup is that if a single sync process gets taken
out, say by the OOM killer, it will not be revived until the entire process
group is restarted. As far as I can tell, there are two solutions to this:
 * Loop and poll child process health.
 * Use supervisor to explicitly manage a group of processes.
This commit implements the latter alternative, if used with the following
supervisor config.

```
[program:mailsync]
numprocs=8
environment=MAILSYNC_PROCESSES=8
process_name=%(process_num)d
command=/srv/inbox/bin/inbox-start --prod --process_num=%(process_num)
directory=/srv/inbox
user=admin
autostart=true
autorestart=true
stopasgroup=true
stdout_logfile=/var/log/inboxapp/mailsync.log
stderr_logfile=/var/log/inboxapp/mailsync.err.log
 ```

Test Plan:
Run mailsync with this config and introduce a memory leak in a
single process.

Reviewers: spang

Reviewed By: spang

Differential Revision: https://review.inboxapp.com/D322"
spang,2014-08-16 18:56:59,https://api.github.com/repos/nylas/sync-engine/git/commits/bfbd1107169a4274746443ab11d39b9880bfbe40,bfbd1107169a4274746443ab11d39b9880bfbe40,Better error message when gevent lock acquire fails.
spang,2014-08-16 18:56:59,https://api.github.com/repos/nylas/sync-engine/git/commits/6671f681fe07da8413cb4623731f5be7965af4c1,6671f681fe07da8413cb4623731f5be7965af4c1,Better error message when gevent lock acquire fails.
emfree,2014-08-16 02:52:18,https://api.github.com/repos/nylas/sync-engine/git/commits/c8199d99909cb60110258fd06fdb9456f910113e,c8199d99909cb60110258fd06fdb9456f910113e,"Handle HTMLParseError when stripping tags.

Also remove unused code from inbox/util/html.py."
emfree,2014-08-16 02:52:18,https://api.github.com/repos/nylas/sync-engine/git/commits/18280ffab4f5bb6140596fb218c3d53c47ea4efa,18280ffab4f5bb6140596fb218c3d53c47ea4efa,"Handle HTMLParseError when stripping tags.

Also remove unused code from inbox/util/html.py."
emfree,2014-08-16 01:17:20,https://api.github.com/repos/nylas/sync-engine/git/commits/13169abdbf2552a9fd7c0815f45ceb6c3479deb7,13169abdbf2552a9fd7c0815f45ceb6c3479deb7,Fix merge error in providers.py
grinich,2014-08-15 19:29:28,https://api.github.com/repos/nylas/sync-engine/git/commits/8a1be18b52f97106fdb48f064cea173d04a64753,8a1be18b52f97106fdb48f064cea173d04a64753,"Add snippet property to Message API response

Summary: Discussion here: https://github.com/inboxapp/inbox/issues/66

Test Plan: Just adds to the serializer

Reviewers: emfree

Reviewed By: emfree

Differential Revision: https://review.inboxapp.com/D335"
emfree,2014-08-13 23:15:37,https://api.github.com/repos/nylas/sync-engine/git/commits/080637c99898082d38b306ef73983552b263e628,080637c99898082d38b306ef73983552b263e628,"Set pool_recycle to deal with MySQL closing idle connections.

See http://docs.sqlalchemy.org/en/latest/dialects/mysql.html#connection-timeouts

Cherry-picking this onto master so it definitely gets deployed."
emfree,2014-08-15 21:00:53,https://api.github.com/repos/nylas/sync-engine/git/commits/32f4ec77fb887949fa4f17f007e18f64eb541390,32f4ec77fb887949fa4f17f007e18f64eb541390,"Catch IMAPClient.AbortError, IMAPClient.Abort.

The latter doesn't seem to exist, so this was causing AttributeErrors that are
messing up the auth flow."
grinich,2014-08-15 04:25:29,https://api.github.com/repos/nylas/sync-engine/git/commits/499653f051cf1d8946831d1d02ab434c61701032,499653f051cf1d8946831d1d02ab434c61701032,"Remove UIDNEXT

Summary:
It seems that we're not actually using UIDNEXT for anything. There was an issue reported where Dreamhost email accounts (Dovecot) wouldn't return UIDNEXT in the folder status, causing a crash. So I've removed it.

Relevant issue: https://github.com/inboxapp/inbox/pull/78

Test Plan: sync still works just fine. passes tests.

Reviewers: spang

Reviewed By: spang

Subscribers: emfree

Differential Revision: https://review.inboxapp.com/D332"
khamidou,2014-08-15 09:32:18,https://api.github.com/repos/nylas/sync-engine/git/commits/78131d69a5f663aea67ec0f64f47270d39c6e52e,78131d69a5f663aea67ec0f64f47270d39c6e52e,"Handle gracefully some IMAP errors

Summary:
Apparently IMAPClient raises a specific exception when it encounters a ""transient"" error (i.e: an error which may be fixed when retrying).

I've added code to handle this class of errors for the syncback backend and the login code. This should fix T112 and also some errors we see popping up randomly on sentry (ex: https://app.getsentry.com/inbox/beta/group/28209207/)

Test Plan: Can't really test this kind of thing

Reviewers: spang, charles

Reviewed By: charles

Maniphest Tasks: T112

Differential Revision: https://review.inboxapp.com/D317"
kav-ya,2014-08-14 23:43:42,https://api.github.com/repos/nylas/sync-engine/git/commits/b2376cf95824c7c9972510972202aae6e5761c47,b2376cf95824c7c9972510972202aae6e5761c47,"Sync monitor should not wait on a killed folder sync -
Previously, if a folder sync greenlet was killed due to an exception during initial sync,
the monitor would sleep forever and fail to start subsequent folder syncs
since the only conditions it checked were folder sync state polling/ finished."
kav-ya,2014-08-14 22:53:58,https://api.github.com/repos/nylas/sync-engine/git/commits/01ec8e1a19bca124748be31d955f614767df5362,01ec8e1a19bca124748be31d955f614767df5362,Insert check in a couple more places.
kav-ya,2014-08-14 22:37:04,https://api.github.com/repos/nylas/sync-engine/git/commits/35b08edbc388ea9699cf50e0b2b31fd485f9eec9,35b08edbc388ea9699cf50e0b2b31fd485f9eec9,"Check for the empty seq case before .in_(seq) queries; results in an expensive
sequential scan otherwise."
kav-ya,2014-08-14 22:06:28,https://api.github.com/repos/nylas/sync-engine/git/commits/bd2abc356c05034c643b5cd4a892c753194480fd,bd2abc356c05034c643b5cd4a892c753194480fd,"Don't overwrite Account.sync_state at sync_stop() if Invalid credentials/Connection error/
Killed because foldersyncs were killed."
emfree,2014-08-14 20:22:33,https://api.github.com/repos/nylas/sync-engine/git/commits/5c0e1e963c48a50069dab57082981c9ee619a3f9,5c0e1e963c48a50069dab57082981c9ee619a3f9,"Merge pull request #77 from caitp/docs

Docs: remove invalid key from ""update thread"" example"
caitp,2014-08-14 19:31:26,https://api.github.com/repos/nylas/sync-engine/git/commits/72faa1af31214e1dc5d8bca105b98cc66a3faf6d,72faa1af31214e1dc5d8bca105b98cc66a3faf6d,"Docs: remove invalid key from ""update thread"" example

The thread PUT route is only able to have the keys ""add_tags"" and ""remove_tags"" in the request
body, otherwise the response is a 400."
emfree,2014-08-14 19:00:30,https://api.github.com/repos/nylas/sync-engine/git/commits/b0feee64d6088221bc0a8ff4f532cae5decf28d6,b0feee64d6088221bc0a8ff4f532cae5decf28d6,"Require refresh token when committing OAuth accounts.

Don't know how this could happen, but in the immediate future failing with a
KeyError seems better than silently committing a null value."
khamidou,2014-08-14 16:50:47,https://api.github.com/repos/nylas/sync-engine/git/commits/16bec17e7337fd1cbaef12934cfeae05a563719f,16bec17e7337fd1cbaef12934cfeae05a563719f,fix var scoping bug
khamidou,2014-08-14 09:07:37,https://api.github.com/repos/nylas/sync-engine/git/commits/f9d113aa528b60d1a41b5caf0f1f0f7da4a8c8b3,f9d113aa528b60d1a41b5caf0f1f0f7da4a8c8b3,"Break into a python interpreter from anywhere

Summary:
I use pdb a lot when debugging and I find it really annoying that we only get stack traces from errors on gunks. Wouldn't it be cool to be able to at least have access to an interpreter at the bottom of a stack trace? Well, rdb does this. To use it, insert a call to ""rdb.break_to_interpreter"" and the greenlet will block while waiting for a telnet (or netcat if you can) connection on localhost (and without blocking the whole process).

Currently the debugger is very basic - it's still possible to examine the stackframe using sys._getframe, though. I'm looking for a way to make the frame data available in locals() and to have greenlets break into the debugger whenever they get an uncaught exception.

Test Plan: Ran a sync

Reviewers: charles, spang, emfree

Reviewed By: emfree

Projects: #inbox-sync

Differential Revision: https://review.inboxapp.com/D321"
khamidou,2014-08-14 09:06:20,https://api.github.com/repos/nylas/sync-engine/git/commits/8d0b6bd618ebad9c51dc42fff0f567814365f77a,8d0b6bd618ebad9c51dc42fff0f567814365f77a,"Fix gandi folder mapping.

Summary: Folder mapping was incomplete for Gandi. Fixes T283.

Test Plan: Ran a full sync. Saw that all canonical folders were indexed.

Reviewers: charles, spang

Reviewed By: spang

Subscribers: spang

Maniphest Tasks: T283

Differential Revision: https://review.inboxapp.com/D320"
emfree,2014-08-14 02:04:22,https://api.github.com/repos/nylas/sync-engine/git/commits/2c5676c3d7225ab29ac594e336cdfa444ea8fc67,2c5676c3d7225ab29ac594e336cdfa444ea8fc67,"Manage multiprocessing via supervisor, not startup script.

Summary:
An issue with our current setup is that if a single sync process gets taken
out, say by the OOM killer, it will not be revived until the entire process
group is restarted. As far as I can tell, there are two solutions to this:
 * Loop and poll child process health.
 * Use supervisor to explicitly manage a group of processes.
This commit implements the latter alternative, if used with the following
supervisor config.

```
[program:mailsync]
numprocs=8
environment=MAILSYNC_PROCESSES=8
process_name=%(process_num)d
command=/srv/inbox/bin/inbox-start --prod --process_num=%(process_num)
directory=/srv/inbox
user=admin
autostart=true
autorestart=true
stopasgroup=true
stdout_logfile=/var/log/inboxapp/mailsync.log
stderr_logfile=/var/log/inboxapp/mailsync.err.log
 ```

Test Plan:
Run mailsync with this config and introduce a memory leak in a
single process.

Reviewers: spang

Reviewed By: spang

Differential Revision: https://review.inboxapp.com/D322"
emfree,2014-08-13 23:15:37,https://api.github.com/repos/nylas/sync-engine/git/commits/439cbfbfa6b16fdd0d24f91adb55eb510802ab8c,439cbfbfa6b16fdd0d24f91adb55eb510802ab8c,"Set pool_recycle to deal with MySQL closing idle connections.

See http://docs.sqlalchemy.org/en/latest/dialects/mysql.html#connection-timeouts"
pavelbinar,2014-08-13 18:37:07,https://api.github.com/repos/nylas/sync-engine/git/commits/e9fc0834419b96a3fc69640b9e8677bb9be46630,e9fc0834419b96a3fc69640b9e8677bb9be46630,Fix monocle/app.py code merge error
kav-ya,2014-08-13 18:39:14,https://api.github.com/repos/nylas/sync-engine/git/commits/e4eda7a6eea5c3f3ad0d1f352f67139895e4b4bf,e4eda7a6eea5c3f3ad0d1f352f67139895e4b4bf,"Merge pull request #74 from pavelbinar/master

Fix monocle/app.py code merge error"
pavelbinar,2014-08-13 18:37:07,https://api.github.com/repos/nylas/sync-engine/git/commits/e5bf402b794a3641f22291110e32f4352da7e1fc,e5bf402b794a3641f22291110e32f4352da7e1fc,Fix monocle/app.py code merge error
khamidou,2014-08-13 09:39:45,https://api.github.com/repos/nylas/sync-engine/git/commits/4ba7f806de4e91b34f0ca86716d191da6f056487,4ba7f806de4e91b34f0ca86716d191da6f056487,"Fix MX domain validation 'bug'

Summary: I spent an hour on this quasi-bug... *sigh* The problem is the MX domain validation code expects domain names to end with a '.' (because this is how they are represented in DNS). I changed the code to validate against standard domain names.

Test Plan: Ran a sync on gandi.

Reviewers: charles

Reviewed By: charles

Differential Revision: https://review.inboxapp.com/D318"
kav-ya,2014-08-13 07:01:06,https://api.github.com/repos/nylas/sync-engine/git/commits/4e0fb137d857af4a2f50db9227f450126bc0eadc,4e0fb137d857af4a2f50db9227f450126bc0eadc,Raise ConnectionError rather than ValidationError for all non-Invalid Credentials errors during Oauth.
emfree,2014-08-13 06:38:32,https://api.github.com/repos/nylas/sync-engine/git/commits/914d6b32c42d2e2bb529e276f8d9fa8638d40e62,914d6b32c42d2e2bb529e276f8d9fa8638d40e62,"Raise ValidationError in events code, don't return it."
emfree,2014-08-13 03:39:16,https://api.github.com/repos/nylas/sync-engine/git/commits/b3250b248f178c63c54b75d847696188933cc2bf,b3250b248f178c63c54b75d847696188933cc2bf,Clearer logging of token validation errors and unparseable cal events.
emfree,2014-08-13 03:15:29,https://api.github.com/repos/nylas/sync-engine/git/commits/05b6eaf259117cc6254e2b13c5a02569713e6356,05b6eaf259117cc6254e2b13c5a02569713e6356,Fix filtering criterion when updating contacts from message.
bengotow,2014-08-12 23:16:11,https://api.github.com/repos/nylas/sync-engine/git/commits/d3cdde6d512fff265b9299ca7f835b0c759b33ea,d3cdde6d512fff265b9299ca7f835b0c759b33ea,[docs] Improving heading text layout
grinich,2014-08-12 21:45:49,https://api.github.com/repos/nylas/sync-engine/git/commits/1938f2dd0040e389b523a65f611e381a6ff81c2c,1938f2dd0040e389b523a65f611e381a6ff81c2c,Don't skip
khamidou,2014-08-12 10:14:30,https://api.github.com/repos/nylas/sync-engine/git/commits/25bb4e867d372652e44083102d7e091849793d95,25bb4e867d372652e44083102d7e091849793d95,"Fix a small ImapClient bug

Summary: I found a small bug in ImapClient which makes it crash when making a SEARCH using MODSEQ. The bug will be fixed in 0.12. In the meantime, I changed requirements.txt to point to our ImapClient fork.

Test Plan: Ran a full sync and an update afterwards.

Reviewers: emfree, spang

Reviewed By: spang

Differential Revision: https://review.inboxapp.com/D315"
kav-ya,2014-08-12 06:20:27,https://api.github.com/repos/nylas/sync-engine/git/commits/9b2e270d21c6c3b60877b544dbeae32a3e469b1a,9b2e270d21c6c3b60877b544dbeae32a3e469b1a,"[Monocle] Fix pretty date regression.
Sync start time is original start time.
Kill sync end time."
emfree,2014-08-12 05:31:49,https://api.github.com/repos/nylas/sync-engine/git/commits/a85c51c5f625c7948c35df650d2c3a6b237e9b13,a85c51c5f625c7948c35df650d2c3a6b237e9b13,"Update migration 072 to not depend on Message model.

The problem is that a later migration (076) adds a Message.thread_order column.
So if you try to run a migration that spans 072 to 076, it will import the
later version of the Message class, which references a thread_order column that
isn't in the database yet. Fix this by including a self-contained
calculate_html_snippet function.

Also update migration 079 to properly check for the existence of the 'uid'
unique constraint."
emfree,2014-08-12 01:33:18,https://api.github.com/repos/nylas/sync-engine/git/commits/8ddedcb8a06a1435aabe60e6471d5a548335f42b,8ddedcb8a06a1435aabe60e6471d5a548335f42b,"Remove module-level imports from migrations.

The problem here is that alembic imports all the migration scripts when we
check the current alembic revision on startup. This can break as the code
changes later. In particular, we may end up importing stuff that gevent later
monkeypatches, causing strange breakages."
emfree,2014-08-12 00:26:35,https://api.github.com/repos/nylas/sync-engine/git/commits/33b14aca1d1705bb525e762b7a51c64d7f31bc66,33b14aca1d1705bb525e762b7a51c64d7f31bc66,"Make configure_logging idempotent; move API response configuration.

It doesn't make sense to globally configure an app's error handlers if it uses
the ns_api blueprint, so move the errorhandler installation to api/srv.py."
kav-ya,2014-08-12 00:11:23,https://api.github.com/repos/nylas/sync-engine/git/commits/4ae01bf88268e67c2fdf34e4077aa30587be7618,4ae01bf88268e67c2fdf34e4077aa30587be7618,[Monocle] Include approx. sync rate for EAS syncs
bengotow,2014-08-11 23:03:48,https://api.github.com/repos/nylas/sync-engine/git/commits/73bc2a1130d103a5294f0a7fe5cbc4b4451e44b5,73bc2a1130d103a5294f0a7fe5cbc4b4451e44b5,Improvements to docs for tags
bengotow,2014-08-11 22:04:24,https://api.github.com/repos/nylas/sync-engine/git/commits/1fd75626417563e7326e207defec87b1443728ec,1fd75626417563e7326e207defec87b1443728ec,Improvements to docs JSON
bengotow,2014-08-11 22:00:25,https://api.github.com/repos/nylas/sync-engine/git/commits/c5ee7765d569506e87aa446e8afabae14a5b02af,c5ee7765d569506e87aa446e8afabae14a5b02af,"Improvements to docs for drafts,sending based on feedback"
kav-ya,2014-08-11 20:57:38,https://api.github.com/repos/nylas/sync-engine/git/commits/5c44d0337de381b3b1f2ebc8d78156836404ad88,5c44d0337de381b3b1f2ebc8d78156836404ad88,"Fix to 'cannot acquire gevent lock'.
Fixes T247.

Summary:
service.start_sync() checks if the account's already locked and its sync_state is killed - if so, unlock before trying to
reacquire the lock.

Test Plan: None.

Reviewers: emfree

Reviewed by: emfree

Differential Revision: https://review.inboxapp.com/D314"
kav-ya,2014-08-07 22:08:01,https://api.github.com/repos/nylas/sync-engine/git/commits/d52e2c066ff5886059fd7d2ff7fdfd19aa303676,d52e2c066ff5886059fd7d2ff7fdfd19aa303676,[Monocle] Basic cache.
khamidou,2014-08-11 10:26:09,https://api.github.com/repos/nylas/sync-engine/git/commits/e8448794c5122a1ab2f08891daaf060b1079c42b,e8448794c5122a1ab2f08891daaf060b1079c42b,"Fix yahoo-none for custom folders.

Summary: Fixes T270.

Test Plan: Ran a sync. Saw that the bug had disappeared.

Reviewers: spang, emfree

Reviewed By: emfree

Maniphest Tasks: T270, T262

Differential Revision: https://review.inboxapp.com/D309"
kav-ya,2014-08-11 08:42:20,https://api.github.com/repos/nylas/sync-engine/git/commits/24b1e9d3ac8c88b426d8ae49071ff8d34d7abea5,24b1e9d3ac8c88b426d8ae49071ff8d34d7abea5,"Adapt new code for Contacts to work with EAS.

Test plan:
All tests in tests/general/contacts + tests/api/test_contacts.py pass.
EAS sync does not fail."
kav-ya,2014-08-11 09:00:29,https://api.github.com/repos/nylas/sync-engine/git/commits/db35ccaf3d6b9fbaf09e88ea335d6ed4a26a42f3,db35ccaf3d6b9fbaf09e88ea335d6ed4a26a42f3,Revert commits pending CR
kav-ya,2014-08-09 22:18:50,https://api.github.com/repos/nylas/sync-engine/git/commits/d53cae59e015ddd3543ce772f6820880f18c3da3,d53cae59e015ddd3543ce772f6820880f18c3da3,"Fix to 'cannot acquire gevent lock' (unreverted)

Summary:
service.start_sync() checks if the account's already locked and its sync_state is killed - if so, unlock before trying to
reacquire the lock.

Test Plan: None.

Reviewers: emfree

Differential Revision: https://review.inboxapp.com/D314"
kav-ya,2014-08-09 22:14:52,https://api.github.com/repos/nylas/sync-engine/git/commits/8cd5b5d16ddb692a9effff3dc45088f4d275d96e,8cd5b5d16ddb692a9effff3dc45088f4d275d96e,"Revert ""Fix to 'cannot acquire gevent lock'.""

This reverts commit c526c0bad1bc97ea5c16e5a8f2da7055c7a99243."
kav-ya,2014-08-09 22:11:32,https://api.github.com/repos/nylas/sync-engine/git/commits/b7ceca58016e548c7a0b6021cb9342c5e041db3e,b7ceca58016e548c7a0b6021cb9342c5e041db3e,Fix to 'cannot acquire gevent lock'.
kav-ya,2014-08-09 21:42:07,https://api.github.com/repos/nylas/sync-engine/git/commits/0723545efc157b3dd2f39307ac9a46713b4950a3,0723545efc157b3dd2f39307ac9a46713b4950a3,Migration update.
emfree,2014-08-09 08:05:26,https://api.github.com/repos/nylas/sync-engine/git/commits/963d50d0dfadeef35cffea108552d85f5dcba737,963d50d0dfadeef35cffea108552d85f5dcba737,"Distinguish between canonical and reserved tag names.

Canonical tags are ones that always exist in the Inbox API. Reserved tags
are ones that we prevent users from creating, because we might use them in the
future or because of confusion potential. Don't actually create tag objects for
the latter category.

Fixes T166."
emfree,2014-08-09 08:01:10,https://api.github.com/repos/nylas/sync-engine/git/commits/3c89fd3655dceb8fe49cdb07f0926ccf7508a183,3c89fd3655dceb8fe49cdb07f0926ccf7508a183,"Make update_thread_labels more performant.

The updating-labels-on-a-thread situation still needs more attention, but in
the meantime, at least make this faster. Doing thread.folders = {...} proves to
be expensive, because sqlalchemy does thread.folders.clear() under the hood,
so we remove all the associated tags and so on. But then in the common case we
just reconstruct the same set of folders, and it's a whole lotta SQL for
nothing. Something to keep in mind when working with the ORM."
emfree,2014-08-09 04:56:33,https://api.github.com/repos/nylas/sync-engine/git/commits/68c2a9f371bf1a9eefd27e2be167aeaae00cbf2b,68c2a9f371bf1a9eefd27e2be167aeaae00cbf2b,"Update a thread's folders when we detect deleted ImapUids.

Summary:
This means that, for example, we remove the 'inbox' tag from a thread if it's
removed from the Gmail inbox during an initial sync.

We don't yet deal with the case that a message is deleted entirely (e.g., from
both Inbox and All Mail on Gmail).

Fixes T271.

Test Plan: Start a sync and archive some mail from the top of the inbox.

Reviewers: spang

Reviewed By: spang

Maniphest Tasks: T271

Differential Revision: https://review.inboxapp.com/D312"
emfree,2014-08-09 01:22:11,https://api.github.com/repos/nylas/sync-engine/git/commits/eef4d9e4c224d7159ed3fe4cd2c99612117cc5dd,eef4d9e4c224d7159ed3fe4cd2c99612117cc5dd,Fix typo in previous commit.
emfree,2014-08-09 01:17:31,https://api.github.com/repos/nylas/sync-engine/git/commits/a6da6086934dd94b22d750d4dd1e99d87057875d,a6da6086934dd94b22d750d4dd1e99d87057875d,"Don't fail in crispin.py when supports_condstore attribute is missing.

Outlook is generic IMAP, but the OutlookAccount class doesn't have the
supports_condstore attribute.

Fixes T272."
emfree,2014-08-09 00:34:18,https://api.github.com/repos/nylas/sync-engine/git/commits/61902ba8700af4503d653dab3ccbd6c9159088cd,61902ba8700af4503d653dab3ccbd6c9159088cd,"[DEPENDENCIES] Switch to our fork of html2text.

PR submitted upstream, but don't want to just sit around and wait for the next
release.

Fixes T265."
emfree,2014-08-08 21:20:40,https://api.github.com/repos/nylas/sync-engine/git/commits/2938b5eeb335690a0e42813e26587c67a67b6070,2938b5eeb335690a0e42813e26587c67a67b6070,"Fix Sentry message truncation.

In an illustrative example of the hazards of constructing an untyped data model
out of dictionaries and lists, raven's RemoveStackLocalsProcessor doesn't do
what it says on the box, so neither does our code based on it. Put together
something that should work better until we can submit a PR upstream."
khamidou,2014-08-08 15:54:27,https://api.github.com/repos/nylas/sync-engine/git/commits/72525d1b8c24d344375641ac8ee0909d3d9cf950,72525d1b8c24d344375641ac8ee0909d3d9cf950,only generic accounts have a supports_condstore attr
khamidou,2014-08-08 12:19:13,https://api.github.com/repos/nylas/sync-engine/git/commits/980e0cd92f18f761d07c06fc8996f99cb673d418,980e0cd92f18f761d07c06fc8996f99cb673d418,forgot debug printf
khamidou,2014-08-08 12:02:31,https://api.github.com/repos/nylas/sync-engine/git/commits/b2387fd42bdb84192ff559cee974268f8011790c,b2387fd42bdb84192ff559cee974268f8011790c,fixed bug in threading code
khamidou,2014-08-08 10:10:56,https://api.github.com/repos/nylas/sync-engine/git/commits/540eff3e02cccb598015a777abb93e85ebd2ca54,540eff3e02cccb598015a777abb93e85ebd2ca54,fix code rot
khamidou,2014-08-08 09:59:37,https://api.github.com/repos/nylas/sync-engine/git/commits/e3c0db7821428dd38a135048b8bcc006dd8e545b,e3c0db7821428dd38a135048b8bcc006dd8e545b,"Automatically enable Condstore for servers who support it

Summary:
I needed this patch to test D297. It does two things:

1. Detect and store condstore support when running inbox-auth
2. When starting a sync choose the right monitor class

Test Plan: Tested by running a full sync + polls on a yahoo and fastmail account. Used the ImapClient logs to check that the right commands where issued.

Reviewers: charles, spang

Reviewed By: spang

Subscribers: mg

Differential Revision: https://review.inboxapp.com/D302"
khamidou,2014-08-08 09:42:01,https://api.github.com/repos/nylas/sync-engine/git/commits/9d30d88a9577576e4e44af7239ecf77391dbfdd3,9d30d88a9577576e4e44af7239ecf77391dbfdd3,"Generic Condstore syncing, take 2.

Summary:
Christine, Charles,

I extracted the condstore syncing code from D280 and adapted it to the new generic backend.

The code is functional but there's some additional work to do which is out of the scope of this patch.

1. There's some refactoring to do around ""crispin_new"". Mostly, I'd like to sniff out the capabilities of the server before constructing the CrispinClient. Right now, every non-gmail provider gets a GenericCrispinClient.

2. There's still this bug in ImapClient. Menno told me he was real close to releasing a fix. Should I go a ahead and fork ImapClient temporarily or just wait for the release?

Test Plan: Ran a couple syncs with fastmail + checked in the ImapClient logs that it was issuing the condstore commands.

Reviewers: charles, spang

Reviewed By: spang

Differential Revision: https://review.inboxapp.com/D297"
emfree,2014-08-08 01:30:27,https://api.github.com/repos/nylas/sync-engine/git/commits/227286f4a2c2d6b29420a04433eeeb65b831be91,227286f4a2c2d6b29420a04433eeeb65b831be91,"Make g_msgids call more performant.

Summary:
Previously, we'd load *all* the g_msgids for a given account before filtering
them. This makes sense in cases where the in_ parameter is stupidly large
(which it sometimes can be). But in, say, deduplicate_message_object_creation,
this function is called with len(in_) == 1. In that case, doing this adds
hundreds of milliseconds to the time it takes to commit each message.

Test Plan: Run syncs on beta-mailsync.

Reviewers: spang

Reviewed By: spang

Differential Revision: https://review.inboxapp.com/D307"
emfree,2014-08-08 00:59:01,https://api.github.com/repos/nylas/sync-engine/git/commits/2cf01c4a3eb8db0a0b7ff5dca1e863e57c8136c3,2cf01c4a3eb8db0a0b7ff5dca1e863e57c8136c3,Short-circuit in gmail_download_and_commit_uids when there's nothing to commit.
emfree,2014-08-08 00:37:46,https://api.github.com/repos/nylas/sync-engine/git/commits/204da90dd3c9b46007a4ac1bf4be094531feae68,204da90dd3c9b46007a4ac1bf4be094531feae68,Remove uninformative log statements.
emfree,2014-08-07 23:11:42,https://api.github.com/repos/nylas/sync-engine/git/commits/f54934a05264cb95adafe3a7bd9cd730bb93e1a1,f54934a05264cb95adafe3a7bd9cd730bb93e1a1,Update unit test database dump.
khamidou,2014-08-07 10:12:56,https://api.github.com/repos/nylas/sync-engine/git/commits/8c1c2decf03dafb086795af3811b7b28d6256207,8c1c2decf03dafb086795af3811b7b28d6256207,"Threading algorithm

Summary:
Kavya, Charles

I've implemented a basic threading algorithm.  It's sort of complicated.

So, last week I wrote a spec for a threading algorithm. This is not the same algorithm. The algo I speced was about flattening graphs (DAGs) which is kind of complicated to code, so I tried out instead an algo which uses lists.

Here's how it works:

1. The first step is getting together all the the messages which share the same subject (this is debatable but you've got to start somewhere) and sorting them by ""received_date""

2. After this, the algo starts from an empty list and inserts all the messages the one after the other using ""insert_message_in_thread"". insert_message_in_thread uses the in-reply-to and references: headers to insert the message at the correct position or to at least take an educated guess at it. It's quite complex, so I've made a flowchart: {F729}

I'm not sure I've been very clear. Tell me if you have questions.

Test Plan: Compare this threading algorithm with Yahoo and Gmail threading. Run it on a bigger dataset.

Reviewers: charles, kav-ya

Reviewed By: kav-ya

Subscribers: emfree, spang

Differential Revision: https://review.inboxapp.com/D267

[Note(emfree): relanding commit c093ac34903. Surprisingly, the thread_order
column does actually get added by the migration with a default value of 0. It's
just excruciatingly slow to run this on a large database. Added a default
Python value though, as there are places where we create a Message object but
don't set this (drafts and sending)]"
emfree,2014-08-07 18:10:20,https://api.github.com/repos/nylas/sync-engine/git/commits/811a7e540bb11602c12bd12b4cc39f2cf981e47b,811a7e540bb11602c12bd12b4cc39f2cf981e47b,"Revert ""Fix alembic version ordering.""

This reverts commit 2c31b304a56d54a1e5febeac0abc02c35cf97208."
emfree,2014-08-07 18:02:33,https://api.github.com/repos/nylas/sync-engine/git/commits/d718a664708b68f0a659c401f9fa41dbaeb74c75,d718a664708b68f0a659c401f9fa41dbaeb74c75,Fix alembic version ordering.
emfree,2014-08-07 17:03:58,https://api.github.com/repos/nylas/sync-engine/git/commits/1bf71f2f5791720b5d8fb4b74915ab73f6f97478,1bf71f2f5791720b5d8fb4b74915ab73f6f97478,"[SCHEMA] Don't try to do search ranking of contacts.

Summary:
This feature proves to be really expensive during a sync, because you have to
issue many additional database queries to commit a single message. It's also of
dubious utility, when just returning unranked results works pretty all right
for contacts. Many clients will likely also opt to cache all contacts locally
for search-as-you-type level performance.

Test Plan:
Run a sync and check that created objects plus filtered API
responses are correct. I'd like to add more unit tests but don't think that's a
blocker.

Reviewers: spang

Reviewed By: spang

Subscribers: mg

Differential Revision: https://review.inboxapp.com/D306"
khamidou,2014-08-07 14:33:26,https://api.github.com/repos/nylas/sync-engine/git/commits/2d5638fd55ac9d2ca99dfa307574e5db4b4e9a27,2d5638fd55ac9d2ca99dfa307574e5db4b4e9a27,fixed scope bug
khamidou,2014-08-07 10:12:56,https://api.github.com/repos/nylas/sync-engine/git/commits/6ddd63c9c31186c55ae167b82f4b5e33e93f5231,6ddd63c9c31186c55ae167b82f4b5e33e93f5231,"Threading algorithm

Summary:
Kavya, Charles

I've implemented a basic threading algorithm.  It's sort of complicated.

So, last week I wrote a spec for a threading algorithm. This is not the same algorithm. The algo I speced was about flattening graphs (DAGs) which is kind of complicated to code, so I tried out instead an algo which uses lists.

Here's how it works:

1. The first step is getting together all the the messages which share the same subject (this is debatable but you've got to start somewhere) and sorting them by ""received_date""

2. After this, the algo starts from an empty list and inserts all the messages the one after the other using ""insert_message_in_thread"". insert_message_in_thread uses the in-reply-to and references: headers to insert the message at the correct position or to at least take an educated guess at it. It's quite complex, so I've made a flowchart: {F729}

I'm not sure I've been very clear. Tell me if you have questions.

Test Plan: Compare this threading algorithm with Yahoo and Gmail threading. Run it on a bigger dataset.

Reviewers: charles, kav-ya

Reviewed By: kav-ya

Subscribers: emfree, spang

Differential Revision: https://review.inboxapp.com/D267"
kav-ya,2014-08-07 08:07:10,https://api.github.com/repos/nylas/sync-engine/git/commits/d48ed2432c00de9035710b505ea0a320dd6743cb,d48ed2432c00de9035710b505ea0a320dd6743cb,Fix typo.
kav-ya,2014-08-07 08:01:53,https://api.github.com/repos/nylas/sync-engine/git/commits/fb1b5a8401038a9fa2312179b52a4f307f14777f,fb1b5a8401038a9fa2312179b52a4f307f14777f,Matching EAS update.
kav-ya,2014-08-07 07:40:05,https://api.github.com/repos/nylas/sync-engine/git/commits/b24fb43490fe99029ba9ad71c4325ecb6c7e4a8e,b24fb43490fe99029ba9ad71c4325ecb6c7e4a8e,Optimize Monocle % calcs.
kav-ya,2014-08-07 04:56:58,https://api.github.com/repos/nylas/sync-engine/git/commits/70d874eec2162e97b63b7cd9ee4d0be467d6760a,70d874eec2162e97b63b7cd9ee4d0be467d6760a,Assign return of removed_deleted_uids() in inbox.mailsync.backends.imap.imap in highestmodseq_update
emfree,2014-08-07 03:49:32,https://api.github.com/repos/nylas/sync-engine/git/commits/7358bf20bb6af797576406b69e4a1e8fe88ef135,7358bf20bb6af797576406b69e4a1e8fe88ef135,Flag-guard db session debug logging.
kav-ya,2014-08-07 03:19:03,https://api.github.com/repos/nylas/sync-engine/git/commits/41718b41ca8209f3ca44c29dd58b9fdda340ea14,41718b41ca8209f3ca44c29dd58b9fdda340ea14,Matching update for EAS accounts.
kav-ya,2014-08-05 22:31:16,https://api.github.com/repos/nylas/sync-engine/git/commits/9da711a65ef91435fe04ac8c86884ede640dc691,9da711a65ef91435fe04ac8c86884ede640dc691,"Include % synced in metrics + other metric calc tweaks.
Also fix bugs in the non-Gmail IMAP metrics updating.

Summary:
Monocle would now display the following metrics:
# Remote, As of, % synced, # remaining, # downloaded, As of

Test Plan: Visual app inspection.

Reviewers: spang

Reviewed By: spang

Subscribers: charles

Differential Revision: https://review.inboxapp.com/D299"
emfree,2014-08-07 02:14:22,https://api.github.com/repos/nylas/sync-engine/git/commits/305d03f38fe3f365686fb635fc747f95a649f370,305d03f38fe3f365686fb635fc747f95a649f370,"[DEPENDENCIES] Bump html2text version.

This is aimed at fixing https://app.getsentry.com/inbox/beta/group/27947231/,
but is purely speculative because I don't have time to dive it more right now.
Anyways, can't hurt."
emfree,2014-08-06 23:31:08,https://api.github.com/repos/nylas/sync-engine/git/commits/7cc84a7ec5a4d15628d19c310322c52999754f7d,7cc84a7ec5a4d15628d19c310322c52999754f7d,Replace 'events' by 'deltas' terminology throughout.
bengotow,2014-08-06 23:29:57,https://api.github.com/repos/nylas/sync-engine/git/commits/185fc1a16542a886f01ee2ca282214872b8051b1,185fc1a16542a886f01ee2ca282214872b8051b1,Improving the delta sync documentation
emfree,2014-08-06 22:50:44,https://api.github.com/repos/nylas/sync-engine/git/commits/98641112b38d65be4c5960042e9a5a125b7a1f45,98641112b38d65be4c5960042e9a5a125b7a1f45,"[DEPENDENCIES] Add facility to cumulatively profile sync processes.

Summary:
This commit adds the ability to get cumulative profiler data for a running sync
process by doing `kill -SIGTRAP <sync_pid>`, if the 'DEBUG_PROFILING_ON' flag
is set in the config.

Requires an updated version of pyinstrument to avoid issues around interrupting
syscalls when the profiler runs with use_signal=True.

Test Plan: run a mailsync and try it out.

Reviewers: kav-ya

Reviewed By: kav-ya

Differential Revision: https://review.inboxapp.com/D303"
spang,2014-08-06 19:28:46,https://api.github.com/repos/nylas/sync-engine/git/commits/d3d5113d1b4a48ca56a7c1192c0eec6a26cf3db3,d3d5113d1b4a48ca56a7c1192c0eec6a26cf3db3,Fix NoResultFound error in add_new_imapuid
spang,2014-08-06 01:26:53,https://api.github.com/repos/nylas/sync-engine/git/commits/25eb07cbed29e077723057759994e0792894283c,25eb07cbed29e077723057759994e0792894283c,"Remove unused ImapThread method.

Pretty sure this snuck in because I started some code that Karim finished."
spang,2014-08-05 21:22:35,https://api.github.com/repos/nylas/sync-engine/git/commits/4d04eee423d452f24ccb3c845c02dabe14ad3ba1,4d04eee423d452f24ccb3c845c02dabe14ad3ba1,Create minimal pools from engine in migrations.
khamidou,2014-08-06 19:03:54,https://api.github.com/repos/nylas/sync-engine/git/commits/1d05f61e7cbbeaa0be654870f4cb23e6b3ac3c57,1d05f61e7cbbeaa0be654870f4cb23e6b3ac3c57,"[Sentry] Add git revision to traces + Keep some stack locals

Summary:
Christine, Eben,

I fixed T254 and also created a custom sentry processor to keep the last n locals from the stack trace.

Test Plan: No test plan - can't reach gunks :(

Reviewers: spang, emfree

Reviewed By: emfree

Maniphest Tasks: T254

Differential Revision: https://review.inboxapp.com/D298"
emfree,2014-08-06 05:47:29,https://api.github.com/repos/nylas/sync-engine/git/commits/9e12dd7e3930026930befe0e3acc574cbab0cef2,9e12dd7e3930026930befe0e3acc574cbab0cef2,"Actually cache blob values in memory.

Previously, by property/setter magic, doing `part.data = value` in message
parsing would write to the data to S3. Then accessing `part.data` in
`message.body` would read it right back. Not ideal.

It seems the original intent was to actually parallelize persisting to disk,
but that code has bitrotted. This is an interim patch, but we should definitely
take another look."
emfree,2014-08-06 04:34:30,https://api.github.com/repos/nylas/sync-engine/git/commits/9215a8a07217c688cf5ddd152428a683507561d5,9215a8a07217c688cf5ddd152428a683507561d5,"Add logging around db session creation and teardown.

We won't keep this in permanently, but we REALLY want to know exactly how the
connection pool is getting exhausted."
emfree,2014-08-06 04:27:09,https://api.github.com/repos/nylas/sync-engine/git/commits/0281f6d78f12c0e657e4e17a865790c884bdd6be,0281f6d78f12c0e657e4e17a865790c884bdd6be,Update bin/clear-db to keep new genericaccount table.
emfree,2014-08-06 02:47:58,https://api.github.com/repos/nylas/sync-engine/git/commits/cdfe9f8c7c1786406203bca66d06b161fc1d408d,cdfe9f8c7c1786406203bca66d06b161fc1d408d,Fix Monocle pretty-date timezoning.
emfree,2014-08-06 01:01:40,https://api.github.com/repos/nylas/sync-engine/git/commits/b6bb62926e22b5a8bc93548c94b5df367e1618ca,b6bb62926e22b5a8bc93548c94b5df367e1618ca,"Update API sync protocol terminology to ""delta protocol."""
emfree,2014-08-06 00:26:59,https://api.github.com/repos/nylas/sync-engine/git/commits/6d9ad3787810b9cd723893d952e04fcafd7e3c16,6d9ad3787810b9cd723893d952e04fcafd7e3c16,Serialize crispin connection creation to prevent database connection spike.
emfree,2014-08-05 22:33:04,https://api.github.com/repos/nylas/sync-engine/git/commits/60f82ef7ab52c0477dacff071c18b978e47484d0,60f82ef7ab52c0477dacff071c18b978e47484d0,"Fix logging call to find app frame and name on odd tracebacks.

Some frames don't have a '__name__' attribute in their f_globals, which breaks
structlog's utility for finding the first application frame when you specify
additional modules to ignore. Fix this.

(todo: submit a PR to structlog for this)"
emfree,2014-08-02 03:05:40,https://api.github.com/repos/nylas/sync-engine/git/commits/e3f53318737cf22bb04d05b82b6cfa14fa1e5a56,e3f53318737cf22bb04d05b82b6cfa14fa1e5a56,"[SCHEMA] Add index on eas_thrid.

For great performance."
emfree,2014-08-05 21:45:20,https://api.github.com/repos/nylas/sync-engine/git/commits/d0e4d96739ea7677c85ae5cc6db1596d2073f49f,d0e4d96739ea7677c85ae5cc6db1596d2073f49f,"Raise slow query threshold, and don't log full stacktrace.

This was generating a huge amount of log spam, much of it likely just from
scheduling contention. We also don't need the full stack trace to figure out
where the call comes from, given that we now log module line and number."
spang,2014-08-05 21:04:14,https://api.github.com/repos/nylas/sync-engine/git/commits/27dc86b893e81f30e2578923a8e68d3fb30fe0be,27dc86b893e81f30e2578923a8e68d3fb30fe0be,s/Block/Part/
spang,2014-08-05 20:51:15,https://api.github.com/repos/nylas/sync-engine/git/commits/b8ede8eab5c8c2c8c2d588b5ef35e2bd9225cba1,b8ede8eab5c8c2c8c2d588b5ef35e2bd9225cba1,Don't call Message.calculate_sanitized_body() if decode_error = True.
emfree,2014-08-05 05:21:42,https://api.github.com/repos/nylas/sync-engine/git/commits/433fc73b7d85fbbc2b6668d09a49510c89fba49e,433fc73b7d85fbbc2b6668d09a49510c89fba49e,"Don't try to take object snapshot on delete revision.

Fixes T253."
emfree,2014-08-05 04:35:45,https://api.github.com/repos/nylas/sync-engine/git/commits/657faccc6dba7e534674b14aa242b16a07b56cdf,657faccc6dba7e534674b14aa242b16a07b56cdf,"Truncate email addresses if necessary.

Fixes T258."
emfree,2014-08-05 04:10:51,https://api.github.com/repos/nylas/sync-engine/git/commits/7a0160e6d9117b97a3905f1e852b6bd8321a9142,7a0160e6d9117b97a3905f1e852b6bd8321a9142,"Remove custom __repr__ implementations.

They mess up raven/sentry, especially when they don't work with unicode objects."
kav-ya,2014-08-05 02:38:12,https://api.github.com/repos/nylas/sync-engine/git/commits/11790a65ff3f91728b2134504a76a943457738d7,11790a65ff3f91728b2134504a76a943457738d7,"[Monocle] s/account sync_state column/row color. Also get rid of separate Enabled? column.

The colors we use for account sync_state are:
Running - no color
Killed - some shade of red
Invalid/Connerror - some shade of orange
Stopped - some shade of yellow"
kav-ya,2014-08-05 00:12:51,https://api.github.com/repos/nylas/sync-engine/git/commits/fc87da080e2b7d1c7bed1b2100ba2a88cfe8b058,fc87da080e2b7d1c7bed1b2100ba2a88cfe8b058,"Preserve account.sync_state=invalid/connerr when set during pool creation.
Syncs are incorrectly reported as 'stopped' otherwise.

Also get rid of sync_type on Monocle, didn't seem useful."
emfree,2014-08-04 22:13:05,https://api.github.com/repos/nylas/sync-engine/git/commits/9dac4be61ea2921e8fe6215ae4bc0fab7edad350,9dac4be61ea2921e8fe6215ae4bc0fab7edad350,"Read mysql database and user names from config in bin/create-db.

Also add option --prod to disable creating the test database for production
deployments."
emfree,2014-08-04 22:03:24,https://api.github.com/repos/nylas/sync-engine/git/commits/34f285136c2c0da0f577f4707fc17d1fe3ebb313,34f285136c2c0da0f577f4707fc17d1fe3ebb313,"Add -p option to setup.sh to skip db configuration.

(Don't want to use the default config when configuring prod machines.)"
kav-ya,2014-08-04 19:48:20,https://api.github.com/repos/nylas/sync-engine/git/commits/a6f0713c39ea9c86cb1bfab3918fc5a450c35d93,a6f0713c39ea9c86cb1bfab3918fc5a450c35d93,Change log level on reconcile_message() logging.
kav-ya,2014-08-04 18:10:01,https://api.github.com/repos/nylas/sync-engine/git/commits/0d212201b81a12ff7a1c0d27ea2299166114ec96,0d212201b81a12ff7a1c0d27ea2299166114ec96,Fix migration order.
emfree,2014-08-04 17:21:17,https://api.github.com/repos/nylas/sync-engine/git/commits/b01cf0c1cf1ce8063eb83cade7c999279b38bdb9,b01cf0c1cf1ce8063eb83cade7c999279b38bdb9,Fix crispin logging typo.
khamidou,2014-08-04 06:25:20,https://api.github.com/repos/nylas/sync-engine/git/commits/3266aaed9ae6ae22a1d240c25a9c2e38bcea1621,3266aaed9ae6ae22a1d240c25a9c2e38bcea1621,"Strip <title>, <script> and <style> tags from HTML emails.

Summary:  Fixes T162. The code which strips HTML preserves the contents of the tags but it doesn't make sense to keep inline Javascript and CSS.

Test Plan: Ran a full sync. Checked results for HTML emails.

Reviewers: spang

Reviewed By: spang

Maniphest Tasks: T162

Differential Revision: https://review.inboxapp.com/D281"
emfree,2014-08-04 03:38:11,https://api.github.com/repos/nylas/sync-engine/git/commits/e29049c1c8ffc48bde2064853b9920c7d3a3c0d4,e29049c1c8ffc48bde2064853b9920c7d3a3c0d4,Fix indentation error in bin/inbox-sync.
emfree,2014-08-04 03:36:09,https://api.github.com/repos/nylas/sync-engine/git/commits/82067acc257b8c98b561e4d3380ac93e052810a4,82067acc257b8c98b561e4d3380ac93e052810a4,"Save client_id and client_secret on GmailAccount object when applicable.

We need to do this here now that this is the only place where we create the
GmailAccount object."
emfree,2014-08-04 00:13:59,https://api.github.com/repos/nylas/sync-engine/git/commits/65c1fb5dfaf6629a047b5d4d8e2beb488cc45982,65c1fb5dfaf6629a047b5d4d8e2beb488cc45982,"Remove stack locals from sentry messages.

It's annoying that we have to do this, but it seems like the quickest way for
now to not have messages dropped."
emfree,2014-08-03 02:28:54,https://api.github.com/repos/nylas/sync-engine/git/commits/ecd42773ae32facda46fcf2b496d15db2cf21896,ecd42773ae32facda46fcf2b496d15db2cf21896,Move sentry alerting into function for easier calling from other services.
grinich,2014-08-03 00:38:17,https://api.github.com/repos/nylas/sync-engine/git/commits/76a665040ff95f5758cc79b40ffa6d8d664c34dd,76a665040ff95f5758cc79b40ffa6d8d664c34dd,Update readme
emfree,2014-08-02 02:29:55,https://api.github.com/repos/nylas/sync-engine/git/commits/a8b50a94e32a544d53b2e359fad7e7d21018fe0a,a8b50a94e32a544d53b2e359fad7e7d21018fe0a,"Move handling of 'unknown' providers.

Needed with D292."
emfree,2014-08-02 18:41:59,https://api.github.com/repos/nylas/sync-engine/git/commits/f2eee47ab379db246db47891b7c27499bf8ad754,f2eee47ab379db246db47891b7c27499bf8ad754,"[DEPENDENCIES] Better validate API query parameters.

Summary:
Use flask-restful's parameter-parsing facility to return meaningful errors when
unexpected or malformed parameters are passed in API requests.

Test Plan: Unit tests.

Reviewers: charles

Reviewed By: charles

Differential Revision: https://review.inboxapp.com/D288"
emfree,2014-08-02 17:56:36,https://api.github.com/repos/nylas/sync-engine/git/commits/43fb42029c88d88e59727a025d574b0de794bc60,43fb42029c88d88e59727a025d574b0de794bc60,Add generic exception retry and reporting logic to top-level SyncService.
spang,2014-08-02 00:55:42,https://api.github.com/repos/nylas/sync-engine/git/commits/c6a79bc7eaf025006fd35e32c9dd1a9d4575af5e,c6a79bc7eaf025006fd35e32c9dd1a9d4575af5e,[DEPENDENCIES] Add missing simplejson dep.
spang,2014-08-02 00:18:04,https://api.github.com/repos/nylas/sync-engine/git/commits/61cfec4fb8a0d6ae3519eed391fdbb835279a37b,61cfec4fb8a0d6ae3519eed391fdbb835279a37b,Fix what looks like a bad merge.
kav-ya,2014-08-01 21:52:20,https://api.github.com/repos/nylas/sync-engine/git/commits/1ab8c40e56fb63802b90b092db9a9817886623c9,1ab8c40e56fb63802b90b092db9a9817886623c9,[Monocle] Include provider counts in accounts page.
emfree,2014-08-01 18:20:47,https://api.github.com/repos/nylas/sync-engine/git/commits/3157087e762cf65d8dcb18080a8a7e003ecfcc27,3157087e762cf65d8dcb18080a8a7e003ecfcc27,"Change syncback_service text fixture scope.

I still really don't understand how exactly gevent and pytest interact, but
this seems to resolve the issue in which later tests using the fixture fail
when the whole suite is run."
khamidou,2014-08-01 17:30:00,https://api.github.com/repos/nylas/sync-engine/git/commits/e85005a21fcb88c8f563d68a75c22d1dcd5b24db,e85005a21fcb88c8f563d68a75c22d1dcd5b24db,"Catch UnpackValueError when loading the Gmail metadata cache

Summary: Fixes T199.

Test Plan: Tested by launching a sync, stopping it midway and manually corrupting the cache.

Reviewers: spang

Reviewed By: spang

Maniphest Tasks: T199

Differential Revision: https://review.inboxapp.com/D289"
kav-ya,2014-08-01 03:46:30,https://api.github.com/repos/nylas/sync-engine/git/commits/aa92c31b9f5a91cc2300c4564978b107aad6e765,aa92c31b9f5a91cc2300c4564978b107aad6e765,[Monocle] Close db session after request processing.
emfree,2014-07-31 19:31:53,https://api.github.com/repos/nylas/sync-engine/git/commits/b5e3f1135f76e3735071b5c7a2a29654210aa133,b5e3f1135f76e3735071b5c7a2a29654210aa133,"Remove order_by API parameter; always return results most-recent first.

This is the better choice for most applications."
emfree,2014-07-31 22:17:37,https://api.github.com/repos/nylas/sync-engine/git/commits/d97bc89787d356cab603ad28321ea7d5f33dada6,d97bc89787d356cab603ad28321ea7d5f33dada6,"Limit tag queries by namespace_id to improve API performance.

This is a quick way to resolve the most egregious slowness when doing API
queries filtered by a tag. We should however explore doing this more
automatically, e.g. with the association proxy."
kav-ya,2014-07-31 21:15:18,https://api.github.com/repos/nylas/sync-engine/git/commits/871eaaa41b63b960ba937423d93ced5173445990,871eaaa41b63b960ba937423d93ced5173445990,"Fixes T236: (AttributeError) 'int' object has no attribute 'lstrip'

IMAPClient's fetch() parses numeric labels into Python ints/longs.
Therefore convert them to unicode strs."
kav-ya,2014-07-30 22:14:23,https://api.github.com/repos/nylas/sync-engine/git/commits/02ff16e2c0a0c6c7d69108a7a4f3dcb7cdf1aada,02ff16e2c0a0c6c7d69108a7a4f3dcb7cdf1aada,"Configurable resettable_counter.

Summary:
retry_crispin sets max_count=5, reset_interval=150 in the hope
this decreases the number of imaplib abort errors we've been seeing.

We pick 5 because that was the number we'd used with geventconnpool's retry
(i.e. before we switched to our own). 150 is more arbitrary.

Test Plan: Test added to tests/general/test_concurrency.py

Reviewers: spang

Reviewed By: spang

Differential Revision: https://review.inboxapp.com/D286"
kav-ya,2014-07-31 05:02:29,https://api.github.com/repos/nylas/sync-engine/git/commits/36c173547b4389b888460fd24798bc405cf5f760,36c173547b4389b888460fd24798bc405cf5f760,Adapt Monocle to run under nginx.
spang,2014-07-30 04:04:32,https://api.github.com/repos/nylas/sync-engine/git/commits/3a00924c1de8f3d59be501480a9cd344fc5b7963,3a00924c1de8f3d59be501480a9cd344fc5b7963,"Don't hold database sessions open for long periods during mailsync.

Summary:
This was causing us to create a ridiculous number of database
connections which sat around idle most of the time because the mailsync
code was waiting on network I/O (or simply sleeping).

The codebase still needs further audit, but this improves the situation a lot.

Test Plan: Deploy to Gunks.

Reviewers: kav-ya

Differential Revision: https://review.inboxapp.com/D284"
spang,2014-07-30 23:11:54,https://api.github.com/repos/nylas/sync-engine/git/commits/ae0e5ff021b3242ee47a5e094beaa5746f2ec123,ae0e5ff021b3242ee47a5e094beaa5746f2ec123,Decrease db pool max_overflow.
spang,2014-07-30 03:09:25,https://api.github.com/repos/nylas/sync-engine/git/commits/5a853e6c82e9c7c42d4ee17cbe3ea96deafacc1d,5a853e6c82e9c7c42d4ee17cbe3ea96deafacc1d,Update outdated comment.
spang,2014-07-30 22:07:50,https://api.github.com/repos/nylas/sync-engine/git/commits/927ea840fec3f5df5cb2e336ea7aa65f239ff2d9,927ea840fec3f5df5cb2e336ea7aa65f239ff2d9,Update line endings. (Latest git enforces.)
kav-ya,2014-07-30 21:24:39,https://api.github.com/repos/nylas/sync-engine/git/commits/82ed11aacc68c064b1f6c618dde12ea94c7592a5,82ed11aacc68c064b1f6c618dde12ea94c7592a5,"Rename FK in migration 70 - For some reason, Gunks' db has it named differently than ours."
khamidou,2014-07-30 18:32:01,https://api.github.com/repos/nylas/sync-engine/git/commits/0bea26333969adfaf7949fc2bfee23c640632188,0bea26333969adfaf7949fc2bfee23c640632188,"added a small ""getting all the messages in a thread"" section"
kav-ya,2014-07-30 07:21:57,https://api.github.com/repos/nylas/sync-engine/git/commits/53b089ce7e97d27d4690b7449319854071f2bd0a,53b089ce7e97d27d4690b7449319854071f2bd0a,"[Monocle]: Include account info (email, provider) in per-account status page."
kav-ya,2014-07-30 06:03:20,https://api.github.com/repos/nylas/sync-engine/git/commits/83d95f2ec32156a16cf28ba93baf8be7f789b49f,83d95f2ec32156a16cf28ba93baf8be7f789b49f,"Fix SQLAlchemy UnmappedInstanceError on EAS messages w.out. Date, Received headers."
spang,2014-07-30 01:37:53,https://api.github.com/repos/nylas/sync-engine/git/commits/7c7397a705f825b4946976a2884914e0951696aa,7c7397a705f825b4946976a2884914e0951696aa,"Always inherit from object.

See https://docs.python.org/2/glossary.html\#term-new-style-class for why."
spang,2014-07-30 01:27:24,https://api.github.com/repos/nylas/sync-engine/git/commits/22a721d39f100bbad9aa4a66e4ed4a454edc5a3d,22a721d39f100bbad9aa4a66e4ed4a454edc5a3d,"Explicitly garbage collect ScriptDirectory object in check_db().

For whatever reason, the line `script.get_current_head()` leaves a bunch
of idle db connections lying around until the ScriptDirectory object is
garbage collected. I'm not sure what it's using them all for because
ahhh source diving SQLAlchemy, but it's sure not because we're asking
for a lot of connections in our migration env config. For now, we can
work around by explicitly cleaning them up."
spang,2014-07-30 01:23:19,https://api.github.com/repos/nylas/sync-engine/git/commits/fafbf47424ad253db38c8cf07b5fcc9d2cf29633,fafbf47424ad253db38c8cf07b5fcc9d2cf29633,"Don't setproctitle in inbox.util.startup.

Scripts should set their proctitle to something unique themselves."
spang,2014-07-30 01:22:10,https://api.github.com/repos/nylas/sync-engine/git/commits/0c879d251afec376b61599b767c0876c59739ac5,0c879d251afec376b61599b767c0876c59739ac5,"Use main_engine() in alembic env setup.

We enforce a few valuable options such as strict mode and the charset
with it, which are valuable to set during migrations as well."
spang,2014-07-29 22:14:49,https://api.github.com/repos/nylas/sync-engine/git/commits/97c34df0276ecd113df570b036cf2189cd468f48,97c34df0276ecd113df570b036cf2189cd468f48,"Properly handle SIGTERM in inbox-start.

Now we will shut down child processes upon receipt of SIGTERM, so
running under supervisor continues to work. Supervisor uses SIGTERM for
its 'stop' command.

We remove the use of gipc as well since we're not really intermingling
our usage of gevent and multiprocessing, and it's not clear to me that
gipc is well-maintained."
spang,2014-07-19 03:07:03,https://api.github.com/repos/nylas/sync-engine/git/commits/6f7b777acaa8059971bbf77ebb12a295ec9909cb,6f7b777acaa8059971bbf77ebb12a295ec9909cb,"[DEPENDENCIES] Basic multicore support for SyncService.

Summary:
We implement super ultra basic multicore support by splitting account
syncs across CPU by (account.id % 4), which does not take into account
system load in any way whatsoever. We can still shard across machines by
changing an account's `sync_host`.

gipc is required in order to prevent multiprocessing from duplicating
parent greenlets into child processes.

My goal here was to retain deployment+development simplicity, hence
choosing to use Python's multiprocessing library rather than a shell
script wrapper or CLI arguments + multiple supervised services.
I had to remove the auto-reloader for mailsync since it doesn't play nice with
gipc.

In the meantime, we also removed SyncService's dependency on ZeroRPC,
and instead do all account actions by polling for changes to the
database. bin/inbox-sync now simply marks the database and returns
immediately instead of waiting on an RPC call. Nothing should be talking
directly to the mail sync process now. Also, each process has its own
connection pool; SQLAlchemy pools are not safe for concurrent access.

Test Plan: manual testing

Reviewers: emfree

Differential Revision: https://review.inboxapp.com/D265"
spang,2014-07-29 20:29:41,https://api.github.com/repos/nylas/sync-engine/git/commits/a1bbc1d81716cb4b15e357077c28ef17b9834986,a1bbc1d81716cb4b15e357077c28ef17b9834986,"[DEPENDENCIES] Add cssselect package.

Talon uses this for some quote extraction."
kav-ya,2014-07-29 20:15:32,https://api.github.com/repos/nylas/sync-engine/git/commits/dd8a36d1e6bdf53f5b401f830b6b15263d39e206,dd8a36d1e6bdf53f5b401f830b6b15263d39e206,"[Monocle] Display account counts (total, running, stopped, killed, unstarted)."
kav-ya,2014-07-29 17:38:25,https://api.github.com/repos/nylas/sync-engine/git/commits/37dc6f678674c5f9df5ff797b0ff612672951e76,37dc6f678674c5f9df5ff797b0ff612672951e76,"[DEPENDENCIES] lxml (for talon).

Also fix import in tests/imap/network/test_actions_syncback.py"
kav-ya,2014-07-29 03:14:17,https://api.github.com/repos/nylas/sync-engine/git/commits/59fead7c318f1df835d2f7fa6fdab0fcf6b51d2b,59fead7c318f1df835d2f7fa6fdab0fcf6b51d2b,"[SCHEMA] Fixes T207: EAS Integrity Error

Summary:
EAS folders are uniquely determined by a folder_name and an eas_folder_id.
We pass in the eas_folder_id as the canonical name since Folder.find_or_create()
queries on both name, canonical_name before creating a Folder.

The included migration:
1. Changes the unique constraint on Folder from (account_id, name) to (account_id, name, canonical_name)
2. Adds a unique constraint on EASFolderSyncStatus for the (account_id, eas_folder_id) relation.

Test Plan: Syncs (EAS, other) run as before.

Reviewers: spang

Differential Revision: https://review.inboxapp.com/D275"
spang,2014-07-29 17:15:43,https://api.github.com/repos/nylas/sync-engine/git/commits/a4d693429feccc24d1926151f9ca94f671295944,a4d693429feccc24d1926151f9ca94f671295944,Don't run monocle in debug mode by default.
spang,2014-07-29 05:45:22,https://api.github.com/repos/nylas/sync-engine/git/commits/45c1d31245f726bd299cfa1a9ffb3153f5e83b6f,45c1d31245f726bd299cfa1a9ffb3153f5e83b6f,"Raise better error when message has no BODY[].

This shouldn't really happen, but we're seeing it on a Hotmail account, so more investigation is warranted."
spang,2014-07-29 02:38:53,https://api.github.com/repos/nylas/sync-engine/git/commits/a94de49bd773d665c921364dd62349cc74560409,a94de49bd773d665c921364dd62349cc74560409,"[DEPENDENCIES] Integrate exception logging with Sentry.

Summary:
For large deployments, exceptions over email get extremely unwieldy.

This commit also fixes up the email code to use `config.get_required()`
and moves the structlog configuration as far up in inbox/log.py as we
can (it's strange to have code that runs on import way down at the
bottom).

There is some known weirdness with integrating raven's logger with structlog
(see for example https://github.com/getsentry/raven-python/issues/377), but
we can look more into weeding out extra errors later---let's first see what
things look like in practice with Sentry's default verbose logging.

We may also want to hook into the logging infrastructure directly later and
report on more errors than just mailsync uncaught exceptions.

Test Plan: Manual triggering of exceptions.

Reviewers: kav-ya

Reviewed By: kav-ya

Differential Revision: https://review.inboxapp.com/D273"
emfree,2014-07-26 05:41:59,https://api.github.com/repos/nylas/sync-engine/git/commits/632ffe08bc5627ce37c215af83b4dbc107831d2a,632ffe08bc5627ce37c215af83b4dbc107831d2a,"Handle RequestError in contacts sync.

People will inevitably not enable the google contacts API, and we should really
handle that exception. Just logging an error seems like the way to go for now."
nylasbot,2014-07-26 01:41:40,https://api.github.com/repos/nylas/sync-engine/git/commits/8626f5a481077a7f0d42af50ba1a1d25efb03f3a,8626f5a481077a7f0d42af50ba1a1d25efb03f3a,"Monkey-patch bson's JSON decoder to not include timezone info.

This isn't necessarily a future-proof solution, but does mean that we
don't have to add tzinfo all over the place. All oru datetimes are UTC
anyways."
kav-ya,2014-07-26 01:43:02,https://api.github.com/repos/nylas/sync-engine/git/commits/40dfd8a61b1fa2dbe582a24592e8a2459c11f51e,40dfd8a61b1fa2dbe582a24592e8a2459c11f51e,s/@mit.edu/@exchange.mit.edu
emfree,2014-07-26 00:52:20,https://api.github.com/repos/nylas/sync-engine/git/commits/405c3ed80a0da5130910d377f279a17d6a4ac1e6,405c3ed80a0da5130910d377f279a17d6a4ac1e6,"Don't put account id in exception email subject.

Allows gmail to thread those emails more reasonably."
emfree,2014-07-26 00:38:23,https://api.github.com/repos/nylas/sync-engine/git/commits/fcb92eecf613b7b5ab64c39fc28bd54d6cd484f0,fcb92eecf613b7b5ab64c39fc28bd54d6cd484f0,"Catch UnicodeDecodeErrors in slow query logging.

Just an interim fix to keep this from breaking stuff while we investigate the
underlying issue."
emfree,2014-07-26 00:26:53,https://api.github.com/repos/nylas/sync-engine/git/commits/a86e992567095f3e9fcadb813cccd21ffe0a630c,a86e992567095f3e9fcadb813cccd21ffe0a630c,"Schedule draft-deletion-syncback as a separate action from sending.

This prevents us from potentially re-sending a message if the drafts-syncback
call fails for some separate reason."
emfree,2014-07-25 23:55:56,https://api.github.com/repos/nylas/sync-engine/git/commits/49ec34da77652e678c669a5ad6a3e9dedf14239a,49ec34da77652e678c669a5ad6a3e9dedf14239a,"Return more attachment information in API message representation.

Test Plan: curl http://localhost/n/<ns_id>/messages/<id of message with attachment>

Reviewers: charles

Subscribers: mg, bengotow

Differential Revision: https://review.inboxapp.com/D268"
emfree,2014-07-25 23:43:22,https://api.github.com/repos/nylas/sync-engine/git/commits/b945b5f792d1b40bf78cd01b372cf3166d510e73,b945b5f792d1b40bf78cd01b372cf3166d510e73,"Support 'filename' and 'message' parameters on /files queries.

This is a preliminary commit, which doesn't properly return files that are
Blocks but not Parts. Could also use some unit tests."
nylasbot,2014-07-25 22:43:43,https://api.github.com/repos/nylas/sync-engine/git/commits/d1a026fccc70034ec33609a754f20072081d1637,d1a026fccc70034ec33609a754f20072081d1637,"Reduce writable connection pool size to 1 for now.

We were still getting 'too many simultaneous connection' errors...

Also add a bit of logging."
emfree,2014-07-25 21:43:52,https://api.github.com/repos/nylas/sync-engine/git/commits/5105198c8e9cc5199e0beba2aa96679b9fb6351d,5105198c8e9cc5199e0beba2aa96679b9fb6351d,"Prevent concurrent creation of duplicate connection pools.

Did you think that because a gevented process is basically still
single-threaded, it's free of your normal concurrency woes? Well, not so much.
Consider the following test case:

---
import random
from gevent import monkey; monkey.patch_all()
import gevent

def maybe_update_shared_dict(k, v, d={}, final=False):
    if d.get(k) is None:
        gevent.sleep()
        d[k] = v
    return d.get(k)

def test():
    print maybe_update_shared_dict('a', random.randint(0, 22))

threads = [gevent.spawn(test) for _ in range(10)]
gevent.joinall(threads)
---

Only the first call to maybe_update_shared_dict should store a value in the
dictionary d, and all the other greenlets should read it. But that's not
actually what happens, because concurrency.

This is basically what we were doing when creating IMAP connection pools. This
is an issue if you start the syncback service and it tries to execute a bunch
of actions for the same account at once -- you end up creating a bunch of
connection pools. Add per-account locks to prevent this."
emfree,2014-07-25 20:55:59,https://api.github.com/repos/nylas/sync-engine/git/commits/fda1bf16b4ae27c03832ffc893cb5c0c1b05e54a,fda1bf16b4ae27c03832ffc893cb5c0c1b05e54a,"Reduce writable IMAP connection pool size.

We don't really need 4 simultaneous writable connections. Maybe we don't even
need 2. This reduces the likelihood that we hit the simultaneous-connection
limit."
kav-ya,2014-07-25 16:34:22,https://api.github.com/repos/nylas/sync-engine/git/commits/f66682d3d2273e8765d01cbfaa30c0832158970a,f66682d3d2273e8765d01cbfaa30c0832158970a,Propogate sync_state='killed' to account sync if all its folder syncs have been killed.
kav-ya,2014-07-25 03:47:37,https://api.github.com/repos/nylas/sync-engine/git/commits/25ed4b9c8ddff5ad5e472c5d90cf4de272fa2503,25ed4b9c8ddff5ad5e472c5d90cf4de272fa2503,"Post-review push for 'Fixes T201: Drafts API should support ?thread=filter.'
Also, tests/general/test_mutable_json_type passes again."
kav-ya,2014-07-25 03:45:30,https://api.github.com/repos/nylas/sync-engine/git/commits/ef37713f966054377d94c99cff5272f865348deb,ef37713f966054377d94c99cff5272f865348deb,"Revert ""Fixes  T201: Drafts API should support ?thread=filter.""
This reverts commit cfa8cb8935544229c9f923ecece8b95b0f145731."
kav-ya,2014-07-25 03:26:43,https://api.github.com/repos/nylas/sync-engine/git/commits/b5f7c5dbd2a752e325884ef5824f35b9976bd859,b5f7c5dbd2a752e325884ef5824f35b9976bd859,"Fixes  T201: Drafts API should support ?thread=filter.

Summary:
get_drafts() method added to inbox/api/filtering.Filter
draft_query_api() added to inbox/api/ns_api.py

Test Plan: Added test in tests/api/test_drafts.py

Reviewers: emfree

Differential Revision: https://review.inboxapp.com/D266"
kav-ya,2014-07-24 22:15:27,https://api.github.com/repos/nylas/sync-engine/git/commits/cf1eca85c79d1d3381dbd8499dc72a265fb13803,cf1eca85c79d1d3381dbd8499dc72a265fb13803,Fixes T191: Flanker DecodeError in EAS
kav-ya,2014-07-24 21:20:49,https://api.github.com/repos/nylas/sync-engine/git/commits/0b19437499a4869f6c84d771c22925c638d2dd1d,0b19437499a4869f6c84d771c22925c638d2dd1d,"[Monocle]
Fully reset sync status on restarting foldersyncs.
Sync type (new/resumed) on account, rather than folder."
khamidou,2014-07-24 11:03:17,https://api.github.com/repos/nylas/sync-engine/git/commits/420b4c9759d7fc2015c87f7c9d9d55c6f342242a,420b4c9759d7fc2015c87f7c9d9d55c6f342242a,"Add support for yahoo syncback actions

Summary:
Implemented all actions - needs review.

Christine, could you take a quick look at the code and tell me if it's okay?
I'd like to have your opinion on this specific things:

1. I'm not sure I'm doing the ORM requests the right way. There's probably something
   more efficient than loading all the fields from the db.

2. I'm a bit wary about the race condition we get when deleting a draft which is not yet
   reconciled. I'm open to suggestions about how to handle this.

fixed rebase bug

code for review

rebased latests changes + fixed rebasing bugs

ignore soft deletes - fixes draft deletion bug

draft deletion and reconciliation

refactor - moved draft deletion code from YahooCrispinClient to CrispinClient - ... we won't need it for yahoo because their servers don't support querying a specific header

Test Plan: manual testing, interacting with the REST API using curl.

Reviewers: spang

Reviewed By: spang

Subscribers: kav-ya

Differential Revision: https://review.inboxapp.com/D257"
kav-ya,2014-07-23 22:24:39,https://api.github.com/repos/nylas/sync-engine/git/commits/daf6e402c8e52d4aa4ab8f38fde0179a5e4a777f,daf6e402c8e52d4aa4ab8f38fde0179a5e4a777f,"Potentially fix T197, T194.

Summary:
T197 was due to yesterday's ""fix"" to T194.
Therefore revert it (i.e. remove the db_session.add(folder) in create_db_objects();
if no new_uids were added, there is no db_commit() before the save_folder_names() which
will try to create the same folder raising the error in T197).

This didn't really fix T194 anyway so it's not a huge loss.

So, take two at fixing T194:
Folder.create() adds the created Folder to the session;
there is some weirdness about association proxy + backref
(See: https://groups.google.com/forum/#!topic/sqlalchemy/6RV6ay3rwIs).
In particular, I'm not sure how autoflush behaves in this case when
the folder the FolderItem is instantiated with may not have been
explicitly added to the session.

As before, not certain this is a guaranteed fix but:
1. I'd like to test it against mg's failing accounts on Gunks.
2. I won't mark anything as resolved till we see it is.
3. It may work.

Test Plan: Sync on inboxapptest runs.

Reviewers: emfree

Reviewed By: emfree

Maniphest Tasks: T194

Differential Revision: https://review.inboxapp.com/D264"
khamidou,2014-07-23 11:26:16,https://api.github.com/repos/nylas/sync-engine/git/commits/c9b13996a755fabc6053c55dfb459e12b3600c4f,c9b13996a755fabc6053c55dfb459e12b3600c4f,"Moved from pyflakes and pep8 to flake8

Summary: flake8 has some desirable features like annotations to deactivate unneeded warnings.

Test Plan: check if linting still works (it does)

Reviewers: spang, emfree

Reviewed By: emfree

Differential Revision: https://review.inboxapp.com/D258"
emfree,2014-07-23 00:51:36,https://api.github.com/repos/nylas/sync-engine/git/commits/7f617a7aa21862ffde6b94afe8300f82498ea80a,7f617a7aa21862ffde6b94afe8300f82498ea80a,"Add a script to run the syncback service independently.

We need this if the API is deployed other than via the bin/inbox-api script."
kav-ya,2014-07-22 23:16:44,https://api.github.com/repos/nylas/sync-engine/git/commits/019c11d1f350ace00392b0317d009e4191499dc6,019c11d1f350ace00392b0317d009e4191499dc6,"Fixes T194: IntegrityError (1452) FolderItem.folder_id -> Folder.id Foreign Key Constraint Fails.

Summary:
Here's what I think the issue is:

We create a new Folder (line 118, mailsync.base.create_db_objects()) but do not add it to the session.
The corresponding FolderItems are created in line 680, mailsync.gmail.add_gmail_attrs() with autoflush disabled.
Then in contacts.process_mail.update_contacts(), we call get_contact_objects();
the db_session.query(Contact).filter(…).all() in this function triggers an autoflush and causes
the IntegrityError (1452): foreign key constraint fails for FolderItem.folder_id -> Folder.id because the FolderItems are in the session but the Folder
is not.

To fix this:
Added the Folder to the session in mailsync.base.create_db_objects()

Note:
I am not certain that this is the issue, I could not repro it to test the fix - hence, the request for review.

Test Plan: Sync runs as before.

Reviewers: emfree

Reviewed By: emfree

Differential Revision: https://review.inboxapp.com/D263"
emfree,2014-07-23 00:51:36,https://api.github.com/repos/nylas/sync-engine/git/commits/02d1c5d5e7d9df89e76169a7032bfcd4dce9fcd0,02d1c5d5e7d9df89e76169a7032bfcd4dce9fcd0,"Fix assorted drafts/sending bugs.

* Keep track in memory of which syncback actions have been scheduled but not
  completed, so that we don't try to schedule them twice.
* Remove `message.is_draft` assertion from inbox.actions.delete_draft. This was
  failing when we sent a message, then tried to delete the draft-that-it-was.
* Return instead of raising an AssertionError if we try to send a message that
  isn't a draft or is already sent.
* Distinguish between creating a draft and syncing it to the backend,
  and creating a draft only to send it immediately (in the /send API).
* When constructing the In-Reply-To and References headers on a message, don't
  the previous message's Message-Id and References headers may be null. In this
  case, gracefully degrade instead of failing with a TypeError."
emfree,2014-07-22 23:17:34,https://api.github.com/repos/nylas/sync-engine/git/commits/fe9c658f1c8b4c437591fa19403a9c77dafb2bc3,fe9c658f1c8b4c437591fa19403a9c77dafb2bc3,"[SCHEMA] Set executed status on action log entries.

Summary:
This is a prerequisite to running the syncback service as an actual standalone
service: we can stop and restart it and not need to worry about losing actions.

Test Plan: Unit tests updated.

Reviewers: kav-ya

Reviewed By: kav-ya

Differential Revision: https://review.inboxapp.com/D259"
emfree,2014-07-22 06:07:44,https://api.github.com/repos/nylas/sync-engine/git/commits/9ca0ee55ae4a3c38fd59afc0397c344401602d2c,9ca0ee55ae4a3c38fd59afc0397c344401602d2c,Update test db dump to not include message.created_date.
emfree,2014-07-22 05:49:00,https://api.github.com/repos/nylas/sync-engine/git/commits/65ac0313a2c67844c82fb1125b65c27984e39994,65ac0313a2c67844c82fb1125b65c27984e39994,"Don't copy created_date in migration 066.

Not using that field anymore."
emfree,2014-07-22 02:12:05,https://api.github.com/repos/nylas/sync-engine/git/commits/f57a1c866bac95870db9ae97de99f9e296256ee8,f57a1c866bac95870db9ae97de99f9e296256ee8,Clarify phrasing in API filtering documentation.
kav-ya,2014-07-22 01:52:52,https://api.github.com/repos/nylas/sync-engine/git/commits/5bdc18f28d6caa934eeb538843acc5abc2c0a75e,5bdc18f28d6caa934eeb538843acc5abc2c0a75e,Fixes T185: Column extra_flags cannot be null
kav-ya,2014-07-21 23:22:47,https://api.github.com/repos/nylas/sync-engine/git/commits/0f8e3f65e4b76b7faccb8590194987df597eae68,0f8e3f65e4b76b7faccb8590194987df597eae68,"[SCHEMA] Fixes T163: Drafts synced from remote can't be updated/sent via API

Summary:
Kill SpoolMessage, the Message table stores the extra info needed for Inbox-created, synced back drafts.

Also fixes a few minor drafts related bugs.

Test Plan: None (regression tested)

Reviewers: emfree

Reviewed By: emfree

Differential Revision: https://review.inboxapp.com/D255"
bengotow,2014-07-17 23:41:02,https://api.github.com/repos/nylas/sync-engine/git/commits/640fdc57b2405661a0cade2a2b91318bcf3e9b0d,640fdc57b2405661a0cade2a2b91318bcf3e9b0d,"Updating documentation based on Layer meeting feedback

Summary: Only modifies docs

Test Plan: Read over docs and provide feedback

Reviewers: spang

Differential Revision: https://review.inboxapp.com/D242

Conflicts:
	inbox/docs/api/05_tags.mdown"
bengotow,2014-08-12 17:40:16,https://api.github.com/repos/nylas/sync-engine/git/commits/fd32cd43396ccb4a0b5714bc6a7790b9f33b0943,fd32cd43396ccb4a0b5714bc6a7790b9f33b0943,"Improvements to docs: PUT ""/thread"" => ""/threads"""
khamidou,2014-08-12 10:14:30,https://api.github.com/repos/nylas/sync-engine/git/commits/e8460343a489d528424b52817e067eadbc1baa8a,e8460343a489d528424b52817e067eadbc1baa8a,"Fix a small ImapClient bug

Summary: I found a small bug in ImapClient which makes it crash when making a SEARCH using MODSEQ. The bug will be fixed in 0.12. In the meantime, I changed requirements.txt to point to our ImapClient fork.

Test Plan: Ran a full sync and an update afterwards.

Reviewers: emfree, spang

Reviewed By: spang

Differential Revision: https://review.inboxapp.com/D315"
kav-ya,2014-08-12 06:20:27,https://api.github.com/repos/nylas/sync-engine/git/commits/d92d769611e1b7b5ec86364c3caeee051d47d99e,d92d769611e1b7b5ec86364c3caeee051d47d99e,"[Monocle] Fix pretty date regression.
Sync start time is original start time.
Kill sync end time."
emfree,2014-08-12 05:31:49,https://api.github.com/repos/nylas/sync-engine/git/commits/09b327358f8e91c5f5d84b226643398af1d7556b,09b327358f8e91c5f5d84b226643398af1d7556b,"Update migration 072 to not depend on Message model.

The problem is that a later migration (076) adds a Message.thread_order column.
So if you try to run a migration that spans 072 to 076, it will import the
later version of the Message class, which references a thread_order column that
isn't in the database yet. Fix this by including a self-contained
calculate_html_snippet function.

Also update migration 079 to properly check for the existence of the 'uid'
unique constraint."
emfree,2014-08-12 01:33:18,https://api.github.com/repos/nylas/sync-engine/git/commits/565fe01f806304dee099abd93e6dbfbf278e79c5,565fe01f806304dee099abd93e6dbfbf278e79c5,"Remove module-level imports from migrations.

The problem here is that alembic imports all the migration scripts when we
check the current alembic revision on startup. This can break as the code
changes later. In particular, we may end up importing stuff that gevent later
monkeypatches, causing strange breakages."
emfree,2014-08-12 00:26:35,https://api.github.com/repos/nylas/sync-engine/git/commits/048ef9a897b34cf55c199ad20e8ab3c53d6f87fa,048ef9a897b34cf55c199ad20e8ab3c53d6f87fa,"Make configure_logging idempotent; move API response configuration.

It doesn't make sense to globally configure an app's error handlers if it uses
the ns_api blueprint, so move the errorhandler installation to api/srv.py."
kav-ya,2014-08-12 00:11:23,https://api.github.com/repos/nylas/sync-engine/git/commits/14e91ea94ec23273a68a804e122e50d299ed7514,14e91ea94ec23273a68a804e122e50d299ed7514,[Monocle] Include approx. sync rate for EAS syncs
bengotow,2014-08-11 23:03:48,https://api.github.com/repos/nylas/sync-engine/git/commits/28642e949ea146262803cd475a1c6e1d2b5c432c,28642e949ea146262803cd475a1c6e1d2b5c432c,Improvements to docs for tags
bengotow,2014-08-11 22:04:24,https://api.github.com/repos/nylas/sync-engine/git/commits/15b7245ed6bfcb7ca352933ff925f2f6e6ebaa00,15b7245ed6bfcb7ca352933ff925f2f6e6ebaa00,Improvements to docs JSON
bengotow,2014-08-11 22:00:25,https://api.github.com/repos/nylas/sync-engine/git/commits/cb1cea4b76525d3a5e32d3a34c01792c9fbd9a87,cb1cea4b76525d3a5e32d3a34c01792c9fbd9a87,"Improvements to docs for drafts,sending based on feedback"
kav-ya,2014-08-11 20:57:38,https://api.github.com/repos/nylas/sync-engine/git/commits/b779d681f3d1438eb55c039e989ad86d074c7875,b779d681f3d1438eb55c039e989ad86d074c7875,"Fix to 'cannot acquire gevent lock'.
Fixes T247.

Summary:
service.start_sync() checks if the account's already locked and its sync_state is killed - if so, unlock before trying to
reacquire the lock.

Test Plan: None.

Reviewers: emfree

Reviewed by: emfree

Differential Revision: https://review.inboxapp.com/D314"
kav-ya,2014-08-07 22:08:01,https://api.github.com/repos/nylas/sync-engine/git/commits/f84bb59d3c59831cd460084a0ba0495cc7930db3,f84bb59d3c59831cd460084a0ba0495cc7930db3,[Monocle] Basic cache.
khamidou,2014-08-11 10:26:09,https://api.github.com/repos/nylas/sync-engine/git/commits/33325ab95da871c214d2793f0ea7b49625287aaf,33325ab95da871c214d2793f0ea7b49625287aaf,"Fix yahoo-none for custom folders.

Summary: Fixes T270.

Test Plan: Ran a sync. Saw that the bug had disappeared.

Reviewers: spang, emfree

Reviewed By: emfree

Maniphest Tasks: T270, T262

Differential Revision: https://review.inboxapp.com/D309"
kav-ya,2014-08-11 08:42:20,https://api.github.com/repos/nylas/sync-engine/git/commits/20ae31344260dae6eafdb63d941fae94a60a31e1,20ae31344260dae6eafdb63d941fae94a60a31e1,"Adapt new code for Contacts to work with EAS.

Test plan:
All tests in tests/general/contacts + tests/api/test_contacts.py pass.
EAS sync does not fail."
kav-ya,2014-08-11 09:00:29,https://api.github.com/repos/nylas/sync-engine/git/commits/e2dda7e556cc6652a0fb34aa62edb0887af45f8e,e2dda7e556cc6652a0fb34aa62edb0887af45f8e,Revert commits pending CR
kav-ya,2014-08-09 22:18:50,https://api.github.com/repos/nylas/sync-engine/git/commits/16691da42e097992746e6341d6b39533bf2ac909,16691da42e097992746e6341d6b39533bf2ac909,"Fix to 'cannot acquire gevent lock' (unreverted)

Summary:
service.start_sync() checks if the account's already locked and its sync_state is killed - if so, unlock before trying to
reacquire the lock.

Test Plan: None.

Reviewers: emfree

Differential Revision: https://review.inboxapp.com/D314"
kav-ya,2014-08-09 22:14:52,https://api.github.com/repos/nylas/sync-engine/git/commits/ad69f4d85ad1d38156455a9560385809740e7f01,ad69f4d85ad1d38156455a9560385809740e7f01,"Revert ""Fix to 'cannot acquire gevent lock'.""

This reverts commit c526c0bad1bc97ea5c16e5a8f2da7055c7a99243."
kav-ya,2014-08-09 22:11:32,https://api.github.com/repos/nylas/sync-engine/git/commits/c526c0bad1bc97ea5c16e5a8f2da7055c7a99243,c526c0bad1bc97ea5c16e5a8f2da7055c7a99243,Fix to 'cannot acquire gevent lock'.
kav-ya,2014-08-09 21:42:07,https://api.github.com/repos/nylas/sync-engine/git/commits/b6663edb1c75b4b7776dd5eb10acf484b7aaeb32,b6663edb1c75b4b7776dd5eb10acf484b7aaeb32,Migration update.
emfree,2014-08-09 08:05:26,https://api.github.com/repos/nylas/sync-engine/git/commits/5b654fb16624cc16207d6f38931d51670e4b7e5c,5b654fb16624cc16207d6f38931d51670e4b7e5c,"Distinguish between canonical and reserved tag names.

Canonical tags are ones that always exist in the Inbox API. Reserved tags
are ones that we prevent users from creating, because we might use them in the
future or because of confusion potential. Don't actually create tag objects for
the latter category.

Fixes T166."
emfree,2014-08-09 08:01:10,https://api.github.com/repos/nylas/sync-engine/git/commits/0f41efc80f6175c0b914372140a7df4e9dc0fbae,0f41efc80f6175c0b914372140a7df4e9dc0fbae,"Make update_thread_labels more performant.

The updating-labels-on-a-thread situation still needs more attention, but in
the meantime, at least make this faster. Doing thread.folders = {...} proves to
be expensive, because sqlalchemy does thread.folders.clear() under the hood,
so we remove all the associated tags and so on. But then in the common case we
just reconstruct the same set of folders, and it's a whole lotta SQL for
nothing. Something to keep in mind when working with the ORM."
emfree,2014-08-09 04:56:33,https://api.github.com/repos/nylas/sync-engine/git/commits/54f7ba4414001dfeb32ae73bbf2258f803be39b0,54f7ba4414001dfeb32ae73bbf2258f803be39b0,"Update a thread's folders when we detect deleted ImapUids.

Summary:
This means that, for example, we remove the 'inbox' tag from a thread if it's
removed from the Gmail inbox during an initial sync.

We don't yet deal with the case that a message is deleted entirely (e.g., from
both Inbox and All Mail on Gmail).

Fixes T271.

Test Plan: Start a sync and archive some mail from the top of the inbox.

Reviewers: spang

Reviewed By: spang

Maniphest Tasks: T271

Differential Revision: https://review.inboxapp.com/D312"
emfree,2014-08-09 01:22:11,https://api.github.com/repos/nylas/sync-engine/git/commits/a3210c3efe3c974789bca7998cc55dbb6d51826a,a3210c3efe3c974789bca7998cc55dbb6d51826a,Fix typo in previous commit.
emfree,2014-08-09 01:17:31,https://api.github.com/repos/nylas/sync-engine/git/commits/397f9b0d9eb8b3340ef898fce06fc36c1a2fec81,397f9b0d9eb8b3340ef898fce06fc36c1a2fec81,"Don't fail in crispin.py when supports_condstore attribute is missing.

Outlook is generic IMAP, but the OutlookAccount class doesn't have the
supports_condstore attribute.

Fixes T272."
emfree,2014-08-09 00:34:18,https://api.github.com/repos/nylas/sync-engine/git/commits/9d880e2a60988424d013607f89c966ebceef49b1,9d880e2a60988424d013607f89c966ebceef49b1,"[DEPENDENCIES] Switch to our fork of html2text.

PR submitted upstream, but don't want to just sit around and wait for the next
release.

Fixes T265."
emfree,2014-08-08 21:20:40,https://api.github.com/repos/nylas/sync-engine/git/commits/cb76a2b1a8caf6d2fff2f0c7f43454eecffb908f,cb76a2b1a8caf6d2fff2f0c7f43454eecffb908f,"Fix Sentry message truncation.

In an illustrative example of the hazards of constructing an untyped data model
out of dictionaries and lists, raven's RemoveStackLocalsProcessor doesn't do
what it says on the box, so neither does our code based on it. Put together
something that should work better until we can submit a PR upstream."
khamidou,2014-08-08 15:54:27,https://api.github.com/repos/nylas/sync-engine/git/commits/d19c56dd40e7819d904591610e4e29d88b6d6f9b,d19c56dd40e7819d904591610e4e29d88b6d6f9b,only generic accounts have a supports_condstore attr
khamidou,2014-08-08 12:19:13,https://api.github.com/repos/nylas/sync-engine/git/commits/0dc2b1f33313190668a4ec3550966568daa2e247,0dc2b1f33313190668a4ec3550966568daa2e247,forgot debug printf
khamidou,2014-08-08 12:02:31,https://api.github.com/repos/nylas/sync-engine/git/commits/61995eb1121983d104bc24ce7f94fc24d02410cd,61995eb1121983d104bc24ce7f94fc24d02410cd,fixed bug in threading code
khamidou,2014-08-08 10:10:56,https://api.github.com/repos/nylas/sync-engine/git/commits/00cd772cdba73d070dc37a9c6e0174fe01af0ab9,00cd772cdba73d070dc37a9c6e0174fe01af0ab9,fix code rot
khamidou,2014-08-08 09:59:37,https://api.github.com/repos/nylas/sync-engine/git/commits/708b8d797d08e63314c93ab992c08babdb8ddc2f,708b8d797d08e63314c93ab992c08babdb8ddc2f,"Automatically enable Condstore for servers who support it

Summary:
I needed this patch to test D297. It does two things:

1. Detect and store condstore support when running inbox-auth
2. When starting a sync choose the right monitor class

Test Plan: Tested by running a full sync + polls on a yahoo and fastmail account. Used the ImapClient logs to check that the right commands where issued.

Reviewers: charles, spang

Reviewed By: spang

Subscribers: mg

Differential Revision: https://review.inboxapp.com/D302"
khamidou,2014-08-08 09:42:01,https://api.github.com/repos/nylas/sync-engine/git/commits/761b2803de2cfc19b6fa69a0b85b0f3ed386cbe3,761b2803de2cfc19b6fa69a0b85b0f3ed386cbe3,"Generic Condstore syncing, take 2.

Summary:
Christine, Charles,

I extracted the condstore syncing code from D280 and adapted it to the new generic backend.

The code is functional but there's some additional work to do which is out of the scope of this patch.

1. There's some refactoring to do around ""crispin_new"". Mostly, I'd like to sniff out the capabilities of the server before constructing the CrispinClient. Right now, every non-gmail provider gets a GenericCrispinClient.

2. There's still this bug in ImapClient. Menno told me he was real close to releasing a fix. Should I go a ahead and fork ImapClient temporarily or just wait for the release?

Test Plan: Ran a couple syncs with fastmail + checked in the ImapClient logs that it was issuing the condstore commands.

Reviewers: charles, spang

Reviewed By: spang

Differential Revision: https://review.inboxapp.com/D297"
emfree,2014-08-08 01:30:27,https://api.github.com/repos/nylas/sync-engine/git/commits/f27e91ba35d09ceec33695d6e97f524399aff564,f27e91ba35d09ceec33695d6e97f524399aff564,"Make g_msgids call more performant.

Summary:
Previously, we'd load *all* the g_msgids for a given account before filtering
them. This makes sense in cases where the in_ parameter is stupidly large
(which it sometimes can be). But in, say, deduplicate_message_object_creation,
this function is called with len(in_) == 1. In that case, doing this adds
hundreds of milliseconds to the time it takes to commit each message.

Test Plan: Run syncs on beta-mailsync.

Reviewers: spang

Reviewed By: spang

Differential Revision: https://review.inboxapp.com/D307"
emfree,2014-08-08 00:59:01,https://api.github.com/repos/nylas/sync-engine/git/commits/2c8e80d4b51ff9dca70f24a69c51c92b71f5bf6d,2c8e80d4b51ff9dca70f24a69c51c92b71f5bf6d,Short-circuit in gmail_download_and_commit_uids when there's nothing to commit.
emfree,2014-08-08 00:37:46,https://api.github.com/repos/nylas/sync-engine/git/commits/1f2d530878f08c2c41a708b4d99bb5181d4de6da,1f2d530878f08c2c41a708b4d99bb5181d4de6da,Remove uninformative log statements.
bengotow,2014-08-08 00:35:09,https://api.github.com/repos/nylas/sync-engine/git/commits/63aa64936981a9d8e35f887e30fd678483c1282e,63aa64936981a9d8e35f887e30fd678483c1282e,"Remove duplicate ""to"" in example JSON"
emfree,2014-08-07 23:11:42,https://api.github.com/repos/nylas/sync-engine/git/commits/f6725241a866494f29f5ba45561ffe488753e5f0,f6725241a866494f29f5ba45561ffe488753e5f0,Update unit test database dump.
khamidou,2014-08-07 10:12:56,https://api.github.com/repos/nylas/sync-engine/git/commits/b64db7beb4744f4ff0e32a3ef9363b5db3b8da0b,b64db7beb4744f4ff0e32a3ef9363b5db3b8da0b,"Threading algorithm

Summary:
Kavya, Charles

I've implemented a basic threading algorithm.  It's sort of complicated.

So, last week I wrote a spec for a threading algorithm. This is not the same algorithm. The algo I speced was about flattening graphs (DAGs) which is kind of complicated to code, so I tried out instead an algo which uses lists.

Here's how it works:

1. The first step is getting together all the the messages which share the same subject (this is debatable but you've got to start somewhere) and sorting them by ""received_date""

2. After this, the algo starts from an empty list and inserts all the messages the one after the other using ""insert_message_in_thread"". insert_message_in_thread uses the in-reply-to and references: headers to insert the message at the correct position or to at least take an educated guess at it. It's quite complex, so I've made a flowchart: {F729}

I'm not sure I've been very clear. Tell me if you have questions.

Test Plan: Compare this threading algorithm with Yahoo and Gmail threading. Run it on a bigger dataset.

Reviewers: charles, kav-ya

Reviewed By: kav-ya

Subscribers: emfree, spang

Differential Revision: https://review.inboxapp.com/D267

[Note(emfree): relanding commit c093ac34903. Surprisingly, the thread_order
column does actually get added by the migration with a default value of 0. It's
just excruciatingly slow to run this on a large database. Added a default
Python value though, as there are places where we create a Message object but
don't set this (drafts and sending)]"
emfree,2014-08-07 18:10:32,https://api.github.com/repos/nylas/sync-engine/git/commits/1057a329ca3c7b038b4c3336809be5d369f2b8cc,1057a329ca3c7b038b4c3336809be5d369f2b8cc,"Revert ""Threading algorithm""

This reverts commit c093ac34903dac74959603099530145e7cf038bc.

Reason for rollback: migration doesn't work."
emfree,2014-08-07 18:10:20,https://api.github.com/repos/nylas/sync-engine/git/commits/c3a00a9647111529a53af85c30070980001eb850,c3a00a9647111529a53af85c30070980001eb850,"Revert ""Fix alembic version ordering.""

This reverts commit 2c31b304a56d54a1e5febeac0abc02c35cf97208."
emfree,2014-08-07 18:02:33,https://api.github.com/repos/nylas/sync-engine/git/commits/2c31b304a56d54a1e5febeac0abc02c35cf97208,2c31b304a56d54a1e5febeac0abc02c35cf97208,Fix alembic version ordering.
emfree,2014-08-07 17:03:58,https://api.github.com/repos/nylas/sync-engine/git/commits/4ed3d6cf50f81af69db49fe33c073e72eb496a61,4ed3d6cf50f81af69db49fe33c073e72eb496a61,"[SCHEMA] Don't try to do search ranking of contacts.

Summary:
This feature proves to be really expensive during a sync, because you have to
issue many additional database queries to commit a single message. It's also of
dubious utility, when just returning unranked results works pretty all right
for contacts. Many clients will likely also opt to cache all contacts locally
for search-as-you-type level performance.

Test Plan:
Run a sync and check that created objects plus filtered API
responses are correct. I'd like to add more unit tests but don't think that's a
blocker.

Reviewers: spang

Reviewed By: spang

Subscribers: mg

Differential Revision: https://review.inboxapp.com/D306"
khamidou,2014-08-07 14:33:26,https://api.github.com/repos/nylas/sync-engine/git/commits/d196a563c66160671bf12a2f69fd567f42fc436c,d196a563c66160671bf12a2f69fd567f42fc436c,fixed scope bug
khamidou,2014-08-07 10:12:56,https://api.github.com/repos/nylas/sync-engine/git/commits/c093ac34903dac74959603099530145e7cf038bc,c093ac34903dac74959603099530145e7cf038bc,"Threading algorithm

Summary:
Kavya, Charles

I've implemented a basic threading algorithm.  It's sort of complicated.

So, last week I wrote a spec for a threading algorithm. This is not the same algorithm. The algo I speced was about flattening graphs (DAGs) which is kind of complicated to code, so I tried out instead an algo which uses lists.

Here's how it works:

1. The first step is getting together all the the messages which share the same subject (this is debatable but you've got to start somewhere) and sorting them by ""received_date""

2. After this, the algo starts from an empty list and inserts all the messages the one after the other using ""insert_message_in_thread"". insert_message_in_thread uses the in-reply-to and references: headers to insert the message at the correct position or to at least take an educated guess at it. It's quite complex, so I've made a flowchart: {F729}

I'm not sure I've been very clear. Tell me if you have questions.

Test Plan: Compare this threading algorithm with Yahoo and Gmail threading. Run it on a bigger dataset.

Reviewers: charles, kav-ya

Reviewed By: kav-ya

Subscribers: emfree, spang

Differential Revision: https://review.inboxapp.com/D267"
kav-ya,2014-08-07 08:07:10,https://api.github.com/repos/nylas/sync-engine/git/commits/ca9e6e0042dbffc21590b0bb4a871e32425ad546,ca9e6e0042dbffc21590b0bb4a871e32425ad546,Fix typo.
kav-ya,2014-08-07 08:01:53,https://api.github.com/repos/nylas/sync-engine/git/commits/b0b2c5ac7cb6c651caba6f660ec92b66fdb3419c,b0b2c5ac7cb6c651caba6f660ec92b66fdb3419c,Matching EAS update.
kav-ya,2014-08-07 07:40:05,https://api.github.com/repos/nylas/sync-engine/git/commits/5e5949737961da78092ff77bdd8ece61e7466d16,5e5949737961da78092ff77bdd8ece61e7466d16,Optimize Monocle % calcs.
kav-ya,2014-08-07 04:56:58,https://api.github.com/repos/nylas/sync-engine/git/commits/9aa335297b2f43e01523d9d9de02e19689d03ac9,9aa335297b2f43e01523d9d9de02e19689d03ac9,Assign return of removed_deleted_uids() in inbox.mailsync.backends.imap.imap in highestmodseq_update
emfree,2014-08-07 03:49:32,https://api.github.com/repos/nylas/sync-engine/git/commits/e944f7f0a3379cf14136bd372bd668d03a6896ab,e944f7f0a3379cf14136bd372bd668d03a6896ab,Flag-guard db session debug logging.
kav-ya,2014-08-07 03:19:03,https://api.github.com/repos/nylas/sync-engine/git/commits/77e3dc4182bbf0333152931a03204fddeab12d13,77e3dc4182bbf0333152931a03204fddeab12d13,Matching update for EAS accounts.
kav-ya,2014-08-05 22:31:16,https://api.github.com/repos/nylas/sync-engine/git/commits/93603e1d51d23348138320306f33ed7941dd550e,93603e1d51d23348138320306f33ed7941dd550e,"Include % synced in metrics + other metric calc tweaks.
Also fix bugs in the non-Gmail IMAP metrics updating.

Summary:
Monocle would now display the following metrics:
# Remote, As of, % synced, # remaining, # downloaded, As of

Test Plan: Visual app inspection.

Reviewers: spang

Reviewed By: spang

Subscribers: charles

Differential Revision: https://review.inboxapp.com/D299"
emfree,2014-08-07 02:14:22,https://api.github.com/repos/nylas/sync-engine/git/commits/8460621cb993601893b8baf597e30f327ddd0ec9,8460621cb993601893b8baf597e30f327ddd0ec9,"[DEPENDENCIES] Bump html2text version.

This is aimed at fixing https://app.getsentry.com/inbox/beta/group/27947231/,
but is purely speculative because I don't have time to dive it more right now.
Anyways, can't hurt."
emfree,2014-08-06 23:31:08,https://api.github.com/repos/nylas/sync-engine/git/commits/db7b948e4054cb06aa7aad20bec943ef22be5164,db7b948e4054cb06aa7aad20bec943ef22be5164,Replace 'events' by 'deltas' terminology throughout.
bengotow,2014-08-06 23:29:57,https://api.github.com/repos/nylas/sync-engine/git/commits/c838367c0421fd55e07ee6ea11ce70bcb8ae0534,c838367c0421fd55e07ee6ea11ce70bcb8ae0534,Improving the delta sync documentation
emfree,2014-08-06 22:50:44,https://api.github.com/repos/nylas/sync-engine/git/commits/c6e53c58bed1e3c4ddfc2f727aae3f445acd81f7,c6e53c58bed1e3c4ddfc2f727aae3f445acd81f7,"[DEPENDENCIES] Add facility to cumulatively profile sync processes.

Summary:
This commit adds the ability to get cumulative profiler data for a running sync
process by doing `kill -SIGTRAP <sync_pid>`, if the 'DEBUG_PROFILING_ON' flag
is set in the config.

Requires an updated version of pyinstrument to avoid issues around interrupting
syscalls when the profiler runs with use_signal=True.

Test Plan: run a mailsync and try it out.

Reviewers: kav-ya

Reviewed By: kav-ya

Differential Revision: https://review.inboxapp.com/D303"
spang,2014-08-06 19:28:46,https://api.github.com/repos/nylas/sync-engine/git/commits/c5841d37a90dd06d4212de214027d56d15995d8c,c5841d37a90dd06d4212de214027d56d15995d8c,Fix NoResultFound error in add_new_imapuid
spang,2014-08-06 01:26:53,https://api.github.com/repos/nylas/sync-engine/git/commits/d1fa630725f931208f384fad8ebcaf2fee4c41fc,d1fa630725f931208f384fad8ebcaf2fee4c41fc,"Remove unused ImapThread method.

Pretty sure this snuck in because I started some code that Karim finished."
spang,2014-08-05 21:22:35,https://api.github.com/repos/nylas/sync-engine/git/commits/244ddc1d5ac7d73c60fae9f5722599bcab733534,244ddc1d5ac7d73c60fae9f5722599bcab733534,Create minimal pools from engine in migrations.
khamidou,2014-08-06 19:03:54,https://api.github.com/repos/nylas/sync-engine/git/commits/2fc2b80764edab56826a11145a1ac658602b1610,2fc2b80764edab56826a11145a1ac658602b1610,"[Sentry] Add git revision to traces + Keep some stack locals

Summary:
Christine, Eben,

I fixed T254 and also created a custom sentry processor to keep the last n locals from the stack trace.

Test Plan: No test plan - can't reach gunks :(

Reviewers: spang, emfree

Reviewed By: emfree

Maniphest Tasks: T254

Differential Revision: https://review.inboxapp.com/D298"
khamidou,2014-08-06 16:30:27,https://api.github.com/repos/nylas/sync-engine/git/commits/d977651fb034e4c2ad9329e7c4bb36347b88d6a0,d977651fb034e4c2ad9329e7c4bb36347b88d6a0,flanker depends on g++
khamidou,2014-08-06 16:29:23,https://api.github.com/repos/nylas/sync-engine/git/commits/fddd236c69a2ef13aebfface92b3129928b70d3a,fddd236c69a2ef13aebfface92b3129928b70d3a,flanker depends on g++
emfree,2014-08-06 05:47:29,https://api.github.com/repos/nylas/sync-engine/git/commits/d0551ef3d9657932228a80a58787037060bc428f,d0551ef3d9657932228a80a58787037060bc428f,"Actually cache blob values in memory.

Previously, by property/setter magic, doing `part.data = value` in message
parsing would write to the data to S3. Then accessing `part.data` in
`message.body` would read it right back. Not ideal.

It seems the original intent was to actually parallelize persisting to disk,
but that code has bitrotted. This is an interim patch, but we should definitely
take another look."
emfree,2014-08-06 04:34:30,https://api.github.com/repos/nylas/sync-engine/git/commits/3733964d81115d3c7eb7c6bf3af49bd46cc8c682,3733964d81115d3c7eb7c6bf3af49bd46cc8c682,"Add logging around db session creation and teardown.

We won't keep this in permanently, but we REALLY want to know exactly how the
connection pool is getting exhausted."
emfree,2014-08-06 04:27:09,https://api.github.com/repos/nylas/sync-engine/git/commits/cf90bb12ee3b81756bd9fa5f450f701fd7dea5aa,cf90bb12ee3b81756bd9fa5f450f701fd7dea5aa,Update bin/clear-db to keep new genericaccount table.
emfree,2014-08-06 02:47:58,https://api.github.com/repos/nylas/sync-engine/git/commits/ecb33eb9ffb95ed15c4e8902655d61a0b9c30a68,ecb33eb9ffb95ed15c4e8902655d61a0b9c30a68,Fix Monocle pretty-date timezoning.
emfree,2014-08-06 01:01:40,https://api.github.com/repos/nylas/sync-engine/git/commits/408811b3bc85fad262a46112c085037faa3a9eb7,408811b3bc85fad262a46112c085037faa3a9eb7,"Update API sync protocol terminology to ""delta protocol."""
emfree,2014-08-06 00:26:59,https://api.github.com/repos/nylas/sync-engine/git/commits/e789b9424999791cc1d40ad8ef6778b26bd5e387,e789b9424999791cc1d40ad8ef6778b26bd5e387,Serialize crispin connection creation to prevent database connection spike.
emfree,2014-08-05 22:33:04,https://api.github.com/repos/nylas/sync-engine/git/commits/f2cd48034d517269877fca15fdc212d03c180f37,f2cd48034d517269877fca15fdc212d03c180f37,"Fix logging call to find app frame and name on odd tracebacks.

Some frames don't have a '__name__' attribute in their f_globals, which breaks
structlog's utility for finding the first application frame when you specify
additional modules to ignore. Fix this.

(todo: submit a PR to structlog for this)"
emfree,2014-08-02 03:05:40,https://api.github.com/repos/nylas/sync-engine/git/commits/2374d21083b94a136dc5a2c7b3a3e09cfd6df14a,2374d21083b94a136dc5a2c7b3a3e09cfd6df14a,"[SCHEMA] Add index on eas_thrid.

For great performance."
emfree,2014-08-05 21:45:20,https://api.github.com/repos/nylas/sync-engine/git/commits/1ba0e07cbe7d6c81e6f038bddb85c0e7182f55cf,1ba0e07cbe7d6c81e6f038bddb85c0e7182f55cf,"Raise slow query threshold, and don't log full stacktrace.

This was generating a huge amount of log spam, much of it likely just from
scheduling contention. We also don't need the full stack trace to figure out
where the call comes from, given that we now log module line and number."
spang,2014-08-05 21:04:14,https://api.github.com/repos/nylas/sync-engine/git/commits/9c7cca1a30259f2db92f2a63c96e2a723d916199,9c7cca1a30259f2db92f2a63c96e2a723d916199,s/Block/Part/
spang,2014-08-05 20:51:15,https://api.github.com/repos/nylas/sync-engine/git/commits/79d2ce7ed0965bf524228abbad869e6b99b0e7f3,79d2ce7ed0965bf524228abbad869e6b99b0e7f3,Don't call Message.calculate_sanitized_body() if decode_error = True.
grinich,2014-08-05 19:01:34,https://api.github.com/repos/nylas/sync-engine/git/commits/6968c9e868c81052a1aeef968414503dfa3ffe21,6968c9e868c81052a1aeef968414503dfa3ffe21,"Merge pull request #70 from rmasters/binary-files-line-endings

Fix git converting line endings in binary files"
rmasters,2014-08-05 18:49:35,https://api.github.com/repos/nylas/sync-engine/git/commits/44c70167c617c08cd3038112e70a688601b3c405,44c70167c617c08cd3038112e70a688601b3c405,Fix git converting line endings in binary files
emfree,2014-08-05 05:21:42,https://api.github.com/repos/nylas/sync-engine/git/commits/2cccb401f83c8c1a0045ca52b5321de878ec9686,2cccb401f83c8c1a0045ca52b5321de878ec9686,"Don't try to take object snapshot on delete revision.

Fixes T253."
emfree,2014-08-05 04:35:45,https://api.github.com/repos/nylas/sync-engine/git/commits/cd36e2ee8c746708b8030e0c708f2a292726d804,cd36e2ee8c746708b8030e0c708f2a292726d804,"Truncate email addresses if necessary.

Fixes T258."
emfree,2014-08-05 04:10:51,https://api.github.com/repos/nylas/sync-engine/git/commits/d648866f6544b6d045f019e3f1f52821562bed81,d648866f6544b6d045f019e3f1f52821562bed81,"Remove custom __repr__ implementations.

They mess up raven/sentry, especially when they don't work with unicode objects."
kav-ya,2014-08-05 02:38:12,https://api.github.com/repos/nylas/sync-engine/git/commits/60bb9430b0a118c86b08d80b0541bfe2f0fa62f0,60bb9430b0a118c86b08d80b0541bfe2f0fa62f0,"[Monocle] s/account sync_state column/row color. Also get rid of separate Enabled? column.

The colors we use for account sync_state are:
Running - no color
Killed - some shade of red
Invalid/Connerror - some shade of orange
Stopped - some shade of yellow"
emfree,2014-08-05 02:00:48,https://api.github.com/repos/nylas/sync-engine/git/commits/0eae3bb9690899ccfacb189f79efd6414bc3a3e6,0eae3bb9690899ccfacb189f79efd6414bc3a3e6,Remove Pygments dependency.
kav-ya,2014-08-05 00:12:51,https://api.github.com/repos/nylas/sync-engine/git/commits/c02d0163b305b21c94084f8592fe822d8e484bf4,c02d0163b305b21c94084f8592fe822d8e484bf4,"Preserve account.sync_state=invalid/connerr when set during pool creation.
Syncs are incorrectly reported as 'stopped' otherwise.

Also get rid of sync_type on Monocle, didn't seem useful."
kav-ya,2014-08-04 22:36:05,https://api.github.com/repos/nylas/sync-engine/git/commits/48ad6b67941e72a8218df731f46085034576e6fb,48ad6b67941e72a8218df731f46085034576e6fb,"[DEPENDENCIES] Remove pygments, not needed in inbox-core."
emfree,2014-08-04 22:13:05,https://api.github.com/repos/nylas/sync-engine/git/commits/648432467695563265230935e3d40d121f857f6d,648432467695563265230935e3d40d121f857f6d,"Read mysql database and user names from config in bin/create-db.

Also add option --prod to disable creating the test database for production
deployments."
emfree,2014-08-04 22:03:24,https://api.github.com/repos/nylas/sync-engine/git/commits/ea84d1cc85e017da933789d46653ad6d815b0c40,ea84d1cc85e017da933789d46653ad6d815b0c40,"Add -p option to setup.sh to skip db configuration.

(Don't want to use the default config when configuring prod machines.)"
kav-ya,2014-08-04 19:48:20,https://api.github.com/repos/nylas/sync-engine/git/commits/cae8a2fe643c54ea88b0f8af81e8ef9cbc300846,cae8a2fe643c54ea88b0f8af81e8ef9cbc300846,Change log level on reconcile_message() logging.
emfree,2014-08-04 18:50:30,https://api.github.com/repos/nylas/sync-engine/git/commits/451112e94959288477b64f9b5aca447cf969a12f,451112e94959288477b64f9b5aca447cf969a12f,"Revert ""[generic_provider] Support for generic providers via configuration file.""

This reverts commit 9aca109e1e55031de16fc06e3281de33b0c1fb5e.

Reason for rollback: Migration doesn't work."
kav-ya,2014-08-04 18:10:01,https://api.github.com/repos/nylas/sync-engine/git/commits/8069304882c6f368fc8ae443ad87da82b440b352,8069304882c6f368fc8ae443ad87da82b440b352,Fix migration order.
emfree,2014-08-04 17:21:17,https://api.github.com/repos/nylas/sync-engine/git/commits/2513885d252deb26e185f6dea84fdd6c14e81d82,2513885d252deb26e185f6dea84fdd6c14e81d82,Fix crispin logging typo.
grinich,2014-08-04 17:21:57,https://api.github.com/repos/nylas/sync-engine/git/commits/4e480a815fa5670025bcaf595826a0c6e2f95004,4e480a815fa5670025bcaf595826a0c6e2f95004,"Merge pull request #68 from mmattioli/minor-updates

Minor improvements to docs and imports"
khamidou,2014-08-04 06:25:20,https://api.github.com/repos/nylas/sync-engine/git/commits/2217f016e86fe9f5eb9ddab64417a0aea527c343,2217f016e86fe9f5eb9ddab64417a0aea527c343,"Strip <title>, <script> and <style> tags from HTML emails.

Summary:  Fixes T162. The code which strips HTML preserves the contents of the tags but it doesn't make sense to keep inline Javascript and CSS.

Test Plan: Ran a full sync. Checked results for HTML emails.

Reviewers: spang

Reviewed By: spang

Maniphest Tasks: T162

Differential Revision: https://review.inboxapp.com/D281"
mmattioli,2014-08-04 03:49:20,https://api.github.com/repos/nylas/sync-engine/git/commits/0c472ef1edda436688fa1f5814a94a9f8fe5b604,0c472ef1edda436688fa1f5814a94a9f8fe5b604,"Minor Improvements

Added missing semicolon to HTML tag

Separated imports in util/misc.py"
emfree,2014-08-04 03:38:11,https://api.github.com/repos/nylas/sync-engine/git/commits/9e20e0d0057a18a29a01c91f2667594c5c670c7b,9e20e0d0057a18a29a01c91f2667594c5c670c7b,Fix indentation error in bin/inbox-sync.
emfree,2014-08-04 03:36:09,https://api.github.com/repos/nylas/sync-engine/git/commits/45386bcfad4c19e05069fa639a9c36bae0757981,45386bcfad4c19e05069fa639a9c36bae0757981,"Save client_id and client_secret on GmailAccount object when applicable.

We need to do this here now that this is the only place where we create the
GmailAccount object."
emfree,2014-08-04 00:13:59,https://api.github.com/repos/nylas/sync-engine/git/commits/6ade42179d0319d142f54b284dbbfbc03886b382,6ade42179d0319d142f54b284dbbfbc03886b382,"Remove stack locals from sentry messages.

It's annoying that we have to do this, but it seems like the quickest way for
now to not have messages dropped."
emfree,2014-08-03 02:28:54,https://api.github.com/repos/nylas/sync-engine/git/commits/391e2a925dbf47b7c92fc71c9fa53769646032bd,391e2a925dbf47b7c92fc71c9fa53769646032bd,Move sentry alerting into function for easier calling from other services.
grinich,2014-08-03 00:38:17,https://api.github.com/repos/nylas/sync-engine/git/commits/8d89199a59d11703d8d1ba3a7b4b5646993b47b9,8d89199a59d11703d8d1ba3a7b4b5646993b47b9,Update readme
emfree,2014-08-02 02:29:55,https://api.github.com/repos/nylas/sync-engine/git/commits/babc0a31153065f7b03876300b2b46391480a9f7,babc0a31153065f7b03876300b2b46391480a9f7,"Move handling of 'unknown' providers.

Needed with D292."
emfree,2014-08-02 18:41:59,https://api.github.com/repos/nylas/sync-engine/git/commits/acd3d809b862da717fa8fed3ef01475e9b5e0b77,acd3d809b862da717fa8fed3ef01475e9b5e0b77,"[DEPENDENCIES] Better validate API query parameters.

Summary:
Use flask-restful's parameter-parsing facility to return meaningful errors when
unexpected or malformed parameters are passed in API requests.

Test Plan: Unit tests.

Reviewers: charles

Reviewed By: charles

Differential Revision: https://review.inboxapp.com/D288"
emfree,2014-08-02 17:56:36,https://api.github.com/repos/nylas/sync-engine/git/commits/c15c96838b2943901be8798e0feaaed6a9ec4bac,c15c96838b2943901be8798e0feaaed6a9ec4bac,Add generic exception retry and reporting logic to top-level SyncService.
spang,2014-08-02 00:55:42,https://api.github.com/repos/nylas/sync-engine/git/commits/f34a900c0467efb6fea44076820a0e5b72529e85,f34a900c0467efb6fea44076820a0e5b72529e85,[DEPENDENCIES] Add missing simplejson dep.
spang,2014-08-02 00:18:04,https://api.github.com/repos/nylas/sync-engine/git/commits/b101e31893cb3d83a0c5bd677070c316e33275c2,b101e31893cb3d83a0c5bd677070c316e33275c2,Fix what looks like a bad merge.
kav-ya,2014-08-01 21:52:20,https://api.github.com/repos/nylas/sync-engine/git/commits/7dce41f19ebeacd603d6901f3f7ea924291057e1,7dce41f19ebeacd603d6901f3f7ea924291057e1,[Monocle] Include provider counts in accounts page.
emfree,2014-08-01 18:20:47,https://api.github.com/repos/nylas/sync-engine/git/commits/34d1f3c2a86f51c1a618cbd272d4c5388c56ed08,34d1f3c2a86f51c1a618cbd272d4c5388c56ed08,"Change syncback_service text fixture scope.

I still really don't understand how exactly gevent and pytest interact, but
this seems to resolve the issue in which later tests using the fixture fail
when the whole suite is run."
khamidou,2014-08-01 17:30:00,https://api.github.com/repos/nylas/sync-engine/git/commits/68ba4654b393d25a9690f0c022afeca12b5d7197,68ba4654b393d25a9690f0c022afeca12b5d7197,"Catch UnpackValueError when loading the Gmail metadata cache

Summary: Fixes T199.

Test Plan: Tested by launching a sync, stopping it midway and manually corrupting the cache.

Reviewers: spang

Reviewed By: spang

Maniphest Tasks: T199

Differential Revision: https://review.inboxapp.com/D289"
kav-ya,2014-08-01 03:46:30,https://api.github.com/repos/nylas/sync-engine/git/commits/18a37aa5b950b590ca0340b4293ba2b54100b1b4,18a37aa5b950b590ca0340b4293ba2b54100b1b4,[Monocle] Close db session after request processing.
bengotow,2014-07-31 23:48:17,https://api.github.com/repos/nylas/sync-engine/git/commits/b6e781571c8973e8be5294d68557e61ce7dbe96a,b6e781571c8973e8be5294d68557e61ce7dbe96a,Moving to latest version of Pygments for Swift code formatting support
emfree,2014-07-31 19:31:53,https://api.github.com/repos/nylas/sync-engine/git/commits/232b20084bd84c78695cc9be3dfe5b0ec8f80252,232b20084bd84c78695cc9be3dfe5b0ec8f80252,"Remove order_by API parameter; always return results most-recent first.

This is the better choice for most applications."
emfree,2014-07-31 22:17:37,https://api.github.com/repos/nylas/sync-engine/git/commits/85d63ebfc6cd5361af7ee5739ca029a7fa195be8,85d63ebfc6cd5361af7ee5739ca029a7fa195be8,"Limit tag queries by namespace_id to improve API performance.

This is a quick way to resolve the most egregious slowness when doing API
queries filtered by a tag. We should however explore doing this more
automatically, e.g. with the association proxy."
kav-ya,2014-07-31 21:15:18,https://api.github.com/repos/nylas/sync-engine/git/commits/642727f4fa6873fd426467f6d4ed7a90ec60818a,642727f4fa6873fd426467f6d4ed7a90ec60818a,"Fixes T236: (AttributeError) 'int' object has no attribute 'lstrip'

IMAPClient's fetch() parses numeric labels into Python ints/longs.
Therefore convert them to unicode strs."
kav-ya,2014-07-30 22:14:23,https://api.github.com/repos/nylas/sync-engine/git/commits/ff2b2510dca24f81a8fd601454d499c8225d8af4,ff2b2510dca24f81a8fd601454d499c8225d8af4,"Configurable resettable_counter.

Summary:
retry_crispin sets max_count=5, reset_interval=150 in the hope
this decreases the number of imaplib abort errors we've been seeing.

We pick 5 because that was the number we'd used with geventconnpool's retry
(i.e. before we switched to our own). 150 is more arbitrary.

Test Plan: Test added to tests/general/test_concurrency.py

Reviewers: spang

Reviewed By: spang

Differential Revision: https://review.inboxapp.com/D286"
kav-ya,2014-07-31 05:02:29,https://api.github.com/repos/nylas/sync-engine/git/commits/f52f5ca481a590d0bad58cae7b042c20dd20f426,f52f5ca481a590d0bad58cae7b042c20dd20f426,Adapt Monocle to run under nginx.
spang,2014-07-30 04:04:32,https://api.github.com/repos/nylas/sync-engine/git/commits/19896b8ffb3ded7d1d74ce59c976d739629b3d49,19896b8ffb3ded7d1d74ce59c976d739629b3d49,"Don't hold database sessions open for long periods during mailsync.

Summary:
This was causing us to create a ridiculous number of database
connections which sat around idle most of the time because the mailsync
code was waiting on network I/O (or simply sleeping).

The codebase still needs further audit, but this improves the situation a lot.

Test Plan: Deploy to Gunks.

Reviewers: kav-ya

Differential Revision: https://review.inboxapp.com/D284"
bengotow,2014-07-31 01:35:35,https://api.github.com/repos/nylas/sync-engine/git/commits/4ab4ea149ebebe60bf8c4f7cb9e64c9b6ee8ff24,4ab4ea149ebebe60bf8c4f7cb9e64c9b6ee8ff24,"Removing webhooks documentation

Webhooks are being significantly refactored as we move to an application-centric model for the Inbox hosted solution. This documentation is deprecated."
spang,2014-07-30 23:11:54,https://api.github.com/repos/nylas/sync-engine/git/commits/c941bacfca23d702bf45ac00da8173ea56a3cfcb,c941bacfca23d702bf45ac00da8173ea56a3cfcb,Decrease db pool max_overflow.
spang,2014-07-30 03:09:25,https://api.github.com/repos/nylas/sync-engine/git/commits/e13723745a06a53e122b5e14cd2aa2ec8834c497,e13723745a06a53e122b5e14cd2aa2ec8834c497,Update outdated comment.
spang,2014-07-30 22:07:50,https://api.github.com/repos/nylas/sync-engine/git/commits/8ea4434147ad3c66c2ceeabe7899465c9e4e9ea7,8ea4434147ad3c66c2ceeabe7899465c9e4e9ea7,Update line endings. (Latest git enforces.)
kav-ya,2014-07-30 21:24:39,https://api.github.com/repos/nylas/sync-engine/git/commits/34125781c38af9aacc33d20117b6c3c6dbb89211,34125781c38af9aacc33d20117b6c3c6dbb89211,"Rename FK in migration 70 - For some reason, Gunks' db has it named differently than ours."
khamidou,2014-07-30 18:32:01,https://api.github.com/repos/nylas/sync-engine/git/commits/6fcc6be18eb9c5d2962759ac85b5b0488e05ba91,6fcc6be18eb9c5d2962759ac85b5b0488e05ba91,"added a small ""getting all the messages in a thread"" section"
kav-ya,2014-07-30 07:21:57,https://api.github.com/repos/nylas/sync-engine/git/commits/880de278b06a04ee3ceefc5736447ff0e292c2ba,880de278b06a04ee3ceefc5736447ff0e292c2ba,"[Monocle]: Include account info (email, provider) in per-account status page."
kav-ya,2014-07-30 06:03:20,https://api.github.com/repos/nylas/sync-engine/git/commits/a20ba0d478af468717bede97bf93f421199dfa19,a20ba0d478af468717bede97bf93f421199dfa19,"Fix SQLAlchemy UnmappedInstanceError on EAS messages w.out. Date, Received headers."
spang,2014-07-30 01:37:53,https://api.github.com/repos/nylas/sync-engine/git/commits/745c5c144c6950f49019683ec6312c6fdc194280,745c5c144c6950f49019683ec6312c6fdc194280,"Always inherit from object.

See https://docs.python.org/2/glossary.html\#term-new-style-class for why."
spang,2014-07-30 01:27:24,https://api.github.com/repos/nylas/sync-engine/git/commits/b575fcd0868485d5b0c92bbfc04d46f92227cca3,b575fcd0868485d5b0c92bbfc04d46f92227cca3,"Explicitly garbage collect ScriptDirectory object in check_db().

For whatever reason, the line `script.get_current_head()` leaves a bunch
of idle db connections lying around until the ScriptDirectory object is
garbage collected. I'm not sure what it's using them all for because
ahhh source diving SQLAlchemy, but it's sure not because we're asking
for a lot of connections in our migration env config. For now, we can
work around by explicitly cleaning them up."
spang,2014-07-30 01:23:19,https://api.github.com/repos/nylas/sync-engine/git/commits/8cba10d172e63b4c15f74ea2f76031f91ac056f9,8cba10d172e63b4c15f74ea2f76031f91ac056f9,"Don't setproctitle in inbox.util.startup.

Scripts should set their proctitle to something unique themselves."
spang,2014-07-30 01:22:10,https://api.github.com/repos/nylas/sync-engine/git/commits/224c75e369640e0e1b908687db7f365677d76eba,224c75e369640e0e1b908687db7f365677d76eba,"Use main_engine() in alembic env setup.

We enforce a few valuable options such as strict mode and the charset
with it, which are valuable to set during migrations as well."
spang,2014-07-29 22:14:49,https://api.github.com/repos/nylas/sync-engine/git/commits/70a12de2f7d0067b3394c5459881e05d4408f554,70a12de2f7d0067b3394c5459881e05d4408f554,"Properly handle SIGTERM in inbox-start.

Now we will shut down child processes upon receipt of SIGTERM, so
running under supervisor continues to work. Supervisor uses SIGTERM for
its 'stop' command.

We remove the use of gipc as well since we're not really intermingling
our usage of gevent and multiprocessing, and it's not clear to me that
gipc is well-maintained."
spang,2014-07-19 03:07:03,https://api.github.com/repos/nylas/sync-engine/git/commits/1c62fec00b71e14ccc3f71cd351b4127b1b5f91e,1c62fec00b71e14ccc3f71cd351b4127b1b5f91e,"[DEPENDENCIES] Basic multicore support for SyncService.

Summary:
We implement super ultra basic multicore support by splitting account
syncs across CPU by (account.id % 4), which does not take into account
system load in any way whatsoever. We can still shard across machines by
changing an account's `sync_host`.

gipc is required in order to prevent multiprocessing from duplicating
parent greenlets into child processes.

My goal here was to retain deployment+development simplicity, hence
choosing to use Python's multiprocessing library rather than a shell
script wrapper or CLI arguments + multiple supervised services.
I had to remove the auto-reloader for mailsync since it doesn't play nice with
gipc.

In the meantime, we also removed SyncService's dependency on ZeroRPC,
and instead do all account actions by polling for changes to the
database. bin/inbox-sync now simply marks the database and returns
immediately instead of waiting on an RPC call. Nothing should be talking
directly to the mail sync process now. Also, each process has its own
connection pool; SQLAlchemy pools are not safe for concurrent access.

Test Plan: manual testing

Reviewers: emfree

Differential Revision: https://review.inboxapp.com/D265"
spang,2014-07-29 20:29:41,https://api.github.com/repos/nylas/sync-engine/git/commits/444f94743ee328a8b194ee96485f1355c2f74bc2,444f94743ee328a8b194ee96485f1355c2f74bc2,"[DEPENDENCIES] Add cssselect package.

Talon uses this for some quote extraction."
kav-ya,2014-07-29 20:15:32,https://api.github.com/repos/nylas/sync-engine/git/commits/0d230bd1552abb6b152ac573a91fa7bff5be5f8c,0d230bd1552abb6b152ac573a91fa7bff5be5f8c,"[Monocle] Display account counts (total, running, stopped, killed, unstarted)."
kav-ya,2014-07-29 17:38:25,https://api.github.com/repos/nylas/sync-engine/git/commits/f6bd8dd1d1657719edf7ba3aee67075e74ae9be0,f6bd8dd1d1657719edf7ba3aee67075e74ae9be0,"[DEPENDENCIES] lxml (for talon).

Also fix import in tests/imap/network/test_actions_syncback.py"
kav-ya,2014-07-29 03:14:17,https://api.github.com/repos/nylas/sync-engine/git/commits/01b36a0fd5163e371cf1bc37ece7bc87d07486b7,01b36a0fd5163e371cf1bc37ece7bc87d07486b7,"[SCHEMA] Fixes T207: EAS Integrity Error

Summary:
EAS folders are uniquely determined by a folder_name and an eas_folder_id.
We pass in the eas_folder_id as the canonical name since Folder.find_or_create()
queries on both name, canonical_name before creating a Folder.

The included migration:
1. Changes the unique constraint on Folder from (account_id, name) to (account_id, name, canonical_name)
2. Adds a unique constraint on EASFolderSyncStatus for the (account_id, eas_folder_id) relation.

Test Plan: Syncs (EAS, other) run as before.

Reviewers: spang

Differential Revision: https://review.inboxapp.com/D275"
spang,2014-07-29 17:15:43,https://api.github.com/repos/nylas/sync-engine/git/commits/fcd375fb5be26d014ab71b72dfd10d63ed782b0d,fcd375fb5be26d014ab71b72dfd10d63ed782b0d,Don't run monocle in debug mode by default.
spang,2014-07-29 05:45:22,https://api.github.com/repos/nylas/sync-engine/git/commits/83f9a396bbab6621a630791698d54caf63454efe,83f9a396bbab6621a630791698d54caf63454efe,"Raise better error when message has no BODY[].

This shouldn't really happen, but we're seeing it on a Hotmail account, so more investigation is warranted."
spang,2014-07-29 02:38:53,https://api.github.com/repos/nylas/sync-engine/git/commits/26be5de97f6d5d443aa8255f190c96296f22cdf7,26be5de97f6d5d443aa8255f190c96296f22cdf7,"[DEPENDENCIES] Integrate exception logging with Sentry.

Summary:
For large deployments, exceptions over email get extremely unwieldy.

This commit also fixes up the email code to use `config.get_required()`
and moves the structlog configuration as far up in inbox/log.py as we
can (it's strange to have code that runs on import way down at the
bottom).

There is some known weirdness with integrating raven's logger with structlog
(see for example https://github.com/getsentry/raven-python/issues/377), but
we can look more into weeding out extra errors later---let's first see what
things look like in practice with Sentry's default verbose logging.

We may also want to hook into the logging infrastructure directly later and
report on more errors than just mailsync uncaught exceptions.

Test Plan: Manual triggering of exceptions.

Reviewers: kav-ya

Reviewed By: kav-ya

Differential Revision: https://review.inboxapp.com/D273"
grinich,2014-07-28 22:56:09,https://api.github.com/repos/nylas/sync-engine/git/commits/82817c7349ba1ca65b29d8839105ad03cf9ed2f7,82817c7349ba1ca65b29d8839105ad03cf9ed2f7,[typo] thread -> threads
grinich,2014-07-23 09:37:31,https://api.github.com/repos/nylas/sync-engine/git/commits/5c593f312c5d5d8f763627a039023c153d7d0b38,5c593f312c5d5d8f763627a039023c153d7d0b38,typo
grinich,2014-07-24 18:46:43,https://api.github.com/repos/nylas/sync-engine/git/commits/8b11195debbb48f0fb2372c487dd5260e71422cd,8b11195debbb48f0fb2372c487dd5260e71422cd,"Enforce LF line endings project-wide

Closes Issue #9"
grinich,2014-07-24 21:30:21,https://api.github.com/repos/nylas/sync-engine/git/commits/4dea8c14bedbc4db87fdb082ccdeff0fbc6e9bc2,4dea8c14bedbc4db87fdb082ccdeff0fbc6e9bc2,[Typo] inboxapp -> talon for repo
grinich,2014-07-24 21:29:29,https://api.github.com/repos/nylas/sync-engine/git/commits/468909ca7fd21beaea163f5ead6dc0132ebb45d1,468909ca7fd21beaea163f5ead6dc0132ebb45d1,"Install Talon directly from Mailgun's GitHub repo

Their pip install flow is currently failing.

See https://github.com/mailgun/talon/issues/1"
grinich,2014-07-24 21:18:15,https://api.github.com/repos/nylas/sync-engine/git/commits/f07b054a559e4fb808a155cbf4490546d96c94fd,f07b054a559e4fb808a155cbf4490546d96c94fd,"Add Talon dependency now that Mailgun has open sourced it!

http://blog.mailgun.com/open-sourcing-our-email-signature-parsing-library/"
kav-ya,2014-07-25 18:06:20,https://api.github.com/repos/nylas/sync-engine/git/commits/86a676171484040f0a2b7b3c39ec53de653c2fc0,86a676171484040f0a2b7b3c39ec53de653c2fc0,Remove unused ports from Vagrantfile
emfree,2014-07-26 05:41:59,https://api.github.com/repos/nylas/sync-engine/git/commits/c8b57e356ddc27ee839e980ea1d673cdd08cf7a5,c8b57e356ddc27ee839e980ea1d673cdd08cf7a5,"Handle RequestError in contacts sync.

People will inevitably not enable the google contacts API, and we should really
handle that exception. Just logging an error seems like the way to go for now."
nylasbot,2014-07-26 01:41:40,https://api.github.com/repos/nylas/sync-engine/git/commits/a36b1c3d44e91edf992e7112c47fb5b02a0fd5ef,a36b1c3d44e91edf992e7112c47fb5b02a0fd5ef,"Monkey-patch bson's JSON decoder to not include timezone info.

This isn't necessarily a future-proof solution, but does mean that we
don't have to add tzinfo all over the place. All oru datetimes are UTC
anyways."
kav-ya,2014-07-26 01:43:02,https://api.github.com/repos/nylas/sync-engine/git/commits/4c41e22af67952b9ddb887056b7917f5d8561341,4c41e22af67952b9ddb887056b7917f5d8561341,s/@mit.edu/@exchange.mit.edu
emfree,2014-07-26 00:52:20,https://api.github.com/repos/nylas/sync-engine/git/commits/0d03955fc9cdbfae78a76fe6524898460de2b680,0d03955fc9cdbfae78a76fe6524898460de2b680,"Don't put account id in exception email subject.

Allows gmail to thread those emails more reasonably."
emfree,2014-07-26 00:38:23,https://api.github.com/repos/nylas/sync-engine/git/commits/d6912bae770658c0e8e29300207a3f58a62c8e03,d6912bae770658c0e8e29300207a3f58a62c8e03,"Catch UnicodeDecodeErrors in slow query logging.

Just an interim fix to keep this from breaking stuff while we investigate the
underlying issue."
emfree,2014-07-26 00:26:53,https://api.github.com/repos/nylas/sync-engine/git/commits/d77c647874f6cb05fe44471d19f6c498ae9a1d2f,d77c647874f6cb05fe44471d19f6c498ae9a1d2f,"Schedule draft-deletion-syncback as a separate action from sending.

This prevents us from potentially re-sending a message if the drafts-syncback
call fails for some separate reason."
emfree,2014-07-25 23:55:56,https://api.github.com/repos/nylas/sync-engine/git/commits/fad9b20c98c083af61e0cb5abca8233c15a83f05,fad9b20c98c083af61e0cb5abca8233c15a83f05,"Return more attachment information in API message representation.

Test Plan: curl http://localhost/n/<ns_id>/messages/<id of message with attachment>

Reviewers: charles

Subscribers: mg, bengotow

Differential Revision: https://review.inboxapp.com/D268"
emfree,2014-07-25 23:43:22,https://api.github.com/repos/nylas/sync-engine/git/commits/cb497cfd3258a794cd4de0ddf1a7d504ad0d5750,cb497cfd3258a794cd4de0ddf1a7d504ad0d5750,"Support 'filename' and 'message' parameters on /files queries.

This is a preliminary commit, which doesn't properly return files that are
Blocks but not Parts. Could also use some unit tests."
nylasbot,2014-07-25 22:43:43,https://api.github.com/repos/nylas/sync-engine/git/commits/460658f592bb8b7922627a62a8dd4c83b7031fd8,460658f592bb8b7922627a62a8dd4c83b7031fd8,"Reduce writable connection pool size to 1 for now.

We were still getting 'too many simultaneous connection' errors...

Also add a bit of logging."
emfree,2014-07-25 21:43:52,https://api.github.com/repos/nylas/sync-engine/git/commits/3c899f2bbcaf7b3a8f8ffe47f51eef8870a9d1b9,3c899f2bbcaf7b3a8f8ffe47f51eef8870a9d1b9,"Prevent concurrent creation of duplicate connection pools.

Did you think that because a gevented process is basically still
single-threaded, it's free of your normal concurrency woes? Well, not so much.
Consider the following test case:

---
import random
from gevent import monkey; monkey.patch_all()
import gevent

def maybe_update_shared_dict(k, v, d={}, final=False):
    if d.get(k) is None:
        gevent.sleep()
        d[k] = v
    return d.get(k)

def test():
    print maybe_update_shared_dict('a', random.randint(0, 22))

threads = [gevent.spawn(test) for _ in range(10)]
gevent.joinall(threads)
---

Only the first call to maybe_update_shared_dict should store a value in the
dictionary d, and all the other greenlets should read it. But that's not
actually what happens, because concurrency.

This is basically what we were doing when creating IMAP connection pools. This
is an issue if you start the syncback service and it tries to execute a bunch
of actions for the same account at once -- you end up creating a bunch of
connection pools. Add per-account locks to prevent this."
emfree,2014-07-25 20:55:59,https://api.github.com/repos/nylas/sync-engine/git/commits/e328d27820043ee687c712201c32373846b37c4f,e328d27820043ee687c712201c32373846b37c4f,"Reduce writable IMAP connection pool size.

We don't really need 4 simultaneous writable connections. Maybe we don't even
need 2. This reduces the likelihood that we hit the simultaneous-connection
limit."
kav-ya,2014-07-25 18:06:20,https://api.github.com/repos/nylas/sync-engine/git/commits/1526026f593db353214a904b1e614130797d6825,1526026f593db353214a904b1e614130797d6825,Remove unused ports from Vagrantfile
kav-ya,2014-07-25 16:34:22,https://api.github.com/repos/nylas/sync-engine/git/commits/8156770534cf592842b5b8219a549e78818762cf,8156770534cf592842b5b8219a549e78818762cf,Propogate sync_state='killed' to account sync if all its folder syncs have been killed.
kav-ya,2014-07-25 03:47:37,https://api.github.com/repos/nylas/sync-engine/git/commits/34da8e52b1eb9754be245703ec9538c284011fa5,34da8e52b1eb9754be245703ec9538c284011fa5,"Post-review push for 'Fixes T201: Drafts API should support ?thread=filter.'
Also, tests/general/test_mutable_json_type passes again."
kav-ya,2014-07-25 03:45:30,https://api.github.com/repos/nylas/sync-engine/git/commits/21a9f9f9a584fd1c46f5df60bd1e727d6551fd08,21a9f9f9a584fd1c46f5df60bd1e727d6551fd08,"Revert ""Fixes  T201: Drafts API should support ?thread=filter.""
This reverts commit cfa8cb8935544229c9f923ecece8b95b0f145731."
kav-ya,2014-07-25 03:26:43,https://api.github.com/repos/nylas/sync-engine/git/commits/cfa8cb8935544229c9f923ecece8b95b0f145731,cfa8cb8935544229c9f923ecece8b95b0f145731,"Fixes  T201: Drafts API should support ?thread=filter.

Summary:
get_drafts() method added to inbox/api/filtering.Filter
draft_query_api() added to inbox/api/ns_api.py

Test Plan: Added test in tests/api/test_drafts.py

Reviewers: emfree

Differential Revision: https://review.inboxapp.com/D266"
kav-ya,2014-07-24 22:15:27,https://api.github.com/repos/nylas/sync-engine/git/commits/6f1b592a9b1ebd702ea29e63c313349303b58cc4,6f1b592a9b1ebd702ea29e63c313349303b58cc4,Fixes T191: Flanker DecodeError in EAS
grinich,2014-07-24 21:30:21,https://api.github.com/repos/nylas/sync-engine/git/commits/1289063e20944fae725f77cc6ea9c986371985aa,1289063e20944fae725f77cc6ea9c986371985aa,[Typo] inboxapp -> talon for repo
grinich,2014-07-24 21:29:29,https://api.github.com/repos/nylas/sync-engine/git/commits/67fc6b13a10e613dd1d2b2b52e8aca858e689287,67fc6b13a10e613dd1d2b2b52e8aca858e689287,"Install Talon directly from Mailgun's GitHub repo

Their pip install flow is currently failing.

See https://github.com/mailgun/talon/issues/1"
kav-ya,2014-07-24 21:20:49,https://api.github.com/repos/nylas/sync-engine/git/commits/4c2d6d25bed5f257249314921683d8ab9fb8a649,4c2d6d25bed5f257249314921683d8ab9fb8a649,"[Monocle]
Fully reset sync status on restarting foldersyncs.
Sync type (new/resumed) on account, rather than folder."
grinich,2014-07-24 21:18:15,https://api.github.com/repos/nylas/sync-engine/git/commits/b270129dca3d33f3450a2441b3abbff2675f563b,b270129dca3d33f3450a2441b3abbff2675f563b,"Add Talon dependency now that Mailgun has open sourced it!

http://blog.mailgun.com/open-sourcing-our-email-signature-parsing-library/"
grinich,2014-07-24 18:46:43,https://api.github.com/repos/nylas/sync-engine/git/commits/3a6c0910280dfe4b8f6ba4714681a13364743ad8,3a6c0910280dfe4b8f6ba4714681a13364743ad8,"Enforce LF line endings project-wide

Closes Issue #9"
khamidou,2014-07-24 11:03:17,https://api.github.com/repos/nylas/sync-engine/git/commits/456cf6b1e963cc584ca1d9861ca979e936c0ce7c,456cf6b1e963cc584ca1d9861ca979e936c0ce7c,"Add support for yahoo syncback actions

Summary:
Implemented all actions - needs review.

Christine, could you take a quick look at the code and tell me if it's okay?
I'd like to have your opinion on this specific things:

1. I'm not sure I'm doing the ORM requests the right way. There's probably something
   more efficient than loading all the fields from the db.

2. I'm a bit wary about the race condition we get when deleting a draft which is not yet
   reconciled. I'm open to suggestions about how to handle this.

fixed rebase bug

code for review

rebased latests changes + fixed rebasing bugs

ignore soft deletes - fixes draft deletion bug

draft deletion and reconciliation

refactor - moved draft deletion code from YahooCrispinClient to CrispinClient - ... we won't need it for yahoo because their servers don't support querying a specific header

Test Plan: manual testing, interacting with the REST API using curl.

Reviewers: spang

Reviewed By: spang

Subscribers: kav-ya

Differential Revision: https://review.inboxapp.com/D257"
kav-ya,2014-07-23 22:24:39,https://api.github.com/repos/nylas/sync-engine/git/commits/9c80e7f8bd8364ec14c3cb8edf50737e98371632,9c80e7f8bd8364ec14c3cb8edf50737e98371632,"Potentially fix T197, T194.

Summary:
T197 was due to yesterday's ""fix"" to T194.
Therefore revert it (i.e. remove the db_session.add(folder) in create_db_objects();
if no new_uids were added, there is no db_commit() before the save_folder_names() which
will try to create the same folder raising the error in T197).

This didn't really fix T194 anyway so it's not a huge loss.

So, take two at fixing T194:
Folder.create() adds the created Folder to the session;
there is some weirdness about association proxy + backref
(See: https://groups.google.com/forum/#!topic/sqlalchemy/6RV6ay3rwIs).
In particular, I'm not sure how autoflush behaves in this case when
the folder the FolderItem is instantiated with may not have been
explicitly added to the session.

As before, not certain this is a guaranteed fix but:
1. I'd like to test it against mg's failing accounts on Gunks.
2. I won't mark anything as resolved till we see it is.
3. It may work.

Test Plan: Sync on inboxapptest runs.

Reviewers: emfree

Reviewed By: emfree

Maniphest Tasks: T194

Differential Revision: https://review.inboxapp.com/D264"
khamidou,2014-07-23 11:26:16,https://api.github.com/repos/nylas/sync-engine/git/commits/e8cbced8d9d7b689cbbe292319eb2a3c90448f6d,e8cbced8d9d7b689cbbe292319eb2a3c90448f6d,"Moved from pyflakes and pep8 to flake8

Summary: flake8 has some desirable features like annotations to deactivate unneeded warnings.

Test Plan: check if linting still works (it does)

Reviewers: spang, emfree

Reviewed By: emfree

Differential Revision: https://review.inboxapp.com/D258"
grinich,2014-07-23 09:37:31,https://api.github.com/repos/nylas/sync-engine/git/commits/7d1576e0e6ffe3a6f276f9be05ff2287ad8367c9,7d1576e0e6ffe3a6f276f9be05ff2287ad8367c9,typo
emfree,2014-07-23 00:51:36,https://api.github.com/repos/nylas/sync-engine/git/commits/24f038c8dceea325e13d8b2462827575766e1b01,24f038c8dceea325e13d8b2462827575766e1b01,"Add a script to run the syncback service independently.

We need this if the API is deployed other than via the bin/inbox-api script."
kav-ya,2014-07-22 23:16:44,https://api.github.com/repos/nylas/sync-engine/git/commits/923e553d9faff4329ff3d63a14d7415b708d6ba4,923e553d9faff4329ff3d63a14d7415b708d6ba4,"Fixes T194: IntegrityError (1452) FolderItem.folder_id -> Folder.id Foreign Key Constraint Fails.

Summary:
Here's what I think the issue is:

We create a new Folder (line 118, mailsync.base.create_db_objects()) but do not add it to the session.
The corresponding FolderItems are created in line 680, mailsync.gmail.add_gmail_attrs() with autoflush disabled.
Then in contacts.process_mail.update_contacts(), we call get_contact_objects();
the db_session.query(Contact).filter(…).all() in this function triggers an autoflush and causes
the IntegrityError (1452): foreign key constraint fails for FolderItem.folder_id -> Folder.id because the FolderItems are in the session but the Folder
is not.

To fix this:
Added the Folder to the session in mailsync.base.create_db_objects()

Note:
I am not certain that this is the issue, I could not repro it to test the fix - hence, the request for review.

Test Plan: Sync runs as before.

Reviewers: emfree

Reviewed By: emfree

Differential Revision: https://review.inboxapp.com/D263"
emfree,2014-07-23 00:51:36,https://api.github.com/repos/nylas/sync-engine/git/commits/48858267647a71da63e665adb7709713999249d8,48858267647a71da63e665adb7709713999249d8,"Fix assorted drafts/sending bugs.

* Keep track in memory of which syncback actions have been scheduled but not
  completed, so that we don't try to schedule them twice.
* Remove `message.is_draft` assertion from inbox.actions.delete_draft. This was
  failing when we sent a message, then tried to delete the draft-that-it-was.
* Return instead of raising an AssertionError if we try to send a message that
  isn't a draft or is already sent.
* Distinguish between creating a draft and syncing it to the backend,
  and creating a draft only to send it immediately (in the /send API).
* When constructing the In-Reply-To and References headers on a message, don't
  the previous message's Message-Id and References headers may be null. In this
  case, gracefully degrade instead of failing with a TypeError."
emfree,2014-07-22 23:17:34,https://api.github.com/repos/nylas/sync-engine/git/commits/6ae1d591a03b31855d14d538c3531bedfa692e08,6ae1d591a03b31855d14d538c3531bedfa692e08,"[SCHEMA] Set executed status on action log entries.

Summary:
This is a prerequisite to running the syncback service as an actual standalone
service: we can stop and restart it and not need to worry about losing actions.

Test Plan: Unit tests updated.

Reviewers: kav-ya

Reviewed By: kav-ya

Differential Revision: https://review.inboxapp.com/D259"
emfree,2014-07-22 06:07:44,https://api.github.com/repos/nylas/sync-engine/git/commits/7b84596cbd68dd78775bd944b7c1d0c855820f75,7b84596cbd68dd78775bd944b7c1d0c855820f75,Update test db dump to not include message.created_date.
emfree,2014-07-22 05:49:00,https://api.github.com/repos/nylas/sync-engine/git/commits/4cafd78d73ce9b86597f5ef8d1d70bc644cce5cd,4cafd78d73ce9b86597f5ef8d1d70bc644cce5cd,"Don't copy created_date in migration 066.

Not using that field anymore."
emfree,2014-07-22 02:12:05,https://api.github.com/repos/nylas/sync-engine/git/commits/7baa82032efb8be8b5b4661421b4ca9bff7bf879,7baa82032efb8be8b5b4661421b4ca9bff7bf879,Clarify phrasing in API filtering documentation.
kav-ya,2014-07-22 01:52:52,https://api.github.com/repos/nylas/sync-engine/git/commits/9cb21e75172ea35ba95d5c218538c1456586ddf1,9cb21e75172ea35ba95d5c218538c1456586ddf1,Fixes T185: Column extra_flags cannot be null
kav-ya,2014-07-21 23:22:47,https://api.github.com/repos/nylas/sync-engine/git/commits/a113ab129836decdef7e8c23ad4c8121a879702c,a113ab129836decdef7e8c23ad4c8121a879702c,"[SCHEMA] Fixes T163: Drafts synced from remote can't be updated/sent via API

Summary:
Kill SpoolMessage, the Message table stores the extra info needed for Inbox-created, synced back drafts.

Also fixes a few minor drafts related bugs.

Test Plan: None (regression tested)

Reviewers: emfree

Reviewed By: emfree

Differential Revision: https://review.inboxapp.com/D255"
spang,2014-07-21 19:22:31,https://api.github.com/repos/nylas/sync-engine/git/commits/33a09be242397fd6f3a645776ee1d8e9b8b61ba5,33a09be242397fd6f3a645776ee1d8e9b8b61ba5,Fix index name collision in migration 056.
emfree,2014-07-20 03:21:50,https://api.github.com/repos/nylas/sync-engine/git/commits/9890688374d300918b5beeae147d81c2da12e8d4,9890688374d300918b5beeae147d81c2da12e8d4,Add an index to the transaction table to speed up client sync.
emfree,2014-07-16 02:46:29,https://api.github.com/repos/nylas/sync-engine/git/commits/83ccd26b9615dfdc5a196d73079c0867132d8241,83ccd26b9615dfdc5a196d73079c0867132d8241,Implement a safer_yield_per utility to avoid OOM issues and slowness.
emfree,2014-07-20 01:54:41,https://api.github.com/repos/nylas/sync-engine/git/commits/a882e0b1ff09c6b2f4f2038db19ba6e3e5d1a998,a882e0b1ff09c6b2f4f2038db19ba6e3e5d1a998,"Log to stdout, not stderr.

This lets us separate our own logs from other stuff, like boto logs and
un-truncated tracebacks."
emfree,2014-07-20 01:06:54,https://api.github.com/repos/nylas/sync-engine/git/commits/4266be96ed9b439772d11bf072dced43844e0be3,4266be96ed9b439772d11bf072dced43844e0be3,"More safely format large exception messages.

The immediate reason for this is that SQLAlchemy may return an excessively
large error message if, say the MySQL server goes away because you're trying to
insert a large object. Trying to log the entire 25MB insert statement is not
that helpful, and breaks various things."
spang,2014-07-19 22:45:51,https://api.github.com/repos/nylas/sync-engine/git/commits/d031e1b8a0af566f541c3e393d1338a5025212bf,d031e1b8a0af566f541c3e393d1338a5025212bf,Remove unused import in inbox/crispin.py.
spang,2014-07-19 22:24:24,https://api.github.com/repos/nylas/sync-engine/git/commits/2a7d6bccf86df1f7f677e9ac0e0012f1d41b2cf6,2a7d6bccf86df1f7f677e9ac0e0012f1d41b2cf6,"Fix bug in g_msgids() affecting Gmail message deduplication.

We occasionally were failing to deduplicate message object creation or
download because we wrongly excluded messages which currently had no
associated ImapUids. (This is actually a common situation, as when a
message moves we might well delete the old ImapUid before creating the
new one.)

Fixes T180."
emfree,2014-07-19 22:30:57,https://api.github.com/repos/nylas/sync-engine/git/commits/e0d6e3194069a437591f9445ad13eeb0ddc7110b,e0d6e3194069a437591f9445ad13eeb0ddc7110b,"Fix sending error when subject parameter is unset.

If we're sending a reply to a thread and there's no subject given, use the
thread's subject; otherwise use the empty string. Fixes TypeError in gmail
sending code."
spang,2014-07-19 21:50:06,https://api.github.com/repos/nylas/sync-engine/git/commits/97902bb85487a582bcb1a5bc7c5184a7b728d1a4,97902bb85487a582bcb1a5bc7c5184a7b728d1a4,Fix bug in migration 064.
emfree,2014-07-19 21:42:58,https://api.github.com/repos/nylas/sync-engine/git/commits/3b4fe9cdc12281530d7eedf0a5cce530c5637dc5,3b4fe9cdc12281530d7eedf0a5cce530c5637dc5,"Make slow query logging more structured.

Also add support for log.exception, which may be called by gunicorn."
kav-ya,2014-07-19 10:03:56,https://api.github.com/repos/nylas/sync-engine/git/commits/14b00991284aed5c3a42a63ad9b3a227343ec355,14b00991284aed5c3a42a63ad9b3a227343ec355,Fix previous migration down_revision ID.
emfree,2014-07-17 22:01:46,https://api.github.com/repos/nylas/sync-engine/git/commits/257218d6c3b5ba90aa3bb9b5f603aea7b5a30273,257218d6c3b5ba90aa3bb9b5f603aea7b5a30273,"[SCHEMA] Make Message.*_addr non-null to prevent TypeErrors.

In Thread.participants, we assume that these attributes are iterable, but they
may not be set at all in case of decoding error. It's generally safer to have
them maybe be the empty list, but never null.

Fixes T181."
spang,2014-07-19 04:44:24,https://api.github.com/repos/nylas/sync-engine/git/commits/f07abd3bdd931f87651b22f7eaf7f76a288b2dd4,f07abd3bdd931f87651b22f7eaf7f76a288b2dd4,Don't retry on DataError and IntegrityError.
spang,2014-07-19 04:31:38,https://api.github.com/repos/nylas/sync-engine/git/commits/4e265cb8832b0d4cb679ecf04086e78ce6bb1e85,4e265cb8832b0d4cb679ecf04086e78ce6bb1e85,"[SCHEMA] Drop part.misc_keyval column.

We have no plans to use this data, and a lack of logic for truncation is
causing some messages to break syncs.

Fixes T177."
spang,2014-07-19 03:56:09,https://api.github.com/repos/nylas/sync-engine/git/commits/40f53cc4a666d87fac4aa18e5b83d55192f42101,40f53cc4a666d87fac4aa18e5b83d55192f42101,Migration 061 should delete RecipientInfo rows for all accounts.
kav-ya,2014-07-19 03:16:45,https://api.github.com/repos/nylas/sync-engine/git/commits/9660cace5a090dcc70c95a8bdc184e50f719790b,9660cace5a090dcc70c95a8bdc184e50f719790b,For real.
kav-ya,2014-07-19 03:15:35,https://api.github.com/repos/nylas/sync-engine/git/commits/09427819f98e340f06e88e15b845c8fbba52d46c,09427819f98e340f06e88e15b845c8fbba52d46c,[SCHEMA] Rename migration.
kav-ya,2014-07-19 03:10:01,https://api.github.com/repos/nylas/sync-engine/git/commits/d5a0b5ba9446439e602864fe003664e97a1f3a44,d5a0b5ba9446439e602864fe003664e97a1f3a44,[Monocle] Filter accounts by provider + state (v1)
spang,2014-07-19 03:10:59,https://api.github.com/repos/nylas/sync-engine/git/commits/69c52c5a614bcb526121c54a6e6b65d93577ae7e,69c52c5a614bcb526121c54a6e6b65d93577ae7e,[DEPENDENCIES] Update to latest click.
spang,2014-07-19 03:08:18,https://api.github.com/repos/nylas/sync-engine/git/commits/33b7e9ced106150a55c7b202bd5a150df80b535f,33b7e9ced106150a55c7b202bd5a150df80b535f,"Port bin/inbox-* to click.

Summary:
We're already using this library elsewhere, and it's a lot cleaner to
use than argparse. I did some consistency tidying as well.

This is a precursor to modifying bin/inbox-start for multicore support.

Test Plan: ./runtests, manual verification that scripts start as expected

Reviewers: emfree

Reviewed By: emfree

Differential Revision: https://review.inboxapp.com/D254"
kav-ya,2014-07-19 03:08:30,https://api.github.com/repos/nylas/sync-engine/git/commits/a516e4d6bcff74c0100a2cf14a6a20e16bd92fca,a516e4d6bcff74c0100a2cf14a6a20e16bd92fca,Add a try/except to  migration 061.
kav-ya,2014-07-19 02:10:02,https://api.github.com/repos/nylas/sync-engine/git/commits/179ffd8c5b7cea783cc939e7cbba230d3fb77d21,179ffd8c5b7cea783cc939e7cbba230d3fb77d21,"[SCHEMA] Fixes T171: Data too long for column message_id_header

We up the max column length to 998 in accordance with http://tools.ietf.org/html/rfc4130 (section 5.3.3)
(We can't truncate this header because it is used to populate the In-Reply-To header on
messages we send)."
kav-ya,2014-07-19 01:32:20,https://api.github.com/repos/nylas/sync-engine/git/commits/932a32453e8abb72ef2f958a0c03e89897bdb9c4,932a32453e8abb72ef2f958a0c03e89897bdb9c4,[SCHEMA] Migration to remove EASFolderSyncStatus + Folder rows we never sync.
kav-ya,2014-07-19 01:31:56,https://api.github.com/repos/nylas/sync-engine/git/commits/143035168f6a8ff924aaf14c025b7c1fb82456e2,143035168f6a8ff924aaf14c025b7c1fb82456e2,[SCHEMA] Migration to cascade Folder deletes to EASUid
emfree,2014-07-19 00:46:09,https://api.github.com/repos/nylas/sync-engine/git/commits/2a9956aae9100b04e87c9bb373e7ff1370a0d04b,2a9956aae9100b04e87c9bb373e7ff1370a0d04b,"[SCHEMA] Explicitly schedule syncback actions, instead of using the transaction log.

Summary:
Fixes T167, by removing the offending code altogether.

Instead of inferring syncback actions to execute from the generic transaction
log, explicitly store them in the new ActionLog table. This provides the
following benefits:

 * It's easier to ensure that syncback actions are executed when they should
   be. For example, if a user marks a single message as read via the API, we
   want to sync that back. But if we change a message's read status in
   mailsync, we don't want to schedule a syncback action. It's currently
   impossible to distinguish those two scenarios just by interpreting the
   transaction log. Similarly, we had to clunkily distinguish between tags that
   were set via the API and tags that were set from mailsync.

 * The SyncbackService doesn't need to process the *entire* transaction log.

Test Plan: Unit tests, and manually san-checking syncback actions.

Reviewers: kav-ya

Reviewed By: kav-ya

Subscribers: spang

Maniphest Tasks: T167

Differential Revision: https://review.inboxapp.com/D248"
spang,2014-07-18 22:49:14,https://api.github.com/repos/nylas/sync-engine/git/commits/b75e6910a0dd4dcced3fe8130b76ce3794ce8f08,b75e6910a0dd4dcced3fe8130b76ce3794ce8f08,Make sure to commit final objects in migration 057.
nylasbot,2014-07-18 22:43:55,https://api.github.com/repos/nylas/sync-engine/git/commits/ee5b96a51df54afa04e7eb5d6d179f14ceaa2887,ee5b96a51df54afa04e7eb5d6d179f14ceaa2887,Fix alembic revision branch.
spang,2014-07-18 22:39:06,https://api.github.com/repos/nylas/sync-engine/git/commits/5fa7ace255940277c27f1034ee2e03e72c2ab83d,5fa7ace255940277c27f1034ee2e03e72c2ab83d,"[SCHEMA] Truncate message subjects to 255 characters.

Fixes DataErrors caused by subjects that overflow the size of MySQL's TEXT."
kav-ya,2014-07-18 02:51:30,https://api.github.com/repos/nylas/sync-engine/git/commits/00aeffa9841964d9089c0547507f769698f0b03b,00aeffa9841964d9089c0547507f769698f0b03b,"Fixes T138 and then some:
Include account_id in exceptions email,
Include errors in Monocle.

Summary:
To include account_id in the exceptions email, we simply use an extra account_id param;
I did some quick, prelim digging into directly using the account_id that the logger is initialized with
(through the event_dict passed to the structlog processors) but that seemed unnecessarily complicated.

The changes to include errors in Monocle should be more obvious;
we currently store the error in the database table itself because that's where Monocle pulls its data from but eventually,
we should move to a different approach.
Note that this rev includes a migration to change how we store sync_status info in models.account (switched to using a single JSON column)

Test Plan:
Visual app inspection.
Sync runs as before.

Reviewers: emfree

Reviewed By: emfree

Subscribers: spang

Maniphest Tasks: T138

Differential Revision: https://review.inboxapp.com/D249"
spang,2014-07-18 21:30:18,https://api.github.com/repos/nylas/sync-engine/git/commits/2180d021da7b31adcce1c27958d4976e6495d3ed,2180d021da7b31adcce1c27958d4976e6495d3ed,Fix argument ordering in migraton 056.
spang,2014-07-18 21:30:18,https://api.github.com/repos/nylas/sync-engine/git/commits/84026450863cf78d2904c26ca0de4406f7349770,84026450863cf78d2904c26ca0de4406f7349770,Fix argument ordering in migraton 056.
spang,2014-07-18 21:27:24,https://api.github.com/repos/nylas/sync-engine/git/commits/91b2631123394a3f69d539b8eea445df5bfeadd6,91b2631123394a3f69d539b8eea445df5bfeadd6,Fix database session bug which results in creation of multiple Thread objects on Gmail.
spang,2014-07-18 21:19:49,https://api.github.com/repos/nylas/sync-engine/git/commits/c7de6e3a2ba67e1a06fe75720a86532f86b0920e,c7de6e3a2ba67e1a06fe75720a86532f86b0920e,Fix up a comment and log error.
spang,2014-07-17 23:35:48,https://api.github.com/repos/nylas/sync-engine/git/commits/68ff65afd4906da283ca0c5c45a9977d9d3f5dc1,68ff65afd4906da283ca0c5c45a9977d9d3f5dc1,"[SCHEMA] Remove duplicate Gmail message data and tighten constraints.

Some bugs caused Message objects to occasionally be duplicated for Gmail
accounts. I'm not 100% sure we've eradicated them all, but tightening
the constraints on the table will make it easier to make sure.

Note that MySQL does not apply unique constraints against rows on which
some of the columns to constraint are NULL, so this does not affect
non-Gmail accounts (which do not have a g_msgid)."
khamidou,2014-07-18 11:45:56,https://api.github.com/repos/nylas/sync-engine/git/commits/5d5ed13f41598005ead556acc632a1261a4fc617,5d5ed13f41598005ead556acc632a1261a4fc617,"Periodically refresh IMAP flags for those servers that don't support CONDSTORE

Summary:
Christine,

I integrated the changes we talked about yesterday. Here's what I think you should take a look at first:

- I've decided to spawn a new greenlet to update IMAP flags during a full sync. I thought it would be cleaner this way (imap.py:561). To do this I defined a new function ""imap_check_flags"" which was largely copy-pasted from another one. Tell me if you think there's stuff which should be abstracted away.

- IMAP updates are limited to the highest ""refresh_flags_max"" UIDs (2000 by default, but this is a constructor parameter). I must say I haven't found a better variable name so I'm open to suggestions.

Test Plan: Ran a smoke test. Triggered a full sync and paused the program with a debugger. Checked that the fields where updated in the db.

Reviewers: spang

Reviewed By: spang

Differential Revision: https://review.inboxapp.com/D241"
emfree,2014-07-18 02:50:49,https://api.github.com/repos/nylas/sync-engine/git/commits/da5f95da982e2aeb7a8cae86b4276aece7c7158c,da5f95da982e2aeb7a8cae86b4276aece7c7158c,"Order API responses most-recent-first when order_by=date.

Not least-recent-first. Dammit."
emfree,2014-07-17 22:05:18,https://api.github.com/repos/nylas/sync-engine/git/commits/a072c7d9ae80b06af2bbbb195933098baad3d791,a072c7d9ae80b06af2bbbb195933098baad3d791,Fix migration 053 when email addresses or non-null but not parseable.
bengotow,2014-07-17 23:41:02,https://api.github.com/repos/nylas/sync-engine/git/commits/97d4d72c5f5e8f6ab7fcb636c82015353b98eea6,97d4d72c5f5e8f6ab7fcb636c82015353b98eea6,"Updating documentation based on Layer meeting feedback

Summary: Only modifies docs

Test Plan: Read over docs and provide feedback

Reviewers: spang

Differential Revision: https://review.inboxapp.com/D242

Conflicts:
	inbox/docs/api/05_tags.mdown"
spang,2014-07-17 23:15:38,https://api.github.com/repos/nylas/sync-engine/git/commits/9c241921bc9285ffeed52ec170c84a9b550aa431,9c241921bc9285ffeed52ec170c84a9b550aa431,"X-GM-MSGID is unique per account, but not globally.

We had a couple bugs in there where we were making improper assumptions
on how to look up the associated Message object when creating ImapUid
entries for deduplicated Gmail message downloads."
spang,2014-07-16 23:14:27,https://api.github.com/repos/nylas/sync-engine/git/commits/55f45df220f762d5de2bf6c6445bd8c4ead02405,55f45df220f762d5de2bf6c6445bd8c4ead02405,Update ImapUid code now that we generate Messages regardless of parse errors.
emfree,2014-07-17 18:21:37,https://api.github.com/repos/nylas/sync-engine/git/commits/f0250c2be3123cdb210212351b5a81b16aaadae1,f0250c2be3123cdb210212351b5a81b16aaadae1,"Set db pool size in config, and remove unused config values."
emfree,2014-07-17 00:41:07,https://api.github.com/repos/nylas/sync-engine/git/commits/5ba0e7c33c90d7728e472aab28ecae1b0ccb7cd8,5ba0e7c33c90d7728e472aab28ecae1b0ccb7cd8,"Apply query.order_by before applying limit/offset in api/filtering.py

Otherwise the call fails with a sqlalchemy InvalidRequestError. Fixes T159."
spang,2014-07-17 00:45:37,https://api.github.com/repos/nylas/sync-engine/git/commits/2e185ea6db8d8f555485386cb0951626d300bf3a,2e185ea6db8d8f555485386cb0951626d300bf3a,Don't canonicalize NULL contact email addresses.
emfree,2014-07-17 00:27:30,https://api.github.com/repos/nylas/sync-engine/git/commits/55978e2436540baffe7f8bd9de8410b14994503b,55978e2436540baffe7f8bd9de8410b14994503b,"Don't store Message.mailing_list_info or Thread.mailing_list_info columns.

Summary: We weren't using them for anything. Fixes T156.

Test Plan: Sync run.

Reviewers: kav-ya

Reviewed By: kav-ya

Maniphest Tasks: T156

Differential Revision: https://review.inboxapp.com/D247"
emfree,2014-07-17 00:21:06,https://api.github.com/repos/nylas/sync-engine/git/commits/099e44fd685ce399fbe00b7dcebe0ec471a97ba8,099e44fd685ce399fbe00b7dcebe0ec471a97ba8,"[SCHEMA] Canonicalize email addresses when comparing them.

Summary:
Specifically, this currently means removing any periods from Gmail addresses.
We'll still return whatever form was originally stored. I.e., if you authed as
ben.bitdiddle@gmail.com, that's what we use to send, and return in `/n/` API
queries, etc.

Test Plan:
Unit tests updated; auth and sending behavior manually tested; ran a
sync without breakage.

Reviewers: spang

Reviewed By: spang

Differential Revision: https://review.inboxapp.com/D245"
spang,2014-07-16 22:08:40,https://api.github.com/repos/nylas/sync-engine/git/commits/3a4aba18d472d43ce100fbd5b8c8e952b3de8636,3a4aba18d472d43ce100fbd5b8c8e952b3de8636,Remove unused imports in mailsync/backends/base.py.
emfree,2014-07-15 00:04:54,https://api.github.com/repos/nylas/sync-engine/git/commits/88b6209460936e631ce0fab805675fd4b742cb49,88b6209460936e631ce0fab805675fd4b742cb49,"[SCHEMA] Store client_id and client_secret on GmailAccount objects.

This is an interim change to allow account syncs to run using a developer's
client ID and client secret, as opposed to the ones specified in the sync
engine config. If these parameters aren't stored, we still use the configured
ones, so that auth and sync in the dev VM work as before."
emfree,2014-07-16 23:26:08,https://api.github.com/repos/nylas/sync-engine/git/commits/1ef0cf15b4510b36c23b421b5e2dfdfe6fc32b71,1ef0cf15b4510b36c23b421b5e2dfdfe6fc32b71,"Fix type error when syncing back an unarchive action.

We were passing a Folder object to remote_move(), but that function expects a
folder name. Fix this, and rename the parameters to be more explicit."
emfree,2014-07-16 22:31:19,https://api.github.com/repos/nylas/sync-engine/git/commits/c272c1af35ad50674cace3811129bc13ec3ee49c,c272c1af35ad50674cace3811129bc13ec3ee49c,Set loglevel for logging fixture.
spang,2014-07-16 22:00:20,https://api.github.com/repos/nylas/sync-engine/git/commits/fc738451f87c48eab2d35ed82935584171b8057b,fc738451f87c48eab2d35ed82935584171b8057b,"Remove bad assertion and skip missing UIDs instead.

Similar to the KeyError issue, if UIDs disappear in the middle of a flag
update operation, we just shouldn't update them.

Fixes T153."
emfree,2014-07-16 21:48:18,https://api.github.com/repos/nylas/sync-engine/git/commits/9d1a46fa63ec4e2cb4c7204a2528c219755a44f0,9d1a46fa63ec4e2cb4c7204a2528c219755a44f0,"Don't check is_latest attribute on drafts that aren't SpoolMessage instances.

Fixes T157."
emfree,2014-07-16 21:45:05,https://api.github.com/repos/nylas/sync-engine/git/commits/008e841c544f2875aeb81dcf006805d90a99ea40,008e841c544f2875aeb81dcf006805d90a99ea40,"Fix call to update_imap_flags in order to properly set is_draft attribute.

Gmail uses a '\\Draft` *label*, not the '\\Draft' IMAP flag, so by omitting
that second parameter we weren't marking synced drafts as such."
spang,2014-07-16 21:30:48,https://api.github.com/repos/nylas/sync-engine/git/commits/1a726c373936cd12e4a71d839d863f2e8ac9d546,1a726c373936cd12e4a71d839d863f2e8ac9d546,"Fix KeyError in Gmail mailsync's add_new_imapuids()

Messages can still move around while a given IMAP session is open, so
sometimes we'll start adding ImapUid entries but not get the flag info
while the message is still in the given folder. (For example, when a
message is archived in the middle of this operation.)

The right thing to do in this situation is to skip adding the ImapUid
entry; we'll catch the message later via the All Mail sync."
emfree,2014-07-16 19:02:02,https://api.github.com/repos/nylas/sync-engine/git/commits/e0e72423dc19a6f9b6f8eb82ae09f4d002cf1aa6,e0e72423dc19a6f9b6f8eb82ae09f4d002cf1aa6,Properly configure logging level.
spang,2014-07-15 23:27:17,https://api.github.com/repos/nylas/sync-engine/git/commits/023cc97a6011f763eed769f6056c0eca333fa0b0,023cc97a6011f763eed769f6056c0eca333fa0b0,Better structlog logging in models/message.py.
spang,2014-07-15 22:54:33,https://api.github.com/repos/nylas/sync-engine/git/commits/114884672d7b344578446433246bfa58f5c56220,114884672d7b344578446433246bfa58f5c56220,"Store Message objects even if DecodingError occurs.

Summary:
It turns out that we do want to keep around message metadata even if we
fail to parse the entire message, since e.g. we don't want to keep
trying to download the UID over and over again, which we *will*, since
we determine which UIDs to download by looking at which UIDs we have
locally. It would be messier to relax the imapuid.message_id constraint
than to just store Message rows for the failed messages too.

Plus, this way we get to take a look at any metadata that *did* parse
successfully, and have better ways to expose failed messages to
developers.

This also fixes a NoResultFound error which is triggered by the previous
DecodingError codepath, where we tried to create imapuid rows in Gmail
syncs without corresponding Message rows.

Fixes T122 and GH #31.

Test Plan: ./runtests, manually throw mime.DecodingError & verify behaviour

Reviewers: emfree

Reviewed By: emfree

Maniphest Tasks: T122

Differential Revision: https://review.inboxapp.com/D243"
spang,2014-07-15 22:46:39,https://api.github.com/repos/nylas/sync-engine/git/commits/cf06bd6e1e5088ec1d7508a647eb09c432773b63,cf06bd6e1e5088ec1d7508a647eb09c432773b63,"Decrease default IMAP pool size from 8 to 6.

How low can we go?"
spang,2014-07-15 22:51:02,https://api.github.com/repos/nylas/sync-engine/git/commits/02e6403e8992346d868c27ec60394e459687f173,02e6403e8992346d868c27ec60394e459687f173,"Don't retry IMAP syncs on MailsyncError, ValueError, or AttributeError.

Summary:
These are always totally fatal errors that we throw manually, or
programming errors, so we shouldn't retry. Retrying just adds extra log spam.

Test Plan: ./runtests & manual verification by throwing errors under the retry

Reviewers: emfree

Reviewed By: emfree

Differential Revision: https://review.inboxapp.com/D244"
spang,2014-07-15 21:01:03,https://api.github.com/repos/nylas/sync-engine/git/commits/4173214ce7c577a8fa4bfd3c77909198bdb7c49d,4173214ce7c577a8fa4bfd3c77909198bdb7c49d,"Remove old, deprecated search code."
spang,2014-07-15 20:26:33,https://api.github.com/repos/nylas/sync-engine/git/commits/d84d19be3f65d4e950a0cae46d6f08458496f429,d84d19be3f65d4e950a0cae46d6f08458496f429,"Fix folder mapping KeyError when starting some IMAP syncs.

We were creating the {name: id} mapping for folders before we had
necessarily created folder objects for all folders belonging to an IMAP
account, which meant that sometimes we'd get a KeyError starting up the
sync because we couldn't find a Folder object for a given folder."
emfree,2014-07-15 08:05:07,https://api.github.com/repos/nylas/sync-engine/git/commits/f50fdb0f997ef0709b519fdf374754d6abd2a425,f50fdb0f997ef0709b519fdf374754d6abd2a425,"Support read and update operations on user-created tags.

Summary:
Addresses issue #45. Deletes will take a little more care because we need to
ensure that the tag gets removed from all threads.

Test Plan: Unit tests added.

Reviewers: kav-ya

Reviewed By: kav-ya

Differential Revision: https://review.inboxapp.com/D240"
emfree,2014-07-15 02:57:44,https://api.github.com/repos/nylas/sync-engine/git/commits/d27e43cb12f524715e8d63f18ded7117980ef370,d27e43cb12f524715e8d63f18ded7117980ef370,"Set load_on_pending for Part.message.

Like commit 526f9620, fixes errors when constructing the transaction log."
emfree,2014-07-14 22:26:22,https://api.github.com/repos/nylas/sync-engine/git/commits/bb9b723b5b4f242c4b560b0e2a5b13d76c9e3ff6,bb9b723b5b4f242c4b560b0e2a5b13d76c9e3ff6,"Set load_on_pending=True for namespace relationship of versioned objects.

This prevents errors when constructing the transaction log. Otherwise, if e.g.
a Block object was constructed with
block = Block(namespace_id=ns_id, ...)
then attempts to access block.namespace in the after_flush handler may
erroneously return None."
emfree,2014-07-14 21:52:52,https://api.github.com/repos/nylas/sync-engine/git/commits/dbe5478bedf28ba36823f628b56501727fcf41ef,dbe5478bedf28ba36823f628b56501727fcf41ef,"Automatically start syncs for newly-registered accounts.

Summary:
In inbox/mailsync/service.py, poll for accounts that have been registered but
don't have syncs started, and start them.

Also remove support for the 'startall/stopall' functionality in bin/inbox-sync,
which is not that useful and adds unnecessary complexity to the normal
start/stop sync implementation.

Test Plan:
Auth a new account and check that the sync starts; run
`bin/inbox-sync start <email_address>` and `bin/inbox-sync stop <email_address>`.

Reviewers: kav-ya, spang

Reviewed By: kav-ya, spang

Subscribers: kav-ya

Differential Revision: https://review.inboxapp.com/D237"
emfree,2014-07-14 19:22:43,https://api.github.com/repos/nylas/sync-engine/git/commits/ac372ad3cae558e09622645a0fc2e17e761de2ba,ac372ad3cae558e09622645a0fc2e17e761de2ba,"Return the same API representation for 'blocks' and 'parts'.

Summary:
Fixes issue #41. For files which have been uploaded but not actually attached
to a message, we simply set thee 'message' attribute to null.

Also remove some outdated code which defined a namespace property for Part
objects -- we now explicitly save the namespace_id in the Block parent class.

Test Plan: curl http://localhost:5555/n/<ns_id>/files

Reviewers: spang

Reviewed By: spang

Differential Revision: https://review.inboxapp.com/D234"
spang,2014-07-21 19:22:31,https://api.github.com/repos/nylas/sync-engine/git/commits/bcb4fd582f78e5ad32706fe850e4f30992809cc7,bcb4fd582f78e5ad32706fe850e4f30992809cc7,Fix index name collision in migration 056.
emfree,2014-07-20 03:21:50,https://api.github.com/repos/nylas/sync-engine/git/commits/16b6cce11d607d8cd33d2c9eb61cf9f90bae00a3,16b6cce11d607d8cd33d2c9eb61cf9f90bae00a3,Add an index to the transaction table to speed up client sync.
emfree,2014-07-16 02:46:29,https://api.github.com/repos/nylas/sync-engine/git/commits/5ecfcc459523a532c46072ab6676fd910ccb0441,5ecfcc459523a532c46072ab6676fd910ccb0441,Implement a safer_yield_per utility to avoid OOM issues and slowness.
emfree,2014-07-20 01:54:41,https://api.github.com/repos/nylas/sync-engine/git/commits/263751c672f1bfc9088d1e62bcca5749c3277572,263751c672f1bfc9088d1e62bcca5749c3277572,"Log to stdout, not stderr.

This lets us separate our own logs from other stuff, like boto logs and
un-truncated tracebacks."
emfree,2014-07-20 01:06:54,https://api.github.com/repos/nylas/sync-engine/git/commits/88eb10f239dd03629bb70b16b49445bd22e256ef,88eb10f239dd03629bb70b16b49445bd22e256ef,"More safely format large exception messages.

The immediate reason for this is that SQLAlchemy may return an excessively
large error message if, say the MySQL server goes away because you're trying to
insert a large object. Trying to log the entire 25MB insert statement is not
that helpful, and breaks various things."
spang,2014-07-19 22:45:51,https://api.github.com/repos/nylas/sync-engine/git/commits/c3c46cb9493680e3a47bb40ac2ddc55fdb1104a4,c3c46cb9493680e3a47bb40ac2ddc55fdb1104a4,Remove unused import in inbox/crispin.py.
spang,2014-07-19 22:24:24,https://api.github.com/repos/nylas/sync-engine/git/commits/68d3d2abf748e27bde23570c9fb15c9676df5e68,68d3d2abf748e27bde23570c9fb15c9676df5e68,"Fix bug in g_msgids() affecting Gmail message deduplication.

We occasionally were failing to deduplicate message object creation or
download because we wrongly excluded messages which currently had no
associated ImapUids. (This is actually a common situation, as when a
message moves we might well delete the old ImapUid before creating the
new one.)

Fixes T180."
emfree,2014-07-19 22:30:57,https://api.github.com/repos/nylas/sync-engine/git/commits/d3d5069f3907a8e983f8ac76acda5426c220f9a1,d3d5069f3907a8e983f8ac76acda5426c220f9a1,"Fix sending error when subject parameter is unset.

If we're sending a reply to a thread and there's no subject given, use the
thread's subject; otherwise use the empty string. Fixes TypeError in gmail
sending code."
spang,2014-07-19 21:50:06,https://api.github.com/repos/nylas/sync-engine/git/commits/fad59f7a5c72ea543fbfdb78342c6bdd4eb0f8cc,fad59f7a5c72ea543fbfdb78342c6bdd4eb0f8cc,Fix bug in migration 064.
emfree,2014-07-19 21:42:58,https://api.github.com/repos/nylas/sync-engine/git/commits/00dfa5362c0fcd55c2880dee69739b35f597e66a,00dfa5362c0fcd55c2880dee69739b35f597e66a,"Make slow query logging more structured.

Also add support for log.exception, which may be called by gunicorn."
kav-ya,2014-07-19 10:03:56,https://api.github.com/repos/nylas/sync-engine/git/commits/d506568ce4a48d87f4eddb859f372da9843030b1,d506568ce4a48d87f4eddb859f372da9843030b1,Fix previous migration down_revision ID.
emfree,2014-07-17 22:01:46,https://api.github.com/repos/nylas/sync-engine/git/commits/e68d05116fd731f76f95c5e2bbff86d98c5b636c,e68d05116fd731f76f95c5e2bbff86d98c5b636c,"[SCHEMA] Make Message.*_addr non-null to prevent TypeErrors.

In Thread.participants, we assume that these attributes are iterable, but they
may not be set at all in case of decoding error. It's generally safer to have
them maybe be the empty list, but never null.

Fixes T181."
spang,2014-07-19 04:44:24,https://api.github.com/repos/nylas/sync-engine/git/commits/f4087548e4ac0b7d0c617f25d0c573cfcc2446cc,f4087548e4ac0b7d0c617f25d0c573cfcc2446cc,Don't retry on DataError and IntegrityError.
spang,2014-07-19 04:31:38,https://api.github.com/repos/nylas/sync-engine/git/commits/6dfb4e3e97538ca309edef5c049579203dbe444c,6dfb4e3e97538ca309edef5c049579203dbe444c,"[SCHEMA] Drop part.misc_keyval column.

We have no plans to use this data, and a lack of logic for truncation is
causing some messages to break syncs.

Fixes T177."
spang,2014-07-19 03:56:09,https://api.github.com/repos/nylas/sync-engine/git/commits/a025358b07200a0e3d839e8963949c9a7e40e24d,a025358b07200a0e3d839e8963949c9a7e40e24d,Migration 061 should delete RecipientInfo rows for all accounts.
kav-ya,2014-07-19 03:16:45,https://api.github.com/repos/nylas/sync-engine/git/commits/a9dab0d0d5a0740aeffa0fa1d5613e32bb784424,a9dab0d0d5a0740aeffa0fa1d5613e32bb784424,For real.
kav-ya,2014-07-19 03:15:35,https://api.github.com/repos/nylas/sync-engine/git/commits/8cc7c8bcf460dc0952ceeafef6dce016f044f179,8cc7c8bcf460dc0952ceeafef6dce016f044f179,[SCHEMA] Rename migration.
kav-ya,2014-07-19 03:10:01,https://api.github.com/repos/nylas/sync-engine/git/commits/26f50ffe0f81a3396352bb1b8d12914fa49487c3,26f50ffe0f81a3396352bb1b8d12914fa49487c3,[Monocle] Filter accounts by provider + state (v1)
spang,2014-07-19 03:10:59,https://api.github.com/repos/nylas/sync-engine/git/commits/dfcf90b752180b830b05aa20bf4bfacf2c1f71aa,dfcf90b752180b830b05aa20bf4bfacf2c1f71aa,[DEPENDENCIES] Update to latest click.
spang,2014-07-19 03:08:18,https://api.github.com/repos/nylas/sync-engine/git/commits/704c3f60b12a91d92cf9acef9e2654325542043e,704c3f60b12a91d92cf9acef9e2654325542043e,"Port bin/inbox-* to click.

Summary:
We're already using this library elsewhere, and it's a lot cleaner to
use than argparse. I did some consistency tidying as well.

This is a precursor to modifying bin/inbox-start for multicore support.

Test Plan: ./runtests, manual verification that scripts start as expected

Reviewers: emfree

Reviewed By: emfree

Differential Revision: https://review.inboxapp.com/D254"
kav-ya,2014-07-19 03:08:30,https://api.github.com/repos/nylas/sync-engine/git/commits/fe20a5ed0f04a71d70e4e1f7328d85f982dd1b1a,fe20a5ed0f04a71d70e4e1f7328d85f982dd1b1a,Add a try/except to  migration 061.
kav-ya,2014-07-19 02:10:02,https://api.github.com/repos/nylas/sync-engine/git/commits/dc079153f83709722fd3bd787a878b09a053c858,dc079153f83709722fd3bd787a878b09a053c858,"[SCHEMA] Fixes T171: Data too long for column message_id_header

We up the max column length to 998 in accordance with http://tools.ietf.org/html/rfc4130 (section 5.3.3)
(We can't truncate this header because it is used to populate the In-Reply-To header on
messages we send)."
kav-ya,2014-07-19 01:32:20,https://api.github.com/repos/nylas/sync-engine/git/commits/793c58d5615adb47d90b3cbcfbeb1e24839b64c8,793c58d5615adb47d90b3cbcfbeb1e24839b64c8,[SCHEMA] Migration to remove EASFolderSyncStatus + Folder rows we never sync.
kav-ya,2014-07-19 01:31:56,https://api.github.com/repos/nylas/sync-engine/git/commits/336015af7777356614b08f6fd6f83b81201cd0da,336015af7777356614b08f6fd6f83b81201cd0da,[SCHEMA] Migration to cascade Folder deletes to EASUid
emfree,2014-07-19 00:46:09,https://api.github.com/repos/nylas/sync-engine/git/commits/b50eab9f2c68ecf4a8a6c8b76e94eab312dd8650,b50eab9f2c68ecf4a8a6c8b76e94eab312dd8650,"[SCHEMA] Explicitly schedule syncback actions, instead of using the transaction log.

Summary:
Fixes T167, by removing the offending code altogether.

Instead of inferring syncback actions to execute from the generic transaction
log, explicitly store them in the new ActionLog table. This provides the
following benefits:

 * It's easier to ensure that syncback actions are executed when they should
   be. For example, if a user marks a single message as read via the API, we
   want to sync that back. But if we change a message's read status in
   mailsync, we don't want to schedule a syncback action. It's currently
   impossible to distinguish those two scenarios just by interpreting the
   transaction log. Similarly, we had to clunkily distinguish between tags that
   were set via the API and tags that were set from mailsync.

 * The SyncbackService doesn't need to process the *entire* transaction log.

Test Plan: Unit tests, and manually san-checking syncback actions.

Reviewers: kav-ya

Reviewed By: kav-ya

Subscribers: spang

Maniphest Tasks: T167

Differential Revision: https://review.inboxapp.com/D248"
spang,2014-07-18 22:49:14,https://api.github.com/repos/nylas/sync-engine/git/commits/4961c2ddfb660bc72b20a8217a39a75beb3d0c56,4961c2ddfb660bc72b20a8217a39a75beb3d0c56,Make sure to commit final objects in migration 057.
nylasbot,2014-07-18 22:43:55,https://api.github.com/repos/nylas/sync-engine/git/commits/1a25e48258d49c6f751f5c5d22dee8362952e106,1a25e48258d49c6f751f5c5d22dee8362952e106,Fix alembic revision branch.
spang,2014-07-18 22:39:06,https://api.github.com/repos/nylas/sync-engine/git/commits/f5f8120fca38e70d68e57eea1bf38605532f16ca,f5f8120fca38e70d68e57eea1bf38605532f16ca,"[SCHEMA] Truncate message subjects to 255 characters.

Fixes DataErrors caused by subjects that overflow the size of MySQL's TEXT."
kav-ya,2014-07-18 02:51:30,https://api.github.com/repos/nylas/sync-engine/git/commits/4eb65fa0d5557946562705f4316fb70eca77cd58,4eb65fa0d5557946562705f4316fb70eca77cd58,"Fixes T138 and then some:
Include account_id in exceptions email,
Include errors in Monocle.

Summary:
To include account_id in the exceptions email, we simply use an extra account_id param;
I did some quick, prelim digging into directly using the account_id that the logger is initialized with
(through the event_dict passed to the structlog processors) but that seemed unnecessarily complicated.

The changes to include errors in Monocle should be more obvious;
we currently store the error in the database table itself because that's where Monocle pulls its data from but eventually,
we should move to a different approach.
Note that this rev includes a migration to change how we store sync_status info in models.account (switched to using a single JSON column)

Test Plan:
Visual app inspection.
Sync runs as before.

Reviewers: emfree

Reviewed By: emfree

Subscribers: spang

Maniphest Tasks: T138

Differential Revision: https://review.inboxapp.com/D249"
spang,2014-07-18 21:30:18,https://api.github.com/repos/nylas/sync-engine/git/commits/58d406188d0e6b432cf68a61e1756ce5d9d759a2,58d406188d0e6b432cf68a61e1756ce5d9d759a2,Fix argument ordering in migraton 056.
spang,2014-07-18 21:30:18,https://api.github.com/repos/nylas/sync-engine/git/commits/ebda02311bf6ce133af7caf322968ec30f6ecf58,ebda02311bf6ce133af7caf322968ec30f6ecf58,Fix argument ordering in migraton 056.
spang,2014-07-18 21:27:24,https://api.github.com/repos/nylas/sync-engine/git/commits/19c8f70dea6f339ee372d411b52c34d406aebd6e,19c8f70dea6f339ee372d411b52c34d406aebd6e,Fix database session bug which results in creation of multiple Thread objects on Gmail.
spang,2014-07-18 21:19:49,https://api.github.com/repos/nylas/sync-engine/git/commits/4e9891f723302cec86feb1e50322fb8787f40a7a,4e9891f723302cec86feb1e50322fb8787f40a7a,Fix up a comment and log error.
spang,2014-07-17 23:35:48,https://api.github.com/repos/nylas/sync-engine/git/commits/1387c4af4144e61504b093eb54f7f62521fc6d5c,1387c4af4144e61504b093eb54f7f62521fc6d5c,"[SCHEMA] Remove duplicate Gmail message data and tighten constraints.

Some bugs caused Message objects to occasionally be duplicated for Gmail
accounts. I'm not 100% sure we've eradicated them all, but tightening
the constraints on the table will make it easier to make sure.

Note that MySQL does not apply unique constraints against rows on which
some of the columns to constraint are NULL, so this does not affect
non-Gmail accounts (which do not have a g_msgid)."
khamidou,2014-07-18 11:45:56,https://api.github.com/repos/nylas/sync-engine/git/commits/db6845d56113242225109d6900e0716288be8f2c,db6845d56113242225109d6900e0716288be8f2c,"Periodically refresh IMAP flags for those servers that don't support CONDSTORE

Summary:
Christine,

I integrated the changes we talked about yesterday. Here's what I think you should take a look at first:

- I've decided to spawn a new greenlet to update IMAP flags during a full sync. I thought it would be cleaner this way (imap.py:561). To do this I defined a new function ""imap_check_flags"" which was largely copy-pasted from another one. Tell me if you think there's stuff which should be abstracted away.

- IMAP updates are limited to the highest ""refresh_flags_max"" UIDs (2000 by default, but this is a constructor parameter). I must say I haven't found a better variable name so I'm open to suggestions.

Test Plan: Ran a smoke test. Triggered a full sync and paused the program with a debugger. Checked that the fields where updated in the db.

Reviewers: spang

Reviewed By: spang

Differential Revision: https://review.inboxapp.com/D241"
emfree,2014-07-18 02:50:49,https://api.github.com/repos/nylas/sync-engine/git/commits/24b63fd1d6f4c515e876c37b6f56887f5d45dc63,24b63fd1d6f4c515e876c37b6f56887f5d45dc63,"Order API responses most-recent-first when order_by=date.

Not least-recent-first. Dammit."
emfree,2014-07-17 22:05:18,https://api.github.com/repos/nylas/sync-engine/git/commits/5f7c1b4f5c2de64df7c7e9f35f2d9425ebca4e5c,5f7c1b4f5c2de64df7c7e9f35f2d9425ebca4e5c,Fix migration 053 when email addresses or non-null but not parseable.
bengotow,2014-07-17 23:41:02,https://api.github.com/repos/nylas/sync-engine/git/commits/e65fbb0540ca403c02a992a3d4f0f1e102e0cb17,e65fbb0540ca403c02a992a3d4f0f1e102e0cb17,"Updating documentation based on Layer meeting feedback

Summary: Only modifies docs

Test Plan: Read over docs and provide feedback

Reviewers: spang

Differential Revision: https://review.inboxapp.com/D242

Conflicts:
	inbox/docs/api/05_tags.mdown"
spang,2014-07-17 23:15:38,https://api.github.com/repos/nylas/sync-engine/git/commits/422d262b61ee477cd14fd8a5e1aa165d6ad4dd63,422d262b61ee477cd14fd8a5e1aa165d6ad4dd63,"X-GM-MSGID is unique per account, but not globally.

We had a couple bugs in there where we were making improper assumptions
on how to look up the associated Message object when creating ImapUid
entries for deduplicated Gmail message downloads."
spang,2014-07-16 23:14:27,https://api.github.com/repos/nylas/sync-engine/git/commits/22e5f54ed7ae923caa3c7b7ad20bf3f97590ca56,22e5f54ed7ae923caa3c7b7ad20bf3f97590ca56,Update ImapUid code now that we generate Messages regardless of parse errors.
emfree,2014-07-17 18:21:37,https://api.github.com/repos/nylas/sync-engine/git/commits/610aa509dc79e13c7b66ee07b1ab122a9ac2dd03,610aa509dc79e13c7b66ee07b1ab122a9ac2dd03,"Set db pool size in config, and remove unused config values."
emfree,2014-07-17 00:41:07,https://api.github.com/repos/nylas/sync-engine/git/commits/1f6bc4c746dbd1415a5f377340930a9d64e7c0c0,1f6bc4c746dbd1415a5f377340930a9d64e7c0c0,"Apply query.order_by before applying limit/offset in api/filtering.py

Otherwise the call fails with a sqlalchemy InvalidRequestError. Fixes T159."
spang,2014-07-17 00:45:37,https://api.github.com/repos/nylas/sync-engine/git/commits/030b6611ed7a6e8f165b16bb239a38c013b4f771,030b6611ed7a6e8f165b16bb239a38c013b4f771,Don't canonicalize NULL contact email addresses.
emfree,2014-07-17 00:27:30,https://api.github.com/repos/nylas/sync-engine/git/commits/71def6dc7edb7f1a444fb03fec0af88a30fb1a35,71def6dc7edb7f1a444fb03fec0af88a30fb1a35,"Don't store Message.mailing_list_info or Thread.mailing_list_info columns.

Summary: We weren't using them for anything. Fixes T156.

Test Plan: Sync run.

Reviewers: kav-ya

Reviewed By: kav-ya

Maniphest Tasks: T156

Differential Revision: https://review.inboxapp.com/D247"
emfree,2014-07-17 00:21:06,https://api.github.com/repos/nylas/sync-engine/git/commits/7cef588f860bfc5ce84b9e2db708ddf4c4d0f964,7cef588f860bfc5ce84b9e2db708ddf4c4d0f964,"[SCHEMA] Canonicalize email addresses when comparing them.

Summary:
Specifically, this currently means removing any periods from Gmail addresses.
We'll still return whatever form was originally stored. I.e., if you authed as
ben.bitdiddle@gmail.com, that's what we use to send, and return in `/n/` API
queries, etc.

Test Plan:
Unit tests updated; auth and sending behavior manually tested; ran a
sync without breakage.

Reviewers: spang

Reviewed By: spang

Differential Revision: https://review.inboxapp.com/D245"
spang,2014-07-16 22:08:40,https://api.github.com/repos/nylas/sync-engine/git/commits/e1553867ecdd9bf6b54ae312fd4e64f32c96e305,e1553867ecdd9bf6b54ae312fd4e64f32c96e305,Remove unused imports in mailsync/backends/base.py.
emfree,2014-07-15 00:04:54,https://api.github.com/repos/nylas/sync-engine/git/commits/82b14a092d99c26264bd305b390aa9b11b93e62a,82b14a092d99c26264bd305b390aa9b11b93e62a,"[SCHEMA] Store client_id and client_secret on GmailAccount objects.

This is an interim change to allow account syncs to run using a developer's
client ID and client secret, as opposed to the ones specified in the sync
engine config. If these parameters aren't stored, we still use the configured
ones, so that auth and sync in the dev VM work as before."
emfree,2014-07-16 23:26:08,https://api.github.com/repos/nylas/sync-engine/git/commits/0bfa140a6be21a8065d3ecb0d100660e6df969c3,0bfa140a6be21a8065d3ecb0d100660e6df969c3,"Fix type error when syncing back an unarchive action.

We were passing a Folder object to remote_move(), but that function expects a
folder name. Fix this, and rename the parameters to be more explicit."
emfree,2014-07-16 22:31:19,https://api.github.com/repos/nylas/sync-engine/git/commits/3e114664ec626052b890c76f84b632e768b943bc,3e114664ec626052b890c76f84b632e768b943bc,Set loglevel for logging fixture.
spang,2014-07-16 22:00:20,https://api.github.com/repos/nylas/sync-engine/git/commits/8b157adb28d62ea5eff5fea02d98ddc165a4a720,8b157adb28d62ea5eff5fea02d98ddc165a4a720,"Remove bad assertion and skip missing UIDs instead.

Similar to the KeyError issue, if UIDs disappear in the middle of a flag
update operation, we just shouldn't update them.

Fixes T153."
emfree,2014-07-16 21:48:18,https://api.github.com/repos/nylas/sync-engine/git/commits/4de0bb8f42a03e9e19897fbdcd80800925daa87b,4de0bb8f42a03e9e19897fbdcd80800925daa87b,"Don't check is_latest attribute on drafts that aren't SpoolMessage instances.

Fixes T157."
emfree,2014-07-16 21:45:05,https://api.github.com/repos/nylas/sync-engine/git/commits/0656789265d482901fa242178c5d6981ad2ca003,0656789265d482901fa242178c5d6981ad2ca003,"Fix call to update_imap_flags in order to properly set is_draft attribute.

Gmail uses a '\\Draft` *label*, not the '\\Draft' IMAP flag, so by omitting
that second parameter we weren't marking synced drafts as such."
spang,2014-07-16 21:30:48,https://api.github.com/repos/nylas/sync-engine/git/commits/44e9d9920af25a7f626f1a607051c4c766325de2,44e9d9920af25a7f626f1a607051c4c766325de2,"Fix KeyError in Gmail mailsync's add_new_imapuids()

Messages can still move around while a given IMAP session is open, so
sometimes we'll start adding ImapUid entries but not get the flag info
while the message is still in the given folder. (For example, when a
message is archived in the middle of this operation.)

The right thing to do in this situation is to skip adding the ImapUid
entry; we'll catch the message later via the All Mail sync."
emfree,2014-07-16 19:02:02,https://api.github.com/repos/nylas/sync-engine/git/commits/a44eefb195929d533a20b76d743ff4c28e835400,a44eefb195929d533a20b76d743ff4c28e835400,Properly configure logging level.
spang,2014-07-15 23:27:17,https://api.github.com/repos/nylas/sync-engine/git/commits/22ff3453231ddb522ad505b99539f127b4b1472b,22ff3453231ddb522ad505b99539f127b4b1472b,Better structlog logging in models/message.py.
spang,2014-07-15 22:54:33,https://api.github.com/repos/nylas/sync-engine/git/commits/e7cadde117122b3b77c52875d1f6e6dba7da5bcc,e7cadde117122b3b77c52875d1f6e6dba7da5bcc,"Store Message objects even if DecodingError occurs.

Summary:
It turns out that we do want to keep around message metadata even if we
fail to parse the entire message, since e.g. we don't want to keep
trying to download the UID over and over again, which we *will*, since
we determine which UIDs to download by looking at which UIDs we have
locally. It would be messier to relax the imapuid.message_id constraint
than to just store Message rows for the failed messages too.

Plus, this way we get to take a look at any metadata that *did* parse
successfully, and have better ways to expose failed messages to
developers.

This also fixes a NoResultFound error which is triggered by the previous
DecodingError codepath, where we tried to create imapuid rows in Gmail
syncs without corresponding Message rows.

Fixes T122 and GH #31.

Test Plan: ./runtests, manually throw mime.DecodingError & verify behaviour

Reviewers: emfree

Reviewed By: emfree

Maniphest Tasks: T122

Differential Revision: https://review.inboxapp.com/D243"
spang,2014-07-15 22:46:39,https://api.github.com/repos/nylas/sync-engine/git/commits/062d02cc1cdc37419f0b7c0f47307033283db17b,062d02cc1cdc37419f0b7c0f47307033283db17b,"Decrease default IMAP pool size from 8 to 6.

How low can we go?"
spang,2014-07-15 22:51:02,https://api.github.com/repos/nylas/sync-engine/git/commits/4ce3d7f6e3f2022651d2846f2205377f7d7cb737,4ce3d7f6e3f2022651d2846f2205377f7d7cb737,"Don't retry IMAP syncs on MailsyncError, ValueError, or AttributeError.

Summary:
These are always totally fatal errors that we throw manually, or
programming errors, so we shouldn't retry. Retrying just adds extra log spam.

Test Plan: ./runtests & manual verification by throwing errors under the retry

Reviewers: emfree

Reviewed By: emfree

Differential Revision: https://review.inboxapp.com/D244"
spang,2014-07-15 21:01:03,https://api.github.com/repos/nylas/sync-engine/git/commits/468c898f56e282a778f8ee6192ae98ce4872c5a6,468c898f56e282a778f8ee6192ae98ce4872c5a6,"Remove old, deprecated search code."
spang,2014-07-15 20:26:33,https://api.github.com/repos/nylas/sync-engine/git/commits/88f8d67af8de51c5f89cbc40bb0b865659b1f3a8,88f8d67af8de51c5f89cbc40bb0b865659b1f3a8,"Fix folder mapping KeyError when starting some IMAP syncs.

We were creating the {name: id} mapping for folders before we had
necessarily created folder objects for all folders belonging to an IMAP
account, which meant that sometimes we'd get a KeyError starting up the
sync because we couldn't find a Folder object for a given folder."
emfree,2014-07-15 08:05:07,https://api.github.com/repos/nylas/sync-engine/git/commits/0a1f645f2e01aff92186b9a7c3f85c88ec6e9237,0a1f645f2e01aff92186b9a7c3f85c88ec6e9237,"Support read and update operations on user-created tags.

Summary:
Addresses issue #45. Deletes will take a little more care because we need to
ensure that the tag gets removed from all threads.

Test Plan: Unit tests added.

Reviewers: kav-ya

Reviewed By: kav-ya

Differential Revision: https://review.inboxapp.com/D240"
grinich,2014-07-15 19:36:27,https://api.github.com/repos/nylas/sync-engine/git/commits/f327b1220131bad7d26355f23abd48a4492a8d9b,f327b1220131bad7d26355f23abd48a4492a8d9b,"Merge pull request #47 from lheyberger/master

Fixed coma issues in json examples"
lheyberger,2014-07-15 19:10:48,https://api.github.com/repos/nylas/sync-engine/git/commits/9f3acf2c69c02f6a1047ff8625da8cf4c839aadb,9f3acf2c69c02f6a1047ff8625da8cf4c839aadb,Fixed coma issues in json examples
kav-ya,2014-07-15 06:22:43,https://api.github.com/repos/nylas/sync-engine/git/commits/7f0c0a7543e2522cb0d1ee2e269a82c0d29b6389,7f0c0a7543e2522cb0d1ee2e269a82c0d29b6389,"Fixes Github #43: document Thread#subject_date

Summary: Rename to 'first_message_timestamp'
Update docs.

Test Plan: tests/api pass as before.

Reviewers: emfree

Differential Revision: https://review.inboxapp.com/D239"
emfree,2014-07-15 07:32:26,https://api.github.com/repos/nylas/sync-engine/git/commits/c3304f443b9c328fb29286727fa187dda1c1d431,c3304f443b9c328fb29286727fa187dda1c1d431,"Add LOGDIR back to config.

This is actually still needed with the new logging infrastructure, because we
save messsages with decode errors to separate files in that directory in
inbox.models.message._get_errfile_name()."
emfree,2014-07-15 07:32:26,https://api.github.com/repos/nylas/sync-engine/git/commits/ded042b7f8c9553ea09b88523333d398a035b0d2,ded042b7f8c9553ea09b88523333d398a035b0d2,"Add LOGDIR back to config.

This is actually still needed with the new logging infrastructure, because we
save messsages with decode errors to separate files in that directory in
inbox.models.message._get_errfile_name()."
emfree,2014-07-15 02:57:44,https://api.github.com/repos/nylas/sync-engine/git/commits/2a1c9c7a035348ad71ee1bd08d98ca52deb53006,2a1c9c7a035348ad71ee1bd08d98ca52deb53006,"Set load_on_pending for Part.message.

Like commit 526f9620, fixes errors when constructing the transaction log."
emfree,2014-07-14 22:26:22,https://api.github.com/repos/nylas/sync-engine/git/commits/526f962009d044cee3f4833e91c1bbf7f5c3474b,526f962009d044cee3f4833e91c1bbf7f5c3474b,"Set load_on_pending=True for namespace relationship of versioned objects.

This prevents errors when constructing the transaction log. Otherwise, if e.g.
a Block object was constructed with
block = Block(namespace_id=ns_id, ...)
then attempts to access block.namespace in the after_flush handler may
erroneously return None."
emfree,2014-07-14 19:30:26,https://api.github.com/repos/nylas/sync-engine/git/commits/a36adadc32144a5412f435d2eb6b656a0ed4c710,a36adadc32144a5412f435d2eb6b656a0ed4c710,"Adapt logging setup to work when the API server is run under gunicorn.

Summary:
Run with:
  gunicorn --worker-class inbox.api.wsgi.InboxWSGIWorker --logger-class inbox.api.wsgi.GunicornLogger inbox.api.srv:app ...

This also requires some minor changes to our existing logging setup, because
gunicorn passes positional arguments in its logging messages
(`self.log.info('message %s', some_value)`) but structlog can't currently
handle that (https://github.com/hynek/structlog/issues/19).

Test Plan:
Run `bin/inbox-api` and `gunicorn --worker-class
inbox.api.wsgi.InboxWSGIWorker --logger-class inbox.api.wsgi.GunicornLogger
--workers=1 --bind 127.0.0.1:5555 inbox.api.srv:app` and make some API
requests.

Reviewers: spang

Reviewed By: spang

Differential Revision: https://review.inboxapp.com/D235"
emfree,2014-07-13 02:35:09,https://api.github.com/repos/nylas/sync-engine/git/commits/161db3a7e0cd01d851cfdb501881a39d754d6764,161db3a7e0cd01d851cfdb501881a39d754d6764,Fix merge error between previous two commits.
emfree,2014-07-11 05:10:46,https://api.github.com/repos/nylas/sync-engine/git/commits/cc5183cf75c1950efd17ab2f8895e4a24194ef49,cc5183cf75c1950efd17ab2f8895e4a24194ef49,"Port logging to structlog.

Summary:
Our existing log infrastructure was not a scalable solution. We'll
funnel these structured logs into LogStash+Kibana or a similar toolchain
for searchable logs and visualizations.

structlog makes it easy to bind specific params to a given logger, so we
get more context for debugging. Awesome!

Also configure logging to just write to syslog instead of various files. This
requires a bit of configuration of rsyslog, but I think will ultimately make it
easier to set up remote log forwarding, log rotation and similar fancy stuff,
without having to worry about any of it in the actual application code.

Test Plan: Unit tests updated, and mailsync/api servers run.

Reviewers: spang

Reviewed By: spang

Differential Revision: https://review.inboxapp.com/D231"
spang,2014-07-11 02:56:10,https://api.github.com/repos/nylas/sync-engine/git/commits/afcd3bcaea068333642db3691148421695a8b483,afcd3bcaea068333642db3691148421695a8b483,"Fix crasher when Gmail 'Important' folder disabled in IMAP.

Summary:
We solve this by creating folder rows with a NULL 'name' when we have
the special Gmail label on messages but the corresponding IMAP folder is
disabled. If the folder is later re-enabled, we reconcile the existing
Folder row with the detected folder name, so messages will be properly
synced.

Note that adding `nullable=True` is merely making an existing default
explicit.

Test Plan: Manually disable Important on test account, sync messages, re-enable and verify resolution.

Reviewers: emfree

Reviewed By: emfree

Differential Revision: https://review.inboxapp.com/D232"
kav-ya,2014-07-10 21:37:20,https://api.github.com/repos/nylas/sync-engine/git/commits/bd590aa3a48eb40aa6e426b14674992878ca8104,bd590aa3a48eb40aa6e426b14674992878ca8104,Remove old defn. of register_backends() from inbox.mailsync.backends.base
kav-ya,2014-07-10 00:21:59,https://api.github.com/repos/nylas/sync-engine/git/commits/95bfa973dc6cd8695dd93da0f69c74484f7bd219,95bfa973dc6cd8695dd93da0f69c74484f7bd219,"* Update _process_log() for drafts.

* Test drafts reconciliation without a sync.
We now do this via two tests:
test_drafts_syncback.test_remote_save_draft() and test_reconcile_message.py,
which each test a separate chunk of that logic."
emfree,2014-07-10 00:20:19,https://api.github.com/repos/nylas/sync-engine/git/commits/c759eccd553ca12fdfade420f11db7ceb7e6203f,c759eccd553ca12fdfade420f11db7ceb7e6203f,"Make bin/clear-db also keep 'secret' table if --with-users isn't specified.

Needed now that auth credentials are stored in that table."
emfree,2014-07-09 23:09:55,https://api.github.com/repos/nylas/sync-engine/git/commits/4190774da34df09af5a69dd292f854ac5d62b5b9,4190774da34df09af5a69dd292f854ac5d62b5b9,"Use a less aggressive participant deduplication strategy.

Fixes T123."
emfree,2014-07-09 19:23:20,https://api.github.com/repos/nylas/sync-engine/git/commits/f9bbba2d133ec0b8c7a9aeca3ee42563b22ba010,f9bbba2d133ec0b8c7a9aeca3ee42563b22ba010,Deduplicate a thread's participants by email address.
emfree,2014-07-09 18:19:21,https://api.github.com/repos/nylas/sync-engine/git/commits/f8f68d31aa921cfc1a20393e9f1fde814f9b6ea7,f8f68d31aa921cfc1a20393e9f1fde814f9b6ea7,"Use a gevent pool for actions syncback instead of Redis-plus-workers.

Summary:
This is much simpler, and we were probably going to change this eventually
anyways. The immediate reason for doing it right now is that the rq module
reconfigures the root logger, which is really annoying when you are trying to
actually configure it yourself.

Also, start the SyncbackService as a simple greenlet instead of a ZeroRPC
service (which it isn't really).

Test Plan: Unit tests updated, end-to-end syncback behavior manually verified.

Reviewers: spang

Reviewed By: spang

Differential Revision: https://review.inboxapp.com/D229"
emfree,2014-07-14 21:52:52,https://api.github.com/repos/nylas/sync-engine/git/commits/f58120825b8be8e12ee5a6be61f1026c6a8cb76b,f58120825b8be8e12ee5a6be61f1026c6a8cb76b,"Automatically start syncs for newly-registered accounts.

Summary:
In inbox/mailsync/service.py, poll for accounts that have been registered but
don't have syncs started, and start them.

Also remove support for the 'startall/stopall' functionality in bin/inbox-sync,
which is not that useful and adds unnecessary complexity to the normal
start/stop sync implementation.

Test Plan:
Auth a new account and check that the sync starts; run
`bin/inbox-sync start <email_address>` and `bin/inbox-sync stop <email_address>`.

Reviewers: kav-ya, spang

Reviewed By: kav-ya, spang

Subscribers: kav-ya

Differential Revision: https://review.inboxapp.com/D237"
emfree,2014-07-14 19:30:26,https://api.github.com/repos/nylas/sync-engine/git/commits/fe647af49fc8370f7cc43d268de3922fca984e6c,fe647af49fc8370f7cc43d268de3922fca984e6c,"Adapt logging setup to work when the API server is run under gunicorn.

Summary:
Run with:
  gunicorn --worker-class inbox.api.wsgi.InboxWSGIWorker --logger-class inbox.api.wsgi.GunicornLogger inbox.api.srv:app ...

This also requires some minor changes to our existing logging setup, because
gunicorn passes positional arguments in its logging messages
(`self.log.info('message %s', some_value)`) but structlog can't currently
handle that (https://github.com/hynek/structlog/issues/19).

Test Plan:
Run `bin/inbox-api` and `gunicorn --worker-class
inbox.api.wsgi.InboxWSGIWorker --logger-class inbox.api.wsgi.GunicornLogger
--workers=1 --bind 127.0.0.1:5555 inbox.api.srv:app` and make some API
requests.

Reviewers: spang

Reviewed By: spang

Differential Revision: https://review.inboxapp.com/D235"
emfree,2014-07-14 19:22:43,https://api.github.com/repos/nylas/sync-engine/git/commits/a2fa7e0e556a26a1f21c015468b61705a9d1f9c2,a2fa7e0e556a26a1f21c015468b61705a9d1f9c2,"Return the same API representation for 'blocks' and 'parts'.

Summary:
Fixes issue #41. For files which have been uploaded but not actually attached
to a message, we simply set thee 'message' attribute to null.

Also remove some outdated code which defined a namespace property for Part
objects -- we now explicitly save the namespace_id in the Block parent class.

Test Plan: curl http://localhost:5555/n/<ns_id>/files

Reviewers: spang

Reviewed By: spang

Differential Revision: https://review.inboxapp.com/D234"
emfree,2014-07-13 02:35:09,https://api.github.com/repos/nylas/sync-engine/git/commits/3b541cd2e908ba330f147ce651193860e0c29231,3b541cd2e908ba330f147ce651193860e0c29231,Fix merge error between previous two commits.
emfree,2014-07-11 05:10:46,https://api.github.com/repos/nylas/sync-engine/git/commits/4ac47d23fd628ca1df8d26fd974da122398688ca,4ac47d23fd628ca1df8d26fd974da122398688ca,"Port logging to structlog.

Summary:
Our existing log infrastructure was not a scalable solution. We'll
funnel these structured logs into LogStash+Kibana or a similar toolchain
for searchable logs and visualizations.

structlog makes it easy to bind specific params to a given logger, so we
get more context for debugging. Awesome!

Also configure logging to just write to syslog instead of various files. This
requires a bit of configuration of rsyslog, but I think will ultimately make it
easier to set up remote log forwarding, log rotation and similar fancy stuff,
without having to worry about any of it in the actual application code.

Test Plan: Unit tests updated, and mailsync/api servers run.

Reviewers: spang

Reviewed By: spang

Differential Revision: https://review.inboxapp.com/D231"
spang,2014-07-11 02:56:10,https://api.github.com/repos/nylas/sync-engine/git/commits/0b70f1b66af9dca7b525bdfcb730e32beecad0d0,0b70f1b66af9dca7b525bdfcb730e32beecad0d0,"Fix crasher when Gmail 'Important' folder disabled in IMAP.

Summary:
We solve this by creating folder rows with a NULL 'name' when we have
the special Gmail label on messages but the corresponding IMAP folder is
disabled. If the folder is later re-enabled, we reconcile the existing
Folder row with the detected folder name, so messages will be properly
synced.

Note that adding `nullable=True` is merely making an existing default
explicit.

Test Plan: Manually disable Important on test account, sync messages, re-enable and verify resolution.

Reviewers: emfree

Reviewed By: emfree

Differential Revision: https://review.inboxapp.com/D232"
kav-ya,2014-07-10 21:37:20,https://api.github.com/repos/nylas/sync-engine/git/commits/0778b1f16210fb727fb188f7c39c235ae2efccd6,0778b1f16210fb727fb188f7c39c235ae2efccd6,Remove old defn. of register_backends() from inbox.mailsync.backends.base
spang,2014-07-09 19:46:53,https://api.github.com/repos/nylas/sync-engine/git/commits/4e807b4751a9115037f3cd0a828b2849b8fad6f7,4e807b4751a9115037f3cd0a828b2849b8fad6f7,"Detect misconfigured Gmail accounts.

Summary:
We require the 'all mail' folder to be enabled via Gmail IMAP. This
commit hard-aborts syncs for accounts that are misconfigured, and
directs the user to fix their account settings.

Test Plan: runtests, manual testing with setting disabled

Reviewers: kav-ya

Reviewed By: kav-ya

Differential Revision: https://review.inboxapp.com/D230"
spang,2014-07-10 00:20:22,https://api.github.com/repos/nylas/sync-engine/git/commits/473bb777ddc1c23fd527b0e4d8ef6a258ed2d1d9,473bb777ddc1c23fd527b0e4d8ef6a258ed2d1d9,"Always use ignore_soft_deletes=False in sync backends.

We do this because otherwise the sync logic becomes horrendously complex.
There were just a couple spots where we'd made this mistake."
kav-ya,2014-07-10 00:21:59,https://api.github.com/repos/nylas/sync-engine/git/commits/736528b3772139ffc1631c4b9976f1294a999ee4,736528b3772139ffc1631c4b9976f1294a999ee4,"* Update _process_log() for drafts.

* Test drafts reconciliation without a sync.
We now do this via two tests:
test_drafts_syncback.test_remote_save_draft() and test_reconcile_message.py,
which each test a separate chunk of that logic."
spang,2014-07-10 00:20:22,https://api.github.com/repos/nylas/sync-engine/git/commits/50274a16eb25462d600cb83ffafa33d4a6c422b9,50274a16eb25462d600cb83ffafa33d4a6c422b9,"Always use ignore_soft_deletes=False in sync backends.

We do this because otherwise the sync logic becomes horrendously complex.
There were just a couple spots where we'd made this mistake."
emfree,2014-07-10 00:20:19,https://api.github.com/repos/nylas/sync-engine/git/commits/ea8f148a07e21fe0d4762d20b691566a7338df8e,ea8f148a07e21fe0d4762d20b691566a7338df8e,"Make bin/clear-db also keep 'secret' table if --with-users isn't specified.

Needed now that auth credentials are stored in that table."
emfree,2014-07-09 23:09:55,https://api.github.com/repos/nylas/sync-engine/git/commits/2e17b617d37abc15dc7e632b11c410ccb1f0f3ea,2e17b617d37abc15dc7e632b11c410ccb1f0f3ea,"Use a less aggressive participant deduplication strategy.

Fixes T123."
spang,2014-07-09 19:46:53,https://api.github.com/repos/nylas/sync-engine/git/commits/428f26fa6a1a22d818713543768b0d8e64f6ef6f,428f26fa6a1a22d818713543768b0d8e64f6ef6f,"Detect misconfigured Gmail accounts.

Summary:
We require the 'all mail' folder to be enabled via Gmail IMAP. This
commit hard-aborts syncs for accounts that are misconfigured, and
directs the user to fix their account settings.

Test Plan: runtests, manual testing with setting disabled

Reviewers: kav-ya

Reviewed By: kav-ya

Differential Revision: https://review.inboxapp.com/D230"
emfree,2014-07-09 19:23:20,https://api.github.com/repos/nylas/sync-engine/git/commits/f31975a1aa5b13534666b4b2c298e32ec3bc9ff0,f31975a1aa5b13534666b4b2c298e32ec3bc9ff0,Deduplicate a thread's participants by email address.
emfree,2014-07-09 19:23:48,https://api.github.com/repos/nylas/sync-engine/git/commits/74f6e47c362b0c840d4df7a10e1b70abc29f5709,74f6e47c362b0c840d4df7a10e1b70abc29f5709,Fix default limit for API resource requests.
emfree,2014-07-09 19:23:48,https://api.github.com/repos/nylas/sync-engine/git/commits/579dad6481c4458fe682440bab7bfbbb31f733aa,579dad6481c4458fe682440bab7bfbbb31f733aa,Fix default limit for API resource requests.
emfree,2014-07-09 18:19:21,https://api.github.com/repos/nylas/sync-engine/git/commits/ee3179cf1ec4cece91c15a5d8f5920941606a559,ee3179cf1ec4cece91c15a5d8f5920941606a559,"Use a gevent pool for actions syncback instead of Redis-plus-workers.

Summary:
This is much simpler, and we were probably going to change this eventually
anyways. The immediate reason for doing it right now is that the rq module
reconfigures the root logger, which is really annoying when you are trying to
actually configure it yourself.

Also, start the SyncbackService as a simple greenlet instead of a ZeroRPC
service (which it isn't really).

Test Plan: Unit tests updated, end-to-end syncback behavior manually verified.

Reviewers: spang

Reviewed By: spang

Differential Revision: https://review.inboxapp.com/D229"
emfree,2014-07-09 18:17:17,https://api.github.com/repos/nylas/sync-engine/git/commits/bfea50d850c7b0fcb8de50802d2378cc9bfed99c,bfea50d850c7b0fcb8de50802d2378cc9bfed99c,Actually configure arcanist correctly.
emfree,2014-07-09 18:13:59,https://api.github.com/repos/nylas/sync-engine/git/commits/4780876f9a2750ffbb0180fea89c99dd58fcfcc5,4780876f9a2750ffbb0180fea89c99dd58fcfcc5,"arc land onto branch 'dev' by default.

Note that you can also do `arc land --onto <branch>`."
spang,2014-07-08 22:45:04,https://api.github.com/repos/nylas/sync-engine/git/commits/2c81b1e0085334856ec2eaa3e6f64d4fc8fa2f36,2c81b1e0085334856ec2eaa3e6f64d4fc8fa2f36,Log auth errors.
kav-ya,2014-07-08 00:19:08,https://api.github.com/repos/nylas/sync-engine/git/commits/4b2138bc044f1785b8d61674e6876d79f4e7dc9c,4b2138bc044f1785b8d61674e6876d79f4e7dc9c,"Fixes T120: resume 'killed' syncs on restart. Also consolidates account sync_state updates.

Summary: As above.

Test Plan: Killed, stopped syncs + restarted server.

Reviewers: emfree

Differential Revision: https://review.inboxapp.com/D227"
kav-ya,2014-07-07 21:52:07,https://api.github.com/repos/nylas/sync-engine/git/commits/0c160c8e787a9019571f358b70633efa13cad466,0c160c8e787a9019571f358b70633efa13cad466,"Support for inbox.util.eas in the /inbox-eas repo; this is where EAS-specific util code would live.

Summary: As above.

Test Plan: Sync runs as before.

Reviewers: spang

Differential Revision: https://review.inboxapp.com/D226"
kav-ya,2014-07-07 15:37:14,https://api.github.com/repos/nylas/sync-engine/git/commits/756014f35dc8c4f714c03d1057681c5dc91dc477,756014f35dc8c4f714c03d1057681c5dc91dc477,"retry_with_logging(), retry_and_report_killed() take optional retry_classes + fail_classes arguments;
it doesn't make sense for retry() to do so otherwise.

Summary: As above.

Test Plan: Test added in tests/general/test_logging.py

Reviewers: emfree

Differential Revision: https://review.inboxapp.com/D225"
emfree,2014-07-08 18:16:46,https://api.github.com/repos/nylas/sync-engine/git/commits/2764644ef47aa8f479336a5d324185d2a94b3066,2764644ef47aa8f479336a5d324185d2a94b3066,Fail more informatively if the inbox package isn't installed.
emfree,2014-07-08 17:27:24,https://api.github.com/repos/nylas/sync-engine/git/commits/bdde00eac620a0f47883645116476141e0c222be,bdde00eac620a0f47883645116476141e0c222be,Properly set snippet and subject/subjectdate on threads.
emfree,2014-07-08 05:18:32,https://api.github.com/repos/nylas/sync-engine/git/commits/150c69cb974dc9f52e106d6fa52c3f5bbbeba136,150c69cb974dc9f52e106d6fa52c3f5bbbeba136,Fix typos in docs.
grinich,2014-07-08 05:10:49,https://api.github.com/repos/nylas/sync-engine/git/commits/44c18f075d6d2faa8d5deb32ee1a24dd98e328c9,44c18f075d6d2faa8d5deb32ee1a24dd98e328c9,Update README.md
emfree,2014-07-08 05:06:30,https://api.github.com/repos/nylas/sync-engine/git/commits/67b1cbd5a6a256a78dd5629fb294d1b0c07dad2a,67b1cbd5a6a256a78dd5629fb294d1b0c07dad2a,Fix typo in message API.
spang,2014-07-07 22:30:59,https://api.github.com/repos/nylas/sync-engine/git/commits/7dd1733c939cabd6f71e21568134c7d5b83b4671,7dd1733c939cabd6f71e21568134c7d5b83b4671,"Only select All Mail folder in console if it exists.

Users can configure which folders are available over IMAP, so sometimes a Gmail account will not have a detected All Mail folder. We shouldn't try to select the folder in that case, so the console can still be used for debugging."
kav-ya,2014-07-07 02:37:57,https://api.github.com/repos/nylas/sync-engine/git/commits/d09e2016ac688db7f588acbb0210ba69e7cc21cc,d09e2016ac688db7f588acbb0210ba69e7cc21cc,"Fix ./runtests so the command-line options work as expected i.e.
./runtests runs provider-agnostic tests only (tests/general, tests/imap)
./runtests -i runs IMAP-specific tests only (tests/imap but not the network tests)
./runtests -a runs all tests.

Also update tests in tests/imap/network."
emfree,2014-07-06 22:06:03,https://api.github.com/repos/nylas/sync-engine/git/commits/53999e21245b9c99992f1db9c0bdb6efecd9c86d,53999e21245b9c99992f1db9c0bdb6efecd9c86d,"Assorted minor documentation updates.

* Update example response bodies to be mostly valid JSON.
* Replace most real people's email addresses with fake ones.
* Clarify a few things.
* Fix typos."
emfree,2014-07-06 20:31:59,https://api.github.com/repos/nylas/sync-engine/git/commits/b255b8f79af27b881f93d3e64e739736ab16326a,b255b8f79af27b881f93d3e64e739736ab16326a,"Limit number of threads and messages that can be requested.

Remove support and documentation for 'set limit=0 for no limit' behavior. This
will just break things if you try to request *all* messages in a mailbox. For
now, don't allow limit arguments greate than 1000."
spang,2014-07-06 18:48:42,https://api.github.com/repos/nylas/sync-engine/git/commits/73526c9b543805561321c48825e5f450325e4ad9,73526c9b543805561321c48825e5f450325e4ad9,Unbreak drafts from previous fix.
spang,2014-07-06 16:46:48,https://api.github.com/repos/nylas/sync-engine/git/commits/dfb9fa09864fd183426ef10ac3153b515bfd24cd,dfb9fa09864fd183426ef10ac3153b515bfd24cd,"Fix handling of DecodeError messages.

All the code that deals properly with handling DecodeError when creating
new Message objects expects to receive None if a message decode fails. A
previous refactor lost this functionality by putting the try block into
the object constructor, which you can't return a different value from. I
solve this by creating an alternate .create() constructor instead."
emfree,2014-07-06 02:52:50,https://api.github.com/repos/nylas/sync-engine/git/commits/8c204f5739898dadebf6db9edc0feac26b7f3a67,8c204f5739898dadebf6db9edc0feac26b7f3a67,"Remove empty file inbox/actions/base.py from repo.

(It was emptied in commit 4cefd279.)"
emfree,2014-07-06 02:42:48,https://api.github.com/repos/nylas/sync-engine/git/commits/c1724c39de2a08f56c7d2e5eb04e73a1a26f3181,c1724c39de2a08f56c7d2e5eb04e73a1a26f3181,"Remove 'Processing log from entry' logspam from SyncbackService.

It really isn't very helpful, and makes it harder to interpret more important
messages logged from the API."
emfree,2014-07-06 02:39:01,https://api.github.com/repos/nylas/sync-engine/git/commits/b0e1e2e0d906e2877be3826ce325a06baaeea338,b0e1e2e0d906e2877be3826ce325a06baaeea338,"Better set sender name for Gmail accounts.

Now it will be the empty string instead of the unfortunate 'None None', if for
some reason we don't have name information stored for the account."
emfree,2014-07-06 02:25:16,https://api.github.com/repos/nylas/sync-engine/git/commits/7094a0f1fe96dadbf5754950d6cefe21ddfe1416,7094a0f1fe96dadbf5754950d6cefe21ddfe1416,"Fix typo in spawning ZeroRPC services.

With this wrong syntax, we weren't actually spawning a new greenlet, instead
just executing the callable. This would prevent the bin/inbox-api and
bin/inbox-start scripts from actually starting all services."
emfree,2014-07-06 01:08:46,https://api.github.com/repos/nylas/sync-engine/git/commits/cd19d61dcc3290f323e449a42ada0e351e1b4819,cd19d61dcc3290f323e449a42ada0e351e1b4819,"Fix bug preventing EAS accounts from being authed.

Commit 4cefd27 removed a few lines from inbox.auth.handler_from_provider that
were needed to auth EAS accounts. Basically, if the provider wasn't Gmail or
Yahoo, we'd always try EAS. This commit does the same thing in
inbox.util.url.provider_from_address. This strategy isn't ideal in the longer
term, but is better than not being able to auth an EAS account at all.)

(Note that nothing changes if EAS support is not installed.)"
spang,2014-07-05 05:41:30,https://api.github.com/repos/nylas/sync-engine/git/commits/15cb60dd85cf2f393d77d13b3a5c578ddf1619c3,15cb60dd85cf2f393d77d13b3a5c578ddf1619c3,"Use a dictionary comprehension

Per Eben's suggestion. Definitely more legible."
spang,2014-07-05 04:42:46,https://api.github.com/repos/nylas/sync-engine/git/commits/1f26687bd64f7b13d46d63aaeb6c8e493711598f,1f26687bd64f7b13d46d63aaeb6c8e493711598f,"status_cb is dead

We've just been passing around a noop function for a while now---this
functionality has been subsumed by keeping metrics info in the database."
spang,2014-07-05 00:51:35,https://api.github.com/repos/nylas/sync-engine/git/commits/388b6ea652ac1c4e3e92c62430b7508b3c25b07f,388b6ea652ac1c4e3e92c62430b7508b3c25b07f,Lint fixes
spang,2014-07-05 04:21:19,https://api.github.com/repos/nylas/sync-engine/git/commits/4cefd279e25dc35d2b89590744db5490b9b18393,4cefd279e25dc35d2b89590744db5490b9b18393,"Make register_backends() implicit.

Summary:
This should remove bugs where we forget to call register_backends(), and
generally remove a lot of code duplication. Backend modules are loaded
transparently upon importing pluggable modules.

We have to be more careful about circular imports, but that can be
mostly avoided by making sure not to put unrelated code in backend
modules (such as the 'oauth' module being under the 'auth' module tree,
or putting top-level methods in a separate 'base' module without also
having a separate 'backends' tree for pluggable implementations.)

Test Plan: ./runtests, start syncs

Reviewers: emfree

Differential Revision: https://review.inboxapp.com/D224"
spang,2014-07-05 04:15:13,https://api.github.com/repos/nylas/sync-engine/git/commits/e0639b80538deebe561dbbc45fab17c71bc8aa79,e0639b80538deebe561dbbc45fab17c71bc8aa79,Missed an instance of uid_validity col rename
spang,2014-07-05 04:00:13,https://api.github.com/repos/nylas/sync-engine/git/commits/7f209a31d4d481f5a955e193398242e37239a34b,7f209a31d4d481f5a955e193398242e37239a34b,Bugfixes from IMAP code refactor.
emfree,2014-07-05 00:56:51,https://api.github.com/repos/nylas/sync-engine/git/commits/1f38f8c1379f6f4c39dbff5dc923726d4a6fbe3d,1f38f8c1379f6f4c39dbff5dc923726d4a6fbe3d,"Clean up filters documentation.

* Regexen don't actually work at this point.
* Be a little more explicit and consistent in wording.
* Fix typos."
emfree,2014-07-04 23:29:58,https://api.github.com/repos/nylas/sync-engine/git/commits/d72520772c7deaca9874f609dee22f359e8e4f06,d72520772c7deaca9874f609dee22f359e8e4f06,"Fix retry counter behavior.

If you use 'retry' as a decorator, turns out you can't instantiate the retry
counter outside the definition of the wrapped function that you return.
Otherwise that one counter instance gets bound to the decorated function. Then
if you do

@retry
def f():
    ...

every successful execution of f() increments the same retry counter. Bad news.

Fix this, and remove the ability for now to pass a customizable retry counter
at all. We aren't using it at the moment, and doing so is clearly fraught with
peril."
spang,2014-07-04 23:45:08,https://api.github.com/repos/nylas/sync-engine/git/commits/30716ed14a67c45f63ad13a754d88338d08150c1,30716ed14a67c45f63ad13a754d88338d08150c1,[SCHEMA] Fix bug in 050 migration for EAS.
spang,2014-07-04 23:23:36,https://api.github.com/repos/nylas/sync-engine/git/commits/98b6e45b5374b9bde9f27107fbe97f110497ce20,98b6e45b5374b9bde9f27107fbe97f110497ce20,Fix alembic rev branch.
spang,2014-07-04 23:12:47,https://api.github.com/repos/nylas/sync-engine/git/commits/ee33f606bc403098d5afb99439ed4abeb6f9c73c,ee33f606bc403098d5afb99439ed4abeb6f9c73c,"[SCHEMA] IMAP table cleanups.

Summary:
This clears up some inconsistencies that have been bothering me for a
while, and should make the code easier to understand for new developers.

The following changes are included:
* tables: FolderSync => ImapFolderSyncStatus
  (other providers such as EAS are first-class citizens)
  - plus _sync_status => _metrics (to not be the status of the status)
* tables: UIDValidity => ImapFolderInfo
  (this table doesn't contain just UIDVALIDITY any more)
* UIDInvalid => UidInvalid to match ImapUid
  (it's awkward to use all caps names especially when both words are
  canonically uppercase)
* Remove duplication of folder_name and use a FK to Folder instead
  (facilitates some optimizations wrt not having to look up folder IDs too)
* Canonicalize 'account' as relationship for IMAP tables to accounts,
  since of course they're always referring to an ImapAccount, and this
  is consistent with EAS.
* Some other minor tweaks and doc updates

Test Plan: Ran mailsync, unit tests

Reviewers: kav-ya

Reviewed By: kav-ya

Differential Revision: https://review.inboxapp.com/D215"
kav-ya,2014-07-04 22:26:00,https://api.github.com/repos/nylas/sync-engine/git/commits/04db6e88ddc4cfb56682fa6b9fbd858b471cbbbd,04db6e88ddc4cfb56682fa6b9fbd858b471cbbbd,"Monocle tweaks:
Links open in same tab/window.
Entire account_id table cell is clickable."
emfree,2014-07-04 22:06:49,https://api.github.com/repos/nylas/sync-engine/git/commits/c1746020a5882dab5112779068fa3e359c84c49f,c1746020a5882dab5112779068fa3e359c84c49f,"Unify our retry logic.

Summary:
Yes, this is the umpteenth iteration of the retry logic. But there are two
reasons to do it:

(1) retry_crispin will currently only retry a bounded number of times, which is
not ideal, since we expect it to retry every couple of hours. With this patch,
it uses our slightly-more-sophisticated failure counter, which resets if there
are no failures for a certain amount of time.

(2) retry_crispin also currently tries to log using logger.log(level, msg),
which is not supported by structlog.

A (trivial) patch updating the EAS code is also ready.

Test Plan: Unit tests updated and sync run.

Reviewers: spang, kav-ya

Reviewed By: spang, kav-ya

Subscribers: kav-ya

Differential Revision: https://review.inboxapp.com/D222"
emfree,2014-07-04 22:06:01,https://api.github.com/repos/nylas/sync-engine/git/commits/fca72387bc6551bb5d8ab1a7e36dda3beb5332e6,fca72387bc6551bb5d8ab1a7e36dda3beb5332e6,"Don't try to store a thread's participants in the thread table.

Summary:
Instead, compute the participants from the thread's messages and latest draft
revisions. Storing extra data on the thread seemed like a good idea for
performance, but it turns out to be tricky to guarantee correctness that
way, at least for now.

The performance hit is unfortunate (doing /threads on mg's huge mailbox on
gunks now takes ~1.7s vs 1.2s), but it's more important to be right than fast
for now.

Similarly, remove the message_public_ids column, which I originally added but
wasn't actually being used.

Fixes T113.

Test Plan:
Unit tests; sent myself a message via the API and checked that its
thread's participants were correctly set.

Reviewers: kav-ya

Reviewed By: kav-ya

Maniphest Tasks: T113

Differential Revision: https://review.inboxapp.com/D221"
kav-ya,2014-07-04 21:17:15,https://api.github.com/repos/nylas/sync-engine/git/commits/0e17ebf8b30ad562a174ff72090e922d9f4492a0,0e17ebf8b30ad562a174ff72090e922d9f4492a0,Monocle makeover.
grinich,2014-07-04 18:17:34,https://api.github.com/repos/nylas/sync-engine/git/commits/cee10b3492ba45e86e520a6ac401910b95c6b10c,cee10b3492ba45e86e520a6ac401910b95c6b10c,headline
emfree,2014-07-04 05:31:47,https://api.github.com/repos/nylas/sync-engine/git/commits/6b41ba9837c933379a2535781cb97f3cd0ee23fc,6b41ba9837c933379a2535781cb97f3cd0ee23fc,"Fix typo in calling verify_account.

verify_account() no longer takes a db_session parameter."
kav-ya,2014-07-04 00:57:38,https://api.github.com/repos/nylas/sync-engine/git/commits/ccca15b272ac7a1904a6567d5ae270d3ad8098be,ccca15b272ac7a1904a6567d5ae270d3ad8098be,"Actually allow startall/stopall as options to ./bin/inbox-sync.
Previously `email_address` was a required arg so we couldn't really use these.

Summary: Self explanatory.

Test Plan: Ran with all option combos.

Reviewers: spang

Reviewed By: spang

Differential Revision: https://review.inboxapp.com/D220"
emfree,2014-07-03 23:01:42,https://api.github.com/repos/nylas/sync-engine/git/commits/96a4824dcd6d97de948afb6b664997a1c00e75c6,96a4824dcd6d97de948afb6b664997a1c00e75c6,"Dependency housecleaning.

Summary:
Remove some unused dependencies and a bit of unused code.  A few of these, like
pyzmq, are only needed by other pip packages we use, so we don't need to
explicitly require them ourselves. Others, like htop, are useful tools but not
actually needed to use Inbox.

Test Plan:
Run a sync and `py.test tests` in a fresh VM with only the new
dependencies installed.

Reviewers: spang

Reviewed By: spang

Differential Revision: https://review.inboxapp.com/D218"
bengotow,2014-07-03 22:13:21,https://api.github.com/repos/nylas/sync-engine/git/commits/15d9824bb61ba4a04b70f868fdbd4b1c5b26f8b6,15d9824bb61ba4a04b70f868fdbd4b1c5b26f8b6,Merge branch 'master' of ssh://github.com/inboxapp/inbox
bengotow,2014-07-03 22:09:38,https://api.github.com/repos/nylas/sync-engine/git/commits/45976e4f1d6d6893fc3a5a85bdfe66cf6a9e1006,45976e4f1d6d6893fc3a5a85bdfe66cf6a9e1006,"Improved installation / getting started docs by clarifying ""Inbox Sync Engine""

Summary: Changes to docs

Test Plan: Read docs

Reviewers: @spang

Subscribers:"
emfree,2014-07-03 19:32:48,https://api.github.com/repos/nylas/sync-engine/git/commits/437ebd252f5bccd5e65c9ce2c24606f4ac692617,437ebd252f5bccd5e65c9ce2c24606f4ac692617,"Move import in old migration.

Apparently doing `alembic stamp head` on a fresh database imports all
migrations, which is a problem if the (otherwise now unneeded) crypto
dependency is missing."
kav-ya,2014-07-03 07:07:34,https://api.github.com/repos/nylas/sync-engine/git/commits/9930020d90d491ee62f0dc5ad6fd51604c5db191,9930020d90d491ee62f0dc5ad6fd51604c5db191,"ConfigError is raised on config dict access, rather than by calling code as per Eben's suggestion."
kav-ya,2014-07-03 06:41:02,https://api.github.com/repos/nylas/sync-engine/git/commits/e22e206e3709c71fc3746474c4b53551f55c2429,e22e206e3709c71fc3746474c4b53551f55c2429,Update docstring for retry_wrapper()
kav-ya,2014-07-02 21:39:42,https://api.github.com/repos/nylas/sync-engine/git/commits/8146c2643fb905b17a6a368613c3348350ea9ff9,8146c2643fb905b17a6a368613c3348350ea9ff9,"retry_wrapper() arg to specify exceptions we don't want to retry.

For most exceptions, we probably want the retrying so retry_wrapper()
takes an optional `exclude` arg to explicitly specify those we *don't* want to retry
on.

Sync runs as before, tests pass."
grinich,2014-07-02 21:40:53,https://api.github.com/repos/nylas/sync-engine/git/commits/71ec4cf380d5cdf0c2478a8daa4efd99cc9c1418,71ec4cf380d5cdf0c2478a8daa4efd99cc9c1418,Remove bullet list
spang,2014-07-02 21:15:18,https://api.github.com/repos/nylas/sync-engine/git/commits/5e85cb3ffdb1b839211895e8fe19865f55b84f50,5e85cb3ffdb1b839211895e8fe19865f55b84f50,"Remove search from README.

Not implemented yet."
grinich,2014-07-02 19:51:40,https://api.github.com/repos/nylas/sync-engine/git/commits/1d7cbf71990723241efea5f5552bf6b78f277392,1d7cbf71990723241efea5f5552bf6b78f277392,remove unused docfiles
kav-ya,2014-07-02 19:23:56,https://api.github.com/repos/nylas/sync-engine/git/commits/5a5dd71f894b7371da5c203ceafece737dc717dd,5a5dd71f894b7371da5c203ceafece737dc717dd,Switch other config asserts to ConfigErrors too.
kav-ya,2014-07-02 19:00:23,https://api.github.com/repos/nylas/sync-engine/git/commits/3eed9567104ef68dd418bebe41cc6b09fbca47f9,3eed9567104ef68dd418bebe41cc6b09fbca47f9,Raise ConfigError rather than assert fail in actions.base
kav-ya,2014-07-02 18:40:34,https://api.github.com/repos/nylas/sync-engine/git/commits/d6565e4998221f5063ebca2a3154b92ee87ef3ab,d6565e4998221f5063ebca2a3154b92ee87ef3ab,"EAS sync status reporting includes run_state, times"
grinich,2014-07-02 18:39:45,https://api.github.com/repos/nylas/sync-engine/git/commits/64434c3d07bf349984984fd43511e113aa5c6b5e,64434c3d07bf349984984fd43511e113aa5c6b5e,Merge branch with full history
emfree,2014-07-02 18:36:32,https://api.github.com/repos/nylas/sync-engine/git/commits/02d0e2334b2fee12df69e35615a3dcdfcaf786ba,02d0e2334b2fee12df69e35615a3dcdfcaf786ba,Properly set minimum transaction id when transaction log is empty.
emfree,2014-07-02 01:26:24,https://api.github.com/repos/nylas/sync-engine/git/commits/e94b5a747c2e892579229b2bf886c3c02351f491,e94b5a747c2e892579229b2bf886c3c02351f491,Fix migration 047 in the case that there aren't actually threads stored.
emfree,2014-07-02 00:14:34,https://api.github.com/repos/nylas/sync-engine/git/commits/8fbc1f8647a1e4f61905a0168a11fc4e70cd735f,8fbc1f8647a1e4f61905a0168a11fc4e70cd735f,"Don't put alembic_ini path in config.

It's always part of the repo right now, and this allows Inbox to work
out-of-the box even if you don't have it in the /vagrant directory."
bengotow,2014-07-01 23:02:46,https://api.github.com/repos/nylas/sync-engine/git/commits/edd1e1a5bfda5eb9ab6f17f71e71bae92b970734,edd1e1a5bfda5eb9ab6f17f71e71bae92b970734,"Updating the documentation to separate ""getting started"" and ""api"" docs into folders, updating copy"
bengotow,2014-06-30 22:09:24,https://api.github.com/repos/nylas/sync-engine/git/commits/f33303ae1135af9f62c1cb62bb71f51f0be847f6,f33303ae1135af9f62c1cb62bb71f51f0be847f6,"Updated Vagrant configuration to fix VMWare, Update /docs to fix typos, formatting. Replace todos with coming soon verbiage, etc.

Summary: Update /docs to fix typos, formatting. Replace todos with coming soon verbiage, etc.

Test Plan: Look over changes, try running on VMWare elsewhere.

Reviewers: charles

Differential Revision: https://review.inboxapp.com/D208"
bengotow,2014-06-18 21:24:39,https://api.github.com/repos/nylas/sync-engine/git/commits/8366fb289c1d83c9902b1c120764b61e81e1019a,8366fb289c1d83c9902b1c120764b61e81e1019a,Updated Vagrant configuration to fix Virtualbox support
emfree,2014-07-01 07:47:42,https://api.github.com/repos/nylas/sync-engine/git/commits/f5f50195e1b053f9e40aa903884b4982188c59dd,f5f50195e1b053f9e40aa903884b4982188c59dd,"Use subqueryload instead of joinedload in certain eager joins.

This seems to be way more performant on big mailboxes."
emfree,2014-07-01 06:35:34,https://api.github.com/repos/nylas/sync-engine/git/commits/a59495b2b3f08f6d158bf8362a2f1c0827f341cb,a59495b2b3f08f6d158bf8362a2f1c0827f341cb,"Update JSON encoder call in api/srv.py.

Boo for bad merges."
emfree,2014-07-01 04:55:44,https://api.github.com/repos/nylas/sync-engine/git/commits/f3b231fcfc71f87c08547cd76a305701dd59190c,f3b231fcfc71f87c08547cd76a305701dd59190c,"Improve API performance, part 2.

Summary:
This commit rewrites APIEncoder to optionally accept and cache a namespace
public id parameter. If we serialize a large number of objects at once,
separately fetching the namespace public id for each object is actually quite
expensive.

Example numbers, running locally on  a set of ~5000 messages and 1000 threads:
```
-----------------------------------------------------------------
                                         |    time in seconds
Query                                    ------------------------
                                         | master |  D210 |  D211
-----------------------------------------------------------------
/threads                                 |  2.73  | 0.426 | 0.210
/messages                                |  2.07  | 0.790 | 0.288
/threads?to=pika-commie@mit.edu          |  2.67  | 0.586 | 0.361
/messages?to=pika-commie@mit.edu         |  4.25  | 0.918 | 0.408
/messages?thread=b5uxk18wzxry97d7xueh7vd7|  0.206 | 0.082 | 0.056
-----------------------------------------------------------------
```

Test Plan: Unit tests and extensive manual testing.

Reviewers: spang

Reviewed By: spang

Differential Revision: https://review.inboxapp.com/D211"
emfree,2014-07-01 04:53:15,https://api.github.com/repos/nylas/sync-engine/git/commits/6ef131e4a316f52da61cad287f27d223da52a819,6ef131e4a316f52da61cad287f27d223da52a819,"[SCHEMA] Improve API performance, part 1.

Summary:
 * Rewrite the code that interprets API query parameters into SQL, and move it
   from models/lens.py to api/filtering.py. Eagerly load a few attributes in
   order to make computing API representations of objects much faster.

 * Store some additional data in Thread objects, so we don't have to compute it
   by loading the thread's messages.

 * Also add a 'profile' decorator in inbox/util/debug.py that can be used for
   selective performance analysis.

Test Plan:
Unit tests updated to directly exercise the API
(tests/api/test_filtering.py)

Reviewers: spang

Reviewed By: spang

Differential Revision: https://review.inboxapp.com/D210"
emfree,2014-07-01 01:48:56,https://api.github.com/repos/nylas/sync-engine/git/commits/ee103bc827baa71e8fd0f81ec043f5c2a75bf8e4,ee103bc827baa71e8fd0f81ec043f5c2a75bf8e4,"Run setup script as part of Vagrant provisioning.

Summary: Might as well save the step of having to run it separately.

Test Plan:
Destroyed a VM and recreated it, running the setup script as part of
provisioning.

Reviewers: charles, spang

Reviewed By: spang

Differential Revision: https://review.inboxapp.com/D214"
spang,2014-07-01 04:25:06,https://api.github.com/repos/nylas/sync-engine/git/commits/147ad0dc3a7a0af1b2a5df146bec23bb03ed5954,147ad0dc3a7a0af1b2a5df146bec23bb03ed5954,"[SCHEMA] Alpha Yahoo mail sync support.

Summary:
Current caveats:
* No threading support. (Each message is a new thread.)
* No flag synchronization support.
* No actions support.
* No sending/drafts reconcilation.

Read-only mail synchronization totally works though.

Test Plan: Full sync of test account + made sure Gmail still works.

Reviewers: kav-ya

Reviewed By: kav-ya

Differential Revision: https://review.inboxapp.com/D212"
emfree,2014-07-01 01:15:22,https://api.github.com/repos/nylas/sync-engine/git/commits/909240e25d29a765ef40b3546ae158ac3a5e4e69,909240e25d29a765ef40b3546ae158ac3a5e4e69,Remove deprecated search script.
spang,2014-06-30 22:17:26,https://api.github.com/repos/nylas/sync-engine/git/commits/420123ed752bba442cceafde112aecbe6a5508f7,420123ed752bba442cceafde112aecbe6a5508f7,Don't select 'All Mail' in console for non-Gmail accounts.
emfree,2014-06-30 20:55:37,https://api.github.com/repos/nylas/sync-engine/git/commits/ba64ee728a8aee4bca4593125eb2a19d1748fa04,ba64ee728a8aee4bca4593125eb2a19d1748fa04,"[SCHEMA] Remove encrypted-password-storage schema from base Account object.

Summary:
Instead, Account subclasses for providers that use password auth (YahooAccount,
EASAccount) should just store a 'password' field directly.

Test Plan:
Tested the migration with one EAS account, and auth after applying
this patch with another. Both work.

Reviewers: spang

Reviewed By: spang

Differential Revision: https://review.inboxapp.com/D206"
spang,2014-06-30 21:16:44,https://api.github.com/repos/nylas/sync-engine/git/commits/2869627b5099dbe82c62012c9a4e399e31f364f1,2869627b5099dbe82c62012c9a4e399e31f364f1,"Fix typo

This has been driving me nuts!"
spang,2014-06-30 19:28:34,https://api.github.com/repos/nylas/sync-engine/git/commits/ccfadfb28d1cf4201fffd044be4a024737f4cb29,ccfadfb28d1cf4201fffd044be4a024737f4cb29,"--dummy arg no longer supported.

We ripped out this [incomplete] functionality some time ago."
emfree,2014-06-30 17:38:09,https://api.github.com/repos/nylas/sync-engine/git/commits/762366062a0c92b0d49aaf27e1d67fa25f5c196c,762366062a0c92b0d49aaf27e1d67fa25f5c196c,"[SCHEMA] Refactor several pieces of draft logic.

Summary:
* Make create_and_save_draft() a provider-independent function that just
  directly creates a SpoolMessage with the desired attributes. This eliminates
  duplicated code across repos. Also fixes an issue in which new drafts
  appeared as unread messages.

* Don't copy/fork drafts on conflicting updates. Instead fail with 409 on an
  attempt to post to a draft that has already been updated.

* Eliminate the intermediate DraftThread object. Instead just set
  SpoolMessage.thread_id to reference the draft you're replying to. This fixes
  an issue with the /threads API call, in which we'd create a new draft object
  that contained only the draft. But then both the original thread and
  the newly-created one would be returned by /threads, and both would contain
  the draft public id in their 'drafts' field.

* Modify tests to directly exercise the API for more coverage.

* Fix an argument typo in which we couldn't sync back drafts with attachments.

* Allow tags to be set on draft creation.

Test Plan: Unit tests are in-progress.

Reviewers: kav-ya

Reviewed By: kav-ya

Differential Revision: https://review.inboxapp.com/D192"
grinich,2014-06-29 21:12:54,https://api.github.com/repos/nylas/sync-engine/git/commits/aa4f92b15731870724a95893e67127fa7b6b3d6f,aa4f92b15731870724a95893e67127fa7b6b3d6f,try adding headers before starting app
grinich,2014-06-29 19:22:50,https://api.github.com/repos/nylas/sync-engine/git/commits/6322d3adf15723df9f5e69fd1e51597b9784e642,6322d3adf15723df9f5e69fd1e51597b9784e642,Remove not-yet-implemented namespace properties
grinich,2014-06-29 05:54:15,https://api.github.com/repos/nylas/sync-engine/git/commits/7971aee382d066da03eb9a119bfdc3f34a714312,7971aee382d066da03eb9a119bfdc3f34a714312,Merge from old repo to have full history
emfree,2014-06-28 00:52:42,https://api.github.com/repos/nylas/sync-engine/git/commits/fa5017bef812802da0e6dc5dcb32ab839d3cd3a9,fa5017bef812802da0e6dc5dcb32ab839d3cd3a9,"[DEPENDENCIES] Upgrade to SQLAlchemy 0.9.6.

Summary:
The proximal reason for this is to take advantage of the new load_only feature
(http://docs.sqlalchemy.org/en/rel_0_9/changelog/migration_09.html#new-query-options-api-load-only-option),
which we could employ for great gains in performance.

I've been running this version for a bit locally with no obvious breakages, and
don't see anything in the changelog that would affect us.

Test Plan: Unit tests and local syncing.

Reviewers: spang

Reviewed By: spang

Differential Revision: https://review.inboxapp.com/D204"
emfree,2014-06-27 20:57:41,https://api.github.com/repos/nylas/sync-engine/git/commits/8f6839379b026dfe75ea35bb07e156dbe85bb669,8f6839379b026dfe75ea35bb07e156dbe85bb669,"Fix case-sensitivity bug when updating Gmail labels.

We now coerce all label names to lowercase, so we need to compare to lowercase
strings when dealing with Gmail's special labels."
kav-ya,2014-06-25 01:14:27,https://api.github.com/repos/nylas/sync-engine/git/commits/a9231a44c03b503f370068c8b4184dba7a98e221,a9231a44c03b503f370068c8b4184dba7a98e221,Remove extra migration
spang,2014-06-25 01:05:22,https://api.github.com/repos/nylas/sync-engine/git/commits/f75b6dc01862d6c9cf91e309b43e60299181a202,f75b6dc01862d6c9cf91e309b43e60299181a202,"Rip out old in-memory/ZeroRPC status interface.

Summary: This has been deprecated by Kavya's sweet new status dashboard.

Test Plan: runtests, git grep for places where this code was used

Reviewers: kav-ya

Reviewed By: kav-ya

Differential Revision: https://review.inboxapp.com/D198"
kav-ya,2014-06-24 23:59:56,https://api.github.com/repos/nylas/sync-engine/git/commits/d9f376aee50709ced29ca67f4b9772d5c72c20d6,d9f376aee50709ced29ca67f4b9772d5c72c20d6,"Include Running/ Stopped/ Killed in sync status metrics, for both account + folders (Updated).

Summary:
Running is self explanatory.
Stopped: via sync-stop/cntrl-c
Killed: by an uncaught exception

Test Plan:
Visual app inspection.

Reviewers:
spang

Differential Revision:
https://review.inboxapp.com/D194"
kav-ya,2014-06-24 23:08:30,https://api.github.com/repos/nylas/sync-engine/git/commits/aecaee40694a703210c6b561218e2df039fefa59,aecaee40694a703210c6b561218e2df039fefa59,Fix failing tests.
kav-ya,2014-06-24 23:10:27,https://api.github.com/repos/nylas/sync-engine/git/commits/4d48923324a8097b027ec47e957ccb18ea19d206,4d48923324a8097b027ec47e957ccb18ea19d206,"Revert ""Include Running/ Stopped/ Killed in sync status metrics, for both account + folders.""

This reverts commit 456d38ddc949b10f9835432130cacfeeacb70c15."
kav-ya,2014-06-24 02:26:21,https://api.github.com/repos/nylas/sync-engine/git/commits/456d38ddc949b10f9835432130cacfeeacb70c15,456d38ddc949b10f9835432130cacfeeacb70c15,"Include Running/ Stopped/ Killed in sync status metrics, for both account + folders.

Summary:
Running is self explanatory.
Stopped: via sync-stop/cntrl-c
Killed: by an uncaught exception

Test Plan: Visual app inspection.

Reviewers: spang

Differential Revision: https://review.inboxapp.com/D194"
emfree,2014-06-24 22:16:31,https://api.github.com/repos/nylas/sync-engine/git/commits/3899ae73928fe4bbe47b9d13d43f38f24aa6ca2b,3899ae73928fe4bbe47b9d13d43f38f24aa6ca2b,"[SCHEMA] Add support for per-message unread marking, and the unseen tag.

Summary:
 * Don't store 'user_mutable' as a column in the tags table. Instead, implement
   properties tag.user_addable and tag.user_removable (these are distinct,
   since the 'unseen' tag may be removed but not added).

 * Add API support for setting a message's unread attribute.

 * Automatically remove the unseen tag when the unread tag is removed.

 * Update documentation.

Test Plan: Unit tests updated.

Reviewers: spang

Reviewed By: spang

Differential Revision: https://review.inboxapp.com/D195"
emfree,2014-06-24 21:01:24,https://api.github.com/repos/nylas/sync-engine/git/commits/fadcde349a54a86e3ebc9151527de1397f4de803,fadcde349a54a86e3ebc9151527de1397f4de803,Add gmailaccount to list of tables to keep in bin/clear-db.
emfree,2014-06-24 20:51:28,https://api.github.com/repos/nylas/sync-engine/git/commits/0fd950130060078ac7c7015fb90e04af72faf384,0fd950130060078ac7c7015fb90e04af72faf384,"Truncate tag names corresponding to long backend folder names.

We were already truncating long folder names, but because the associated tag
name was 'gmail-<folder name>', it was still too long.

Also validate tag name length when tags are created via the API.

Fixes T81."
kav-ya,2014-06-24 02:17:37,https://api.github.com/repos/nylas/sync-engine/git/commits/53e8b69f6f3bfc6e7fc4a248ec73b42a0bb8d9b0,53e8b69f6f3bfc6e7fc4a248ec73b42a0bb8d9b0,Fix bug in retry_wrapper: gevent.GreenletExit is not an Exception
spang,2014-06-23 23:50:26,https://api.github.com/repos/nylas/sync-engine/git/commits/c1659568653905bbf1d19ec9e37722a26d3e1db7,c1659568653905bbf1d19ec9e37722a26d3e1db7,Remove unused imports
spang,2014-06-23 23:40:35,https://api.github.com/repos/nylas/sync-engine/git/commits/89cc98d7a41718007fe3af4d196508d26206b4a6,89cc98d7a41718007fe3af4d196508d26206b4a6,Bump imapclient dep to latest
emfree,2014-06-23 19:10:28,https://api.github.com/repos/nylas/sync-engine/git/commits/85ee171bfb596f178fb14bca676b14b672adc982,85ee171bfb596f178fb14bca676b14b672adc982,"Remove API support for deprecated '/messages/all', '/files/all' calls.

Clients should just do '/messages/' or '/files/' instead."
emfree,2014-06-23 18:24:55,https://api.github.com/repos/nylas/sync-engine/git/commits/fde6b3debf1a879af354208ee093da49e726790b,fde6b3debf1a879af354208ee093da49e726790b,"Update import path for ignition module.

For a while we had duplicate inbox.ignition and inbox.models.ignition imports.
Commit 27d6f1 removed the latter."
kav-ya,2014-06-22 03:32:42,https://api.github.com/repos/nylas/sync-engine/git/commits/b4cc002c337702dc3b8012858ac6864db7f2ecc7,b4cc002c337702dc3b8012858ac6864db7f2ecc7,Quick + dirty link to per-account page from /accounts.
kav-ya,2014-06-21 23:38:32,https://api.github.com/repos/nylas/sync-engine/git/commits/7cc741fb4e0335f68016880f3512f57d49591cfc,7cc741fb4e0335f68016880f3512f57d49591cfc,"Fix bug in selective updating of metrics in update_uids_counts().
Tested by running ben.bitdiddle sync.

App formatting changes: bold column headings, acc sync_status as Active/Inactive rather than booleans."
spang,2014-06-21 23:37:31,https://api.github.com/repos/nylas/sync-engine/git/commits/ed978142081253d5debc28a8fa35770bfbd09c62,ed978142081253d5debc28a8fa35770bfbd09c62,"Use platform.node() instead of socket.getfqdn().

See https://github.com/ansible/ansible/issues/2663. We need to revisit
this code when we do sharding for real, but this is a quick fix to
socket.fqdn() weirdly returning 'localhost' for now."
kav-ya,2014-06-21 19:53:10,https://api.github.com/repos/nylas/sync-engine/git/commits/03e3e9a1872601b814fb01314f3cf38fa90895f7,03e3e9a1872601b814fb01314f3cf38fa90895f7,Changes to support EAS sync status reporting
spang,2014-06-21 19:48:00,https://api.github.com/repos/nylas/sync-engine/git/commits/3bbe1117755fa8b37f2fc182311dd6866e55e820,3bbe1117755fa8b37f2fc182311dd6866e55e820,Update docstring.
spang,2014-06-21 18:21:13,https://api.github.com/repos/nylas/sync-engine/git/commits/ac127b53a8bddd874552848fa0e98b2c2d901c84,ac127b53a8bddd874552848fa0e98b2c2d901c84,"Enable TTY logging handler even if outputting to non-TTY.

We're going to start running mailsync under supervisor with main output
to a logfile, and just redirecting the existing screen output (including
colours) is the simplest thing we can do to get going with the
transition."
kav-ya,2014-06-21 19:08:58,https://api.github.com/repos/nylas/sync-engine/git/commits/5b2eab6beb6b317bab40d61c76de3b111484207b,5b2eab6beb6b317bab40d61c76de3b111484207b,"Sync status reporting + dashboard v1

Sync status
-----------
To calculate mailsync status and progress, we track the following metrics,
and store them in the FolderSync tables -

Before we start downloading messages:
remote_uid_count, using crispin_client.all_uids()
num_to_download
num_to_delete
num_to_update
timestamp

If the state is `initial` rather than `poll`, we also store
sync_type i.e. starting anew or resuming, determined by the cache state.

As we download:
num_downloaded_so_far since timestamp
num_left_to_download

Dashboard app
-------------
A basic Flask app is in inbox/monocle
To run it:
python inbox/monocle/app.py
go to http://0.0.0.0:5000/accounts or http://0.0.0.0:5000/accounts/{account_id}

Test Plan:
Visual inspection using the app.
tests/general/test_mutable_json_type.py

Reviewers: spang

Reviewed By: spang

Subscribers: emfree

Differential Revision: https://review.inboxapp.com/D182"
spang,2014-06-21 03:58:55,https://api.github.com/repos/nylas/sync-engine/git/commits/5ea1a81b40b90f6622ee377896f1d704228f361a,5ea1a81b40b90f6622ee377896f1d704228f361a,Ignore a bunch of bin/.
spang,2014-06-20 18:34:22,https://api.github.com/repos/nylas/sync-engine/git/commits/0cccd5651459cc7fce70409a3e8fa759e6139a89,0cccd5651459cc7fce70409a3e8fa759e6139a89,Remove outdated config setup from README.md.
kav-ya,2014-06-20 16:35:59,https://api.github.com/repos/nylas/sync-engine/git/commits/a02c9365be2193eac691db57707c56f3f4ad360d,a02c9365be2193eac691db57707c56f3f4ad360d,Standardize on single quotes for string literals
kav-ya,2014-06-19 21:11:40,https://api.github.com/repos/nylas/sync-engine/git/commits/35e6d9a3b1508762f4adaa81bcd373dc71ffef27,35e6d9a3b1508762f4adaa81bcd373dc71ffef27,Fix typo in auth_types check (inbox.models.account)
grinich,2014-06-19 00:09:46,https://api.github.com/repos/nylas/sync-engine/git/commits/5c90dce74d676b47a55e34e4b35ccb77f124af63,5c90dce74d676b47a55e34e4b35ccb77f124af63,"Add GmailAccount

Summary:
Adds new GmailAccount which inherits from ImapAccount to provide storage of Gmail-specific properties, such as access tokens and OAuth details. This also removes prefixes, so account.o_access_token becomes account.access_token in the case of a GmailAccount.

This commit also cleans up some ForeignKey references to use classes+attributes
instead of strings. ie: Lens.id instead of 'lens.id'

Providers now user all lowercase names. e.g. 'gmail'. OAuth is also now keyed
as 'oauth' to avoid bugs in string comparisons.

Both ImapAccount and EASAccount inherit from the base Account table/class.

Test Plan: Tests don't pass yet because the database needs a migration.

Reviewers: mg, spang

Reviewed By: mg, spang

Subscribers: emfree

Differential Revision: https://review.inboxapp.com/D189"
emfree,2014-06-18 21:02:31,https://api.github.com/repos/nylas/sync-engine/git/commits/f9c2280a44bac5b9abb35ebd77a139585a423739,f9c2280a44bac5b9abb35ebd77a139585a423739,"Handle API endpoints with or without trailing slashes, without redirecting.

Summary:
Note that by applying this globally, we're being permissive not just
for, say, `/threads/` vs `/threads`, but also for
`/threads/ckjjbxbxda48hr07fvqu644pj` vs `/threads/ckjjbxbxda48hr07fvqu644pj/`.
If this isn't intended behavior, we should instead set strict_slashes=False
only on specific endpoints.

Test Plan: Do `curl http://localhost:5555/n` and `curl http://localhost:5555/n/`.

Reviewers: mg

Reviewed By: mg

Differential Revision: https://review.inboxapp.com/D191"
emfree,2014-06-18 05:22:09,https://api.github.com/repos/nylas/sync-engine/git/commits/2ea8c78ea672a572abeb0e1885431c2e6eaad05d,2ea8c78ea672a572abeb0e1885431c2e6eaad05d,"Enable pytest coverage reports in arcanist.

Apparently the only thing stopping us from having this was my inability to
do even the most trivial things in PHP."
kav-ya,2014-06-17 21:21:46,https://api.github.com/repos/nylas/sync-engine/git/commits/7f1b6e602fc67b0568553929f0637aa6e19f22b6,7f1b6e602fc67b0568553929f0637aa6e19f22b6,Lint bin/ scripts
emfree,2014-06-17 06:32:39,https://api.github.com/repos/nylas/sync-engine/git/commits/c84d969f5fbb759b104d6ae97d8f80383c11564f,c84d969f5fbb759b104d6ae97d8f80383c11564f,"Don't call drop_everything() when tearing down the test db fixture.

Summary:
This call is failing with an odd sqlalchemy ResourceClosedError in certain
configurations of some tests for the drafts API that I'm working on.
I really don't know why. But in any case we don't actually need it since we
load the database dump from scratch for each test. In fact, eliminating it
makes the tests run a few seconds faster.

Test Plan: py.test tests

Reviewers: spang

Reviewed By: spang

Differential Revision: https://review.inboxapp.com/D188"
emfree,2014-06-17 21:09:14,https://api.github.com/repos/nylas/sync-engine/git/commits/a4f61ed3244cc6b350329abe34fc228f8a79caf1,a4f61ed3244cc6b350329abe34fc228f8a79caf1,"Update API endpoints for resource lists to include a trailing slash.

Updated endpoints are:
/threads/
/messages/
/contacts/
/tags/
/webhooks/
/files/

The equivalents without trailing-slash will redirect."
emfree,2014-06-17 19:26:16,https://api.github.com/repos/nylas/sync-engine/git/commits/e8ca9a3c2cc1889cda495441df858b4615aea22b,e8ca9a3c2cc1889cda495441df858b4615aea22b,"Construct database engine after importing config overrides in startup scripts.

If we construct the engine (and configure logging) before parsing command-line
arguments, then we aren't reading from any configuration file you might pass.
The proximate goal here is to serve from the test database dump via
bin/inbox-api -c tests/config-test.json"
kav-ya,2014-06-17 21:13:46,https://api.github.com/repos/nylas/sync-engine/git/commits/696f999be133ffa9a90f3d2f65051922e25a2ca2,696f999be133ffa9a90f3d2f65051922e25a2ca2,Remove unused 'group_uids_by_thread' fn in mailsync/backends/gmail.py
kav-ya,2014-06-17 19:33:50,https://api.github.com/repos/nylas/sync-engine/git/commits/22611ddefa98a887ba6e4a31a10cea336adf0ed9,22611ddefa98a887ba6e4a31a10cea336adf0ed9,"/thread/<public_id> API call returns both 'messages' and 'drafts'.
Test added in tests/imap/test_drafts.py"
emfree,2014-06-17 18:57:03,https://api.github.com/repos/nylas/sync-engine/git/commits/27d6f1b86a1fc20b7845a9806fe523e9c1634423,27d6f1b86a1fc20b7845a9806fe523e9c1634423,"Remove duplicated ignition.py file.

We had both inbox/ignition.py and inbox/models/ignition.py. All imports are
from inbox.ignition, not inbox.models.ignition, so remove the latter."
emfree,2014-06-17 03:54:10,https://api.github.com/repos/nylas/sync-engine/git/commits/4a712172760f15ca8488a9b6e9ff69f66edb00e5,4a712172760f15ca8488a9b6e9ff69f66edb00e5,"Add tests/data to pytest norecursedirs.

pytest was taking forever to collect tests because it was recursing through all
the deeply nested directories in tests/data/parts. By not doing this we cut the
collection time from about 30 to 3 seconds."
emfree,2014-06-17 00:30:13,https://api.github.com/repos/nylas/sync-engine/git/commits/decefdebdd3deb8e5a5459b8823dcf4a08768a66,decefdebdd3deb8e5a5459b8823dcf4a08768a66,"Remove duplicate TagItem definition.

Fixes T75."
emfree,2014-06-16 17:46:41,https://api.github.com/repos/nylas/sync-engine/git/commits/5d3e5810ab31ac00dce049ec516e8dcad220f0d4,5d3e5810ab31ac00dce049ec516e8dcad220f0d4,"Update API message representation.

Summary:
Don't expose tags on messages, but do expose unread status.

Also consolidate computing SpoolMessage and Message representations, removing
duplicate code.

Test Plan: Check the /messages API query.

Reviewers: kav-ya

Reviewed By: kav-ya

Subscribers: bengotow

Differential Revision: https://review.inboxapp.com/D187"
emfree,2014-06-15 23:00:49,https://api.github.com/repos/nylas/sync-engine/git/commits/96f34587d461870216746bc352d59b218a246f7f,96f34587d461870216746bc352d59b218a246f7f,"Don't call gevent.monkey.patch_all() in api/srv.py.

It breaks the api_client fixture in the tests in really weird ways, and isn't
actually needed. (We monkey-patch in bin/inbox-api, and gunicorn's GeventWorker
does it too: https://github.com/benoitc/gunicorn/blob/master/gunicorn/workers/ggevent.py#L170)"
emfree,2014-06-15 22:31:53,https://api.github.com/repos/nylas/sync-engine/git/commits/b6bbd94671c111328c177b8e2035f68467f1af39,b6bbd94671c111328c177b8e2035f68467f1af39,"Simplify configuration of test_lens.py.

We were reading test values for the received_date parameter, etc.  by parsing a
saved mime message, which didn't really make a ton of sense. Instead just get
test values by querying the database for a test message."
grinich,2014-06-14 23:14:13,https://api.github.com/repos/nylas/sync-engine/git/commits/2570afe94936eae787555437e0961512a074a64b,2570afe94936eae787555437e0961512a074a64b,"Split database models into individual modules.

This is a pretty big patch, but it's largely refactoring and not much new code.

- Removal of ""tables"" module, bumping those items up one level
- All database models are available through `inbox.models`
- `create_message` function is now part of `Message` object constructor.
  This also means that attributes of `Message` objects must be set manually
  in the tests instead of just passing keyword args.
- Lots of misc things moved around and cleaned up"
grinich,2014-06-14 23:14:13,https://api.github.com/repos/nylas/sync-engine/git/commits/5603049edb86cd9376e4456df5033254205b6c7e,5603049edb86cd9376e4456df5033254205b6c7e,update for inbox package location
grinich,2014-06-14 21:50:00,https://api.github.com/repos/nylas/sync-engine/git/commits/d7d2edbb78c8a8201420a2a23baf674eee0bd78e,d7d2edbb78c8a8201420a2a23baf674eee0bd78e,grey out slow query traces and params
grinich,2014-06-14 19:47:18,https://api.github.com/repos/nylas/sync-engine/git/commits/be5acbf62568e228ae87d9b4c85d95aa63fadbe5,be5acbf62568e228ae87d9b4c85d95aa63fadbe5,Fixes a bug where dev machine timezone affects parsing of test dates
grinich,2014-06-14 00:22:03,https://api.github.com/repos/nylas/sync-engine/git/commits/82d40ba6724eb9fb4022c0444f33208f635877b3,82d40ba6724eb9fb4022c0444f33208f635877b3,move inbox.models.message -> inbox.models.message_util
spang,2014-06-14 01:20:01,https://api.github.com/repos/nylas/sync-engine/git/commits/e784dffe3852800ee42311a6bdc0722fdfb6ff5d,e784dffe3852800ee42311a6bdc0722fdfb6ff5d,"[DEPENDENCIES] Don't install supervisor from PyPI.

This just doesn't seem to work on Debian/Ubuntu; use the version from
APT instead, which we already install in setup.sh. If you are attempting
to run a proper prod setup, you will wish to 'pip uninstall supervisor'.
(If this doesn't work, you'll have to manually remove the files in
/usr/local.)"
spang,2014-06-14 00:53:28,https://api.github.com/repos/nylas/sync-engine/git/commits/37e9d47b693b0ad8d1b28e1fbf9c9d64946fcc68,37e9d47b693b0ad8d1b28e1fbf9c9d64946fcc68,"Patch gevent.pywsgi.WSGIHandler in inbox.api.srv.

This way it will work properly when run from gunicorn (e.g. under
supervisor) as well as when run from bin/inbox-api (for development)."
spang,2014-06-14 00:51:10,https://api.github.com/repos/nylas/sync-engine/git/commits/bae24cc14787c3644fc035a6650939c970e578f5,bae24cc14787c3644fc035a6650939c970e578f5,[DEPENDENCIES] Use latest gunicorn.
grinich,2014-06-14 00:12:42,https://api.github.com/repos/nylas/sync-engine/git/commits/ef244c60132be50f131d735a3f75ecb39c718da8,ef244c60132be50f131d735a3f75ecb39c718da8,Inherit from `MailSyncBase` abstract class
emfree,2014-06-13 18:30:03,https://api.github.com/repos/nylas/sync-engine/git/commits/d1aa82f300667382464fd6983a2f89e2e13d453e,d1aa82f300667382464fd6983a2f89e2e13d453e,"Revert ""Add imaplib.IMAP4.abort to exception classes for retry_crispin.""

imaplib.IMAP4.abort is actually a subclass of imaplib.IMAP4.error, so adding it
to CONN_DISCARD_EXC_CLASSES wasn't doing anything.

This reverts commit 230c0f7ddc3effdfe8479611609105d71e5f1617."
emfree,2014-06-13 17:56:47,https://api.github.com/repos/nylas/sync-engine/git/commits/bbf7554eda024e51589dc6e59533fc92f9c7bd79,bbf7554eda024e51589dc6e59533fc92f9c7bd79,"Sync modified gmail labels on existing, fully-synced threads.

Summary:
If we had already fully synced a thread, and you added or removed a label on it
in the Gmail web interface, we wouldn't persist that modification when we
called update_metadata(). This change fixes that. It also simplifies some logic
dealing with label name case-sensitivity, because we're now exposing them in
lowercase anyways.

Test Plan: Manual sync testing.

Reviewers: spang

Reviewed By: spang

Differential Revision: https://review.inboxapp.com/D180"
kav-ya,2014-06-13 17:27:37,https://api.github.com/repos/nylas/sync-engine/git/commits/5c3e87cbb25bffa01bd4662e51a11ff4aa6f3f77,5c3e87cbb25bffa01bd4662e51a11ff4aa6f3f77,Fix incorrect condition check in draft_delete_api().
emfree,2014-06-13 08:36:16,https://api.github.com/repos/nylas/sync-engine/git/commits/230c0f7ddc3effdfe8479611609105d71e5f1617,230c0f7ddc3effdfe8479611609105d71e5f1617,"Add imaplib.IMAP4.abort to exception classes for retry_crispin.

This is so that we can retry on imaplib.IMAP4.abort('socket error: EOF')
errors."
emfree,2014-06-13 08:32:52,https://api.github.com/repos/nylas/sync-engine/git/commits/b15101e654c36cf81c422b7253e86e1a92a98706,b15101e654c36cf81c422b7253e86e1a92a98706,"Revert to events_end terminology in client sync API; update semantics.

Instead of returning events in the interval [events_start, next_event), return
events in the interval (events_start, events_end]. This means that clients can
poll on /sync/events?stamp=<events_end value> to check for new events."
kav-ya,2014-06-12 23:26:37,https://api.github.com/repos/nylas/sync-engine/git/commits/a1d6e44cfcbd187348b95b9d5f927ed6f7f624d9,a1d6e44cfcbd187348b95b9d5f927ed6f7f624d9,Don't rename unique constraint
kav-ya,2014-06-12 23:16:27,https://api.github.com/repos/nylas/sync-engine/git/commits/1066ac55fcb0d8701ed55388765b993efcb63d83,1066ac55fcb0d8701ed55388765b993efcb63d83,"Migration to change unique constraint on EASFolderSync table.
Previous unique constraint was account_id to folder_name, but it really should be account_id to eas_folder_id since
only that is guaranteed to be unique."
emfree,2014-06-12 22:30:29,https://api.github.com/repos/nylas/sync-engine/git/commits/48907cd81711ed8ad2fa9b6b7f458dc977a3a817,48907cd81711ed8ad2fa9b6b7f458dc977a3a817,"Rename parameter to 'order_by' in message, thread and contacts API queries.

Previously called 'order'."
emfree,2014-06-12 21:37:40,https://api.github.com/repos/nylas/sync-engine/git/commits/3adeba5ecdfd2940e04b828a1ac227634e6c0997,3adeba5ecdfd2940e04b828a1ac227634e6c0997,Actually set content-type for webhooks post body.
emfree,2014-06-12 21:09:33,https://api.github.com/repos/nylas/sync-engine/git/commits/ee27ec5a6b5d6669fd00a2dc95e7bf9006d3de03,ee27ec5a6b5d6669fd00a2dc95e7bf9006d3de03,"[DEPENDENCIES] Delete old search code.

We're not going to use any of this and it's breaking inbox-start."
emfree,2014-06-12 18:25:02,https://api.github.com/repos/nylas/sync-engine/git/commits/450e7c37ec21c255cb8a22a36b33f0fd5b33ecd8,450e7c37ec21c255cb8a22a36b33f0fd5b33ecd8,Update client sync docs.
emfree,2014-06-12 00:42:25,https://api.github.com/repos/nylas/sync-engine/git/commits/5eb3b1b3b94659ef673d0abd7b74ab549d8fdd1c,5eb3b1b3b94659ef673d0abd7b74ab549d8fdd1c,"Get crispin client inside code wrapped by retry_crispin, not outside.

Summary:
We were passing a crispin_client instance to functions wrapped by
`@retry_crispin`. That meant that if Gmail closed the connection, we'd be
retrying with the *same* connection, leading to inevitable failure.

Instead, pass the connection pool, and get a new client from within the wrapped
code. This way we'll use a new connection on retry.

Test Plan:
I ran side-by-side syncs with and without this change. Both
eventually logged a ""socket error: EOF"". The sync with this change successfully
retried with a new connection, the sync without retried several times before
aborting.

Reviewers: spang

Reviewed By: spang

Differential Revision: https://review.inboxapp.com/D181"
emfree,2014-06-12 00:34:40,https://api.github.com/repos/nylas/sync-engine/git/commits/d115d61aa706ffbb01cba641d9409dc2d859387e,d115d61aa706ffbb01cba641d9409dc2d859387e,Use standard requests package instead of forked version.
emfree,2014-06-11 22:20:19,https://api.github.com/repos/nylas/sync-engine/git/commits/9515571b3f9f8416bbe52505181a5e48cf9df976,9515571b3f9f8416bbe52505181a5e48cf9df976,"Support ordering API thread/message results by subject or date.

Addresses T57."
emfree,2014-06-11 19:23:23,https://api.github.com/repos/nylas/sync-engine/git/commits/825c72ebb7892cf3edd3ea2db0d33a75bc9b3606,825c72ebb7892cf3edd3ea2db0d33a75bc9b3606,"[DEPENDENCIES] Switch back to upstream geventconnpool.

@spang's PR got merged."
emfree,2014-06-11 19:21:40,https://api.github.com/repos/nylas/sync-engine/git/commits/5c2c9ba10b87d4eaaadec296461013cc07f2e2d8,5c2c9ba10b87d4eaaadec296461013cc07f2e2d8,Update client sync tests to use changed parameter name.
emfree,2014-06-11 18:19:20,https://api.github.com/repos/nylas/sync-engine/git/commits/0258a299e8a91a89d36e751924e9b8fc47c046f1,0258a299e8a91a89d36e751924e9b8fc47c046f1,"Fix client sync error when diffing against old transactions.

transaction.public_snapshot may not be set for old transactions, so don't try
to compare against it if it's None."
emfree,2014-06-11 18:18:10,https://api.github.com/repos/nylas/sync-engine/git/commits/6b950fd8aa3eca36204aa0bb37756ee049c4158e,6b950fd8aa3eca36204aa0bb37756ee049c4158e,"Disable autoflush for all of add_gmail_attrs().

Otherwise a distinct transaction is created for each updated tag on a thread,
which is annoying."
emfree,2014-06-11 17:29:10,https://api.github.com/repos/nylas/sync-engine/git/commits/042e35d4640b38a047272365d9c260a667e7e241,042e35d4640b38a047272365d9c260a667e7e241,"[SCHEMA] Client sync API, version 1.

Summary:
 * Modify the Transaction schema, replacing the 'additional_data' field by the
   'public_snapshot' field. When we generate a transaction log entry for an
   object `obj`, use 'public_snapshot' to store the API representation of obj
   at that time. (This lets us easily filter and expose transaction log entries
   in the API).

 * Simplify the code in models/revision.py(delta), removing a cryptic part of
   the original sqlalchemy example code that we weren't actually using.

 * Add API endpoints.

 Known issues:
 * Changes to the 'tags' field for messages may not be correct (this is because
   the tags aren't actually mapped property of the Message object in any way,
   so sqlalchemy can't detect tag changes as a change on the Message object).

Test Plan: Working on it.

Reviewers: kav-ya

Reviewed By: kav-ya

Differential Revision: https://review.inboxapp.com/D175"
emfree,2014-06-11 01:58:25,https://api.github.com/repos/nylas/sync-engine/git/commits/91e29a8bd065d95c5833984bc089cb29fb11f7ec,91e29a8bd065d95c5833984bc089cb29fb11f7ec,"Log stack trace along with slow queries.

Makes it a lot easier to see at a glance where in the code the query is."
emfree,2014-06-10 23:54:53,https://api.github.com/repos/nylas/sync-engine/git/commits/6fea71b21cc930ebd9b97a8d9e89ae1fa23f455d,6fea71b21cc930ebd9b97a8d9e89ae1fa23f455d,Fix a few typos in the docs.
emfree,2014-06-10 22:13:14,https://api.github.com/repos/nylas/sync-engine/git/commits/31f6c50d57f6d72f5704ed30afed25d62b874222,31f6c50d57f6d72f5704ed30afed25d62b874222,"Move logic from load_test_config() to migrations/env.py.

Previously load_test_config was looking for the nonexistent file
'/etc/inboxapp/test-config.json'.  Since it's only called from
migrations/env.py, and since we can assume that migrations on the test DB are
always run by hand from the inbox root directory, move the logic to that file
and simplify it."
emfree,2014-06-10 18:52:07,https://api.github.com/repos/nylas/sync-engine/git/commits/70862d787ab8fdd5382ca4e8ea3c2ad95463a820,70862d787ab8fdd5382ca4e8ea3c2ad95463a820,"Correctly spawn greenlets using retry_wrapper.

retry_wrapper executes its function argument, instead of returning a wrapper
function object. So we have to do gevent.spawn(retry_wrapper, func), not
gevent.spawn(retry_wrapper(func))."
emfree,2014-06-10 18:29:10,https://api.github.com/repos/nylas/sync-engine/git/commits/1e21ae1237929927705e733a1e00a2303594cdf3,1e21ae1237929927705e733a1e00a2303594cdf3,Use pdb.post_mortem instead of pdb.set_trace in debug utility.
grinich,2014-06-10 17:18:20,https://api.github.com/repos/nylas/sync-engine/git/commits/8964a87494ec7b76860f9c35957528ba93b2b662,8964a87494ec7b76860f9c35957528ba93b2b662,"fix lxml bug

related to parsing unicode strings that also have an encoding/charset definition in the XML opener"
emfree,2014-06-10 06:26:31,https://api.github.com/repos/nylas/sync-engine/git/commits/c91f5185ec574069fcec3321c64332df4d162155,c91f5185ec574069fcec3321c64332df4d162155,"Add decorator to pause and debug sporadic exceptions.

The thought is that this may be useful for debugging exceptions that occur
sporadically on staging: manually instrument the offending function with
`@pause_on_exception`, then when it happens again you can jump into pdb and see
what's happening."
emfree,2014-06-10 05:51:55,https://api.github.com/repos/nylas/sync-engine/git/commits/4df9108ff53f9760d964c87353754247b76e9df5,4df9108ff53f9760d964c87353754247b76e9df5,"Add function retry_wrapper to handle reexecuting failed greenlets.

Summary:
Previously we were wrapping all functions spawned as greenlets with
log_uncaught_errors(); now we instead wrap with retry_wrapper(), which handles
both logging uncaught exceptions and retrying on failure.

retry_wrapper keeps a failure count. By default, it will stop retrying if there
are too many failures in quick succession, but will reset the failure count to
zero if there are no failures over a longer interval (default five minutes).
This behavior is designed to be configurable.

Test Plan: Unit tests added.

Reviewers: mg, kav-ya

Reviewed By: mg

Differential Revision: https://review.inboxapp.com/D178"
grinich,2014-06-10 03:14:20,https://api.github.com/repos/nylas/sync-engine/git/commits/2e740f7f517e785e71baebca8c8bd9acf3dce66d,2e740f7f517e785e71baebca8c8bd9acf3dce66d,remove cruft
grinich,2014-06-10 03:13:44,https://api.github.com/repos/nylas/sync-engine/git/commits/7487433a13d0f561019fa8e5b1f7597dc8b6b752,7487433a13d0f561019fa8e5b1f7597dc8b6b752,no longer using xapian
emfree,2014-06-09 22:49:58,https://api.github.com/repos/nylas/sync-engine/git/commits/f0a36d92e63aad6195ca125a6c47a07ee3ea5a1b,f0a36d92e63aad6195ca125a6c47a07ee3ea5a1b,"Update tests in test_actions_syncback.

Fix them to use the new function names and arguments for syncback actions as
defined in actions/gmail.py."
emfree,2014-06-09 22:47:06,https://api.github.com/repos/nylas/sync-engine/git/commits/8e1f9d0ef107380e5a464dd2f1256e7c2ff54705,8e1f9d0ef107380e5a464dd2f1256e7c2ff54705,"Fix IntegrityError when syncing a new folder.

Previously, we'd call get_associated_tag from Folder.find_or_create to get or
create the tag associated to a new folder. If we then add that folder to a
thread's folders, the also_set_tag validator would query for that tag. Because
we have autoflush disabled while constructing threads in the mailsync code,
this query wouldn't find the tag. So we'd create it again. On the next
flush, this caused an IntegrityError."
grinich,2014-06-09 22:57:09,https://api.github.com/repos/nylas/sync-engine/git/commits/9fd46f1594573fbf761c0c486babe92b223a8823,9fd46f1594573fbf761c0c486babe92b223a8823,Update README.md
grinich,2014-06-09 16:28:49,https://api.github.com/repos/nylas/sync-engine/git/commits/5b2202fc941ce043abfedaca398cb9c9446a8760,5b2202fc941ce043abfedaca398cb9c9446a8760,update docs from review: clarity and removing comments
kav-ya,2014-06-09 22:34:33,https://api.github.com/repos/nylas/sync-engine/git/commits/6809163334b88dc30519043b15e9139601aaaeb5,6809163334b88dc30519043b15e9139601aaaeb5,Change draft flag check for drafts reconciliation
grinich,2014-06-09 22:33:31,https://api.github.com/repos/nylas/sync-engine/git/commits/5ede2d8345a9d20a37d65d255c65f2c59f087be3,5ede2d8345a9d20a37d65d255c65f2c59f087be3,Update README.md
grinich,2014-06-09 22:02:36,https://api.github.com/repos/nylas/sync-engine/git/commits/80330f6678f803315251f3551358e27fab3543f0,80330f6678f803315251f3551358e27fab3543f0,git rebase config
grinich,2014-06-09 21:53:15,https://api.github.com/repos/nylas/sync-engine/git/commits/316df8c7a2f8319d82df9e1e03097a355330633d,316df8c7a2f8319d82df9e1e03097a355330633d,"Filter on g_msgids in Python instead of sending huge list to MySQL

Closes #T53"
grinich,2014-06-09 02:35:35,https://api.github.com/repos/nylas/sync-engine/git/commits/ce6acd71ed0580a41da80dcb9f583d586f7534fe,ce6acd71ed0580a41da80dcb9f583d586f7534fe,revert back to 12.04 because trusty causes gevent to segfault :(
grinich,2014-06-08 23:52:03,https://api.github.com/repos/nylas/sync-engine/git/commits/df9a9151c0c3a481673362e3944b5641ca61a493,df9a9151c0c3a481673362e3944b5641ca61a493,"Remove inbox.server module, moving everything up one level"
grinich,2014-06-08 19:23:36,https://api.github.com/repos/nylas/sync-engine/git/commits/7633f87327de9c534468f7c821ba93282327ef47,7633f87327de9c534468f7c821ba93282327ef47,temporarily disable VMware fusion provider because we need a 14.04 box
kav-ya,2014-06-08 05:12:53,https://api.github.com/repos/nylas/sync-engine/git/commits/ecbb3cf496965bd220ae2c74da028c8c6b39293d,ecbb3cf496965bd220ae2c74da028c8c6b39293d,"Changes to support EAS drafts, sending too.
test_drafts, test_drafts_syncback pass again."
kav-ya,2014-06-08 04:24:27,https://api.github.com/repos/nylas/sync-engine/git/commits/a20891fdf9c396b69a87b76666375223de80a050,a20891fdf9c396b69a87b76666375223de80a050,Copy default config to /etc/inboxapp before setting up databases
grinich,2014-06-07 00:51:36,https://api.github.com/repos/nylas/sync-engine/git/commits/c447f5b65dbcf49b5cddf5b2f177a1d5b121adf6,c447f5b65dbcf49b5cddf5b2f177a1d5b121adf6,"Update from Ubuntu 12.0.4 to 14.04 (Python 2.7.6)

New Python for great good!

How to update your VM:

sudo apt-get update
sudo apt-get install update-manager-core
sudo do-release-upgrade -d
sudo reboot

By default, Ubuntu LTS release won't offer to upgrade to the next LTS until the first point release has been made. So `do-release-upgrade` won't show anything until Ubuntu 14.04.1 is released, which is scheduled for July 24th. Hence the `-d` flag.


You can also just erase your existing VM and start over by running `vagrant destroy`."
grinich,2014-06-07 00:44:45,https://api.github.com/repos/nylas/sync-engine/git/commits/c619734696a12496cc5149afa4ff167f13a4f120,c619734696a12496cc5149afa4ff167f13a4f120,"Support for attachments in drafts

Summary: This adds support for attachments in drafts and sent messages. We pass around block_public_ids (externally known as file ids) until we create the MIME representation of the message. The function `gen_attachments` in inbox/server/sendmail/base.py converts a list of Block public_ids to a dicionary containing attachment metadata and the actual data as a bytestring.

Test Plan: Tests have been modified and pass

Reviewers: kav-ya, emfree

Reviewed By: emfree

CC: emfree

Differential Revision: https://review.inboxapp.com/D176"
emfree,2014-06-07 00:18:19,https://api.github.com/repos/nylas/sync-engine/git/commits/2b2627f4f6447eaa8751645a4e4a155e9b54201f,2b2627f4f6447eaa8751645a4e4a155e9b54201f,"Set content-type for webhooks post request.

Also add missing call to db_session.commit() on stopping a webhook."
grinich,2014-06-07 00:16:17,https://api.github.com/repos/nylas/sync-engine/git/commits/32d461ce05310fcb1db2bb9bfa67103d4a334e95,32d461ce05310fcb1db2bb9bfa67103d4a334e95,"File-based config system

Summary:
The Python module thing with a command-line arg was nice, but broke with the various scripts and alembic.

These config files won't be changing often, so I feel OK putting them in a file on disk.

Obviously the hardcoded paths can in the future be pulled from environment variables or something, but this works for now and is important to move forward.

Test Plan: Tests pass. You need a test config

Reviewers: emfree

Reviewed By: emfree

Differential Revision: https://review.inboxapp.com/D177"
grinich,2014-06-06 22:04:06,https://api.github.com/repos/nylas/sync-engine/git/commits/ecdcc0f7423b8e740ab3fc6a284321d36fd1f6a7,ecdcc0f7423b8e740ab3fc6a284321d36fd1f6a7,truncate email_address instead of setting column collation
kav-ya,2014-06-06 23:50:16,https://api.github.com/repos/nylas/sync-engine/git/commits/3436b98b3cb0ff61bb8b0d860570c8574955e4f2,3436b98b3cb0ff61bb8b0d860570c8574955e4f2,"(Empty commit)
Use our fork of requests which implements a custom exception that wraps urllib3's MaxRetryError (previously wrapped by request's ConnectionError),
the custom exception is implemented as a subclass of request's ConnectionError so as to be compatible with any dependant code.

We do this so we can implement our own HTTP transport adapter to specify max_retries, delay interval between HTTP request retries
for EAS requests (see inbox-eas repo). This in turn is an attempt to fix an ActiveSyncException('Could not connect to EAS server') error on
the testing box.

Sync runs, tests pass as before."
kav-ya,2014-06-06 00:00:19,https://api.github.com/repos/nylas/sync-engine/git/commits/db976b10852d40b6224c91d33f9330171b805644,db976b10852d40b6224c91d33f9330171b805644,"Use our fork of requests, needed for EAS gunks error fix.
Sync runs, tests pass as before."
emfree,2014-06-06 23:03:25,https://api.github.com/repos/nylas/sync-engine/git/commits/f584bf2fb9333e9c68d095344532893fa1e11167,f584bf2fb9333e9c68d095344532893fa1e11167,"Bump crispin connection pool size.

I think we were using up all the connections now that we're syncing the
Trash/Spam/Inbox and All folders. This caused execution of
mailsync.backends.gmail.download_queued_threads to hang at line 347 when
getting a new crispin client, and lead to new messages not being processed
promptly by a running sync.

Since we need to revisit this pooling anyways (T29), simply bump the connection
pool size for now. Note that it can't be made arbitrarily large, or imaplib may
fail with 'too many simultaneous connections'."
emfree,2014-06-06 22:21:43,https://api.github.com/repos/nylas/sync-engine/git/commits/0d72f73b580ba6b80c62332d15efdc1ac02dc166,0d72f73b580ba6b80c62332d15efdc1ac02dc166,Remove stray debugging code.
emfree,2014-06-06 22:16:48,https://api.github.com/repos/nylas/sync-engine/git/commits/c54d6e9243f51ceae29fd5966143cb06dba77977,c54d6e9243f51ceae29fd5966143cb06dba77977,Fix typo in previous commit.
emfree,2014-06-06 22:01:32,https://api.github.com/repos/nylas/sync-engine/git/commits/352f875ccb8fca12c16a65a62a311d89c45e4cb0,352f875ccb8fca12c16a65a62a311d89c45e4cb0,"Check that webhook callback_url is https at registration time.

And return 400 from the API if it isn't. We still just have a
not-too-informative catch-all error message, but this is at least better than
accepting the webhook and later refusing to post to it."
emfree,2014-06-06 00:50:24,https://api.github.com/repos/nylas/sync-engine/git/commits/aadfe9a7b225720b2f4d6704504171abbe907c44,aadfe9a7b225720b2f4d6704504171abbe907c44,"Only poll the transaction log for webhooks when there are active hooks.

Also set min_processed_id more intelligently, and only fire hooks on messages
with received_date after the webhook's updated_at timestamp (so we don't fire
hooks when syncing old messages)."
grinich,2014-06-06 21:15:35,https://api.github.com/repos/nylas/sync-engine/git/commits/5e3ba6eb1ba583ae3699d3876f161508969c94ef,5e3ba6eb1ba583ae3699d3876f161508969c94ef,comment on detached block
grinich,2014-06-06 03:15:06,https://api.github.com/repos/nylas/sync-engine/git/commits/adb781c0eb77cd02044bb9f00b67a2acd921d3ba,adb781c0eb77cd02044bb9f00b67a2acd921d3ba,explicitly set collation so we can build an index
emfree,2014-06-05 22:32:35,https://api.github.com/repos/nylas/sync-engine/git/commits/ce612fc5b88e2d28d307450faa19dc07da329197,ce612fc5b88e2d28d307450faa19dc07da329197,"Use 'aggressive=False when gevent-monkeypatching in tests.

Fixes T59."
kav-ya,2014-06-05 21:16:36,https://api.github.com/repos/nylas/sync-engine/git/commits/451b8e0013de2db675dff40f5dc9989b5a34d67d,451b8e0013de2db675dff40f5dc9989b5a34d67d,"gevent monkey_patch, call preflight in inbox-auth too."
kav-ya,2014-06-05 19:05:17,https://api.github.com/repos/nylas/sync-engine/git/commits/20b7977c8980df9093fa4c908e46c23b31a4d24e,20b7977c8980df9093fa4c908e46c23b31a4d24e,"Drafts syncback, reconciliation.

Summary:
1. Syncback -
Draft operations (create, update, delete, send) are propogated to the remote backend.

2. Reconciliation -
Identify a `Drafts`, `Sent Mail` (or corresponding) message synced from the
remote backend as one we sent and reconcile it with the message we
created and stored in the local data store at the time of created.

Notes:
- We also now use the public_id for the X-INBOX-ID header (rather than generating a new random id).
- Deletes old sendmail tests.

Test Plan: Tests in test_drafts_syncback, _reconciliation.

Reviewers: emfree

Reviewed By: emfree

CC: mg

Differential Revision: https://review.inboxapp.com/D174"
kav-ya,2014-06-05 03:34:33,https://api.github.com/repos/nylas/sync-engine/git/commits/a69fe607cfe245f084a02365f1d087cff14596c3,a69fe607cfe245f084a02365f1d087cff14596c3,Fix typo in get_associated_tag()
emfree,2014-06-03 19:52:05,https://api.github.com/repos/nylas/sync-engine/git/commits/8dd759a879604b7fb498100e45491a50301945b2,8dd759a879604b7fb498100e45491a50301945b2,"Tag interface, part 3.

Summary:
 * Delete local actions code. Local actions are now expressed solely by
   adding/removing tags. Refactor the rest of the existing actions code as a
   result.

 * Add a listener service which checks the transaction log for tag mutations,
   and executes the corresponding syncback actions.

 * Expose 'unread' and 'archive' as tags on threads.

 * Support dependent tag mutations (e.g., remove the 'inbox' tag when you add
   the 'archive' tag, and vice versa).

 * Refactor drafts code to work with new syncback infrastructure. In the
   process, move a bunch of provider-agnostic stuff out of the Gmail-specific
   code.

 * Unrelatedly, ensure that when we do something like
      db_session.query(Object).filter(Object.related_id == some_id),
   we always filter by the *id*, not the object itself (otherwise, with our
   custom primaryjoin condition, sqlalchemy basically loads a Cartesian
   product of both the table and the related table). This was previously the
   source of a gnarly crashing bug in this code.

Test Plan: Unit tests added.

Reviewers: spang, kav-ya

Reviewed By: kav-ya

CC: mg

Differential Revision: https://review.inboxapp.com/D162"
emfree,2014-06-03 19:51:05,https://api.github.com/repos/nylas/sync-engine/git/commits/06432d849a4c0a1447aa1136b0f1273fde4111b2,06432d849a4c0a1447aa1136b0f1273fde4111b2,"Tag interface part 2: Better record added/removed tags in the tx log

Summary:
Added or removed tags now appear in the transaction log as revisions of the
Thread object.

Don't have FolderItems inherit from HasRevisions (it doesn't need to).

[Stop reading here if you don't care about implementation details.]

Given related parent and child tables, we add the ability to record updates to
a parent's collection of children as a revision of the parent. See the
docstring in models/revision.py for details.

(Why not just have the TagItems association table subclass HasRevisions? you
may ask. Good question. One reason is that handling removed tags that way is
tricky, because all the transaction log can tell you is that a TagItem with
some ID was deleted. But you can't figure out from that what the corresponding
tag or thread was. Another reason is that delete transactions for the TagItem
table aren't created at all if you use an association proxy
(`thread.tags.remove(tag)`), because in this case sqlalchemy directly issues
sql to the database, without instantiating the association object.

Test Plan: Still working on the tests.

Reviewers: spang

Reviewed By: spang

Differential Revision: https://review.inboxapp.com/D160"
emfree,2014-06-04 22:22:26,https://api.github.com/repos/nylas/sync-engine/git/commits/a1fcc84a68e82bde58bf858fb790af0bff05042a,a1fcc84a68e82bde58bf858fb790af0bff05042a,"[DEPENDENCIES] Use faulthandler module for easier debugging.

Install and enable the faulthandler module, which prints a Python traceback if
the process receives SIGABRT or similar signals. This is helpful for debugging
hanging processes, and should eventually be useful when we have our own utility
to monitor resource consumption."
emfree,2014-06-04 17:55:45,https://api.github.com/repos/nylas/sync-engine/git/commits/13a58310444d9011c606264288306675ee9f8547,13a58310444d9011c606264288306675ee9f8547,Fix TypeError in webhooks code when transaction log is empty.
bengotow,2014-06-04 19:16:34,https://api.github.com/repos/nylas/sync-engine/git/commits/82bffff83698fd8ef0871da9926df855a327d512,82bffff83698fd8ef0871da9926df855a327d512,Update documentation: sending / drafting / files
bengotow,2014-06-04 18:42:56,https://api.github.com/repos/nylas/sync-engine/git/commits/799c1ecefc6843906fa1c5676efb2303346fb587,799c1ecefc6843906fa1c5676efb2303346fb587,Update documentation: include unread under 'Tag Actions'
grinich,2014-06-04 17:40:21,https://api.github.com/repos/nylas/sync-engine/git/commits/e8e0973a9f8ad223d1d2075de99841615268bc29,e8e0973a9f8ad223d1d2075de99841615268bc29,Don't require keypres for setup script
emfree,2014-06-04 01:04:02,https://api.github.com/repos/nylas/sync-engine/git/commits/ebb445e83e6185d4eaad87731535a71b7770f4a5,ebb445e83e6185d4eaad87731535a71b7770f4a5,"Revert ""Tag interface part 2: Better record added/removed tags in the tx log""

This reverts commit 7af9b5a842c749d9bde0f5eb2a2f1e9c757ccac3."
emfree,2014-06-04 01:03:53,https://api.github.com/repos/nylas/sync-engine/git/commits/d2e9358e614b9be3b848481a4b7606d6db7dcdb1,d2e9358e614b9be3b848481a4b7606d6db7dcdb1,"Revert ""Tag interface, part 3.""

This reverts commit 474ccd057f670e209b5702380634d09207627ff7."
emfree,2014-06-03 19:52:05,https://api.github.com/repos/nylas/sync-engine/git/commits/474ccd057f670e209b5702380634d09207627ff7,474ccd057f670e209b5702380634d09207627ff7,"Tag interface, part 3.

Summary:
 * Delete local actions code. Local actions are now expressed solely by
   adding/removing tags. Refactor the rest of the existing actions code as a
   result.

 * Add a listener service which checks the transaction log for tag mutations,
   and executes the corresponding syncback actions.

 * Expose 'unread' and 'archive' as tags on threads.

 * Support dependent tag mutations (e.g., remove the 'inbox' tag when you add
   the 'archive' tag, and vice versa).

 * Refactor drafts code to work with new syncback infrastructure. In the
   process, move a bunch of provider-agnostic stuff out of the Gmail-specific
   code.

Test Plan: Unit tests added.

Reviewers: spang, kav-ya

Reviewed By: kav-ya

CC: mg

Differential Revision: https://review.inboxapp.com/D162"
emfree,2014-06-03 19:51:05,https://api.github.com/repos/nylas/sync-engine/git/commits/7af9b5a842c749d9bde0f5eb2a2f1e9c757ccac3,7af9b5a842c749d9bde0f5eb2a2f1e9c757ccac3,"Tag interface part 2: Better record added/removed tags in the tx log

Summary:
Added or removed tags now appear in the transaction log as revisions of the
Thread object.

[Stop reading here if you don't care about implementation details.]

Given related parent and child tables, we add the ability to record updates to
a parent's collection of children as a revision of the parent. See the
docstring in models/revision.py for details.

(Why not just have the TagItems association table subclass HasRevisions? you
may ask. Good question. One reason is that handling removed tags that way is
tricky, because all the transaction log can tell you is that a TagItem with
some ID was deleted. But you can't figure out from that what the corresponding
tag or thread was. Another reason is that delete transactions for the TagItem
table aren't created at all if you use an association proxy
(`thread.tags.remove(tag)`), because in this case sqlalchemy directly issues
sql to the database, without instantiating the association object.

Test Plan: Still working on the tests.

Reviewers: spang

Reviewed By: spang

Differential Revision: https://review.inboxapp.com/D160"
emfree,2014-06-03 19:50:40,https://api.github.com/repos/nylas/sync-engine/git/commits/4cd78ef7b6decc540729e9205eb367a4c67b790b,4cd78ef7b6decc540729e9205eb367a4c67b790b,"[SCHEMA] Support a full-featured tag interface, part 1.

Summary:
This is the first in a series of three or four commits.

Rename UserTag to Tag, and tweak its schema, as well as the Folder schema.
Everything we expose as a tag now has a corresponding Tag row, whether the tag
comes from an IMAP folder ('gmail-jobslist'), was created via the API
('my-awesome-tag'), or has some special semantics ('unread', 'drafts', ...).
This makes it a lot easier to reason about what's going on.

This is a precursor to the following changes:
 - Modify our actions code such that Thread.folders is *always* an exact mirror
   of what we sync from the IMAP backend. We express local actions only by
   mutating tags, not folders. Again, this makes things simpler.

 - Get rid of the Redis queue for actions syncback. Instead, we'll have a
   syncback service that consumes the transaction log, and executes actions
   based on recorded tag mutations. Per discussion with mg, this means that,
   for example, the API server can run on a machine without access to user
   credentials.

Test Plan: Will add tests once I put all the pieces together.

Reviewers: spang

Reviewed By: spang

Differential Revision: https://review.inboxapp.com/D159"
kav-ya,2014-06-03 19:33:44,https://api.github.com/repos/nylas/sync-engine/git/commits/2d811e2568c875f046abb0fd3ca7496721a18fd6,2d811e2568c875f046abb0fd3ca7496721a18fd6,"Test config overrides MSG_PARTS_DIRECTORY, CACHE_BASEDIR, LOGDIR too."
emfree,2014-06-03 19:07:27,https://api.github.com/repos/nylas/sync-engine/git/commits/323194456c9c4e1340cff4861a7240a41bd4b4e4,323194456c9c4e1340cff4861a7240a41bd4b4e4,Actually properly close database session on /n/ API query.
emfree,2014-06-03 17:46:12,https://api.github.com/repos/nylas/sync-engine/git/commits/4325295e5b574903d5a2358bb47bb37ac56dfdab,4325295e5b574903d5a2358bb47bb37ac56dfdab,Also invoke preflight() when running bin/inbox-api.
emfree,2014-06-03 03:15:50,https://api.github.com/repos/nylas/sync-engine/git/commits/a5894e512519c340cbe592a1db77fe4e1d83c2f9,a5894e512519c340cbe592a1db77fe4e1d83c2f9,"Don't use yield_per when scanning the transaction log.

Turns out yield_per doesn't help much if the database driver tries to buffer all
results into memory before returning them. For now, just manually window the
scan."
emfree,2014-06-03 17:01:04,https://api.github.com/repos/nylas/sync-engine/git/commits/cd683529fd2fddb5e89bde095177dbe2e243a57a,cd683529fd2fddb5e89bde095177dbe2e243a57a,Set correct process title in bin/inbox-api.
grinich,2014-06-03 02:28:49,https://api.github.com/repos/nylas/sync-engine/git/commits/dd5c2d81acbb5637fb138334e04cf5308810176a,dd5c2d81acbb5637fb138334e04cf5308810176a,vmware fusion provider basebox
grinich,2014-06-03 01:20:40,https://api.github.com/repos/nylas/sync-engine/git/commits/3a605649b1f012414965eca80a736ad4f689de7b,3a605649b1f012414965eca80a736ad4f689de7b,override flask logger
grinich,2014-06-03 01:20:29,https://api.github.com/repos/nylas/sync-engine/git/commits/5f272bda31137db92c627348bd84373dd77f1bd2,5f272bda31137db92c627348bd84373dd77f1bd2,fix file upload api endpoint
grinich,2014-06-03 01:19:54,https://api.github.com/repos/nylas/sync-engine/git/commits/54d5f3176a3d186963c90fc677154067c3c9f132,54d5f3176a3d186963c90fc677154067c3c9f132,comment about S3
grinich,2014-06-03 00:35:39,https://api.github.com/repos/nylas/sync-engine/git/commits/846f5fe9696d575d4599eeb6adf02b8a8512323c,846f5fe9696d575d4599eeb6adf02b8a8512323c,remove old config check
kav-ya,2014-06-02 22:43:43,https://api.github.com/repos/nylas/sync-engine/git/commits/1ef2a08bd7ca7267a1fd950c85863bffa08c96a1,1ef2a08bd7ca7267a1fd950c85863bffa08c96a1,"folder_monitors is a gevent.pool.Group, therefore use the Group.kill() method to kill
the greenlets in the group rather than killall, which causes a TypeError."
kav-ya,2014-06-02 22:38:27,https://api.github.com/repos/nylas/sync-engine/git/commits/f118b5beccad3cb4310d98ed66138976608ffe83,f118b5beccad3cb4310d98ed66138976608ffe83,"Remove old test_sendmail_* tests, superceded by corresponding test_draft_* tests"
grinich,2014-06-02 21:27:08,https://api.github.com/repos/nylas/sync-engine/git/commits/a3be80afacfc8bb857c8b76d7abf6d87f0211f3a,a3be80afacfc8bb857c8b76d7abf6d87f0211f3a,Properly close database session on /n/ API query. (Accidentially reverted this.)
grinich,2014-06-02 20:40:21,https://api.github.com/repos/nylas/sync-engine/git/commits/4d4d26a798ef245097803ebc2d5b33c24efdb03e,4d4d26a798ef245097803ebc2d5b33c24efdb03e,"New config system

Summary:
So I've been pretty unhappy with our config system for a while. Boostrapping redwood off it was the last straw, and here's a first stab at fixing it. In general, I feel like configuration needs to be powerful to remain simple, and that *configuration is code* at the end of the day.

Some things I didn't like about the previous system:

* Massaging booleans from `yes` or `no` to native Python `True` or `False` types. Yuck.
* Expanding paths based on potential relative user directories
* Overriding the entire config file for tests, when really we only change one or two params
* This `config-sample.cfg` stuff, when most/all of the defaults are fine
* The notion of production vs. staging vs. development. It's really premature optimization, given that we have literally zero production machines and nothing running on RDS at the moment.

I had a good conversation with Eben over lunch about how Google uses feature flags to turn on/off specific code paths. I think this might be a better approach, since it will be clear what's actually enabled, and not guessing based on staging/production/etc. One first pass at this is deciding to send emails by the `EMAIL_EXCEPTIONS` configuration value.

I also want to explore using our pluggable modules to override configuration via other modules which might import `inbox`. You can imagine this in a test scenario, or the case of redwood, which uses a lot of shared utilities and database functions.

This commit also breaks out where we're creating the database engine, since we don't want to create it in code that other modules import.

In general, I want to start a discussion about this (hence cc'ing a few of you). The goal here is to figure out something that adds some more flexibility immediately (land this quickly), but gets us on the right track towards a comprehensive solution later.

Test Plan: One tests fails... I'm not sure why.

Reviewers: emfree, kav-ya

Reviewed By: emfree

CC: emfree, kav-ya

Differential Revision: https://review.inboxapp.com/D166"
grinich,2014-06-01 21:46:48,https://api.github.com/repos/nylas/sync-engine/git/commits/d24fd2f1689208fe604c40eec1b69aefd5f76ea2,d24fd2f1689208fe604c40eec1b69aefd5f76ea2,"Remove OAuth callback (not supported)

Summary:
This is too complicated to setup for development VMs, and we're not going to use this codepath in the hosted version.

dont check oauth credentials at import

Test Plan: Tests pass

Reviewers: emfree

Reviewed By: emfree

Differential Revision: https://review.inboxapp.com/D173"
grinich,2014-06-01 19:31:33,https://api.github.com/repos/nylas/sync-engine/git/commits/a0714580a81ea81408746fc109836de1e19188df,a0714580a81ea81408746fc109836de1e19188df,Changes from @emfree's CR
grinich,2014-06-01 19:16:22,https://api.github.com/repos/nylas/sync-engine/git/commits/1301391d00499bf35a8c5b16885bd03f310b4249,1301391d00499bf35a8c5b16885bd03f310b4249,Ignore pip editable package directory
grinich,2014-06-01 17:07:35,https://api.github.com/repos/nylas/sync-engine/git/commits/9e99fa6c1f914d914123ef8580dd6b84fb5b1c52,9e99fa6c1f914d914123ef8580dd6b84fb5b1c52,Install Inbox package from top level directory
grinich,2014-06-01 17:05:00,https://api.github.com/repos/nylas/sync-engine/git/commits/49b4b5416a1201a71eed54fd495143c9a500cece,49b4b5416a1201a71eed54fd495143c9a500cece,"Merge pull request #13 from caitp/mode100755

chore(bin/*) chmod +x binaries"
caitp,2014-06-01 12:16:44,https://api.github.com/repos/nylas/sync-engine/git/commits/2c971fb64c72e6183e9eded9e8b4330cc0f887da,2c971fb64c72e6183e9eded9e8b4330cc0f887da,chore(bin/*) chmod +x binaries
grinich,2014-06-01 02:40:15,https://api.github.com/repos/nylas/sync-engine/git/commits/d311aa64bd17374e3eb0572b3caff3574bd4b8f6,d311aa64bd17374e3eb0572b3caff3574bd4b8f6,"Module cleanup & split scripts

- split `./inbox` script to many smaller scripts in `bin` directory
- moved all tools to `bin` folder
- moved module up one level to `inbox` folder (convention)
- created preflight function in module for checking dependencies, database, etc.

Note, the search scripts are still broken, but I moved them anyway"
emfree,2014-05-31 00:48:13,https://api.github.com/repos/nylas/sync-engine/git/commits/11979db46c6ee415d1dd011d97a5055cea459948,11979db46c6ee415d1dd011d97a5055cea459948,"Add an 'order' parameter to the /contacts API.

Only return ranked results if 'order=rank'; otherwise return results ordered by
internal ID.

Also add some validation for the 'limit' and 'offset' parameters."
emfree,2014-05-30 22:25:18,https://api.github.com/repos/nylas/sync-engine/git/commits/4ed0a4939d6b09625e5554427b9eb235c9224c29,4ed0a4939d6b09625e5554427b9eb235c9224c29,"Properly close database session on /n/ API query.

Otherwise the open session blocks the test database teardown when testing this
stuff."
spang,2014-05-30 21:35:39,https://api.github.com/repos/nylas/sync-engine/git/commits/59295d7dfc9dc54d0ef40f8ddf829062cfd07fa0,59295d7dfc9dc54d0ef40f8ddf829062cfd07fa0,"Don't thread expand on trash/spam while polling.

Summary:
Fix for T49.

Oof, this bug was an oversight during the adding of this feature. Now
the logic is equivalent in initial sync / poll.

Test Plan: Poll works on my machine.

Reviewers: emfree

Reviewed By: emfree

Differential Revision: https://review.inboxapp.com/D170"
spang,2014-05-30 21:14:17,https://api.github.com/repos/nylas/sync-engine/git/commits/a56eccca4bab9498156c62df2b5e24ebb66271eb,a56eccca4bab9498156c62df2b5e24ebb66271eb,"Configure some options for sendmail retry decorator too.

Summary:
I forgot that by default @retry is still silent and has some other
behaviours we want to override.

Test Plan: unit tests

Reviewers: kav-ya

Reviewed By: kav-ya

Differential Revision: https://review.inboxapp.com/D169"
emfree,2014-05-30 20:35:22,https://api.github.com/repos/nylas/sync-engine/git/commits/c3f4be7b752c2f14c35c43c6020563175c40d9d9,c3f4be7b752c2f14c35c43c6020563175c40d9d9,"Fail fast, but not that fast."
spang,2014-05-30 18:31:11,https://api.github.com/repos/nylas/sync-engine/git/commits/bb87910b3800d89a6c9214419344ec7c500bf590,bb87910b3800d89a6c9214419344ec7c500bf590,"[DEPENDENCIES] Switch to our version of geventconnpool.

Summary:
I added some features which will hopefully make our imaplib errors go
away (it seems that monkeypatching the exceptions was not working). I'm
trying to push these + a port of our extra features upstream, but for
now we'll have to use our fork.

This patch eliminates copy-pasting and customizing of every instance of
our code which wants to use a gevent-safe connection pool with logging.

Now we don't monkeypatch stdlib (except for gevent), which is really for
the best.

See https://github.com/rasky/geventconnpool/pull/1 for info on the state
of pushing these changes back.

Test Plan: Simulated imaplib.IMAP4.abort() errors, seems to work.

Reviewers: emfree

Reviewed By: emfree

Differential Revision: https://review.inboxapp.com/D168"
spang,2014-05-30 17:48:12,https://api.github.com/repos/nylas/sync-engine/git/commits/4d8c0973b0d9f50024bed4df9426905083967d86,4d8c0973b0d9f50024bed4df9426905083967d86,"[DEPENDENCIES] Switch to our version of geventconnpool.

I added some features which will hopefully make our imaplib errors go
away (it seems that monkeypatching the exceptions was not working). I'm
trying to push these + a port of our extra features upstream, but for
now we'll have to use our fork.

This patch eliminates copy-pasting and customizing of every instance of
our code which wants to use a gevent-safe connection pool with logging.

Now we don't monkeypatch stdlib (except for gevent), which is really for
the best.

See https://github.com/rasky/geventconnpool/pull/1 for info on the state
of pushing these changes back."
spang,2014-05-30 00:49:39,https://api.github.com/repos/nylas/sync-engine/git/commits/2c93ce1df80adee636af4001f1deee031a1ce23e,2c93ce1df80adee636af4001f1deee031a1ce23e,Explicitly disallow running Inbox as root.
spang,2014-05-29 23:32:14,https://api.github.com/repos/nylas/sync-engine/git/commits/79971951b0b1034693f861f8454bc6850efe22e3,79971951b0b1034693f861f8454bc6850efe22e3,"Roll back pyOpenSSL requirement.

There are some unresolved bugs in requests' pyOpenSSL backend which are
causing too many errors right now. We should definitely use the
pyOpenSSL backend eventually for SNI support and other improvements, but
right now it's causing too much noise while trying to shake out other
bugs via stress testing. We'll revisit this decision before beta launch.

There is ongoing work on this upstream which will hopefully be resolved
in the next few weeks or months:

(See https://github.com/shazow/urllib3/pull/371"
kav-ya,2014-05-29 21:24:21,https://api.github.com/repos/nylas/sync-engine/git/commits/3a0bc6e969d43f881f60e47fe751308695cd1d0c,3a0bc6e969d43f881f60e47fe751308695cd1d0c,"Provider-agnostic drafts functions, exceptions live in sendmail.base

Test Plan:
All tests pass as before."
emfree,2014-05-29 21:29:14,https://api.github.com/repos/nylas/sync-engine/git/commits/4a9ae56b189ad365d2633475a134b77d27928f4c,4a9ae56b189ad365d2633475a134b77d27928f4c,Remove unused import from test_drafts_syncback.py
emfree,2014-05-29 20:15:33,https://api.github.com/repos/nylas/sync-engine/git/commits/7134ccccdeb8edbb686b5995d572b9278596cc45,7134ccccdeb8edbb686b5995d572b9278596cc45,Remove skipif annotation from drafts unit tests.
emfree,2014-05-29 20:06:36,https://api.github.com/repos/nylas/sync-engine/git/commits/b6afef1230d1591f92508c9bc03d2e64cef92aa3,b6afef1230d1591f92508c9bc03d2e64cef92aa3,Remove unused function send_thread().
grinich,2014-05-29 00:50:28,https://api.github.com/repos/nylas/sync-engine/git/commits/5c538031a3502b8afdf4b0d80cf5c4b0bdba9d63,5c538031a3502b8afdf4b0d80cf5c4b0bdba9d63,"Generalize loading of shared folders

Summary:
This will auto-load any folder in the parent directory with the format ""share-*""

It removes the prefix for the mount path. So for example, the parent directory should have ""share-inbox-eas"" to mount it at ""/inbox-eas"" within the VM

Test Plan: doesn't impact tests

Reviewers: kav-ya

Reviewed By: kav-ya

Differential Revision: https://review.inboxapp.com/D167"
kav-ya,2014-05-29 00:28:09,https://api.github.com/repos/nylas/sync-engine/git/commits/88bf4ef8cac8687fdeb7e5548bd0f9fab81d88b6,88bf4ef8cac8687fdeb7e5548bd0f9fab81d88b6,"Drafts support

Summary:
Adds support for drafts.
This includes creating, updating, deleting and sending drafts;
both independant drafts + drafts that are replies are possible.

We implement drafts as immutable objects (like all messages in Inbox). Thus, updating a draft
creates a new draft message under the hood. We do this so update conflicts are handled
correctly i.e. two updates to the same draft cannot result in non-deterministic behavior.

Test plan:
Tests are in tests/imap/test_drafts.py

Reviewers:
spang

Reviewed By:
spang

CC:
emfree, mg

Differential Revision:
https://review.inboxapp.com/D149"
spang,2014-05-28 18:47:30,https://api.github.com/repos/nylas/sync-engine/git/commits/61237eb54dced1f15d25afeb333922c15743fa02,61237eb54dced1f15d25afeb333922c15743fa02,"Better error when sync() exits with successful status.

These sync() methods shouldn't be exiting on their own, they should only
be explicitly stopped. So a successful exit is a bug, and we need to
know what kind of account it is in order to figure out where the bug is."
spang,2014-05-28 18:46:04,https://api.github.com/repos/nylas/sync-engine/git/commits/86242a60a56612251d89c48f8b1759c516bc7b65,86242a60a56612251d89c48f8b1759c516bc7b65,"Fix default logger purpose.

We changed this a while ago."
grinich,2014-05-28 12:16:16,https://api.github.com/repos/nylas/sync-engine/git/commits/7ce678074be1a9b68579bc312f911ec71afd2158,7ce678074be1a9b68579bc312f911ec71afd2158,add fragment support to url_concat utility
grinich,2014-05-28 12:15:38,https://api.github.com/repos/nylas/sync-engine/git/commits/6502e0130d31a9aef2859eabbdb882f8c4a25f59,6502e0130d31a9aef2859eabbdb882f8c4a25f59,also install g++ and htop on setup
grinich,2014-05-28 12:15:20,https://api.github.com/repos/nylas/sync-engine/git/commits/5d3d331c10f19212432cb346897719bd8342a390,5d3d331c10f19212432cb346897719bd8342a390,bump pytest version
spang,2014-05-27 22:33:47,https://api.github.com/repos/nylas/sync-engine/git/commits/1807a4af2cd7449a66a40046d7eb5eede21bc38d,1807a4af2cd7449a66a40046d7eb5eede21bc38d,"Fix KeyError on message deduplication.

Summary:
If we don't have X-GM-MSGID for a given UID, it means that the UID
appeared in the folder between the download of remote_g_metadata and the
fetching of the remote UID list. This race happens rarely, and the
easiest solution is to assume we have to download the full message in
this case. If we actually do already have a message with this
X-GM-MSGID, we will deduplicate it upon database insersion.

Test Plan:
Running it on staging for a while. The patch is small enough that
I think we can jump straight to that.

Reviewers: emfree

Reviewed By: emfree

Differential Revision: https://review.inboxapp.com/D165"
spang,2014-05-27 22:06:17,https://api.github.com/repos/nylas/sync-engine/git/commits/004529b75f6851fa854e8b9b22062d1bb061933b,004529b75f6851fa854e8b9b22062d1bb061933b,Break long line.
spang,2014-05-27 21:58:57,https://api.github.com/repos/nylas/sync-engine/git/commits/74de4c3d578f50a456c4ef3632d290f7247b06ff,74de4c3d578f50a456c4ef3632d290f7247b06ff,"Saner crispin retry policy.

Summary:
Don't try again immediately, and if a maximum retry limit is hit, just
fail. (The goal is to show dead account mailsyncs on a dashboard and
have manual intervention.)

Test Plan:
I applied this patch to crispin.py and watched the carnage ensue. Seems to
behave properly:
```
@@ -247,6 +246,7 @@ class CrispinClient(object):
         self._folder_names = None
         self.log.info('Selected folder {0} with {1} messages.'.format(
             folder, select_info['EXISTS']))
+        raise socket.error(""fail fail fail"")
         return uidvalidity_cb(folder, select_info)

     @property
```

Reviewers: mg

Reviewed By: mg

Differential Revision: https://review.inboxapp.com/D164"
emfree,2014-05-27 01:48:12,https://api.github.com/repos/nylas/sync-engine/git/commits/dd77e64d2e179c9b8126914dbe10963ea4138099,dd77e64d2e179c9b8126914dbe10963ea4138099,Add `expunge` method to InboxSession.
emfree,2014-05-26 17:57:01,https://api.github.com/repos/nylas/sync-engine/git/commits/08437016e78702db8bd1e7d51847a44ef66bc3e7,08437016e78702db8bd1e7d51847a44ef66bc3e7,Remove outdated comment.
grinich,2014-05-25 21:34:30,https://api.github.com/repos/nylas/sync-engine/git/commits/eb2b5677ffcd25b519bd2c51b3be13725967d25c,eb2b5677ffcd25b519bd2c51b3be13725967d25c,"Move engine/models to be app-agnostic

Summary:
- Move engine creation to new module (ignition)
- Move `engine_uri` and `db_uri` to config.py. (Note: we should probably make all configuration done in a module instead of processing a flat file.)
- Move autotimestamps to SQLalchemy mixin so it can be used in other modules
- Move other various mixins to their own file
- Fix imports in all the old migrations and tests

Test Plan: Run the tests

Reviewers: emfree

Reviewed By: emfree

CC: spang

Differential Revision: https://review.inboxapp.com/D161"
grinich,2014-05-25 20:02:19,https://api.github.com/repos/nylas/sync-engine/git/commits/34565fd6f972efe6ee43b8cc46723b638c0195a4,34565fd6f972efe6ee43b8cc46723b638c0195a4,cruft cleanup
spang,2014-05-25 15:22:47,https://api.github.com/repos/nylas/sync-engine/git/commits/0b57f7ad75464c98233ded00801534058d2caf9f,0b57f7ad75464c98233ded00801534058d2caf9f,"Don't interpolate unicode into str in trim_filename().

Causes the following crash:

          File ""/vagrant/src/inbox/server/models/message.py"", line 22, in trim_filename
    ""characters. {1}"".format(max_len, s))
        UnicodeEncodeError: 'ascii' codec can't encode character u'\u2014' in position 44: ordinal not in range(128)"
spang,2014-05-25 03:31:01,https://api.github.com/repos/nylas/sync-engine/git/commits/d2a363e57c65aaa0d73d6964a3ca50c1b9124965,d2a363e57c65aaa0d73d6964a3ca50c1b9124965,"Enable passive_deletes for FolderItem and ImapUid.

There may be many entries associated with a deleted label, and it's
vastly more efficient to let the database ON DELETE CASCADE deal with
them than cascading at the ORM layer.

Also, the current code crashes because SQLAlchemy tries to UPDATE
folder_id = NULL, which is a constraint violation."
spang,2014-05-25 03:01:19,https://api.github.com/repos/nylas/sync-engine/git/commits/06276361401f99d9656baf8c07a1f854973ad9c9,06276361401f99d9656baf8c07a1f854973ad9c9,Fix crash when encountering *new* folders/labels.
spang,2014-05-25 02:40:23,https://api.github.com/repos/nylas/sync-engine/git/commits/5af05a2411b6786ac9ab38912d1521cf53fcf476,5af05a2411b6786ac9ab38912d1521cf53fcf476,Gmail/IMAP: sync folder/label names on every poll.
spang,2014-05-25 01:34:51,https://api.github.com/repos/nylas/sync-engine/git/commits/c7b6a8404903ecbfbfb5befab6b128214a11add9,c7b6a8404903ecbfbfb5befab6b128214a11add9,"[SCHEMA] Sync Gmail label deletes.

I know cascades are scary, but I don't see how we could execute this
code with bad data from the remote, and no message objects are ever
deleted by it, just labels on threads and imapuid entries. These deletes
will be synced later anyway, and this reduces our workload and the
complexity of the syncing code."
spang,2014-05-25 00:55:56,https://api.github.com/repos/nylas/sync-engine/git/commits/b7dd3194c54bdf126e89280d89c76b20d35d747b,b7dd3194c54bdf126e89280d89c76b20d35d747b,"Truncate folder names if they're too long.

Due to database limitations, we can't store labels longer than 191
characters, though Gmail labels may be up to 225 characters."
spang,2014-05-25 00:18:52,https://api.github.com/repos/nylas/sync-engine/git/commits/052fb2ebc8b1ae22658a4c97a73db363a2c8ec23,052fb2ebc8b1ae22658a4c97a73db363a2c8ec23,Do IS [NOT] NULL in a pep8-compliant way.
spang,2014-05-25 00:17:41,https://api.github.com/repos/nylas/sync-engine/git/commits/feabab451b14a290adefa3281335b2e7ea21c62a,feabab451b14a290adefa3281335b2e7ea21c62a,Document our different query.get() semantics.
spang,2014-05-25 00:17:11,https://api.github.com/repos/nylas/sync-engine/git/commits/f1d84bc0e512c55fff151f4b60c16268c3a25164,f1d84bc0e512c55fff151f4b60c16268c3a25164,imaplib.IMAP4.abort should trigger conn pool discards too.
spang,2014-05-24 23:51:37,https://api.github.com/repos/nylas/sync-engine/git/commits/09bbb00810cc68a71122cdea3f971817613ba54a,09bbb00810cc68a71122cdea3f971817613ba54a,"Save Gmail labels as folders on sync start.

This also means that we properly create folders for labels which have no
associated messages, which we don't currently do."
spang,2014-05-24 23:33:02,https://api.github.com/repos/nylas/sync-engine/git/commits/fe0b80ae1bbad23c91c49b0531503e6a02402e3b,fe0b80ae1bbad23c91c49b0531503e6a02402e3b,Don't crash if user has no trash or spam folder.
spang,2014-05-24 18:41:13,https://api.github.com/repos/nylas/sync-engine/git/commits/eac01013a82da993885195c71898c506561f8e2e,eac01013a82da993885195c71898c506561f8e2e,"Fix outdated comment.

We've moved to a world where we have Inbox and everything else instead
of All Mail and everything else. Inbox is the special one."
spang,2014-05-24 18:17:38,https://api.github.com/repos/nylas/sync-engine/git/commits/71659f4b01d0915bb1da8db4fa5fa8d8fb55939f,71659f4b01d0915bb1da8db4fa5fa8d8fb55939f,"Sync Trash and Spam on Gmail (after Inbox and All Mail).

These folders are not a part of All Mail, so we have not been syncing
them so far. Fortunately, syncing them turns out to be logically
identical to syncing All Mail."
spang,2014-05-24 04:14:16,https://api.github.com/repos/nylas/sync-engine/git/commits/b00fe9132418799fa10ceaf0b254048bda3ae50b,b00fe9132418799fa10ceaf0b254048bda3ae50b,"Fix slow count() subqueries in webhooks startup.

SQLAlchemy by default when doing a count() on a query will issue the
count over a SELECT subquery, which, if you have a LOT of data you're
selecting, is incredibly slow. For example:

Slow query took 5402.23ms:
SELECT count(*) AS count_1 FROM
(SELECT transaction.table_name AS transaction_table_name,
transaction.record_id AS transaction_record_id, transaction.command AS transaction_command,
transaction.delta AS transaction_delta, transaction.additional_data AS transaction_additional_data,
transaction.id AS transaction_id, transaction.created_at AS transaction_created_at,
transaction.updated_at AS transaction_updated_at, transaction.deleted_at AS transaction_deleted_at,
transaction.namespace_id AS transaction_namespace_id
FROM transaction
WHERE transaction.deleted_at IS NULL AND transaction.table_name = %s AND
transaction.id > %s ORDER BY transaction.id ASC) AS anon_1 with params
('message', -1)

The way to get around this is to use func.count() on the primary key of
what you're trying to count. This works properly even with additional
filters applied.

(There's a reason for this madness, see the sidebar on
http://docs.sqlalchemy.org/en/rel_0_9/orm/tutorial.html#counting.)"
spang,2014-05-24 04:10:43,https://api.github.com/repos/nylas/sync-engine/git/commits/497934fde0c178ec9e1906c00cafe1266c3dbdd9,497934fde0c178ec9e1906c00cafe1266c3dbdd9,Throw a better error when incompatible stuff is passed to session.query().
spang,2014-05-23 22:36:29,https://api.github.com/repos/nylas/sync-engine/git/commits/59fb430407ca3a9bd3e48de0cbbb2d8d00f3bf9d,59fb430407ca3a9bd3e48de0cbbb2d8d00f3bf9d,"[SCHEMA] Index on imapuid.msg_uid, easuid.msg_uid, transaction.table_name.

Courtesy of our hot new slow query logging. Thanks @mg!"
spang,2014-05-23 22:27:58,https://api.github.com/repos/nylas/sync-engine/git/commits/2c55403324dc8d5a0b87830ec910e68202729581,2c55403324dc8d5a0b87830ec910e68202729581,"Simplify save_folder_names() and don't require any folders but Inbox.

In Gmail, you can _turn off_ arbitrary folders except the Inbox from
showing up in the IMAP API, presumably so e.g. people can reduce the
amount of data synced by their desktop email client. We'll have to add
in some mechanism of notifying users that they need to re-enable folders
in IMAP for some Inbox features to work properly, but for now, we can
just skip syncing those folders."
grinich,2014-05-24 01:03:49,https://api.github.com/repos/nylas/sync-engine/git/commits/bf1cd39cfa0ac13682fa6392ac6409c406618f62,bf1cd39cfa0ac13682fa6392ac6409c406618f62,"Check module versions defined in requirements.txt before starting.

Test Plan: Run inbox with an old depdency

Reviewers: emfree, spang

Reviewed By: emfree

Differential Revision: https://review.inboxapp.com/D158"
spang,2014-05-23 21:24:55,https://api.github.com/repos/nylas/sync-engine/git/commits/47ec2f436b28284d2b8bb348d5db07f4f8fd0b6e,47ec2f436b28284d2b8bb348d5db07f4f8fd0b6e,"Always start a new IMAP session on crispin.select_folder().

Starting a session is slow, but it makes sure we're not getting back old
cached values from the IMAP server. The caller of select_folder() should
be able to assume that it's actually getting a new session."
emfree,2014-05-23 21:06:49,https://api.github.com/repos/nylas/sync-engine/git/commits/5bec0d4723bde9a74e6d6a1bf797ccb49a1f78f8,5bec0d4723bde9a74e6d6a1bf797ccb49a1f78f8,Don't load all your contacts into memory.
emfree,2014-05-22 21:54:04,https://api.github.com/repos/nylas/sync-engine/git/commits/9d34670fdd40e36e3d6f1f986eb7ecb2e75f964b,9d34670fdd40e36e3d6f1f986eb7ecb2e75f964b,Move test_sendmail.py to the tests/imap/network directory.
emfree,2014-05-22 21:39:12,https://api.github.com/repos/nylas/sync-engine/git/commits/d48662be491e6fa4d8800341b3fac278ef50f1fc,d48662be491e6fa4d8800341b3fac278ef50f1fc,Don't run tests in tests/imap/network by default.
emfree,2014-05-22 19:44:25,https://api.github.com/repos/nylas/sync-engine/git/commits/f969016a188271171fc755e26aaf077a3621f35a,f969016a188271171fc755e26aaf077a3621f35a,"Fix sendmail tests.

Forgot to update them to not rely on api_client fixture in previous commit."
emfree,2014-05-22 19:30:26,https://api.github.com/repos/nylas/sync-engine/git/commits/0275be8507ee7629907e9974d4a781295771f150,0275be8507ee7629907e9974d4a781295771f150,"Delete old ZeroRPC API.

Summary: Seems we're not really using or maintaining it anymore.

Test Plan: ./runtests

Reviewers: spang

Reviewed By: spang

Differential Revision: https://review.inboxapp.com/D157"
grinich,2014-05-22 19:07:36,https://api.github.com/repos/nylas/sync-engine/git/commits/59377f44291bbbd28baa7a51188a84b676c1bc93,59377f44291bbbd28baa7a51188a84b676c1bc93,"log slow queries

Test Plan: see some slow queries in your logs!

Reviewers: spang

Reviewed By: spang

Differential Revision: https://review.inboxapp.com/D156"
spang,2014-05-21 22:10:28,https://api.github.com/repos/nylas/sync-engine/git/commits/612274de7273175a01f516962d5d83fad44e808b,612274de7273175a01f516962d5d83fad44e808b,"Ignore .dat files.

This is the output from memory_profiler. ;)"
spang,2014-05-21 22:02:56,https://api.github.com/repos/nylas/sync-engine/git/commits/6dfda212c824f3ed28eb3eb4ab60d1fc298c5783,6dfda212c824f3ed28eb3eb4ab60d1fc298c5783,"Ignore man/, which some pip dists use."
spang,2014-05-21 21:22:47,https://api.github.com/repos/nylas/sync-engine/git/commits/8f70af55a1cbe58eea64ca8b40b0f8d67d6a0b8b,8f70af55a1cbe58eea64ca8b40b0f8d67d6a0b8b,"[SCHEMA] Fix nullable constraints on EASUid and EASFoldersync state enum.

Summary:
The former we tightened on Gmail at one point and didn't trickle it back
to EAS. The latter is a bug from way back.

We really need to figure out a better deal for what to do with EAS-only
migrations, but putting it here for now.

Depends on D153

Test Plan: Upgrade/downgrade.

Reviewers: kav-ya

Reviewed By: kav-ya

Differential Revision: https://review.inboxapp.com/D154"
spang,2014-05-21 17:42:36,https://api.github.com/repos/nylas/sync-engine/git/commits/d750f18cda40b211827866913c2887a5c532d0fa,d750f18cda40b211827866913c2887a5c532d0fa,"Can't assume that EAS tables exist in migrations.

This account backend is optional."
spang,2014-05-21 17:12:49,https://api.github.com/repos/nylas/sync-engine/git/commits/1cbd313d92a9834108a3d7656d7e2ca929868c97,1cbd313d92a9834108a3d7656d7e2ca929868c97,"Comment talon dep for now.

Thanks to @Analect for pointing out that this doesn't work."
spang,2014-05-21 16:57:17,https://api.github.com/repos/nylas/sync-engine/git/commits/92b37c642e1c85c784f1802edd10e77bc243275f,92b37c642e1c85c784f1802edd10e77bc243275f,"Use gevent.killall() instead of while loop on sync stop.

A simpler and more robust solution to my fix yesterday, inspired by
learning that killall() exists via Kavya's EAS code."
grinich,2014-05-21 03:24:02,https://api.github.com/repos/nylas/sync-engine/git/commits/0edb2da209c53b49017cf1ea590da6270e23c795,0edb2da209c53b49017cf1ea590da6270e23c795,filename
grinich,2014-05-21 03:14:21,https://api.github.com/repos/nylas/sync-engine/git/commits/707f788f6a8d14b2ee78753b3ced80670dd3d9b5,707f788f6a8d14b2ee78753b3ced80670dd3d9b5,add indexes to timestamp columns
spang,2014-05-21 02:26:57,https://api.github.com/repos/nylas/sync-engine/git/commits/ca1c2179745ee3fc4a236ffdce7021626e1d990e,ca1c2179745ee3fc4a236ffdce7021626e1d990e,"Explicitly set primaryjoin on backrefs.

There's a bug in SQLAlchemy < 0.9.4 where the JOIN condition is
incorrectly generated from primaryjoin conditions which also specify
conditions intended for a backref. The fix is to make backref
primaryjoin conditions explicit.

This was causing cartesian products which OM NOM NOMd all the memory
when objects were loaded via relationships.

For more info, see:
https://bitbucket.org/zzzeek/sqlalchemy/issue/2948/better-replacement-of-columns-w-bound"
spang,2014-05-20 23:22:06,https://api.github.com/repos/nylas/sync-engine/git/commits/af89e683c52895fb956093c4faab1f3ed710687d,af89e683c52895fb956093c4faab1f3ed710687d,Fix add_new_imapuids()
spang,2014-05-20 18:20:42,https://api.github.com/repos/nylas/sync-engine/git/commits/5c0c3d8d10b2dab33ad2610ee980958c0ed4b8a5,5c0c3d8d10b2dab33ad2610ee980958c0ed4b8a5,"Fix syncmanager_lock deadlock in Gmail sync.

Notably, this manifests when trying to run check_new_g_thrids() during
initial sync. It turns out that the code marked ""XXX does this cause a
deadlock?"" ...  caused a deadlock."
spang,2014-05-20 18:22:08,https://api.github.com/repos/nylas/sync-engine/git/commits/d223f062bf8307ae335e8ef0c6e304b2de3ba52a,d223f062bf8307ae335e8ef0c6e304b2de3ba52a,"Never ignore soft deletes in mailsync sessions.

This fixes a potential bug where imapuids deleted in
check_new_g_thrids() will be soft-deleted instead of hard-deleted.
imapuids should never be soft-deleted."
spang,2014-05-20 17:58:56,https://api.github.com/repos/nylas/sync-engine/git/commits/69828ddf5b875141f683b29193b1d7d5a239c1a4,69828ddf5b875141f683b29193b1d7d5a239c1a4,Don't crash if folder monitors for account change during sync stop.
spang,2014-05-20 17:33:39,https://api.github.com/repos/nylas/sync-engine/git/commits/e722897e612af1ae3653400462ee6732e1f9f232,e722897e612af1ae3653400462ee6732e1f9f232,"Deduplicate message download on poll too.

Notably, we don't want to re-download messages downloaded via IDLE
polling on Inbox via polling on All Mail."
spang,2014-05-20 17:23:16,https://api.github.com/repos/nylas/sync-engine/git/commits/5d46c6a949bcab96625a430f3806d6b16cb3bc1b,5d46c6a949bcab96625a430f3806d6b16cb3bc1b,"Eager load namespaces by default.

This is a teeny tiny amount of data and we pretty much always want it.
Eager loading by default simplifies a lot of other code and reduces the
opportunity for errors caused by using joins incorrectly."
spang,2014-05-20 17:09:35,https://api.github.com/repos/nylas/sync-engine/git/commits/6ebf286dff97a31bfe54f1885d32e9d47de4426d,6ebf286dff97a31bfe54f1885d32e9d47de4426d,Eager load associated messages here rather than useless noop join.
grinich,2014-05-20 23:59:55,https://api.github.com/repos/nylas/sync-engine/git/commits/1f37b0540483f0cd1ef59e4637781263765b36a1,1f37b0540483f0cd1ef59e4637781263765b36a1,remove this crap. too hard to understand
emfree,2014-05-20 22:45:40,https://api.github.com/repos/nylas/sync-engine/git/commits/0443b5c89e1dfbc58e3d28b89c0d45cc14d177d2,0443b5c89e1dfbc58e3d28b89c0d45cc14d177d2,"Set ignore_soft_deletes=False in recent migrations.

Otherwise you can't migrate databases that don't have the deleted_at column
yet."
emfree,2014-05-20 20:54:31,https://api.github.com/repos/nylas/sync-engine/git/commits/07ad9a2892566faf317b7812dd6c660ae44fb579,07ad9a2892566faf317b7812dd6c660ae44fb579,"[SCHEMA] Save read status on Message objects; support Gmail 'unread' syncback.

Summary:
 * Add an 'is_read' bit to Message objects, which just mirrors the IMAP
   '\Seen' flag.
 * Add support for syncing back unread status changes (at a per-thread level)
   for Gmail.
 * Also tighten the nullability constraints on 'UserTagItem.created_at' and
   'UserTagItem.updated_at'. This really should have been part of migration
   028; including it here for convenience.

Test Plan: Unit tests added.

Reviewers: spang, mg

Reviewed By: mg

CC: mg

Differential Revision: https://review.inboxapp.com/D150"
emfree,2014-05-20 20:33:08,https://api.github.com/repos/nylas/sync-engine/git/commits/ef9e0403e34b49b2909122a7abcbd7ba94e569ea,ef9e0403e34b49b2909122a7abcbd7ba94e569ea,"Condense whitespace when calculating message snippets.

Summary:
Note that this will not apply to already synced messages.

Fixes T8

Test Plan: Manual testing.

Reviewers: mg

Reviewed By: mg

Maniphest Tasks: T8

Differential Revision: https://review.inboxapp.com/D151"
emfree,2014-05-20 19:11:42,https://api.github.com/repos/nylas/sync-engine/git/commits/b63bfb0dfeee8dffbc4fd5cf23b8bb98083dfb9f,b63bfb0dfeee8dffbc4fd5cf23b8bb98083dfb9f,Fix typo in join condition for contact search tokens.
grinich,2014-05-20 03:20:00,https://api.github.com/repos/nylas/sync-engine/git/commits/893892aa25058cd42080c1dc2bce44f7ed93466d,893892aa25058cd42080c1dc2bce44f7ed93466d,tx logging
grinich,2014-05-20 03:18:21,https://api.github.com/repos/nylas/sync-engine/git/commits/0fd1357bda80f96c1433b173367bf4a0a7e4c45a,0fd1357bda80f96c1433b173367bf4a0a7e4c45a,remove commit_account. saving too lines isn't worth having another function
emfree,2014-05-20 02:33:04,https://api.github.com/repos/nylas/sync-engine/git/commits/ea1b5bcd13c2a91fdb4edcc64d460d3cea082a0f,ea1b5bcd13c2a91fdb4edcc64d460d3cea082a0f,"Fix Lens unit tests.

With the previous commit, a lens should *always* take a Unix timestamp for any
time-related parameters (previously, the expectations were implicitly and
erroneously different for API query filtering and webhook filtering)."
emfree,2014-05-20 01:57:17,https://api.github.com/repos/nylas/sync-engine/git/commits/12b1d552e0696715576980304d3c6d5943822acb,12b1d552e0696715576980304d3c6d5943822acb,"Validate query parameter input.

Check API query parameter values to make sure they make sense, and return 400
if they don't."
grinich,2014-05-20 00:04:56,https://api.github.com/repos/nylas/sync-engine/git/commits/3c327502fa86415c545e6513e46740fda32a5789,3c327502fa86415c545e6513e46740fda32a5789,errormsg in subject line
spang,2014-05-16 21:56:26,https://api.github.com/repos/nylas/sync-engine/git/commits/96684f6ead2c56a52eaa689da04003aeb1150538,96684f6ead2c56a52eaa689da04003aeb1150538,"Bump requests dep to 2.3.0.

Lots of good fixes in this one."
spang,2014-05-16 21:55:59,https://api.github.com/repos/nylas/sync-engine/git/commits/5a2847f58703ff0ec62d5e4d9271ca664cc3462b,5a2847f58703ff0ec62d5e4d9271ca664cc3462b,Lint inbox.util.html.
spang,2014-05-16 18:10:23,https://api.github.com/repos/nylas/sync-engine/git/commits/f5140393141fedb657b427fea4cb7abebc4117f7,f5140393141fedb657b427fea4cb7abebc4117f7,"Replace BeautifulSoup with talon.

Faster and less memory intensive for our use case."
spang,2014-05-16 02:35:57,https://api.github.com/repos/nylas/sync-engine/git/commits/12e5c3e7d6644229591f97266b4e5a8bd7879f44,12e5c3e7d6644229591f97266b4e5a8bd7879f44,"Fix bug where Gmail sync doesn't actually add imapuid entries sometimes.

SQLAlchemy was silently dropping the Folder filter condition because I
did not explicitly join() it on the query."
spang,2014-05-16 01:53:06,https://api.github.com/repos/nylas/sync-engine/git/commits/73428d10fc8522789535f26ca234d9fff02b06b4,73428d10fc8522789535f26ca234d9fff02b06b4,More log messages.
spang,2014-05-15 23:46:19,https://api.github.com/repos/nylas/sync-engine/git/commits/19b661ed883537a1aae4873e70999209c2381dc2,19b661ed883537a1aae4873e70999209c2381dc2,"[DEPENDENCIES] Add clear-cache tool.

Whenever we make an upgrade that e.g. changes the format, data types, or
other parts of cached data, we need to clear the existing cache on a
server restart. Here's a tool to do that.

I chose to use the click library for this tool because it's a really
nice interface for writing CLI scripts. We should use it more going
forward!"
spang,2014-05-15 22:32:04,https://api.github.com/repos/nylas/sync-engine/git/commits/5d42f40cd9e4b47d446f0b977998c70e6791d97a,5d42f40cd9e4b47d446f0b977998c70e6791d97a,"Don't make type coercions in db wrapper functions.

We should always be returning the straight-up types defined by the db columns."
spang,2014-05-15 22:03:06,https://api.github.com/repos/nylas/sync-engine/git/commits/0d5cef053051931b69506cd6513e2805d732002b,0d5cef053051931b69506cd6513e2805d732002b,"Standardize Crispin types.

We now always coerce inputs to strings before passing them off to the
IMAPClient connection, and convert numbers to long ints before returning
them to the caller, so callers don't have to check types or coerce
themselves.

We are standardizing on *always* treating UIDs, X-GM-MSGID, and
X-GM-THRID as integers when just passing them around."
grinich,2014-05-16 02:56:28,https://api.github.com/repos/nylas/sync-engine/git/commits/5a5ce71193733e8981ab6fbf40480cbbb46ab084,5a5ce71193733e8981ab6fbf40480cbbb46ab084,Setup `/n/` API endpoint within the blueprint
grinich,2014-05-16 02:56:09,https://api.github.com/repos/nylas/sync-engine/git/commits/0d431ba73d90323f9330213fa0963a4eaaa1499b,0d431ba73d90323f9330213fa0963a4eaaa1499b,move these to other repo
emfree,2014-05-15 23:50:46,https://api.github.com/repos/nylas/sync-engine/git/commits/808a49725e1b7cadd8696aa1166e9845602fe29c,808a49725e1b7cadd8696aa1166e9845602fe29c,Put the latest migration where it belongs.
emfree,2014-05-15 23:09:18,https://api.github.com/repos/nylas/sync-engine/git/commits/c7398ae574cb95cfae6876839b5ba08cfb0a9e81,c7398ae574cb95cfae6876839b5ba08cfb0a9e81,"[SCHEMA] Correctly set public_id and exposed_name for existing 'Inbox' folders.

This commit does not actually alter the schema, but does include a migration.
The previous migration was not correctly setting the public_id and exposed_name
fields on existing Gmail 'Inbox' folders. This fixes that."
spang,2014-05-15 22:54:49,https://api.github.com/repos/nylas/sync-engine/git/commits/9c549c94fa6d3752da00b4e82bbf2ae35e0aa4af,9c549c94fa6d3752da00b4e82bbf2ae35e0aa4af,"Properly short-circuit out of InboxSession.add() when soft deletes disabled.

Otherwise this code will crash."
emfree,2014-05-15 22:24:44,https://api.github.com/repos/nylas/sync-engine/git/commits/9a54dd6d036e8d1ab9c089a3a370552d0bd15b1a,9a54dd6d036e8d1ab9c089a3a370552d0bd15b1a,"[SCHEMA] Begin adding tag support to API.

Summary:
 * Rename InternalTag to UserTag, and add another table SystemTag for reserved,
   Inbox-managed tags that don't map to a backend folder (e.g., ""sending"",
   files"")

 * Support folder name aliasing, so that we can handle Gmail's messy
   labels-aka-folders abstraction. I.e., treat ""Sent"" and ""[Gmail]/Sent Mail""
   as the same folder.

 * Make the relationship between threads and tags many-to-many.

 * Add exposed_name and public_id fields to the Folder table to store the names
   we use when when exposing the folder as a tag.

 * Support tag as a query parameter in API queries. Current limitations:
   - Can only match on one tag at a time.
   - Can't match on public_id of user-created tag.

Test Plan: Ha! Not really. I did play with it a bit though.

Reviewers: spang, mg

Reviewed By: spang

CC: bengotow

Differential Revision: https://review.inboxapp.com/D148"
spang,2014-05-15 00:14:52,https://api.github.com/repos/nylas/sync-engine/git/commits/9e61b6a25b8ca2cfa00645362da102ccf3a709c0,9e61b6a25b8ca2cfa00645362da102ccf3a709c0,Better log message for crispin_client.g_metadata().
grinich,2014-05-15 00:03:22,https://api.github.com/repos/nylas/sync-engine/git/commits/18b5b61f82069d8987ac63c4de5ab41fe227b2d2,18b5b61f82069d8987ac63c4de5ab41fe227b2d2,update root path info
grinich,2014-05-14 23:42:13,https://api.github.com/repos/nylas/sync-engine/git/commits/f67c0192093a3a16daabfda18ca0845b0aa9da3e,f67c0192093a3a16daabfda18ca0845b0aa9da3e,"move docs to python module, served via different service"
emfree,2014-05-14 23:53:50,https://api.github.com/repos/nylas/sync-engine/git/commits/dbbe83872533557f61873f0fd0a98c6f44a7d65a,dbbe83872533557f61873f0fd0a98c6f44a7d65a,Revert breaking changes to tests/imap/test_sendmail.py.
emfree,2014-05-14 23:50:17,https://api.github.com/repos/nylas/sync-engine/git/commits/b1fa6db3ce0494d4e3b1a4f8554a948d3d468891,b1fa6db3ce0494d4e3b1a4f8554a948d3d468891,Update tags API docs.
spang,2014-05-14 23:37:38,https://api.github.com/repos/nylas/sync-engine/git/commits/ce11f7183f98dcbb8fa30eed03878b14195c924b,ce11f7183f98dcbb8fa30eed03878b14195c924b,"Fix IMAP/Gmail mailsync logging.

Oof, we renamed this logger at some point, since we've expanded to
syncing more than just mail."
spang,2014-05-14 23:14:36,https://api.github.com/repos/nylas/sync-engine/git/commits/e1cb55526c6c3c55456106bf05f0abc5f8f69526,e1cb55526c6c3c55456106bf05f0abc5f8f69526,[SCHEMA] Delete soft-deleted imapuids.
spang,2014-05-14 21:16:18,https://api.github.com/repos/nylas/sync-engine/git/commits/c60c8b4b32bad8115bb4ab345de160bb3576fd65,c60c8b4b32bad8115bb4ab345de160bb3576fd65,Don't ignore soft deletes in IMAP/Gmail mail sync backend.
spang,2014-05-14 17:50:57,https://api.github.com/repos/nylas/sync-engine/git/commits/837ff7dff404108d50e5add345a924e4964adb89,837ff7dff404108d50e5add345a924e4964adb89,"Tighten imapuid message check filter.

There's a potential bug here that just hasn't popped up yet."
spang,2014-05-14 00:47:46,https://api.github.com/repos/nylas/sync-engine/git/commits/882638e2a84eae992bb9301f2adf7d27f7f3b910,882638e2a84eae992bb9301f2adf7d27f7f3b910,Reference IRC channel in README.
spang,2014-05-14 00:27:59,https://api.github.com/repos/nylas/sync-engine/git/commits/7111de2d6846a9e39d81d46078803bbda4c6f9b8,7111de2d6846a9e39d81d46078803bbda4c6f9b8,"[SCHEMA] Implement audit timestamps and soft deletes on all tables.

Summary:
This is also the first start in creating our own custom ORM layer on top
of SQLAlchemy which supports automatically excluding soft-deleted rows
and, eventually, constraining results by namespace.

The API we have implemented simply wraps a SQLAlchemy session object and
provides a compatible API. If you define a relationship() on a mapper,
you also MUST make sure to manually exclude deletes via a custom
`primaryjoin`. There does not appear to be a public API available to
automatically instrument all SQLAlchemy relationships.

Test Plan: ./runtests and ./runtests -i pass

Reviewers: mg, emfree, kav-ya

Reviewed By: kav-ya

Differential Revision: https://review.inboxapp.com/D145"
spang,2014-05-13 23:12:35,https://api.github.com/repos/nylas/sync-engine/git/commits/5c67cf046d3b7108c6541192ca187aed16a871fa,5c67cf046d3b7108c6541192ca187aed16a871fa,"Automatically email exceptions from prod/staging.

Test Plan:
Can't reaaally test until we get back to the office, but ""works
on my machine""...

Reviewers: emfree

Reviewed By: emfree

Differential Revision: https://review.inboxapp.com/D147"
kav-ya,2014-05-12 21:50:18,https://api.github.com/repos/nylas/sync-engine/git/commits/12d9d6f3dd08bd271d8117d6ccce18dab2fff8a2,12d9d6f3dd08bd271d8117d6ccce18dab2fff8a2,"Update migration 024 to do the right thing + preserve data for EAS accounts as well.

Summary:
If EAS accounts are in the database and we use a different migration to update the EASUid table,
all sorts of errors are thrown. We therefore need this migration to make the needed EAS schema
changes too. The changes have the convenient side-effect of data preservation for EAS accounts too.

Test Plan: Tested on dumps with Gmail, EAS accounts.

Reviewers: spang

Reviewed By: spang

CC: mg

Differential Revision: https://review.inboxapp.com/D146"
kav-ya,2014-05-12 19:35:12,https://api.github.com/repos/nylas/sync-engine/git/commits/8685d311002a40b00ca8289a1a5ff640767add53,8685d311002a40b00ca8289a1a5ff640767add53,"Update migration 024 to do the right thing + preserve data for EAS accounts as well.

Summary:
If EAS accounts are in the database and we use a different migration to update the EASUid table,
all sorts of errors are thrown. We therefore need this migration to make the needed EAS schema
changes too. The changes have the convenient side-effect of data preservation for EAS accounts too.

Test Plan: Tested on dumps with Gmail, EAS accounts.

Reviewers: spang

CC: mg

Differential Revision: https://review.inboxapp.com/D146"
grinich,2014-05-11 02:12:28,https://api.github.com/repos/nylas/sync-engine/git/commits/77f478be06efadbb6734c119689cd67c2d1f54df,77f478be06efadbb6734c119689cd67c2d1f54df,typo
grinich,2014-05-11 02:12:01,https://api.github.com/repos/nylas/sync-engine/git/commits/e18a2ef9cbf2b15f4c6d50f44c535391d00765c5,e18a2ef9cbf2b15f4c6d50f44c535391d00765c5,"Kill if database is out of date

closes https://app.asana.com/0/5241592671238/11790859167796"
kav-ya,2014-05-09 23:58:45,https://api.github.com/repos/nylas/sync-engine/git/commits/ac3a3c916d1cf721999ac059f531b40c474621a3,ac3a3c916d1cf721999ac059f531b40c474621a3,"Migration 024 does not throw KeyError if EAS accounts are in the database.
NOTE:
Data for Exchange accounts is still blown away (preserving it is not necessary right now), we just don't err anymore."
kav-ya,2014-05-09 23:15:08,https://api.github.com/repos/nylas/sync-engine/git/commits/9567d2ba46d6f2b8111fa3834553cc52a14d9757,9567d2ba46d6f2b8111fa3834553cc52a14d9757,Rename the ImapUid/Folder relationship backref in migration 024 too
kav-ya,2014-05-09 21:45:49,https://api.github.com/repos/nylas/sync-engine/git/commits/68bb932435c39061fd90c3721e4578a8d79e91e2,68bb932435c39061fd90c3721e4578a8d79e91e2,"Rename the reverse ImapUid/Folder relationship to 'imapuids' (from 'uids').
We do this so as to support a similar EASUid/Folder relationship."
grinich,2014-05-09 21:24:00,https://api.github.com/repos/nylas/sync-engine/git/commits/12c64b1315afc51c5176cc8a5317b645dcd82676,12c64b1315afc51c5176cc8a5317b645dcd82676,"Remove User, SharedFolder, and UserSession from models and API

Summary: spring cleaning

Test Plan: all tests pass

Reviewers: spang

Reviewed By: spang

Differential Revision: https://review.inboxapp.com/D144"
spang,2014-05-09 19:18:21,https://api.github.com/repos/nylas/sync-engine/git/commits/822cc7cdc36819c8c5b2e89afee57a1b4e425c52,822cc7cdc36819c8c5b2e89afee57a1b4e425c52,"Update imapuid index name to reflect latest columns.

No migration included here because foreign key constraints already
caused mysql to DTRT, albeit without the rename."
grinich,2014-05-09 11:50:14,https://api.github.com/repos/nylas/sync-engine/git/commits/59307ab06442cabfcecb6ceffe04e623860b72c2,59307ab06442cabfcecb6ceffe04e623860b72c2,cURL
grinich,2014-05-09 11:32:13,https://api.github.com/repos/nylas/sync-engine/git/commits/d7653986fb560bf5e20c701471f5c2c0d6162e7f,d7653986fb560bf5e20c701471f5c2c0d6162e7f,move functions from srv.py to ns_api.py
grinich,2014-05-09 08:54:40,https://api.github.com/repos/nylas/sync-engine/git/commits/1532ff75e055a506559186e68d9c4bd9f7a0c4b8,1532ff75e055a506559186e68d9c4bd9f7a0c4b8,cleaner way to sanitize paths
grinich,2014-05-09 08:43:04,https://api.github.com/repos/nylas/sync-engine/git/commits/274107e60d627b2fa7044644ed9d526b7bf0bd8a,274107e60d627b2fa7044644ed9d526b7bf0bd8a,make api a module within inbox
grinich,2014-05-09 08:40:51,https://api.github.com/repos/nylas/sync-engine/git/commits/2b085b4764acd5395b5b8819bc1e3767b06c281e,2b085b4764acd5395b5b8819bc1e3767b06c281e,many small changes to docs and templates
kav-ya,2014-05-06 22:10:25,https://api.github.com/repos/nylas/sync-engine/git/commits/1e95da2c01c571b6b055ed9e54c3ff36b4a526da,1e95da2c01c571b6b055ed9e54c3ff36b4a526da,"Sendmail code uses new schema, tests pass."
spang,2014-05-08 23:11:44,https://api.github.com/repos/nylas/sync-engine/git/commits/e847e973ff447bc8710ebf301dfd381daa6350e1,e847e973ff447bc8710ebf301dfd381daa6350e1,"[SCHEMA] Split folders into account backend folders/labels and internal tags.

Summary:
Note that associated fixes for sending mail are in a dependent revision, D140.

[SCHEMA] Separate tables for backend folders/labels and Inbox-internal Tags.

Following a design discussion, we are splitting our notion of folders
and tags into two different things: folders/labels from the account
backend (e.g. Gmail), and Inbox-specific tags, called InternalTag
(trying to reduce term overloading here).

Port Gmail code to new folder/label schema.

With this change, we rip out folder name translation for Gmail labels
and store them as-is. Special Inbox labels will be provided via
different queries; they no longer are stored specially in the database.

Split actions into local/remote, subsuming old API functions.

Since we are now mirroring folders/labels from remote accounts to our
local data store as-is, we no longer have a unified API for what e.g.
'local archive' means for any given message. We solve this by expanding
the actions API to also cover local actions.

Test Plan: ./runtests and ./runtests -i (Kavya's handling send & EAS)

Reviewers: mg, kav-ya

Reviewed By: kav-ya

Differential Revision: https://review.inboxapp.com/D134"
spang,2014-05-08 22:12:55,https://api.github.com/repos/nylas/sync-engine/git/commits/4fac03d7fd9f4c76094992b94031e652d55fd1b6,4fac03d7fd9f4c76094992b94031e652d55fd1b6,Fix weird merge.
spang,2014-05-08 22:09:34,https://api.github.com/repos/nylas/sync-engine/git/commits/4f00546a45892d19b8c0577f0e23024380be4549,4f00546a45892d19b8c0577f0e23024380be4549,"[SCHEMA] Fix two major concurrency-related Gmail sync crash bugs.

Summary:
Long explanation:

(bug 1)

It turns out that the relationship between ImapUid and Message was configured
as 1-to-1 for legacy reasons. (Pre thread expansion this invariant was true.)
So when we created a *second* ImapUid row for a given Message object, which,
when downloading a message from Inbox, happens to be the Inbox row, not the All
Mail row, we would set `message_id = NULL` for the first row, courtesy of
sqlalchemy. (Messages downloaded //only// via All Mail only have one ImapUid
row still.)

Then the deduplication code on the All Mail sync would call
`backends/imap/account/g_msgids()` to get a list of local `g_msgids` to
deduplicate download on. This function joins on `Message` to get the `g_msgid`.
Because `message_id` was not associated with the message for the All Mail
imapuid anymore, that message would be downloaded again and the code would
crash trying to insert the new imapuid into the database, because it already
existed, albeit with a NULL message_id. (There's also a second deduplication
stage after download/before insertion, but that ALSO fails because of the
`message_id = NULL` problem.)

I am pretty sure this bug can happen even without a restart. BUT, on restarts,
if messages are ARCHIVED from the Inbox, we delete the associated imapuids...
which, previously, would cascade to associated Message objects, assuming a
1-to-1 relationship. This would cause more `message_id = NULL` madness and more
dedupe bugs. I suspect restarts are more likely to cause this race because of
everything happening at once, though our IDLE poller during initial sync also
detects deletes.

We fix this by removing the relationship cascade and tightening
ImapUid.message_id with `nullable=False`. (Unrelatedly, we also tighten
the NULL constraint on `msg_uid`, which is inexplicably also nullable.)

Initially, `message_id` was nullable to support local delete detection, but
we're going to do that by adding `deleted_at` columns to all tables instead.
Deleted objects will eventually be garbage collected by a separate service.
Way safer.

(bug 2)

So say you download a message via `Inbox`... the Gmail sync code creates
imapuid entries for both `Inbox` and `All Mail`.  Then the `All Mail` initial
sync greenlet starts up (this race is *way* more likely after a restart). It
calls `deduplicate_message_download`, which notices that the message has been
already downloaded... and tries to create the imapuid again. Turns out this
code shouldn't create new imapuid rows when running on the All Mail folder.

We fix with a conditional check on the folder name in `add_new_imapuids`.

---

This fix brought to you by driving around SF in a minivan with a ukelele, a
long dinner with friends, a hot shower, pushups and squats, back-and-forths
with @emfree spanning days, and Moderat.

Test Plan: manually running a sync and start/stopping a few times

Reviewers: emfree, mg

Reviewed By: emfree

CC: emfree, mg, kav-ya

Differential Revision: https://review.inboxapp.com/D143"
spang,2014-05-08 19:30:55,https://api.github.com/repos/nylas/sync-engine/git/commits/8b00af31266fc30b0df632aefe5e948640261c91,8b00af31266fc30b0df632aefe5e948640261c91,"Fix two major concurrency-related Gmail sync bugs.

It might not be all of them, but at least it's some of them."
emfree,2014-05-08 18:43:39,https://api.github.com/repos/nylas/sync-engine/git/commits/4b5b82c6ea8b1c3d65c443c09a28e0db757f0325,4b5b82c6ea8b1c3d65c443c09a28e0db757f0325,"Remove unused test file in Inbox root directory.

Seems this is a stray test database dump that somehow got added to the
repository."
emfree,2014-05-08 18:43:25,https://api.github.com/repos/nylas/sync-engine/git/commits/179d4bf988e55e1df644c1081aecd35ff9f96176,179d4bf988e55e1df644c1081aecd35ff9f96176,"Support creating, reading, and searching contacts via API.

Summary:
* Update corresponding documentation.
* Remove deprecated functions from old api.py file (keep corresponding unit
  tests as reference for eventually unit-testing the new API functions, but
  mark as xfail).

Test Plan: Manual testing.

Reviewers: mg

Reviewed By: mg

CC: bengotow

Differential Revision: https://review.inboxapp.com/D142"
emfree,2014-05-08 01:55:42,https://api.github.com/repos/nylas/sync-engine/git/commits/d7f8c920c33853f46d53da0f9e5a2bae4ff6e140,d7f8c920c33853f46d53da0f9e5a2bae4ff6e140,"Fix typos in API docs; better align code behavior with docs.

* Fix some small typos.
* Clarify that webhooks may be started and stopped, but are otherwise
  immutable.
* Set webhook include_body parameter to False by default, per documentation.
* Add support for getting all registered webhooks on a namespace, per
  documentation."
emfree,2014-05-07 18:31:01,https://api.github.com/repos/nylas/sync-engine/git/commits/f8f880788535f73c7c3cc015deac94a7140075cd,f8f880788535f73c7c3cc015deac94a7140075cd,"Add some support for webhooks to API; fix related bugs.

Summary:
* Standardize parameter names across API documentation and implementation: use
  'to', 'from', etc. everywhere, instead of sometimes using 'to_addr', etc.
* Add API support for creating, reading, and starting/stopping hooks.
* Concomitantly add support to the webhook service for starting/stopping hooks
  via ZeroRPC.
* Fix a bug where we wouldn't actually filter transactions on any_email.
* Simplify and standardize variable naming in the webhook service.

Test Plan: Manual testing.

Reviewers: mg

Reviewed By: mg

Differential Revision: https://review.inboxapp.com/D141"
emfree,2014-05-07 18:23:19,https://api.github.com/repos/nylas/sync-engine/git/commits/bf50f50c226ae3d3f5c33bd1a9a2a28bff33b195,bf50f50c226ae3d3f5c33bd1a9a2a28bff33b195,"Update example URLS in API docs.

Make sure they contain /n/<namespace_id> where appropriate."
kav-ya,2014-05-06 21:13:49,https://api.github.com/repos/nylas/sync-engine/git/commits/0bf47ae6bf1d7c163eecc71e603b99e579a2d7fe,0bf47ae6bf1d7c163eecc71e603b99e579a2d7fe,"SMTPConnectionPool is a pool of our SMTPConnection instances rather than smtplib's SMTPConnections.

The problem:
We created the SMTP connections at pool instantiation but did not use them till later; by then,
the server might have disconnected causing us to get SMTPServerDisconnectedErrors that we
had no way to handle.

The fix:
SMTPConnectionPool is a pool of our SMTPConnection instances. Each instance is a wrapper around
an (smtplib's) SMTP connection, which takes care of reconnecting if needed.

This will also simplify the implementation of retry-sending when we decide a scheme for it.

Tests:
All sendmail tests pass consistently without raising those errors now."
spang,2014-05-06 19:31:35,https://api.github.com/repos/nylas/sync-engine/git/commits/56a5207e5b685a34362c26071db49decfe8bb574,56a5207e5b685a34362c26071db49decfe8bb574,"Maaaybe fix a race creating ImapUids.

Summary: We weren't locking some instances of creating new ImapUid entries.

Test Plan: Try to reproduce the crash...

Reviewers: emfree

Reviewed By: emfree

Differential Revision: https://review.inboxapp.com/D138"
emfree,2014-05-06 19:30:58,https://api.github.com/repos/nylas/sync-engine/git/commits/c0839502ec2a26e60b586683d39b4e70629ab109,c0839502ec2a26e60b586683d39b4e70629ab109,"Fix limit and offset parameter handling in API.

Summary:
Fix limit and offset parameter handling in API.

The Lens class doesn't take limit and offset parameters as class attributes;
they need to be passed to the message_query and thread_query methods.

Also allow offset to be applied on explicitly unlimited queries, and
fix an unrelated missing-argument typo in webhook.py.

Test Plan: Manual testing.

Reviewers: mg

Reviewed By: mg

Differential Revision: https://review.inboxapp.com/D139"
emfree,2014-05-05 22:57:24,https://api.github.com/repos/nylas/sync-engine/git/commits/c912a5be215ecde4b939ba6e2657a13d48f41beb,c912a5be215ecde4b939ba6e2657a13d48f41beb,Fix another missing-argument typo in webhook.py.
grinich,2014-05-06 02:56:18,https://api.github.com/repos/nylas/sync-engine/git/commits/3b38559bd8067713ffb267ab9b647b63d90f0b26,3b38559bd8067713ffb267ab9b647b63d90f0b26,"[SCHEMA] Consolidate Webhook filters with new `Lens` class.

Summary:
- Combines `DatabaseFilter` and `TransactionalDataFilter` into the single `Lens` object which is used to filter data in both cases.

- Called ""lens"" because it is used to filter/focus something. Also because the word ""filter"" is used way too much in SQLalchemy and it would be confusing to differentiate.

- Still left to do is connect this to webhooks as filter objects and write moar tests.

Test Plan: Run migration and all tests pass

Reviewers: emfree

Reviewed By: emfree

Differential Revision: https://review.inboxapp.com/D135"
spang,2014-05-06 01:29:02,https://api.github.com/repos/nylas/sync-engine/git/commits/4c341aa8cc3b65d30660228e9a0f3710dfcc1e90,4c341aa8cc3b65d30660228e9a0f3710dfcc1e90,Make the console work again.
spang,2014-05-06 01:23:29,https://api.github.com/repos/nylas/sync-engine/git/commits/c8d546a6faaef998079a190ddf641472338d213a,c8d546a6faaef998079a190ddf641472338d213a,Update out-of-date comment.
emfree,2014-05-05 22:36:00,https://api.github.com/repos/nylas/sync-engine/git/commits/6e5dff9b3babdc6f9de97511a5b7bf8d62db2bbb,6e5dff9b3babdc6f9de97511a5b7bf8d62db2bbb,"Catch ConnectionError in webhook worker code.

Also fix missing-argument typo in webhook.py, and actually return True from
WebhookWorker.execute on success."
emfree,2014-05-05 22:27:26,https://api.github.com/repos/nylas/sync-engine/git/commits/8c9f5b361635204a6d73a9744440a5fa289d8376,8c9f5b361635204a6d73a9744440a5fa289d8376,"Always define `data` attribute in EventData constructor.

`transaction.delta` may sometimes be None (for example, for transactions
corresponding to deletions). Previously this would lead to an AttributeError in
`WebhookWorker.filter`, causing the webhook service to fail."
spang,2014-05-05 21:51:18,https://api.github.com/repos/nylas/sync-engine/git/commits/a88e1adb7d029f7254b7ee6ba37e4e99a57cb4eb,a88e1adb7d029f7254b7ee6ba37e4e99a57cb4eb,Clean up a few little pieces of code with defaultdicts.
spang,2014-05-05 21:36:49,https://api.github.com/repos/nylas/sync-engine/git/commits/b248bbcf30e87fa0e1027ac0096d4d943257e0b6,b248bbcf30e87fa0e1027ac0096d4d943257e0b6,"Rip out (currently not working) sync_status() and related test.

Summary:
Right now the failing test makes it harder to make sure ongoing work isn't
breaking anything new. I'm not really sure what's going on with the failing
test (it gets a timeout trying to query the sync server, is something
blocking?), but given that we're replacing this code with a new method of
keeping track of and querying sync status, I don't think it's worth our time to
debug it.

Test Plan: ./runtests

Reviewers: emfree

Reviewed By: emfree

Differential Revision: https://review.inboxapp.com/D136"
emfree,2014-05-05 18:39:19,https://api.github.com/repos/nylas/sync-engine/git/commits/94941220b3435d946144a4ab3a06978e6aa261d2,94941220b3435d946144a4ab3a06978e6aa261d2,Don't return internal namespace id in 404 error messages.
emfree,2014-05-05 18:37:52,https://api.github.com/repos/nylas/sync-engine/git/commits/b42864c748e7e16b21b3d08b7e021e80ca449726,b42864c748e7e16b21b3d08b7e021e80ca449726,Return 404 instead of 500 on nonexistent namespace ids.
emfree,2014-05-05 18:19:45,https://api.github.com/repos/nylas/sync-engine/git/commits/19838cc822f4e571a9c274d8307020ecc80654b2,19838cc822f4e571a9c274d8307020ecc80654b2,"Remove redundant namespace filter in thread_query_api().

`g.filter` gets the namespace id on instantiation, and already filters by it in
`g.filter.thread_query`. Since this also applies a limit and offset, calling
`Query.filter()` again in `thread_query_api` causes the error:

InvalidRequestError: Query.filter() being called on a Query which already has
LIMIT or OFFSET applied. To modify the row-limited results of a Query, call
from_self() first. Otherwise, call filter() before limit() or offset() are
applied."
spang,2014-05-05 18:16:56,https://api.github.com/repos/nylas/sync-engine/git/commits/0312b48d75b49199c1c219ceba5940e1dda02c09,0312b48d75b49199c1c219ceba5940e1dda02c09,"Sync test config with config-sample.cfg.

Folks often forget to update this when they make changes to the main
config file."
emfree,2014-05-05 17:59:02,https://api.github.com/repos/nylas/sync-engine/git/commits/7db191596b768935182528cfde14c581c10707f3,7db191596b768935182528cfde14c581c10707f3,"Update tests/general/test_filter.py to test limit functionality.

Also make our datetime arithmetic a little more concise."
grinich,2014-05-04 19:01:48,https://api.github.com/repos/nylas/sync-engine/git/commits/1ce8753c5b97968043fe722de0b533a22f62445b,1ce8753c5b97968043fe722de0b533a22f62445b,initial CORS support
grinich,2014-05-04 19:01:31,https://api.github.com/repos/nylas/sync-engine/git/commits/fe6f8fb07bcf7c27dff2d959a7282102618ccc8d,fe6f8fb07bcf7c27dff2d959a7282102618ccc8d,remove unnecessary configvars
grinich,2014-05-04 19:01:11,https://api.github.com/repos/nylas/sync-engine/git/commits/01bdcffcb161a9908ebbb53c242c3c37ea5903d5,01bdcffcb161a9908ebbb53c242c3c37ea5903d5,api docs changes
grinich,2014-05-04 12:20:51,https://api.github.com/repos/nylas/sync-engine/git/commits/38b87ea914be5d0ec9932f7246be3ab84d09903c,38b87ea914be5d0ec9932f7246be3ab84d09903c,fix a tx bug and add some logging
grinich,2014-05-04 11:14:41,https://api.github.com/repos/nylas/sync-engine/git/commits/bb58b770443eb4369bea8ac9fa56707b6995812a,bb58b770443eb4369bea8ac9fa56707b6995812a,"[DEPENDENCIES] Switch to PyMySQL

Our previous MySQL adapter doesn't play nicely with Gevent, and would block the entire process on queries. This became super apparent when trying to serve the static docs from the same process that was running expensive API requests.

PyMySQL is an all-Python database connector that works great with greenlets and Gevent's monkey patching. It has hundreds of stars on GitHub[1], and a vibrant community.

Technically it's a bit slower[2] than the pure C implementation, but I don't imagine that will have a significant effect for us. Effectively not blocking is way more important. Plus, it's pure Python in case we want to move to PyPy someday.

This commit also fixes a related bug where we were relying on the database adapter to coerce the uuid objects to strings.

[1] https://github.com/PyMySQL/PyMySQL

[2] https://github.com/Tin/sqlalchemy-gevent-mysql-drivers-comparison"
grinich,2014-05-04 07:19:58,https://api.github.com/repos/nylas/sync-engine/git/commits/e99b325dc2bc6823b65b508361c73c4f41ffb970,e99b325dc2bc6823b65b508361c73c4f41ffb970,fix test DB from previous commit
grinich,2014-05-04 07:04:56,https://api.github.com/repos/nylas/sync-engine/git/commits/431632496057cef181a75593c24b8827a9a7fc7f,431632496057cef181a75593c24b8827a9a7fc7f,Fix alembic history
grinich,2014-05-04 06:25:38,https://api.github.com/repos/nylas/sync-engine/git/commits/6b8a42e7b615026ce580c34c25824a159b56bd2d,6b8a42e7b615026ce580c34c25824a159b56bd2d,some docs changes
grinich,2014-05-04 06:25:23,https://api.github.com/repos/nylas/sync-engine/git/commits/42ee96694c9789e25a1c52007d52c65c5bb66de6,42ee96694c9789e25a1c52007d52c65c5bb66de6,specify greenlet version since I think the new gevent is missing it
grinich,2014-05-04 02:11:37,https://api.github.com/repos/nylas/sync-engine/git/commits/759cda25b50bbd0c41af4cef28b03925d98b8422,759cda25b50bbd0c41af4cef28b03925d98b8422,"brief docs on webhooks, along with API serialization"
kav-ya,2014-05-03 23:11:35,https://api.github.com/repos/nylas/sync-engine/git/commits/b22a541dd4d40605e4d3f034768ad7cb0cb14b52,b22a541dd4d40605e4d3f034768ad7cb0cb14b52,"Tests use new test dump (for sendmail purposes), tests updated too."
kav-ya,2014-04-29 23:09:10,https://api.github.com/repos/nylas/sync-engine/git/commits/730d5be4f306325195332a4cd034da1d218469a1,730d5be4f306325195332a4cd034da1d218469a1,"Reconciliation gotchas fixed,
Sendmail tests,
Delete behavior for SpoolMessages,

[Not For Review (yet)]: Subtle Reconcile gotchas fixed

Sendmail syncback, reconciliation tests for reply

[Not For Review] v1 delete behavior for SpoolMessages"
kav-ya,2014-04-29 06:51:00,https://api.github.com/repos/nylas/sync-engine/git/commits/fc019b422f3af97e86d2a6f89bd243c12a0e8ec9,fc019b422f3af97e86d2a6f89bd243c12a0e8ec9,"D116 CR changes incl.: Restructuring sendmail directory, more descriptive docstrings, linting, test changes."
kav-ya,2014-04-25 00:41:16,https://api.github.com/repos/nylas/sync-engine/git/commits/5caf42796569a3d667860f95c9275994e473a606,5caf42796569a3d667860f95c9275994e473a606,"D116 update:
Quitting connections, support for to-,cc-,bcc-
Remaining CR changes.
Remaining docstrings.
Migrations.

TODOs left:
- Composing reply bodies to include previous messages"
kav-ya,2014-04-22 02:03:20,https://api.github.com/repos/nylas/sync-engine/git/commits/0e071e7b8267db4c7393675446e10f0c1ac5d25a,0e071e7b8267db4c7393675446e10f0c1ac5d25a,Sending replies
kav-ya,2014-04-21 19:01:15,https://api.github.com/repos/nylas/sync-engine/git/commits/2c95d98d9ac41fa8c58d0d3bcbe24045e5e37ede,2c95d98d9ac41fa8c58d0d3bcbe24045e5e37ede,"Remove PYTHONIOENCODING changes in setup.sh

Summary: Accidentally closed D85 by a push, the changes discussed there are actually contained in this rev

Test Plan: None

Reviewers: spang

Differential Revision: https://review.inboxapp.com/D108"
kav-ya,2014-04-21 17:43:03,https://api.github.com/repos/nylas/sync-engine/git/commits/294b305aa7e0c78c72d4eac87ded476425873b62,294b305aa7e0c78c72d4eac87ded476425873b62,"Change for EAS invalid pw case, to allow user to re-enter pw once before raising error.

Summary:
One line change in password_auth to allow password re-rentry.
See D106 too

Test Plan: None

Reviewers: mg

Differential Revision: https://review.inboxapp.com/D107"
emfree,2014-05-04 00:25:55,https://api.github.com/repos/nylas/sync-engine/git/commits/079be0dce5aa9375bea05eae92dafd2f06479c35,079be0dce5aa9375bea05eae92dafd2f06479c35,"Add a `snippet` field to the API response for threads.

Summary:
Currently it's just the snippet from the most recent message in the thread.

Also fix a typo in which we thought we were ordering Thread.messages by message
received date, but actually weren't.

Test Plan: Manual testing.

Reviewers: mg

Reviewed By: mg

CC: bengotow

Differential Revision: https://review.inboxapp.com/D133"
grinich,2014-05-03 02:15:02,https://api.github.com/repos/nylas/sync-engine/git/commits/37f4f231c016ffec4c89e87cda8d01f4f239e474,37f4f231c016ffec4c89e87cda8d01f4f239e474,more API doc changes
grinich,2014-05-03 01:46:25,https://api.github.com/repos/nylas/sync-engine/git/commits/297d42bf076e5275cd189646de3b8e53976fe1f4,297d42bf076e5275cd189646de3b8e53976fe1f4,"check namespace on threads, start removing `all` reference"
grinich,2014-05-03 01:45:51,https://api.github.com/repos/nylas/sync-engine/git/commits/8e90f58630ad764d5131060ae7e7fcb5053ea668,8e90f58630ad764d5131060ae7e7fcb5053ea668,Fixes for overriding flask.wsgi's logger
grinich,2014-05-03 01:45:13,https://api.github.com/repos/nylas/sync-engine/git/commits/e9f655596059ef8ffaf408a8290f85b534d93741,e9f655596059ef8ffaf408a8290f85b534d93741,lots of API doc changes
grinich,2014-05-02 19:40:25,https://api.github.com/repos/nylas/sync-engine/git/commits/a4e26b92d3100a17151ed399ecd8a2bf3c0b4134,a4e26b92d3100a17151ed399ecd8a2bf3c0b4134,add favicon to docs to silence those log 404s
emfree,2014-05-02 22:17:12,https://api.github.com/repos/nylas/sync-engine/git/commits/cce6a717c91206c71caaaa547ab3220b05599dac,cce6a717c91206c71caaaa547ab3220b05599dac,"[SCHEMA] Webhook service, special preview version.

Summary:
Please see the module docstring in inbox/server/transactions/webhook.py for a
discussion of the overall service design.

Test Plan: Working on it.

Reviewers: spang, mg

Reviewed By: mg

Differential Revision: https://review.inboxapp.com/D130"
emfree,2014-05-02 21:17:12,https://api.github.com/repos/nylas/sync-engine/git/commits/9fd2063fa1cf296775d43cc59e2e155e2d17d52a,9fd2063fa1cf296775d43cc59e2e155e2d17d52a,"Actually return participants for a thread.

Currently we're deduplicating only on the (display name, email) pair, so a
given thread may contain e.g. both

{ ""email"": ""pika-private@mit.edu"",
  ""name"": ""\""pika-private@mit.edu\""\t"" }

and

{ ""email"": ""pika-private@mit.edu"",
  ""name"": ""Wrathful Artichokes"" },

as separate participants, but this is better than nothing for now."
grinich,2014-05-02 19:30:27,https://api.github.com/repos/nylas/sync-engine/git/commits/7d1540dba90183790c0d85e60b815132c853207c,7d1540dba90183790c0d85e60b815132c853207c,put api server behind gevent.wsgi
emfree,2014-05-02 19:16:10,https://api.github.com/repos/nylas/sync-engine/git/commits/8a6179d947e1cbf5995218598275e31ae35939f8,8a6179d947e1cbf5995218598275e31ae35939f8,Actually pass thread id parameter to query filter.
emfree,2014-05-02 17:03:35,https://api.github.com/repos/nylas/sync-engine/git/commits/2a578884cca82d6801571263a1895cf8ec3eb661,2a578884cca82d6801571263a1895cf8ec3eb661,"Format display name/email pairs in JSON as dicts, not arrays.

Summary:
Not sure if this is what we actually want to go with for the API, but if so
here's an expedient way to do it.

Responses now look like this:

""cc"": [
    {
        ""email"": ""daniel.l.gerber@gmail.com"",
        ""name"": ""Daniel Gerber""
    },
    {
        ""email"": ""narenst@gmail.com"",
        ""name"": ""Naren""
    },
    {
        ""email"": ""townley.andrew@gmail.com"",
        ""name"": ""Andrew Townley""
    }
],

Instead of this:
""cc"": [
    [
        ""Daniel Gerber"",
        ""daniel.l.gerber@gmail.com""
    ],
    [
        ""Naren"",
        ""narenst@gmail.com""
    ],
    [
        ""Andrew Townley"",
        ""townley.andrew@gmail.com""
    ]
],

Test Plan: Manual testing

Reviewers: mg

Reviewed By: mg

CC: bengotow

Differential Revision: https://review.inboxapp.com/D132"
emfree,2014-05-02 03:17:11,https://api.github.com/repos/nylas/sync-engine/git/commits/cc7dac729f6838f6b65a28b0b0516dbd44925af9,cc7dac729f6838f6b65a28b0b0516dbd44925af9,"Support query parameters on /threads and /messages API queries.

Summary:
Example:
http://localhost:555/<ns_public_id>/messages?
from=christine@spang.cc&last_message_after=1398384000

Right now we're only doing exact matching on string parameters.

Relatedly:
* Fix a typo in APIEncoder (subjectdate belongs to Thread not
Message).
* Order query results by ascending ID so that windowing can work properly.

Test Plan: Experimental feature.

Reviewers: mg

Reviewed By: mg

Differential Revision: https://review.inboxapp.com/D131"
grinich,2014-05-02 07:24:10,https://api.github.com/repos/nylas/sync-engine/git/commits/cc1a9bee3d35a1f1ad1aa5d129515d0102cd0f03,cc1a9bee3d35a1f1ad1aa5d129515d0102cd0f03,remove stunnel config from api server
spang,2014-05-02 05:12:05,https://api.github.com/repos/nylas/sync-engine/git/commits/7207b232b7fdbaad9fffb863c04c174e1a8563c6,7207b232b7fdbaad9fffb863c04c174e1a8563c6,"Base is special; you can't share it between projects.

Because the associated metadata object is given information about all
tables that sqlalchemy knows about, leaving this object shared totally
messes up the inbox.sqlalchemy.revision tests since it tries to make
//all// tables for inbox in sqlite!"
grinich,2014-05-02 05:03:10,https://api.github.com/repos/nylas/sync-engine/git/commits/7f3b0296f520ef0413bf0dcfe068444e82e1f57a,7f3b0296f520ef0413bf0dcfe068444e82e1f57a,HTTPS proxy server
spang,2014-05-02 04:56:38,https://api.github.com/repos/nylas/sync-engine/git/commits/a5bb6303e206859c073483da63ed3dcdbc816404,a5bb6303e206859c073483da63ed3dcdbc816404,"Support non-versioned sessions.

Sometimes you want this, either for testing or for migrations."
grinich,2014-05-02 04:41:36,https://api.github.com/repos/nylas/sync-engine/git/commits/ddb90b0aa483b1c585760583c21e036c783a2180,ddb90b0aa483b1c585760583c21e036c783a2180,some API doc changes and merge API server requirements with main app
grinich,2014-05-02 01:30:17,https://api.github.com/repos/nylas/sync-engine/git/commits/a9fad51a8487780788aaefe08cea685d9838606a,a9fad51a8487780788aaefe08cea685d9838606a,"Rename Alembic migrations in the actual order

I have no idea why they don't just remove pyc files before running anything. Causes so many headaches. If you're ever having issues, try just running `find . -name '*.pyc' -delete` in your shell."
grinich,2014-05-02 00:51:01,https://api.github.com/repos/nylas/sync-engine/git/commits/ef22b79d2d61db65948c9cac72c0d72ec5ba7daf,ef22b79d2d61db65948c9cac72c0d72ec5ba7daf,"First part of API (w/ migration)

Summary:
- Migration to store message `blocks` in a separate table `parts`. This change is important for future use where non-message blocks can be uploaded to a namespace. The `part` objects are attachments on messages, and inherit from the `block` foundation, which provides the appropriate hashing, IDs, and Blob storage to S3 options.

- Custom JSON Encoder: works with many of our data objects (not all yet)

- API Documentation: these are written in Markdown and live in separate category files. The Flask app handles Markdown -> HTML rendering at the `/docs` URL. CSS based on GitHub style. Table of Contents is autogenerated based on filename ordering and title metadata.

- Initial version of the API server. (See the docs for more details) The Flask server `srv.py` runs on port 5555 and most of it is broken. It uses Flask Blueprints for different URL prefixes.

- File uploads: created in proper namespace

- File downloads: smart filenames are generated based on mimetype and common extensions (inline attachments don't have filenames)

- Fix for a *huge* bug parsing messages where we replaced newlines for all binary data (not just plain text)

Test Plan: all tests pass. updated test dump included

Reviewers: spang, emfree, kav-ya

Reviewed By: spang

Differential Revision: https://review.inboxapp.com/D129"
emfree,2014-05-01 21:29:39,https://api.github.com/repos/nylas/sync-engine/git/commits/ec6fad24fed7d23070b13939c51f13771a7437f1,ec6fad24fed7d23070b13939c51f13771a7437f1,"Install gevent via pip instead of apt-get.

This lets us use gevent 1.0, which has more features and no external
dependencies."
emfree,2014-05-01 19:49:02,https://api.github.com/repos/nylas/sync-engine/git/commits/e3f6d3a935ff2913de2b129aeb9a36370d470a0c,e3f6d3a935ff2913de2b129aeb9a36370d470a0c,"Construct database queries on threads/messages from query parameters.

Summary: Currently only for exact term matching -- no regular expressions yet.

Test Plan: Unit tests to come.

Reviewers: mg, spang

Reviewed By: mg

Differential Revision: https://review.inboxapp.com/D128"
emfree,2014-05-01 02:42:38,https://api.github.com/repos/nylas/sync-engine/git/commits/2f34d442157f86af4fd75c48ea2cf568fbef34f6,2f34d442157f86af4fd75c48ea2cf568fbef34f6,"Rearrange imports in previous migration.

According to mg bad things can happen if you try to do stuff outside of a
migration's upgrade() function."
spang,2014-05-01 02:15:49,https://api.github.com/repos/nylas/sync-engine/git/commits/3085958be5ac3487659c168942ec3a965796a94d,3085958be5ac3487659c168942ec3a965796a94d,"Bump alembic dep to latest.

Not fixing anything specific, but want to keep up-to-date."
emfree,2014-04-30 19:50:06,https://api.github.com/repos/nylas/sync-engine/git/commits/21b7b7ee17e69f3dc1ebebbbded66289ec8a4252,21b7b7ee17e69f3dc1ebebbbded66289ec8a4252,Use flanker instead of manual parsing when canonicalizing adresses.
emfree,2014-04-30 19:50:06,https://api.github.com/repos/nylas/sync-engine/git/commits/a5d578d6126f205821a04cd9b7cec3012e1f1d87,a5d578d6126f205821a04cd9b7cec3012e1f1d87,"[SCHEMA] Establish an association between messages and contacts.

Summary:
We want this mostly so that we can filter messages based on the from/to/cc/bcc
fields -- constructing SQL queries against the current JSON-encoded fields is
extremely clunky.

This commit also removes the HookManager abstraction, which we probably won't
use since we're not doing synchronous hooks.

Test Plan: Unit tests updated.

Reviewers: spang, mg

Reviewed By: spang

Differential Revision: https://review.inboxapp.com/D127"
spang,2014-04-29 23:41:52,https://api.github.com/repos/nylas/sync-engine/git/commits/56f4822335376d5b7c8a0da8aaed3b57ffe93297,56f4822335376d5b7c8a0da8aaed3b57ffe93297,"Lint models.namespace.

Getting rid of old style slowly as we touch files that haven't been
touched in a while. :)"
spang,2014-04-29 20:31:49,https://api.github.com/repos/nylas/sync-engine/git/commits/a2f8035eb1ca093b74f34b8dd77c990652a4d9bd,a2f8035eb1ca093b74f34b8dd77c990652a4d9bd,"Pool crispin clients, not IMAPClients.

Summary:
It turns out that my original abstraction here was not the right one.
Crispin's state caching essentially ties it to a single IMAP connection,
so the right thing to do is pool wrapped connections, not this mess with
passing raw IMAPClients into every single method call.

This connection pooling strategy is *definitely* not smart enough in the
long run when we have connections for many accounts open to the same
server, but it's way better than what we have now.

As a part of this refactor, we delete inbox.server.pool and move the
code in it to places that make more sense. This module was a remnant of
the days when we only supported Gmail sync.

This refactor really helps make the IMAP sync code more readable.

Test Plan: ./runtests -a

Reviewers: kav-ya

Reviewed By: kav-ya

Differential Revision: https://review.inboxapp.com/D126"
kav-ya,2014-04-29 00:15:19,https://api.github.com/repos/nylas/sync-engine/git/commits/78d2b09fed3bdeb44a293b069b269abd53d72507,78d2b09fed3bdeb44a293b069b269abd53d72507,Remove PYTHONIOENCODING from setup.sh
emfree,2014-04-28 22:34:36,https://api.github.com/repos/nylas/sync-engine/git/commits/16d54b82288476c0d0569b30d05e5538ae45a828,16d54b82288476c0d0569b30d05e5538ae45a828,Remove unused/duplicate address parsing code.
grinich,2014-04-27 00:22:16,https://api.github.com/repos/nylas/sync-engine/git/commits/18ffcf89c9c455b900817bd513aa698f999ebb1f,18ffcf89c9c455b900817bd513aa698f999ebb1f,"[SCHEMA] Add global unique `public_id` to database objects

Summary:
`public_id` is a binary column that is stored as a 128 bit unsigned integer, generated from Python's UUID module.

Although the field is stored as binary, the value on our model objects is exposed as a base-36 string (letters and numbers only). These should always be autogenerated, with the exception of the included migration.

Currently these objects have public_ids. (We can add others later if needed.)

- Account
- Block
- Contact
- Message
- Namespace
- SharedFolder
- Thread
- User
- UserSession

Test Plan: Run migration, it might take a while

Reviewers: spang, emfree

CC: kav-ya

Differential Revision: https://review.inboxapp.com/D125"
emfree,2014-04-27 22:06:28,https://api.github.com/repos/nylas/sync-engine/git/commits/ff38ec24ed9fa3bcd40300ea08542879930b5430,ff38ec24ed9fa3bcd40300ea08542879930b5430,"Add ability to attach extra data to transactions.

Summary:
The immediate reason for this is that we may want to filter message entries in
the transaction log based on folder names or attachment filenames, etc. But
that data may only appear somewhere else altogether in the log. Attaching the
data where we'll need it is much more convenient than needing to go looking for
it when we process the log.

Test Plan: Basic unit test added; sync manually run.

Reviewers: spang, mg

Reviewed By: mg

Differential Revision: https://review.inboxapp.com/D124"
grinich,2014-04-27 01:32:53,https://api.github.com/repos/nylas/sync-engine/git/commits/629e7ae18e97fe6f38f1b954fbb61a5e27d8911a,629e7ae18e97fe6f38f1b954fbb61a5e27d8911a,"Merge pull request #7 from jre21/master

Cleanups for dev environment"
emfree,2014-04-27 00:30:15,https://api.github.com/repos/nylas/sync-engine/git/commits/97cf5665ee088ad961aeb58fdc4bf817a23c242f,97cf5665ee088ad961aeb58fdc4bf817a23c242f,Fix test_hooks.
spang,2014-04-26 23:01:27,https://api.github.com/repos/nylas/sync-engine/git/commits/0c88377518bd115942e343871f1308475b69231d,0c88377518bd115942e343871f1308475b69231d,"Download messages in a thread one-at-a-time.

Summary:
Big threads containing embedded images etc. can use a TON of memory if
we try to download entire threads at a time. Shouldn't actually be much
of a perf loss to download sequentially, and it's way better than
vomiting over everything.

Someday we may want to do something fancier like precalculating message
sizes and using that to chunk.

Test Plan: Ran a sync manually. (no test coverage yet)

Reviewers: emfree

Reviewed By: emfree

Differential Revision: https://review.inboxapp.com/D123"
spang,2014-04-26 20:23:01,https://api.github.com/repos/nylas/sync-engine/git/commits/6172153b5707ad8ced138d39ba8a63ed51935ed4,6172153b5707ad8ced138d39ba8a63ed51935ed4,"Remove some database session refreshes from tests.

Now that we're using the READ-UNCOMMITTED isolation mode, these
refreshes to make SELECT return the right data are unnecessary."
spang,2014-04-26 20:21:12,https://api.github.com/repos/nylas/sync-engine/git/commits/25040ae67a9ba1c25cb904acb2c7c0be2e81c699,25040ae67a9ba1c25cb904acb2c7c0be2e81c699,Clarify sqlalchemy session relationship to db txns.
spang,2014-04-26 20:19:36,https://api.github.com/repos/nylas/sync-engine/git/commits/dc9abf3e819c7786dee3f90aeef2258aa336dfd8,dc9abf3e819c7786dee3f90aeef2258aa336dfd8,"Don't have ZeroRPC test fixtures require db fixture.

We weren't actually using this functionality, and we want the zerorpc
fixtures to be scoped to the session (otherwise we get ZeroRPC
socket-in-use errors), whereas the database gets scoped to the
_function_. With pytest, you can't use function-scoped fixture within a
session-scoped fixture."
emfree,2014-04-26 18:52:38,https://api.github.com/repos/nylas/sync-engine/git/commits/263119d97c24743b5780a2d3d7f9d63b4f256cbc,263119d97c24743b5780a2d3d7f9d63b4f256cbc,"Set db isolation level to READ COMMITTED.

Summary:
Hopefully this will help resolve concurrency issues in the sync code in which
queries one one Greenlet weren't seeing database updates committed by another
Greenlet.

Test Plan:
Well... can no longer seem to reproduce the IntegrityErrors I was
getting.

Reviewers: spang

Reviewed By: spang

Differential Revision: https://review.inboxapp.com/D122"
emfree,2014-04-26 05:59:05,https://api.github.com/repos/nylas/sync-engine/git/commits/6d6b4bd726c06098d40fc605511be91e3a6a5382,6d6b4bd726c06098d40fc605511be91e3a6a5382,"Resurrect CrispinClient.CHUNK_SIZE attribute.

Deleted in D119, but seems to be needed in update_metadata() and
update_saved_g_metadata()."
emfree,2014-04-26 04:38:50,https://api.github.com/repos/nylas/sync-engine/git/commits/50aa239bbe0da0dfaf9cddb94569eac0b95817e6,50aa239bbe0da0dfaf9cddb94569eac0b95817e6,"Remove extraneous add_all/commit calls.

They were moved into a try/except block by D115."
spang,2014-04-26 04:07:51,https://api.github.com/repos/nylas/sync-engine/git/commits/8bde03199ffd38ed2f68fd60cd5817a0307abf84,8bde03199ffd38ed2f68fd60cd5817a0307abf84,"Hard error-out if anyone tries to use YahooCrispinClient.

This was part of the review process, but I messed up landing the patch
(D119) and accidentally pushed an earlier version. Adding back in the
change here."
spang,2014-04-26 03:59:26,https://api.github.com/repos/nylas/sync-engine/git/commits/408e7116993c52dd7dcf4c7d468529f2fdd419ac,408e7116993c52dd7dcf4c7d468529f2fdd419ac,Lint inbox.sqlalchemy.
spang,2014-04-25 23:56:00,https://api.github.com/repos/nylas/sync-engine/git/commits/d534fb2ea22c0d7492bb8513fafb0b38283292c6,d534fb2ea22c0d7492bb8513fafb0b38283292c6,"Drastically simplify Crispin code.

DummyCrispinClient was a hairbrained idea to save all the raw bits we
pulled off the wire to disk and be able to replay operations in a sort
of offline mode, for testing and things. In retrospect, this is not the
most straightforward way to get the benefits that we want, namely the
ability to test message parsing separately from message download, and
the caching schema was complicated enough that we never ended up
finishing it or using it for anything.

Let's rip it out and move on. As it is, it's just confusing."
grinich,2014-04-25 22:52:52,https://api.github.com/repos/nylas/sync-engine/git/commits/621cbdd12ae4e4d909ab81c310424016e6658d9d,621cbdd12ae4e4d909ab81c310424016e6658d9d,"[SCHEMA] several changes

Summary:
1. Log error messages when crispin throws exceptions via @retry_crispin decorator. (Previously was geventconnpool's @retry)
2. Store message.from_addr and message.sender as list of addresses. Apparently sometimes there can be more than one sender. I believe the spec allows this, even though it's uncommon. The change for this includes a migration and updated test database dump.
3. Trim block.filename to 64 characters. I'm not sure what the real limit is for this in the spec. It was failing for me with malformed messages that had some crazy huge b64 encoded data in the filename. (See the Dropbox folder.)
4. Print all objects and fields when SQLalchemy throws a DataError during commits
5.  Add some misc logging

Test Plan: Run the migration on your dev machine and get some weird-ass messages in your mail account.

Reviewers: spang, emfree, kav-ya

Reviewed By: spang

Differential Revision: https://review.inboxapp.com/D115"
spang,2014-04-25 17:35:21,https://api.github.com/repos/nylas/sync-engine/git/commits/23bd57f2c7231b1cef292e763a59287edc1dc998,23bd57f2c7231b1cef292e763a59287edc1dc998,"pyOpenSSL requires libffi to build.

Thanks Jacob Emmert-Aronsen for pointing this out."
grinich,2014-04-24 07:05:56,https://api.github.com/repos/nylas/sync-engine/git/commits/aa957920132e66e2772a3cc7dfd72f32b396f0bb,aa957920132e66e2772a3cc7dfd72f32b396f0bb,use `.format()` when will I learn...
spang,2014-04-23 01:33:35,https://api.github.com/repos/nylas/sync-engine/git/commits/76ce059c28b96a35fb80bb33ccb4a61736b7bb0d,76ce059c28b96a35fb80bb33ccb4a61736b7bb0d,Use new vagrant directory name for test keydir.
emfree,2014-04-22 23:20:50,https://api.github.com/repos/nylas/sync-engine/git/commits/8de3260f589fd4138a2d8e6c650a237e69606dce,8de3260f589fd4138a2d8e6c650a237e69606dce,"Fix and lint tests in tests/imap.

Summary:
 * Add missing imports.
 * Don't expect API method return values to be jsonified.
 * Update auth token in test DB dump.
 * Update test_actions_syncback.THREAD_ID to a value that works with the actual
   state of the test account (previously, it corresponded to a thread that
   seems to have been deleted).

Test Plan: ./runtests --all

Reviewers: spang

Reviewed By: spang

Differential Revision: https://review.inboxapp.com/D113"
emfree,2014-04-22 22:59:41,https://api.github.com/repos/nylas/sync-engine/git/commits/ea7879f1f9b3435803cb7db73d396a6fe703681d,ea7879f1f9b3435803cb7db73d396a6fe703681d,"Remove jsonify decorator from API.

Summary:
It's not really needed with ZeroRPC, and we weren't applying it consistently
anyways.

Test Plan: ./runtests

Reviewers: spang, mg

Reviewed By: mg

CC: mg

Differential Revision: https://review.inboxapp.com/D112"
emfree,2014-04-22 22:59:09,https://api.github.com/repos/nylas/sync-engine/git/commits/07ba3497a2ff56d8e6c70ad1cd40f7be2f9288d9,07ba3497a2ff56d8e6c70ad1cd40f7be2f9288d9,"Actually return contact search results highest-scoring first.

Summary:
Previously we were (1) returning results lowest-scoring first, and (2)
limiting the result count before ranking, instead of after.

Test Plan:
Still needs a regression test, but for now manually verified via
`zerorpc tcp://0.0.0.0:9999 search_contacts <account_id> <search_string>.`

Reviewers: spang, mg

Reviewed By: mg

Differential Revision: https://review.inboxapp.com/D111"
spang,2014-04-22 20:30:24,https://api.github.com/repos/nylas/sync-engine/git/commits/321d437c450bfd102534873b5436c3465da1cb2b,321d437c450bfd102534873b5436c3465da1cb2b,"Upgrade our TLS support by using pyOpenSSL-backed requests.

requests will automatically use pyOpenSSL if it, ndg-httpsclient, and
pyasn1 are installed. pyOpenSSL is currently the best TLS implementation
for Python, and gives us features above the standard librarly ssl module
like TLS SNI support.

You'll need to re-run `pip install -r requirements.txt` and note that
you'll need the libffi headers to compile pyOpenSSL for platforms like
Linux that don't have binary dists available from PyPI (such as Linux).
(Install package `libffi-dev` on Debian/Ubuntu.)

You can verify that yours is working properly by running:

    py.test -s tests/general/network/test_sni.py

Thanks to Hynek Schlawack's PyCon 2014 talk on SSL/TLS for this. :)"
spang,2014-04-22 17:14:17,https://api.github.com/repos/nylas/sync-engine/git/commits/d9a76d99fb2598f2e30dd3e56d3aa36a0fa0718c,d9a76d99fb2598f2e30dd3e56d3aa36a0fa0718c,"Make account.sync_lock() gevent-safe.

Summary: Thanks @emfree for pointing out this bug.

Test Plan:
./runtests, manually fired up a sync and stopped it, seems OK. I
can't reproduce the error you were getting stopping a sync on master though,
does this fix-in-theory work for you?

Reviewers: emfree

Reviewed By: emfree

CC: emfree

Differential Revision: https://review.inboxapp.com/D109"
emfree,2014-04-22 03:31:50,https://api.github.com/repos/nylas/sync-engine/git/commits/d492be4dfadbfa4a82c9214edbd0b63e04d001a7,d492be4dfadbfa4a82c9214edbd0b63e04d001a7,Fix tests in test_api.py.
spang,2014-04-22 03:02:07,https://api.github.com/repos/nylas/sync-engine/git/commits/cc1cd320721bc57852ff3957a81539d7c0ca19b7,cc1cd320721bc57852ff3957a81539d7c0ca19b7,"Use a gevent Group instead of a list to keep track of folder monitors.

This is cleaner and more concise and probably more efficient since we're
not running an endless loop that just yields every iteration. More on
groups at http://sdiehl.github.io/gevent-tutorial/#groups-and-pools."
spang,2014-04-22 02:01:29,https://api.github.com/repos/nylas/sync-engine/git/commits/ea8fcea4f3c490fe8bfd4d8af72f40ce77779e9b,ea8fcea4f3c490fe8bfd4d8af72f40ce77779e9b,Lint tables.base and don't drop to pdb on txn errors.
grinich,2014-04-22 01:51:16,https://api.github.com/repos/nylas/sync-engine/git/commits/da1d691b501a25776f8a43d25015abe1d11c4627,da1d691b501a25776f8a43d25015abe1d11c4627,Add some new MX records for Google mail servers
spang,2014-04-22 01:19:52,https://api.github.com/repos/nylas/sync-engine/git/commits/7a4ec6755dd41b0fbc4091a20682d15f2f467986,7a4ec6755dd41b0fbc4091a20682d15f2f467986,"Implement a uid/thread-polling helper for IMAP/Gmail initial sync.

Summary:
In the case that a user has e.g. a very large inbox, our current design has the
shortcoming that, during the initial sync, it won't continue to download new
messages. This is untenable for the user experience, so we're solving it by
having a parallel greenlet during this time that keeps checking for new
UIDs/threads and adding them to the top of the initial sync uid/thread download
stack.

By doing this, we have to get rid of the ""chunked download"" feature...  if we
batch download messages in groups, we'll introduce a delay with how fast we
download new UIDs. It's not clear to me that batching actually wins us that
much speed anyway.

I think we're going to need to introduce IDLE support at some point for
the quickest receipt of new mail, but this is better than what we've got
for now.

Test Plan: ./runtests + a bunch of manual testing that has me thinking real hard about how to do better automatic testing.

Reviewers: mg

Reviewed By: mg

CC: kav-ya, emfree

Differential Revision: https://review.inboxapp.com/D51"
bengotow,2014-04-22 05:56:15,https://api.github.com/repos/nylas/sync-engine/git/commits/a989350ff3a8a4c7ea73f97dc3467ec64207f3e4,a989350ff3a8a4c7ea73f97dc3467ec64207f3e4,"Added directory creation to setup.sh for /var/log/inboxapp and /var/lib/inboxapp

Summary:

Test Plan: Test with fresh install, confirm that ./inbox works on the first try now

Reviewers: mg

CC:"
emfree,2014-04-21 19:47:04,https://api.github.com/repos/nylas/sync-engine/git/commits/8f0f6c0be66efcabdbf9f7ce7ec6647ca980935e,8f0f6c0be66efcabdbf9f7ce7ec6647ca980935e,"Use replace() instead of translate() in canonicalize_address.

Turns out the semantics of literal.translate() are different if literal is a
string or unicode object. Using replace() is also more readable.

Also
 * Add a regression test.
 * Check for argument validity in process_mail.get_cotnact_objects()."
emfree,2014-04-21 19:36:58,https://api.github.com/repos/nylas/sync-engine/git/commits/d4e88323e24e050bbeda88b72d08c32ef462ac03,d4e88323e24e050bbeda88b72d08c32ef462ac03,Fix merge error in D96.
emfree,2014-04-21 18:15:53,https://api.github.com/repos/nylas/sync-engine/git/commits/ae00a3117c77e6b15dd11f73f3e2f045eca762d1,ae00a3117c77e6b15dd11f73f3e2f045eca762d1,"[SCHEMA] Rank contact search results based on mail data.

Summary:
It'll certainly be necessary to iterate on the actual scoring function, but
this is some basic infrastructure for computing and storing signals.

Test Plan: Some manual testing; unit test added.

Reviewers: mg

Reviewed By: mg

Differential Revision: https://review.inboxapp.com/D97"
emfree,2014-04-21 07:51:45,https://api.github.com/repos/nylas/sync-engine/git/commits/32965071f094ac915990c799608f8eb2310216ad,32965071f094ac915990c799608f8eb2310216ad,"Minimal support for message hooks and contact ingestion from mail.

Summary:
Add the low-level beginnings of a framework for registering functions
to execute on new mail data, and use it to add contacts from the from/to/cc
fields. Shortly we'll also use this to provide ranking signals for contacts
search.

Test Plan: Unit test added.

Reviewers: mg

Reviewed By: mg

CC: kav-ya

Differential Revision: https://review.inboxapp.com/D96"
grinich,2014-04-21 07:29:46,https://api.github.com/repos/nylas/sync-engine/git/commits/164e44c81d327bd131aa6eb4e1157a57333fdb76,164e44c81d327bd131aa6eb4e1157a57333fdb76,skip resolving messages we don't have a record of
grinich,2014-04-21 07:29:12,https://api.github.com/repos/nylas/sync-engine/git/commits/597ce99deb605581e9a2e2fbca4e40413cb58b73,597ce99deb605581e9a2e2fbca4e40413cb58b73,don't mail if a sync isn't running yet
grinich,2014-04-21 07:28:25,https://api.github.com/repos/nylas/sync-engine/git/commits/6e49064d22daf622c590bc8fe3e7aefaf8c2dddc,6e49064d22daf622c590bc8fe3e7aefaf8c2dddc,check database state only in some cli functions
grinich,2014-04-20 20:28:57,https://api.github.com/repos/nylas/sync-engine/git/commits/5f906a97935bcaaf663a6760e49561599d1df244,5f906a97935bcaaf663a6760e49561599d1df244,"Don't log GreenletExit as an uncaught error.

Summary: Fixes logspam when greenlets terminate on sync_stop call.

Test Plan: Unit test updated.

Reviewers: mg

Reviewed By: mg

Differential Revision: https://review.inboxapp.com/D105"
emfree,2014-04-20 06:30:06,https://api.github.com/repos/nylas/sync-engine/git/commits/9dd9f02d9e5c4dadd27f834aaf01a5683d93b1f4,9dd9f02d9e5c4dadd27f834aaf01a5683d93b1f4,"Don't prematurely exit start_sync on unsupported account.

Previously, if you had one unsupported account among many, the start_sync
method would return prematurely, instead of starting syncs for the remaining
accounts."
grinich,2014-04-19 21:52:47,https://api.github.com/repos/nylas/sync-engine/git/commits/f87f690b01530d002ed659d6a4890e935461a64a,f87f690b01530d002ed659d6a4890e935461a64a,"various bug fixes, including msgpack cache instead of pickle"
emfree,2014-04-19 05:52:36,https://api.github.com/repos/nylas/sync-engine/git/commits/d9077664217f0154b8509fec043ccd1722045c76,d9077664217f0154b8509fec043ccd1722045c76,"Fix erroneous revert in D104.

The previous commit partially undid 31799240c7 by mistake. Put the changes
back."
grinich,2014-04-07 23:11:20,https://api.github.com/repos/nylas/sync-engine/git/commits/96df899e82e343f49d5756fa17aaa6a65d5fdd75,96df899e82e343f49d5756fa17aaa6a65d5fdd75,"[SCHEMA] Sending mail

Summary: This is the big sending mail project which Kavya and MG have been working on. It includes basic support for composing messages, specifying recipients, and sending with the Gmail SMTP provider. It also handles the reconciliation of immediately-saved sent messages from Inbox and later sync'd messages in `Sent Mail` through a custom header.

Test Plan: Testing database should be updated. Also see `tests/imap/test_sendmail.py`

Reviewers: spang, emfree

CC: kav-ya

Differential Revision: https://review.inboxapp.com/D104"
kav-ya,2014-04-18 23:21:34,https://api.github.com/repos/nylas/sync-engine/git/commits/1d27489f6962b66d464345f6a429cf83eb2c4177,1d27489f6962b66d464345f6a429cf83eb2c4177,"Handle OAuth invalid_grant error

Summary:
OAuth account verification fails intermittently in that trying to validate the refresh_token returns an invalid_grant error.
This happens because there are limits on the number of refresh tokens per Client/Account pair. We simply need to rerun the entire OAuth process to
reset the refresh token, this commit handles that.

Test Plan:
mysql inbox < tests/data/base_dump.sql
./inbox debug
./inbox sync start

- Invalid grant -> reruns OAuth instead of throwing an exception
- Starts sync

Reviewers: spang

Reviewed By: spang

Differential Revision: https://review.inboxapp.com/D99"
kav-ya,2014-04-18 23:10:51,https://api.github.com/repos/nylas/sync-engine/git/commits/59ecc2cca4fef67226afff513a971a75197186f3,59ecc2cca4fef67226afff513a971a75197186f3,"Remove is_created column in Message table, fix alembic branches"
kav-ya,2014-04-16 22:15:14,https://api.github.com/repos/nylas/sync-engine/git/commits/bd13d4e5f6280f36a5e0a347e0cbab94538f1443,bd13d4e5f6280f36a5e0a347e0cbab94538f1443,D92 CR changes
kav-ya,2014-04-16 18:13:51,https://api.github.com/repos/nylas/sync-engine/git/commits/f3a54cf4698954370a04dbbc71b4e43c68c4fd66,f3a54cf4698954370a04dbbc71b4e43c68c4fd66,util/db.py: Defensive assert for reset_columns default values
kav-ya,2014-04-15 02:51:33,https://api.github.com/repos/nylas/sync-engine/git/commits/500c7d3deccb35a7dd5a8c39f0d8c7984e1e8b44,500c7d3deccb35a7dd5a8c39f0d8c7984e1e8b44,"DB table changes to ImapAccount, Message tables.

Summary:
Move UserInfo columns from Account->ImapAccount table. Create is_created column in Message table, needed for sending mail.
Migrations + updated tests.

Test Plan:
Syncs as before.
Tests pass as before.

Reviewers: spang, mg

Differential Revision: https://review.inboxapp.com/D92"
kav-ya,2014-04-10 18:57:13,https://api.github.com/repos/nylas/sync-engine/git/commits/c1a9bcec55d324f50cae25c7ed7a36b9ba3d701b,c1a9bcec55d324f50cae25c7ed7a36b9ba3d701b,"Run setup.sh in bash

Summary:
#!/bin/sh can be symlinked to bash or dash but certain commands in the script are bash commands
and fail when executing in dash.
So, execute in a bash shell.

Test Plan: Actually sets up without failing.

Reviewers: spang

CC: mg

Differential Revision: https://review.inboxapp.com/D85"
emfree,2014-04-18 22:17:20,https://api.github.com/repos/nylas/sync-engine/git/commits/31799240c7112bc5e3ce2224c5610ee84676b814,31799240c7112bc5e3ce2224c5610ee84676b814,"Remove separate contacts API service.

Summary:
 * Move its methods into the general Inbox API.
 * Always start and stop mail and contacts sync together.

Test Plan: Unit tests updated; sync manually started and stopped.

Reviewers: mg

Reviewed By: mg

Differential Revision: https://review.inboxapp.com/D101"
spang,2014-04-18 18:32:33,https://api.github.com/repos/nylas/sync-engine/git/commits/cad87726d5bafb141aeaa2b1b205ee3904cb2e5b,cad87726d5bafb141aeaa2b1b205ee3904cb2e5b,"Lint, clean up, and test inbox.util.file, make Lock() gevent-safe.

Summary:
This is part of debugging some locking related issues in the sync
code. Turns out that when I switched the Gmail sync stuff to use a file
lock, I also totally broke the locking behaviour, because flock() is a
_process level_ lock, and if you try to grab that lock from multiple
greenlets, it will happily return and say that you have the lock. This
modifies the locking to be much more strict; you can only grab the lock
once, and only from one greenlet, and if you release it more times than
you grab it it will also throw an exception.

Test Plan: Tests included in tests/general/test_lock.py and
           tests/general/test_misc_utils.py

Reviewers: emfree

Differential Revision: https://review.inboxapp.com/D100"
spang,2014-04-18 15:12:57,https://api.github.com/repos/nylas/sync-engine/git/commits/139015f61d7b021f72f373f409f6c4910b3f998e,139015f61d7b021f72f373f409f6c4910b3f998e,Fix alembic migration branching.
kav-ya,2014-04-18 15:08:27,https://api.github.com/repos/nylas/sync-engine/git/commits/ce0f977ebd800402d1ba4c5871b6aa7b414ffb4e,ce0f977ebd800402d1ba4c5871b6aa7b414ffb4e,"./tools/clear-db fix

Summary:
Running ./tools/clear-db occasionally threw an error on trying to set eas_account_sync_key=None; it tried to do that because the default value for that column was returned $s None, which makes no sense
(since we set the server_default for that column to '0').

Both Eben and Spang ran into the error but I couldn't repro it until now - when the database is populated from the test dump,
or if it was created before the switch to using server_default (like the time of the test dump), the default values would be NULL.
This migration fixes that.

Test Plan: It's been tested on the test dump.

Reviewers: spang

Reviewed By: spang

Differential Revision: https://review.inboxapp.com/D98"
emfree,2014-04-18 02:15:39,https://api.github.com/repos/nylas/sync-engine/git/commits/9e926d60b8de31a4c3092ba05a939f4d5cca184f,9e926d60b8de31a4c3092ba05a939f4d5cca184f,"[SCHEMA] Store raw remote contact data.

Summary:
Right now we're just keeping a few fields in the contacts schema. By keeping
the entirety of the data we get from the remote provider, we can revise the
schema without resyncing.

Test Plan: Behavior manually verified for Google contact sync.

Reviewers: mg

Reviewed By: mg

Differential Revision: https://review.inboxapp.com/D93"
emfree,2014-04-16 22:29:51,https://api.github.com/repos/nylas/sync-engine/git/commits/63a83677991b2450a962a13c68db164e81bbd3c1,63a83677991b2450a962a13c68db164e81bbd3c1,"Delete contacts when the remote provider tells us to.

Test Plan: Unit test added.

Reviewers: kav-ya

Reviewed By: kav-ya

Differential Revision: https://review.inboxapp.com/D88"
spang,2014-04-15 15:43:27,https://api.github.com/repos/nylas/sync-engine/git/commits/62192f4a07f398fb8f326de8c02d750cca262ee3,62192f4a07f398fb8f326de8c02d750cca262ee3,"Recreate dropped tables at the end of clear-db.

Now that we don't auto-create tables on startup, we need to manually
recreate any tables we drop."
grinich,2014-04-13 16:19:15,https://api.github.com/repos/nylas/sync-engine/git/commits/1c5b6db7912d48549ce3573b920c3e1f6aef95cf,1c5b6db7912d48549ce3573b920c3e1f6aef95cf,"Move table+column creation into the `create_db.py` script, which is run at setup.

Summary:
Previously we allowed this to run everytime on startup, which broke some alembic revisions by creating new tables before a migration was run.From now on, we should ony be creating tables+columns via SQLalchemy *once* and all subscequent changes done via migration scripts.

Inspried by a chat with Selena Deckelmann. :)

Test Plan: passes all tests.

Reviewers: emfree, spang

Reviewed By: emfree

Differential Revision: https://review.inboxapp.com/D89"
emfree,2014-04-10 19:35:52,https://api.github.com/repos/nylas/sync-engine/git/commits/6ab493050ca7ddbe66f9e916edee20ff9309d3e5,6ab493050ca7ddbe66f9e916edee20ff9309d3e5,"Minor updates to general contacts sync.

Summary:
Add contact UID type assertion.
It's easy to accidentally pass an int rather than a string, but doing so is Bad
News.

In Contact.copy_from, copy fields whether or not they're None.
This is needed to properly sync individual deleted attributes of EAS contact
objects.

Test Plan: ./runtests

Reviewers: kav-ya

Reviewed By: kav-ya

Differential Revision: https://review.inboxapp.com/D86"
emfree,2014-04-10 18:18:31,https://api.github.com/repos/nylas/sync-engine/git/commits/103f366578a8066eb8562481483eb5fd0e47c14c,103f366578a8066eb8562481483eb5fd0e47c14c,"Add pytest engine for Arcanist.

Summary:
You'll need to do `pip install coverage` in your VM.
Tests can be disabled by running `arc diff --nounit`.

Test Plan: Run arc diff --preview on some test commit.

Reviewers: spang

Reviewed By: spang

CC: kav-ya, mg

Differential Revision: https://review.inboxapp.com/D84"
kav-ya,2014-04-08 22:54:21,https://api.github.com/repos/nylas/sync-engine/git/commits/9daa9c27c8642b2bece1def590d8fa40f46071e3,9daa9c27c8642b2bece1def590d8fa40f46071e3,"Test code restructured.

Summary:
To allow different providers to be tested independantly:
tests/general: provider agnostic tests
tests/imap: Imap tests
tests/data, tests/util: data + utility needed for tests.

Note: EAS tests live in the corresponding tests/eas directory in the inbox-eas repo.

Test Plan:
./runtests passes all as expected (i.e. depending on the value of the EASTEST flag)

Reviewers:
spang, emfree

CC:
emfree

Differential Revision: https://review.inboxapp.com/D63"
emfree,2014-04-08 21:00:07,https://api.github.com/repos/nylas/sync-engine/git/commits/50d7be9c94c34072593fa03c171fd51cdd23f465,50d7be9c94c34072593fa03c171fd51cdd23f465,"Set uid for locally added contacts.

uid is no longer a nullable column for contacts."
kav-ya,2014-04-04 22:05:35,https://api.github.com/repos/nylas/sync-engine/git/commits/e79fc35e7719cb6263bb03d8c016cad93754bbe1,e79fc35e7719cb6263bb03d8c016cad93754bbe1,"Fix to 'Un-stamped database!' bug

Summary:
Attempting an ./inbox start (for example) after running ./tools/clear-db results in an 'Un-stamped database error';
clearing the db drops the alembic_version table, hence the check for it in inbox:283 fails.

This commit fixes the problem by always including the alembic_version table in the tables kept i.e. not dropped

Test Plan: All scripts work as before.

Reviewers: spang

Reviewed By: spang

Differential Revision: https://review.inboxapp.com/D82"
emfree,2014-04-08 00:19:48,https://api.github.com/repos/nylas/sync-engine/git/commits/8cc4011b30fb2ab77e3af4cdb43fd3a22b108de9,8cc4011b30fb2ab77e3af4cdb43fd3a22b108de9,Fix a g_id -> uid renaming that escaped D72.
emfree,2014-04-07 23:11:20,https://api.github.com/repos/nylas/sync-engine/git/commits/355706099980ce87897ed8f492a90990ee6c167c,355706099980ce87897ed8f492a90990ee6c167c,"[SCHEMA] Allow contact sync from arbitrary remotes.

Summary:
 * Rename g_id to the more generic uid.
 * Add a 'provider_name' column to the Contact table. This allows us to sync
   contacts from multiple backends for the same account without needing to
   worry about uid collisions between those backends.

Test Plan: Unit test added; Google contact sync manually tested to work.

Reviewers: spang

Reviewed By: spang

Differential Revision: https://review.inboxapp.com/D72"
grinich,2014-04-06 01:37:54,https://api.github.com/repos/nylas/sync-engine/git/commits/bbb61d008dacc804e9bef49a64538bfa4d0bb886,bbb61d008dacc804e9bef49a64538bfa4d0bb886,dont serialize messagebody.
grinich,2014-04-06 01:37:23,https://api.github.com/repos/nylas/sync-engine/git/commits/5b1865f9bedb5595f14f0fb8eb496d5a08b2f584,5b1865f9bedb5595f14f0fb8eb496d5a08b2f584,refresh environment
grinich,2014-04-04 18:09:09,https://api.github.com/repos/nylas/sync-engine/git/commits/280a43fcdaf80ffb3a4df9af13c25140a4234b78,280a43fcdaf80ffb3a4df9af13c25140a4234b78,"Replace polling with IDLE

Summary:
    This commit replaces polling on the Inbox folder with the IMAP IDLE command.

    FUTURE TODO:
    * Make sure server supports IDLE via CAPABILITIES command. For example, Yahoo doesn't.
    * Utilize returned Sequence IDs to quickly fetch new messages (though likely won't do this)
    * Make `IDLE_FOLDERS` dynamically configurable via API
    * Consider not doing a HIGHESTMODSEQ and instead just fetch all UIDs when IDLE returns, since it only

Test Plan: Add/remove mail from the Inbox folder, which should trigger an immediate IDLE callback

Reviewers: spang

Reviewed By: spang

Differential Revision: https://review.inboxapp.com/D80"
grinich,2014-04-04 01:08:09,https://api.github.com/repos/nylas/sync-engine/git/commits/e9f0dbf3b7a15acd9c770c6dedbbd8d5bae04615,e9f0dbf3b7a15acd9c770c6dedbbd8d5bae04615,"[SCHEMA] save UserInfo about Google OAuth Account (name, locale, etc.)

Test Plan: run the migration and re-auth

Reviewers: spang

Differential Revision: https://review.inboxapp.com/D81"
spang,2014-04-02 23:21:39,https://api.github.com/repos/nylas/sync-engine/git/commits/e98dd1da168069b8f4007926e46d65cefdd381db,e98dd1da168069b8f4007926e46d65cefdd381db,"Actually actually abort when db isn't stamped.

Somehow I lost half this commit previously. :/"
grinich,2014-04-03 00:37:05,https://api.github.com/repos/nylas/sync-engine/git/commits/6d8eb91cfac472b40b7aaa4d40311eac4d4627c4,6d8eb91cfac472b40b7aaa4d40311eac4d4627c4,reverting to pickle because msgpack doesn't support namedtuples
spang,2014-04-02 23:53:13,https://api.github.com/repos/nylas/sync-engine/git/commits/8277b3394b4d33ac32a187536210e5b90d1dfdc5,8277b3394b4d33ac32a187536210e5b90d1dfdc5,Actually bail when the db isn't stamped or up-to-date.
spang,2014-04-02 23:27:07,https://api.github.com/repos/nylas/sync-engine/git/commits/8799427e2622783d6bb145f0f87bcd11a33c8a74,8799427e2622783d6bb145f0f87bcd11a33c8a74,Rip out some inbox-util setup code which I missed.
grinich,2014-04-02 23:00:38,https://api.github.com/repos/nylas/sync-engine/git/commits/e26c84a4af353a36ae3af2f76940164bc4a7641c,e26c84a4af353a36ae3af2f76940164bc4a7641c,"We're only using these in the message parsing, and the way these functions wrap flanker removes a lot of the nice stuff the module provides, like the `full_spec()` function. So I'm pulling it out of utils for now."
spang,2014-04-02 21:48:49,https://api.github.com/repos/nylas/sync-engine/git/commits/901fd2c88efdc6dc0153cbf4c94047856fd83d8b,901fd2c88efdc6dc0153cbf4c94047856fd83d8b,"Move misc utils back here.

Separating them out while things are still changing so quickly is too
confusing. We can rip out code we want to share later."
grinich,2014-04-02 21:36:32,https://api.github.com/repos/nylas/sync-engine/git/commits/5791d3b00cc7e9aa829345a5825702ffabdaec13,5791d3b00cc7e9aa829345a5825702ffabdaec13,missing arg for showing status
grinich,2014-04-02 21:36:02,https://api.github.com/repos/nylas/sync-engine/git/commits/6aa579800c3a147b39bacf1cd2bc164a03991c12,6aa579800c3a147b39bacf1cd2bc164a03991c12,goofy mg
grinich,2014-04-02 20:35:20,https://api.github.com/repos/nylas/sync-engine/git/commits/94866bdcc07dbfec497885139262a55ab080397b,94866bdcc07dbfec497885139262a55ab080397b,"Use MesssagePack for serialization in cache

See
https://github.com/inboxapp/inbox-util/commit/91b06cf5d27069bd8394bd2ba0
d2591adf027e6c"
grinich,2014-04-02 20:28:25,https://api.github.com/repos/nylas/sync-engine/git/commits/0509247a2d631799bcc3d5fad5ccf84ab0ce765b,0509247a2d631799bcc3d5fad5ccf84ab0ce765b,"Switch to our own fork of zerorpc

See why
https://github.com/inboxapp/zerorpc-python/commit/33b3dc675dab9db5fb6ed1
d8dd7ddca9a0d5e76b"
grinich,2014-04-02 20:05:50,https://api.github.com/repos/nylas/sync-engine/git/commits/0ab2fba1305a0211248d2772e49f5439ad1814b0,0ab2fba1305a0211248d2772e49f5439ad1814b0,Update README.md
grinich,2014-04-01 23:02:56,https://api.github.com/repos/nylas/sync-engine/git/commits/6c2e1293d6f6744d3f121f63ef751d7b8b7bc18c,6c2e1293d6f6744d3f121f63ef751d7b8b7bc18c,"check for config file, PYTHONIOENCODING, remove pyc, and colorize"
grinich,2014-04-01 23:02:26,https://api.github.com/repos/nylas/sync-engine/git/commits/9bfcc685e4a775bb0333f8dfa4aef99fe06b8371,9bfcc685e4a775bb0333f8dfa4aef99fe06b8371,use master branch
kav-ya,2014-03-28 23:32:16,https://api.github.com/repos/nylas/sync-engine/git/commits/0b7fc2ae39472d406ba46cc2c29a8e2ef2840507,0b7fc2ae39472d406ba46cc2c29a8e2ef2840507,"Fix remove_messages deletes not cascaded.

Summary:
Deletes were not cascaded i.e. deleting a uid did not cause the corresponding message etc. to be deleted.
This was because of how the Query.delete() works in SQLAlchemy, see: http://docs.sqlalchemy.org/en/rel_0_9/orm/query.html#sqlalchemy.orm.query.

This commit fixes that by using session.delete() instead.

Test Plan: None.

Reviewers: spang

Reviewed By: spang

Differential Revision: https://review.inboxapp.com/D75"
grinich,2014-04-01 00:32:12,https://api.github.com/repos/nylas/sync-engine/git/commits/ca7301647cd28536619b8703e0a070c63c9b9546,ca7301647cd28536619b8703e0a070c63c9b9546,"Fixes a *huge* bug, where we weren't actually saving to/cc/bcc/etc. if the message had more than one address...

Test Plan: just query your db for stuff like `message.cc_addr` to see how bad this bug is :(

Reviewers: spang

Reviewed By: spang

Differential Revision: https://review.inboxapp.com/D77"
grinich,2014-03-31 21:52:55,https://api.github.com/repos/nylas/sync-engine/git/commits/41525c22bae4d16ed8efadd40a595245ada90aa3,41525c22bae4d16ed8efadd40a595245ada90aa3,Update README.md
grinich,2014-03-31 21:17:25,https://api.github.com/repos/nylas/sync-engine/git/commits/db263f57d40f870579487c230a4a779290ff7aa7,db263f57d40f870579487c230a4a779290ff7aa7,"Not sure why, but the default encoding in my shell was `ISO-8859-1`, which was causing sys.stdout to fail when printing unicode.

Test Plan:
    >>> import sys
    >>> print(sys.stdout.encoding)
    utf_8

Reviewers: spang

Reviewed By: spang

Differential Revision: https://review.inboxapp.com/D78"
grinich,2014-03-28 23:56:12,https://api.github.com/repos/nylas/sync-engine/git/commits/131a635dda078fa38ad92dc7fff5616f22cf985b,131a635dda078fa38ad92dc7fff5616f22cf985b,"default to removing pyc files and not writing bytecode on start

Test Plan: try having some `.pyc` files around...

Reviewers: spang

Reviewed By: spang

CC: emfree

Differential Revision: https://review.inboxapp.com/D61"
grinich,2014-03-25 23:20:17,https://api.github.com/repos/nylas/sync-engine/git/commits/64979b3ad62f193edb6a8d81bd649427cfa75090,64979b3ad62f193edb6a8d81bd649427cfa75090,check if folders exist before mounting them
emfree,2014-03-28 23:17:53,https://api.github.com/repos/nylas/sync-engine/git/commits/c9567778991d51bb0d7ed3cba6673f37c4b3c949,c9567778991d51bb0d7ed3cba6673f37c4b3c949,"Use log_uncaught_errors on each new greenlet.

Summary:
For classes that inherit from Greenlet, move the implementation of _run(self)
to _run_impl(self), and use _run to wrap the call in an exception logging
handler.

Test Plan:
Throw an exception inside a decorated _run() method and check that
it gets logged. ./runtests passes.

Reviewers: spang

Reviewed By: spang

Differential Revision: https://review.inboxapp.com/D71"
emfree,2014-03-27 23:14:28,https://api.github.com/repos/nylas/sync-engine/git/commits/dc34a51de9846b71b359de219315ba1a04e49fb9,dc34a51de9846b71b359de219315ba1a04e49fb9,"Run migrations on test DB with alembic --tag=test.

Summary:
You can now run alembic migrations on the test database dump with the following
sequence of commands:

mysql test < tests/data/base_dump.sql
alembic upgrade head --tag=test
mysqldump test > tests/data/base_dump.sql

Hopefully this will make it easier to keep the test dump current, and also help
us sanity-check our migration scripts.

Test Plan: I did this with a pending migration script I have and it worked.

Reviewers: spang

Reviewed By: spang

CC: kav-ya, mg

Differential Revision: https://review.inboxapp.com/D69"
spang,2014-03-26 21:31:58,https://api.github.com/repos/nylas/sync-engine/git/commits/d73829f70d12b3df60c7a3290213ece0f3b9ee3d,d73829f70d12b3df60c7a3290213ece0f3b9ee3d,"Don't put a ton of code in a __init__.py.

Summary:
The most visible reason I'm changing this is because it makes our
logging weird (it reports the filename and __init__ is not that
helpful). But also, it's not very idiomatic to put a lot of code in a
__init__.py, it's much more common to put code in a different file and
import whatever is intended to be public in the __init__.

Test Plan: ./runtests + start up ./inbox without explosions

Reviewers: kav-ya

Reviewed By: kav-ya

Differential Revision: https://review.inboxapp.com/D67"
emfree,2014-03-26 18:44:02,https://api.github.com/repos/nylas/sync-engine/git/commits/aa0710db6d75d06d55bc00ae451e781374b33f6f,aa0710db6d75d06d55bc00ae451e781374b33f6f,"Fix 'Attribute history events accumulated' warning.

Summary:
Sometimes we see this warning:

/usr/local/lib/python2.7/dist-packages/sqlalchemy/orm/session.py:1824:
SAWarning: Attribute history events accumulated on 1 previously clean instances
within inner-flush event handlers have been reset, and will not result in
database updates. Consider using set_committed_value() within inner-flush event
handlers to avoid this warning.

I think this is because the after_flush listener in versioned_session calls
Transaction.set_extra_attrs, which in turn updates the Transaction object's
namespace attribute. Because of the now-removed backref, this would induce an
update to the corresponding Namespace object's attribute. That's the 'attribute
history event' that the warning is talking about. (You can instrument the
after_flush listener and see that after creating revisions, session.dirty
contains a Namespace instance that it did not before.)

Anyways, we don't seem to be using the backref, so remove it.

Test Plan:
Previously the warning would trigger on contacts sync. Now it does
not. Unit tests passing.

Reviewers: spang

Reviewed By: spang

Differential Revision: https://review.inboxapp.com/D66"
grinich,2014-03-25 22:36:00,https://api.github.com/repos/nylas/sync-engine/git/commits/d9cddcb3a0dbc06f6fbd9cf88a3d36e7d035e73e,d9cddcb3a0dbc06f6fbd9cf88a3d36e7d035e73e,"Migration for table split

Summary:
ImapAccount -> Account, ImapAccount
Thread -> Thread, ImapThread,
imapaccount_id->account_id in Namespace, Contact

Migration for EAS tables not needed.

Test Plan:
Both upgrading and downgrading tested to work:
To test upgrade, a database dump from a pre-table split sync was used
To test downgrade, the tests/data/base_dump.sql was used)

Reviewers: spang, kav-ya

Reviewed By: spang

CC: mg

Differential Revision: https://review.inboxapp.com/D48"
kav-ya,2014-03-25 21:35:50,https://api.github.com/repos/nylas/sync-engine/git/commits/25d33cda042c6f2cf3ae815bf12ee1f1595c6305,25d33cda042c6f2cf3ae815bf12ee1f1595c6305,"Allow out-of-tree action submodules.

Test Plan: test_actions, test_actions_syncback work.

Reviewers: spang

Reviewed By: spang

Differential Revision: https://review.inboxapp.com/D62"
grinich,2014-03-25 20:39:05,https://api.github.com/repos/nylas/sync-engine/git/commits/8f3c177faa4c3020a7e337fd2139475d28870b12,8f3c177faa4c3020a7e337fd2139475d28870b12,add util package to dependencies
kav-ya,2014-03-25 17:41:52,https://api.github.com/repos/nylas/sync-engine/git/commits/2a0cb740a30c512ff928b3403984ec083e940d04,2a0cb740a30c512ff928b3403984ec083e940d04,default->server_default in database tables
kav-ya,2014-03-25 16:18:33,https://api.github.com/repos/nylas/sync-engine/git/commits/de55d739491cfbd4b4e27cc57a1640f2e66deef7,de55d739491cfbd4b4e27cc57a1640f2e66deef7,"Reset certain columns in eas keep_tables

Summary:
With just ./tools/clear-db (i.e. --with users not specified), we want to keep the easaccount table but reset
eas_account_sync_key=0 (i.e. get rid of all sync state info)

See matching push to inbox-util

Test Plan: Expected effect for both gmail, EAS.

Reviewers: spang

Differential Revision: https://review.inboxapp.com/D60"
emfree,2014-03-25 02:53:43,https://api.github.com/repos/nylas/sync-engine/git/commits/41095ebd13bdf592b87fc81ef7432dc5cd99f05a,41095ebd13bdf592b87fc81ef7432dc5cd99f05a,"Don't use args unpacking in call to msg_create_fn.

Summary:
5e1141b837 broke EAS sync because create_eas_message wasn't passing a
namedtuple. I think it's a little clearer to have implementations of
msg_create_fn just take the raw message object and inspect its properties
themselves. This way you can also have the raw message object be any sort of
class, as opposed to a namedtuple specifically.

Test Plan: Ran unit tests; synced test Gmail account.

Reviewers: spang

Reviewed By: spang

Differential Revision: https://review.inboxapp.com/D58"
emfree,2014-03-25 02:50:55,https://api.github.com/repos/nylas/sync-engine/git/commits/163e9a27794e958db2ba11a1906b40529e6af1cb,163e9a27794e958db2ba11a1906b40529e6af1cb,"Replace bad account.create_message calls.

Summary:
imap/__init__.py has:
from inbox.server.mailsync.backends.imap import account
and then calls account.create_message in two places, but I'm pretty sure that
should be account.create_imap_message.

A create_message function actually exists in the module namespace of
backends/imap/account.py, because it gets imported from
inbox.server.models.message. So this doesn't get caught by the linter.

Test Plan: No :(

Reviewers: kav-ya, spang

Reviewed By: spang

Differential Revision: https://review.inboxapp.com/D57"
emfree,2014-03-25 01:42:06,https://api.github.com/repos/nylas/sync-engine/git/commits/40e9fdc9abdb904519461115da3407fd98ec5f06,40e9fdc9abdb904519461115da3407fd98ec5f06,"Fix actions unit tests.

Test Plan: I ran them.

Reviewers: kav-ya

Differential Revision: https://review.inboxapp.com/D56"
kav-ya,2014-03-24 17:44:53,https://api.github.com/repos/nylas/sync-engine/git/commits/8b0ce8b49eba259b154f2ba0eb26e9ab5f2740cb,8b0ce8b49eba259b154f2ba0eb26e9ab5f2740cb,"Actions supports pluggable backends.

Test Plan: Gmail actions works as before.

Reviewers: spang

Reviewed By: spang

Differential Revision: https://review.inboxapp.com/D55"
spang,2014-03-24 19:03:29,https://api.github.com/repos/nylas/sync-engine/git/commits/ee6d44474d24a5f3fb53d2331e0713b087070b01,ee6d44474d24a5f3fb53d2331e0713b087070b01,'easaccount' is a user-specific table too.
spang,2014-03-24 18:58:56,https://api.github.com/repos/nylas/sync-engine/git/commits/f86a02f8f5dc539dccabbb10c78a337de634e617,f86a02f8f5dc539dccabbb10c78a337de634e617,Make clear-db use genericized drop_everything().
spang,2014-03-24 18:33:29,https://api.github.com/repos/nylas/sync-engine/git/commits/d59557d530e155d0123ca7d28dfc850db90edb7c,d59557d530e155d0123ca7d28dfc850db90edb7c,"More linting and clarity fixes.

Summary:
Cleanups.

Test Plan: ./runtests passes

Reviewers: kav-ya

Reviewed By: kav-ya

Differential Revision: https://review.inboxapp.com/D52"
spang,2014-03-24 01:13:26,https://api.github.com/repos/nylas/sync-engine/git/commits/7a8b70e3626a48bea964f229f331b93b19a000a1,7a8b70e3626a48bea964f229f331b93b19a000a1,"Move mailsync.backends.imapaccount -> mailsync.backends.imap.account.

Summary:
I don't think we should have direct submodules of mailsync.backends that
aren't actual backends. This code is clearly code that belongs to the
IMAP backend, and thus belongs in that submodule.

Test Plan: ./runtests passes

Reviewers: kav-ya

Differential Revision: https://review.inboxapp.com/D52"
spang,2014-03-24 18:31:36,https://api.github.com/repos/nylas/sync-engine/git/commits/95df3395252d6c956ff43fd25e7e2ebba89107f3,95df3395252d6c956ff43fd25e7e2ebba89107f3,"Rename mail sync log to be less generic.

Summary: We have contacts sync now too.

Test Plan: ./runtests passes

Reviewers: emfree

Reviewed By: emfree

Differential Revision: https://review.inboxapp.com/D53"
spang,2014-03-24 18:27:50,https://api.github.com/repos/nylas/sync-engine/git/commits/33201610bb7f617fb9a596e58862e11040b84d8c,33201610bb7f617fb9a596e58862e11040b84d8c,"Whoops, add missing 'then' in if statement."
kav-ya,2014-03-24 17:05:11,https://api.github.com/repos/nylas/sync-engine/git/commits/86f67d0ecb4d8827317aca99cf64ec50ff55762f,86f67d0ecb4d8827317aca99cf64ec50ff55762f,Add KEYDIR to tests/config.cfg
spang,2014-03-24 04:29:54,https://api.github.com/repos/nylas/sync-engine/git/commits/a2e2e5f2e527a74f49fef926695e1674e9ad2432,a2e2e5f2e527a74f49fef926695e1674e9ad2432,Fix a bad cherry-pick.
spang,2014-03-24 04:12:43,https://api.github.com/repos/nylas/sync-engine/git/commits/5e1141b837afd4fc054cf94a324716104dd09975,5e1141b837afd4fc054cf94a324716104dd09975,"Represent raw messages as a namedtuple.

Another fine example of a place where namedtuples lend more clarity to
the code."
emfree,2014-03-24 03:26:37,https://api.github.com/repos/nylas/sync-engine/git/commits/ed6808f2baba70068addf3f8572f97a858c434f9,ed6808f2baba70068addf3f8572f97a858c434f9,"Don't try to tokenize null contact fields.

Test Plan: Regression test added.

Reviewers: spang

Reviewed By: spang

Differential Revision: https://review.inboxapp.com/D54"
spang,2014-03-24 02:56:12,https://api.github.com/repos/nylas/sync-engine/git/commits/8bccd2a92999386c92ec83ec8fdfceb1e79f0883,8bccd2a92999386c92ec83ec8fdfceb1e79f0883,"Rip out non-server modules.

These live in inbox-util.git now, because ostensibly we may want to use
them in code that's not the Inbox server.

You'll need to restart your vagrant machine after this commit, and make
sure to clone the new repo first! Then re-run setup.sh in the restarted
VM, or just `pip install -e /vagrant-util`."
spang,2014-03-24 01:13:43,https://api.github.com/repos/nylas/sync-engine/git/commits/8c6d0b793c9881855fd11b30cd0df4090d41936b,8c6d0b793c9881855fd11b30cd0df4090d41936b,More linting.
spang,2014-03-24 00:40:57,https://api.github.com/repos/nylas/sync-engine/git/commits/3054ae67cc969f1b1bbc48aa2ef1ac86d16f5461,3054ae67cc969f1b1bbc48aa2ef1ac86d16f5461,Lint formatting fixes for a lot of files.
spang,2014-03-24 00:37:15,https://api.github.com/repos/nylas/sync-engine/git/commits/1fbc1e977657564c2e9cba0382e6aacbc3d80408,1fbc1e977657564c2e9cba0382e6aacbc3d80408,"Set log level via the config file.

Eventually we probably also want to be able to override this at the
command line."
spang,2014-03-05 19:36:21,https://api.github.com/repos/nylas/sync-engine/git/commits/d9093c09e26e27311a281b9f9d575148bcd76efd,d9093c09e26e27311a281b9f9d575148bcd76efd,Use numpy formatting for expand_threads() docstring.
spang,2014-03-05 19:21:21,https://api.github.com/repos/nylas/sync-engine/git/commits/84106e723d6cab9d4cc46485cb43e043b5efa260,84106e723d6cab9d4cc46485cb43e043b5efa260,"Make GmailCrispinClient.g_metadata() return namedtuples.

This is exactly the sort of place where using a namedtuple makes the
code cleaner."
kav-ya,2014-03-22 22:34:30,https://api.github.com/repos/nylas/sync-engine/git/commits/8d24e29c9853223737e1e89e145e74a2260a106b,8d24e29c9853223737e1e89e145e74a2260a106b,"./inbox start logs providers currently supported, with getattr->hasattr
(Updated Differential revision 49)

Summary:
To make testing easier, it's useful to know what providers are available before trying to auth an account

Test plan:
Sync works as before."
spang,2014-03-21 03:02:18,https://api.github.com/repos/nylas/sync-engine/git/commits/0acd311aec0f4f04c8780fd6ddf0e567157b7bf0,0acd311aec0f4f04c8780fd6ddf0e567157b7bf0,Flake8 lint console.py.
spang,2014-03-21 03:01:59,https://api.github.com/repos/nylas/sync-engine/git/commits/49194baef2abc336122bab4cb7f8c8e49087b23c,49194baef2abc336122bab4cb7f8c8e49087b23c,Fix debugging console. (Bad import.)
emfree,2014-03-20 23:28:35,https://api.github.com/repos/nylas/sync-engine/git/commits/ce4dfaabfb1091414a25bb9a9ec08c6e2d10873d,ce4dfaabfb1091414a25bb9a9ec08c6e2d10873d,"Add script to run tests before landing changes.

Summary:
tools/test_and_submit.sh will merge your changes into master, run the test
suite on the resultant working copy, and push only if the tests pass.
Consider using it instead of `arc land` to submit changes.

Test Plan:
Checked that script aborts if the tests fail; successfully
used it to submit an accepted commit. The script probably won't handle every
weird Git edge-case though.

Reviewers: spang

Reviewed By: spang

CC: kav-ya, mg

Differential Revision: https://review.inboxapp.com/D46"
emfree,2014-03-20 20:59:53,https://api.github.com/repos/nylas/sync-engine/git/commits/ffdc740cc816bdfbb91cc689afa046f74d1f47db,ffdc740cc816bdfbb91cc689afa046f74d1f47db,"Fix typo in contacts API's stop_sync method.

Summary: Also clean up a few related minor defects.

Test Plan: Started and stopped sync successfully.

Reviewers: kav-ya

Reviewed By: kav-ya

Differential Revision: https://review.inboxapp.com/D42"
kav-ya,2014-03-20 17:21:44,https://api.github.com/repos/nylas/sync-engine/git/commits/fb96c1720748490c069ca9580ee493f2ed5667f3,fb96c1720748490c069ca9580ee493f2ed5667f3,Updated test config
kav-ya,2014-03-20 17:06:02,https://api.github.com/repos/nylas/sync-engine/git/commits/a722447a879089f82a0fbf7de7f29f05f626a791,a722447a879089f82a0fbf7de7f29f05f626a791,CR changes
kav-ya,2014-03-19 22:47:57,https://api.github.com/repos/nylas/sync-engine/git/commits/618ffaac3cde2ffb7e041eec268ea16d32c0111e,618ffaac3cde2ffb7e041eec268ea16d32c0111e,"Changes to make pluggable backends work

Test Plan: Gmail, EAS sync work as before.

Reviewers: spang

Differential Revision: https://review.inboxapp.com/D45"
kav-ya,2014-03-19 20:33:52,https://api.github.com/repos/nylas/sync-engine/git/commits/f85b9830fc108208e820c5413876d0bc93d1f21b,f85b9830fc108208e820c5413876d0bc93d1f21b,Ondeletes added
kav-ya,2014-03-19 18:20:43,https://api.github.com/repos/nylas/sync-engine/git/commits/6b456dee2f0afd7caaa99e75dc7dc0ae29cd0fd2,6b456dee2f0afd7caaa99e75dc7dc0ae29cd0fd2,Db schema update + corresponding test dump update
grinich,2014-03-20 02:44:12,https://api.github.com/repos/nylas/sync-engine/git/commits/b0da416d03f060c1b22eadfb43146223c2567b95,b0da416d03f060c1b22eadfb43146223c2567b95,"[CONFIG] Change config names for both install/web oauth flows.

Summary:
This patch introduces a way to support OAuth via both the Google
`installed` API app type, as well as the conventional web callback method.
It includes a stub Flask app to handle the URL redirection.

Any production system will certainly use web oauth, but this lets us keep
the previous flexibilty for quick development.

Test Plan: Try changing your OAuth client id/secret to the production values.

Reviewers: spang, kav-ya

Reviewed By: kav-ya

CC: emfree

Differential Revision: https://review.inboxapp.com/D39"
emfree,2014-03-19 19:22:24,https://api.github.com/repos/nylas/sync-engine/git/commits/3bd260585c40cfba95ad10f91d6acc16fc5689ef,3bd260585c40cfba95ad10f91d6acc16fc5689ef,"Update a few stragglers following D41.

Test Plan:
Successfully ran new Gmail and Google contacts syncs; ran unit
tests.

Reviewers: kav-ya

Reviewed By: kav-ya

Differential Revision: https://review.inboxapp.com/D43"
kav-ya,2014-03-19 08:17:36,https://api.github.com/repos/nylas/sync-engine/git/commits/b223ed13aa903f2012e05c7e522935dfc8e563ce,b223ed13aa903f2012e05c7e522935dfc8e563ce,"Contacts, tests use new tables; contacts migration fixed"
kav-ya,2014-03-19 00:13:45,https://api.github.com/repos/nylas/sync-engine/git/commits/f1336a05af311d6d40973972ff0d025f2bdbc069,f1336a05af311d6d40973972ff0d025f2bdbc069,"Pluggable tables + code changes Dynamic loading issues fixed

Summary: Table split w/ dynamic module loading.

Test Plan: Works as before.

Reviewers: spang

Reviewed By: spang

Differential Revision: https://review.inboxapp.com/D41"
kav-ya,2014-03-18 21:56:26,https://api.github.com/repos/nylas/sync-engine/git/commits/157a80e7186bbb945fcfae19de5c7ccf700ee2b5,157a80e7186bbb945fcfae19de5c7ccf700ee2b5,"Pluggable tables + code changes Dynamic loading issues fixed

Summary: Table split w/ dynamic module loading.

Test Plan: Works as before.

Reviewers: spang

Differential Revision: https://review.inboxapp.com/D41"
kav-ya,2014-03-17 21:59:00,https://api.github.com/repos/nylas/sync-engine/git/commits/f80ade072607ee1ff9f2347e9155c42496cdffe4,f80ade072607ee1ff9f2347e9155c42496cdffe4,Pluggable tables + code changes
emfree,2014-03-18 21:54:04,https://api.github.com/repos/nylas/sync-engine/git/commits/fc4d4d616ac8b0e965d3de084c2244c71528b50a,fc4d4d616ac8b0e965d3de084c2244c71528b50a,"Have user create config before running setup.sh.

setup.sh calls tools/create_db.py, which requires a config file to be in place.
It's confusing for a first-time user if they try to run setup.sh and it isn't
there."
emfree,2014-03-18 20:04:27,https://api.github.com/repos/nylas/sync-engine/git/commits/f71a2f2ef60aac93201dce5bf13085c0bfde1039,f71a2f2ef60aac93201dce5bf13085c0bfde1039,"[SCHEMA] Minimal contact search implementation.

Summary:
Provide a simple per-user contact search ability. Currently, it only uses a
simple prefix-completion heuristic, and doesn't rank results other than
alphabetically, but it's fast and works.

Depends on D38.

Test Plan: Unit tests added.

Reviewers: spang

Reviewed By: spang

Differential Revision: https://review.inboxapp.com/D40"
emfree,2014-03-18 17:48:34,https://api.github.com/repos/nylas/sync-engine/git/commits/05eadc6cb2eef60eac48a70b879880adcbcd71a2,05eadc6cb2eef60eac48a70b879880adcbcd71a2,"[CONFIG] Contacts API and code reorganization.

Summary:
 * Move the contacts code into its own directory as it grows, rename
   rolodex->contacts for greater clarity.
 * Provide a minimal ZeroRPC API for starting/stopping contacts sync, and
   adding/updating/getting contact data.

Test Plan: Unit tests added.

Reviewers: spang

Reviewed By: spang

Differential Revision: https://review.inboxapp.com/D38"
grinich,2014-03-17 19:19:09,https://api.github.com/repos/nylas/sync-engine/git/commits/5a594e7ce11110a6853388de87b9de15820ad9f1,5a594e7ce11110a6853388de87b9de15820ad9f1,Migration for importing old accounts (last October)
spang,2014-03-17 20:45:32,https://api.github.com/repos/nylas/sync-engine/git/commits/d1bae212bfa02c823fb1a0ebca2a27ae1781db5d,d1bae212bfa02c823fb1a0ebca2a27ae1781db5d,"Allow out-of-tree submodule plugins for auth/mailsync backends.

Summary: See the pkgutil.extend_path() docstring for more details.

Test Plan:
I ran ./inbox start and printed out the loaded modules. It doesn't
*quite* work with the split-out inbox-eas yet because we're still working on
the models split, but once that's done it will be really easy to verify that
this works.

Reviewers: kav-ya

Reviewed By: kav-ya

CC: mg

Differential Revision: https://review.inboxapp.com/D37"
grinich,2014-03-17 18:52:27,https://api.github.com/repos/nylas/sync-engine/git/commits/497a570c443488cc0a16d83cc1de73653f33af66,497a570c443488cc0a16d83cc1de73653f33af66,assert we have the config var
grinich,2014-03-17 18:42:23,https://api.github.com/repos/nylas/sync-engine/git/commits/50f90b85ba5d95712f477ccd3b10f726d74f2cf6,50f90b85ba5d95712f477ccd3b10f726d74f2cf6,linux defaults!
grinich,2014-03-15 01:17:17,https://api.github.com/repos/nylas/sync-engine/git/commits/fdb1394a00d74e4dd12432de64f14ecb246458f4,fdb1394a00d74e4dd12432de64f14ecb246458f4,ignore flanker installation directory
grinich,2014-03-14 04:28:45,https://api.github.com/repos/nylas/sync-engine/git/commits/84300f500afeb83b8866dd593a10f7a7fcb79ce0,84300f500afeb83b8866dd593a10f7a7fcb79ce0,log recursion depth decoding errors (iconv) differently
grinich,2014-03-14 04:27:50,https://api.github.com/repos/nylas/sync-engine/git/commits/70f03e03647e701a05b04df61b4c585a10eca479,70f03e03647e701a05b04df61b4c585a10eca479,"switch out our own fork of flanker, in which I fixed some bugs"
emfree,2014-03-13 23:54:56,https://api.github.com/repos/nylas/sync-engine/git/commits/2b9e487715185cf3ac3d93896fec7f99b2c9d3f3,2b9e487715185cf3ac3d93896fec7f99b2c9d3f3,"Fix import in rolodex.py; update test DB dump.

verify_imap_account moved from session.py to pool.py when I wasn't looking."
kav-ya,2014-03-13 08:01:02,https://api.github.com/repos/nylas/sync-engine/git/commits/7ef1f16b777bfaa22c711f0cb78f5309b9e9f467,7ef1f16b777bfaa22c711f0cb78f5309b9e9f467,"Allow re-entering of OAuth auth code

Summary:
In case of an entry error, allow the user to simply re-enter the auth code before returning an
Invalid credentials error.

Test Plan: Ad-hoc testing.

Reviewers: mg, spang

Reviewed By: mg

Differential Revision: https://review.inboxapp.com/D31"
emfree,2014-03-13 22:22:28,https://api.github.com/repos/nylas/sync-engine/git/commits/5a0511ad226912628321ceb9917cddc9577b188e,5a0511ad226912628321ceb9917cddc9577b188e,"Poll for contact updates; rewrite merge logic.

Summary:
* For each IMAP account, spawn a Greenlet to poll periodically for contact
  updates.

* Rewrite the contact update logic so that local/remote update merges will
  actually work once we have the facility to make local contact updates.
  Previously, a contact entry with source 'remote' would be stored when the
  contact was first added from Google API client. But we wouldn't update that
  entry on subsequent updates from the Google client. This means that merges
  wouldn't really work correctly.

This commit updates contact entries with source 'remote' at each sync, so
that merges should work correctly in the face of repeated local or remote
updates to contact data.

Test Plan:
Unit tests added. Ran ./inbox debug while adding/updating my test
account's contacts and verified database updates.

Reviewers: spang

Reviewed By: spang

Differential Revision: https://review.inboxapp.com/D14"
emfree,2014-03-13 22:20:54,https://api.github.com/repos/nylas/sync-engine/git/commits/cbc42e00478341eb6b95ea1be5409e46dea37c05,cbc42e00478341eb6b95ea1be5409e46dea37c05,"Fix sync_status API method.

Test Plan:
Ran `zerorpc tcp://0.0.0.0:9999 sync_status` against running sync
service.

Reviewers: spang

Reviewed By: spang

Differential Revision: https://review.inboxapp.com/D28"
grinich,2014-03-13 21:20:38,https://api.github.com/repos/nylas/sync-engine/git/commits/d25f2947ccaeac6f9983a799e335c22f88918e62,d25f2947ccaeac6f9983a799e335c22f88918e62,[SCHEMA] add migration for rSc651f58f79726830873aba91883d0b17a2766e44
emfree,2014-03-13 18:31:05,https://api.github.com/repos/nylas/sync-engine/git/commits/322130b0da79a794e3ccf0c60d7b83c473602264,322130b0da79a794e3ccf0c60d7b83c473602264,"Merge pull request #4 from cenkalti/examples

fix hashbang lines in examples"
emfree,2014-03-13 18:24:14,https://api.github.com/repos/nylas/sync-engine/git/commits/7e014b487cc0f78350582f73e25f9e752eeae141,7e014b487cc0f78350582f73e25f9e752eeae141,"Remove configfile copy operation from setup script.

Summary:
And check on config load if file exists. If not, print a more descriptive
message.

Test Plan: Attempted to run ./inbox with and without existing configfile.

Reviewers: mg

Reviewed By: mg

Differential Revision: https://review.inboxapp.com/D29"
cenkalti,2014-03-13 05:24:45,https://api.github.com/repos/nylas/sync-engine/git/commits/5c547335951c265078255e5f2699a09237215e2e,5c547335951c265078255e5f2699a09237215e2e,fix hashbang lines in examples
grinich,2014-03-13 02:16:30,https://api.github.com/repos/nylas/sync-engine/git/commits/806143e66a937b0ede475429fc187fb4a7119916,806143e66a937b0ede475429fc187fb4a7119916,"Add Arcanist configuration for running linters on Python code when you run `arc diff`.

Make sure you have PyFlakes, PyLint, and PEP8 installed.

You can bring all your dependencies up to date by running `pip install -r requirements.txt`"
kav-ya,2014-03-12 21:50:33,https://api.github.com/repos/nylas/sync-engine/git/commits/5cfa9e5bff0d02ca54314d8343a7bdad33fca37c,5cfa9e5bff0d02ca54314d8343a7bdad33fca37c,"sub_dirs->backend_subdirs, docs for directory structure"
kav-ya,2014-03-12 18:49:41,https://api.github.com/repos/nylas/sync-engine/git/commits/dd62ee7b2c1ae758f000fea48b68540fa571cea6,dd62ee7b2c1ae758f000fea48b68540fa571cea6,rename auth module fns to be clearer
kav-ya,2014-03-11 23:01:48,https://api.github.com/repos/nylas/sync-engine/git/commits/8a6656854c0d7ab136c2728c4094d800715b7930,8a6656854c0d7ab136c2728c4094d800715b7930,"Load mailsync modules from subfolders too, needed for EAS"
kav-ya,2014-03-11 19:50:33,https://api.github.com/repos/nylas/sync-engine/git/commits/c651f58f79726830873aba91883d0b17a2766e44,c651f58f79726830873aba91883d0b17a2766e44,Drafts as a required folder
kav-ya,2014-03-11 19:43:12,https://api.github.com/repos/nylas/sync-engine/git/commits/c4451c691d7fbcf4176006ef4e54f652425209df,c4451c691d7fbcf4176006ef4e54f652425209df,create_account->compose_account in pool.py
kav-ya,2014-03-11 17:38:54,https://api.github.com/repos/nylas/sync-engine/git/commits/af88e89c541c9cc97b8986e220f7474afe3c0c84,af88e89c541c9cc97b8986e220f7474afe3c0c84,"Pluggable backends for sync, v1 AND Pluggable backends for auth, v1

Summary:
Pluggable backends for sync, v1

The pluggable backends for the sync service, it works as expected but is called v1 for three reasons:
1. I'd like to convert a few absolute imports to relative imports (marked by a corresponding TODO in the code)
2. I'd like to look into a better way to identify the provider (I currently use a module attribute)
3. It hasn't been reviewed by you yet =)

Pluggable backends for auth, v1

Auth abstracted out + the pluggable backends for auth, it works as expected too but is called v1 for these reasons:
1. As above: I'd like to convert a few absolute imports to relative imports and I'd like to look into a better way to identify the provider
2. I'd like to double-check that I'm using class methods correctly and that it's okay.
3. I'd like to look into implementing a better way to populate the auth_cls_for dict.

Test Plan: Not required.

Reviewers: spang

Reviewed By: spang

CC: emfree

Differential Revision: https://review.inboxapp.com/D23"
emfree,2014-03-10 05:37:04,https://api.github.com/repos/nylas/sync-engine/git/commits/f88b89b621770fc845eb1513018a53af8901bd4b,f88b89b621770fc845eb1513018a53af8901bd4b,"Don't say sudo ./inbox in README.

Test Plan: Ran commands as user.

Reviewers: mg

Reviewed By: mg

Differential Revision: https://review.inboxapp.com/D27"
grinich,2014-03-09 04:14:06,https://api.github.com/repos/nylas/sync-engine/git/commits/c38f999169ba26f6f7c82cc9af851131aefb91bb,c38f999169ba26f6f7c82cc9af851131aefb91bb,"add iconv codecs

Summary:
Time time has come for iconv.

```
LookupError: unknown encoding: iso-2022-cn
<ImapFolderSyncMonitor at 0x2cba380> failed with LookupError
```

Test Plan: You can run it on some wonky mail, or just trust me. I've only had this issue with a few messages in my +500k mailbox.

Reviewers: spang

Reviewed By: spang

Differential Revision: https://review.inboxapp.com/D25"
spang,2014-03-09 04:10:03,https://api.github.com/repos/nylas/sync-engine/git/commits/8a9a394a9c43759f0f014ea8223fdf50c528c44e,8a9a394a9c43759f0f014ea8223fdf50c528c44e,"Use parens instead of breaking import over multiple lines.

As recommended by Writing Idiomatic Python."
grinich,2014-03-09 03:51:26,https://api.github.com/repos/nylas/sync-engine/git/commits/346ebfd5c740b9028008f6b5f5d89d25be7077cb,346ebfd5c740b9028008f6b5f5d89d25be7077cb,"[CONFIG] [SCHEMA]

Summary:
Since we're now running migrations, we need to make sure alembic always knows where it is in the history by ""stamping"" the revision. This is saved in the `alembic_revision` table in the inbox databasel

You need to do two things to update your working copy for this patch:

1. Add this line to your config.cfg:

`ALEMBIC_INI = ./alembic.ini`

2. Run this in the top-level folder

`alembic stamp head`

This will ""stamp"" your database to the latest alembic revision hash (should be `269247bc37d3`), meaning that when you run `alembic upgrade head`, it will only apply new migrations. If you don't do this, alembic will try to run _all_ the migrations, even for those whose changes have already been propagated to the relevant database models.

I've also added a script that does this when the database is created, so you don't need to manually do this when booting a new dev box.

(Obviously we should do something different for prod deployments on ec2.)

Test Plan: Running `sudo python tools/create_db.py` should be idempotent, and detect that the database has both already been created and stamped. If not, it will create the DB and stamp it.

Reviewers: spang

Reviewed By: spang

Differential Revision: https://review.inboxapp.com/D24"
emfree,2014-03-09 03:21:37,https://api.github.com/repos/nylas/sync-engine/git/commits/1481a8967322bbc959550f97f3f0550e174fd2eb,1481a8967322bbc959550f97f3f0550e174fd2eb,"Set actions queue label from config.cfg.

Summary:
YOU MUST RERUN ./setup.sh AFTER THIS COMMIT.

The main point here is to allow the unit tests in test_actions.py to pass if
another Inbox instance is running concurrently. Previously, that instance would
grab actions enqueued by the test, causing the test to fail.

Another solution would be to use a separate Redis instance for the tests, but
that seems a lot more complicated.

Test Plan: Ran ./runtests with ./inbox debug running in the background.

Reviewers: spang, mg

Reviewed By: spang

Differential Revision: https://review.inboxapp.com/D21"
emfree,2014-03-07 02:22:30,https://api.github.com/repos/nylas/sync-engine/git/commits/bfb62a61c7db3f4a61d9e335883388bd44f4108b,bfb62a61c7db3f4a61d9e335883388bd44f4108b,"Replace copy.deepcopy by manual copy in rolodex.py.

Summary:
This fixes a breakage caused by creating a new Contact object from an old one
via deepcopy() and subsequently committing both to the database. Sqlalchemy
will fail with the error message ""A conflicting state was already present in
the identity map.""

On the topic of logspam, you may still see warnings of the following form when
syncing new contacts:

  /usr/local/lib/python2.7/dist-packages/sqlalchemy/orm/session.py:1824:
  SAWarning: Attribute history events accumulated on 1 previously clean
  instances within inner-flush event handlers have been reset, and will not
  result in database updates. Consider using set_committed_value() within
  inner-flush event handlers to avoid this warning.

These seem to occur even with the original version of rolodex.py. It appears to
be related to session versioning; working on a fix.

Test Plan: Added some google contacts and ran ./inbox debug.

Reviewers: mg

Reviewed By: mg

Differential Revision: https://review.inboxapp.com/D19"
grinich,2014-03-07 00:38:51,https://api.github.com/repos/nylas/sync-engine/git/commits/bc7cde36b7b676c2ceb89b4b4097cfa5fe54e8eb,bc7cde36b7b676c2ceb89b4b4097cfa5fe54e8eb,MySQL configuration for storing database on ec2 non-root partition
grinich,2014-03-06 21:30:17,https://api.github.com/repos/nylas/sync-engine/git/commits/e87d06a9f262b9fbb3019d08cd86b5be35ad3532,e87d06a9f262b9fbb3019d08cd86b5be35ad3532,"LittleJSON was a bit too little for some flags

Test Plan: Run the migration via `alembic upgrade head`

Reviewers: spang

Reviewed By: spang

Differential Revision: https://review.inboxapp.com/D17"
grinich,2014-03-06 19:33:47,https://api.github.com/repos/nylas/sync-engine/git/commits/68981853957df10fc8bb169dba1a91f8bb71a2f2,68981853957df10fc8bb169dba1a91f8bb71a2f2,"store g_thrid as BigInteger and send filter by integers, not strings

Test Plan: Run the migration

Reviewers: spang

Reviewed By: spang

Differential Revision: https://review.inboxapp.com/D16"
spang,2014-03-06 18:44:39,https://api.github.com/repos/nylas/sync-engine/git/commits/26acdf586610ac53db58c0f314fff816c06ab7d0,26acdf586610ac53db58c0f314fff816c06ab7d0,"Clarify when new_db_session() is still required.

Auditors: eben"
spang,2014-03-06 18:36:58,https://api.github.com/repos/nylas/sync-engine/git/commits/62f25036495c30d9edb343ae2bc2a20a8fb8153f,62f25036495c30d9edb343ae2bc2a20a8fb8153f,"Clarify database session documentation.

Summary:
Don't use new_db_session() in ./inbox.

Whenever we can, we should be using session_scope()
which will properly rollback transaction failures
and close the session when it goes out of scope.

Test Plan: Ran ./inbox.

Reviewers: emfree

Reviewed By: emfree

Differential Revision: https://review.inboxapp.com/D15

Conflicts:
	tools/regen-sanitized"
grinich,2014-03-06 08:37:23,https://api.github.com/repos/nylas/sync-engine/git/commits/a94bbd20b474baa688397baed845ea28f331c1c8,a94bbd20b474baa688397baed845ea28f331c1c8,remove space to match error line
grinich,2014-03-05 03:27:10,https://api.github.com/repos/nylas/sync-engine/git/commits/0644ec5c040681cedf6cfa2f93c00ae8825e6660,0644ec5c040681cedf6cfa2f93c00ae8825e6660,"Split the query into windowed parts, since loading all the rows into memory
is slow and usually kills the Python process."
grinich,2014-03-05 03:24:25,https://api.github.com/repos/nylas/sync-engine/git/commits/2bab791c7eeb70fc7b9f3869d41ecabdd2da13c0,2bab791c7eeb70fc7b9f3869d41ecabdd2da13c0,"Work-in-progress of handling `maximum recursion depth exceeded` errors that
are occasionally thrown by BeautifulSoup.

This hasn't been super well tested, as it has only been an issue on a message
every 100k or so...

In the future I want to switch to Google's Gumbo parser (or something) for
better speed and error handling."
emfree,2014-03-05 00:17:23,https://api.github.com/repos/nylas/sync-engine/git/commits/6fc0ad470a36a2fee8e75bfa5e19308a60557891,6fc0ad470a36a2fee8e75bfa5e19308a60557891,"Update test DB dump following dcc3b4993.

Test Plan: ./runtests

Reviewers: mg

Reviewed By: mg

Differential Revision: https://review.inboxapp.com/D13"
emfree,2014-03-04 20:07:41,https://api.github.com/repos/nylas/sync-engine/git/commits/46ff8cac7a2d4e2fbc7e6fd833ef0bf222923686,46ff8cac7a2d4e2fbc7e6fd833ef0bf222923686,"Add facility to log unhandled errors in greenlets.

Test Plan: Unit-test added in test_logging.py

Reviewers: spang, mg

Reviewed By: spang

Differential Revision: https://review.inboxapp.com/D7"
grinich,2014-03-04 08:35:35,https://api.github.com/repos/nylas/sync-engine/git/commits/32cc11bc36f1cf755059aa076bdb9beff064c749,32cc11bc36f1cf755059aa076bdb9beff064c749,remove some of the noisy logging
grinich,2014-03-04 07:54:34,https://api.github.com/repos/nylas/sync-engine/git/commits/dcc3b49937d2104b3505b37238e70243eae4f0df,dcc3b49937d2104b3505b37238e70243eae4f0df,"[SCHEMA] So apparently the Message-ID header is not actually required by Gmail.

This commit includes a migration which should be run using `alembic update head1.
I renamed the `message_id` column to `message_id_header` since we're using
properties other places with *very* similar names (see backrefs).

Ironically it was stored messages from Mailbox that don't include the
Message-ID header as required by RFC-2822. See below...

```
mysql> select message.subject from message where message_id_header IS NULL;
+---------------------------------+
| subject                         |
+---------------------------------+
| Tips for Using Mailbox in Gmail |
+---------------------------------+
1 row in set (3.92 sec)
```

Auditors: spang"
spang,2014-03-04 07:49:23,https://api.github.com/repos/nylas/sync-engine/git/commits/4d3a7b316b31ff0f2f7eaa071f540cd721a06091,4d3a7b316b31ff0f2f7eaa071f540cd721a06091,"[SCHEMA] Store g_msgid and g_thrid as BigIntegers.

Summary:
These take _way_ less storage space than 40-character strings, so
much better for putting indexes on, which we need.

Test Plan: It's running in tmux on your AWS dev box.

Reviewers: mg

Reviewed By: mg

Differential Revision: https://review.inboxapp.com/D11"
spang,2014-03-04 06:38:25,https://api.github.com/repos/nylas/sync-engine/git/commits/91a8058092749d4c6ecc8c245e02c90996204f40,91a8058092749d4c6ecc8c245e02c90996204f40,"Document our module import grouping guideline.

Pretty sure this is only in my brain, and I can't really justify
nitpicking about it if I don't tell anyone what rules I'm using. ;)"
grinich,2014-03-04 06:10:46,https://api.github.com/repos/nylas/sync-engine/git/commits/4965d1547bbb01ffef5cdc3f43f4d6a86dbc20f9,4965d1547bbb01ffef5cdc3f43f4d6a86dbc20f9,"pretty sure this was some cruft debugging code...

Auditors: spang"
spang,2014-03-04 04:20:21,https://api.github.com/repos/nylas/sync-engine/git/commits/674d72604cda2d64180ee0ab7db0c9e314e59e7f,674d72604cda2d64180ee0ab7db0c9e314e59e7f,Log slow queries by default.
spang,2014-03-04 01:12:50,https://api.github.com/repos/nylas/sync-engine/git/commits/7499c4621c77a7fcbb6683d04d6fdfb084732e66,7499c4621c77a7fcbb6683d04d6fdfb084732e66,Bump SQLAlchemy and MySQL-Python req to latest stable.
spang,2014-03-04 00:35:12,https://api.github.com/repos/nylas/sync-engine/git/commits/29bd8403b73ea3642a12d8173be7981ebd2f8738,29bd8403b73ea3642a12d8173be7981ebd2f8738,Fix migrations bitrot.
spang,2014-03-04 00:31:17,https://api.github.com/repos/nylas/sync-engine/git/commits/9f57f7a650acf67ccf1eb913f3e95b62bfb62fda,9f57f7a650acf67ccf1eb913f3e95b62bfb62fda,"Re-add alembic to requirements.txt.

Shouldn't really have been removed in the first place, but we're
doing migrations for all schema changes now."
emfree,2014-03-03 19:55:01,https://api.github.com/repos/nylas/sync-engine/git/commits/55a046de13998cf0d09f8f4b965c3012d20395ea,55a046de13998cf0d09f8f4b965c3012d20395ea,"Fix config for test_api.py.

Summary:
A seemingly wrong entry for MSG_PARTS_DIRECTORY in tests/config.cfg was causing
test_headers_for_message to fail when it couldn't find the data on
disk.

Test Plan: ./runtests

Reviewers: kav-ya

Reviewed By: kav-ya

Differential Revision: https://review.inboxapp.com/D10"
grinich,2014-03-02 21:23:27,https://api.github.com/repos/nylas/sync-engine/git/commits/3750f13110af76bebc479d0fe51cd1a9bf1b860a,3750f13110af76bebc479d0fe51cd1a9bf1b860a,add lots of instrumentation logging
emfree,2014-02-28 23:42:13,https://api.github.com/repos/nylas/sync-engine/git/commits/cc95b14aa66f1cd842b301bda28d04209bb7ff60,cc95b14aa66f1cd842b301bda28d04209bb7ff60,"Actually set g_id for Contact objects.

Summary:
The g_id field is (presumably) supposed to be the unique ID for contacts coming
from the Google contacts API. But it wasn't being set at all.

Test Plan: Adding tests for contacts code is a work-in-progress.

Reviewers: kav-ya

Reviewed By: kav-ya

Differential Revision: https://review.inboxapp.com/D9"
emfree,2014-02-28 03:50:51,https://api.github.com/repos/nylas/sync-engine/git/commits/75599298be23c4e39cb58399ceed51e8bf3f96e2,75599298be23c4e39cb58399ceed51e8bf3f96e2,"Separate Google-API-specific logic from rolodex.py.

Summary:
This is pretty much a prerequisite for unit-testing contact sync functionality,
adding other contact provider sources, etc.

Test Plan: Will add unit tests before merging.

Reviewers: spang

Reviewed By: spang

Differential Revision: https://review.inboxapp.com/D8"
emfree,2014-02-26 07:17:51,https://api.github.com/repos/nylas/sync-engine/git/commits/94626b7b41ad7f0f8bf14cc1cdfc48df0c1e3947,94626b7b41ad7f0f8bf14cc1cdfc48df0c1e3947,"Begin adding unit tests for cryptography module.

Summary: Add basic unit tests for util/cryptography.py. Also remove spurious trailing comma from .arcconfig (arc doesn't seem to like spurious trailing commas).

Test Plan: Commit adds tests.

Reviewers: spang

Reviewed By: spang

Differential Revision: https://review.inboxapp.com/D5"
spang,2014-02-26 05:52:28,https://api.github.com/repos/nylas/sync-engine/git/commits/8e9d6e4d90e12bf2a63f512798d207bfadfa3d4f,8e9d6e4d90e12bf2a63f512798d207bfadfa3d4f,"This stuff is for making it easy to run tests! ./runtests should now pass. A bunch of tests were broken because we weren't running them regularly.

Summary:
We moved all these to requirements.txt.

Small fixes to setup.py.

Postel tests require network.

Add a simple testrunner script.

Invoke with:
    ./runtests

before landing commits on master! It by default excludes tests
in tests/network, which are slow and not super reliable, but if
you're modifying the mail sync code you should run those too
with --all.

Unbreak actions tests.

Make move_thread() idempotent.

Can't think of a good reason for it not to be.

Fix test_actions.py.

This has been broken since the db test fixture scoping change.

Clean up test_api.py and make it pass again.

My php hates your JSON.

➜  inbox git:(master) ✗ php --version
PHP 5.5.9-1 (cli) (built: Feb  7 2014 18:09:20)
Copyright (c) 1997-2014 The PHP Group
Zend Engine v2.5.0, Copyright (c) 1998-2014 Zend Technologies
    with Zend OPcache v7.0.3, Copyright (c) 1999-2014, by Zend Technologies
➜  inbox git:(master) ✗ arc which
Exception
Unable to parse '.arcconfig' file '/home/spang/src/inboxapp/inbox/.arcconfig'. The file contents should be valid JSON.

FILE CONTENTS
{
  ""project_id"" : ""inbox"",
  ""conduit_uri"" : ""https://review.inboxapp.com/"",
}

(Run with --trace for a full exception trace.)

Test Plan: ./runtests -x

Reviewers: mg

Reviewed By: mg

Differential Revision: https://review.inboxapp.com/D6"
spang,2014-02-26 05:44:15,https://api.github.com/repos/nylas/sync-engine/git/commits/9aca6f877ea3d0f942fc5ea741c99528c5c8f2e3,9aca6f877ea3d0f942fc5ea741c99528c5c8f2e3,Make this comment a bit less ambiguous.
spang,2014-02-26 05:28:20,https://api.github.com/repos/nylas/sync-engine/git/commits/6ab1464f1f29453303570308bb69c9fe38ba63ce,6ab1464f1f29453303570308bb69c9fe38ba63ce,Fix a typo.
grinich,2014-02-26 04:42:26,https://api.github.com/repos/nylas/sync-engine/git/commits/0454864958d3659c6100402b23ccddd4fa36222b,0454864958d3659c6100402b23ccddd4fa36222b,arc configfile doh!
grinich,2014-02-25 23:56:34,https://api.github.com/repos/nylas/sync-engine/git/commits/facb3865f3be9c0fdc71652d818b02850f630d54,facb3865f3be9c0fdc71652d818b02850f630d54,actually use parts directory
spang,2014-02-25 23:02:52,https://api.github.com/repos/nylas/sync-engine/git/commits/4009bc29f8f239cf9c9f10780f22a387a91a31af,4009bc29f8f239cf9c9f10780f22a387a91a31af,Fix missing arg bug w/update_metadata().
spang,2014-02-25 22:42:08,https://api.github.com/repos/nylas/sync-engine/git/commits/698a08511d55c045d1887bacb79965c0c325f0f8,698a08511d55c045d1887bacb79965c0c325f0f8,Don't install nodejs here. (JS code lives elsewhere now.)
spang,2014-02-25 04:06:14,https://api.github.com/repos/nylas/sync-engine/git/commits/a6fffd3dab55f5b076e586952e1a335ffe5b80c3,a6fffd3dab55f5b076e586952e1a335ffe5b80c3,"Use set comprehensions when appropriate.

More idiomatic / cleaner. These were introduced in Python 2.7, which we
require:
http://docs.python.org/dev/whatsnew/2.7.html\#other-language-changes"
spang,2014-02-25 03:58:17,https://api.github.com/repos/nylas/sync-engine/git/commits/25aa6fb5887f1f60c833299c379bbf03cc794e45,25aa6fb5887f1f60c833299c379bbf03cc794e45,Clarify the role of inbox.util module.
spang,2014-02-24 05:26:07,https://api.github.com/repos/nylas/sync-engine/git/commits/4a42a48c413512d37e2cb8badc565a01a5240096,4a42a48c413512d37e2cb8badc565a01a5240096,Correct outdated comment.
spang,2014-02-24 04:00:33,https://api.github.com/repos/nylas/sync-engine/git/commits/488ce078bd803744e8eb8fc8d499b21059c6618c,488ce078bd803744e8eb8fc8d499b21059c6618c,"Don't break @timed, just stop timing stuff."
spang,2014-02-24 03:59:00,https://api.github.com/repos/nylas/sync-engine/git/commits/ebad54fd0c0c53195abf675ca0bac7a470e53b22,ebad54fd0c0c53195abf675ca0bac7a470e53b22,"Use - instead of set.difference()

More idiomatic, cleaner."
grinich,2014-02-24 02:35:21,https://api.github.com/repos/nylas/sync-engine/git/commits/395f29afd10bf31adaf286dda7af4d10a00625cb,395f29afd10bf31adaf286dda7af4d10a00625cb,https for review server
grinich,2014-02-22 07:21:09,https://api.github.com/repos/nylas/sync-engine/git/commits/cd411973b55478414f127c32ded62bd5b6d0ae67,cd411973b55478414f127c32ded62bd5b6d0ae67,really sick of this log statement
spang,2014-02-22 04:55:23,https://api.github.com/repos/nylas/sync-engine/git/commits/e25ce1336de265fee1d4238e382da73969f32630,e25ce1336de265fee1d4238e382da73969f32630,Only create a new ImapUid if the message correctly decoded.
spang,2014-02-22 00:18:48,https://api.github.com/repos/nylas/sync-engine/git/commits/fb9dbfa6506ee026998e42071e1a044fd2273feb,fb9dbfa6506ee026998e42071e1a044fd2273feb,"Add docstring conventions to README.md.

We're not really using them yet, but I just started using
them for documenting parameters and think we should use
them more going forward (see http://stackoverflow.com/a/10065932)."
spang,2014-02-21 20:26:30,https://api.github.com/repos/nylas/sync-engine/git/commits/fe5fdcc5e081caaee3867386be9107b4a140ac68,fe5fdcc5e081caaee3867386be9107b4a140ac68,Update test dump for changed column name
spang,2014-02-21 19:56:02,https://api.github.com/repos/nylas/sync-engine/git/commits/2e43f0296b004a8417264e2146c4087c8fc4c94c,2e43f0296b004a8417264e2146c4087c8fc4c94c,"Separate Message and ImapUid creation.

Making way for non-IMAP account backends!"
spang,2014-02-21 19:41:30,https://api.github.com/repos/nylas/sync-engine/git/commits/096e4818797f55eae152d732574c325ebc6c5d9e,096e4818797f55eae152d732574c325ebc6c5d9e,"[SCHEMA] Rename internaldate to received_date

INTERNALDATe is IMAP-specific and received_date is more descriptive
anyway."
spang,2014-02-21 19:17:20,https://api.github.com/repos/nylas/sync-engine/git/commits/cb9a3be0489173f68f3ceca599eeb7000890e808,cb9a3be0489173f68f3ceca599eeb7000890e808,Rearrange docs to split out Gmail and general info
spang,2014-02-21 01:01:22,https://api.github.com/repos/nylas/sync-engine/git/commits/668b25f7dbf37201d423a72802af34e127069b8c,668b25f7dbf37201d423a72802af34e127069b8c,Tests for some import delete cascades.
spang,2014-02-21 00:59:45,https://api.github.com/repos/nylas/sync-engine/git/commits/f9fbf18eda0cc372f619ec6fb8ebfec46602137e,f9fbf18eda0cc372f619ec6fb8ebfec46602137e,Make some other delete cascades explicit.
spang,2014-02-21 00:46:29,https://api.github.com/repos/nylas/sync-engine/git/commits/d01111aea768735ee1d2e9ee6cc499ed2b25c0a4,d01111aea768735ee1d2e9ee6cc499ed2b25c0a4,"Configure delete cascading for Message, ImapUid, and Block."
spang,2014-02-21 00:45:53,https://api.github.com/repos/nylas/sync-engine/git/commits/cec848593c996d4e2798645f6648ec11904c5202,cec848593c996d4e2798645f6648ec11904c5202,"Specify echo=False in our engine configuration.

Makes it easy to figure out where to flip on echo=True for debugging
when desired."
spang,2014-02-21 00:05:04,https://api.github.com/repos/nylas/sync-engine/git/commits/658fd53f20ff3c2775a065dea4f695564c96c015,658fd53f20ff3c2775a065dea4f695564c96c015,"Isolate db usage to a single test

We can't really guarantee that multiple different test functions
will restore the database to its original state, especially across
files."
spang,2014-02-21 00:04:16,https://api.github.com/repos/nylas/sync-engine/git/commits/f3ec51c40364986267e98124d496820ee13bf038,f3ec51c40364986267e98124d496820ee13bf038,Update test dump for new column
spang,2014-02-20 23:26:55,https://api.github.com/repos/nylas/sync-engine/git/commits/6ff7ecf37f78d71206fe32f9a5f49527b1e11e1f,6ff7ecf37f78d71206fe32f9a5f49527b1e11e1f,"Fix Lock() implementation of __exit__()

Not sure why this hasn't bitten us until now."
spang,2014-02-20 22:39:53,https://api.github.com/repos/nylas/sync-engine/git/commits/3e432acbd144051846cbf5b012d818ee619ef0e7,3e432acbd144051846cbf5b012d818ee619ef0e7,Wrap local datastore update actions in namespace lock.
spang,2014-02-20 20:27:47,https://api.github.com/repos/nylas/sync-engine/git/commits/a75a83a3abb5eb302d96f45e62973094a561deb0,a75a83a3abb5eb302d96f45e62973094a561deb0,Remove totally redundant comment.
spang,2014-02-20 20:12:14,https://api.github.com/repos/nylas/sync-engine/git/commits/b4b5776f786f385fb55b7d304b30e3886d2aabec,b4b5776f786f385fb55b7d304b30e3886d2aabec,"Properly fill out Message.is_draft.

(This hadn't been implemented yet.)"
spang,2014-02-20 20:11:33,https://api.github.com/repos/nylas/sync-engine/git/commits/ff015ee1835f9a05cfcbd6eca0bd2c2b946f5431,ff015ee1835f9a05cfcbd6eca0bd2c2b946f5431,"Wrap mailsync message update/delete in syncmanager_lock too.

These can end up modifying datastore data too (i.e. tables other than ImapUid)."
spang,2014-02-20 19:20:51,https://api.github.com/repos/nylas/sync-engine/git/commits/27c75e08179bcf027536f335e63f955ceb839e8f,27c75e08179bcf027536f335e63f955ceb839e8f,"Switch IMAP mail sync to use namespace-wide write lock.

We can't just use an in-memory lock anymore because we're going to have
other processes writing to the database too. We need to generalize to a
per-namespace lock in order to support shared folders in the future."
spang,2014-02-20 19:03:10,https://api.github.com/repos/nylas/sync-engine/git/commits/0f76acb7b9e0b1220e6fa069abc87a06a2bad324,0f76acb7b9e0b1220e6fa069abc87a06a2bad324,"Add a write lock for ImapAccount.

We need this in order to be able to have different processes
updating data in the datastore, e.g. API functions from Inbox
clients and the mail sync engine."
spang,2014-02-20 19:01:50,https://api.github.com/repos/nylas/sync-engine/git/commits/321a81f6216e2a5f64525e10b387acd5e536272a,321a81f6216e2a5f64525e10b387acd5e536272a,Document ImapAccount.sync_lock()
spang,2014-02-20 18:24:20,https://api.github.com/repos/nylas/sync-engine/git/commits/3dd4e2c836645adce19a669de2518b3bfd573067,3dd4e2c836645adce19a669de2518b3bfd573067,"[SCHEMA] Add is_draft column to Message

This is part of the Inbox datastore API that we're going to expose."
spang,2014-02-20 02:48:03,https://api.github.com/repos/nylas/sync-engine/git/commits/01fb25c8f34f73622b9406bda69bc5285fca5df5,01fb25c8f34f73622b9406bda69bc5285fca5df5,doc updates
spang,2014-02-19 23:36:40,https://api.github.com/repos/nylas/sync-engine/git/commits/0f7d8c257b6cb2f9bc3a015fd06eaa50c16f29b2,0f7d8c257b6cb2f9bc3a015fd06eaa50c16f29b2,some more notes on IMAP sessions
spang,2014-02-19 01:02:43,https://api.github.com/repos/nylas/sync-engine/git/commits/700e3ee272d07857534d6b7d9327ad8b746b2582,700e3ee272d07857534d6b7d9327ad8b746b2582,Test queue running.
spang,2014-02-18 21:55:31,https://api.github.com/repos/nylas/sync-engine/git/commits/1acb8d92c0134419ff4022d657181e3027deb31c,1acb8d92c0134419ff4022d657181e3027deb31c,"Update test database dump.

New columns."
spang,2014-02-18 20:15:56,https://api.github.com/repos/nylas/sync-engine/git/commits/451497e4787818ad245f3ee334db7d8c70ddcd79,451497e4787818ad245f3ee334db7d8c70ddcd79,Forgot to add account ID on these functions.
spang,2014-02-18 20:15:08,https://api.github.com/repos/nylas/sync-engine/git/commits/5a84dc2f8edc9899eb5b36290ef498a03e2aa4e3,5a84dc2f8edc9899eb5b36290ef498a03e2aa4e3,"add dashboard req

Sooo useful for monitoring queues.
Try it at 192.168.10.200:9181 today!"
spang,2014-02-18 19:40:03,https://api.github.com/repos/nylas/sync-engine/git/commits/19990c4bf5e63fb59869ca4298e045a02ca64c6f,19990c4bf5e63fb59869ca4298e045a02ca64c6f,We're using the system lxml
spang,2014-02-18 19:34:33,https://api.github.com/repos/nylas/sync-engine/git/commits/25dc3a0557006d69dc4a72883b452b0c0d345c47,25dc3a0557006d69dc4a72883b452b0c0d345c47,"bump a couple reqs

Trying to see if bumping zerorpc/zeromq fixes some bugs I'm seeing."
spang,2014-02-17 22:46:29,https://api.github.com/repos/nylas/sync-engine/git/commits/93fe0b9a5a223267a0363b1c1b67f7d77f6918fa,93fe0b9a5a223267a0363b1c1b67f7d77f6918fa,inbox script launches actions worker
spang,2014-02-17 00:42:54,https://api.github.com/repos/nylas/sync-engine/git/commits/bfbf6dc1e661b856079f6a8bffa000040ec107f5,bfbf6dc1e661b856079f6a8bffa000040ec107f5,"Make IMAP connection readonly bit configurable

Aaand it defaults to True, for paranoia's sake."
spang,2014-02-17 00:05:39,https://api.github.com/repos/nylas/sync-engine/git/commits/87a8434ea7937a2d4061ad7d07deb5c5eb6400a1,87a8434ea7937a2d4061ad7d07deb5c5eb6400a1,Document funny Gmail IMAP behaviour involving labels
spang,2014-02-16 20:46:04,https://api.github.com/repos/nylas/sync-engine/git/commits/8dfef4e8f9a3a2d799cb64383de022895a30d591,8dfef4e8f9a3a2d799cb64383de022895a30d591,Note about rationale for splitting out write actions
spang,2014-02-16 19:51:43,https://api.github.com/repos/nylas/sync-engine/git/commits/cc0a7c7fc17676f36dce083a0d383d5bc92b32ea,cc0a7c7fc17676f36dce083a0d383d5bc92b32ea,"s/uidvalidity_callback/uidvalidity_cb/g

cb is a pretty standard abbreviation for callback, and using it makes
the function name a bit less unwieldy."
spang,2014-02-16 19:46:07,https://api.github.com/repos/nylas/sync-engine/git/commits/3e2b755a93e6532fff278a65d45a420b616237b5,3e2b755a93e6532fff278a65d45a420b616237b5,pluralize actions submodule to be more in line with models
spang,2014-02-14 01:14:06,https://api.github.com/repos/nylas/sync-engine/git/commits/af094cf61db3b1fa31e5047cf7d28fd158ccb58f,af094cf61db3b1fa31e5047cf7d28fd158ccb58f,"change thread_id arg in crispin to g_thrid

It's too confusing the way it is---it conflicts with our thread_id
columns in the models."
spang,2014-02-14 01:11:46,https://api.github.com/repos/nylas/sync-engine/git/commits/746b5a25cfc64fda7897b81d801b1cd11527f62d,746b5a25cfc64fda7897b81d801b1cd11527f62d,"Disable crispin's usage of readonly=True on select

OK, this is getting real now. :)"
spang,2014-02-13 19:10:07,https://api.github.com/repos/nylas/sync-engine/git/commits/a5fe07cadeede8d4f6198f4dbc2889e837b69970,a5fe07cadeede8d4f6198f4dbc2889e837b69970,syncback tests
spang,2014-02-13 19:09:10,https://api.github.com/repos/nylas/sync-engine/git/commits/b8106fde9afdf45415b26196cb6ea2a3c7d95d54,b8106fde9afdf45415b26196cb6ea2a3c7d95d54,implement gmail syncback actions
spang,2014-02-12 18:30:39,https://api.github.com/repos/nylas/sync-engine/git/commits/550aaed21e55171889fecf623618d6dd1c28fb77,550aaed21e55171889fecf623618d6dd1c28fb77,Add redis-server to VM deps
spang,2014-02-12 18:25:21,https://api.github.com/repos/nylas/sync-engine/git/commits/dfbc5ae738b4975d1f17304ad94915d1e0a58ac9,dfbc5ae738b4975d1f17304ad94915d1e0a58ac9,"Ow, that's a bug"
spang,2014-02-12 18:25:13,https://api.github.com/repos/nylas/sync-engine/git/commits/91de9524ade41ce244b9b2118e4f2aee9f27050a,91de9524ade41ce244b9b2118e4f2aee9f27050a,Update local actions to take advantage of new datastore folder abstraction
spang,2014-02-12 00:24:26,https://api.github.com/repos/nylas/sync-engine/git/commits/ceee8622e53aec14f80e7e2de4e0864fd8e6d91e,ceee8622e53aec14f80e7e2de4e0864fd8e6d91e,Less ambiguous name for test_events.py
spang,2014-02-11 20:18:23,https://api.github.com/repos/nylas/sync-engine/git/commits/48c341d6ffa1c3ae3d019dd9e739099c9c9f7d41,48c341d6ffa1c3ae3d019dd9e739099c9c9f7d41,implement and test local thread copy
spang,2014-02-06 23:39:28,https://api.github.com/repos/nylas/sync-engine/git/commits/9c0329230d8908bf99974b0bb5ae6772e8cd9bad,9c0329230d8908bf99974b0bb5ae6772e8cd9bad,unit tests for local client actions
spang,2014-02-06 23:38:59,https://api.github.com/repos/nylas/sync-engine/git/commits/c86ce0cf17216c82b9b1f26e94c00b6fc8a44811,c86ce0cf17216c82b9b1f26e94c00b6fc8a44811,rq test fixture
spang,2014-02-06 19:06:01,https://api.github.com/repos/nylas/sync-engine/git/commits/c8a75ca041df444ea343db62448e23dce126267e,c8a75ca041df444ea343db62448e23dce126267e,add rq to requirements
spang,2014-01-18 22:00:01,https://api.github.com/repos/nylas/sync-engine/git/commits/c28b45b114841fa34bc3fd9d65f0bdf48366341a,c28b45b114841fa34bc3fd9d65f0bdf48366341a,Prototype queue processing for actions.
spang,2014-02-20 20:37:50,https://api.github.com/repos/nylas/sync-engine/git/commits/295673c1e8b53fccd1bfc6e3886b02756121313d,295673c1e8b53fccd1bfc6e3886b02756121313d,Fix mis-merge. Sorry mg!
grinich,2014-02-20 08:29:41,https://api.github.com/repos/nylas/sync-engine/git/commits/a5cda4b341b437b3a04f5f872a04c5ddda09bd95,a5cda4b341b437b3a04f5f872a04c5ddda09bd95,define conn_pool_size default to 1
grinich,2014-02-20 05:00:58,https://api.github.com/repos/nylas/sync-engine/git/commits/f57ba943643a415a78ce59e9a33fa6fea808374f,f57ba943643a415a78ce59e9a33fa6fea808374f,quick hack to hopefully skip beautifulsoup bug
spang,2014-02-19 22:55:53,https://api.github.com/repos/nylas/sync-engine/git/commits/d59a66c14e68ff6d188a6115d4b2e7d52eedf04c,d59a66c14e68ff6d188a6115d4b2e7d52eedf04c,add reference to UIDVALIDITY section in rfc3501
spang,2014-02-16 22:21:26,https://api.github.com/repos/nylas/sync-engine/git/commits/591d81dea602761bd8f189a467ff43d2bb478180,591d81dea602761bd8f189a467ff43d2bb478180,Make a note about ImapUid test entries
spang,2014-02-11 23:59:51,https://api.github.com/repos/nylas/sync-engine/git/commits/c0f36137bc1376faab843e0a7817e980a509cb52,c0f36137bc1376faab843e0a7817e980a509cb52,Update test dump for new ImapAccount columns
spang,2014-02-17 22:56:48,https://api.github.com/repos/nylas/sync-engine/git/commits/60f3b0390a5f34b4ba08b8371fe2ceb38d991a70,60f3b0390a5f34b4ba08b8371fe2ceb38d991a70,remove unused imports in inbox script
spang,2014-02-18 00:38:12,https://api.github.com/repos/nylas/sync-engine/git/commits/bf98a7751b57fb32ce77de3a9d51e0c893b27163,bf98a7751b57fb32ce77de3a9d51e0c893b27163,mg removed the add command
spang,2014-02-12 02:26:32,https://api.github.com/repos/nylas/sync-engine/git/commits/81929329f43157a22909a5dbd4efc733cd6da48e,81929329f43157a22909a5dbd4efc733cd6da48e,"Canonicalize folder_names keys as lowercase

As a part of this, I'm also simplifying the logic in Gmail's
folder_names() detection to get rid of the janky usage of
boolean flags."
spang,2014-02-12 01:52:15,https://api.github.com/repos/nylas/sync-engine/git/commits/6062bd77883916bcd977294036e69f4ff371be8b,6062bd77883916bcd977294036e69f4ff371be8b,Canonicalize All Mail to be 'archive' in our datastore
spang,2014-02-11 23:41:08,https://api.github.com/repos/nylas/sync-engine/git/commits/9132649e70af95e4cc97cec0e05737eb9f182917,9132649e70af95e4cc97cec0e05737eb9f182917,IMAP sync backends now save folder names when sync starts.
spang,2014-02-14 23:45:55,https://api.github.com/repos/nylas/sync-engine/git/commits/567702dadc52c9ba890bd52e8d81b69793607952,567702dadc52c9ba890bd52e8d81b69793607952,MSGDIR changed names while I wasn't looking
spang,2014-02-18 00:52:06,https://api.github.com/repos/nylas/sync-engine/git/commits/dd3e31cdac2dfa61a1e059a544eff86326afd0d6,dd3e31cdac2dfa61a1e059a544eff86326afd0d6,pool_size arg went missing somewhere
spang,2014-02-18 00:51:42,https://api.github.com/repos/nylas/sync-engine/git/commits/c695c1668fbd5a3f8c3468ac771efdc7aba14d04,c695c1668fbd5a3f8c3468ac771efdc7aba14d04,cleanups
spang,2014-02-13 19:08:47,https://api.github.com/repos/nylas/sync-engine/git/commits/a2c9d299ec084fe93333a7dcd089762a09db5221,a2c9d299ec084fe93333a7dcd089762a09db5221,Add a backref to message to access associated imapuid
spang,2014-02-11 23:39:48,https://api.github.com/repos/nylas/sync-engine/git/commits/d32275d46f99dadb9e93a4f4d353d495a6558d28,d32275d46f99dadb9e93a4f4d353d495a6558d28,[SCHEMA] add inbox folder name cols to imapaccount
spang,2014-02-12 01:51:50,https://api.github.com/repos/nylas/sync-engine/git/commits/cde691852dbbca1cabc5a751ad6592877318860e,cde691852dbbca1cabc5a751ad6592877318860e,"Remove duplicate lower() call.

We already make sure all members of existing_labels and new_labels are
lowercase."
spang,2014-02-11 22:46:51,https://api.github.com/repos/nylas/sync-engine/git/commits/ee1d52ee80c7b9d3e6e1e47e07835d6216176b4a,ee1d52ee80c7b9d3e6e1e47e07835d6216176b4a,Better docstrings for FolderItem/ImapUid
spang,2014-02-18 18:40:09,https://api.github.com/repos/nylas/sync-engine/git/commits/b52d8dfdccee71239287556ea8ca4d492440da74,b52d8dfdccee71239287556ea8ca4d492440da74,"Fix make_account() call args

Something got messed up somewhere."
kav-ya,2014-02-18 04:15:17,https://api.github.com/repos/nylas/sync-engine/git/commits/905b7c4db64b10bcdba1de85cd01d6d98710519b,905b7c4db64b10bcdba1de85cd01d6d98710519b,"inbox_crypto renamed to cryptography, does not use config"
kav-ya,2014-02-17 06:32:19,https://api.github.com/repos/nylas/sync-engine/git/commits/972f96aa483056295883d956ee55c90972c3dd75,972f96aa483056295883d956ee55c90972c3dd75,Rebase fixed
kav-ya,2014-02-17 06:20:34,https://api.github.com/repos/nylas/sync-engine/git/commits/671f52c1a2cfac3d5724195798652c6806bd2b5a,671f52c1a2cfac3d5724195798652c6806bd2b5a,Passwords merged in
kav-ya,2014-02-17 06:13:28,https://api.github.com/repos/nylas/sync-engine/git/commits/8c1dc579d04c590674d1af2ce5a168f978897789,8c1dc579d04c590674d1af2ce5a168f978897789,Passwords CR-II changes
kav-ya,2014-02-12 21:52:16,https://api.github.com/repos/nylas/sync-engine/git/commits/099bee8d0ddae42774d9ec1d9a7d457f973b6333,099bee8d0ddae42774d9ec1d9a7d457f973b6333,Fail gracefully if non-Gmail sync
kav-ya,2014-02-11 22:36:47,https://api.github.com/repos/nylas/sync-engine/git/commits/acb370e87559faca6400e47813aa45dc5dbf7d37,acb370e87559faca6400e47813aa45dc5dbf7d37,Passwords CR changes
kav-ya,2014-02-02 00:40:44,https://api.github.com/repos/nylas/sync-engine/git/commits/bf5dd56579b2f7a3a1dad37831ff4acc7d37dc42,bf5dd56579b2f7a3a1dad37831ff4acc7d37dc42,Fixed MX query error. Added MX for Yahoo small biz
kav-ya,2014-01-31 23:00:15,https://api.github.com/repos/nylas/sync-engine/git/commits/dc13fe628e3f80161ffd1d53be1b17bcae8454fa,dc13fe628e3f80161ffd1d53be1b17bcae8454fa,imap_host added to ImapAccount table
kav-ya,2014-01-31 22:49:55,https://api.github.com/repos/nylas/sync-engine/git/commits/cbf6dc1aad19ae9e852cfde7f07c0e20974a4de4,cbf6dc1aad19ae9e852cfde7f07c0e20974a4de4,Cleanup
kav-ya,2014-01-31 22:42:37,https://api.github.com/repos/nylas/sync-engine/git/commits/16e32ee1749f45f12af3d263bb520a0088f05b2f,16e32ee1749f45f12af3d263bb520a0088f05b2f,getpass() to get password
kav-ya,2014-01-31 22:37:54,https://api.github.com/repos/nylas/sync-engine/git/commits/f93b70981a1c9b4dc142d0dc53b27387828f266d,f93b70981a1c9b4dc142d0dc53b27387828f266d,AES128 pw encryption
kav-ya,2014-01-31 19:28:22,https://api.github.com/repos/nylas/sync-engine/git/commits/71305004715223c63fa97f1ee24364559b642c94,71305004715223c63fa97f1ee24364559b642c94,Pre pycrypto passwords attempt
kav-ya,2014-01-29 07:06:25,https://api.github.com/repos/nylas/sync-engine/git/commits/7ab6bb10eba17b73c7c614ee0e62c4b01fa1e558,7ab6bb10eba17b73c7c614ee0e62c4b01fa1e558,Verify imap creds sep from login. Pw encryption impl too but not fully working.
kav-ya,2014-01-29 03:31:01,https://api.github.com/repos/nylas/sync-engine/git/commits/447834ed5fa18980a39b88d50b2fff761f9d7053,447834ed5fa18980a39b88d50b2fff761f9d7053,Pre-test changes
grinich,2014-01-29 00:26:35,https://api.github.com/repos/nylas/sync-engine/git/commits/3fa11d37b7d3139cc467036c8cd1064b45da5ce3,3fa11d37b7d3139cc467036c8cd1064b45da5ce3,"add code for identifying yahoo mail accounts, and remove command line add command in favor of auth"
kav-ya,2014-01-28 15:55:51,https://api.github.com/repos/nylas/sync-engine/git/commits/867d63831d1b4445a93bb6dabfd299c91d312a23,867d63831d1b4445a93bb6dabfd299c91d312a23,"Changes made, not working"
kav-ya,2014-01-27 22:07:11,https://api.github.com/repos/nylas/sync-engine/git/commits/4439a7d40f66f629a1e2c44465da6f7779403a36,4439a7d40f66f629a1e2c44465da6f7779403a36,Yahoo sync stuff started
kav-ya,2014-01-27 02:26:00,https://api.github.com/repos/nylas/sync-engine/git/commits/eb14996d399e23318c8f405af6f3c0833c13f45c,eb14996d399e23318c8f405af6f3c0833c13f45c,Capabilities
kav-ya,2014-01-24 17:35:38,https://api.github.com/repos/nylas/sync-engine/git/commits/06f223e8c82b6f9b0d317b64d70fa9340eecb912,06f223e8c82b6f9b0d317b64d70fa9340eecb912,With capabilities
kav-ya,2014-01-24 17:19:18,https://api.github.com/repos/nylas/sync-engine/git/commits/fd8454d5bd01a34950b0fcc95de45f34823277a7,fd8454d5bd01a34950b0fcc95de45f34823277a7,Yahoo basics
kav-ya,2014-01-23 08:12:12,https://api.github.com/repos/nylas/sync-engine/git/commits/bd2cfedeb65e8ec8b5d63862fca182c4d1d6afba,bd2cfedeb65e8ec8b5d63862fca182c4d1d6afba,"Yaayay testdb set-up, ready for API tests"
kav-ya,2014-01-23 04:09:04,https://api.github.com/repos/nylas/sync-engine/git/commits/0ef2a15f78404a9b109028d28e3d44d13e189b17,0ef2a15f78404a9b109028d28e3d44d13e189b17,Test db under test user created successfully
kav-ya,2014-01-22 22:08:59,https://api.github.com/repos/nylas/sync-engine/git/commits/1c106bebea18b2cc0026d9bdaf04b37afbf2ce94,1c106bebea18b2cc0026d9bdaf04b37afbf2ce94,"Convert to using a testDB, populated with data dump"
kav-ya,2014-01-22 16:05:57,https://api.github.com/repos/nylas/sync-engine/git/commits/d8d9f11fe0863d87e96d75ff08311241654ac9ef,d8d9f11fe0863d87e96d75ff08311241654ac9ef,test_api is broken
kav-ya,2014-01-20 12:18:20,https://api.github.com/repos/nylas/sync-engine/git/commits/70a5d157422044252894212fcb56a58a514d2c69,70a5d157422044252894212fcb56a58a514d2c69,Started tests
grinich,2014-02-14 05:51:58,https://api.github.com/repos/nylas/sync-engine/git/commits/4b3ad105b65c19792fdc408fdcf1e791a19438fc,4b3ad105b65c19792fdc408fdcf1e791a19438fc,dont print config
grinich,2014-02-14 05:49:45,https://api.github.com/repos/nylas/sync-engine/git/commits/4f034c562a62c910dff73dff204fa45cf360c53b,4f034c562a62c910dff73dff204fa45cf360c53b,Make sure to expand paths that have the home directory reference '~'
grinich,2014-02-08 04:39:34,https://api.github.com/repos/nylas/sync-engine/git/commits/3f077c2388073b7cb8949f4edf58971cd17185bb,3f077c2388073b7cb8949f4edf58971cd17185bb,smallchange
spang,2014-02-12 19:23:01,https://api.github.com/repos/nylas/sync-engine/git/commits/ca9e046dda04c54c09b1e824fe25244b66d6ba0f,ca9e046dda04c54c09b1e824fe25244b66d6ba0f,Make IMAP connection pool size configurable
spang,2014-02-11 22:29:54,https://api.github.com/repos/nylas/sync-engine/git/commits/000d5e1962dcdb16b866aab7200ffeb2a1dd2a05,000d5e1962dcdb16b866aab7200ffeb2a1dd2a05,"All crispin clients should implement folder_names().

This is a start towards hammering down the Inbox data store abstraction,
which will canonicalize the names and semantics of various folder names."
spang,2014-02-12 00:23:36,https://api.github.com/repos/nylas/sync-engine/git/commits/63f36285ca59fcd43f591f53c7ffaedf46472347,63f36285ca59fcd43f591f53c7ffaedf46472347,pytest fixture for SyncService
spang,2014-02-12 00:16:04,https://api.github.com/repos/nylas/sync-engine/git/commits/cc60320bfb894eaa236871ea0a28ae0b4f15f93c,cc60320bfb894eaa236871ea0a28ae0b4f15f93c,Add ben bitdiddle oauth credentials to tests/config.cfg
spang,2014-02-11 19:42:44,https://api.github.com/repos/nylas/sync-engine/git/commits/eb2b5753fa85672f533f103ff661d9d07def201d,eb2b5753fa85672f533f103ff661d9d07def201d,Clarify a comment
spang,2014-02-11 22:33:03,https://api.github.com/repos/nylas/sync-engine/git/commits/8081d6d9ffddca639d3839d963c9453617b4d370,8081d6d9ffddca639d3839d963c9453617b4d370,kill empty file
spang,2014-02-11 22:28:28,https://api.github.com/repos/nylas/sync-engine/git/commits/2faf25902c5b53691a1022d1f5311ca3bb13782e,2faf25902c5b53691a1022d1f5311ca3bb13782e,can has grammar
kav-ya,2014-02-11 20:08:13,https://api.github.com/repos/nylas/sync-engine/git/commits/6ace7bf682bf89e4cc79981d9ce5fb86331ad31f,6ace7bf682bf89e4cc79981d9ce5fb86331ad31f,New ML tests pass
spang,2014-02-11 18:27:15,https://api.github.com/repos/nylas/sync-engine/git/commits/b93ddcc1a719e7084fd44d0e188e535c2d0a7bed,b93ddcc1a719e7084fd44d0e188e535c2d0a7bed,"Merge pull request #3 from emfree/master

Tweaks to README.md and inbox script"
kav-ya,2014-02-11 17:54:24,https://api.github.com/repos/nylas/sync-engine/git/commits/5dbe8ddab1d8ca141fb3de9dcbc531b356fe7abf,5dbe8ddab1d8ca141fb3de9dcbc531b356fe7abf,mailing_list_headers-> thread
grinich,2014-02-07 22:28:04,https://api.github.com/repos/nylas/sync-engine/git/commits/34e9bd49828167a260d591a3176f1d7e14fa46b0,34e9bd49828167a260d591a3176f1d7e14fa46b0,touch up examples
spang,2014-02-06 22:50:23,https://api.github.com/repos/nylas/sync-engine/git/commits/d2cde756114de56f5d7f3caf5f0b1b4fa6caf511,d2cde756114de56f5d7f3caf5f0b1b4fa6caf511,"make clear-db support -c

Need it to debug weirdness with the test code's database teardown."
spang,2014-02-06 22:57:17,https://api.github.com/repos/nylas/sync-engine/git/commits/e74ff58c7bc99e5f7726831ee88df6a670f1071d,e74ff58c7bc99e5f7726831ee88df6a670f1071d,"close session before tearing down test db

Solves a test hang problem."
spang,2014-02-04 20:54:52,https://api.github.com/repos/nylas/sync-engine/git/commits/849f9a30f354aff495b5d32b3b5f66ea7dfb6d9a,849f9a30f354aff495b5d32b3b5f66ea7dfb6d9a,always use 'from pytest import fixture'
kav-ya,2014-02-06 08:11:07,https://api.github.com/repos/nylas/sync-engine/git/commits/486602dfa8a7c0227f14e5b82092ad3e08334313,486602dfa8a7c0227f14e5b82092ad3e08334313,tests_api fix: uses msg from new sync dump
spang,2014-02-06 02:12:38,https://api.github.com/repos/nylas/sync-engine/git/commits/81833b263a65b737de001a9f5a7a9840a265c8f8,81833b263a65b737de001a9f5a7a9840a265c8f8,add a mailing list message to the test data
emfree,2014-02-05 08:15:56,https://api.github.com/repos/nylas/sync-engine/git/commits/fd397eee98f3ad58abdcb97616e142a82156fc9f,fd397eee98f3ad58abdcb97616e142a82156fc9f,"Minor changes to README.md.

* Update Vagrant download link.
* ./inbox sync start expects an account ID, not an email address, so use
  ./inbox add instead."
emfree,2014-02-05 08:13:08,https://api.github.com/repos/nylas/sync-engine/git/commits/22c189b3ae212bce5d366366a494ba75a98d0632,22c189b3ae212bce5d366366a494ba75a98d0632,"Print welcome prompt after ZeroRPC services start.

I think this makes it clearer to the user that the script isn't somehow hanging
when starting the SearchService."
grinich,2014-02-04 20:58:27,https://api.github.com/repos/nylas/sync-engine/git/commits/9b95cdeaa5d85737a9ce59537108f74611b3ed13,9b95cdeaa5d85737a9ce59537108f74611b3ed13,"Merge pull request #2 from nvasilakis/master

[Minor] Update README file"
spang,2014-02-04 20:57:07,https://api.github.com/repos/nylas/sync-engine/git/commits/39985b6c31a36b3f4b3c6f1805f63976a16c5acd,39985b6c31a36b3f4b3c6f1805f63976a16c5acd,fix bad search-and-replace
spang,2014-02-04 20:50:28,https://api.github.com/repos/nylas/sync-engine/git/commits/ca1de401291f74858cb56da63a6b33c037b3dfd6,ca1de401291f74858cb56da63a6b33c037b3dfd6,Fix postel test
spang,2014-02-04 20:49:37,https://api.github.com/repos/nylas/sync-engine/git/commits/bbd40c1033c453c4b207078c6d57ee1a3a9bac87,bbd40c1033c453c4b207078c6d57ee1a3a9bac87,unify conftest.py and tests/util tree
nvasilakis,2014-02-04 20:40:31,https://api.github.com/repos/nylas/sync-engine/git/commits/49edc4933be7df448f31ed3d241bc5ca1a5fbf9d,49edc4933be7df448f31ed3d241bc5ca1a5fbf9d,"[Minor] Update README file

* Fix typos and numbering
* Fix external urls
* Remove back-ticks from last two commands
* Point to /examples directory"
spang,2014-02-04 20:16:28,https://api.github.com/repos/nylas/sync-engine/git/commits/0521e1f1b88b31adaf703aa050ca2893bc769a2b,0521e1f1b88b31adaf703aa050ca2893bc769a2b,"Update test data

We need parts too!"
spang,2014-02-04 20:14:14,https://api.github.com/repos/nylas/sync-engine/git/commits/aa710bc1f53489bc384354c3bdff9f037bc76d24,aa710bc1f53489bc384354c3bdff9f037bc76d24,more ignores
spang,2014-02-04 20:10:54,https://api.github.com/repos/nylas/sync-engine/git/commits/858ca11132531725b6fa352b977af1c0b9e974be,858ca11132531725b6fa352b977af1c0b9e974be,Don't hardcode ZeroRPC service socket locations
spang,2014-02-04 20:03:27,https://api.github.com/repos/nylas/sync-engine/git/commits/17a8f112e248794eec8ac404c6a8638150bc627f,17a8f112e248794eec8ac404c6a8638150bc627f,cleanups
spang,2014-02-04 19:57:14,https://api.github.com/repos/nylas/sync-engine/git/commits/6ef65ab91b18c1d3cf21040dac5035a2eaf7656a,6ef65ab91b18c1d3cf21040dac5035a2eaf7656a,Specify rolodex server loc in test config
spang,2014-02-04 19:55:05,https://api.github.com/repos/nylas/sync-engine/git/commits/9d83fb2f5c38b0d6fd557e0e63cf2c9c6d720947,9d83fb2f5c38b0d6fd557e0e63cf2c9c6d720947,Remove deprecated config variables
spang,2014-02-04 19:48:23,https://api.github.com/repos/nylas/sync-engine/git/commits/0bbefc78557a843238fb028b428b7dc2c8894723,0bbefc78557a843238fb028b428b7dc2c8894723,make ./inbox support specifying an alternative config file
spang,2014-02-04 19:40:16,https://api.github.com/repos/nylas/sync-engine/git/commits/05067d02aa9dcfdc8af9150857c58c357ad127ee,05067d02aa9dcfdc8af9150857c58c357ad127ee,configure message parts folder for testing
spang,2014-02-04 19:21:05,https://api.github.com/repos/nylas/sync-engine/git/commits/5053d9f85d215f8c7e906eca9870aa73cd394cab,5053d9f85d215f8c7e906eca9870aa73cd394cab,Don't import from within a method unless we have to.
spang,2014-02-04 19:05:28,https://api.github.com/repos/nylas/sync-engine/git/commits/b311448f2a279d91daee5bff6e2b328ec5bc23a2,b311448f2a279d91daee5bff6e2b328ec5bc23a2,"Make TestDB get configuration from test config

We already have the config() fixture from conftest.py,
so we don't need to replicate it here. In the future
we may want to unify the fixtures in conftest.py with
this other tree of fixtures."
spang,2014-02-04 19:04:22,https://api.github.com/repos/nylas/sync-engine/git/commits/8ad310f70d92d4b656a4d384a4214836913c5de9,8ad310f70d92d4b656a4d384a4214836913c5de9,"Put test data dump in subdir.

More separating tests vs other test stuff."
spang,2014-02-04 18:52:39,https://api.github.com/repos/nylas/sync-engine/git/commits/4739f87cee5baabf968700937bab20fe04fac25b,4739f87cee5baabf968700937bab20fe04fac25b,"Use different ports for ZeroRPC services during testing

Otherwise we get port clashes if we have an instance running
and try to run tests."
spang,2014-02-04 18:47:15,https://api.github.com/repos/nylas/sync-engine/git/commits/f625ac1ba3eeec2e815f4d225fd7eee4d5a22b4e,f625ac1ba3eeec2e815f4d225fd7eee4d5a22b4e,Make test_api.py use new api_client fixture
spang,2014-02-04 18:46:08,https://api.github.com/repos/nylas/sync-engine/git/commits/9dbfb4faae1afbed21d0e315b5148db5310643fe,9dbfb4faae1afbed21d0e315b5148db5310643fe,Test fixture for API clients
spang,2014-02-04 18:45:29,https://api.github.com/repos/nylas/sync-engine/git/commits/1f5d52f18df2fba70b53acd681ebb381f532adff,1f5d52f18df2fba70b53acd681ebb381f532adff,Document expected behaviour instead of leaving XXX comment
spang,2014-02-04 18:19:27,https://api.github.com/repos/nylas/sync-engine/git/commits/5380c50cb9763c58bfd1a5d49bcec97350cf9f7f,5380c50cb9763c58bfd1a5d49bcec97350cf9f7f,Note about what goes in conftest.py
spang,2014-02-04 18:19:16,https://api.github.com/repos/nylas/sync-engine/git/commits/85e145e4b999f44d8380d844af5217701ca397d4,85e145e4b999f44d8380d844af5217701ca397d4,"Remove DB() fixture from conftest.py

Deprecated by new fixture in util/base.py."
spang,2014-02-04 18:06:22,https://api.github.com/repos/nylas/sync-engine/git/commits/6ffecc183d837ec8153f956f058b7d20c4eca953,6ffecc183d837ec8153f956f058b7d20c4eca953,"Reorganize tests/ util code

It's nicer to have a separate tree for stuff we're importing
vs actual tests."
kav-ya,2014-02-04 17:13:16,https://api.github.com/repos/nylas/sync-engine/git/commits/f791c2a85272ed3f8bd6e86c3d9ff304e2a419d4,f791c2a85272ed3f8bd6e86c3d9ff304e2a419d4,Only create db if not exists
kav-ya,2014-02-04 07:44:48,https://api.github.com/repos/nylas/sync-engine/git/commits/1ff097a67f520e69590a2dbf4288ac636c6af9ed,1ff097a67f520e69590a2dbf4288ac636c6af9ed,first_10_subjects api fn uses Thread
spang,2014-02-03 23:32:19,https://api.github.com/repos/nylas/sync-engine/git/commits/f6403e2f9995a807ecd90d86ad8b247333ea2e1f,f6403e2f9995a807ecd90d86ad8b247333ea2e1f,trim trailing whitespace
kav-ya,2014-01-31 22:42:37,https://api.github.com/repos/nylas/sync-engine/git/commits/4b04eb979490860e7889c29b2ea47d9ceea1622c,4b04eb979490860e7889c29b2ea47d9ceea1622c,Passwords cherrypicked onto here
kav-ya,2014-02-03 23:10:17,https://api.github.com/repos/nylas/sync-engine/git/commits/78517d8c9980ad280b5063f6bf629b6d1b470681,78517d8c9980ad280b5063f6bf629b6d1b470681,Tabs->spaces in examples/first_10_subjects.py
grinich,2014-02-01 03:08:02,https://api.github.com/repos/nylas/sync-engine/git/commits/cb822c9d6f4b4e3f4f8ddc464d0b3fff57d5cefb,cb822c9d6f4b4e3f4f8ddc464d0b3fff57d5cefb,Update README.md
grinich,2014-01-29 23:44:38,https://api.github.com/repos/nylas/sync-engine/git/commits/75c8448a2175b0971903588cbb466ceda5c896b8,75c8448a2175b0971903588cbb466ceda5c896b8,Update README.md
grinich,2014-01-28 23:45:30,https://api.github.com/repos/nylas/sync-engine/git/commits/40d2d2eb3ad79062d16060da8916b271f117520d,40d2d2eb3ad79062d16060da8916b271f117520d,cruft
grinich,2014-01-28 23:45:19,https://api.github.com/repos/nylas/sync-engine/git/commits/1ece8a3b0e74220d0fd57aedaf689728bf34c957,1ece8a3b0e74220d0fd57aedaf689728bf34c957,location for storing mail non-s3
grinich,2014-01-28 23:44:01,https://api.github.com/repos/nylas/sync-engine/git/commits/db155f12f6b8061e1ccd6a057faa34ff4aaf9539,db155f12f6b8061e1ccd6a057faa34ff4aaf9539,add NodeJS and script example
grinich,2014-01-28 23:42:24,https://api.github.com/repos/nylas/sync-engine/git/commits/a5c1e1b90d253cd468b062887a092aa1dcfb7317,a5c1e1b90d253cd468b062887a092aa1dcfb7317,update setup info and log/store in local directories
grinich,2014-01-27 19:55:24,https://api.github.com/repos/nylas/sync-engine/git/commits/76699da775f0acb8781bf8f13f7aba1b1f714c69,76699da775f0acb8781bf8f13f7aba1b1f714c69,remove old git repos tha tare not used
kav-ya,2014-01-26 23:09:31,https://api.github.com/repos/nylas/sync-engine/git/commits/e206cae1662d477e225ece1b925617230274253f,e206cae1662d477e225ece1b925617230274253f,Examples dir
kav-ya,2014-01-26 20:58:34,https://api.github.com/repos/nylas/sync-engine/git/commits/22e39af290b01c3095c78bb9e417fe480de45771,22e39af290b01c3095c78bb9e417fe480de45771,CR changes
kav-ya,2014-01-26 00:38:00,https://api.github.com/repos/nylas/sync-engine/git/commits/fb35080261f0e8d73481284e5631ba2dccf043ad,fb35080261f0e8d73481284e5631ba2dccf043ad,"ML, headers API + testing framework"
kav-ya,2014-01-25 19:56:32,https://api.github.com/repos/nylas/sync-engine/git/commits/b762d2fba7ca2cb8c40ffd525ba57ce9ff92f3b5,b762d2fba7ca2cb8c40ffd525ba57ce9ff92f3b5,Removed message.namespace for all API fns
kav-ya,2014-01-25 05:50:07,https://api.github.com/repos/nylas/sync-engine/git/commits/946b68e617156d90f5742d02c57f35f4e19b33fa,946b68e617156d90f5742d02c57f35f4e19b33fa,Tests for mailing list API + header API pass
kav-ya,2014-01-24 21:11:44,https://api.github.com/repos/nylas/sync-engine/git/commits/445697748c80501d350435ee2485f604d33db0ec,445697748c80501d350435ee2485f604d33db0ec,Post CR changes
kav-ya,2014-01-23 17:56:31,https://api.github.com/repos/nylas/sync-engine/git/commits/9fa4bf7f83bb402fc94bd545219edb7c68b6e1b7,9fa4bf7f83bb402fc94bd545219edb7c68b6e1b7,"Fix typo in ./inbox, other cleanup.

Fix typo in ./inbox

Cleanup"
kav-ya,2014-01-22 22:08:59,https://api.github.com/repos/nylas/sync-engine/git/commits/ab526c5bf267f15c9ffb71596e68bf7b7bc781bb,ab526c5bf267f15c9ffb71596e68bf7b7bc781bb,"API Testing v2: test DB set-up.
Convert to using a testDB, populated with data dump

Test db under test user created successfully

Yaayay testdb set-up, ready for API tests"
kav-ya,2014-01-20 12:18:20,https://api.github.com/repos/nylas/sync-engine/git/commits/2a9a3b2e726cc4cfa0dbb1353dd5c2d30a5e26cc,2a9a3b2e726cc4cfa0dbb1353dd5c2d30a5e26cc,"API Testing v1

Started tests

test_api is broken"
kav-ya,2014-01-20 03:39:24,https://api.github.com/repos/nylas/sync-engine/git/commits/1d1355cb67437a1c0e709ca8cb2bbfa8745f062e,1d1355cb67437a1c0e709ca8cb2bbfa8745f062e,Pre-test headers api
spang,2014-01-24 21:00:59,https://api.github.com/repos/nylas/sync-engine/git/commits/441c5d656f0f1c025d20f75c023a8631597803c2,441c5d656f0f1c025d20f75c023a8631597803c2,Fix a typo
spang,2014-01-20 16:47:14,https://api.github.com/repos/nylas/sync-engine/git/commits/715e3cf32923c8d961b1e8f8fb3d1d9482be6ecd,715e3cf32923c8d961b1e8f8fb3d1d9482be6ecd,Tweak out-of-date bits in README.md
grinich,2014-01-23 21:36:40,https://api.github.com/repos/nylas/sync-engine/git/commits/8d6469002a9d55959248e8281ce6c8cf9bb138f9,8d6469002a9d55959248e8281ce6c8cf9bb138f9,More info
kav-ya,2014-01-23 17:56:31,https://api.github.com/repos/nylas/sync-engine/git/commits/1f317ec3a89d58a79ec06446b75df9b9cd620e11,1f317ec3a89d58a79ec06446b75df9b9cd620e11,Fix typo in ./inbox
kav-ya,2014-01-22 19:53:14,https://api.github.com/repos/nylas/sync-engine/git/commits/6b493054c7ee33adea5a7b80b9fcc2e7f81f7332,6b493054c7ee33adea5a7b80b9fcc2e7f81f7332,Always init_db() (idempotent)
kav-ya,2014-01-22 15:54:35,https://api.github.com/repos/nylas/sync-engine/git/commits/bed973ecd1835ae4d87cfd3f415b1fed375744f1,bed973ecd1835ae4d87cfd3f415b1fed375744f1,Make auth handle no db tables (since server hasnt started) case
kav-ya,2014-01-21 16:48:13,https://api.github.com/repos/nylas/sync-engine/git/commits/07ee55cc075e46a707d10a4d1e192c5b55f31223,07ee55cc075e46a707d10a4d1e192c5b55f31223,"auth, add: email_addr->required args"
spang,2014-01-20 18:06:31,https://api.github.com/repos/nylas/sync-engine/git/commits/03526ac13c1779a9b7a59745cc8d6cfd72d195d9,03526ac13c1779a9b7a59745cc8d6cfd72d195d9,Make auth() properly handle the case where we've already authed the account
spang,2014-01-20 18:06:08,https://api.github.com/repos/nylas/sync-engine/git/commits/80617ebad8d3331821cb8e6c453a7f376b9d2d76,80617ebad8d3331821cb8e6c453a7f376b9d2d76,Fix typo
spang,2014-01-20 17:30:08,https://api.github.com/repos/nylas/sync-engine/git/commits/5bb42c58e18eb874c8746ef937e377aa8b6e1bd1,5bb42c58e18eb874c8746ef937e377aa8b6e1bd1,Remove commented imports.
spang,2014-01-20 17:52:45,https://api.github.com/repos/nylas/sync-engine/git/commits/b69e5d1d715df3a35ef870aaaa88aaa0d5edf737,b69e5d1d715df3a35ef870aaaa88aaa0d5edf737,Fix some minor bugs in SyncService.
spang,2014-01-20 17:33:41,https://api.github.com/repos/nylas/sync-engine/git/commits/3a01e8f68ba49bf087bf643f1034071b16725d77,3a01e8f68ba49bf087bf643f1034071b16725d77,"Clean up ./inbox.

Here are the changes:
* Don't explicitly check for --email-address argument; we can make it a
  required argument and then argparse will spit out the right help
  message automatically.
* I want the auth command to also create a new account in the database
  for testing purposes.
* So far we've been naming all functions in this file directly after the
  subcommand, so let's continue doing that with add.
* Adapt for changes to oauth.py."
spang,2014-01-20 17:31:34,https://api.github.com/repos/nylas/sync-engine/git/commits/622ca2dbc6396ee5cf248b6c8e6efe0b5b72bdfa,622ca2dbc6396ee5cf248b6c8e6efe0b5b72bdfa,"Clean up APIs in oauth.py

Let's bubble up exceptions instead of catching them and returning None
(what is this, C? :). This will make us properly implement retries and
exception-handling."
spang,2014-01-20 16:58:53,https://api.github.com/repos/nylas/sync-engine/git/commits/72cc9db43ae7a64bcf3c070e4967d62999f436df,72cc9db43ae7a64bcf3c070e4967d62999f436df,"Clean up some parts of ./inbox, fix sync launcher bug"
spang,2014-01-20 16:52:30,https://api.github.com/repos/nylas/sync-engine/git/commits/f118ce5b9ecf2051f988d5da613143edc381edd7,f118ce5b9ecf2051f988d5da613143edc381edd7,fix ./inbox sync description
kav-ya,2014-01-20 13:46:44,https://api.github.com/repos/nylas/sync-engine/git/commits/4b82822e6e3a1932b754fd1c98b6091e672756dd,4b82822e6e3a1932b754fd1c98b6091e672756dd,"All CR changes for OAuth, tested."
kav-ya,2014-01-20 12:56:49,https://api.github.com/repos/nylas/sync-engine/git/commits/b277c685cc7136bbe6bbde6846a67b4370143e5d,b277c685cc7136bbe6bbde6846a67b4370143e5d,google_oauth.py deleted too
kav-ya,2014-01-20 12:55:51,https://api.github.com/repos/nylas/sync-engine/git/commits/dd54716d28953f125da43b5db1583b63400aa325,dd54716d28953f125da43b5db1583b63400aa325,CR changes
spang,2014-01-19 16:53:20,https://api.github.com/repos/nylas/sync-engine/git/commits/1db5e1099db186ca085442c3a7666ee6a0a66944,1db5e1099db186ca085442c3a7666ee6a0a66944,"Add arc configuration

Test Plan: none

Reviewers: kav-ya

Differential Revision: http://review.inboxapp.com/D1"
grinich,2014-01-19 09:49:41,https://api.github.com/repos/nylas/sync-engine/git/commits/a9236936457e6ad47d182a3c5445610c6ab073e1,a9236936457e6ad47d182a3c5445610c6ab073e1,Much simpler Vagrantfile for development in VirtualBox
grinich,2014-01-19 09:16:46,https://api.github.com/repos/nylas/sync-engine/git/commits/93d1d30401343362212ef1a425776ba27f779f45,93d1d30401343362212ef1a425776ba27f779f45,ignore silly mac files
grinich,2014-01-19 09:16:30,https://api.github.com/repos/nylas/sync-engine/git/commits/75e6645b2f20c6004f956032cb5e208aef5efa46,75e6645b2f20c6004f956032cb5e208aef5efa46,move image creation system to inboxapp/darkroom
grinich,2014-01-19 06:45:34,https://api.github.com/repos/nylas/sync-engine/git/commits/45a11d53337685fe356884b90aa413018a560558,45a11d53337685fe356884b90aa413018a560558,mysql
grinich,2014-01-19 06:33:14,https://api.github.com/repos/nylas/sync-engine/git/commits/4424e042651d4a02cdfccb782859e18f6c4b7864,4424e042651d4a02cdfccb782859e18f6c4b7864,logging line
grinich,2014-01-19 06:30:56,https://api.github.com/repos/nylas/sync-engine/git/commits/218ccf44897e9e9e0a64fd76e8cd7b5d035583a2,218ccf44897e9e9e0a64fd76e8cd7b5d035583a2,setproctitle version
grinich,2014-01-19 06:01:41,https://api.github.com/repos/nylas/sync-engine/git/commits/271b51dc37e793d39515a9b2d9d0e24c18f923e5,271b51dc37e793d39515a9b2d9d0e24c18f923e5,try this pip install
grinich,2014-01-19 05:35:33,https://api.github.com/repos/nylas/sync-engine/git/commits/36fcd58cf1f8b86b3f16a96daf81f254579d108b,36fcd58cf1f8b86b3f16a96daf81f254579d108b,no sudo
grinich,2014-01-19 05:14:57,https://api.github.com/repos/nylas/sync-engine/git/commits/37360eec28ae5d76498a5e7c9716f31402ade404,37360eec28ae5d76498a5e7c9716f31402ade404,trying to fix build snafu
kav-ya,2014-01-19 04:56:34,https://api.github.com/repos/nylas/sync-engine/git/commits/b9382404e37792c6199f1fbba0348f94b556d058,b9382404e37792c6199f1fbba0348f94b556d058,Update README.md
kav-ya,2014-01-19 04:56:03,https://api.github.com/repos/nylas/sync-engine/git/commits/951798d12922b3b2ba5bc09695dbbc0fe20a8037,951798d12922b3b2ba5bc09695dbbc0fe20a8037,"Update README.md

To include the `vagrant reload` command in case the shared folder hasn't synced."
kav-ya,2014-01-19 04:48:44,https://api.github.com/repos/nylas/sync-engine/git/commits/02cd5bf4324cedc9098334127a54ce2484445bf2,02cd5bf4324cedc9098334127a54ce2484445bf2,setup.sh updated
kav-ya,2014-01-19 04:44:26,https://api.github.com/repos/nylas/sync-engine/git/commits/ced24d06ee6d31aee914335d453a9e5880bf2126,ced24d06ee6d31aee914335d453a9e5880bf2126,Basic mailing list headers support
kav-ya,2014-01-19 00:29:15,https://api.github.com/repos/nylas/sync-engine/git/commits/2de7e1e9e8e9266bf6278082d37db916ab867620,2de7e1e9e8e9266bf6278082d37db916ab867620,OAuth creds added to config-sample
kav-ya,2014-01-19 00:26:00,https://api.github.com/repos/nylas/sync-engine/git/commits/d867eb15ce5a6376558d7330a460a59f4887d283,d867eb15ce5a6376558d7330a460a59f4887d283,CLI to add accounts using OAuth
kav-ya,2014-01-18 23:41:29,https://api.github.com/repos/nylas/sync-engine/git/commits/aaea2088399c1c75432a173e2dc029240c32d94b,aaea2088399c1c75432a173e2dc029240c32d94b,mailing list headers
grinich,2014-01-18 08:04:51,https://api.github.com/repos/nylas/sync-engine/git/commits/767fad3373bc14be8b95059ab42f052730c11456,767fad3373bc14be8b95059ab42f052730c11456,script directory
grinich,2014-01-18 08:00:03,https://api.github.com/repos/nylas/sync-engine/git/commits/b9f9df82492aab57e15f5b6119169294156c152d,b9f9df82492aab57e15f5b6119169294156c152d,First try at building images using Packer
grinich,2014-01-18 08:04:51,https://api.github.com/repos/nylas/sync-engine/git/commits/234aecf206c03beca33a53db27a401d5a50b0c68,234aecf206c03beca33a53db27a401d5a50b0c68,script directory
grinich,2014-01-18 08:00:03,https://api.github.com/repos/nylas/sync-engine/git/commits/227e34a09d6645d2b880c6175e76f5badcdb7778,227e34a09d6645d2b880c6175e76f5badcdb7778,First try at building images using Packer
spang,2014-01-17 17:32:32,https://api.github.com/repos/nylas/sync-engine/git/commits/5613d55d422eff3e6dc12aadd453b83387d33059,5613d55d422eff3e6dc12aadd453b83387d33059,"Fix zerorpc launcher script.

Now that we don't run a web frontend, the parent greenlet was exiting
without waiting for the children to run."
grinich,2014-01-15 22:19:53,https://api.github.com/repos/nylas/sync-engine/git/commits/90e91e071d0bf8ec17a656e8b0041a561fe91077,90e91e071d0bf8ec17a656e8b0041a561fe91077,remove jslint config
spang,2014-01-15 18:33:18,https://api.github.com/repos/nylas/sync-engine/git/commits/acb93b3207d5077108f541fe0a6bbcd0e3506d58,acb93b3207d5077108f541fe0a6bbcd0e3506d58,"Migrate server code from old repo.

This is the new home of all the Inbox server-side API services: mail
sync, search, API, etc. This core code is the base of the Inbox mail
framework. The AngularJS web client and associated websockets
integration now live in their own repository."
spang,2014-01-15 18:18:17,https://api.github.com/repos/nylas/sync-engine/git/commits/b1ed8502b7a276087cc1d1988895ee6427350085,b1ed8502b7a276087cc1d1988895ee6427350085,Initial commit
grinich,2014-01-15 15:12:26,https://api.github.com/repos/nylas/sync-engine/git/commits/c02a268b310d42e77572aebe25a305d718895c92,c02a268b310d42e77572aebe25a305d718895c92,also remove npm package listing
grinich,2014-01-15 15:06:44,https://api.github.com/repos/nylas/sync-engine/git/commits/b793fa1d580bad92327229e7f2f9ac8b9d497a0b,b793fa1d580bad92327229e7f2f9ac8b9d497a0b,Remove old img gallery template
grinich,2014-01-15 15:04:50,https://api.github.com/repos/nylas/sync-engine/git/commits/8847677bae1b6f87515ef2c7a314156321e51f8b,8847677bae1b6f87515ef2c7a314156321e51f8b,"Moving the AngularJS web client to it's own repo. They just grow up so fast. :'-)

This is gearing up for the open source release. We still need to remove
more stuff, including the websocket RPC stuff.

Ideally, we should also slim the flask app to only handle oAuth, but be
easily extendable."
grinich,2014-01-15 04:14:00,https://api.github.com/repos/nylas/sync-engine/git/commits/80181bf6883b89294179b7ee8de871a9e426457b,80181bf6883b89294179b7ee8de871a9e426457b,"hacky scrolling notifications. this doesnt actually work yet, but committing so we can split into two repos"
grinich,2014-01-15 03:03:43,https://api.github.com/repos/nylas/sync-engine/git/commits/648352e1bfe6a172bad6fbbbfe4efff841a6d074,648352e1bfe6a172bad6fbbbfe4efff841a6d074,fix gravatar size to match css
grinich,2014-01-15 02:57:13,https://api.github.com/repos/nylas/sync-engine/git/commits/d4f30eea6134dd5fa9cdcfaa042d8ca2c0965ef4,d4f30eea6134dd5fa9cdcfaa042d8ca2c0965ef4,more memory for VM
spang,2014-01-14 19:34:02,https://api.github.com/repos/nylas/sync-engine/git/commits/c70e1b42dbfb02c5bbeb84dc7fd6c31af9d47e22,c70e1b42dbfb02c5bbeb84dc7fd6c31af9d47e22,make config file support yes/no for bools
grinich,2014-01-14 19:25:30,https://api.github.com/repos/nylas/sync-engine/git/commits/19f075d6a54efc48bc145ed4c9b2ec50d3eefb04,19f075d6a54efc48bc145ed4c9b2ec50d3eefb04,setup script hack fixes
grinich,2014-01-03 02:26:02,https://api.github.com/repos/nylas/sync-engine/git/commits/a79cece42883dfb6eb653287f5c5b0373c842651,a79cece42883dfb6eb653287f5c5b0373c842651,this setup hack script is still shitty
grinich,2014-01-03 02:25:35,https://api.github.com/repos/nylas/sync-engine/git/commits/f1f82fdc4a4cf45d14af309e9c0e2ad8b01ae7f5,f1f82fdc4a4cf45d14af309e9c0e2ad8b01ae7f5,remove PIL and bump beautifulsoup version
grinich,2014-01-03 02:25:09,https://api.github.com/repos/nylas/sync-engine/git/commits/78750f09745de36a73143043d01544e7415ba367,78750f09745de36a73143043d01544e7415ba367,remove docker containers note
grinich,2013-12-16 23:15:43,https://api.github.com/repos/nylas/sync-engine/git/commits/c9ca19362c4446cd29d3e746d5e9bf5ca32dc873,c9ca19362c4446cd29d3e746d5e9bf5ca32dc873,update VirtualBox Guest Additions version
grinich,2013-12-16 23:15:06,https://api.github.com/repos/nylas/sync-engine/git/commits/084fd8bdceeb860fd9485e0b185a38ece6953f64,084fd8bdceeb860fd9485e0b185a38ece6953f64,bump docker version
spang,2013-12-23 05:37:41,https://api.github.com/repos/nylas/sync-engine/git/commits/823e2a0ebb4e797041d6f0ab40a5fdff9655f876,823e2a0ebb4e797041d6f0ab40a5fdff9655f876,"oops, don't commit my temp VM memory bump"
spang,2013-12-23 05:34:14,https://api.github.com/repos/nylas/sync-engine/git/commits/c0aa573f4db4e6f0e33ebf827245f9bf41f3797a,c0aa573f4db4e6f0e33ebf827245f9bf41f3797a,can has grammar
spang,2013-12-23 04:31:04,https://api.github.com/repos/nylas/sync-engine/git/commits/e133df7849454ffe263dced947143d3c9854a8b3,e133df7849454ffe263dced947143d3c9854a8b3,"Use RLock instead of BoundedSemaphore

Makes it obvious that it's reentrant and we're using it as a lock."
spang,2013-12-23 01:20:33,https://api.github.com/repos/nylas/sync-engine/git/commits/80f6eff722d214b89331a18248c7b90b9da70e19,80f6eff722d214b89331a18248c7b90b9da70e19,"Skip messages with decode errors.

We should fix these flanker bugs, but for now I just want to make sure
the mail sync is reliable."
spang,2013-12-23 00:58:13,https://api.github.com/repos/nylas/sync-engine/git/commits/34b5366c0997b64d60554b5afb14a2c222a982c4,34b5366c0997b64d60554b5afb14a2c222a982c4,Fix bad substitution.
spang,2013-12-23 00:36:29,https://api.github.com/repos/nylas/sync-engine/git/commits/0819cc8a7ce0bfe8e9586bd0574606e50aa24c10,0819cc8a7ce0bfe8e9586bd0574606e50aa24c10,Log flanker decode errors to disk.
spang,2013-12-23 00:35:28,https://api.github.com/repos/nylas/sync-engine/git/commits/ebf6887466b6154bde8a18dca6dc90ea2c438b97,ebf6887466b6154bde8a18dca6dc90ea2c438b97,Silly arg duplication.
spang,2013-12-22 18:09:49,https://api.github.com/repos/nylas/sync-engine/git/commits/ce748df941bf937c3ff0f3df16a1fcce301576d3,ce748df941bf937c3ff0f3df16a1fcce301576d3,Avoid gmail syncmanager startup race.
spang,2013-12-22 16:00:33,https://api.github.com/repos/nylas/sync-engine/git/commits/617a9756bcb5aebef78518449cca6b65f6bead2a,617a9756bcb5aebef78518449cca6b65f6bead2a,Fix bad creation of NULL revs.
spang,2013-12-22 15:59:59,https://api.github.com/repos/nylas/sync-engine/git/commits/5d5679e4001625c4d7c3105fe7731ebdf2ef7024,5d5679e4001625c4d7c3105fe7731ebdf2ef7024,defensive assertion
spang,2013-12-22 15:42:19,https://api.github.com/repos/nylas/sync-engine/git/commits/e1862c4dfe2df200db6e8fad8c148060ed054bd8,e1862c4dfe2df200db6e8fad8c148060ed054bd8,Fix typo in comment block.
spang,2013-12-22 03:12:09,https://api.github.com/repos/nylas/sync-engine/git/commits/3d8cecf08733523a40386e5077623e81299672e8,3d8cecf08733523a40386e5077623e81299672e8,"Store message parts locally by default.

Prep for open source release."
spang,2013-12-22 00:30:49,https://api.github.com/repos/nylas/sync-engine/git/commits/6bcef263b55732a88b3a290df852400693a9de91,6bcef263b55732a88b3a290df852400693a9de91,"Delete obsolete note about concurrency.

locking hurrrr"
spang,2013-12-21 23:05:49,https://api.github.com/repos/nylas/sync-engine/git/commits/0eab273acf1e41812aa55738ba387b023c60a523,0eab273acf1e41812aa55738ba387b023c60a523,"Fix buggy API sessions.

Now we're using a session per API call, which fixes the bug
where new messages wouldn't show up in the front-end."
spang,2013-12-21 22:59:52,https://api.github.com/repos/nylas/sync-engine/git/commits/70b219a295c244ffba94399003a2a039a41cf41c,70b219a295c244ffba94399003a2a039a41cf41c,cleanups
spang,2013-12-21 22:57:21,https://api.github.com/repos/nylas/sync-engine/git/commits/d47bb9ff00c70bc7e369d246e35925c2f963c89c,d47bb9ff00c70bc7e369d246e35925c2f963c89c,"Rip out TODO code.

Paring down to the core for the open source release.

TODOs will be reimplemented as an app on top of Inbox."
spang,2013-12-21 21:07:03,https://api.github.com/repos/nylas/sync-engine/git/commits/2eccf1b0d50607fb0b8cd487cbceaf30cbd38cd6,2eccf1b0d50607fb0b8cd487cbceaf30cbd38cd6,word wrap README.md
spang,2013-12-16 23:32:00,https://api.github.com/repos/nylas/sync-engine/git/commits/20afcedbf686ff848a6bf6aca48ded4ecfa3a468,20afcedbf686ff848a6bf6aca48ded4ecfa3a468,Split Gmail-specific methods into separate CrispinClient.
spang,2013-12-15 04:40:53,https://api.github.com/repos/nylas/sync-engine/git/commits/0ae89332bd99495d05775be274edea088b38fab0,0ae89332bd99495d05775be274edea088b38fab0,"Strip apart Gmail and generic IMAP code.

Gmail is different enough from generic IMAP that we need to give it its
own home for its code. Also, this lays the groundwork for additional
backends in the future."
theicfire,2013-12-19 01:15:15,https://api.github.com/repos/nylas/sync-engine/git/commits/052474af3635e998e90bd06a33a0972367d9cb42,052474af3635e998e90bd06a33a0972367d9cb42,Made webapp port a config variable
theicfire,2013-12-19 00:49:50,https://api.github.com/repos/nylas/sync-engine/git/commits/fc24ee5ec58c370d31cadbe26f9d2c20149e5133,fc24ee5ec58c370d31cadbe26f9d2c20149e5133,Fixing logging error at startup
tinkerer,2013-12-16 02:31:25,https://api.github.com/repos/nylas/sync-engine/git/commits/c1766b675cc90dcea86e5f9d6cae3d0ee212055a,c1766b675cc90dcea86e5f9d6cae3d0ee212055a,"updating Vagrant file to map directory, also style with Arial"
tinkerer,2013-12-16 02:31:14,https://api.github.com/repos/nylas/sync-engine/git/commits/fc523e72f0b868cf7ce5b7b7f22fa63450ee6f36,fc523e72f0b868cf7ce5b7b7f22fa63450ee6f36,Merge branch 'master' of https://github.com/inboxapp/inbox-server
grinich,2013-12-16 02:29:03,https://api.github.com/repos/nylas/sync-engine/git/commits/08e8fff46a4e6f627ebcfdd46576230badd0fa65,08e8fff46a4e6f627ebcfdd46576230badd0fa65,non-docker setup script2
grinich,2013-12-16 02:28:21,https://api.github.com/repos/nylas/sync-engine/git/commits/cbb004fd79753cb846d7f3687a11bde4a0369fb0,cbb004fd79753cb846d7f3687a11bde4a0369fb0,non-docker setup script
spang,2013-12-15 22:55:01,https://api.github.com/repos/nylas/sync-engine/git/commits/900afff8e04a01f84f16a4660b89f9f9e4af7ebc,900afff8e04a01f84f16a4660b89f9f9e4af7ebc,Fix _download_new_messages call.
spang,2013-12-15 22:54:46,https://api.github.com/repos/nylas/sync-engine/git/commits/34c051e8c547c48640f06a067e4decaf355fb454,34c051e8c547c48640f06a067e4decaf355fb454,Bump size of delta column.
spang,2013-12-15 22:39:44,https://api.github.com/repos/nylas/sync-engine/git/commits/2b2c7c82d49d2150788f6df6c8a0aa292d5ffef1,2b2c7c82d49d2150788f6df6c8a0aa292d5ffef1,Bump size of delta column.
spang,2013-12-15 21:52:22,https://api.github.com/repos/nylas/sync-engine/git/commits/0f24319e763787dc86d3e7d23421ec74b46e728b,0f24319e763787dc86d3e7d23421ec74b46e728b,fix console again
spang,2013-12-13 05:12:04,https://api.github.com/repos/nylas/sync-engine/git/commits/faab502b4724f71a0db62cfb29a274172f3b3c6d,faab502b4724f71a0db62cfb29a274172f3b3c6d,Fix log tests.
spang,2013-12-11 01:52:35,https://api.github.com/repos/nylas/sync-engine/git/commits/659083d95622ead8c6cd50b526291390811da5e1,659083d95622ead8c6cd50b526291390811da5e1,"Add session_scope and purge db usage from crispin again.

Now that we have various different sessions in various different places,
we need to avoid passing around session-attached SQLalchemy objects or
things get hairy."
spang,2013-12-10 21:32:30,https://api.github.com/repos/nylas/sync-engine/git/commits/98e42e02ae5c2a9af9475950cf979f66594ff84d,98e42e02ae5c2a9af9475950cf979f66594ff84d,Fix message template location.
spang,2013-12-10 00:35:09,https://api.github.com/repos/nylas/sync-engine/git/commits/ce7ba552c2804dea3c3e1b53b5b5318a7d106b3f,ce7ba552c2804dea3c3e1b53b5b5318a7d106b3f,Fix new session arg req in sync engine.
spang,2013-12-10 00:28:20,https://api.github.com/repos/nylas/sync-engine/git/commits/9b0d0df60b75fd8ca376366aedd7fb77a97a247a,9b0d0df60b75fd8ca376366aedd7fb77a97a247a,"Use json_util for JSON serialization in mysql.

Does stuff like makes datetimes serializeable, and is compatible with
Javascript."
spang,2013-12-09 03:43:21,https://api.github.com/repos/nylas/sync-engine/git/commits/ffdad757d67b557d5050394a40038e38f1deda5d,ffdad757d67b557d5050394a40038e38f1deda5d,Bugfixes.
spang,2013-12-09 03:28:17,https://api.github.com/repos/nylas/sync-engine/git/commits/134631fc95ba2d66c8a4002c5c76ab558288f007,134631fc95ba2d66c8a4002c5c76ab558288f007,"Rip out collections.

Stripping down to the core."
spang,2013-12-08 21:08:33,https://api.github.com/repos/nylas/sync-engine/git/commits/1831399882896a9631e7fb4d10c1a7e7f8cbd815,1831399882896a9631e7fb4d10c1a7e7f8cbd815,Split out Base and auto-generate table names.
spang,2013-12-05 20:20:32,https://api.github.com/repos/nylas/sync-engine/git/commits/3212dd816bb4d1a9fde764beae2cfe23e9db9dde,3212dd816bb4d1a9fde764beae2cfe23e9db9dde,Fix get_crispin_from_email
spang,2013-12-05 20:17:20,https://api.github.com/repos/nylas/sync-engine/git/commits/d0244e471982c6b00bd7fedf4ad6058a8eb897e8,d0244e471982c6b00bd7fedf4ad6058a8eb897e8,"Split models into submodules.

Getting unwieldy."
spang,2013-12-05 20:16:31,https://api.github.com/repos/nylas/sync-engine/git/commits/d23569bf67917b154b3c7eb84edca52f4ca447f9,d23569bf67917b154b3c7eb84edca52f4ca447f9,"Expand more threads at a time during sync.

Really not that much data."
spang,2013-12-05 20:15:14,https://api.github.com/repos/nylas/sync-engine/git/commits/b403a32ccfbaed32ab602aaac30f9b5ea75c7df7,b403a32ccfbaed32ab602aaac30f9b5ea75c7df7,Reduce pool size for console.
spang,2013-12-05 03:56:25,https://api.github.com/repos/nylas/sync-engine/git/commits/f8bc1f94df5848d701307e6f9716e8ab6411a241,f8bc1f94df5848d701307e6f9716e8ab6411a241,"Log transaction deltas.

Prep for implementing client-side syncing."
spang,2013-12-03 20:32:54,https://api.github.com/repos/nylas/sync-engine/git/commits/641a7e8019ee496259318d1b8f3769df44e1a7ab,641a7e8019ee496259318d1b8f3769df44e1a7ab,Try harder to make @retry work.
spang,2013-12-03 20:31:19,https://api.github.com/repos/nylas/sync-engine/git/commits/44b1b3ee9c95ea80226adb3f8aeb4ca21e86ac03,44b1b3ee9c95ea80226adb3f8aeb4ca21e86ac03,"Remove dead code.

Connection-handling has been pulled out of crispin completely."
spang,2013-12-02 23:19:03,https://api.github.com/repos/nylas/sync-engine/git/commits/6f9a85b4c5b1d2ad27ec4485723572a1c41141ef,6f9a85b4c5b1d2ad27ec4485723572a1c41141ef,"New crispin client per-FolderSyncMonitor.

Not sure how this slipped through---but since IMAP is stateful and
crispin caches IMAP info such as selectinfo, we need to create a new
instance per syncing folder, otherwise we get all sorts of race
conditions."
spang,2013-12-02 22:14:58,https://api.github.com/repos/nylas/sync-engine/git/commits/0caf19ff67a42dbe325e954003b49435a8d6bc07,0caf19ff67a42dbe325e954003b49435a8d6bc07,Fix message.
spang,2013-12-02 21:53:42,https://api.github.com/repos/nylas/sync-engine/git/commits/0622000573b737f8c4f676b3b2659fe728bff5d3,0622000573b737f8c4f676b3b2659fe728bff5d3,"Verify access token in connection pool.

Had to juggle some code around to prevent import loops."
spang,2013-12-02 20:57:56,https://api.github.com/repos/nylas/sync-engine/git/commits/ee1e13577b5de13d13c9f0687c0c24cead7867ea,ee1e13577b5de13d13c9f0687c0c24cead7867ea,s/sessionmanager/session/ # short and sweet
spang,2013-11-30 23:00:25,https://api.github.com/repos/nylas/sync-engine/git/commits/3dd5c7c3a6854e2be5ddff5138ea907085bed1e4,3dd5c7c3a6854e2be5ddff5138ea907085bed1e4,Clarify message
spang,2013-11-30 22:41:37,https://api.github.com/repos/nylas/sync-engine/git/commits/04a58f977b111bf02de70fd50da361575fb7b0c0,04a58f977b111bf02de70fd50da361575fb7b0c0,"Share connection pool but not crispin instance between folder monitors.

Since we do things like cache the selected folder name in crispin, we
can't actually share it between folder monitors without getting
state-induced race conditions. We do want to share the connection pool
between all crispin instances though, since otherwise we'd open up
n*pools connections."
spang,2013-11-30 22:02:31,https://api.github.com/repos/nylas/sync-engine/git/commits/d33291f978b5d94ccacf65440f66339c1978003d,d33291f978b5d94ccacf65440f66339c1978003d,Fix more None-type encoding errors.
spang,2013-11-30 22:02:19,https://api.github.com/repos/nylas/sync-engine/git/commits/32ae4e0d7de43ff95a685c9d0d17811b439c6011,32ae4e0d7de43ff95a685c9d0d17811b439c6011,"Move All Mail select call into _download_expanded_threads

Makes it easier to reason that everything that happens before that call is on self.folder_name."
spang,2013-11-30 21:29:06,https://api.github.com/repos/nylas/sync-engine/git/commits/e4a4b01d1193f599da41ff6324221d5606e95a2c,e4a4b01d1193f599da41ff6324221d5606e95a2c,Better logging
spang,2013-11-30 21:28:56,https://api.github.com/repos/nylas/sync-engine/git/commits/c49297f25fa657465937a92172590d7f119d7baf,c49297f25fa657465937a92172590d7f119d7baf,Pull uidvalidity update out.
spang,2013-11-30 20:42:25,https://api.github.com/repos/nylas/sync-engine/git/commits/4f2466fd5f865cbe4b45ac6fb3db1cf5fece5dc1,4f2466fd5f865cbe4b45ac6fb3db1cf5fece5dc1,"REALLY fix poll bug.

Need to save messages with correct UID."
spang,2013-11-30 06:16:53,https://api.github.com/repos/nylas/sync-engine/git/commits/1d1de2a48037b2f8f56c90faa7d3cfe26869b5d5,1d1de2a48037b2f8f56c90faa7d3cfe26869b5d5,"Fix highestmodseq update bug.

Le sigh... calling select_folder() in the middle of updates sure created a lot of bugs."
spang,2013-11-30 05:54:09,https://api.github.com/repos/nylas/sync-engine/git/commits/6c39dc22bbc9df505501e6a59fe42528e998d396,6c39dc22bbc9df505501e6a59fe42528e998d396,"Handle UIDInvalid in top-level state handler.

Cleans up the code a lot and allows a lot more flexibility for breaking
out more code into methods."
grinich,2013-11-30 07:25:33,https://api.github.com/repos/nylas/sync-engine/git/commits/280aa50564d6b06c6ad1c2c3a73432e14d154cac,280aa50564d6b06c6ad1c2c3a73432e14d154cac,update readme
grinich,2013-11-30 07:25:15,https://api.github.com/repos/nylas/sync-engine/git/commits/a0e2a04841885816cda1d2560b59852588cee1e4,a0e2a04841885816cda1d2560b59852588cee1e4,ignore node_modules
grinich,2013-11-30 07:22:30,https://api.github.com/repos/nylas/sync-engine/git/commits/b77e63d3b27b7b2569c62ef611a7e1caca01020d,b77e63d3b27b7b2569c62ef611a7e1caca01020d,"- fix search
- add browser path location for state
- add new DB abstraction layer (preliminary)"
grinich,2013-11-30 06:46:11,https://api.github.com/repos/nylas/sync-engine/git/commits/40d4e51ae864440ad805a3d96179a1ce5895efa7,40d4e51ae864440ad805a3d96179a1ce5895efa7,some logging
grinich,2013-11-30 06:45:48,https://api.github.com/repos/nylas/sync-engine/git/commits/4674872afe2f29713e37badfeaccc2309bbd6c41,4674872afe2f29713e37badfeaccc2309bbd6c41,Updated favicon
grinich,2013-11-30 02:09:00,https://api.github.com/repos/nylas/sync-engine/git/commits/4a950d4b934735b5bc0a39a702a42805444690d0,4a950d4b934735b5bc0a39a702a42805444690d0,cleanup
grinich,2013-11-29 22:21:50,https://api.github.com/repos/nylas/sync-engine/git/commits/647fd7672ba7eba28891b44ee7fd0e48917ce0a8,647fd7672ba7eba28891b44ee7fd0e48917ce0a8,remove some cruft
grinich,2013-11-29 22:20:32,https://api.github.com/repos/nylas/sync-engine/git/commits/155c1ba203f4d5f05960a320805623f4bec2ed63,155c1ba203f4d5f05960a320805623f4bec2ed63,clean task
grinich,2013-11-29 22:09:07,https://api.github.com/repos/nylas/sync-engine/git/commits/91c41ea9c9fdde0cf117ec61a4325428629d8cf0,91c41ea9c9fdde0cf117ec61a4325428629d8cf0,"Adding linter and a bunch of cleanups in the code.

Hooray for consistency!"
grinich,2013-11-28 23:05:36,https://api.github.com/repos/nylas/sync-engine/git/commits/602da5b3cf33218b7fa6d8814e2fe3a19c6515b0,602da5b3cf33218b7fa6d8814e2fe3a19c6515b0,add nodejs for grunt tasks
grinich,2013-11-28 23:04:38,https://api.github.com/repos/nylas/sync-engine/git/commits/4c2789bec894aa0fe53e7b65138e67aaf7125451,4c2789bec894aa0fe53e7b65138e67aaf7125451,remove boostrap and photobox cruft for now
spang,2013-11-30 05:23:43,https://api.github.com/repos/nylas/sync-engine/git/commits/4b07eeec7399938f6a9993b7e82e4b1dee82c82f,4b07eeec7399938f6a9993b7e82e4b1dee82c82f,ow
spang,2013-11-30 02:42:33,https://api.github.com/repos/nylas/sync-engine/git/commits/a21df5cad42b9a056f6985417823c8e7b5d138a9,a21df5cad42b9a056f6985417823c8e7b5d138a9,"Download expanded threads from the get-go.

We'll get a much better user experience on large folders this way."
spang,2013-11-30 00:31:54,https://api.github.com/repos/nylas/sync-engine/git/commits/0482434fde0e1adb835eb87aee93a0049e142c43,0482434fde0e1adb835eb87aee93a0049e142c43,Fix some bugs.
spang,2013-11-30 00:07:50,https://api.github.com/repos/nylas/sync-engine/git/commits/e86aff16ad2d6b5e5f93bccc80c7dc098728c7be,e86aff16ad2d6b5e5f93bccc80c7dc098728c7be,[SCHEMA] Add rev table.
spang,2013-11-29 20:43:39,https://api.github.com/repos/nylas/sync-engine/git/commits/080976e51898729827ac6f37082e2fce2335721c,080976e51898729827ac6f37082e2fce2335721c,Monkeypatch crispin so pool retries on imap conn errors.
spang,2013-11-29 06:11:56,https://api.github.com/repos/nylas/sync-engine/git/commits/3bd1a3257f7d17231df27e19735a02679878a99a,3bd1a3257f7d17231df27e19735a02679878a99a,Clean up deps.
spang,2013-11-29 06:06:02,https://api.github.com/repos/nylas/sync-engine/git/commits/7e26ae526c4a99b1c708db7cc1890b7e4c8cff38,7e26ae526c4a99b1c708db7cc1890b7e4c8cff38,housekeeping
spang,2013-11-29 06:03:25,https://api.github.com/repos/nylas/sync-engine/git/commits/d5f3d8a2506f5714bb21b3271f7ea809ba223f3e,d5f3d8a2506f5714bb21b3271f7ea809ba223f3e,Specify explicit exports in crispin.
spang,2013-11-29 06:03:14,https://api.github.com/repos/nylas/sync-engine/git/commits/372dbbd884bfffb7d7aab5eedc24963fca94c72d,372dbbd884bfffb7d7aab5eedc24963fca94c72d,Remove all migrations. They're out of date.
spang,2013-11-29 05:58:14,https://api.github.com/repos/nylas/sync-engine/git/commits/53c59692332c791e421e9981a10355141c90a3ca,53c59692332c791e421e9981a10355141c90a3ca,We use flanker now.
spang,2013-11-28 23:20:26,https://api.github.com/repos/nylas/sync-engine/git/commits/ec65493aa4058c277fc0528575364667eef2d0bc,ec65493aa4058c277fc0528575364667eef2d0bc,Pool IMAP connections.
grinich,2013-11-28 21:16:56,https://api.github.com/repos/nylas/sync-engine/git/commits/205501b581b7784e43d16509bc9f39f698de131a,205501b581b7784e43d16509bc9f39f698de131a,Update COPYING.md
grinich,2013-11-28 20:10:06,https://api.github.com/repos/nylas/sync-engine/git/commits/3dd2d262442e4014eae7e6e21f1a157dff645beb,3dd2d262442e4014eae7e6e21f1a157dff645beb,add keyboard events handler (wrapping mousetrap.js)
grinich,2013-11-28 20:06:45,https://api.github.com/repos/nylas/sync-engine/git/commits/5e7a2e81011fcd877bb722f3a235b83638b6a907,5e7a2e81011fcd877bb722f3a235b83638b6a907,bump flanker
spang,2013-11-28 02:57:11,https://api.github.com/repos/nylas/sync-engine/git/commits/295b6b482eec3bdabeca09f7edd96fc0c2cccd2d,295b6b482eec3bdabeca09f7edd96fc0c2cccd2d,Script to regen snippets / sanitized bodies.
spang,2013-11-28 02:34:37,https://api.github.com/repos/nylas/sync-engine/git/commits/b6fa31162ab6f7fa743de4c8e531fb1f631b5587,b6fa31162ab6f7fa743de4c8e531fb1f631b5587,Fix missing spaces in snippets.
spang,2013-11-28 02:26:32,https://api.github.com/repos/nylas/sync-engine/git/commits/bda5aac2576d59280525a44e3dd85d635ab412ae,bda5aac2576d59280525a44e3dd85d635ab412ae,Whoops
spang,2013-11-28 02:25:49,https://api.github.com/repos/nylas/sync-engine/git/commits/ede136c82c86166d1d3fdaea7193688c5ab91e8b,ede136c82c86166d1d3fdaea7193688c5ab91e8b,Flags fix.
spang,2013-11-28 01:53:51,https://api.github.com/repos/nylas/sync-engine/git/commits/f8045c7b2876d7e73f242c2c2bf3d5f9f0f86aa7,f8045c7b2876d7e73f242c2c2bf3d5f9f0f86aa7,Make snippets nicer.
spang,2013-11-28 00:41:12,https://api.github.com/repos/nylas/sync-engine/git/commits/743896b2025570cc8afd5ef73a5bde3adefd970f,743896b2025570cc8afd5ef73a5bde3adefd970f,Don't serialize drafts from Message.
spang,2013-11-28 00:36:32,https://api.github.com/repos/nylas/sync-engine/git/commits/e853a48f200add57301cff744b78d5ba58759795,e853a48f200add57301cff744b78d5ba58759795,"Fetch labels whenever we fetch flags.

Gmail needs it."
spang,2013-11-27 20:52:57,https://api.github.com/repos/nylas/sync-engine/git/commits/9207745f52f55559b841df4b3223b5697c679c18,9207745f52f55559b841df4b3223b5697c679c18,Fix console select call.
spang,2013-11-27 20:37:56,https://api.github.com/repos/nylas/sync-engine/git/commits/2f4064089328ec1d6e339e9407c2b5b2e189c7cc,2f4064089328ec1d6e339e9407c2b5b2e189c7cc,Strip quotes on email names before saving to database.
spang,2013-11-27 20:05:52,https://api.github.com/repos/nylas/sync-engine/git/commits/1ad1a6b63fb409c5da433a0af8178a976b8d3e85,1ad1a6b63fb409c5da433a0af8178a976b8d3e85,Some warnings.
spang,2013-11-27 20:00:26,https://api.github.com/repos/nylas/sync-engine/git/commits/c6a3307b54f698eb59187b1f1f9b5dd6e7d72e9d,c6a3307b54f698eb59187b1f1f9b5dd6e7d72e9d,"Pull uidvalidity check out into a select_folder callback.

This makes it way harder to forget to check uidvalidity after making a
select call. You'd have to consciously ignore the API."
spang,2013-11-27 19:26:05,https://api.github.com/repos/nylas/sync-engine/git/commits/39865f1f3765ae4089670a929dd1891a59d34f00,39865f1f3765ae4089670a929dd1891a59d34f00,Expand all threads after polling.
spang,2013-11-27 19:25:13,https://api.github.com/repos/nylas/sync-engine/git/commits/0193ddc7de954b718e5453aeafca861f315492c0,0193ddc7de954b718e5453aeafca861f315492c0,Really fix size-0 block bug.
spang,2013-11-26 04:47:33,https://api.github.com/repos/nylas/sync-engine/git/commits/9ad70ccd9280ba604da5c5fbd84f577850045157,9ad70ccd9280ba604da5c5fbd84f577850045157,Serialise is_draft on messages.
spang,2013-11-26 04:35:12,https://api.github.com/repos/nylas/sync-engine/git/commits/4d8d95274d63ae047def9162744b3d027e75a142,4d8d95274d63ae047def9162744b3d027e75a142,Sync draft status.
spang,2013-11-26 04:00:06,https://api.github.com/repos/nylas/sync-engine/git/commits/3cc562b06592b72e28b34bf9ff48a514cb40c92d,3cc562b06592b72e28b34bf9ff48a514cb40c92d,Don't intentionally crash after expanding threads. ;)
spang,2013-11-26 03:59:24,https://api.github.com/repos/nylas/sync-engine/git/commits/34faaf15f5f133fe3ca0c22614f9e191670c0351,34faaf15f5f133fe3ca0c22614f9e191670c0351,Naive plaintext quote-stripping.
spang,2013-11-25 01:34:40,https://api.github.com/repos/nylas/sync-engine/git/commits/855f8fbdeb95d9f0c72dfe93049e8d5b5161700c,855f8fbdeb95d9f0c72dfe93049e8d5b5161700c,Expand threads after rest of folder has been downloaded.
spang,2013-11-23 06:34:23,https://api.github.com/repos/nylas/sync-engine/git/commits/f4ebb3eb9e45e99aede519af0892859b5436a5e1,f4ebb3eb9e45e99aede519af0892859b5436a5e1,Fix bug where data_to_write is None.
spang,2013-11-23 06:05:34,https://api.github.com/repos/nylas/sync-engine/git/commits/e0bc9e8021c5df8fa642ae88e9e4e6e8e23ee1a5,e0bc9e8021c5df8fa642ae88e9e4e6e8e23ee1a5,"Don't totally break many messages.

Not sure what the deal was with extracting gmail_extra divs, but this
totally breaks display of some messages such as our thread with the
Ksplice mafia.

We now normalize line breaks before saving blocks, and try to be a bit
smarter about stripping out <br> tags."
spang,2013-11-23 05:59:19,https://api.github.com/repos/nylas/sync-engine/git/commits/74bb128703b884a00619b9bfa08318c5c0353d42,74bb128703b884a00619b9bfa08318c5c0353d42,"Wrap plaintext paragraphs in <p> instead of using <br/>.

This fixes our linewrapping problem."
spang,2013-11-23 05:57:48,https://api.github.com/repos/nylas/sync-engine/git/commits/6e568e54b7e63f86f66c073395821b23643bb16e,6e568e54b7e63f86f66c073395821b23643bb16e,"We depend on lxml now.

It's the fastest beautifulsoup parser backend."
spang,2013-11-22 02:49:08,https://api.github.com/repos/nylas/sync-engine/git/commits/9ee4eae88dd3854b448ce9049acc66fd720dea0a,9ee4eae88dd3854b448ce9049acc66fd720dea0a,Fix progress reporting on incremental sync.
spang,2013-11-22 00:29:59,https://api.github.com/repos/nylas/sync-engine/git/commits/4e89c97975c8f4d1df5c45b8d9ae98a3808b52be,4e89c97975c8f4d1df5c45b8d9ae98a3808b52be,remove some cruft
spang,2013-11-21 23:32:19,https://api.github.com/repos/nylas/sync-engine/git/commits/eaa88314c0d5e809a60c8766108847c4675ab77c,eaa88314c0d5e809a60c8766108847c4675ab77c,Deal with null from address.
spang,2013-11-21 22:46:44,https://api.github.com/repos/nylas/sync-engine/git/commits/fe0355dcf89ec34428d60965937343212b282b78,fe0355dcf89ec34428d60965937343212b282b78,Fix sync progress reporting when messages have been deleted.
spang,2013-11-21 22:23:26,https://api.github.com/repos/nylas/sync-engine/git/commits/3d10d559ae206a737cfc9469b7a44f9619b5c13d,3d10d559ae206a737cfc9469b7a44f9619b5c13d,Document tmux docker workaround.
spang,2013-11-21 21:16:32,https://api.github.com/repos/nylas/sync-engine/git/commits/fd969e129a8db7eba69c522ab3599bd744453126,fd969e129a8db7eba69c522ab3599bd744453126,"Add tmux to Dockerfile deps.

I want to be able to multiplex terminals in my container for dev
purposes. We'll probably want this for prod too anyway."
spang,2013-11-21 20:46:13,https://api.github.com/repos/nylas/sync-engine/git/commits/59a29a08711d40ea9debc6e4812b1212e7f12a31,59a29a08711d40ea9debc6e4812b1212e7f12a31,"Remove port-forwarding in Vagrantfile.

We don't need this since we're using a host-only network, and
forwarding privileged ports requires root."
spang,2013-11-21 03:07:56,https://api.github.com/repos/nylas/sync-engine/git/commits/9869001c370082d487ca52f8c0480452f2d388ac,9869001c370082d487ca52f8c0480452f2d388ac,Explicitly state nullable=True.
spang,2013-11-20 23:08:20,https://api.github.com/repos/nylas/sync-engine/git/commits/2ad8c380ff5882863e37c7e3d5d8dc901df836bf,2ad8c380ff5882863e37c7e3d5d8dc901df836bf,username and password are wrong in my.cnf now
spang,2013-11-20 23:08:07,https://api.github.com/repos/nylas/sync-engine/git/commits/a351761061833de0a55ca9023b83fa17d062e229,a351761061833de0a55ca9023b83fa17d062e229,explicitly set mysql collation as well
spang,2013-11-20 22:48:06,https://api.github.com/repos/nylas/sync-engine/git/commits/d1f95092519aff833d1dd7ab0eb508f96d0294dc,d1f95092519aff833d1dd7ab0eb508f96d0294dc,word wrap
spang,2013-11-20 04:53:53,https://api.github.com/repos/nylas/sync-engine/git/commits/ea0a74fb1c35bed5d41f886602a50f74e4eca956,ea0a74fb1c35bed5d41f886602a50f74e4eca956,Open logfiles as utf-8.
spang,2013-11-20 04:09:07,https://api.github.com/repos/nylas/sync-engine/git/commits/ffc35a73afad990076e7c691d91af4029dff6195,ffc35a73afad990076e7c691d91af4029dff6195,"Port message-parsing to flanker.

mailgun++!!"
grinich,2013-11-21 02:38:50,https://api.github.com/repos/nylas/sync-engine/git/commits/b9b5cb86353f869788917d9d557de41e4497ea40,b9b5cb86353f869788917d9d557de41e4497ea40,"First naive implementation of removing quoted text, just splitting on gmail_extra"
grinich,2013-11-21 02:38:05,https://api.github.com/repos/nylas/sync-engine/git/commits/9e1e5e1f9a36807cec6590eb2378326221cf5b57,9e1e5e1f9a36807cec6590eb2378326221cf5b57,searchbox style tweak and disable spelcheck
grinich,2013-11-21 01:24:41,https://api.github.com/repos/nylas/sync-engine/git/commits/e98ba63e8f77dc82b1bb6d0e2cbb07d09cdc5dee,e98ba63e8f77dc82b1bb6d0e2cbb07d09cdc5dee,splash page
grinich,2013-11-21 01:24:28,https://api.github.com/repos/nylas/sync-engine/git/commits/9546cc0685647f636566ba479a1cf6b841cd0f46,9546cc0685647f636566ba479a1cf6b841cd0f46,subject can be empty
grinich,2013-11-21 01:24:15,https://api.github.com/repos/nylas/sync-engine/git/commits/dc70cc488ee92865af22511a8fe485c2b9d8d985,dc70cc488ee92865af22511a8fe485c2b9d8d985,favicon route
grinich,2013-11-21 00:57:19,https://api.github.com/repos/nylas/sync-engine/git/commits/94e9948cab31daf35290634ca513115c4d829618,94e9948cab31daf35290634ca513115c4d829618,fix ports+url config for docker setup
grinich,2013-11-20 21:49:23,https://api.github.com/repos/nylas/sync-engine/git/commits/10c5e9c21cfa89b9fbdaa5a8a27899415064cd20,10c5e9c21cfa89b9fbdaa5a8a27899415064cd20,and remove typekit
grinich,2013-11-20 21:46:41,https://api.github.com/repos/nylas/sync-engine/git/commits/fa241f34706f50c13ad9679275af0a91937c7457,fa241f34706f50c13ad9679275af0a91937c7457,remove email address validation for now
grinich,2013-11-20 21:46:18,https://api.github.com/repos/nylas/sync-engine/git/commits/d7a973d7e46565e21f9a44405cce4ae0f01f989e,d7a973d7e46565e21f9a44405cce4ae0f01f989e,use /vagrant and not /code to share :P
grinich,2013-11-20 03:51:34,https://api.github.com/repos/nylas/sync-engine/git/commits/b63a7e31d18d280729cfe9009c58d7bc557e0450,b63a7e31d18d280729cfe9009c58d7bc557e0450,ignore vagrant folder
grinich,2013-11-20 03:51:02,https://api.github.com/repos/nylas/sync-engine/git/commits/3c98002e675354b67108b05e624c69804f43cd14,3c98002e675354b67108b05e624c69804f43cd14,Less hacky Dockerfile that no longer uses supervisor or nginx
grinich,2013-11-20 03:50:08,https://api.github.com/repos/nylas/sync-engine/git/commits/78e950d828ec60568b1000baf24a96e7e4e47a88,78e950d828ec60568b1000baf24a96e7e4e47a88,sensible default
grinich,2013-11-20 02:59:50,https://api.github.com/repos/nylas/sync-engine/git/commits/4c11063c6906d30559b48f2979a3cc8521fad434,4c11063c6906d30559b48f2979a3cc8521fad434,remove default database from my.cnf
grinich,2013-11-20 02:49:43,https://api.github.com/repos/nylas/sync-engine/git/commits/8cbc637d4de9de2181bf12533a5ad9fe7d9922c5,8cbc637d4de9de2181bf12533a5ad9fe7d9922c5,"Remove all submodules.
We don't need them to be editable in the repo anyway."
grinich,2013-11-20 02:46:22,https://api.github.com/repos/nylas/sync-engine/git/commits/dccb9dc1fee209a336dc33f093fe66f70e9344b9,dccb9dc1fee209a336dc33f093fe66f70e9344b9,fix static file serving in lieu of nginx
spang,2013-11-20 01:07:28,https://api.github.com/repos/nylas/sync-engine/git/commits/1a1a55baba0589a0b7291ab6c376f75d112bbaea,1a1a55baba0589a0b7291ab6c376f75d112bbaea,Fix front page error.
grinich,2013-11-19 22:44:22,https://api.github.com/repos/nylas/sync-engine/git/commits/0dc6a5a32ac3c178fbd418454c0621cbfe822fc7,0dc6a5a32ac3c178fbd418454c0621cbfe822fc7,listen on 0.0.0.0:5000 instead 127.0.0.1:5000
grinich,2013-11-19 22:43:48,https://api.github.com/repos/nylas/sync-engine/git/commits/a1c614b51181ad0fedc36040c974161e0e6f4eeb,a1c614b51181ad0fedc36040c974161e0e6f4eeb,more docker configs
grinich,2013-11-19 12:16:34,https://api.github.com/repos/nylas/sync-engine/git/commits/f355b9e9c7761374a4b0e3adf06fa197b22abc3c,f355b9e9c7761374a4b0e3adf06fa197b22abc3c,closer to docker
grinich,2013-11-19 08:46:32,https://api.github.com/repos/nylas/sync-engine/git/commits/9920a2c915cdd99302389781150d965ba13ce043,9920a2c915cdd99302389781150d965ba13ce043,still broken :(
spang,2013-11-19 05:28:17,https://api.github.com/repos/nylas/sync-engine/git/commits/e9bfd65710fa3cf9a8064b208d8472cf248f4417,e9bfd65710fa3cf9a8064b208d8472cf248f4417,Trigger search index update on message download.
spang,2013-11-19 04:50:59,https://api.github.com/repos/nylas/sync-engine/git/commits/bf22aef9fca3209ea62e64683389a666ac2a3a6b,bf22aef9fca3209ea62e64683389a666ac2a3a6b,Index sanitized body rather than reinventing the wheel.
spang,2013-11-19 02:00:53,https://api.github.com/repos/nylas/sync-engine/git/commits/f2498f3554ee37369eba51aded1815bd5cc7674c,f2498f3554ee37369eba51aded1815bd5cc7674c,s/meta_ids/message_ids/
spang,2013-11-18 21:29:19,https://api.github.com/repos/nylas/sync-engine/git/commits/c225798e7827ccff942deb8e28ed0a6ed63e4a0f,c225798e7827ccff942deb8e28ed0a6ed63e4a0f,Prep for open source release: add AGPLv3 license.
spang,2013-11-16 00:45:38,https://api.github.com/repos/nylas/sync-engine/git/commits/68a29f0468b555da1b88dbba15d6df0ae635a726,68a29f0468b555da1b88dbba15d6df0ae635a726,Clean up old contacts merge.
spang,2013-11-15 00:13:38,https://api.github.com/repos/nylas/sync-engine/git/commits/518f6f29b76bc83eace41fd67cd345c9b4b78a1e,518f6f29b76bc83eace41fd67cd345c9b4b78a1e,"Generate indexes for namespaces, not users."
spang,2013-11-14 18:58:29,https://api.github.com/repos/nylas/sync-engine/git/commits/6051b31ccc758c14896a21e01b831fb397105afd,6051b31ccc758c14896a21e01b831fb397105afd,[SCHEMA] Fix subject bug properly.
grinich,2013-11-16 00:19:16,https://api.github.com/repos/nylas/sync-engine/git/commits/e58033bb8ce045877f7061b5faf2178ac53b8235,e58033bb8ce045877f7061b5faf2178ac53b8235,update flanker
grinich,2013-11-15 20:44:58,https://api.github.com/repos/nylas/sync-engine/git/commits/787974b4d31456aaa69b71377d37c3567f2a6cef,787974b4d31456aaa69b71377d37c3567f2a6cef,Send button UI
grinich,2013-11-15 20:44:36,https://api.github.com/repos/nylas/sync-engine/git/commits/ab281776410838349f09c96e034e940ea74d69c8,ab281776410838349f09c96e034e940ea74d69c8,catch decoding errors when parsing HTML
spang,2013-11-14 18:43:08,https://api.github.com/repos/nylas/sync-engine/git/commits/25bf1b1e6aa9d0c95421a6cb31ac89fb9b2f134d,25bf1b1e6aa9d0c95421a6cb31ac89fb9b2f134d,Don't call re.sub on NULL subjects.
spang,2013-11-14 18:49:30,https://api.github.com/repos/nylas/sync-engine/git/commits/2e55c2fe263989e6b65a8c70855dfff78ea4c126,2e55c2fe263989e6b65a8c70855dfff78ea4c126,Don't trigger assert on empty strings.
spang,2013-11-14 18:47:09,https://api.github.com/repos/nylas/sync-engine/git/commits/abcac8699c7b7e323990ae5ed62af40dca701db4,abcac8699c7b7e323990ae5ed62af40dca701db4,Don't call plaintext2html on NULL parts.
grinich,2013-11-14 08:49:28,https://api.github.com/repos/nylas/sync-engine/git/commits/6ff0b0d616425a5f9e7c6e30b9cad3081c859cf4,6ff0b0d616425a5f9e7c6e30b9cad3081c859cf4,show snippet from most recent msg in side pane
spang,2013-11-14 05:37:06,https://api.github.com/repos/nylas/sync-engine/git/commits/096116db47c5800c23064ab14d4ae15d24363c42,096116db47c5800c23064ab14d4ae15d24363c42,Send works for reals.
spang,2013-11-14 02:23:11,https://api.github.com/repos/nylas/sync-engine/git/commits/f52c75d02adfab945bc5db838af619dd647dce5d,f52c75d02adfab945bc5db838af619dd647dce5d,Worse Is Better
spang,2013-11-14 02:14:13,https://api.github.com/repos/nylas/sync-engine/git/commits/ddb58acff435cdd8cb16ad5eef5443054cc6f1ab,ddb58acff435cdd8cb16ad5eef5443054cc6f1ab,Fall back on displaying email if no name.
spang,2013-11-14 02:07:09,https://api.github.com/repos/nylas/sync-engine/git/commits/878ccc9da2aa52435bcf67cd7def67836a340170,878ccc9da2aa52435bcf67cd7def67836a340170,"Don't switch to todo view after sending mail.

Not sure why it does that."
spang,2013-11-14 01:56:21,https://api.github.com/repos/nylas/sync-engine/git/commits/231029f7a6b1e7bb10b327d0aba289633f695105,231029f7a6b1e7bb10b327d0aba289633f695105,Mail send works again
grinich,2013-11-14 00:45:26,https://api.github.com/repos/nylas/sync-engine/git/commits/613a34691d53429b0e723138289ad36da6e25651,613a34691d53429b0e723138289ad36da6e25651,comment out attachment uploader for now
spang,2013-11-14 00:44:43,https://api.github.com/repos/nylas/sync-engine/git/commits/05216354c89b8a8c8a696501d71e74663598ec0f,05216354c89b8a8c8a696501d71e74663598ec0f,IT WORKS!
spang,2013-11-14 00:02:48,https://api.github.com/repos/nylas/sync-engine/git/commits/c812a0007d44b864c579fa8ec299008ed5dfa474,c812a0007d44b864c579fa8ec299008ed5dfa474,"Fix TODO creation.

I'm also backing out my change where I added namespace_id to
Thread. I think we should do this in the long run, but it's
too confusing a change while Message still tracks namespace_id.
(With both, we then have to update namespace_id on both the
thread _and_ the message when moving a thread to TODOs or
a shared folder.)"
spang,2013-11-13 22:52:00,https://api.github.com/repos/nylas/sync-engine/git/commits/4e9c4d8be514ec9d573e22f0ef78b80da15172fd,4e9c4d8be514ec9d573e22f0ef78b80da15172fd,Fix mark-as-TODO.
spang,2013-11-13 22:51:16,https://api.github.com/repos/nylas/sync-engine/git/commits/6b15c1205c6ef444de6f317f0cd6beab13cbf190,6b15c1205c6ef444de6f317f0cd6beab13cbf190,Remove no-longer-used imports in api.py.
spang,2013-11-13 22:50:43,https://api.github.com/repos/nylas/sync-engine/git/commits/a9ea4f3e9102764a7e00493de6d3eb098828c746,a9ea4f3e9102764a7e00493de6d3eb098828c746,"Limit threads returned by folder name.

D'oh."
spang,2013-11-13 18:03:21,https://api.github.com/repos/nylas/sync-engine/git/commits/325bdff385df0518f4834379219e0161fd4784ab,325bdff385df0518f4834379219e0161fd4784ab,Switch active namespace to TODO namespace when switching views.
spang,2013-11-13 17:42:32,https://api.github.com/repos/nylas/sync-engine/git/commits/b789ace15b83d4587b36645f2494823564cd755b,b789ace15b83d4587b36645f2494823564cd755b,"Trim whitespace when unwrapping subjects.

Otherwise we can get weird things like spaces in the middle of words."
spang,2013-11-13 17:36:30,https://api.github.com/repos/nylas/sync-engine/git/commits/262037f6e803177e36b17f56fd01a8330e3fecc3,262037f6e803177e36b17f56fd01a8330e3fecc3,"Web client requests threads, not messages.

Threads are the future!"
spang,2013-11-13 01:47:55,https://api.github.com/repos/nylas/sync-engine/git/commits/0cd333104b6383bcb46f81bee3b0558c0d28a61b,0cd333104b6383bcb46f81bee3b0558c0d28a61b,Fix flags some more.
spang,2013-11-13 01:44:21,https://api.github.com/repos/nylas/sync-engine/git/commits/0ad451a7189572d7e73a6e221fbc66461fb3e98f,0ad451a7189572d7e73a6e221fbc66461fb3e98f,Remove debug statement.
spang,2013-11-13 01:41:38,https://api.github.com/repos/nylas/sync-engine/git/commits/7815cb65ed30d3f3603b94972432861b0e558ce9,7815cb65ed30d3f3603b94972432861b0e558ce9,"Get new access token before syncing contacts.

Assumes success, but better than not trying."
spang,2013-11-13 01:32:24,https://api.github.com/repos/nylas/sync-engine/git/commits/65f3709f3033b590fd25fe5fcad38b6c1a629e79,65f3709f3033b590fd25fe5fcad38b6c1a629e79,Fix flags. (We were accidentally not syncing them!)
spang,2013-11-13 01:16:51,https://api.github.com/repos/nylas/sync-engine/git/commits/31b428579028044abe604acca7336cc928f7f073,31b428579028044abe604acca7336cc928f7f073,"Fix up to/from addresses in frontend.

We now transit them more sensibly as (name, email) pairs."
spang,2013-11-13 00:46:03,https://api.github.com/repos/nylas/sync-engine/git/commits/efc1f4567a1cde60d9cc9281629a78b64c921ac5,efc1f4567a1cde60d9cc9281629a78b64c921ac5,Make display/displayed consistent.
spang,2013-11-13 00:24:45,https://api.github.com/repos/nylas/sync-engine/git/commits/067c8f4116e0b85df671b68e40d93a7e29895c25,067c8f4116e0b85df671b68e40d93a7e29895c25,"Store db JSON columns as text, not binary.

Human readability is really important for debugging. This commit also
makes us stop requesting server-parsed message envelopes, since this
information is duplicated in the message body, and I *still* don't
understand what in tarnation the server parses email address into."
spang,2013-11-12 20:49:23,https://api.github.com/repos/nylas/sync-engine/git/commits/8a0a6db26c19cc07e057e64bcf6357ff7f76cbf4,8a0a6db26c19cc07e057e64bcf6357ff7f76cbf4,encoding.py: minor cleanups
spang,2013-11-12 20:09:33,https://api.github.com/repos/nylas/sync-engine/git/commits/0604f3cf728a254d4f13bf55c6937db01825b49f,0604f3cf728a254d4f13bf55c6937db01825b49f,Display message thread in Todo view.
grinich,2013-11-12 22:18:28,https://api.github.com/repos/nylas/sync-engine/git/commits/f9ca2b906473fada43b87ead41b8a034065c4119,f9ca2b906473fada43b87ead41b8a034065c4119,starting to fix replybox and add better uploading functionality
spang,2013-11-12 19:35:14,https://api.github.com/repos/nylas/sync-engine/git/commits/e6193a6c78f319d7d4c72c8ac445c03ef11b30e7,e6193a6c78f319d7d4c72c8ac445c03ef11b30e7,"Fix index.html formatting and remove extraneous divs.

go go matchit.vim :)"
spang,2013-11-12 18:55:53,https://api.github.com/repos/nylas/sync-engine/git/commits/7f9a01b4eb8262903bf4c4774cdad0cc1df8aeee,7f9a01b4eb8262903bf4c4774cdad0cc1df8aeee,Don't display TODO items in mail view.
spang,2013-11-12 18:09:21,https://api.github.com/repos/nylas/sync-engine/git/commits/31f1f94b4f27ed3710c4ae620d03829d23cfd604,31f1f94b4f27ed3710c4ae620d03829d23cfd604,Fix TODO item creation.
spang,2013-11-12 17:47:32,https://api.github.com/repos/nylas/sync-engine/git/commits/516fa703d916350a65fe009842c71e2d056f6656,516fa703d916350a65fe009842c71e2d056f6656,"Send message bodies by default with messages.

No more one query per message in a thread. ;)

We're also continuing on with the plan of keeping sanitized messages in
the database. Not sure how scalable it will be, but for now it sure
makes things faster!"
spang,2013-11-12 17:46:53,https://api.github.com/repos/nylas/sync-engine/git/commits/f03dbd2e91f5b6eb176f864b9503ea490d249191,f03dbd2e91f5b6eb176f864b9503ea490d249191,Reorganize imports.
spang,2013-11-12 17:11:37,https://api.github.com/repos/nylas/sync-engine/git/commits/911d99e8742e8152923c939cca33e5c4b2b84e33,911d99e8742e8152923c939cca33e5c4b2b84e33,s/IBMessageMeta/IBMessage/g # MessageMeta is dead
spang,2013-11-12 05:34:39,https://api.github.com/repos/nylas/sync-engine/git/commits/f6c18ee84cf1e7024aa5356ee44c59267118ab64,f6c18ee84cf1e7024aa5356ee44c59267118ab64,Split sanitized bodies on gmail_quote.
spang,2013-11-12 05:34:16,https://api.github.com/repos/nylas/sync-engine/git/commits/f6fd006109a7bdb49b78be228694144b24e83654,f6fd006109a7bdb49b78be228694144b24e83654,Fix UI message mismatching.
spang,2013-11-12 05:32:40,https://api.github.com/repos/nylas/sync-engine/git/commits/6cc523962199a8d9900c43c2b8bd239a0a71803a,6cc523962199a8d9900c43c2b8bd239a0a71803a,cleanups
spang,2013-11-12 05:31:59,https://api.github.com/repos/nylas/sync-engine/git/commits/43e1c20e273a0aaf682ce9014b0bb178b0228d9f,43e1c20e273a0aaf682ce9014b0bb178b0228d9f,Remove dead API function meta_with_id.O
spang,2013-11-12 02:48:15,https://api.github.com/repos/nylas/sync-engine/git/commits/ac4b77be4990081e735d7d03cca7d3b5a5c63c4b,ac4b77be4990081e735d7d03cca7d3b5a5c63c4b,"Implement snippets on the frontend.

omgsquee my first prod angular code!!!!"
spang,2013-11-11 23:26:43,https://api.github.com/repos/nylas/sync-engine/git/commits/c0cfdfed5a38602488bb63bc65b65c70abf8c7da,c0cfdfed5a38602488bb63bc65b65c70abf8c7da,[SCHEMA] Save sanitized messages to DB.
spang,2013-11-11 20:28:18,https://api.github.com/repos/nylas/sync-engine/git/commits/c01bc645500270f5368f53ab456b2385906eb0c6,c01bc645500270f5368f53ab456b2385906eb0c6,clear-db: Save user-associated namespaces and accounts.
spang,2013-11-11 20:24:04,https://api.github.com/repos/nylas/sync-engine/git/commits/8cc843c469737bbc92c7f378daf130e3984c71d2,8cc843c469737bbc92c7f378daf130e3984c71d2,[SCHEMA] Cascade deletes on account removal.
spang,2013-11-11 20:11:04,https://api.github.com/repos/nylas/sync-engine/git/commits/b6506d8355a6a3485b66b4b27ca78105622b740a,b6506d8355a6a3485b66b4b27ca78105622b740a,Message ingester now calculates snippets.
spang,2013-11-11 19:49:47,https://api.github.com/repos/nylas/sync-engine/git/commits/404e95a61134310c31b871d6985284e51fdc3c6e,404e95a61134310c31b871d6985284e51fdc3c6e,Abstract out logic for retrieving message bodies.
spang,2013-11-11 19:40:13,https://api.github.com/repos/nylas/sync-engine/git/commits/40b1d722b91605386185de90af60bed6110864c8,40b1d722b91605386185de90af60bed6110864c8,[SCHEMA] Add snippets to messages
spang,2013-11-11 19:39:53,https://api.github.com/repos/nylas/sync-engine/git/commits/704c719b731a9f369bb5c111ff09f68b884f53f7,704c719b731a9f369bb5c111ff09f68b884f53f7,cleanups
spang,2013-11-11 19:04:19,https://api.github.com/repos/nylas/sync-engine/git/commits/9b7cc081468f07af31ba91d80f818127ef6b421d,9b7cc081468f07af31ba91d80f818127ef6b421d,Kick off mail sync at account auth.
spang,2013-11-11 19:03:12,https://api.github.com/repos/nylas/sync-engine/git/commits/31251ed3a3848700075024858cd82a58cb934d65,31251ed3a3848700075024858cd82a58cb934d65,"Reorganize app.py imports.

Standard library imports go first. from imports are separated
from entire-module imports. Inbox-specific modules go last."
spang,2013-11-11 18:46:48,https://api.github.com/repos/nylas/sync-engine/git/commits/c532ed516cbaeab6a57feb524c3e264ceb9908e9,c532ed516cbaeab6a57feb524c3e264ceb9908e9,cleanup
grinich,2013-11-10 00:54:54,https://api.github.com/repos/nylas/sync-engine/git/commits/fb28a9cae71de532405adeedb0515e0a5eab764b,fb28a9cae71de532405adeedb0515e0a5eab764b,"[dependency] switch to fork of iconv. you need to `pip uninstall iconv` and
then run `pip install -r requirements.txt` again.
This fixes a bug in the decade-old wrapper for libiconv."
grinich,2013-11-10 00:10:55,https://api.github.com/repos/nylas/sync-engine/git/commits/f2187265ba891a61413b35ed85d7182d63beb109,f2187265ba891a61413b35ed85d7182d63beb109,fix sub-second precision bug
grinich,2013-11-09 05:05:11,https://api.github.com/repos/nylas/sync-engine/git/commits/c8953371698e3f755e28c56c49a62be697603630,c8953371698e3f755e28c56c49a62be697603630,Remove photobox.js and swap md5 for an angular-friendly version
grinich,2013-11-09 02:04:58,https://api.github.com/repos/nylas/sync-engine/git/commits/31da776687f98503da01b75d4329d1623ecefacd,31da776687f98503da01b75d4329d1623ecefacd,remove some angular crap
grinich,2013-11-08 23:17:40,https://api.github.com/repos/nylas/sync-engine/git/commits/dcc1792c09a86a7149c2c618d1537f6c92119467,dcc1792c09a86a7149c2c618d1537f6c92119467,Update to AngularJS 1.2.0 including sourcemaps for minified code
grinich,2013-11-08 23:11:52,https://api.github.com/repos/nylas/sync-engine/git/commits/99f421203e4e4b507e48a99ed76c602de06a7276,99f421203e4e4b507e48a99ed76c602de06a7276,dont cache to local disk because ec2 instances are wimpy
grinich,2013-11-05 02:08:36,https://api.github.com/repos/nylas/sync-engine/git/commits/95685d567a0221279887b4d196b0ec662daedac3,95685d567a0221279887b4d196b0ec662daedac3,remove mailgun email verification
spang,2013-11-07 03:51:54,https://api.github.com/repos/nylas/sync-engine/git/commits/00fc9ebb53d2d5d6b98f4aa2d15527533594ff56,00fc9ebb53d2d5d6b98f4aa2d15527533594ff56,"Serialize thread detection per-account.

This ought to fix the bug where we sometimes accidentally create
multiple Thread rows for the same thread. We also stop breaking threads
on subjects for now to match Gmail's behaviour. (If we're to do this,
we need to think about how we want to treat variations in e.g. ""Re:"" /
""RE:"", ""fwd"" etc. to make the experience great.)"
spang,2013-11-07 03:24:39,https://api.github.com/repos/nylas/sync-engine/git/commits/5b5b0427ee996512852c46944a33963310b0c408,5b5b0427ee996512852c46944a33963310b0c408,"Write down some thoughts about concurrency.

A precursor to fix this Thread deduplication bug: a lot of heavy
thinking."
spang,2013-11-07 03:24:13,https://api.github.com/repos/nylas/sync-engine/git/commits/29804cca4dfd1012c38af876d61ddb3b00c1d384,29804cca4dfd1012c38af876d61ddb3b00c1d384,A couple quick model tweaks.
spang,2013-11-07 03:09:10,https://api.github.com/repos/nylas/sync-engine/git/commits/6ad7cebf6ce2d99a57bcf826169eaa78ad88e7c7,6ad7cebf6ce2d99a57bcf826169eaa78ad88e7c7,"Factor out X-GM-MSGID dedupe code.

Turns out polling updates weren't doing this after all."
spang,2013-11-07 03:08:16,https://api.github.com/repos/nylas/sync-engine/git/commits/b0f0ed64ad01193019f50fbaf6760350273f5ae0,b0f0ed64ad01193019f50fbaf6760350273f5ae0,new_folderitem should be plural.
grinich,2013-11-08 06:09:07,https://api.github.com/repos/nylas/sync-engine/git/commits/be42be0eba51f189eba4480ada46fcc1f407e509,be42be0eba51f189eba4480ada46fcc1f407e509,remove boostrap.js
nylasbot,2013-11-06 05:19:40,https://api.github.com/repos/nylas/sync-engine/git/commits/956d4472f8b360e4c663089a6eadc63a813b9cc2,956d4472f8b360e4c663089a6eadc63a813b9cc2,update flanker with gitignore
spang,2013-11-07 17:52:12,https://api.github.com/repos/nylas/sync-engine/git/commits/646a30dcd5023772e3e0cd973f00c37c4f3bce69,646a30dcd5023772e3e0cd973f00c37c4f3bce69,Couple cleanups on rolodex model.
spang,2013-11-07 17:51:36,https://api.github.com/repos/nylas/sync-engine/git/commits/901f595eba5cb0939b7ecbb106a1486ce2f3934e,901f595eba5cb0939b7ecbb106a1486ce2f3934e,"Make rolodex use its own logger.

We now have account-specific rolodex.log. :)"
spang,2013-11-07 03:51:54,https://api.github.com/repos/nylas/sync-engine/git/commits/543d0812334ad0faac896769a2f2b9095152e6c9,543d0812334ad0faac896769a2f2b9095152e6c9,"Serialize thread detection per-account.

This ought to fix the bug where we sometimes accidentally create
multiple Thread rows for the same thread. We also stop breaking threads
on subjects for now to match Gmail's behaviour. (If we're to do this,
we need to think about how we want to treat variations in e.g. ""Re:"" /
""RE:"", ""fwd"" etc. to make the experience great.)"
spang,2013-11-07 03:24:39,https://api.github.com/repos/nylas/sync-engine/git/commits/030081e44486f2a3b34f63dc9a2c3e5623a1a403,030081e44486f2a3b34f63dc9a2c3e5623a1a403,"Write down some thoughts about concurrency.

A precursor to fix this Thread deduplication bug: a lot of heavy
thinking."
spang,2013-11-07 03:24:13,https://api.github.com/repos/nylas/sync-engine/git/commits/5e3c24d441d85f3eebdd27147d5360d4fc6e48e6,5e3c24d441d85f3eebdd27147d5360d4fc6e48e6,A couple quick model tweaks.
spang,2013-11-07 03:09:10,https://api.github.com/repos/nylas/sync-engine/git/commits/958aab812136b281177403d56417f42a6bf39328,958aab812136b281177403d56417f42a6bf39328,"Factor out X-GM-MSGID dedupe code.

Turns out polling updates weren't doing this after all."
spang,2013-11-07 03:08:16,https://api.github.com/repos/nylas/sync-engine/git/commits/923373f5a0670cc5eb653488b9a351c271f57016,923373f5a0670cc5eb653488b9a351c271f57016,new_folderitem should be plural.
sm-smalls,2013-11-07 22:59:27,https://api.github.com/repos/nylas/sync-engine/git/commits/7ea4c04ae8cb28eebc3b1c4fe70aeb1e181ca57c,7ea4c04ae8cb28eebc3b1c4fe70aeb1e181ca57c,"fullComposeView: appcontroller + directive js ... towards making the fullcompose work. The to field looks better by a mile, still work to do. Also need to fix the body moving problem when the to field expands"
sm-smalls,2013-11-07 22:57:42,https://api.github.com/repos/nylas/sync-engine/git/commits/e4380ce01bcb20714514d5d2016dcdee076a984c,e4380ce01bcb20714514d5d2016dcdee076a984c,fullComposeView: style.css and fullComposeView.html ... lot still to fix / clean up here
sm-smalls,2013-11-07 22:57:04,https://api.github.com/repos/nylas/sync-engine/git/commits/dfed4d49521d4d7cf1f29d6e78b52fe50742a6b9,dfed4d49521d4d7cf1f29d6e78b52fe50742a6b9,replyBox directive: small changes to make the styling more k + sendButtonHandler TODO
sm-smalls,2013-11-07 19:44:39,https://api.github.com/repos/nylas/sync-engine/git/commits/2ead29ff21339824df98cc48239ef77fcd367290,2ead29ff21339824df98cc48239ef77fcd367290,index.html adjustment for fullcompose. Includes new display var isMailMessageViewActive to separate the messagelist showing from the full message showing
sm-smalls,2013-11-07 19:43:09,https://api.github.com/repos/nylas/sync-engine/git/commits/0895c6bfff7e28c4c83a94aa483f412031619e19,0895c6bfff7e28c4c83a94aa483f412031619e19,style changes / typo bug fix on wng-click
sm-smalls,2013-11-07 19:42:11,https://api.github.com/repos/nylas/sync-engine/git/commits/76f98b62e1b8c93dbc7b9c8cd882c01241943b3f,76f98b62e1b8c93dbc7b9c8cd882c01241943b3f,layoutjs for the full composer
sm-smalls,2013-11-07 19:38:16,https://api.github.com/repos/nylas/sync-engine/git/commits/fbbb3983cd02762305b515843b3cd428055a1455,fbbb3983cd02762305b515843b3cd428055a1455,added git ignore statements (for emacs mostly)
grinich,2013-11-07 04:54:58,https://api.github.com/repos/nylas/sync-engine/git/commits/c2d24ae55e51caa96a3039dea9b7dfe25aaa633f,c2d24ae55e51caa96a3039dea9b7dfe25aaa633f,Upgrade to AngularJS v1.1.5
grinich,2013-11-07 04:54:22,https://api.github.com/repos/nylas/sync-engine/git/commits/3e736ae8eb9c4103e5080497c723368a174148ae,3e736ae8eb9c4103e5080497c723368a174148ae,remove angular-boostrap
spang,2013-11-06 03:32:20,https://api.github.com/repos/nylas/sync-engine/git/commits/9324b6a9d2b604fd221edc1a5517c0b5ac9ae200,9324b6a9d2b604fd221edc1a5517c0b5ac9ae200,Add tools/create-db.sql
spang,2013-11-06 03:27:35,https://api.github.com/repos/nylas/sync-engine/git/commits/7155a79af53b490b33ec4174c2573088d01ce6f1,7155a79af53b490b33ec4174c2573088d01ce6f1,add example my.cnf
spang,2013-11-06 03:12:28,https://api.github.com/repos/nylas/sync-engine/git/commits/7b8233ef9b319f922160699746abc6553db35e31,7b8233ef9b319f922160699746abc6553db35e31,"Fix utfmb4 errors.

la la la encodings la la la mysql is a toy

NOTE: You may need to recreate your database according to the directions
in README.md."
spang,2013-11-06 01:53:31,https://api.github.com/repos/nylas/sync-engine/git/commits/715232e9775e9b6fc10259fa5b481e63a2009066,715232e9775e9b6fc10259fa5b481e63a2009066,"Fix dict access bug.

We don't always have saved states for a folder."
spang,2013-11-06 01:38:56,https://api.github.com/repos/nylas/sync-engine/git/commits/d20df631e40e17846baff2712cc5667f475473af,d20df631e40e17846baff2712cc5667f475473af,"Revert ""use utf8mb4 for MySQL tables, which defaults to utf8mb4_general_ci""

This reverts commit a699daa26a5a5b384a94ab2ea5e7f854cd4e8192."
spang,2013-11-06 01:17:29,https://api.github.com/repos/nylas/sync-engine/git/commits/a5ffca96a124f4e31e2ef25df5bbbf514582d156,a5ffca96a124f4e31e2ef25df5bbbf514582d156,"Some optimizations to folder sync handling.

Skip even initializing a FolderSyncMonitor for folders in the 'finish'
state, and set the saved state before running the state handler."
spang,2013-11-06 00:45:40,https://api.github.com/repos/nylas/sync-engine/git/commits/22b1fe797afe4ead5afb05546e97bbdc6955b5b1,22b1fe797afe4ead5afb05546e97bbdc6955b5b1,g_email is dead
spang,2013-11-06 00:31:08,https://api.github.com/repos/nylas/sync-engine/git/commits/2c108876c8d7bbf93303b7cbf17c596fd7a100fc,2c108876c8d7bbf93303b7cbf17c596fd7a100fc,Fix a couple misc bugs.
spang,2013-11-06 00:30:46,https://api.github.com/repos/nylas/sync-engine/git/commits/71dd771278d73bb94346cb59db660dcc10547da5,71dd771278d73bb94346cb59db660dcc10547da5,Fix static folder after mg's setuptools reorg.
spang,2013-11-05 20:18:27,https://api.github.com/repos/nylas/sync-engine/git/commits/734e4c8f1be1441d1de7b333e2cc921079f4a335,734e4c8f1be1441d1de7b333e2cc921079f4a335,"Gmail: only poll on INBOX and All Mail.

Since Gmail's IMAP implementation includes all folders as a subset of
All Mail, if we poll on Gmail and All Mail we'll be sure to get all
messages. We don't technicall need to poll on INBOX, but doing so means
we update it faster, since All Mail may be large and MODSEQ searches on
large Gmail mailboxes is hella slow."
grinich,2013-11-05 21:10:07,https://api.github.com/repos/nylas/sync-engine/git/commits/14d6621cc9b1e30bf83b528350ee27726e039f30,14d6621cc9b1e30bf83b528350ee27726e039f30,updated readme
grinich,2013-11-05 20:42:02,https://api.github.com/repos/nylas/sync-engine/git/commits/2b8547016f30b97d7a83c758d426d545e2d01cd9,2b8547016f30b97d7a83c758d426d545e2d01cd9,ignore wand readme
grinich,2013-11-05 20:10:59,https://api.github.com/repos/nylas/sync-engine/git/commits/cac76a31a2817786e4cdca3bfb9bb8b87d829fb2,cac76a31a2817786e4cdca3bfb9bb8b87d829fb2,"This commit moves the server submodule so it can be installed by
pip and also adds MailGun's flanker submodule.

To install, now you can just do pip install -r requirements.txt
inside a virtualenv. This installs all of the dependencies, and
then installs both the dependent packages (submodules) and main
inbox-server package as editable modules. This means you can start a
shell and do `import inbox` and stuff will just work. I think this was
the goal we had for testing when we moved to setuptools, but this is way
easier for dependency installation.

You also still need to install the xapien bindings using the script
provided."
spang,2013-11-05 20:00:20,https://api.github.com/repos/nylas/sync-engine/git/commits/1980bc9c08a8bef3cdbd76e266dde35669c099dd,1980bc9c08a8bef3cdbd76e266dde35669c099dd,"all_mail_folder_name() is dead.

This method was deprecated by the addition of the more generic
'folder_names' property. To replace this call, do:

    crispin_client.folder_names['All']

instead."
spang,2013-11-05 19:26:17,https://api.github.com/repos/nylas/sync-engine/git/commits/b47baeb37ffa9199813fcfd4ff4ae56f98eea8be,b47baeb37ffa9199813fcfd4ff4ae56f98eea8be,Fix 'sync stop' command.
spang,2013-11-05 19:09:11,https://api.github.com/repos/nylas/sync-engine/git/commits/e613e174b8a8f35adeb68ce7b0f0d8e7d11b35fb,e613e174b8a8f35adeb68ce7b0f0d8e7d11b35fb,Remove excess whitespace.
spang,2013-11-05 19:02:39,https://api.github.com/repos/nylas/sync-engine/git/commits/9b561601ca37fc39fca7ae9607ed33682ce7fb6f,9b561601ca37fc39fca7ae9607ed33682ce7fb6f,Fix sync progress reporting.
spang,2013-11-05 18:52:49,https://api.github.com/repos/nylas/sync-engine/git/commits/75dc2fa27e8a326b3b96e33977daa37e0fe75d3d,75dc2fa27e8a326b3b96e33977daa37e0fe75d3d,Don't crash when trying to sync account that hasn't been authed yet.
spang,2013-11-05 18:14:55,https://api.github.com/repos/nylas/sync-engine/git/commits/65fccd7c22794446483ecad5567d0cfc9f515e18,65fccd7c22794446483ecad5567d0cfc9f515e18,Add ROLODEX_SERVER_LOC to config-sample.cfg.
spang,2013-11-05 18:04:25,https://api.github.com/repos/nylas/sync-engine/git/commits/3bf3d1ec14d2c122258993c5f4df64296772648c,3bf3d1ec14d2c122258993c5f4df64296772648c,"s/delete_messages/remove_messages/

Changed this name at some point."
grinich,2013-11-05 07:56:17,https://api.github.com/repos/nylas/sync-engine/git/commits/6496bbc126b422385901bb68f6cf095bb41018fb,6496bbc126b422385901bb68f6cf095bb41018fb,"use utf8mb4 for MySQL tables, which defaults to utf8mb4_general_ci
collation.

this is important because we don't want to mix collations"
grinich,2013-11-05 00:49:21,https://api.github.com/repos/nylas/sync-engine/git/commits/089a774d5c1aacf7b84d6b1ef281f798ed5c2b0c,089a774d5c1aacf7b84d6b1ef281f798ed5c2b0c,some todo cleanup
spang,2013-11-02 23:36:09,https://api.github.com/repos/nylas/sync-engine/git/commits/691dcedfffa8a4bd9ab14c2b4bf3c3fe407b8906,691dcedfffa8a4bd9ab14c2b4bf3c3fe407b8906,Fix error in mail sync state machine diagram.
spang,2013-11-02 23:28:52,https://api.github.com/repos/nylas/sync-engine/git/commits/c93051aec1f936f31352f6c089c96c403dacad35,c93051aec1f936f31352f6c089c96c403dacad35,Make frontend work again.
spang,2013-11-02 21:36:35,https://api.github.com/repos/nylas/sync-engine/git/commits/fa6a1e852427942301b5b094128ed7b9af1c68f5,fa6a1e852427942301b5b094128ed7b9af1c68f5,fix a bunch of bugs
spang,2013-11-02 18:29:45,https://api.github.com/repos/nylas/sync-engine/git/commits/e516201b5d46e2af52f55e1594e2eeb882b61fe5,e516201b5d46e2af52f55e1594e2eeb882b61fe5,canonicalize API
spang,2013-11-02 18:23:41,https://api.github.com/repos/nylas/sync-engine/git/commits/87940ede0e1877a5e0a49855f367c5c73f36b874,87940ede0e1877a5e0a49855f367c5c73f36b874,finish rewriting highestmodseq code
spang,2013-11-02 18:16:42,https://api.github.com/repos/nylas/sync-engine/git/commits/442dd378c0207d468f5fdaccdf9d30945626ec26,442dd378c0207d468f5fdaccdf9d30945626ec26,more refactoring
spang,2013-11-02 18:11:31,https://api.github.com/repos/nylas/sync-engine/git/commits/97304e3f7c10bb621d05168449e267d269297529,97304e3f7c10bb621d05168449e267d269297529,Make Message column nullability more specific.
spang,2013-11-02 18:07:51,https://api.github.com/repos/nylas/sync-engine/git/commits/1732801f8af856cf437083960bc30f6c537841fd,1732801f8af856cf437083960bc30f6c537841fd,more refactoring
spang,2013-11-01 19:30:45,https://api.github.com/repos/nylas/sync-engine/git/commits/38d31db8cfb28d7081711c0065d7c5ed8e7a3949,38d31db8cfb28d7081711c0065d7c5ed8e7a3949,name collisions
spang,2013-11-01 19:28:00,https://api.github.com/repos/nylas/sync-engine/git/commits/fff9110a2f27e3f8ea6fd48083343b0f2b892f08,fff9110a2f27e3f8ea6fd48083343b0f2b892f08,s/SyncMeta/FolderSync/g # foo-meta is dead
spang,2013-11-01 19:26:20,https://api.github.com/repos/nylas/sync-engine/git/commits/d7e9e522ea206078f7e980d721f84af6cc6b657a,d7e9e522ea206078f7e980d721f84af6cc6b657a,s/SharedFolderNSMeta/SharedFolder/g # less java
spang,2013-11-01 19:23:32,https://api.github.com/repos/nylas/sync-engine/git/commits/e15c3a2e473b4c24fd6d00bb0a5d3153b60c64e6,e15c3a2e473b4c24fd6d00bb0a5d3153b60c64e6,s/TodoNSMeta/TodoNamespace/ # less java
spang,2013-11-01 19:05:55,https://api.github.com/repos/nylas/sync-engine/git/commits/5b31cc13da2f01584a44398821acef3e1e459767,5b31cc13da2f01584a44398821acef3e1e459767,s/FolderMeta/FolderItem/g # better name
spang,2013-11-01 18:56:07,https://api.github.com/repos/nylas/sync-engine/git/commits/7139289945d267b67fad16f79922f04fa601aeb5,7139289945d267b67fad16f79922f04fa601aeb5,more sync rewrite
spang,2013-11-01 18:55:26,https://api.github.com/repos/nylas/sync-engine/git/commits/d74007e6481ad50774b7f1758c2a78ec7e56c932,d74007e6481ad50774b7f1758c2a78ec7e56c932,s/MessageMeta/Message/g # remove redundancy
spang,2013-11-01 18:48:03,https://api.github.com/repos/nylas/sync-engine/git/commits/012e0e7201e47c02863dbad5707259708a800afd,012e0e7201e47c02863dbad5707259708a800afd,s/BlockMeta/Block/g # remove redundancy
spang,2013-11-01 15:54:42,https://api.github.com/repos/nylas/sync-engine/git/commits/9de499c2c0e78010707097b675d4596ebe7a2562,9de499c2c0e78010707097b675d4596ebe7a2562,rewrote a lot of sync code. now just need to rewrite incremental update and test.
spang,2013-11-01 01:52:10,https://api.github.com/repos/nylas/sync-engine/git/commits/681ec4e4532d0ded18dbf4fe695e19129381f754,681ec4e4532d0ded18dbf4fe695e19129381f754,save state
spang,2013-10-31 23:15:22,https://api.github.com/repos/nylas/sync-engine/git/commits/8e79cfd093e2531a1985a86fc44cca3f047ea36a,8e79cfd093e2531a1985a86fc44cca3f047ea36a,[SCHEMA] Add thread objects.
spang,2013-10-31 21:57:26,https://api.github.com/repos/nylas/sync-engine/git/commits/8b5d39893550574963994b9e8acdcfb3ec392a1c,8b5d39893550574963994b9e8acdcfb3ec392a1c,"Sync all folders, not just Inbox and All Mail.

For Gmail, this really only means we prioritize syncing stuff from these
earlier ""folders"" first, since everything is in All Mail and we properly
create FolderMeta entries for labels when we go through that."
spang,2013-10-31 19:14:10,https://api.github.com/repos/nylas/sync-engine/git/commits/0806611ee81b3a0aaac9a5df972663702296b22b,0806611ee81b3a0aaac9a5df972663702296b22b,models: Add syncmeta table.
spang,2013-10-31 19:13:54,https://api.github.com/repos/nylas/sync-engine/git/commits/f91178649d2fcb7db98c61a59427a237720043c6,f91178649d2fcb7db98c61a59427a237720043c6,sync: Document how it will work post-refactor.
grinich,2013-11-01 00:30:30,https://api.github.com/repos/nylas/sync-engine/git/commits/31f0c782a4b16cb3ef91007c97aab57e7c926892,31f0c782a4b16cb3ef91007c97aab57e7c926892,remove cruft application.py
grinich,2013-11-01 00:24:41,https://api.github.com/repos/nylas/sync-engine/git/commits/2c584a611bbabc5433a772e23e784f5097d1066f,2c584a611bbabc5433a772e23e784f5097d1066f,"first integration of contacts sync from Google.
[NOTE] database changes"
spang,2013-11-01 00:21:42,https://api.github.com/repos/nylas/sync-engine/git/commits/331e222d1056f86a9f96debacb71026079acdf97,331e222d1056f86a9f96debacb71026079acdf97,"concurrency util functions are server-specific actually.

Also, this way they can use the server logging. I had accidentally
routed this log statement to /dev/null."
spang,2013-10-31 23:30:34,https://api.github.com/repos/nylas/sync-engine/git/commits/d09aa8194ecd2996ea617d62301476d5796bf93e,d09aa8194ecd2996ea617d62301476d5796bf93e,"Crispin doesn't use the root logger anymore.

All of its operations are user-specific, so they use an account-specific
logfile."
spang,2013-10-31 23:41:42,https://api.github.com/repos/nylas/sync-engine/git/commits/75f79269c64068fd6ee22d6eda17591b186ac49d,75f79269c64068fd6ee22d6eda17591b186ac49d,"crispin: Fix bad search-and-replace.

Sorry mg!"
grinich,2013-10-31 22:32:51,https://api.github.com/repos/nylas/sync-engine/git/commits/6e4f479adea0c0e6aa78e1184be64361850b1a11,6e4f479adea0c0e6aa78e1184be64361850b1a11,using imap OR command to fetch messages in given threads
spang,2013-10-31 04:17:40,https://api.github.com/repos/nylas/sync-engine/git/commits/cfb0c4626b3810e1855fe12a53de688cfe336fc8,cfb0c4626b3810e1855fe12a53de688cfe336fc8,"crispin: Move latin1 imapclient de-hack to raw fetch.

This allows up to make sure we're also caching the correct data."
spang,2013-10-31 04:06:32,https://api.github.com/repos/nylas/sync-engine/git/commits/b42b1df2358da5da39a629cc4c202e453784f76d,b42b1df2358da5da39a629cc4c202e453784f76d,Fix wrong comment.
spang,2013-10-31 03:57:01,https://api.github.com/repos/nylas/sync-engine/git/commits/025b3b7bfa142cc3203d434d5918a3e1154da636,025b3b7bfa142cc3203d434d5918a3e1154da636,LOL I'm not sure incremental update actually ever worked.
spang,2013-10-31 03:52:16,https://api.github.com/repos/nylas/sync-engine/git/commits/8b1a1962549bc96a0b926322cdcb002cad7b9ceb,8b1a1962549bc96a0b926322cdcb002cad7b9ceb,partition: put example in block comment.
spang,2013-10-31 03:41:38,https://api.github.com/repos/nylas/sync-engine/git/commits/9faa265132c8b3537baf49066a8144650adaeb4f,9faa265132c8b3537baf49066a8144650adaeb4f,crispin: Put base comment on base class.
spang,2013-10-31 03:37:00,https://api.github.com/repos/nylas/sync-engine/git/commits/8e5d3f951a95eec63a8780ed0f0cd2711b0ab9b4,8e5d3f951a95eec63a8780ed0f0cd2711b0ab9b4,"crispin: non-API functions should start with _.

So folks can tell that they're not supposed to call them."
spang,2013-10-31 02:48:35,https://api.github.com/repos/nylas/sync-engine/git/commits/91a769aee8812f558fbd73c5e4268a7b3988fdac,91a769aee8812f558fbd73c5e4268a7b3988fdac,Fix bugs: online sync runs again.
spang,2013-10-31 02:20:07,https://api.github.com/repos/nylas/sync-engine/git/commits/d3ee028ed5259e0cceea882d242cd8b86d2bb4b2,d3ee028ed5259e0cceea882d242cd8b86d2bb4b2,Fix enum column to actually be a column.
spang,2013-10-31 02:04:02,https://api.github.com/repos/nylas/sync-engine/git/commits/9d32dcab450a2c0c4f70c2e7544f8ef6f05dfa96,9d32dcab450a2c0c4f70c2e7544f8ef6f05dfa96,Port sync engine to new crispin API.
spang,2013-10-30 22:59:01,https://api.github.com/repos/nylas/sync-engine/git/commits/60cb8597a03bbcc15e5c0eebdab911ea73d80ee4,60cb8597a03bbcc15e5c0eebdab911ea73d80ee4,Crispin chooses IMAP hostname based on account provider.
spang,2013-10-30 22:58:44,https://api.github.com/repos/nylas/sync-engine/git/commits/0194d7031e42734f1ff594176a7329eb3bdbe0b3,0194d7031e42734f1ff594176a7329eb3bdbe0b3,Clean up crispin imports.
spang,2013-10-30 22:57:55,https://api.github.com/repos/nylas/sync-engine/git/commits/9fdd15452e677783b67f23452ef20da731ad56a4,9fdd15452e677783b67f23452ef20da731ad56a4,"Add LOGDIR to config-sample.cfg.

Forgot to do this before."
spang,2013-10-30 22:08:59,https://api.github.com/repos/nylas/sync-engine/git/commits/92dcf01f982fda748dad919609a5eed9f1748d56,92dcf01f982fda748dad919609a5eed9f1748d56,"Move model instantiation out of crispin.

Crispin doesn't want to know anything about the database."
spang,2013-10-30 21:51:43,https://api.github.com/repos/nylas/sync-engine/git/commits/4d49cc9319028422ced879a5fbdf539bf216af35,4d49cc9319028422ced879a5fbdf539bf216af35,"RawMessage is dead. Long live RawMessage.

After thinking more about the IMAP caching design, we can do it all on
disk and bypass any sort of database access, which makes things a lot
simpler."
spang,2013-10-30 21:48:59,https://api.github.com/repos/nylas/sync-engine/git/commits/dd454b7a8da4b440ede80fa80776c22bd4ad060d,dd454b7a8da4b440ede80fa80776c22bd4ad060d,"Rewrite crispin to support caching IMAP data.

To bypass the network connection, just use DummyCrispinClient.

This commit also makes the crispin API consistent."
spang,2013-10-29 20:24:11,https://api.github.com/repos/nylas/sync-engine/git/commits/ede14c7e7422bb1df239c27232730b7102cf6c80,ede14c7e7422bb1df239c27232730b7102cf6c80,Ignore dev log dir.
spang,2013-10-29 20:16:46,https://api.github.com/repos/nylas/sync-engine/git/commits/15ead9d4f650eb0b543c0d4d59ecc4fd80209786,15ead9d4f650eb0b543c0d4d59ecc4fd80209786,"Tests for root file logger.

This shit's getting real."
spang,2013-10-29 03:20:02,https://api.github.com/repos/nylas/sync-engine/git/commits/5d2e10dd50ad46b82a49827cdff90db8d140f9fc,5d2e10dd50ad46b82a49827cdff90db8d140f9fc,"Per-sync logging. Oh, and file logging. Woo!

From now on, for general logging do the following:

    from .log import get_logger
    log = get_logger()

For per-sync logging, see sync.py. For non-general-server logging
purposes, feel free to get an opinion from me on what the best
strategy is."
stubailo,2013-10-20 23:26:55,https://api.github.com/repos/nylas/sync-engine/git/commits/5d27d36aa91962514d9aa78ac07e784cb2dccbee,5d27d36aa91962514d9aa78ac07e784cb2dccbee,Made API get real contacts
grinich,2013-10-20 01:10:00,https://api.github.com/repos/nylas/sync-engine/git/commits/50f08cab24f7313913b9540aedea1f105064936b,50f08cab24f7313913b9540aedea1f105064936b,sync up to 25k at once
stubailo,2013-10-19 02:16:03,https://api.github.com/repos/nylas/sync-engine/git/commits/282d90a871697b29d7b87ce748c81acb1eb3c4e7,282d90a871697b29d7b87ce748c81acb1eb3c4e7,Merging changes from google and local database works
grinich,2013-10-19 01:00:53,https://api.github.com/repos/nylas/sync-engine/git/commits/efadbbea3944a27c449ce057ca86551f7c79a3a4,efadbbea3944a27c449ce057ca86551f7c79a3a4,client-side data models and angular services
grinich,2013-10-18 23:57:12,https://api.github.com/repos/nylas/sync-engine/git/commits/7ed65d8e0dc3e8df4ba4e9fb485833a453d38078,7ed65d8e0dc3e8df4ba4e9fb485833a453d38078,add dateutil
stubailo,2013-10-19 00:11:39,https://api.github.com/repos/nylas/sync-engine/git/commits/d6edddcafd9288c688781492a3c3abbbc8c72c54,d6edddcafd9288c688781492a3c3abbbc8c72c54,Added user if no user exists
stubailo,2013-10-18 23:44:36,https://api.github.com/repos/nylas/sync-engine/git/commits/40a174b9959587372eea7b3d79ccc5b279ee2447,40a174b9959587372eea7b3d79ccc5b279ee2447,Fixed indentation
grinich,2013-10-18 23:05:32,https://api.github.com/repos/nylas/sync-engine/git/commits/6719f203c4ee4b48d7aaa34bcd7920d69bd48c3e,6719f203c4ee4b48d7aaa34bcd7920d69bd48c3e,web frontend skeleton
stubailo,2013-10-18 23:06:36,https://api.github.com/repos/nylas/sync-engine/git/commits/762f9e44a5317cd7cfad6968d6dc659ea7991156,762f9e44a5317cd7cfad6968d6dc659ea7991156,Working on fleshin out the model
spang,2013-10-18 20:02:36,https://api.github.com/repos/nylas/sync-engine/git/commits/18cb61460fa55a8f72782734caf70b3612de0f92,18cb61460fa55a8f72782734caf70b3612de0f92,"Rip out some unnecessary stuff in models.py.

Bad paste."
stubailo,2013-10-18 20:06:24,https://api.github.com/repos/nylas/sync-engine/git/commits/0380654ee14446fd5daec0616b36ed3f96521059,0380654ee14446fd5daec0616b36ed3f96521059,Created really simple program the gets the contacts feed
grinich,2013-10-18 19:26:38,https://api.github.com/repos/nylas/sync-engine/git/commits/60732ab2570e3f91d0a81a008d3a3470879eb8b0,60732ab2570e3f91d0a81a008d3a3470879eb8b0,basic db creation and insertion
grinich,2013-10-18 19:14:26,https://api.github.com/repos/nylas/sync-engine/git/commits/85a6a1f8c30797d7762b8ed99a47ddcbb39d5a53,85a6a1f8c30797d7762b8ed99a47ddcbb39d5a53,add google contacts sync example
grinich,2013-10-29 02:47:03,https://api.github.com/repos/nylas/sync-engine/git/commits/eacbfe08fbc781b7bc2fe86486912cf81a4f2181,eacbfe08fbc781b7bc2fe86486912cf81a4f2181,dont crash if None
spang,2013-10-29 01:57:24,https://api.github.com/repos/nylas/sync-engine/git/commits/ec8ccf5b5f13b56ffd0413922cda39410ab5b005,ec8ccf5b5f13b56ffd0413922cda39410ab5b005,"Move util module up a level.

These are the sorts of things we may end up using in non-server code."
spang,2013-10-29 01:09:05,https://api.github.com/repos/nylas/sync-engine/git/commits/e06830939ed44da687f2e4d89afdfd4b48283e25,e06830939ed44da687f2e4d89afdfd4b48283e25,Fix server script name.
spang,2013-10-29 00:56:11,https://api.github.com/repos/nylas/sync-engine/git/commits/7ba075c908459378e9bf00dfb28bfa51c2bf9207,7ba075c908459378e9bf00dfb28bfa51c2bf9207,"Rewrite clear-db tool to use sqlalchemy.

This will solve our foreign key constraint headaches."
spang,2013-10-29 00:29:50,https://api.github.com/repos/nylas/sync-engine/git/commits/682b06760e15180cfa06c2d9b8690ac565f29a4d,682b06760e15180cfa06c2d9b8690ac565f29a4d,"Use pytest for testing.

omg tests."
spang,2013-10-29 00:26:30,https://api.github.com/repos/nylas/sync-engine/git/commits/fbb5e19870084bf510b04e86ac68be4aae4063a9,fbb5e19870084bf510b04e86ac68be4aae4063a9,"Don't use env vars for configuration.

This implementation is a lot cleaner and more flexible."
grinich,2013-10-28 01:03:22,https://api.github.com/repos/nylas/sync-engine/git/commits/6b6206b0e41d0c762b1d87c6c5275d33aef879d5,6b6206b0e41d0c762b1d87c6c5275d33aef879d5,fix the sorting bug and `g_id` -> `id`
jhurwitz,2013-10-27 21:04:48,https://api.github.com/repos/nylas/sync-engine/git/commits/8ab6f7a2492ce7e05c552be29702b2ec481d5c3c,8ab6f7a2492ce7e05c552be29702b2ec481d5c3c,"hook up todo backend to frontend

Currently, you can:
-switch between mail and todo views
-create a todo item from a thread
-view the names of current todo items

You cannot currently modify, interact with, or view the full details of
todo items."
grinich,2013-10-27 18:45:41,https://api.github.com/repos/nylas/sync-engine/git/commits/feb49614869cba49fa4ad271b2a79074a25e9762,feb49614869cba49fa4ad271b2a79074a25e9762,decode unicode contacts headers
jhurwitz,2013-10-27 05:20:16,https://api.github.com/repos/nylas/sync-engine/git/commits/ab8c620960d0118e94c3daad122583337d7c0a98,ab8c620960d0118e94c3daad122583337d7c0a98,model code for todo items
grinich,2013-10-27 03:05:50,https://api.github.com/repos/nylas/sync-engine/git/commits/beb3e36251c77707b6699a193756b09695198f4f,beb3e36251c77707b6699a193756b09695198f4f,prettifies html email that uses default font
grinich,2013-10-27 02:07:22,https://api.github.com/repos/nylas/sync-engine/git/commits/a69d2ecd39d7417d6d934286f33a0d20519c2fa7,a69d2ecd39d7417d6d934286f33a0d20519c2fa7,added function to find common intervals in two strings
grinich,2013-10-27 01:06:44,https://api.github.com/repos/nylas/sync-engine/git/commits/068d975477e38c0b505c57cefe987d51bfb067d5,068d975477e38c0b505c57cefe987d51bfb067d5,websocket endpoint
grinich,2013-10-27 00:51:24,https://api.github.com/repos/nylas/sync-engine/git/commits/df70b8ec7d262b97ce23400d3eeb99b120e311ab,df70b8ec7d262b97ce23400d3eeb99b120e311ab,fuckkkk
grinich,2013-10-27 00:46:03,https://api.github.com/repos/nylas/sync-engine/git/commits/6ba92fab9f6988d813ba61d2ce97c6213c36dbfb,6ba92fab9f6988d813ba61d2ce97c6213c36dbfb,new apis for namespace migration
grinich,2013-10-26 06:51:32,https://api.github.com/repos/nylas/sync-engine/git/commits/e15672681c16f9f805040eec76b0948afb302b75,e15672681c16f9f805040eec76b0948afb302b75,removed hardcoded api call for testing
nylasbot,2013-10-26 22:43:58,https://api.github.com/repos/nylas/sync-engine/git/commits/ff7c73900429bc0844b70b2b2559ec72354804f5,ff7c73900429bc0844b70b2b2559ec72354804f5,spang fixed Xapian
grinich,2013-10-26 06:44:33,https://api.github.com/repos/nylas/sync-engine/git/commits/e44314acf169277e5ceeac74f0403172c1e610d1,e44314acf169277e5ceeac74f0403172c1e610d1,New dev machine configuration
grinich,2013-10-26 06:17:00,https://api.github.com/repos/nylas/sync-engine/git/commits/c153e6c9b15bdac35588563ddba816582141738f,c153e6c9b15bdac35588563ddba816582141738f,attempting to load inbox contents in gui
shewu,2013-10-25 20:14:48,https://api.github.com/repos/nylas/sync-engine/git/commits/d3fac0a1ac74c4fb5771801ba1cc00810d0096c3,d3fac0a1ac74c4fb5771801ba1cc00810d0096c3,added xapian install instructions to README (xapian is used for search)
grinich,2013-10-26 18:23:25,https://api.github.com/repos/nylas/sync-engine/git/commits/198c6ecba59d81833b6de223b4d859a54358bd2e,198c6ecba59d81833b6de223b4d859a54358bd2e,Show mail UI and load stuff
grinich,2013-10-26 05:21:22,https://api.github.com/repos/nylas/sync-engine/git/commits/28ff7849cffab0ee353dc01cee3130a481bc5e8f,28ff7849cffab0ee353dc01cee3130a481bc5e8f,"A more polished todo list interface.
in general, this is less fucked than before.
the default view it loads is todo, which only shows mock data."
jhurwitz,2013-10-25 19:33:42,https://api.github.com/repos/nylas/sync-engine/git/commits/22dc71c758d0a2480f442411f7bb60cd0c25271c,22dc71c758d0a2480f442411f7bb60cd0c25271c,"Revert ""some initial fixes before we can run the server""

This reverts commit 40e28a4796bdaba04c49e92c3aa24ea62345730e.
I didn't realize we had a branch... oops."
jhurwitz,2013-10-26 17:48:57,https://api.github.com/repos/nylas/sync-engine/git/commits/37f2169cf5b78bbb88c06b73f1c7b73d7a65fbe3,37f2169cf5b78bbb88c06b73f1c7b73d7a65fbe3,fixed IMAPAccount.total_stored_messages function
jhurwitz,2013-10-26 05:20:16,https://api.github.com/repos/nylas/sync-engine/git/commits/5a97f021963cfd7b3f983b09fb4482c2bf9d1525,5a97f021963cfd7b3f983b09fb4482c2bf9d1525,fixed IMAPAccount.total_stored_data function
grinich,2013-10-26 04:20:35,https://api.github.com/repos/nylas/sync-engine/git/commits/be4b8806dbc037b3df5320faac78047f4217d153,be4b8806dbc037b3df5320faac78047f4217d153,"added api call to get top level (imap and shared) namespaces
changed first rpc call to call said api call
fixed bug in recv_message that gets userid instead of user"
grinich,2013-10-25 23:50:54,https://api.github.com/repos/nylas/sync-engine/git/commits/e3a01b4df8ca9059c21d0866c894a2b47d381aca,e3a01b4df8ca9059c21d0866c894a2b47d381aca,"Added SharedFolderNSMeta table

Also reorganized the database model to allow one user with multiple IMAPAccounts
and remove notion of root namespaces. We may have broken the app."
shewu,2013-10-25 20:14:48,https://api.github.com/repos/nylas/sync-engine/git/commits/ac172de7d2871e07f0ea3cef36f6cf5eab62da38,ac172de7d2871e07f0ea3cef36f6cf5eab62da38,added xapian install instructions to README (xapian is used for search)
jhurwitz,2013-10-25 19:31:08,https://api.github.com/repos/nylas/sync-engine/git/commits/ad0b1eb78f00bf30cb310025932db0d6fcd086de,ad0b1eb78f00bf30cb310025932db0d6fcd086de,"some initial fixes before we can run the server

(there may be more packages we need to install, but this is at least a
start)"
grinich,2013-10-27 00:51:59,https://api.github.com/repos/nylas/sync-engine/git/commits/79dc79d07aa0710dbdde06ef368f0b8097f6c84c,79dc79d07aa0710dbdde06ef368f0b8097f6c84c,new UI for updated namespace migration
grinich,2013-10-26 18:23:25,https://api.github.com/repos/nylas/sync-engine/git/commits/f0dc5f9f40102ee6d4e802b569593a231da9743d,f0dc5f9f40102ee6d4e802b569593a231da9743d,Show mail UI and load stuff
grinich,2013-10-26 05:21:22,https://api.github.com/repos/nylas/sync-engine/git/commits/626a5a5169dc23cba16076ccf11354b20964e8e4,626a5a5169dc23cba16076ccf11354b20964e8e4,"A more polished todo list interface.
in general, this is less fucked than before.
the default view it loads is todo, which only shows mock data."
grinich,2013-10-25 01:54:32,https://api.github.com/repos/nylas/sync-engine/git/commits/7ea34a1eac77a1842b571c326bc6aa5a1186bdff,7ea34a1eac77a1842b571c326bc6aa5a1186bdff,checkpoint
grinich,2013-10-23 00:36:12,https://api.github.com/repos/nylas/sync-engine/git/commits/a057b4203646c06862249bea96c9d211d7ca918b,a057b4203646c06862249bea96c9d211d7ca918b,logging
grinich,2013-10-23 00:06:53,https://api.github.com/repos/nylas/sync-engine/git/commits/5268e8ad4dd67f4ed64cda0e0ab397f466458fad,5268e8ad4dd67f4ed64cda0e0ab397f466458fad,fuck css
grinich,2013-10-22 19:38:40,https://api.github.com/repos/nylas/sync-engine/git/commits/95ad09feaaa7e59fd68e6a50063602c625f5ce57,95ad09feaaa7e59fd68e6a50063602c625f5ce57,Really should move this config elsewhere
spang,2013-10-22 00:00:20,https://api.github.com/repos/nylas/sync-engine/git/commits/8eaf1792983058034680d13465dfa26b95e59daf,8eaf1792983058034680d13465dfa26b95e59daf,Fix static folder.
spang,2013-10-21 23:59:29,https://api.github.com/repos/nylas/sync-engine/git/commits/7ba6a0f30333782922c5b2d20733cfe6770171f7,7ba6a0f30333782922c5b2d20733cfe6770171f7,"Remove vim modelines.

They make mg a sad panda. We'll deploy a minimal vimrc instead."
spang,2013-10-21 02:28:44,https://api.github.com/repos/nylas/sync-engine/git/commits/03eeac21dc78c4dfabe0fb64c1c67676b13b2202,03eeac21dc78c4dfabe0fb64c1c67676b13b2202,"Switch to setuptools.

This removes ALL sys.path hacks from our codebase. Make your dev
environment work with 'python setup.py develop' instead.

Also, now add dependencies in setup.py instead of requirements.txt.

I've also moved the server code to a subdirectory of 'inbox', which
will be the top-level package for all of our code. (We may even end
up with different git repos that install packages into the 'inbox'
namespace.)"
grinich,2013-10-20 01:09:17,https://api.github.com/repos/nylas/sync-engine/git/commits/bfa510ae499e423c2130ee943bda0f167f9766c4,bfa510ae499e423c2130ee943bda0f167f9766c4,some refactor for iframe injection
grinich,2013-10-20 00:27:56,https://api.github.com/repos/nylas/sync-engine/git/commits/825709cf9d956794d22bf37f1893e8fc04376899,825709cf9d956794d22bf37f1893e8fc04376899,thread pane redesign
grinich,2013-10-19 20:28:14,https://api.github.com/repos/nylas/sync-engine/git/commits/b9091a32af65e2397cff27f224f6ecbd87951871,b9091a32af65e2397cff27f224f6ecbd87951871,more style and better thread data model
grinich,2013-10-18 10:27:25,https://api.github.com/repos/nylas/sync-engine/git/commits/8322c2cdd7aa252f42c77ba97709842298b96bad,8322c2cdd7aa252f42c77ba97709842298b96bad,new design
spang,2013-10-18 03:05:17,https://api.github.com/repos/nylas/sync-engine/git/commits/ae9637792e0bfe47818868fb59502097f6d54846,ae9637792e0bfe47818868fb59502097f6d54846,s/%/.format/
spang,2013-10-17 22:58:24,https://api.github.com/repos/nylas/sync-engine/git/commits/694656f2b9cc641c75b4eb2a8a21af284e44d483,694656f2b9cc641c75b4eb2a8a21af284e44d483,"[SCHEMA] Change 'credentials' table to 'imapaccount'.

Refining the names in the new world order to make sense. Also,
web sessions are for _users_, crispin sessions are for _imap accounts_.
We just happen to be using the IMAP OAuth credentials for all logins
right now."
spang,2013-10-17 22:56:42,https://api.github.com/repos/nylas/sync-engine/git/commits/ad8bfa5b8f88b56c6f7d08f838047b78f34b9fda,ad8bfa5b8f88b56c6f7d08f838047b78f34b9fda,"Make it so you can launch a non-user-associated console.

Useful for just running code w/ the db settings configured."
spang,2013-10-17 01:12:01,https://api.github.com/repos/nylas/sync-engine/git/commits/5a04c4a4c0d6c16f2f42343daec490016d858c81,5a04c4a4c0d6c16f2f42343daec490016d858c81,[SCHEMA] Make messages_for_folder() fast.
spang,2013-10-16 23:54:05,https://api.github.com/repos/nylas/sync-engine/git/commits/f4f78e4cd8466bb8d87f534a87ed65d6e32a20cf,f4f78e4cd8466bb8d87f534a87ed65d6e32a20cf,"[SCHEMA] Move oauth credentials to separate table.

We need these to be tied to namespaces, not users, and we might also
want to encrypt some of them later."
spang,2013-10-16 00:50:01,https://api.github.com/repos/nylas/sync-engine/git/commits/8712d0d1bba192aabae4a57b8abe2244c9c580e3,8712d0d1bba192aabae4a57b8abe2244c9c580e3,"crispin: Rename user_obj to user.

The _obj suffix is ugly; it should be implicit
like everywhere else."
spang,2013-10-16 00:38:18,https://api.github.com/repos/nylas/sync-engine/git/commits/5f94e763058897c8e2874838f4c73cd6cb573752,5f94e763058897c8e2874838f4c73cd6cb573752,frontend works again
spang,2013-10-16 00:26:31,https://api.github.com/repos/nylas/sync-engine/git/commits/11d6e5f7570d3f1feacbdd662b1794fa85760329,11d6e5f7570d3f1feacbdd662b1794fa85760329,"Ugh, unbreak download deduplication."
spang,2013-10-15 23:33:58,https://api.github.com/repos/nylas/sync-engine/git/commits/bb4e674d1d613a2620e44d2858a3eaafaf650082,bb4e674d1d613a2620e44d2858a3eaafaf650082,Sync works again.
spang,2013-10-15 23:25:10,https://api.github.com/repos/nylas/sync-engine/git/commits/05780b3b3548cb1a32ffc815bab3331f4104fd8b,05780b3b3548cb1a32ffc815bab3331f4104fd8b,Make sync code use namespaces.
spang,2013-10-15 22:24:30,https://api.github.com/repos/nylas/sync-engine/git/commits/18fab26604668874e858a1ed4aeadbee1c13472a,18fab26604668874e858a1ed4aeadbee1c13472a,More namespace fixes.
spang,2013-10-15 21:28:46,https://api.github.com/repos/nylas/sync-engine/git/commits/706c5c09e88a4ef49f4dbecff85ad47701bf0e07,706c5c09e88a4ef49f4dbecff85ad47701bf0e07,[SCHEMA] Finish basic namespace implementation.
spang,2013-10-15 17:57:42,https://api.github.com/repos/nylas/sync-engine/git/commits/ea355c6648b394f948d17b05fa6375be0143a5d7,ea355c6648b394f948d17b05fa6375be0143a5d7,[SCHEMA] Finish s/messagepart/blockmeta/.
grinich,2013-10-15 03:02:38,https://api.github.com/repos/nylas/sync-engine/git/commits/3060252b673299819f0f427d86711ee1a76bb610,3060252b673299819f0f427d86711ee1a76bb610,add configuration value for socketio endpoint
grinich,2013-10-15 02:51:22,https://api.github.com/repos/nylas/sync-engine/git/commits/3286e2cb57f86eb20c5121ada09b08d554203d1d,3286e2cb57f86eb20c5121ada09b08d554203d1d,rename MessagePart to BlockMeta and change some table names to not use plurals
grinich,2013-10-15 02:28:42,https://api.github.com/repos/nylas/sync-engine/git/commits/89d27dd0a28f84c99930c0f1dad496e525f62272,89d27dd0a28f84c99930c0f1dad496e525f62272,migrate to namespace table
grinich,2013-10-15 02:27:42,https://api.github.com/repos/nylas/sync-engine/git/commits/f2d4806f5ecfa3fc619f5b085cae07779b48cbe6,f2d4806f5ecfa3fc619f5b085cae07779b48cbe6,remove MSMediumBlob import
spang,2013-10-15 00:25:38,https://api.github.com/repos/nylas/sync-engine/git/commits/ac445481734229cfa5ee59d324e3a15a81668767,ac445481734229cfa5ee59d324e3a15a81668767,Set vim defaults in python files.
spang,2013-10-15 00:05:19,https://api.github.com/repos/nylas/sync-engine/git/commits/5e5623568a9500f44f43a7dabb3511d5dfd4b123,5e5623568a9500f44f43a7dabb3511d5dfd4b123,[SCHEMA] Add namespace table.
grinich,2013-10-14 06:33:26,https://api.github.com/repos/nylas/sync-engine/git/commits/5a227f774b072b1b4e19f72a84f79bc9b61648b3,5a227f774b072b1b4e19f72a84f79bc9b61648b3,add better oauth errors
grinich,2013-10-08 22:35:57,https://api.github.com/repos/nylas/sync-engine/git/commits/94978ed1f9ad4392b5674244ee629e4a8ca69337,94978ed1f9ad4392b5674244ee629e4a8ca69337,bugfix
grinich,2013-10-08 22:28:41,https://api.github.com/repos/nylas/sync-engine/git/commits/8808989897001a4ff72d421043d61a5d58a39f8f,8808989897001a4ff72d421043d61a5d58a39f8f,adding Wand
grinich,2013-10-10 21:06:26,https://api.github.com/repos/nylas/sync-engine/git/commits/66bf49299bb0013c4820283b4a6a03aec886f71d,66bf49299bb0013c4820283b4a6a03aec886f71d,open links in new window by injecting base tag with _blank
grinich,2013-10-10 02:49:49,https://api.github.com/repos/nylas/sync-engine/git/commits/016e356bf8e3efaac1a6e91a88fe1d83a89d40ff,016e356bf8e3efaac1a6e91a88fe1d83a89d40ff,checkpoint in case i drown my laptop
grinich,2013-10-08 23:02:49,https://api.github.com/repos/nylas/sync-engine/git/commits/760f1900832818df0161eda7000af50cdf5ea2df,760f1900832818df0161eda7000af50cdf5ea2df,move some logging to the right place
grinich,2013-10-08 22:56:25,https://api.github.com/repos/nylas/sync-engine/git/commits/01ac995c4fadfd28244ed18c72d0fc56236066c1,01ac995c4fadfd28244ed18c72d0fc56236066c1,start all syncs. testing now
grinich,2013-10-08 22:43:51,https://api.github.com/repos/nylas/sync-engine/git/commits/00d1b114b3906a67440a221a6849a8689fb0994a,00d1b114b3906a67440a221a6849a8689fb0994a,stop all syncs. this shit is untested
grinich,2013-10-08 22:14:05,https://api.github.com/repos/nylas/sync-engine/git/commits/625b0d4a93d612d1731fd2b2f7a746a6dadc271b,625b0d4a93d612d1731fd2b2f7a746a6dadc271b,folder name and uid cant be null for foldermeta
grinich,2013-10-08 22:03:37,https://api.github.com/repos/nylas/sync-engine/git/commits/4926bdbf8fb16c7460195ff29b0ebd9c44f33526,4926bdbf8fb16c7460195ff29b0ebd9c44f33526,initial change to fix iconv
grinich,2013-10-08 21:19:01,https://api.github.com/repos/nylas/sync-engine/git/commits/50418cd7a28bfc0145744a4924bfc82813fdf792,50418cd7a28bfc0145744a4924bfc82813fdf792,fix for sockets expiring and not refreshing oauth token. this will fail endlessly if users revoke our access permanently
grinich,2013-10-06 07:37:44,https://api.github.com/repos/nylas/sync-engine/git/commits/8b00dab953406d464810c01e1fe2e2c9e003a5d8,8b00dab953406d464810c01e1fe2e2c9e003a5d8,set process name as inboxapp-srv
grinich,2013-10-06 06:59:56,https://api.github.com/repos/nylas/sync-engine/git/commits/fc550998844a7f1d6f14094100899fc944188108,fc550998844a7f1d6f14094100899fc944188108,ignore cache dir
grinich,2013-10-06 05:32:49,https://api.github.com/repos/nylas/sync-engine/git/commits/74f0ffd5e45226c48d67d2ac1d8d038a5871e687,74f0ffd5e45226c48d67d2ac1d8d038a5871e687,logging for multiple users. also now write msg data to s3 instead of local disk
spang,2013-10-06 03:11:09,https://api.github.com/repos/nylas/sync-engine/git/commits/7562f34e04d4d9c4317bd36f425e61b405147a76,7562f34e04d4d9c4317bd36f425e61b405147a76,Implement sync_status() API call.
spang,2013-10-06 03:10:42,https://api.github.com/repos/nylas/sync-engine/git/commits/81282c2c1ea04d3bc6355ca9582d4d590cc0b06c,81282c2c1ea04d3bc6355ca9582d4d590cc0b06c,Tweak SyncService status() data.
spang,2013-10-06 03:36:26,https://api.github.com/repos/nylas/sync-engine/git/commits/2fafc2933ec2b25bfe07e08ec0df171f5dd901aa,2fafc2933ec2b25bfe07e08ec0df171f5dd901aa,INTEGERS!
spang,2013-10-06 03:25:43,https://api.github.com/repos/nylas/sync-engine/git/commits/6a60ba21b7b0778c9ec37543a4a04ec2887fabbc,6a60ba21b7b0778c9ec37543a4a04ec2887fabbc,"UIDs are integers, really."
spang,2013-10-06 03:00:34,https://api.github.com/repos/nylas/sync-engine/git/commits/302efc9da9afae2f72efc7d0d487e0c431be24b5,302efc9da9afae2f72efc7d0d487e0c431be24b5,"Message UIDs are numbers, not strings."
spang,2013-10-06 02:49:10,https://api.github.com/repos/nylas/sync-engine/git/commits/cf85d2c415bf83ba1cf99ba632dc94c24dca9e36,cf85d2c415bf83ba1cf99ba632dc94c24dca9e36,"[SCHEMA] Message UIDs should be stored as Integers, not Strings."
grinich,2013-10-06 02:25:39,https://api.github.com/repos/nylas/sync-engine/git/commits/37ce388839403591b487f12ad334ad851e7b8bf4,37ce388839403591b487f12ad334ad851e7b8bf4,filter based on user. still not filtering based on folder.
spang,2013-10-06 02:15:00,https://api.github.com/repos/nylas/sync-engine/git/commits/42ccee29ff881d6914c35a610dbbc710bee74805,42ccee29ff881d6914c35a610dbbc710bee74805,Don't peg CPU while polling.
spang,2013-10-06 00:30:33,https://api.github.com/repos/nylas/sync-engine/git/commits/12f90f77d97877c5cc6bfc307efe5a69bc985871,12f90f77d97877c5cc6bfc307efe5a69bc985871,Update code for UIDValidity model change.
spang,2013-10-06 00:28:38,https://api.github.com/repos/nylas/sync-engine/git/commits/dfc246c4717d19da858522ffeed913e60fde5446,dfc246c4717d19da858522ffeed913e60fde5446,Update code for FolderMeta changes.
spang,2013-10-05 23:29:11,https://api.github.com/repos/nylas/sync-engine/git/commits/149bd2defafb6d9b740023dacb8bc372df8b5658,149bd2defafb6d9b740023dacb8bc372df8b5658,[SCHEMA] Pull shared values out of FolderMeta.
spang,2013-10-05 23:21:45,https://api.github.com/repos/nylas/sync-engine/git/commits/48d8a1a1fe96a24354f81fa568337de4d8efc463,48d8a1a1fe96a24354f81fa568337de4d8efc463,[SCHEMA] Remove duplicate g_email from UIDValidity.
grinich,2013-10-06 00:16:40,https://api.github.com/repos/nylas/sync-engine/git/commits/db0a066731ed470ef815c17d905255ffdffbf8a5,db0a066731ed470ef815c17d905255ffdffbf8a5,actually raise exception
grinich,2013-10-06 00:15:51,https://api.github.com/repos/nylas/sync-engine/git/commits/b149b1827ea913b163814afe7b55ecc67b78ba7d,b149b1827ea913b163814afe7b55ecc67b78ba7d,fix reading from s3 bug
spang,2013-10-05 22:26:05,https://api.github.com/repos/nylas/sync-engine/git/commits/b8791903bb7d9f77bf1bbf5e78e611015331b507,b8791903bb7d9f77bf1bbf5e78e611015331b507,Update clear_db.sql.
spang,2013-10-05 22:24:21,https://api.github.com/repos/nylas/sync-engine/git/commits/4f91b4bd04353ed5425bbd1ba59c0174929624cb,4f91b4bd04353ed5425bbd1ba59c0174929624cb,Update clear db script.
spang,2013-10-05 21:44:39,https://api.github.com/repos/nylas/sync-engine/git/commits/aa2a13256af2a2aceee3c2e8e05ab03d2fb8ce00,aa2a13256af2a2aceee3c2e8e05ab03d2fb8ce00,Don't delete messages that don't belong to you. Oops.
spang,2013-10-05 04:38:22,https://api.github.com/repos/nylas/sync-engine/git/commits/33273478a5fa4c718abb754456249a6517bbf53f,33273478a5fa4c718abb754456249a6517bbf53f,"Fix incremental update bug.

...did that code *ever* work? It was doing a SEARCH with the *latest*
highestmodseq rather than the old cached version."
spang,2013-10-05 02:27:48,https://api.github.com/repos/nylas/sync-engine/git/commits/0b4cc97316252c889fca69a9fe2fbaf93258f448,0b4cc97316252c889fca69a9fe2fbaf93258f448,Time MODSEQ queries.
spang,2013-10-05 01:42:09,https://api.github.com/repos/nylas/sync-engine/git/commits/5bf8ac1eaedba3a7928072453849f03ad083af87,5bf8ac1eaedba3a7928072453849f03ad083af87,Log cache file name.
spang,2013-10-05 01:32:16,https://api.github.com/repos/nylas/sync-engine/git/commits/d835247f26548d1310afb22df8f9c7c26255c04e,d835247f26548d1310afb22df8f9c7c26255c04e,More logging statements about caching.
spang,2013-10-04 21:24:07,https://api.github.com/repos/nylas/sync-engine/git/commits/662cdf6ebb71db43673988894cc142b11d13a73a,662cdf6ebb71db43673988894cc142b11d13a73a,Update imapclient.
spang,2013-10-01 03:00:21,https://api.github.com/repos/nylas/sync-engine/git/commits/9e4b668cc613af35a9c355baf39923fceead2bdc,9e4b668cc613af35a9c355baf39923fceead2bdc,"imaplib2 is dead.

Now that we're eventing I/O using gevent, there's really no reason at
all to be using some crazy threaded imap library."
spang,2013-10-01 01:41:05,https://api.github.com/repos/nylas/sync-engine/git/commits/f9a7e51c6d90aa9cd29d77d91657ecd8d1df86b8,f9a7e51c6d90aa9cd29d77d91657ecd8d1df86b8,"sync: Remove safe_commit()

I can't actually imagine a situation where committing to the database
fails where we _don't_ want the error to percolate upwards."
spang,2013-10-01 00:52:24,https://api.github.com/repos/nylas/sync-engine/git/commits/d4ece9fc5bbaa762d994f984f20ee3c4e588485f,d4ece9fc5bbaa762d994f984f20ee3c4e588485f,Enable spelling correction.
spang,2013-09-30 23:43:49,https://api.github.com/repos/nylas/sync-engine/git/commits/b3ae2d40683ae330bb5a3ba12bd324f4f525186a,b3ae2d40683ae330bb5a3ba12bd324f4f525186a,"Fix search flags.

Search now properly supports AND / OR, + / -, quoted phrases, and
synonyms."
spang,2013-09-30 23:16:41,https://api.github.com/repos/nylas/sync-engine/git/commits/cea8e0f2f9909d1b5597637ec826ca524be62c75,cea8e0f2f9909d1b5597637ec826ca524be62c75,Remove debugging log statement.
spang,2013-09-30 23:16:35,https://api.github.com/repos/nylas/sync-engine/git/commits/9cf7c2d1178d891134abe1ce87fb94ccb69fe239,9cf7c2d1178d891134abe1ce87fb94ccb69fe239,Basic subject indexing.
spang,2013-09-30 23:09:07,https://api.github.com/repos/nylas/sync-engine/git/commits/737741dcf8445b4b456625e66065412b97f09c78,737741dcf8445b4b456625e66065412b97f09c78,Basic to/from/cc/bcc indexing.
spang,2013-09-30 23:08:09,https://api.github.com/repos/nylas/sync-engine/git/commits/7e4b08f3601d348ee12c5fe793a951a1e002c4f3,7e4b08f3601d348ee12c5fe793a951a1e002c4f3,Make index syntax consistent with console/sync/etc.
spang,2013-09-30 18:57:41,https://api.github.com/repos/nylas/sync-engine/git/commits/22f75cff78933e9bb4d1c0d94bcf46da6856eb30,22f75cff78933e9bb4d1c0d94bcf46da6856eb30,Fix 'inbox console'.
spang,2013-09-26 16:49:51,https://api.github.com/repos/nylas/sync-engine/git/commits/2ebf35cd27ce91f034237849ae852b47fdb986aa,2ebf35cd27ce91f034237849ae852b47fdb986aa,search tmp
grinich,2013-10-05 01:21:16,https://api.github.com/repos/nylas/sync-engine/git/commits/1acc6f8ecd4ccbc7d6fac6756d04c64acea2c5fa,1acc6f8ecd4ccbc7d6fac6756d04c64acea2c5fa,move chardet withing try/catch
grinich,2013-10-05 01:20:53,https://api.github.com/repos/nylas/sync-engine/git/commits/b1eccd1fa886895678f1ed117bba1e031180e495,b1eccd1fa886895678f1ed117bba1e031180e495,Write locally to /mnt instead of ../parts
grinich,2013-09-29 03:13:13,https://api.github.com/repos/nylas/sync-engine/git/commits/f8a95398770855f5bc2ee3b6c28fc60a2796d782,f8a95398770855f5bc2ee3b6c28fc60a2796d782,use yield_per to limit memory usage
spang,2013-09-27 22:25:37,https://api.github.com/repos/nylas/sync-engine/git/commits/442a2c6de7fc7f10a90f6601e4ab6f938f075f77,442a2c6de7fc7f10a90f6601e4ab6f938f075f77,Add support for dummy crispin clients to session manager.
spang,2013-09-27 22:15:54,https://api.github.com/repos/nylas/sync-engine/git/commits/6304d1df0ae3d85222d6015f71c9158ff6e001b3,6304d1df0ae3d85222d6015f71c9158ff6e001b3,inbox: Add --dummy toggle for sync.
spang,2013-09-27 22:11:49,https://api.github.com/repos/nylas/sync-engine/git/commits/14a6275d0a8e4445d102b06b054715173236cf93,14a6275d0a8e4445d102b06b054715173236cf93,"[SCHEMA] Add User.save_raw_messages column.

We're going to want a way to toggle whether or not we're saving raw byte
dumps on a user."
spang,2013-09-27 21:31:38,https://api.github.com/repos/nylas/sync-engine/git/commits/dd842a6afff79497ea6a3cd638b76e92554dddf7,dd842a6afff79497ea6a3cd638b76e92554dddf7,"Pull out crispin base class.

Need for the upcoming dummy backend."
spang,2013-09-27 21:30:55,https://api.github.com/repos/nylas/sync-engine/git/commits/3c5bb731fb0b37906ce0e7966a33b03e13df2b09,3c5bb731fb0b37906ce0e7966a33b03e13df2b09,crispin: Remove dead code.
spang,2013-09-27 20:41:47,https://api.github.com/repos/nylas/sync-engine/git/commits/bf1f2a0f2c6bce4f043c94bb346d6e62f8f39092,bf1f2a0f2c6bce4f043c94bb346d6e62f8f39092,Fix bugs in processing shutdown.
spang,2013-09-27 20:13:04,https://api.github.com/repos/nylas/sync-engine/git/commits/45508a9559f50e6835f566cf3b2d3fdcfa1f6e6f,45508a9559f50e6835f566cf3b2d3fdcfa1f6e6f,Fix a couple bugs.
spang,2013-09-27 19:33:15,https://api.github.com/repos/nylas/sync-engine/git/commits/521ca88da303d962f61515f818bf0f1dabd35686,521ca88da303d962f61515f818bf0f1dabd35686,Fix typo.
spang,2013-09-27 19:16:26,https://api.github.com/repos/nylas/sync-engine/git/commits/61fab60c0e09d821d7daa71a49ad7daed2504461,61fab60c0e09d821d7daa71a49ad7daed2504461,"Implement support for shutting down sync workers.

You can do this now by calling stop_sync('email') on the sync service."
spang,2013-09-27 19:13:14,https://api.github.com/repos/nylas/sync-engine/git/commits/ee3e6863e9e3e86855ce0968ee48e939d9f9a3cf,ee3e6863e9e3e86855ce0968ee48e939d9f9a3cf,Pull strip_tags() out to util module.
spang,2013-09-27 19:08:08,https://api.github.com/repos/nylas/sync-engine/git/commits/9b4c8005284bc2e26c84f675e6504a879120094e,9b4c8005284bc2e26c84f675e6504a879120094e,"[SCHEMA] Add sync_host to User model.

For keeping track of what machine a user's sync process is running on."
spang,2013-09-27 19:05:57,https://api.github.com/repos/nylas/sync-engine/git/commits/e97ef015e5cca097f7a29d24ad261b60b13e3d60,e97ef015e5cca097f7a29d24ad261b60b13e3d60,"Clean up util module structure.

Splitting things out this way allows us to better import pieces of code
and not bring in tons of unnecessary dependencies."
spang,2013-09-27 18:48:54,https://api.github.com/repos/nylas/sync-engine/git/commits/16956e5599dbe4c2433128ecc5c2dba33d7d5417,16956e5599dbe4c2433128ecc5c2dba33d7d5417,Add a few more tables to these sql scripts.
spang,2013-09-27 18:48:11,https://api.github.com/repos/nylas/sync-engine/git/commits/17c1cb53cb9c486f1448c884afb8a0d8934b520f,17c1cb53cb9c486f1448c884afb8a0d8934b520f,Forgot to commit photo gallery assets.
spang,2013-09-26 19:44:10,https://api.github.com/repos/nylas/sync-engine/git/commits/844fafadce23fe404989613ef1c9c2c8ca67760c,844fafadce23fe404989613ef1c9c2c8ca67760c,Make sync states persistent.
spang,2013-09-26 19:30:32,https://api.github.com/repos/nylas/sync-engine/git/commits/a4ac04f1a17c3bf74d7e7c2fcbd6af9a27b2b297,a4ac04f1a17c3bf74d7e7c2fcbd6af9a27b2b297,"[SCHEMA] Add sync_active flag to User model.

For making sync states persistent across restarts."
spang,2013-09-26 19:27:55,https://api.github.com/repos/nylas/sync-engine/git/commits/f63612ffa97b6bc1801e0d193e809ec3e6239107,f63612ffa97b6bc1801e0d193e809ec3e6239107,[SCHEMA] Index users by email address.
spang,2013-09-26 19:27:23,https://api.github.com/repos/nylas/sync-engine/git/commits/160b988200f7aad56395a6e8f107d6b6629c7808,160b988200f7aad56395a6e8f107d6b6629c7808,"Clean up user models.

Declarative automatically creates constructors that take keyword
arguments, which is more useful than setting all attributes to None."
spang,2013-09-26 18:39:06,https://api.github.com/repos/nylas/sync-engine/git/commits/b8c686cb1fed5844900d9c230ff0549b96d9ce07,b8c686cb1fed5844900d9c230ff0549b96d9ce07,"Fail harder when saving message data fails.

This should abort the whole initial sync, since who knows what's going
on---programming error, S3 API is down, whatever. We may want to be
smarter about dealing with S3-related network errors in the future, but
for now let's err on the side of being conservative."
spang,2013-09-26 18:05:17,https://api.github.com/repos/nylas/sync-engine/git/commits/b8c8333d58ae5cf63e938153475cf4d0a7a6cecf,b8c8333d58ae5cf63e938153475cf4d0a7a6cecf,"Explicitly create tables only on ./inbox start.

Having this call in the global scope of the models module
breaks alembic migration auto-creation when new tables
are added."
spang,2013-09-26 17:50:21,https://api.github.com/repos/nylas/sync-engine/git/commits/a02085033c0b19dc07bbd26ef2221df51d4a043d,a02085033c0b19dc07bbd26ef2221df51d4a043d,"[SCHEMA] Split out blob-saving logic to a separate role.

We need this code for both message parts *and* raw messages now."
spang,2013-09-18 17:59:13,https://api.github.com/repos/nylas/sync-engine/git/commits/d2a89870db71f2569f0e9eff8f61f16902bf329b,d2a89870db71f2569f0e9eff8f61f16902bf329b,"Index all HTML or all plaintext parts of an email.

The strategy of only indexing the first part doesn't guarantee that for
some mails we only index the mailman footer or something else stupid
like that."
spang,2013-09-16 20:02:33,https://api.github.com/repos/nylas/sync-engine/git/commits/9c57969e6140ed4c75ea511aa9b4d924676b10d1,9c57969e6140ed4c75ea511aa9b4d924676b10d1,Migration for collections
spang,2013-09-16 20:00:13,https://api.github.com/repos/nylas/sync-engine/git/commits/f60f42ffd1d9e32d8f0602367e7ce8dc03ac1692,f60f42ffd1d9e32d8f0602367e7ce8dc03ac1692,"Whoops, forgot to git add this file."
grinich,2013-09-14 20:28:55,https://api.github.com/repos/nylas/sync-engine/git/commits/33bb398f9fafd0639832e0fa3a92bcef6e263eea,33bb398f9fafd0639832e0fa3a92bcef6e263eea,fuck this demo is over phew but this code sucks
spang,2013-09-14 12:19:28,https://api.github.com/repos/nylas/sync-engine/git/commits/bc990df08d060d79bf781c129c0adc450d959190,bc990df08d060d79bf781c129c0adc450d959190,Wrong ordering now that we have foreign keys
spang,2013-09-14 10:30:02,https://api.github.com/repos/nylas/sync-engine/git/commits/981bba76a90e382b2f5c06cb4f4787edb6feaa07,981bba76a90e382b2f5c06cb4f4787edb6feaa07,Implement galleries as collections (working draft).
spang,2013-09-14 08:43:05,https://api.github.com/repos/nylas/sync-engine/git/commits/8c7a4e68144a3f97f130702aa996d6f0adfe5bcb,8c7a4e68144a3f97f130702aa996d6f0adfe5bcb,Also save metadata object.
spang,2013-09-14 08:40:22,https://api.github.com/repos/nylas/sync-engine/git/commits/a293ad41df94256aaa1d29a7797a6d0975bc46ca,a293ad41df94256aaa1d29a7797a6d0975bc46ca,Create message meta too when uploading attachments.
grinich,2013-09-14 07:39:49,https://api.github.com/repos/nylas/sync-engine/git/commits/d7a4861c20c05d72e0bf522adb9b68109ee9d974,d7a4861c20c05d72e0bf522adb9b68109ee9d974,some buttons. really shitty code for demo
grinich,2013-09-14 04:56:01,https://api.github.com/repos/nylas/sync-engine/git/commits/1802b320311f25414490540b627cdb92ea9d03bf,1802b320311f25414490540b627cdb92ea9d03bf,not returning fulltext anymore
grinich,2013-09-14 04:55:39,https://api.github.com/repos/nylas/sync-engine/git/commits/4f4a0d5bd71798e6238213b9bfea34b429c09614,4f4a0d5bd71798e6238213b9bfea34b429c09614,nice fonts everywhere
grinich,2013-09-14 00:20:51,https://api.github.com/repos/nylas/sync-engine/git/commits/dcd1fba72601d85251d6c0aa8dd3d1f137096b24,dcd1fba72601d85251d6c0aa8dd3d1f137096b24,reset to inbox list when clearing search
spang,2013-09-14 05:12:29,https://api.github.com/repos/nylas/sync-engine/git/commits/a3aaa76f44b1e9f1f54f1f8ad0a7cce2f2426b03,a3aaa76f44b1e9f1f54f1f8ad0a7cce2f2426b03,Do index filter on user_id now that we have it.
spang,2013-09-14 03:41:24,https://api.github.com/repos/nylas/sync-engine/git/commits/7e923d33073bd88e03a611a7d64179d289fcbd0d,7e923d33073bd88e03a611a7d64179d289fcbd0d,Everything uses user.id now.
spang,2013-09-14 02:28:05,https://api.github.com/repos/nylas/sync-engine/git/commits/47ec1d7576ffdf26979d4c00b3d8189d9ba2a327,47ec1d7576ffdf26979d4c00b3d8189d9ba2a327,Clean up MessageMeta model.
spang,2013-09-14 02:15:38,https://api.github.com/repos/nylas/sync-engine/git/commits/e5306973771e4de8060a0838839138395b71ba1e,e5306973771e4de8060a0838839138395b71ba1e,Use real user_id in search.
spang,2013-09-14 01:54:49,https://api.github.com/repos/nylas/sync-engine/git/commits/57ec971f15b9465af30e27b5667192b89096972c,57ec971f15b9465af30e27b5667192b89096972c,Add quick search shortcut.
spang,2013-09-14 01:33:22,https://api.github.com/repos/nylas/sync-engine/git/commits/e5a1c9bf681b8aa16e95c93e03fa575722058d31,e5a1c9bf681b8aa16e95c93e03fa575722058d31,Add 'index' command and per-user indexing.
spang,2013-09-14 01:25:42,https://api.github.com/repos/nylas/sync-engine/git/commits/7c02b8b6d5d03a391a9a93934165639e7b5577c6,7c02b8b6d5d03a391a9a93934165639e7b5577c6,inbox: Remove dead code.
spang,2013-09-14 01:25:24,https://api.github.com/repos/nylas/sync-engine/git/commits/68e4396766fef6ea6104d5ea22bd2d016311e0c7,68e4396766fef6ea6104d5ea22bd2d016311e0c7,inbox: Fix up whitespace.
spang,2013-09-14 00:28:06,https://api.github.com/repos/nylas/sync-engine/git/commits/368d7d98ec963df3f733c091c6f4c1210ed3e89e,368d7d98ec963df3f733c091c6f4c1210ed3e89e,"Don't return fulltext from searches.

We don't need it."
spang,2013-09-14 00:26:23,https://api.github.com/repos/nylas/sync-engine/git/commits/ae5bd02c1a6e1490391ae70f27cde0e04465372d,ae5bd02c1a6e1490391ae70f27cde0e04465372d,Clean up database connection later.
spang,2013-09-14 00:24:36,https://api.github.com/repos/nylas/sync-engine/git/commits/1176cbe5d1142ef1562c4b69061e8099912bdefb,1176cbe5d1142ef1562c4b69061e8099912bdefb,"Close db connection after search.

Might solve 'too many open files' error?"
spang,2013-09-14 00:21:18,https://api.github.com/repos/nylas/sync-engine/git/commits/456b83acefe991dc76a8af576f1830db1f2cc81f,456b83acefe991dc76a8af576f1830db1f2cc81f,"Better logging for caching code.

Trying to hunt down this caching bug."
grinich,2013-09-13 23:52:58,https://api.github.com/repos/nylas/sync-engine/git/commits/67a535ed6a2d55dffcb2387c4c8926423b206c26,67a535ed6a2d55dffcb2387c4c8926423b206c26,uid cache bugs
grinich,2013-09-13 23:22:12,https://api.github.com/repos/nylas/sync-engine/git/commits/d253a3add27b4b0cf357537672bfebffb0ba7a28,d253a3add27b4b0cf357537672bfebffb0ba7a28,now fixed
spang,2013-09-13 23:14:26,https://api.github.com/repos/nylas/sync-engine/git/commits/085b1ef1535b3e3ed578f5c1f163ebd8d0209dc2,085b1ef1535b3e3ed578f5c1f163ebd8d0209dc2,Remove cache after initial sync.
grinich,2013-09-13 23:20:46,https://api.github.com/repos/nylas/sync-engine/git/commits/7e89cd9dfd28afb1bae0b09d22111feb6b2ca68e,7e89cd9dfd28afb1bae0b09d22111feb6b2ca68e,HURRR I FIXED A TYPO!
grinich,2013-09-13 23:12:49,https://api.github.com/repos/nylas/sync-engine/git/commits/75178ad86eb6866151e6b16f93cb68af72108ac4,75178ad86eb6866151e6b16f93cb68af72108ac4,Yay searching mail from the client!
spang,2013-09-13 22:25:26,https://api.github.com/repos/nylas/sync-engine/git/commits/cbb0319cc56827babbc5e6fc8299b4de7199cc3b,cbb0319cc56827babbc5e6fc8299b4de7199cc3b,Remove deprecated xappy index-generation script.
spang,2013-09-13 22:24:47,https://api.github.com/repos/nylas/sync-engine/git/commits/424214307b842e8789bfa0e0110a2d8826121344,424214307b842e8789bfa0e0110a2d8826121344,"Remove end-of-initial-sync uidvalidity commit.

Now that we save uidvalidity at the beginning, any changes since the
beginning of the session will just be caught when we start polling."
spang,2013-09-13 21:54:59,https://api.github.com/repos/nylas/sync-engine/git/commits/ed79e8e0ff44f773922a42661f1ca3ec35b79ba3,ed79e8e0ff44f773922a42661f1ca3ec35b79ba3,"search() should take a user_id, not an email address.

We are standardizing on our own user.id as the way to refer to users."
spang,2013-09-13 18:49:23,https://api.github.com/repos/nylas/sync-engine/git/commits/77b0fd26fdc7c9025cc0d1e4ae1a4c3b15b26e41,77b0fd26fdc7c9025cc0d1e4ae1a4c3b15b26e41,"Explicitly test for None when saving data.

Some values such as zero-length strings fail to be truthy but are still
valid MIME payloads. It's fine to save these blank parts, but a 'None'
value is definitely a bug in our decoding/encoding code."
spang,2013-09-13 18:47:34,https://api.github.com/repos/nylas/sync-engine/git/commits/6d7ff4d894342cd95e15a757a08ca145c94130c2,6d7ff4d894342cd95e15a757a08ca145c94130c2,MessagePart 'data' attr -> '_data' to differentiate it from db cols.
spang,2013-09-13 12:37:22,https://api.github.com/repos/nylas/sync-engine/git/commits/09e94fef17952217f20e401f407409e040a0fe35,09e94fef17952217f20e401f407409e040a0fe35,"Don't catch _all_ exceptions when calling os.makedirs.

If the disk is full, for example, we actually do want to crash hard."
spang,2013-09-12 16:25:37,https://api.github.com/repos/nylas/sync-engine/git/commits/8b2c0a83e2741641da0d10eb94ed3ca4a146d6fb,8b2c0a83e2741641da0d10eb94ed3ca4a146d6fb,"Cache g_msgids during initial sync.

This query can be very slow, which is a pain if we need to restart the
sync at all. So, we cache the results to a pickle file, and refresh the
cache with a HIGHESTMODSEQ query if we have a recorded uidvalidity row
on initial sync restart."
grinich,2013-09-13 21:18:26,https://api.github.com/repos/nylas/sync-engine/git/commits/642b18881f9fff41f28efba1b6b602889595cbaf,642b18881f9fff41f28efba1b6b602889595cbaf,display threads + some styling changes
grinich,2013-09-13 17:17:57,https://api.github.com/repos/nylas/sync-engine/git/commits/0f3bfcc64547be0900f13ceabfe9570b73261573,0f3bfcc64547be0900f13ceabfe9570b73261573,formatting for non-html mail
grinich,2013-09-13 16:48:33,https://api.github.com/repos/nylas/sync-engine/git/commits/4ea1edc04a4e05abced0440d9ad800d68a44a3cc,4ea1edc04a4e05abced0440d9ad800d68a44a3cc,fuckthisshit
grinich,2013-09-13 01:56:34,https://api.github.com/repos/nylas/sync-engine/git/commits/85fb939be5173b747d0439a0f6b5e8129ede8dee,85fb939be5173b747d0439a0f6b5e8129ede8dee,remove cruft from bootstrap days
spang,2013-09-13 02:46:35,https://api.github.com/repos/nylas/sync-engine/git/commits/68b8146b4609d9c0fd1844e25373fc54e0b27abb,68b8146b4609d9c0fd1844e25373fc54e0b27abb,"Download mail in reverse UID order.

Higher UIDs tend to be more recent mail, which we want to download
first. Looks like the original mail sync code did this, but I lost that
feature in my rewrite."
grinich,2013-09-13 00:34:41,https://api.github.com/repos/nylas/sync-engine/git/commits/e622ff46f2b499ea89e49136e9f61305d3ea4960,e622ff46f2b499ea89e49136e9f61305d3ea4960,[UI] fetching message bodies. broken for attachments
spang,2013-09-12 05:48:36,https://api.github.com/repos/nylas/sync-engine/git/commits/e90a257d0efb6a9fb81593aa3a6d0964539f220c,e90a257d0efb6a9fb81593aa3a6d0964539f220c,Fix docstring.
spang,2013-09-12 05:09:02,https://api.github.com/repos/nylas/sync-engine/git/commits/ea9527a31152020f7d4282f9a6b35e5c335f5165,ea9527a31152020f7d4282f9a6b35e5c335f5165,Search fixes.
spang,2013-09-12 05:08:34,https://api.github.com/repos/nylas/sync-engine/git/commits/bb29edd57e74bb587c18b8c810f2df894bd6e45f,bb29edd57e74bb587c18b8c810f2df894bd6e45f,"Fuck xappy, just use raw xapian bindings.

Not as pretty but it works."
spang,2013-09-12 01:25:09,https://api.github.com/repos/nylas/sync-engine/git/commits/dd7c4fe9a29c89ed69bb2f20b178ce78c6920f1f,dd7c4fe9a29c89ed69bb2f20b178ce78c6920f1f,"Make --email_address a positional argument.

./inbox sync spang@inboxapp.com

is a lot more natural and waaaay shorter. I don't think we're ever
going to need more arguments anyway."
grinich,2013-09-12 01:00:12,https://api.github.com/repos/nylas/sync-engine/git/commits/50d27330455e6506540326e844375f82ecc6f012,50d27330455e6506540326e844375f82ecc6f012,new logo for homepage
grinich,2013-09-12 00:59:25,https://api.github.com/repos/nylas/sync-engine/git/commits/975f15717dbd61eaad8a8f5abbc998248b43bb26,975f15717dbd61eaad8a8f5abbc998248b43bb26,check for missing ZMQ port
grinich,2013-09-12 00:59:11,https://api.github.com/repos/nylas/sync-engine/git/commits/c14ddbabc830b28fd7acd501a5050281ab2cb10c,c14ddbabc830b28fd7acd501a5050281ab2cb10c,save files to local disk (or s3) and add api call to fetch body
grinich,2013-09-12 00:57:48,https://api.github.com/repos/nylas/sync-engine/git/commits/4a0c4f1da5052548f3caaa27488193fb250908f4,4a0c4f1da5052548f3caaa27488193fb250908f4,remove bootstrap.js
spang,2013-09-12 00:10:12,https://api.github.com/repos/nylas/sync-engine/git/commits/dae5cbfbc2115ea77638d7b3f2095fc845eb29c2,dae5cbfbc2115ea77638d7b3f2095fc845eb29c2,Add missing chardet dependency.
spang,2013-09-11 22:12:21,https://api.github.com/repos/nylas/sync-engine/git/commits/5a607dce04cfdb86a4d701affe27e597b01980fc,5a607dce04cfdb86a4d701affe27e597b01980fc,"A couple little sql scripts I've been using.

e.g.

   mysql < tools/clear_db_minus_users.sql

with a properly set up /etc/my.cnf will wipe the database except
for the 'users' table."
spang,2013-09-11 05:41:02,https://api.github.com/repos/nylas/sync-engine/git/commits/fa8ae2e8ee04918ccf4752885fcc4b186f207def,fa8ae2e8ee04918ccf4752885fcc4b186f207def,NEXT STOP EMBARCADERO
spang,2013-09-11 05:35:11,https://api.github.com/repos/nylas/sync-engine/git/commits/d9452de64669283872858a7457af4a1e16885767,d9452de64669283872858a7457af4a1e16885767,Add script to generate search index.
spang,2013-09-11 05:28:55,https://api.github.com/repos/nylas/sync-engine/git/commits/23bf43e4cfdaa29d9334716fdfc22da44cd1dbb8,23bf43e4cfdaa29d9334716fdfc22da44cd1dbb8,Add draft search server.
spang,2013-09-11 03:42:58,https://api.github.com/repos/nylas/sync-engine/git/commits/e267b81b782e007af77167011abafa99017b0a14,e267b81b782e007af77167011abafa99017b0a14,"Unbreak some stuff in the frontend.

I broke it."
spang,2013-09-11 01:57:36,https://api.github.com/repos/nylas/sync-engine/git/commits/a1c73873f1228725b0b9d6e2ae263c0e3f900fa1,a1c73873f1228725b0b9d6e2ae263c0e3f900fa1,Fix hilarious bug where single-part messages don't get parts added to the db.
spang,2013-09-11 01:57:00,https://api.github.com/repos/nylas/sync-engine/git/commits/db774b08fb58b3ccfac3208076d0ed769a17c830,db774b08fb58b3ccfac3208076d0ed769a17c830,Fix indentation.
spang,2013-09-11 01:20:15,https://api.github.com/repos/nylas/sync-engine/git/commits/d22a187ff98b4f59b474f36d2ff9c5f9b378925c,d22a187ff98b4f59b474f36d2ff9c5f9b378925c,"Migration for new attachments stuff.

For reference, generated with:
alembic revision --autogenerate -m 'Different way of handling attachments.'"
spang,2013-09-11 01:12:04,https://api.github.com/repos/nylas/sync-engine/git/commits/1f9dc605bbd5b8501c0657382976e445b01bad6d,1f9dc605bbd5b8501c0657382976e445b01bad6d,"Relate parts to metadata when syncing.

Makes it easier to use the power of sqlalchemy to e.g. load related
parts at once using .options(joinedload(parts)) on MessageMeta queries.

I didn't technically need to change the fetch_uids() API as much as I
did, it turns out, but due to some initial confusion on how to relate
sqlalchemy objects before commiting, I changed the API. The result is no
worse than what we started with."
spang,2013-09-10 23:52:43,https://api.github.com/repos/nylas/sync-engine/git/commits/fffc3a33f9f8e3d22ab4525b92d05cc2dbd85c31,fffc3a33f9f8e3d22ab4525b92d05cc2dbd85c31,"Save locally to disk as well as to S3.

It's still super useful for development to have a local copy of
downloaded parts."
spang,2013-09-10 23:51:29,https://api.github.com/repos/nylas/sync-engine/git/commits/b45a0a346d54677a8672dcf643e6f179e95d82a0,b45a0a346d54677a8672dcf643e6f179e95d82a0,"Clean up MessageMeta model.

Have it properly reference messagemeta with a foreign key, and
remove unused fields."
grinich,2013-09-11 03:30:44,https://api.github.com/repos/nylas/sync-engine/git/commits/fa675a59ead5b27f1cf3bae68e2a3551a8b36004,fa675a59ead5b27f1cf3bae68e2a3551a8b36004,remove my hardcoded email address DOH
grinich,2013-09-10 22:03:01,https://api.github.com/repos/nylas/sync-engine/git/commits/79dcbcef7bfd321899003eb45cdbedb86c33ae18,79dcbcef7bfd321899003eb45cdbedb86c33ae18,better logging
grinich,2013-09-09 02:34:17,https://api.github.com/repos/nylas/sync-engine/git/commits/e41145a0812d43833d43abf335820c90628bbe62,e41145a0812d43833d43abf335820c90628bbe62,select all mail folder for crisping console
grinich,2013-09-09 02:33:52,https://api.github.com/repos/nylas/sync-engine/git/commits/d45009d412c1be7097014e2a7191bd6cf7163238,d45009d412c1be7097014e2a7191bd6cf7163238,certs location and config filename
grinich,2013-09-08 05:50:14,https://api.github.com/repos/nylas/sync-engine/git/commits/37ac6b7f84490961f8c39496f5b7373402941c84,37ac6b7f84490961f8c39496f5b7373402941c84,chunk -> 20
grinich,2013-09-10 21:55:20,https://api.github.com/repos/nylas/sync-engine/git/commits/dc58237123d025e386ec3441499ce3bec7b68b0d,dc58237123d025e386ec3441499ce3bec7b68b0d,logging cleanup
grinich,2013-09-10 21:54:56,https://api.github.com/repos/nylas/sync-engine/git/commits/030b4bcff12eafcedea45e0c96c2638b85ed6e2f,030b4bcff12eafcedea45e0c96c2638b85ed6e2f,gravatar over https
grinich,2013-09-10 21:54:39,https://api.github.com/repos/nylas/sync-engine/git/commits/a435923874bb8afca23e38414eb64ddd27161f0d,a435923874bb8afca23e38414eb64ddd27161f0d,cleanup
grinich,2013-09-10 21:54:12,https://api.github.com/repos/nylas/sync-engine/git/commits/dc6c166b31db8f0668148adf99e8fee157623eec,dc6c166b31db8f0668148adf99e8fee157623eec,basic support for uploading attachments from client ui
grinich,2013-09-08 03:41:01,https://api.github.com/repos/nylas/sync-engine/git/commits/d8398e37750a53f4f87437916a1a9a336adcf9cd,d8398e37750a53f4f87437916a1a9a336adcf9cd,clear data after writing to s3 and explicity call garbage collector
spang,2013-09-08 03:10:43,https://api.github.com/repos/nylas/sync-engine/git/commits/52fbd86228b491e57a5f09ce879d394bcbc666db,52fbd86228b491e57a5f09ce879d394bcbc666db,"Use 'iconv' package instead of shelling out to iconv.

Saves us a fork() (but in theory calling C code might still be expensive)."
spang,2013-09-08 00:50:46,https://api.github.com/repos/nylas/sync-engine/git/commits/6c9487335b73ff0dfb61021a6bb7d2b7017d70bb,6c9487335b73ff0dfb61021a6bb7d2b7017d70bb,"Specify lamson's license.

If we don't keep track of this stuff, it WILL bite us someday."
grinich,2013-09-08 02:32:57,https://api.github.com/repos/nylas/sync-engine/git/commits/91c2f6ccbfe0a81c9d5e25b642f5a9a0e5edb165,91c2f6ccbfe0a81c9d5e25b642f5a9a0e5edb165,chunk size of one for development. NEED RAM
grinich,2013-09-08 00:23:21,https://api.github.com/repos/nylas/sync-engine/git/commits/728a2c110733d09e923add0cb190f564b13fb12e,728a2c110733d09e923add0cb190f564b13fb12e,another hack for a lookup error
grinich,2013-09-07 23:33:08,https://api.github.com/repos/nylas/sync-engine/git/commits/982713295e0d7e740a324892bf375428a5bb2948,982713295e0d7e740a324892bf375428a5bb2948,i am a moron
grinich,2013-09-07 21:24:42,https://api.github.com/repos/nylas/sync-engine/git/commits/0f4a159e50bb9ced98985585ff887cbe5bc38d6e,0f4a159e50bb9ced98985585ff887cbe5bc38d6e,back out changes and disable iconv
grinich,2013-09-07 19:32:32,https://api.github.com/repos/nylas/sync-engine/git/commits/3b996d4e975df0161efbf054203fe2eae1f5526b,3b996d4e975df0161efbf054203fe2eae1f5526b,typo
grinich,2013-09-07 19:28:49,https://api.github.com/repos/nylas/sync-engine/git/commits/c93be8e8867422c9a6d9e45ef3b1e8fd60e29153,c93be8e8867422c9a6d9e45ef3b1e8fd60e29153,create subprocess object earlier to avoid memory issues
grinich,2013-09-07 19:04:57,https://api.github.com/repos/nylas/sync-engine/git/commits/108b766b4f13ec96f0a42fd6a9b22da73d359c68,108b766b4f13ec96f0a42fd6a9b22da73d359c68,Only fetch one message at a time. Hopefully this will mitigate out of memory errors on ec2 micro instance
grinich,2013-09-07 18:50:17,https://api.github.com/repos/nylas/sync-engine/git/commits/f72a589c82f2bff13cce348de383e42ff340c86e,f72a589c82f2bff13cce348de383e42ff340c86e,log exception
grinich,2013-09-07 10:09:14,https://api.github.com/repos/nylas/sync-engine/git/commits/69b244ae1b78618986336ebea21b2c5a80273a6e,69b244ae1b78618986336ebea21b2c5a80273a6e,wtf
grinich,2013-09-07 09:43:57,https://api.github.com/repos/nylas/sync-engine/git/commits/94c3c7c7fc45a61bd8a40cec1fe0978c5b1c92d2,94c3c7c7fc45a61bd8a40cec1fe0978c5b1c92d2,dont throw error (fix later)
grinich,2013-09-07 08:36:59,https://api.github.com/repos/nylas/sync-engine/git/commits/8d029475d67fdae37c24bbbebd578a7bbdc8aefc,8d029475d67fdae37c24bbbebd578a7bbdc8aefc,typo
grinich,2013-09-07 08:36:25,https://api.github.com/repos/nylas/sync-engine/git/commits/531e9a5ed68d24c22b67575167a98b2e926cb7dd,531e9a5ed68d24c22b67575167a98b2e926cb7dd,typo
grinich,2013-09-07 08:34:33,https://api.github.com/repos/nylas/sync-engine/git/commits/a6b3a1099545c362c0465d6daf3d295f077b39f6,a6b3a1099545c362c0465d6daf3d295f077b39f6,uncomment github fingerprint
grinich,2013-09-07 08:34:12,https://api.github.com/repos/nylas/sync-engine/git/commits/6018ffadf998310e55583deb8d6c78f4689f5b56,6018ffadf998310e55583deb8d6c78f4689f5b56,write message part to s3 when syncing
grinich,2013-09-07 04:44:14,https://api.github.com/repos/nylas/sync-engine/git/commits/167f652cb8c1dfbe7be9d5775d0a8e12539049f8,167f652cb8c1dfbe7be9d5775d0a8e12539049f8,getting sick of this shit
spang,2013-09-06 22:47:44,https://api.github.com/repos/nylas/sync-engine/git/commits/389ba4b21336c58dba115d483dedce613ad476d9,389ba4b21336c58dba115d483dedce613ad476d9,Don't put non-RPC methods on ZeroRPC classes.
spang,2013-09-06 22:30:03,https://api.github.com/repos/nylas/sync-engine/git/commits/2e047b29149d75ff55faaaca99cd67a39521e4cf,2e047b29149d75ff55faaaca99cd67a39521e4cf,FUNCTIONS
spang,2013-09-06 22:21:49,https://api.github.com/repos/nylas/sync-engine/git/commits/1a9b2a6c3090e360f3cb1baf684264f824e31d71,1a9b2a6c3090e360f3cb1baf684264f824e31d71,"Simplify progress-reporting logic for initial sync.

The previous code was racy in that it could leave some progress updates
in the updates queue after the process was finished and falsely trigger
the queue-empty assertion. Now we deal with that properly."
grinich,2013-09-06 22:03:44,https://api.github.com/repos/nylas/sync-engine/git/commits/06f1f622a6ee8ca8a3039b6029b216d9ea0a7182,06f1f622a6ee8ca8a3039b6029b216d9ea0a7182,50x error page
grinich,2013-09-06 22:02:57,https://api.github.com/repos/nylas/sync-engine/git/commits/edade34856c0e333f85529f89937793870f865f4,edade34856c0e333f85529f89937793870f865f4,fix nginx routing and error handling
grinich,2013-09-06 03:08:39,https://api.github.com/repos/nylas/sync-engine/git/commits/f6c300035abe21ed0cb493b6d1370a9234f50bb1,f6c300035abe21ed0cb493b6d1370a9234f50bb1,this isnt actually valid
spang,2013-09-06 21:43:33,https://api.github.com/repos/nylas/sync-engine/git/commits/0f01d73a1a93777853a85b075ff433d5eb61bdb1,0f01d73a1a93777853a85b075ff433d5eb61bdb1,I changed that name
spang,2013-09-05 07:16:41,https://api.github.com/repos/nylas/sync-engine/git/commits/525f607dfdc0ab4c84ea9721cc04f00886cfc226,525f607dfdc0ab4c84ea9721cc04f00886cfc226,"Implement SyncService.

OH MY GOD IT WORKS"
spang,2013-09-06 17:39:33,https://api.github.com/repos/nylas/sync-engine/git/commits/9116f0e68ff426741c6cc22cd19a77eed509260e,9116f0e68ff426741c6cc22cd19a77eed509260e,"Python standard is spaces, not tabs."
spang,2013-09-05 05:23:44,https://api.github.com/repos/nylas/sync-engine/git/commits/5196337f16d40ed977ecaa6acd513209671567e2,5196337f16d40ed977ecaa6acd513209671567e2,Don't need this check now that we're using argparse.
spang,2013-09-04 23:06:18,https://api.github.com/repos/nylas/sync-engine/git/commits/799dcd2313d8b87ad862beb36da4baea6f6100a4,799dcd2313d8b87ad862beb36da4baea6f6100a4,Make sync a ZeroRPC service queryable by the API.
grinich,2013-09-05 23:54:30,https://api.github.com/repos/nylas/sync-engine/git/commits/a5cb9f73d1d97b610ae4a03dbc7d8e7ea2f8cf28,a5cb9f73d1d97b610ae4a03dbc7d8e7ea2f8cf28,fuck nginx
grinich,2013-09-05 22:35:12,https://api.github.com/repos/nylas/sync-engine/git/commits/1bd4d4b3135f21887d417792870739832ad3c24b,1bd4d4b3135f21887d417792870739832ad3c24b,better setup instructions
grinich,2013-09-05 22:35:03,https://api.github.com/repos/nylas/sync-engine/git/commits/60ef29ec93bdd6a2794802d400a8d4366aca6360,60ef29ec93bdd6a2794802d400a8d4366aca6360,ssl key location
grinich,2013-09-05 20:49:41,https://api.github.com/repos/nylas/sync-engine/git/commits/8f6b19bacf3e79e82c2799e84eeac9b82758b313,8f6b19bacf3e79e82c2799e84eeac9b82758b313,better confguration options. create a file config.cfg in the root directory. see config-sample.cfg for an example
grinich,2013-09-05 20:18:11,https://api.github.com/repos/nylas/sync-engine/git/commits/76fc2cb8ff45f0a004f876966d8e18f5f0fc13e5,76fc2cb8ff45f0a004f876966d8e18f5f0fc13e5,return valid User object and move existence checking to make_user function
grinich,2013-09-05 20:17:21,https://api.github.com/repos/nylas/sync-engine/git/commits/3ccd8647a7c336da5335140613edf341904a7b0e,3ccd8647a7c336da5335140613edf341904a7b0e,store session cookie on all inboxapp.com subdomains
grinich,2013-09-05 18:48:32,https://api.github.com/repos/nylas/sync-engine/git/commits/fa037f27e8eab142a56ad99f799a801e882f39e7,fa037f27e8eab142a56ad99f799a801e882f39e7,deploy cleanup
grinich,2013-09-05 18:47:31,https://api.github.com/repos/nylas/sync-engine/git/commits/2cdc19d01e653d7a32115998c6745a629df55df4,2cdc19d01e653d7a32115998c6745a629df55df4,old crispins are still valid connected
grinich,2013-09-05 08:32:58,https://api.github.com/repos/nylas/sync-engine/git/commits/2e3ea18df0d64223053d4db79f0be92851433aad,2e3ea18df0d64223053d4db79f0be92851433aad,cookie domain
grinich,2013-09-05 08:32:37,https://api.github.com/repos/nylas/sync-engine/git/commits/4f495070df37d17dc3aa22230856f80f5ff1d20f,4f495070df37d17dc3aa22230856f80f5ff1d20f,f
grinich,2013-09-05 07:52:35,https://api.github.com/repos/nylas/sync-engine/git/commits/7b89a9ef5c7ff049e78dd6053ab786b9e7f2c9e7,7b89a9ef5c7ff049e78dd6053ab786b9e7f2c9e7,"This adds the ability to create and deploy to a new Amazon EC2 instance, and
also configure a development DNS hostname.

You need to put the SSL certificate+key in /certs and AWS settings in the
fabfile.py. To run, simply call `fab deploy_server` in the deploy directory."
grinich,2013-09-05 03:23:54,https://api.github.com/repos/nylas/sync-engine/git/commits/c1cf24c4e04a03b1a6551404ee433a9b9cc2261e,c1cf24c4e04a03b1a6551404ee433a9b9cc2261e,deploy keys so a provisioned server can copy this repo
grinich,2013-09-05 02:56:05,https://api.github.com/repos/nylas/sync-engine/git/commits/55ff2530c05b117c24aa5cc885819808637bad20,55ff2530c05b117c24aa5cc885819808637bad20,Redirecting the apex domain breaks when this is not hosted at www.inboxapp.com
spang,2013-09-05 02:41:39,https://api.github.com/repos/nylas/sync-engine/git/commits/dbfc6bec883b9cba40ba181db9c2598c364b5f7f,dbfc6bec883b9cba40ba181db9c2598c364b5f7f,"SCHEMA: Give all tables an Integer primary key.

In the long run, we're going to want this for table relations, etc.

also fuck it you're going to have to blow all your tables away and redo
from scratch on this one. messing with all those primary keys suuucks."
spang,2013-09-05 02:40:37,https://api.github.com/repos/nylas/sync-engine/git/commits/fb0f88ef797fc8a8e00d62c5fc79a25b3de8bc9d,fb0f88ef797fc8a8e00d62c5fc79a25b3de8bc9d,Support alembic revision autogeneration.
spang,2013-09-04 21:41:05,https://api.github.com/repos/nylas/sync-engine/git/commits/e98f8e28794d59bc5801282145e85c54261eb22d,e98f8e28794d59bc5801282145e85c54261eb22d,inbox: remove unused import.
spang,2013-09-05 01:49:52,https://api.github.com/repos/nylas/sync-engine/git/commits/49cebc5c38535e37c1ca5ac89c9b2e8ecd77377e,49cebc5c38535e37c1ca5ac89c9b2e8ecd77377e,And again.
spang,2013-09-05 01:32:55,https://api.github.com/repos/nylas/sync-engine/git/commits/38c8655915fe5499c60ee3cafbcb92946f622037,38c8655915fe5499c60ee3cafbcb92946f622037,No uidvalidity saved means the uidvalidity is good.
grinich,2013-09-05 00:10:50,https://api.github.com/repos/nylas/sync-engine/git/commits/0237d9da5e828c541229c406f1bd6c52e85c03fb,0237d9da5e828c541229c406f1bd6c52e85c03fb,force ssl
grinich,2013-09-04 23:00:09,https://api.github.com/repos/nylas/sync-engine/git/commits/7e19c4e618273e2d0cce8cdfce0ccf762a311e70,7e19c4e618273e2d0cce8cdfce0ccf762a311e70,because fuck elastic beanstalk
grinich,2013-09-04 22:58:34,https://api.github.com/repos/nylas/sync-engine/git/commits/83483d25a45f8b84fc5c34e902a5f2eb7e30bf8a,83483d25a45f8b84fc5c34e902a5f2eb7e30bf8a,pull site url from environment variable
grinich,2013-09-04 22:58:08,https://api.github.com/repos/nylas/sync-engine/git/commits/3028003b471423d44e863b15db56253fb446acb5,3028003b471423d44e863b15db56253fb446acb5,fix typo and allow wildcard subdomain (For testing)
spang,2013-09-04 21:40:27,https://api.github.com/repos/nylas/sync-engine/git/commits/0ead3fdde4757b9669c69d6d32d3cee2f0ea92d0,0ead3fdde4757b9669c69d6d32d3cee2f0ea92d0,"Move gevent stuff to separate util file.

Don't really want to pull that stuff in if all you want is, like, chunk()."
spang,2013-09-04 02:06:55,https://api.github.com/repos/nylas/sync-engine/git/commits/3a3797e45df49b563892a771cdd476edc2a8ec9b,3a3797e45df49b563892a771cdd476edc2a8ec9b,"SCHEMA: move flags to FolderMeta

Flags for the same message can be different if the message is in
multiple folders."
grinich,2013-09-04 03:14:00,https://api.github.com/repos/nylas/sync-engine/git/commits/39393b04cdc72af33fa5b81350967082a6dc6346,39393b04cdc72af33fa5b81350967082a6dc6346,no git describe
spang,2013-09-04 01:42:34,https://api.github.com/repos/nylas/sync-engine/git/commits/40432895205ee9593d53c3c9a965af550e560ef2,40432895205ee9593d53c3c9a965af550e560ef2,Remove log statement.
spang,2013-09-04 01:42:14,https://api.github.com/repos/nylas/sync-engine/git/commits/e374cf694add073e1b0ac73a720a1bef27a4f2aa,e374cf694add073e1b0ac73a720a1bef27a4f2aa,Don't double-login initially.
spang,2013-09-04 01:27:55,https://api.github.com/repos/nylas/sync-engine/git/commits/1585ccc1c0552b555cbd116ba531f03f51ecadb0,1585ccc1c0552b555cbd116ba531f03f51ecadb0,Yell hard if resync_uids() is called.
spang,2013-09-04 00:43:04,https://api.github.com/repos/nylas/sync-engine/git/commits/a230ca09d1ecf4a75060184461b50e7e8e40ab0a,a230ca09d1ecf4a75060184461b50e7e8e40ab0a,SCHEMA: add users.initial_sync_done
spang,2013-09-04 00:42:11,https://api.github.com/repos/nylas/sync-engine/git/commits/4772f5dc57d2ab8b4c19d885ad170b5974b7a53b,4772f5dc57d2ab8b4c19d885ad170b5974b7a53b,Fix a typo.
spang,2013-09-04 00:41:53,https://api.github.com/repos/nylas/sync-engine/git/commits/237403a74d8654586ce88b04ed5fb5c9633e7076,237403a74d8654586ce88b04ed5fb5c9633e7076,"Split out config setup from inbox script.

So it can be imported from elsewhere, such as in migrations that also
need to configure the database connection."
spang,2013-09-04 00:11:22,https://api.github.com/repos/nylas/sync-engine/git/commits/9030601d4876898308a3154d0d13d1be4ae2490e,9030601d4876898308a3154d0d13d1be4ae2490e,crispin.py: Remove some useless methods.
spang,2013-09-03 23:04:43,https://api.github.com/repos/nylas/sync-engine/git/commits/17936f647ba994ed57d7fba6a296b68ce30d8e94,17936f647ba994ed57d7fba6a296b68ce30d8e94,Implement poll syncing with HIGHESTMODSEQ.
spang,2013-09-03 20:08:02,https://api.github.com/repos/nylas/sync-engine/git/commits/b321d6401885ca2b3f663f8c871ee2beb64c187a,b321d6401885ca2b3f663f8c871ee2beb64c187a,"Move intial_sync.py -> sync.py.

Now that we're launching stuff from the 'inbox' script,
this is really just a module, not a standalone script.
It makes sense to put all the sync-related stuff here."
spang,2013-09-03 19:05:37,https://api.github.com/repos/nylas/sync-engine/git/commits/b50d007aa329e574b0bd06f7bb41505565f51cac,b50d007aa329e574b0bd06f7bb41505565f51cac,"Not sure why mysql-python is commented, but we need it."
grinich,2013-09-03 22:46:01,https://api.github.com/repos/nylas/sync-engine/git/commits/e09aad2d6fab491a6990e51158cb2fcf9d4cb424,e09aad2d6fab491a6990e51158cb2fcf9d4cb424,update requirements
grinich,2013-09-03 22:42:38,https://api.github.com/repos/nylas/sync-engine/git/commits/baf549190c959b64778ad1e0d6967d1adeae984f,baf549190c959b64778ad1e0d6967d1adeae984f,use python requests lib instead of tornado
grinich,2013-09-03 22:17:05,https://api.github.com/repos/nylas/sync-engine/git/commits/0c637dda06b8ed5297c63527c035ae78a05ce5a1,0c637dda06b8ed5297c63527c035ae78a05ce5a1,ssl configuration
grinich,2013-09-03 20:51:57,https://api.github.com/repos/nylas/sync-engine/git/commits/317e69b280f743467b44dff45474e1d9e49d049b,317e69b280f743467b44dff45474e1d9e49d049b,add your own local settings in local-config.cfg
grinich,2013-09-03 20:43:31,https://api.github.com/repos/nylas/sync-engine/git/commits/a54f6937752d3d14c4d3e16166725039269e07eb,a54f6937752d3d14c4d3e16166725039269e07eb,"add nginx. this does the following:
- redirects apex domain to www (functionality removed from flask)
- serves static assets on /app url from ./web_client
- serves favicon
- supports websocket upgrade"
spang,2013-09-03 18:45:57,https://api.github.com/repos/nylas/sync-engine/git/commits/566a0eac39e1f328c67496d53682bd6de1bd3ac9,566a0eac39e1f328c67496d53682bd6de1bd3ac9,"Clean up requirements.txt.

Delete unused code, don't comment it. That's what revision control is
for."
spang,2013-09-03 18:45:20,https://api.github.com/repos/nylas/sync-engine/git/commits/b30bececa38f25429b5c5c78d002524d4e52dbad,b30bececa38f25429b5c5c78d002524d4e52dbad,"Rip out oauth2 dep.

We're not actually using it (we use imapclient's oauth functionality),
and if we do need an oauth library, we should use the newer, maintained
'oauthlib' which is supported on python 2 and 3."
grinich,2013-09-02 05:10:09,https://api.github.com/repos/nylas/sync-engine/git/commits/c517a7a9a95fd3ab709b0c3640c5471133d9786a,c517a7a9a95fd3ab709b0c3640c5471133d9786a,need a bigger pickle size
grinich,2013-09-02 05:09:55,https://api.github.com/repos/nylas/sync-engine/git/commits/e82457a345ad8b62baa2a571bdbe8dc0356ac700,e82457a345ad8b62baa2a571bdbe8dc0356ac700,switch to positional args
grinich,2013-09-02 05:09:32,https://api.github.com/repos/nylas/sync-engine/git/commits/81a65661c9356696eb2df194f0c89c6850d72e6d,81a65661c9356696eb2df194f0c89c6850d72e6d,back out some broken stuff
grinich,2013-09-01 05:28:48,https://api.github.com/repos/nylas/sync-engine/git/commits/ba2e4e2e2958b6ebf9caaf44849ca766e2f6b9ec,ba2e4e2e2958b6ebf9caaf44849ca766e2f6b9ec,some client socket API fixes and attempts to deploy using AWS Elastic Beanstalk
grinich,2013-08-31 05:54:07,https://api.github.com/repos/nylas/sync-engine/git/commits/652129a04d3aa37935f8e1b02ef85318fc05003e,652129a04d3aa37935f8e1b02ef85318fc05003e,save user identifier
grinich,2013-08-31 05:53:32,https://api.github.com/repos/nylas/sync-engine/git/commits/7854b7460cb413bca820dd8d5233e2a4188d9bde,7854b7460cb413bca820dd8d5233e2a4188d9bde,save subject as TEXT instead of VARCHAR
grinich,2013-08-31 05:51:21,https://api.github.com/repos/nylas/sync-engine/git/commits/c010ac595bc0837c48712f57c40c58fabdbf0150,c010ac595bc0837c48712f57c40c58fabdbf0150,splash page before showing google oauth screen
grinich,2013-08-31 00:58:16,https://api.github.com/repos/nylas/sync-engine/git/commits/0660c547b704224a348979f4b26a3b1dff06ecee,0660c547b704224a348979f4b26a3b1dff06ecee,forgot to add requests dependency
grinich,2013-08-31 00:47:59,https://api.github.com/repos/nylas/sync-engine/git/commits/88a6e469de706665b948cf54e8cb76e7695d501f,88a6e469de706665b948cf54e8cb76e7695d501f,remove tornadorpc dependency
grinich,2013-08-31 00:40:11,https://api.github.com/repos/nylas/sync-engine/git/commits/5bceae65286a9eea1d6e5b2ea38323d2e3b76df7,5bceae65286a9eea1d6e5b2ea38323d2e3b76df7,"Use MySQL instead of SQLite. You need to create a local database and
fill-in credentials in default-config.cfg for this to work.

Note: We should probably take a closer look to see if the VARCHAR max-lengths
are what we want. Also, I think we should store a user ID integer
(auto-incrementing) instead of using the email address as the primary key."
grinich,2013-08-31 00:36:52,https://api.github.com/repos/nylas/sync-engine/git/commits/272a115fd9a87dc5bb46181e203ce29a8f9cdd04,272a115fd9a87dc5bb46181e203ce29a8f9cdd04,fuck this
grinich,2013-08-30 22:36:36,https://api.github.com/repos/nylas/sync-engine/git/commits/dab77f460c53d5c5bacf70d3623863726cfc5586,dab77f460c53d5c5bacf70d3623863726cfc5586,ugh logging
grinich,2013-08-30 21:39:35,https://api.github.com/repos/nylas/sync-engine/git/commits/51f4b531f5680473fb39eac2ba13dbc1b8e020d0,51f4b531f5680473fb39eac2ba13dbc1b8e020d0,logging error
grinich,2013-08-30 21:09:25,https://api.github.com/repos/nylas/sync-engine/git/commits/714a97d094859cbdf1f1801fe99330e9a7bf3782,714a97d094859cbdf1f1801fe99330e9a7bf3782,note
grinich,2013-08-30 20:58:35,https://api.github.com/repos/nylas/sync-engine/git/commits/95db8fb6e09ed6b8fff2e060980cd49e20386f41,95db8fb6e09ed6b8fff2e060980cd49e20386f41,more logging
grinich,2013-08-30 20:58:24,https://api.github.com/repos/nylas/sync-engine/git/commits/85afbb8c9b1cbc5bd57a005ce0f8d970e2d44c1f,85afbb8c9b1cbc5bd57a005ce0f8d970e2d44c1f,add print_dots() for roughly inspeting greenlet switch
grinich,2013-08-30 20:57:54,https://api.github.com/repos/nylas/sync-engine/git/commits/c0a15a02d5ed969cc4f3aabd34f2010d767eb337,c0a15a02d5ed969cc4f3aabd34f2010d767eb337,colorize [ character
grinich,2013-08-30 20:57:25,https://api.github.com/repos/nylas/sync-engine/git/commits/7bef9d72b8fd48a87e343bd6f0e49ce31b138ebe,7bef9d72b8fd48a87e343bd6f0e49ce31b138ebe,"- start sync for user by doing $ ./inbox sync --email_address xxx@gmail.com
- start debug server (autoreload) $./inbox debug
- start crispin shell by doing $ ./inbox console --email_address xxx@gmail.com"
grinich,2013-08-30 20:52:03,https://api.github.com/repos/nylas/sync-engine/git/commits/000fd46cc1c0b07670d4a464e861732e69067684,000fd46cc1c0b07670d4a464e861732e69067684,add hash to entire message body
spang,2013-08-30 20:15:58,https://api.github.com/repos/nylas/sync-engine/git/commits/25e22a1752b85c4853824a05804886a18a6a535d,25e22a1752b85c4853824a05804886a18a6a535d,Mention submodule in README.md.
grinich,2013-08-30 19:35:41,https://api.github.com/repos/nylas/sync-engine/git/commits/ba29c7f4019f37ae387c484fa58d0d33338e6575,ba29c7f4019f37ae387c484fa58d0d33338e6575,variable name 'email' -> 'user_email_address' for clarity. 'email' is kind of a loaded word... :P
grinich,2013-08-30 19:34:41,https://api.github.com/repos/nylas/sync-engine/git/commits/afac74fcb4eb5c4845f016c67a22895f568f0800,afac74fcb4eb5c4845f016c67a22895f568f0800,if encoding lookup fails (something like X-UNKNOWN) try to use chardet. this seems to almost always work.
grinich,2013-08-30 19:33:35,https://api.github.com/repos/nylas/sync-engine/git/commits/a2908ba94936f76c5b60d1d9112a3d0f0ee8ee22,a2908ba94936f76c5b60d1d9112a3d0f0ee8ee22,"- remove tornado from google_oauth module
- move oauth keys to config file (env var)
- move cookie secret to config file (env var)"
grinich,2013-08-30 02:09:01,https://api.github.com/repos/nylas/sync-engine/git/commits/b62d37e3b9d089fb66794dd7f69c8ae92cb2cded,b62d37e3b9d089fb66794dd7f69c8ae92cb2cded,need to figure out why this causes an exception
grinich,2013-08-30 00:27:57,https://api.github.com/repos/nylas/sync-engine/git/commits/1280ee5658c4770fc4927f7c933a721eb61365e4,1280ee5658c4770fc4927f7c933a721eb61365e4,"- expose request object for all websocket messgaes
- cleanup"
grinich,2013-08-29 23:19:19,https://api.github.com/repos/nylas/sync-engine/git/commits/97c7460747c9e6ca33c0dcdc303e78a23cd5c5cf,97c7460747c9e6ca33c0dcdc303e78a23cd5c5cf,"NOTE: For this to work, you need to edit /etc/hosts. See changes to README.md.

Changes:

- Adding ZeroRPC which is a Greenlet-based rpc framework that runs over ZeroMQ

- Expose API module as a ZMQ service that is called by the websocket handler. (We should probably rename API to metaserver or similar, since that's essentially what it's doing.)

- Adding a config file to specify address+port for current and future ZeroMQ services. We probably need to use something more flexible for provisioning hundreds of servers, but this is a start.

- Add subdomain support for app server. All request to apex domain should redirect to www. Right now msg-store.inboxapp is an example of how we can load attachments. It's only doing metadata now.

- Keep track of active websocket connections

- Change wire websocket namespace from being the root namespace (causes some on connect messages to be lost)

- Simple 404 error page

- add g_email to MessageMeta and MessagePart (ie: user identifier)

- Pull web app settings into flask

- change User.email_address to User.g_email for consistency.

- Remove faults code from socket_rpc.py. We should just do this with exceptions instead, and return the proper fault code in the websocket layer.

- Halfway refresh of a bunch of Angular code I'm still working on.

- Lots of cleanup, including me getting better at complying with pep8. Nobody likes cowboy code."
grinich,2013-08-28 02:10:35,https://api.github.com/repos/nylas/sync-engine/git/commits/42f83d3e5ba8f26d31f46694ba0077efc9790bfa,42f83d3e5ba8f26d31f46694ba0077efc9790bfa,listing msg
grinich,2013-08-28 01:39:17,https://api.github.com/repos/nylas/sync-engine/git/commits/ab162d0c2c575bebd157b6633b75a4365a0797e0,ab162d0c2c575bebd157b6633b75a4365a0797e0,clean up some stuff. i'm messy. :(
grinich,2013-08-28 01:36:29,https://api.github.com/repos/nylas/sync-engine/git/commits/021a4881ed603b2ff4a4b388019f30d466552939,021a4881ed603b2ff4a4b388019f30d466552939,delay fetching msgs
spang,2013-08-29 21:07:45,https://api.github.com/repos/nylas/sync-engine/git/commits/9fb1ada5b45bbd742ee6e749739023b22b5f0573,9fb1ada5b45bbd742ee6e749739023b22b5f0573,"Port initial_sync.py to argparse.

No more tornado dependency."
spang,2013-08-29 21:07:25,https://api.github.com/repos/nylas/sync-engine/git/commits/4ab2c46e59cc18e7336bc2200ed7282139bc6d4e,4ab2c46e59cc18e7336bc2200ed7282139bc6d4e,Rip tornado logging out of initial_sync.py.
spang,2013-08-29 20:08:12,https://api.github.com/repos/nylas/sync-engine/git/commits/0c7e922a18b7794a76b6c7c5b486416a1d79206f,0c7e922a18b7794a76b6c7c5b486416a1d79206f,Strip unsafe characters from filename before writing errors to disk.
spang,2013-08-28 02:47:15,https://api.github.com/repos/nylas/sync-engine/git/commits/8ed6b78702f97b3cc18b044fe25bec3a5c9f6ad0,8ed6b78702f97b3cc18b044fe25bec3a5c9f6ad0,Ignore errors dir.
spang,2013-08-28 02:46:52,https://api.github.com/repos/nylas/sync-engine/git/commits/70d417d1c8b179a95400d6dc070d8da318edd343,70d417d1c8b179a95400d6dc070d8da318edd343,encoding.py: Fix creation of errors dir.
spang,2013-08-28 02:46:25,https://api.github.com/repos/nylas/sync-engine/git/commits/e68d8852e13956aa81e38fc422ce2490a008c0a9,e68d8852e13956aa81e38fc422ce2490a008c0a9,initial_sync.py: Clarify skip message.
spang,2013-08-28 02:05:30,https://api.github.com/repos/nylas/sync-engine/git/commits/a849e389e86f727b6eed6cb18cd55d01e15d5a49,a849e389e86f727b6eed6cb18cd55d01e15d5a49,"Always treat uids and g_msgids as strings except when sorting.

La la la types matter sometimes."
grinich,2013-08-28 00:32:49,https://api.github.com/repos/nylas/sync-engine/git/commits/bc8a55e8a5ca3b7de0d1fd93edeba992a03fb6b9,bc8a55e8a5ca3b7de0d1fd93edeba992a03fb6b9,"Porting the app from Tornado to Flask, using gevent-socketio.
This will allow us to run several Flask workers under gunicorn, which
can speak with ngingx over wsgi."
grinich,2013-08-27 07:53:00,https://api.github.com/repos/nylas/sync-engine/git/commits/cb67b28b733fde1e756c681da5b9b576e3fd824f,cb67b28b733fde1e756c681da5b9b576e3fd824f,checkpoint
spang,2013-08-28 00:27:26,https://api.github.com/repos/nylas/sync-engine/git/commits/8be244d327cf4a65729463d936c1d4a66896ec19,8be244d327cf4a65729463d936c1d4a66896ec19,Log weird Content-Dispositions instead of barfing.
spang,2013-08-27 23:53:29,https://api.github.com/repos/nylas/sync-engine/git/commits/e65e6bbe213274ab8198779542217151eecc1178,e65e6bbe213274ab8198779542217151eecc1178,"crispin.py: Correctly set envelope headers.

L O L due to scoping bug, old code was saving a random message's headers
for every message."
spang,2013-08-27 23:36:57,https://api.github.com/repos/nylas/sync-engine/git/commits/0989eee522ee1474ac7e5dc98486a4017a1ad36b,0989eee522ee1474ac7e5dc98486a4017a1ad36b,"crispin.py: Clean up whitespace.

Easier to keep things in my head if I can fit them on my screen."
spang,2013-08-27 23:35:32,https://api.github.com/repos/nylas/sync-engine/git/commits/dbba142ec04ded473bc26bb457370ce19e38cc51,dbba142ec04ded473bc26bb457370ce19e38cc51,"crispin.py: Use a generator for iterating through raw messages.

Go go abstraction."
spang,2013-08-27 22:23:38,https://api.github.com/repos/nylas/sync-engine/git/commits/ff77da24f65207bb7801fa8cebe6663266cf8103,ff77da24f65207bb7801fa8cebe6663266cf8103,"Support updating existing uidvalidity rows on initial sync.

In case of restarts of the script."
spang,2013-08-27 22:04:35,https://api.github.com/repos/nylas/sync-engine/git/commits/095c999c6367ef07e4be4f881378086588ca4fd3,095c999c6367ef07e4be4f881378086588ca4fd3,"Rip UIDVALIDITY checks out of session manager.

This belongs in the sync backend now."
spang,2013-08-27 20:04:51,https://api.github.com/repos/nylas/sync-engine/git/commits/f748e507d3a8cb3a88e11cf42786b0d2ef64e47f,f748e507d3a8cb3a88e11cf42786b0d2ef64e47f,"Fix bugs in sync rewrite.

All the things I didn't get right in my head."
spang,2013-08-27 20:03:44,https://api.github.com/repos/nylas/sync-engine/git/commits/66972513f54090a00659b9ba7f1ca3a243954562,66972513f54090a00659b9ba7f1ca3a243954562,"models.py: Remove useless constructor.

The default constructor created by declarativeis better than this one."
spang,2013-08-27 20:03:06,https://api.github.com/repos/nylas/sync-engine/git/commits/3a4f7cb04b566588848e55130767650b66132653,3a4f7cb04b566588848e55130767650b66132653,models.py: remove unused imports
spang,2013-08-27 03:46:53,https://api.github.com/repos/nylas/sync-engine/git/commits/e6ea8f6707625accfdd889681fd845a503b5d2ae,e6ea8f6707625accfdd889681fd845a503b5d2ae,"Redo some changes from mg.

Got lost in the merge."
spang,2013-08-27 03:36:22,https://api.github.com/repos/nylas/sync-engine/git/commits/449d8b0a85d9ec3da5cd5d23c3b4f726653a2580,449d8b0a85d9ec3da5cd5d23c3b4f726653a2580,"Rewrite initial sync.

Now supports a folder list and records HIGHESTMODSEQ and UIDVALIDITY for
each folder at the end of the first sync."
spang,2013-08-27 03:34:54,https://api.github.com/repos/nylas/sync-engine/git/commits/cfc978b944a901d042aed4b06dfb43c5add8e28c,cfc978b944a901d042aed4b06dfb43c5add8e28c,crispin.py: remove unused tornado import
spang,2013-08-27 03:33:55,https://api.github.com/repos/nylas/sync-engine/git/commits/21650aea6f0c3d465f45b4f5f3e111d1848f28df,21650aea6f0c3d465f45b4f5f3e111d1848f28df,"models.py: Add highestmodseq to UIDValidity.

This commit also removes the __init__ function, which
isn't needed. SQLalchemy declarative classes already
create a default constructor that takes keyword arguments
you can use to set the attributes, which is strictly
*more* useful than this constructor here."
spang,2013-08-27 03:32:40,https://api.github.com/repos/nylas/sync-engine/git/commits/068d07d15b043eb11e39b7377f981499fb288609,068d07d15b043eb11e39b7377f981499fb288609,more useful utility functions
spang,2013-08-26 18:23:54,https://api.github.com/repos/nylas/sync-engine/git/commits/9765e7069e8a929cfdb85356be2ac536c5c48a64,9765e7069e8a929cfdb85356be2ac536c5c48a64,"Doh, dev idle poll on Inbox, not AllMail."
grinich,2013-08-26 21:18:56,https://api.github.com/repos/nylas/sync-engine/git/commits/4ddf5b8fabce39085bfa8e44dd7546835c4e055e,4ddf5b8fabce39085bfa8e44dd7546835c4e055e,compute full body size during metasync
grinich,2013-08-26 21:16:05,https://api.github.com/repos/nylas/sync-engine/git/commits/66c0d0e4ed02ad03eceff8c82fb796aea6911991,66c0d0e4ed02ad03eceff8c82fb796aea6911991,remove confusing logging.
grinich,2013-08-26 08:16:50,https://api.github.com/repos/nylas/sync-engine/git/commits/2fa26a4d56b15f0ca5a4c74a0c76422f878c2446,2fa26a4d56b15f0ca5a4c74a0c76422f878c2446,start size at zero store parts in one directory up to get it out of my greppin way
grinich,2013-08-26 08:15:19,https://api.github.com/repos/nylas/sync-engine/git/commits/b837336e2ab7d67f0ca710380c3ca9e538d4f76b,b837336e2ab7d67f0ca710380c3ca9e538d4f76b,force crispin connect instead of relying on decorator
grinich,2013-08-26 08:14:34,https://api.github.com/repos/nylas/sync-engine/git/commits/4007ef09706d0410275a1df0de29abdee442ed28,4007ef09706d0410275a1df0de29abdee442ed28,add the more_codecs and write failed messages to disk for later testing.
grinich,2013-08-26 08:13:21,https://api.github.com/repos/nylas/sync-engine/git/commits/9558203e1eb5cccd9068b3a71f0283599914d83c,9558203e1eb5cccd9068b3a71f0283599914d83c,Chunk the database queries. Maybe there's a better way to abstract this.
grinich,2013-08-26 08:13:03,https://api.github.com/repos/nylas/sync-engine/git/commits/8dbb5f6e524c18735cbf10dc582114666100e107,8dbb5f6e524c18735cbf10dc582114666100e107,load email from command line
grinich,2013-08-26 08:07:18,https://api.github.com/repos/nylas/sync-engine/git/commits/52978f951ec724da6fb78b023c054422e3e5f41b,52978f951ec724da6fb78b023c054422e3e5f41b,validate google extensions version
grinich,2013-08-26 07:11:58,https://api.github.com/repos/nylas/sync-engine/git/commits/8658844eb363a155254852116e2fa9a0bba7045a,8658844eb363a155254852116e2fa9a0bba7045a,"add the more_codes module, which adds a bunch of codecs that aren't
natively supported in Python by falling back to iconv (libiconv)"
grinich,2013-08-26 04:44:48,https://api.github.com/repos/nylas/sync-engine/git/commits/30596d0288073a49cf21948da59fead3e9c59eb4,30596d0288073a49cf21948da59fead3e9c59eb4,add ipython for crispin repl
grinich,2013-08-26 01:41:31,https://api.github.com/repos/nylas/sync-engine/git/commits/17ad00198a08a62e8bceb842f3d459c094c07f62,17ad00198a08a62e8bceb842f3d459c094c07f62,more encoding bugs and content-type errors
grinich,2013-08-26 01:41:14,https://api.github.com/repos/nylas/sync-engine/git/commits/85ad323527eb58e0b5932280ee5c4f43b9d9652b,85ad323527eb58e0b5932280ee5c4f43b9d9652b,some crude retry logic
grinich,2013-08-26 01:40:23,https://api.github.com/repos/nylas/sync-engine/git/commits/2da475c23197f9fb84181756fda01e9cc21a47b5,2da475c23197f9fb84181756fda01e9cc21a47b5,just log error
spang,2013-08-26 01:32:04,https://api.github.com/repos/nylas/sync-engine/git/commits/d79681abdf71053d090f822b1c8650ae2f250b92,d79681abdf71053d090f822b1c8650ae2f250b92,Dev script for printing IDLE messages.
spang,2013-08-26 00:51:52,https://api.github.com/repos/nylas/sync-engine/git/commits/879c208001561119def57ffc6942841f1ebe3221,879c208001561119def57ffc6942841f1ebe3221,"crispinshell.py: Add refresh capability.

Tired of restarting after timeouts."
spang,2013-08-25 23:57:57,https://api.github.com/repos/nylas/sync-engine/git/commits/221ece5d3c3cf134bd95c9bef05dc55b01c75c5f,221ece5d3c3cf134bd95c9bef05dc55b01c75c5f,metasync.py: Remove dead code.
grinich,2013-08-25 21:01:46,https://api.github.com/repos/nylas/sync-engine/git/commits/9d38c267f7973c5b393c4e521631aa088f7f2bf7,9d38c267f7973c5b393c4e521631aa088f7f2bf7,stringbug
grinich,2013-08-25 21:00:44,https://api.github.com/repos/nylas/sync-engine/git/commits/fac83fc27ee6533bdf763983b64491bc2f83a614,fac83fc27ee6533bdf763983b64491bc2f83a614,"Switch from xlist (deprecated) to special-use mailboxes

Closes https://app.asana.com/0/5241592671238/5007769317047"
grinich,2013-08-24 05:58:32,https://api.github.com/repos/nylas/sync-engine/git/commits/b41d18578961e76a357ecef641b26d77ed9fd76c,b41d18578961e76a357ecef641b26d77ed9fd76c,chunk size
grinich,2013-08-24 05:44:17,https://api.github.com/repos/nylas/sync-engine/git/commits/0c3fdc48336a9f838af240c503b79fdd196b616b,0c3fdc48336a9f838af240c503b79fdd196b616b,ok maybe fewer directories...
grinich,2013-08-24 05:42:30,https://api.github.com/repos/nylas/sync-engine/git/commits/2fead85c40299bd771947a8e838e76a52f3ea5b6,2fead85c40299bd771947a8e838e76a52f3ea5b6,update install instructions to reflect new virtualenv
grinich,2013-08-24 05:27:31,https://api.github.com/repos/nylas/sync-engine/git/commits/4de72f18b813e531e09205a90781998b8cbbeede,4de72f18b813e531e09205a90781998b8cbbeede,progress bar for syncing metadata
grinich,2013-08-24 05:26:19,https://api.github.com/repos/nylas/sync-engine/git/commits/561cdaf4668e7820bca73ae7b3dbb9ba6e8e55e3,561cdaf4668e7820bca73ae7b3dbb9ba6e8e55e3,"add data property to messagepart which takes care of computing size+hash
and writing file to disk in a nested directory structure"
grinich,2013-08-24 03:51:03,https://api.github.com/repos/nylas/sync-engine/git/commits/f6d521a859e1e5fae6cdf54252c4fc9ce0413bba,f6d521a859e1e5fae6cdf54252c4fc9ce0413bba,tab from signupbox to button and enter to submit
grinich,2013-08-24 03:50:08,https://api.github.com/repos/nylas/sync-engine/git/commits/2b6e7f33520c6f4d33f1996e3749b57fb55936c1,2b6e7f33520c6f4d33f1996e3749b57fb55936c1,"- use walk index instead of section for message parts
- store all message headers as json file with with walk index 0"
grinich,2013-08-24 03:48:15,https://api.github.com/repos/nylas/sync-engine/git/commits/4ae623fc54c2a1f412e692f6cac7afd520614047,4ae623fc54c2a1f412e692f6cac7afd520614047,sort by int not string
grinich,2013-08-24 02:41:56,https://api.github.com/repos/nylas/sync-engine/git/commits/63f7ad89a231c4a7d1a1c0b3b0a080010adcba83,63f7ad89a231c4a7d1a1c0b3b0a080010adcba83,"- decode everything to unicode message ingestion using fork of encoding
  module from lampson
- separate and decode individual message parts
- adding FolderMeta object to keep mapping of g_msgid, uid, folder
- better support for int'l headers -> unicode
- removes charset/encoding from MessageMeta (no longer needed w/ unicode)
- store Content-Disposition as enum (inline or attachment)
- store Content-ID
- store Content-Type as enum for common types, or string for others to
  save space. (probably can use this strategy elsewhere too.)
- replace previous hacky sqlalchemy serialization with built-in pickling
- add sketch of AttachmentParts objects for user-added message attachments"
grinich,2013-08-23 04:53:35,https://api.github.com/repos/nylas/sync-engine/git/commits/68eb9e40a145c17c94f3ea2871d2c3a658463f67,68eb9e40a145c17c94f3ea2871d2c3a658463f67,"parse and store message body parts sortof.
this is still fucked but kind of works.
not yet writing parts to disk or s3, but it should all be there.
need to make sure it's correctly decoding attachments and not corrupting anything"
grinich,2013-08-22 07:46:49,https://api.github.com/repos/nylas/sync-engine/git/commits/6382650be42a148e588e887a90b7e96468e35c15,6382650be42a148e588e887a90b7e96468e35c15,"Add command line option to pass in email address to sync.

ex. usage: $ python server/metasync.py --USER_EMAIL=mgrinich@gmail.com"
grinich,2013-08-23 00:33:48,https://api.github.com/repos/nylas/sync-engine/git/commits/6d212f05eea1567a433bd2db4fe466c9ff3e8586,6d212f05eea1567a433bd2db4fe466c9ff3e8586,fix some imports and lowercase mx records
grinich,2013-08-22 07:04:19,https://api.github.com/repos/nylas/sync-engine/git/commits/f8f3be0111ab3c40e24814c7a10a6da76284c5d9,f8f3be0111ab3c40e24814c7a10a6da76284c5d9,add boto
grinich,2013-08-22 07:04:12,https://api.github.com/repos/nylas/sync-engine/git/commits/3ecef02fddcd27adfba449de6c75b0a14d954869,3ecef02fddcd27adfba449de6c75b0a14d954869,more sending crap
grinich,2013-08-22 07:03:09,https://api.github.com/repos/nylas/sync-engine/git/commits/28491b93cddc75a110fe7397e2b9bde01ef7a8d9,28491b93cddc75a110fe7397e2b9bde01ef7a8d9,invalid x symbol
grinich,2013-08-22 07:02:45,https://api.github.com/repos/nylas/sync-engine/git/commits/c8012368c121228e6ff3be9ce0f53c6bde4cff3c,c8012368c121228e6ff3be9ce0f53c6bde4cff3c,spacing
spang,2013-08-23 00:31:52,https://api.github.com/repos/nylas/sync-engine/git/commits/07be9b249d4c415492db48524b44a5beeaac9704,07be9b249d4c415492db48524b44a5beeaac9704,"Switch back to using envelope headers that we used before.

Things like email addresses are parsed in the envelope. To keep
the database the same, let's continue using them instead of
headers parsed from the body."
spang,2013-08-22 03:55:26,https://api.github.com/repos/nylas/sync-engine/git/commits/8ef2f465e52c56783a0d75815dc9b8a54fd21b7f,8ef2f465e52c56783a0d75815dc9b8a54fd21b7f,"Refactor metasync to batch download using BODY.PEEK[].

We need to pull out messages in as big chunks as we can due to network
latency."
spang,2013-08-22 03:52:29,https://api.github.com/repos/nylas/sync-engine/git/commits/3ac4e12ddd42d2ece98b85a3a398c209c3d64848,3ac4e12ddd42d2ece98b85a3a398c209c3d64848,A dev shell for crispin.
spang,2013-08-19 21:46:25,https://api.github.com/repos/nylas/sync-engine/git/commits/db5c1c6962c5f2225d7628adb2f61237f84e6f12,db5c1c6962c5f2225d7628adb2f61237f84e6f12,"Don't require cython/zerorpc/zmq for now.

I'm having some problem with git/pip/installing specific tags from git.
Will deal later."
grinich,2013-08-22 04:08:06,https://api.github.com/repos/nylas/sync-engine/git/commits/0b01cbadf12178e4e3c26fe2fe597ed28812fb8d,0b01cbadf12178e4e3c26fe2fe597ed28812fb8d,add dnspython
grinich,2013-08-22 02:44:40,https://api.github.com/repos/nylas/sync-engine/git/commits/53d2ae21a498569494437dba5d2b5ad8ffbe50fd,53d2ae21a498569494437dba5d2b5ad8ffbe50fd,already logged in screen
grinich,2013-08-22 02:41:11,https://api.github.com/repos/nylas/sync-engine/git/commits/c3429a7a029c328bffd85b58041c56376f776e97,c3429a7a029c328bffd85b58041c56376f776e97,longer rpc timeout
grinich,2013-08-22 02:40:19,https://api.github.com/repos/nylas/sync-engine/git/commits/6f22098d55ff96fa0e7753a76ce86f97adad664f,6f22098d55ff96fa0e7753a76ce86f97adad664f,"- new homepage design
- validate email points to gmail/google mx server before signup"
grinich,2013-08-22 02:02:10,https://api.github.com/repos/nylas/sync-engine/git/commits/4fc15b8f97024c63da7da272943b397af8f764ec,4fc15b8f97024c63da7da272943b397af8f764ec,use typekit for all fonts (now on a paid plan)
grinich,2013-08-21 22:14:32,https://api.github.com/repos/nylas/sync-engine/git/commits/bfa702e3973bb1e9c774dac88eda74400e093d05,bfa702e3973bb1e9c774dac88eda74400e093d05,set MessageMeta.sender_addr instead of MessageMeta.sender (doh!)
grinich,2013-08-20 19:29:33,https://api.github.com/repos/nylas/sync-engine/git/commits/53f03cb52a5c9f75dda44a6148ab6f7fab9a3891,53f03cb52a5c9f75dda44a6148ab6f7fab9a3891,store UIDVALIDITY
grinich,2013-08-20 19:29:04,https://api.github.com/repos/nylas/sync-engine/git/commits/34a8d65105de81de34acb3781c74b4e09f968527,34a8d65105de81de34acb3781c74b4e09f968527,setting base URL in angular so no longer need to webify_links with target=_blank
grinich,2013-08-20 17:31:44,https://api.github.com/repos/nylas/sync-engine/git/commits/4c5e34f18ce9a735634403c15640b56326248887,4c5e34f18ce9a735634403c15640b56326248887,oauth is done automatically now
grinich,2013-08-20 00:33:57,https://api.github.com/repos/nylas/sync-engine/git/commits/2b47a97b2c90b267f2acd68d5cddad1a125a8ffd,2b47a97b2c90b267f2acd68d5cddad1a125a8ffd,timeout alert
grinich,2013-08-20 00:16:55,https://api.github.com/repos/nylas/sync-engine/git/commits/d6a85c31879305cd180a563e3cea6b372d9af191,d6a85c31879305cd180a563e3cea6b372d9af191,rename angular directory to web_client for clarity
grinich,2013-08-20 00:14:19,https://api.github.com/repos/nylas/sync-engine/git/commits/bba5f95e84d45a7b5e8f4383f0cceb47a7efe9da,bba5f95e84d45a7b5e8f4383f0cceb47a7efe9da,update AngularJS to v1.0.7
grinich,2013-08-20 00:06:51,https://api.github.com/repos/nylas/sync-engine/git/commits/20a2a1d96eb5f59a0ddb489403bb61eb27458c53,20a2a1d96eb5f59a0ddb489403bb61eb27458c53,fix date ms
grinich,2013-08-19 23:49:19,https://api.github.com/repos/nylas/sync-engine/git/commits/31b021b95142f853a50b9a411eaaccbade5ffa0f,31b021b95142f853a50b9a411eaaccbade5ffa0f,min width
grinich,2013-08-19 23:49:08,https://api.github.com/repos/nylas/sync-engine/git/commits/6b5184dbb28d878253c2b9f00f5e4322363d4d6f,6b5184dbb28d878253c2b9f00f5e4322363d4d6f,handle mailto links sortof
grinich,2013-08-19 23:30:01,https://api.github.com/repos/nylas/sync-engine/git/commits/dc130bc199d007956e80f9ffd811c40f29a44fb0,dc130bc199d007956e80f9ffd811c40f29a44fb0,send button now does something. also fix some styling.
grinich,2013-08-19 23:29:25,https://api.github.com/repos/nylas/sync-engine/git/commits/33c87825538ec9083eec9dcb4ae5c56346b93610,33c87825538ec9083eec9dcb4ae5c56346b93610,"use User object instead of hardcoding my email address
some sending updates to postel
require login for a few more controllers"
grinich,2013-08-19 22:02:20,https://api.github.com/repos/nylas/sync-engine/git/commits/70684301608d7340bbbfc6246a381b99ecfa2c14,70684301608d7340bbbfc6246a381b99ecfa2c14,fix the message part sync and some encoding bugfixes
grinich,2013-08-19 06:56:17,https://api.github.com/repos/nylas/sync-engine/git/commits/dd1ca12719af94b77175f6817a31eed101488da7,dd1ca12719af94b77175f6817a31eed101488da7,"- metasync now stores message parts
- load message bodies in app from gmail id"
grinich,2013-08-19 00:49:35,https://api.github.com/repos/nylas/sync-engine/git/commits/66f53433394f88e91fcda02d4420eee31c651d31,66f53433394f88e91fcda02d4420eee31c651d31,move to hackpad
grinich,2013-08-19 00:26:40,https://api.github.com/repos/nylas/sync-engine/git/commits/44caa6f9db0f6ced01e5ff5fa071bff9189f7730,44caa6f9db0f6ced01e5ff5fa071bff9189f7730,hacks to get the message metadata synced to sqlalchemy
grinich,2013-08-12 22:32:15,https://api.github.com/repos/nylas/sync-engine/git/commits/ef95bb55ef443a741314868e872b65a9c68a6aaf,ef95bb55ef443a741314868e872b65a9c68a6aaf,fix serialization and metasync improvements
grinich,2013-08-12 21:40:24,https://api.github.com/repos/nylas/sync-engine/git/commits/961c50fdfc38e7e77060729971e4259cae26ea31,961c50fdfc38e7e77060729971e4259cae26ea31,"Switch to use MySQL via SQLalchemy instead of Mongo.

Goodbye friend. I hardly knew ye.

A bunch of other smaller bugfixes too."
grinich,2013-08-11 04:17:48,https://api.github.com/repos/nylas/sync-engine/git/commits/34d556c93cb97077a7f9fa51cd43285aa662d1c5,34d556c93cb97077a7f9fa51cd43285aa662d1c5,Fix message list in UI. Message body still broken
grinich,2013-08-07 03:22:19,https://api.github.com/repos/nylas/sync-engine/git/commits/99832e5d8146d84076519fb0e195083f095bd32c,99832e5d8146d84076519fb0e195083f095bd32c,no tornado.gen
grinich,2013-08-07 03:22:06,https://api.github.com/repos/nylas/sync-engine/git/commits/35a498ca8c77c114750457be9f2c3f6713723838,35a498ca8c77c114750457be9f2c3f6713723838,more font fixes
gnprice,2013-08-06 02:47:56,https://api.github.com/repos/nylas/sync-engine/git/commits/8c4d1aff58abac93d854cca58eea1ffc3e09d76d,8c4d1aff58abac93d854cca58eea1ffc3e09d76d,Drop default argument we're not using
gnprice,2013-08-06 02:45:22,https://api.github.com/repos/nylas/sync-engine/git/commits/ec1ef1e25acf0495f0a57bf7c80ec6f58f5637b4,ec1ef1e25acf0495f0a57bf7c80ec6f58f5637b4,Get real user's email address in some places
grinich,2013-08-06 02:28:47,https://api.github.com/repos/nylas/sync-engine/git/commits/a12bfb254980aef0055231261683769470bcd46c,a12bfb254980aef0055231261683769470bcd46c,"Fonts! Adding the Proxima Nova suite.
Right now this loads everything, which is silly because that's like 5.6MB."
gnprice,2013-08-06 02:25:52,https://api.github.com/repos/nylas/sync-engine/git/commits/c990be06470f42dc8e1291cfa226384c6b02ddc4,c990be06470f42dc8e1291cfa226384c6b02ddc4,"Print whole stack for this error

Should probably use the same helper function in other places where we
catch an error and log it before moving on, too."
gnprice,2013-08-06 02:08:19,https://api.github.com/repos/nylas/sync-engine/git/commits/39c9e7dd34830eb70ce412c4feb1e5eda66aa08a,39c9e7dd34830eb70ce412c4feb1e5eda66aa08a,"Add history to console

The history goes in its own file, separate from your general
Python-prompt history if you maintain such a thing."
gnprice,2013-08-06 02:01:38,https://api.github.com/repos/nylas/sync-engine/git/commits/0c89453744223af5fb5ba68dd9d2564bccfa20b8,0c89453744223af5fb5ba68dd9d2564bccfa20b8,"Add ""./inbox.py console"" command for a Python console"
gnprice,2013-08-06 01:41:20,https://api.github.com/repos/nylas/sync-engine/git/commits/76dab4bcc991854dff5771f6f30be97cfcff9b08,76dab4bcc991854dff5771f6f30be97cfcff9b08,Handle mongod start/stop a bit better
grinich,2013-08-06 01:47:39,https://api.github.com/repos/nylas/sync-engine/git/commits/77a18cfc64acf0e2f1bce4800deee732f47458f1,77a18cfc64acf0e2f1bce4800deee732f47458f1,fixes for firefox
grinich,2013-08-06 01:09:16,https://api.github.com/repos/nylas/sync-engine/git/commits/a460c6b7f10f54702e028b4abb334720517f09ea,a460c6b7f10f54702e028b4abb334720517f09ea,Move docs to Hackpad. Go to http://inbox.hackpad.com
grinich,2013-08-05 23:40:45,https://api.github.com/repos/nylas/sync-engine/git/commits/e478c7d1fe3855166968963fae56c6a0ddfd7ed5,e478c7d1fe3855166968963fae56c6a0ddfd7ed5,This is broken. :( But a beginning for actual message data storage.
grinich,2013-07-31 18:41:41,https://api.github.com/repos/nylas/sync-engine/git/commits/9541ff979654b7f75b8a37bbc2ad2337a48edb44,9541ff979654b7f75b8a37bbc2ad2337a48edb44,some *very* basic explorations in running idler through zerorpc
grinich,2013-07-31 18:38:34,https://api.github.com/repos/nylas/sync-engine/git/commits/459d754b4bf28aea403e8ef408aa32c2c4926aa9,459d754b4bf28aea403e8ef408aa32c2c4926aa9,add jsonRPC python lib
grinich,2013-07-31 18:35:36,https://api.github.com/repos/nylas/sync-engine/git/commits/98c4b9a08075a4941f9ea8c45d844991df44233c,98c4b9a08075a4941f9ea8c45d844991df44233c,cruft cleanup
grinich,2013-07-31 18:24:42,https://api.github.com/repos/nylas/sync-engine/git/commits/9d40f074b2c2a7e9d8116cd2a9f0423d1af528e9,9d40f074b2c2a7e9d8116cd2a9f0423d1af528e9,"remove tornado callback stuff since I want to move to greenlets. also breaking a bunch of stuff here, but all in the name of progress"
grinich,2013-07-31 18:23:41,https://api.github.com/repos/nylas/sync-engine/git/commits/4a07a50c6e831d9a2bed038a8bd8c1e8cf781770,4a07a50c6e831d9a2bed038a8bd8c1e8cf781770,more UI changes
grinich,2013-07-31 17:07:07,https://api.github.com/repos/nylas/sync-engine/git/commits/56f4bd269f93398754477780af110c3584ef5407,56f4bd269f93398754477780af110c3584ef5407,ui changes
grinich,2013-07-29 20:35:35,https://api.github.com/repos/nylas/sync-engine/git/commits/66317811b011ff1b8328f9b8d8e167a61486d6e8,66317811b011ff1b8328f9b8d8e167a61486d6e8,crispin cleanup
grinich,2013-07-29 06:57:04,https://api.github.com/repos/nylas/sync-engine/git/commits/b92abe5d9520c550db575056e9c1e71d5485bcde,b92abe5d9520c550db575056e9c1e71d5485bcde,bump imapclient
grinich,2013-07-29 04:13:11,https://api.github.com/repos/nylas/sync-engine/git/commits/aff164594a583dcfd7b98945c06ae0829f7a70ce,aff164594a583dcfd7b98945c06ae0829f7a70ce,cleanup and remove broken imports
grinich,2013-07-28 22:45:40,https://api.github.com/repos/nylas/sync-engine/git/commits/84835795f194f3b11b174e1bb28a4a17352083f4,84835795f194f3b11b174e1bb28a4a17352083f4,fixes for reply directive
grinich,2013-07-28 08:36:36,https://api.github.com/repos/nylas/sync-engine/git/commits/67960d602d2b5232ddd063cee2cb8813b414b81a,67960d602d2b5232ddd063cee2cb8813b414b81a,ignore things
grinich,2013-07-28 08:31:39,https://api.github.com/repos/nylas/sync-engine/git/commits/ca679758c22502eeb725f7280a58b7c775808aad,ca679758c22502eeb725f7280a58b7c775808aad,big overhaul. new UI with javascript layout. buttons. removing cruft.
grinich,2013-07-20 08:17:39,https://api.github.com/repos/nylas/sync-engine/git/commits/5f1354bf5aa4b8844d62067982d6ba9e8e9d75b8,5f1354bf5aa4b8844d62067982d6ba9e8e9d75b8,crude file uploader based on https://github.com/clouddueling/angularjs-drag-n-drop.git
grinich,2013-07-20 06:34:33,https://api.github.com/repos/nylas/sync-engine/git/commits/ad7d3dcbe02e582e2611c38fe93e6c1f5e754223,ad7d3dcbe02e582e2611c38fe93e6c1f5e754223,some controller mods
grinich,2013-07-20 06:34:12,https://api.github.com/repos/nylas/sync-engine/git/commits/ffbab780fb589adbea438e494fc30bcafad6e4c7,ffbab780fb589adbea438e494fc30bcafad6e4c7,move around some encoding stuff
grinich,2013-07-19 03:23:14,https://api.github.com/repos/nylas/sync-engine/git/commits/7c615c83946db51807a579775c610f3e4f087591,7c615c83946db51807a579775c610f3e4f087591,I should really do this more often
grinich,2013-07-16 07:44:14,https://api.github.com/repos/nylas/sync-engine/git/commits/0b25cae84306403246af4ab1cf55375c74193202,0b25cae84306403246af4ab1cf55375c74193202,start/stop mongo easier
grinich,2013-07-16 07:44:06,https://api.github.com/repos/nylas/sync-engine/git/commits/1daf641986508874b55562120451199f53a93208,1daf641986508874b55562120451199f53a93208,cruft
grinich,2013-07-16 07:43:55,https://api.github.com/repos/nylas/sync-engine/git/commits/239729a2b379e72f5dc0ba06e5021a086cbba4c1,239729a2b379e72f5dc0ba06e5021a086cbba4c1,new socket-io based JSON-RPC on server
grinich,2013-07-16 07:41:56,https://api.github.com/repos/nylas/sync-engine/git/commits/e3ebd1972b3dc2d162c13a61d1c1193a6590df20,e3ebd1972b3dc2d162c13a61d1c1193a6590df20,load js in new location
grinich,2013-07-16 07:35:20,https://api.github.com/repos/nylas/sync-engine/git/commits/659eb72e88f95cd20e0d7a8a9ad6b1ebe82185dd,659eb72e88f95cd20e0d7a8a9ad6b1ebe82185dd,cruft
grinich,2013-07-16 07:35:15,https://api.github.com/repos/nylas/sync-engine/git/commits/e636fc439378a836dc39856824742e802e53e49c,e636fc439378a836dc39856824742e802e53e49c,move ng services and controllers to directories
grinich,2013-07-16 07:34:12,https://api.github.com/repos/nylas/sync-engine/git/commits/19e1c45a4f39240c91c76dfbf02cdd52b3578bdc,19e1c45a4f39240c91c76dfbf02cdd52b3578bdc,syntax cleanup
grinich,2013-07-16 07:33:49,https://api.github.com/repos/nylas/sync-engine/git/commits/8bbf6a7ed465b8f6145931cdbf25aabbf5de5333,8bbf6a7ed465b8f6145931cdbf25aabbf5de5333,Move onLoad resizing out of controller
grinich,2013-07-15 09:18:02,https://api.github.com/repos/nylas/sync-engine/git/commits/e36b551a3988d07b6f1912f164ab06c49e41dbc1,e36b551a3988d07b6f1912f164ab06c49e41dbc1,better auth and failure mode
grinich,2013-07-15 09:16:22,https://api.github.com/repos/nylas/sync-engine/git/commits/83731ccdd4cda1855f1888a1e210ed83fc4e7545,83731ccdd4cda1855f1888a1e210ed83fc4e7545,Fix some encoding bugs. Add bleach subrepo.
grinich,2013-07-14 23:34:43,https://api.github.com/repos/nylas/sync-engine/git/commits/ec4d38aeedc94db5afce0d0c84e27b0a0f3fc768,ec4d38aeedc94db5afce0d0c84e27b0a0f3fc768,move keys to secrets.py
grinich,2013-07-14 22:52:04,https://api.github.com/repos/nylas/sync-engine/git/commits/c2b434265dfe602be20bfeab6a2c7662451c1745,c2b434265dfe602be20bfeab6a2c7662451c1745,working mongodb
grinich,2013-07-14 11:52:01,https://api.github.com/repos/nylas/sync-engine/git/commits/aef9a4c3e31bd315c402ebdc0c88038fcf6bb96a,aef9a4c3e31bd315c402ebdc0c88038fcf6bb96a,file viewing bug
grinich,2013-07-14 11:51:50,https://api.github.com/repos/nylas/sync-engine/git/commits/b3ae5887e3cbca9b2f3909eb8a81da0ce115c3ed,b3ae5887e3cbca9b2f3909eb8a81da0ce115c3ed,better token storage in module
grinich,2013-07-14 05:53:56,https://api.github.com/repos/nylas/sync-engine/git/commits/4c493bfc62250e280b374a67cf7dabbf68b6c2d6,4c493bfc62250e280b374a67cf7dabbf68b6c2d6,do the proper thing with mongod
grinich,2013-07-14 04:57:48,https://api.github.com/repos/nylas/sync-engine/git/commits/46e3798563f5d6791449957a9ed928015721d435,46e3798563f5d6791449957a9ed928015721d435,oauth fixes
grinich,2013-07-14 03:57:51,https://api.github.com/repos/nylas/sync-engine/git/commits/bdaddf4e3fbf0f790edaa9869f64596f78267339,bdaddf4e3fbf0f790edaa9869f64596f78267339,clean up oauth and start looking into adding mongodb
grinich,2013-07-13 22:34:50,https://api.github.com/repos/nylas/sync-engine/git/commits/ad4ed5be5ac7b916bae63d0af13865b9844ff50a,ad4ed5be5ac7b916bae63d0af13865b9844ff50a,remove earlier feebile attempts at coroutines ugh
grinich,2013-07-13 22:33:07,https://api.github.com/repos/nylas/sync-engine/git/commits/d3fc13d78cd171aa9cab8d5aedd460bb1d2b1b03,d3fc13d78cd171aa9cab8d5aedd460bb1d2b1b03,some more fixes to oauth but not storing the tokens anywhere
grinich,2013-07-10 08:58:54,https://api.github.com/repos/nylas/sync-engine/git/commits/b975cdaf063523751c7809f4cbd7c641b67de83f,b975cdaf063523751c7809f4cbd7c641b67de83f,"checkpoint, but broken"
grinich,2013-07-10 08:55:41,https://api.github.com/repos/nylas/sync-engine/git/commits/986cb9c57fa0311e499a4a94e3c59425736c4a91,986cb9c57fa0311e499a4a94e3c59425736c4a91,update packages
grinich,2013-07-10 08:40:51,https://api.github.com/repos/nylas/sync-engine/git/commits/15db09f65263fd4b01eed6944123a056f00138f4,15db09f65263fd4b01eed6944123a056f00138f4,dont have xoauth in package
gnprice,2013-06-22 23:27:54,https://api.github.com/repos/nylas/sync-engine/git/commits/859c615f2b75de3cc3d9ebbf16306be1fdbf2d89,859c615f2b75de3cc3d9ebbf16306be1fdbf2d89,Fixes from cloning from scratch
grinich,2013-07-10 03:28:33,https://api.github.com/repos/nylas/sync-engine/git/commits/c8f3ffc61c9713950ee86824a0b92e8173e916e4,c8f3ffc61c9713950ee86824a0b92e8173e916e4,lots of changes to frontend
grinich,2013-06-22 23:34:49,https://api.github.com/repos/nylas/sync-engine/git/commits/eb70553a557139e34f442fe61855cc0be94a1a25,eb70553a557139e34f442fe61855cc0be94a1a25,Add accidentally ignored angular libraries
grinich,2013-06-22 23:25:22,https://api.github.com/repos/nylas/sync-engine/git/commits/f5a37841e219c9939f2877d9de93c5172737f0ff,f5a37841e219c9939f2877d9de93c5172737f0ff,update imaplib2 submodule
grinich,2013-06-05 01:22:53,https://api.github.com/repos/nylas/sync-engine/git/commits/5f100e389a821683afd99d73ddd65c286f1d31a6,5f100e389a821683afd99d73ddd65c286f1d31a6,rollback imapclient because something is broken
grinich,2013-06-05 01:22:36,https://api.github.com/repos/nylas/sync-engine/git/commits/7381074ae1061f9130d8343fa00553c794e818c1,7381074ae1061f9130d8343fa00553c794e818c1,parts of message viewer into their own directives
grinich,2013-06-04 23:15:42,https://api.github.com/repos/nylas/sync-engine/git/commits/925959739e11971224b9b2a46bfe42210f8f73ab,925959739e11971224b9b2a46bfe42210f8f73ab,update imapclient and imaplib2 subrepos
grinich,2013-06-04 23:08:37,https://api.github.com/repos/nylas/sync-engine/git/commits/218ca5c78e1531a5546f99dfb544ca886e99fa65,218ca5c78e1531a5546f99dfb544ca886e99fa65,not
grinich,2013-06-04 22:57:03,https://api.github.com/repos/nylas/sync-engine/git/commits/fcb3f2cc85ba5bd40dadd0cc3126f5f4e55aa835,fcb3f2cc85ba5bd40dadd0cc3126f5f4e55aa835,some cleanupt
grinich,2013-06-04 22:56:54,https://api.github.com/repos/nylas/sync-engine/git/commits/78b534829683f86e6da9d34a7e86422580a14b2f,78b534829683f86e6da9d34a7e86422580a14b2f,move css to objects and use ng-style
grinich,2013-06-04 21:52:20,https://api.github.com/repos/nylas/sync-engine/git/commits/88c63e41ad98c9a49ce74ba1b9170f5b0eb6673e,88c63e41ad98c9a49ce74ba1b9170f5b0eb6673e,Yay now supports attachments
grinich,2013-06-01 01:20:05,https://api.github.com/repos/nylas/sync-engine/git/commits/e23661e789d2c20998289eea36d599a4fcb20f01,e23661e789d2c20998289eea36d599a4fcb20f01,A much better prototype. Probably going to make a few modifications tonight and show this to YC tomorrow.
grinich,2013-05-30 22:19:02,https://api.github.com/repos/nylas/sync-engine/git/commits/df94bf073eaba6b99f7b0ba17cc85affbced773b,df94bf073eaba6b99f7b0ba17cc85affbced773b,data model checkpoint
grinich,2013-05-26 23:37:14,https://api.github.com/repos/nylas/sync-engine/git/commits/0c9351d3adde116f072c2fe7ab667af11b718010,0c9351d3adde116f072c2fe7ab667af11b718010,moo
grinich,2013-05-22 18:57:52,https://api.github.com/repos/nylas/sync-engine/git/commits/be3a9a58c914d07eefa5c5033b1356e333d0464e,be3a9a58c914d07eefa5c5033b1356e333d0464e,ohgod dont look at this
grinich,2013-05-19 04:26:06,https://api.github.com/repos/nylas/sync-engine/git/commits/fa8c8b0dd90637e1c8f76475b41a3240d1fea816,fa8c8b0dd90637e1c8f76475b41a3240d1fea816,bunch of stuff including intitial multithreading support
grinich,2013-05-14 22:26:54,https://api.github.com/repos/nylas/sync-engine/git/commits/7408fcea75932c4d6725ff801d71c5c58f7ddec4,7408fcea75932c4d6725ff801d71c5c58f7ddec4,hoomygod
grinich,2013-05-13 08:43:54,https://api.github.com/repos/nylas/sync-engine/git/commits/df382badd1d5f60f681c1b80dd90443f6121b170,df382badd1d5f60f681c1b80dd90443f6121b170,more work
grinich,2013-05-11 22:21:11,https://api.github.com/repos/nylas/sync-engine/git/commits/69b7bd297a07d5122b551a1d0007de7ff37353e2,69b7bd297a07d5122b551a1d0007de7ff37353e2,some housekeeping and angular stuff
grinich,2013-05-11 22:20:47,https://api.github.com/repos/nylas/sync-engine/git/commits/73cfeab69a329f0706bbdd6f28f1bf16edb8bd67,73cfeab69a329f0706bbdd6f28f1bf16edb8bd67,somer more niceities for starting server
grinich,2013-05-11 01:24:38,https://api.github.com/repos/nylas/sync-engine/git/commits/88dee166a978b105d98ae4dfa4d0f46dd94e2acf,88dee166a978b105d98ae4dfa4d0f46dd94e2acf,Move server into folder and add top-level way of launching
grinich,2013-05-09 04:47:54,https://api.github.com/repos/nylas/sync-engine/git/commits/09002b80bf1758dda3a12d4dca4326ea409ffefb,09002b80bf1758dda3a12d4dca4326ea409ffefb,Remove some non-socket web calls and housekeeping
grinich,2013-05-09 03:58:45,https://api.github.com/repos/nylas/sync-engine/git/commits/402f2a7650a37cb3f17229dd61889653be453ab7,402f2a7650a37cb3f17229dd61889653be453ab7,More angular stuff. Add wire protocol via socket.io. Basic message fetching. No javascript message models yet.
grinich,2013-05-06 06:57:13,https://api.github.com/repos/nylas/sync-engine/git/commits/b3098619ad2ee085e7e18355976fd33a1fe83151,b3098619ad2ee085e7e18355976fd33a1fe83151,lots of crap some angular
grinich,2013-05-01 01:08:40,https://api.github.com/repos/nylas/sync-engine/git/commits/4abc5795457193d5cfb9f06592b4b5db5bc95f82,4abc5795457193d5cfb9f06592b4b5db5bc95f82,Adding welcome page. Let's do more angular!
grinich,2013-04-29 23:57:44,https://api.github.com/repos/nylas/sync-engine/git/commits/b1b9cad34e44ffc2ea505f6e73c492fc5c7eb633,b1b9cad34e44ffc2ea505f6e73c492fc5c7eb633,initial angular stuff
grinich,2013-04-29 23:54:54,https://api.github.com/repos/nylas/sync-engine/git/commits/ab7d553b42e506ea4d3a0fc1e046c60847b5d642,ab7d553b42e506ea4d3a0fc1e046c60847b5d642,+ last commit. not sure why github for mac is missing lines
grinich,2013-04-29 23:54:16,https://api.github.com/repos/nylas/sync-engine/git/commits/701412b3b07f6c0c624187b71fdd12003180fac9,701412b3b07f6c0c624187b71fdd12003180fac9,+ last commit
grinich,2013-04-29 23:52:18,https://api.github.com/repos/nylas/sync-engine/git/commits/6aa98354bf65f988d0f3c93b71110392c2c052d9,6aa98354bf65f988d0f3c93b71110392c2c052d9,"Batch fetch thread_ids using crazy IMAP 'OR' command.

This is still pretty slow, but at least we don't have to do it
sequentially for every item in the folder. Later we should add the
ability to fetch by X items at once so we can partially update the UI,
and test what is a good number tradeoff. (Maybe like 10 or 15?)"
grinich,2013-04-29 23:49:39,https://api.github.com/repos/nylas/sync-engine/git/commits/152c7b7b8200dc2b10b41fa51b36bd9a2e6f45d6,152c7b7b8200dc2b10b41fa51b36bd9a2e6f45d6,linting + typos
grinich,2013-04-29 23:49:25,https://api.github.com/repos/nylas/sync-engine/git/commits/b946fba50182c557bd493c391b621de846976b06,b946fba50182c557bd493c391b621de846976b06,Fix some typos and inconsistencies in thread model
grinich,2013-04-29 23:44:31,https://api.github.com/repos/nylas/sync-engine/git/commits/835904dc1a6417bd9dcd67db1c1bc7152039c2ff,835904dc1a6417bd9dcd67db1c1bc7152039c2ff,Use timezone information for message dates
grinich,2013-04-28 03:50:00,https://api.github.com/repos/nylas/sync-engine/git/commits/361eb17a93df32b83ff8ebc4e5b50d5ba42ef7b4,361eb17a93df32b83ff8ebc4e5b50d5ba42ef7b4,Include our own version of IMAPclient because it's probably going to change. Also change requirements to pull from the packages directory for this.
grinich,2013-04-28 00:08:04,https://api.github.com/repos/nylas/sync-engine/git/commits/9967c28bd3ee0b5208e1e2022af71008722d8dda,9967c28bd3ee0b5208e1e2022af71008722d8dda,now we have a name
grinich,2013-04-28 00:02:35,https://api.github.com/repos/nylas/sync-engine/git/commits/998593d0ff377ee193ae6e7b558629256e564f1c,998593d0ff377ee193ae6e7b558629256e564f1c,Remove testing code from crispin __init__.py and move the import in client.py. For some reason runnning app.py one directory up wasn't finding imapclient installed.
grinich,2013-04-27 23:48:24,https://api.github.com/repos/nylas/sync-engine/git/commits/4b4e004a1193483be8736dda3f2c4900b6bde6c6,4b4e004a1193483be8736dda3f2c4900b6bde6c6,Better message for generating oauth
grinich,2013-04-27 22:19:08,https://api.github.com/repos/nylas/sync-engine/git/commits/dfc6835b2f73455409b9281e4866c525dd19f82f,dfc6835b2f73455409b9281e4866c525dd19f82f,Don't mave xoauth.py be executable. Creating oauth credentials should be built into the app.
grinich,2013-04-22 01:46:33,https://api.github.com/repos/nylas/sync-engine/git/commits/4e55ccc32b42839722d7bd3a2dcf91e8146e84f1,4e55ccc32b42839722d7bd3a2dcf91e8146e84f1,Add note about rebasing commits
spang,2013-04-20 19:41:52,https://api.github.com/repos/nylas/sync-engine/git/commits/3cadfbdb999d7b4bfb15eb82c8242d06f5a712b8,3cadfbdb999d7b4bfb15eb82c8242d06f5a712b8,Link to Google python style guide in README.md.
spang,2013-04-20 19:37:33,https://api.github.com/repos/nylas/sync-engine/git/commits/f2e122d4f0bca771d0e7a11b1590e8bbe1c191b0,f2e122d4f0bca771d0e7a11b1590e8bbe1c191b0,A couple more RFCs I want to be able to reference offline.
spang,2013-04-20 19:36:07,https://api.github.com/repos/nylas/sync-engine/git/commits/2655ad2d6fbf608073dc0be546239cc6a7faf2cc,2655ad2d6fbf608073dc0be546239cc6a7faf2cc,Fix bugs in last push. Whoops.
spang,2013-04-20 19:31:32,https://api.github.com/repos/nylas/sync-engine/git/commits/932d8ef87b8a88ef9b83ad5ecd26a09a61aac816,932d8ef87b8a88ef9b83ad5ecd26a09a61aac816,"app.py: Use new crispin refactor.

We can use a global client for now, since we're just going to
throw this code away soon anyway."
spang,2013-04-20 19:30:31,https://api.github.com/repos/nylas/sync-engine/git/commits/e544a23a9d363907419965b31a18f786ca47a329,e544a23a9d363907419965b31a18f786ca47a329,"crispin: Refactor to client package.

We now create a crispin client for every server connection, so we can have
more than one connection at a time. (This still needs the 'auth' backend to
be refactored to allow multiple accounts.)

I also cleaned up a few pieces here and there to be a bit more pythonic."
spang,2013-04-20 19:16:00,https://api.github.com/repos/nylas/sync-engine/git/commits/cb599952eb012fad82fc363c8790ef3d60ca91ea,cb599952eb012fad82fc363c8790ef3d60ca91ea,And RFC-2387. Who could forget that!
spang,2013-04-20 17:38:32,https://api.github.com/repos/nylas/sync-engine/git/commits/2296970054c77642fcaccb93079434a2d55b204d,2296970054c77642fcaccb93079434a2d55b204d,An invitation to start musing about names.
spang,2013-04-20 17:29:02,https://api.github.com/repos/nylas/sync-engine/git/commits/d1604f23a1272128e686a25f163a3cbc6b0b21fd,d1604f23a1272128e686a25f163a3cbc6b0b21fd,You never know when you might need RFC-0822.
spang,2013-04-20 17:28:11,https://api.github.com/repos/nylas/sync-engine/git/commits/b65dd239f7d662798e359e7e21b682a30170d72e,b65dd239f7d662798e359e7e21b682a30170d72e,A few musings on the ideal company.
spang,2013-04-20 15:40:37,https://api.github.com/repos/nylas/sync-engine/git/commits/457831a2a94458ed59f6df7fc7f49e1cd7a48fa5,457831a2a94458ed59f6df7fc7f49e1cd7a48fa5,"Add pytest to requirements.txt.

pytest is a lot nicer to use than the default python testing library
('unittest') and pretty popular, so let's use that."
spang,2013-04-20 15:19:06,https://api.github.com/repos/nylas/sync-engine/git/commits/bd43752423d921668a56c2997645afd40766bb86,bd43752423d921668a56c2997645afd40766bb86,"Ignore share/ too.

(If you install bpython in your virtualenv, you get this dir.)"
spang,2013-04-20 15:09:19,https://api.github.com/repos/nylas/sync-engine/git/commits/c05d859e9d40d34c5729d8943ee0a54e0224302e,c05d859e9d40d34c5729d8943ee0a54e0224302e,"Make crispin.py a real package.

We'll definitely want to split stuff out into submodules
eventually, might as well start now.

(See http://docs.python.org/2/tutorial/modules.html#packages if
you want to know more.)"
spang,2013-04-20 15:01:28,https://api.github.com/repos/nylas/sync-engine/git/commits/cb5e2aa963867a267d175d079ca8555ce9456186,cb5e2aa963867a267d175d079ca8555ce9456186,crispin.py: fixup whitespace
spang,2013-04-20 15:01:08,https://api.github.com/repos/nylas/sync-engine/git/commits/51d29e38a6cf5e24f2e2d3170822fc0bd40d5d9e,51d29e38a6cf5e24f2e2d3170822fc0bd40d5d9e,"crispin.py: Remove unusued imports.

My editor automatically checks everything with pyflakes, which is why I
notice this stuff."
grinich,2013-04-19 22:27:35,https://api.github.com/repos/nylas/sync-engine/git/commits/d56f857c31f55c6ce39d13bf4add182c99e3bd5d,d56f857c31f55c6ce39d13bf4add182c99e3bd5d,Create models file and clean up some code
grinich,2013-04-19 02:48:46,https://api.github.com/repos/nylas/sync-engine/git/commits/990829789f447958b8c8b8b53545737361d9516f,990829789f447958b8c8b8b53545737361d9516f,"Queries for BODYSTRUCTURE now have a class! Introducting MessageBodyPart. There's a bunch of crap here that should probably be put into its own file and abstracted a bit better. Ah my baby Crispin.py, they grow up so fast!"
spang,2013-04-18 14:15:21,https://api.github.com/repos/nylas/sync-engine/git/commits/795338f9d1658b19432bc89b7f1ac8370785d9db,795338f9d1658b19432bc89b7f1ac8370785d9db,"Fix some typos.

My mental autocorrect has no off button."
grinich,2013-04-19 01:10:14,https://api.github.com/repos/nylas/sync-engine/git/commits/2627de4f2221fd514878bc0a01c004f64d169f65,2627de4f2221fd514878bc0a01c004f64d169f65,bunch of stuff for the BODYSTRUCTURE command. not finished
grinich,2013-04-18 18:38:12,https://api.github.com/repos/nylas/sync-engine/git/commits/22d7918cd3497becca0a8e786b7fb438b1043ebe,22d7918cd3497becca0a8e786b7fb438b1043ebe,update subpackage
grinich,2013-04-18 00:57:00,https://api.github.com/repos/nylas/sync-engine/git/commits/6628d2a0345366f32709f02ef2a4897c44c9bbd0,6628d2a0345366f32709f02ef2a4897c44c9bbd0,Updating ignore for virtualenv
grinich,2013-04-18 00:49:19,https://api.github.com/repos/nylas/sync-engine/git/commits/eeb7237f3381aff0682a0b82db3aae58b16de0d8,eeb7237f3381aff0682a0b82db3aae58b16de0d8,Basic demo showing how to IDLE for new messages
grinich,2013-04-18 00:48:57,https://api.github.com/repos/nylas/sync-engine/git/commits/664cb64bcaa726dab210b9056af59c5a53b5051c,664cb64bcaa726dab210b9056af59c5a53b5051c,"Add submodule for imaplib2, a threaded version of imaplib, and also some more detailed installation instructions"
grinich,2013-04-16 19:22:19,https://api.github.com/repos/nylas/sync-engine/git/commits/c1aa25cabdb6df28393f27cbf6d263525bcfbd9a,c1aa25cabdb6df28393f27cbf6d263525bcfbd9a,removing cruft
grinich,2013-04-16 19:20:32,https://api.github.com/repos/nylas/sync-engine/git/commits/0393b3e94ab158e6ca2ac1424727a2355919100a,0393b3e94ab158e6ca2ac1424727a2355919100a,Add a bunch of notes into readme file. (Moved DESIGN to here)
grinich,2013-04-16 02:36:14,https://api.github.com/repos/nylas/sync-engine/git/commits/6f94b0039a0521884cdebb96c56c3d62040eeb02,6f94b0039a0521884cdebb96c56c3d62040eeb02,cruft
grinich,2013-04-15 20:59:13,https://api.github.com/repos/nylas/sync-engine/git/commits/63c47a7796ce292965515c07f8714546f6eb5e5e,63c47a7796ce292965515c07f8714546f6eb5e5e,rename Thread() to MsgThread() to avoid conflicting with process threading in the future
spang,2013-04-14 17:41:12,https://api.github.com/repos/nylas/sync-engine/git/commits/4109e52d2db2ccc93fc242158a93aeff671ace3a,4109e52d2db2ccc93fc242158a93aeff671ace3a,A note about websockets.
grinich,2013-04-14 18:18:13,https://api.github.com/repos/nylas/sync-engine/git/commits/61b9a2770b65764f9389a6334db37fb2102cc9d9,61b9a2770b65764f9389a6334db37fb2102cc9d9,Remove files for shadows since they are now drawn with CSS
grinich,2013-04-14 00:30:16,https://api.github.com/repos/nylas/sync-engine/git/commits/5c341b10347b360cd965ad4427707666475e26f9,5c341b10347b360cd965ad4427707666475e26f9,line spacing
grinich,2013-04-13 23:58:15,https://api.github.com/repos/nylas/sync-engine/git/commits/50319d87ca53b77e8cd034d2ec019b12374b05bc,50319d87ca53b77e8cd034d2ec019b12374b05bc,More support for grouping and fetching threads
grinich,2013-04-13 21:00:30,https://api.github.com/repos/nylas/sync-engine/git/commits/1a5033e0a5c4b43db31a085b5385fbd486710dc2,1a5033e0a5c4b43db31a085b5385fbd486710dc2,Draw shadow using CSS instead of PNG image.
grinich,2013-04-13 20:03:23,https://api.github.com/repos/nylas/sync-engine/git/commits/b61c945b6912b560adac4557344ee0e1a9d55f09,b61c945b6912b560adac4557344ee0e1a9d55f09,remove old notes on mimetypes
grinich,2013-04-13 19:57:31,https://api.github.com/repos/nylas/sync-engine/git/commits/dfdb2ce5542d9112986c5ab09f6a4acdfacb0c83,dfdb2ce5542d9112986c5ab09f6a4acdfacb0c83,woah. this makes it almost usable... :)
grinich,2013-04-13 19:46:22,https://api.github.com/repos/nylas/sync-engine/git/commits/d5847e661d70eae223fecfab54cce41fbed3119e,d5847e661d70eae223fecfab54cce41fbed3119e,Super basic SMTP sending
grinich,2013-04-13 19:45:14,https://api.github.com/repos/nylas/sync-engine/git/commits/2fac66b0923b306432e6e57f73995523ed40d915,2fac66b0923b306432e6e57f73995523ed40d915,Add note on how to make git ignore changes to credentials.py
grinich,2013-04-13 19:41:07,https://api.github.com/repos/nylas/sync-engine/git/commits/2b7b5278b0855c9b088e40c1a2e268774064981b,2b7b5278b0855c9b088e40c1a2e268774064981b,Move personal oauth credentials to credentails.py and import from there. Also add urls for Gmail SMTP
grinich,2013-04-13 19:30:31,https://api.github.com/repos/nylas/sync-engine/git/commits/cc7de7e90678bef0383ee4733ce0b0aa6494ecba,cc7de7e90678bef0383ee4733ce0b0aa6494ecba,Add back default route
grinich,2013-04-13 18:18:08,https://api.github.com/repos/nylas/sync-engine/git/commits/1fd507e33746276505d6627094e471fb59a485a9,1fd507e33746276505d6627094e471fb59a485a9,super rudimentary way of fetching and displaying threads
grinich,2013-04-13 18:15:05,https://api.github.com/repos/nylas/sync-engine/git/commits/a6dd8c8adecf667192b17ca7f9910fc72ec53b5f,a6dd8c8adecf667192b17ca7f9910fc72ec53b5f,move subject trimming here
grinich,2013-04-13 18:14:42,https://api.github.com/repos/nylas/sync-engine/git/commits/0c02dc0db5956f045683c8a51cd4487119ee0355,0c02dc0db5956f045683c8a51cd4487119ee0355,syntax formatting
grinich,2013-04-13 04:30:08,https://api.github.com/repos/nylas/sync-engine/git/commits/12895efb33896939969e889f7a241cfe0085ae4e,12895efb33896939969e889f7a241cfe0085ae4e,ui message iframe height (before content)
grinich,2013-04-13 04:29:44,https://api.github.com/repos/nylas/sync-engine/git/commits/16538d3babc406183592bc236af91fcc51d6c81d,16538d3babc406183592bc236af91fcc51d6c81d,Some more regexes that might help
grinich,2013-04-13 04:29:25,https://api.github.com/repos/nylas/sync-engine/git/commits/199917d55ad5b87cecf6bb1c801b472987c79d0e,199917d55ad5b87cecf6bb1c801b472987c79d0e,Add unicode stuff for message body
grinich,2013-04-13 01:13:56,https://api.github.com/repos/nylas/sync-engine/git/commits/85c3fc39936812d00e856683a2df66fd4d969769,85c3fc39936812d00e856683a2df66fd4d969769,fuck pep8
spang,2013-04-12 01:24:17,https://api.github.com/repos/nylas/sync-engine/git/commits/fda848d25a757d0b561756b04db3a74382af9d29,fda848d25a757d0b561756b04db3a74382af9d29,Remove TODO since we're actually using Asana.
grinich,2013-04-12 01:35:19,https://api.github.com/repos/nylas/sync-engine/git/commits/5579d490251e11cd030e78302af921291ba8eb54,5579d490251e11cd030e78302af921291ba8eb54,maybe add another url for gmail
spang,2013-04-12 01:12:45,https://api.github.com/repos/nylas/sync-engine/git/commits/3cf787983f7c49eeb0da97acfe9f10ee277d9e01,3cf787983f7c49eeb0da97acfe9f10ee277d9e01,Some organizational thoughts.
grinich,2013-04-12 00:21:33,https://api.github.com/repos/nylas/sync-engine/git/commits/3e425c89ebc5dc84997f7cf57e9946cefdac6c15,3e425c89ebc5dc84997f7cf57e9946cefdac6c15,Separate some header parsing functions.
grinich,2013-04-12 00:02:00,https://api.github.com/repos/nylas/sync-engine/git/commits/48b4360290abf83333f9cf1fbbaddfeacce21b49,48b4360290abf83333f9cf1fbbaddfeacce21b49,note about registring oauth
spang,2013-04-11 23:48:34,https://api.github.com/repos/nylas/sync-engine/git/commits/74b21499b600d0457832911c81983987ea630396,74b21499b600d0457832911c81983987ea630396,"Always return a list from parse_contacts()

(Fixes a crash.)"
spang,2013-04-11 23:32:53,https://api.github.com/repos/nylas/sync-engine/git/commits/448519d797c189b270b0ba13778b3d2b518d6df4,448519d797c189b270b0ba13778b3d2b518d6df4,Update gitignore for virtualenv.
spang,2013-04-11 23:32:00,https://api.github.com/repos/nylas/sync-engine/git/commits/1c6379282667c586f70537d8b2799a45aeaaa5b8,1c6379282667c586f70537d8b2799a45aeaaa5b8,"Add requirements.txt.

Allows folks to easily bootstrap virtualenvs."
spang,2013-04-11 23:15:57,https://api.github.com/repos/nylas/sync-engine/git/commits/7e06aefdb68987485c5f9a9a1a430bd8757dd951,7e06aefdb68987485c5f9a9a1a430bd8757dd951,"xoauth.py: Don't require a specific python 2 version.

It works fine with python 2.7."
grinich,2013-04-11 23:30:35,https://api.github.com/repos/nylas/sync-engine/git/commits/ae72ae1857add118b32742251ae4b0f94009bbd6,ae72ae1857add118b32742251ae4b0f94009bbd6,fix some imports
grinich,2013-04-11 23:30:22,https://api.github.com/repos/nylas/sync-engine/git/commits/3704073a9bd033ba54abdadc08e9aceb64bddeaa,3704073a9bd033ba54abdadc08e9aceb64bddeaa,for deployment to places like heroku
grinich,2013-04-11 23:15:59,https://api.github.com/repos/nylas/sync-engine/git/commits/6aa0315d5b639676efb072661ee6dfc462b55bcd,6aa0315d5b639676efb072661ee6dfc462b55bcd,Remove my oauth bits :)
grinich,2013-04-11 23:06:27,https://api.github.com/repos/nylas/sync-engine/git/commits/87d6c4ab4b089145b0b4569df87240adc599a172,87d6c4ab4b089145b0b4569df87240adc599a172,Add Google's oAuth scripts
grinich,2013-04-11 22:52:46,https://api.github.com/repos/nylas/sync-engine/git/commits/26b71c1e7304d14d58072db86e088071ecc23339,26b71c1e7304d14d58072db86e088071ecc23339,stuffffff
grinich,2013-04-11 22:52:26,https://api.github.com/repos/nylas/sync-engine/git/commits/d85a9fe0514cd49a2ba5d276924a983064b4fb57,d85a9fe0514cd49a2ba5d276924a983064b4fb57,thread page
grinich,2013-04-10 03:00:59,https://api.github.com/repos/nylas/sync-engine/git/commits/4ad9c85109a6a35ca07d6d0a2ea42ce376c8d37e,4ad9c85109a6a35ca07d6d0a2ea42ce376c8d37e,so much shit
grinich,2013-04-10 02:55:56,https://api.github.com/repos/nylas/sync-engine/git/commits/e4c0ff7229833382d05575edc8c5e419e8ac77ae,e4c0ff7229833382d05575edc8c5e419e8ac77ae,remove OO pattern so that server can be shared as a global variable in module
grinich,2013-04-10 02:44:56,https://api.github.com/repos/nylas/sync-engine/git/commits/4c3cef6a05208800b64998e84d72b457ae7a5353,4c3cef6a05208800b64998e84d72b457ae7a5353,moving mailguts to crispin
grinich,2012-10-19 05:53:03,https://api.github.com/repos/nylas/sync-engine/git/commits/43e6b03686a3ea38ba216b2c3817aa63cc2930a9,43e6b03686a3ea38ba216b2c3817aa63cc2930a9,more stuff and subje
grinich,2012-10-14 04:03:43,https://api.github.com/repos/nylas/sync-engine/git/commits/93f5ae1a73f4823470cacca2c77656e118621034,93f5ae1a73f4823470cacca2c77656e118621034,checkpoint
grinich,2012-10-14 04:03:30,https://api.github.com/repos/nylas/sync-engine/git/commits/1ca7b2171b4adb943018046c773ad8c29edc945d,1ca7b2171b4adb943018046c773ad8c29edc945d,adding ignore
grinich,2012-08-08 06:31:12,https://api.github.com/repos/nylas/sync-engine/git/commits/e2ba7c6b9c45ac1b3a9440fb8233cf5ff8516240,e2ba7c6b9c45ac1b3a9440fb8233cf5ff8516240,first commit. might as well get this stuff in there.
